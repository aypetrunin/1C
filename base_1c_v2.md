#1C:Предприятие 8.3 Практическое пособие разработчика  1C:EDT
Книга позволяет быстро освоить приемы разработки и модификации прикладных решений на платформе «1С:Предприятие 8.3» используя 1C:EDT.
1C:EDT – это современная расширяемая среда разработки прикладных решений. Она создана на основе свободной интегрированной среды разработки модульных кроссплатформенных приложений Eclipse, широко используемой разработчиками во всем мире.
На примере создания реального прикладного решения показана структура различных объектов системы, их назначение и методика использования. Приведены процедуры на встроенном языке, в том числе с применением языка запросов, которые снабжены подробными комментариями.
Книга может быть использована и как практическое руководство, и как справочное пособие. Рассматриваемое в книге прикладное решение учитывает накопленный опыт разработки в системе «1С:Предприятие 8» и демонстрирует многие новые возможности и механизмы, предоставляемые версией 8.3.
Материал рассчитан на начинающих разработчиков, не знакомых с системой «1С:Предприятие 8» и с программированием.
## Кому предназначена эта книга
В основу книги положен реальный пример разработки прикладного решения для небольшой фирмы, оказывающей бытовые услуги, – ООО «На все руки мастер». По мере изучения этой книги вы научитесь основным приемам разработки в системе «1С:Предприятие», освоите различные области автоматизации хозяйственной деятельности, включая бухгалтерский учет, расчет зарплаты и т. д.
Почему был выбран именно такой пример?
С одной стороны, область оказания услуг хорошо знакома большинству из нас. Так или иначе с разнообразными услугами мы сталкиваемся постоянно. Это ремонт различной бытовой техники, обслуживание автомобиля, стирка и химчистка, парикмахерские и косметические услуги и многое другое.
С другой стороны, деятельность ремонтной фирмы хорошо подходит для демонстрации возможностей «1С:Предприятия». Здесь есть разнообразные услуги, оказываемые клиентам, снабжение фирмы необходимыми материалами и их расход при оказании услуг. Работа такого предприятия позволяет рассмотреть учет персонала и расчет заработной платы сотрудников. Есть возможность проиллюстрировать ведение бухгалтерского учета. Это разнообразие видов деятельности позволяет довольно широко показать возможности формирования различных отчетов и итоговых данных на основе имеющейся информации.
Книга обращена в большей степени к начинающим разработчикам, делающим первые шаги в разработке прикладных решений. Пояснения, приведенные в книге, подробны и доступны даже для тех, кто лишь отдаленно знаком с азами программирования.
Если вы только начинаете работу с «1С:Предприятием» или даже совсем не знакомы с этой системой, но очень хотите научиться, то эта книга – для вас. Цель книги – «провести вас за руку» по основным этапам разработки простого прикладного решения в системе «1С:Предприятие» и показать, что нет ничего недоступного для человека с интеллектом.
Более опытным разработчикам книга также будет полезна – она позволит вспомнить или подробнее изучить отдельные моменты разработки. 
## Как читать
Книга максимально приближена к учебному пособию и построена в виде отдельных занятий. В начале каждого занятия дается примерный хронометраж, чтобы вы представляли, сколько времени в среднем необходимо на него потратить.
В конце занятия приводится список контрольных вопросов, позволяющих читателю оценить, насколько он усвоил материал.
В начале книги содержится краткое оглавление по занятиям с указанием продолжительности каждого из них. В каждом занятии находится более подробное оглавление, которое поможет вам быстро переходить к отдельным фрагментам прошлых занятий. В конце книги приведено полное подробное содержание всех занятий.
Каждое занятие является логически законченной частью разработки прикладного решения. Поэтому, хотя занятия различаются по продолжительности, настоятельно рекомендуется выполнять их целиком, от начала до конца. Иначе вам как начинающему разработчику будет сложно восстановить ход своих действий с середины занятия.
Занятия построены по принципу «от простого к сложному». Они последовательно описывают основные приемы и охватывают различные области разработки в системе «1С:Предприятие».
Книга содержит большое количество рисунков и примеров кода на встроенном языке, снабженных подробными комментариями. Если вам они покажутся лишними или слишком подробными, можно их пропустить.
Конфигурация, создаваемая на протяжении всей книги, содержится в дополнительных материалах, о которых говорится в следующем разделе. К ней можно обращаться в тех случаях, когда необходимо проверить правильность самостоятельного выполнения примеров из книги.
Поскольку пример, разбираемый в книге, довольно большой, в дополнительных материалах содержится не один, а пять проектов и информационных баз по состоянию после 6, 10, 16, 20 и 29-го занятия. Это поможет быстрее находить нужные фрагменты конфигурации.
## Ограничения учебной версии платформы
Учебная версия платформы имеет ограничения, которые не позволят вам полностью выполнить примеры, приведенные в этой книге. Таких ограничений немного, и они не носят принципиального характера. Однако сказать о них необходимо.
В 23-м занятии создается список пользователей системы. Учебная версия платформы не позволит задать пароли для пользователей и не позволит установить аутентификацию средствами операционной системы. Но это не имеет принципиального значения для изучения, так как вы все равно сможете запустить систему от имени каждого из созданных пользователей. Только ни у одного из них не будет пароля.
В 25-м занятии рассматривается обмен данными. Учебная версия платформы не позволит проверить в работе вторую часть примера – распределенную информационную базу. Однако первую, более общую, часть (универсальный механизм обмена) вы сможете изучить полностью.

## Установка
Для того чтобы выполнить пример из этой книги, вам понадобятся:
платформа «1С:Предприятие» версии 8.3.21;
64-разрядная Java Platform Standard Edition версии 11;
1C:EDT (1C:Enterprise Development Tools) версии 2022.1.
Можно использовать как учебную, так и полнофункциональную версию платформы «1С:Предприятие». Если подходящая полнофункциональная версия у вас уже установлена, переходите к установке Java Platform и 1C:EDT. Если платформа «1С:Предприятие» у вас не установлена, в следующем разделе описано, как бесплатно скачать и установить учебную версию.
Если какая-либо версия Java Platform у вас уже установлена, мы рекомендуем удалить ее и установить версию, требуемую для 1C:EDT. Если прежняя версия Java Platform все же нужна, то после установки версии 11 нужно выполнить некоторые настройки. Как проверить версию Java, скачать, установить и настроить новую версию, описано в разделе далее.
После того как на вашем компьютере будут платформа «1С:Предприятие» и Java Platform, скачайте бесплатно и установите 1C:EDT.
### Установка платформы «1С:Предприятие»
Чтобы скачать учебную платформу «1С:Предприятие» версии 8.3.21, перейдите по адресу https://online.1c.ru/catalog/free/34499722/ и нажмите Получить продукт бесплатно (рис. 0.1).

Рис. 0.1. Получить продукт бесплатно {https://ai2b.pro/wp-content/uploads/1/00_001.png}
Укажите ФИО, E-mail, установите флажок Я принимаю Лицензионное соглашение и нажмите Отправить.
Через некоторое время на вашу почту придет письмо со ссылкой для скачивания. Ваша почтовая программа может автоматически поместить это письмо в папку Спам, поэтому не забудьте проверить и эту папку тоже.
Скачанный архив распакуйте в отдельную папку и запустите setup.exe (рис. 0.2).

Рис. 0.2. Установка платформы «1С:Предприятие» {https://ai2b.pro/wp-content/uploads/1/00_002.png}
Ничего не меняя, три раза нажмите Далее, а затем нажмите Установить. Платформа «1С:Предприятие» будет установлена на вашем компьютере. Как-либо запускать ее не нужно, 1C:EDT автоматически обнаружит и будет использовать ее.

### Установка Java и 1C:EDT
Чтобы скачать дистрибутивы Java и 1C:EDT, нужно быть зарегистрированным пользователем портала ИТС. Если у вас нет учетной записи на этом портале, вы можете создать ее прямо сейчас.
Перейдите по адресу https://portal.1c.ru/ и нажмите Войти (рис. 0.3).

Рис. 0.3. Вход на портал ИТС {https://ai2b.pro/wp-content/uploads/1/00_003.png}
Для создания учетной записи можно использовать ваши имеющиеся учетные записи в Яндексе, Гугле и других ресурсах. Также вы можете просто создать новый логин и пароль, для этого нажмите Нет логина? (рис. 0.4).

Рис. 0.4. Способы аутентификации на портале ИТС {https://ai2b.pro/wp-content/uploads/1/00_004.png}
После того как вы заполните необходимые данные, вы окажетесь на главной странице портала. Зайдите в раздел 1С:Обновление программ > Скачать обновления программ и нажмите Скрыть недоступные конфигурации.
Вы увидите список дистрибутивов, которые доступны любым пользователям портала (рис. 0.5).

Рис. 0.5. Разделы 1C:EDT и Java {https://ai2b.pro/wp-content/uploads/1/00_001.png}
Сначала скачайте и установите дистрибутив Java, он находится в разделе Liberica 11 Full JDK.
После этого скачайте и установите дистрибутив 1C:EDT, он находится в разделе 1C:Enterprise Development Tools.
#### Установка Java
Прежде чем скачивать и устанавливать Java, проверьте: возможно, на вашем компьютере уже установлена подходящая версия. Для этого в строку поиска введите «командная» и запустите приложение Командная строка (Command Prompt). Выполните команду java –version.
Если у вас установлена версия 11, вы увидите похожее сообщение (рис. 0.6).

Рис. 0.6. Java Platform Standard Edition версии 11 {https://ai2b.pro/wp-content/uploads/1/00_001.png}
Если Java у вас не установлена или ее версия не подходит, установите версию 11.
Для этого зайдите в раздел Liberica 11 Full JDK (см. рис. 0.5). Выберите последнюю версию, в данном случае это версия 11.0.15+10 (рис. 0.7).

Рис. 0.7. Последняя версия Java {https://ai2b.pro/wp-content/uploads/1/00_007.png}
Зайдите в раздел с этой версией, нажмите Liberica 11 Full JDK (64-bit) для Windows, скачайте дистрибутив и запустите его (рис. 0.8).

Рис. 0.8. Установка Java {https://ai2b.pro/wp-content/uploads/1/00_008.png}
Ничего не меняя, два раза нажмите Next, затем нажмите Install. Java Platform будет установлена на вашем компьютере.

#### Установка 1C:EDT
Чтобы скачать 1C:EDT, зайдите в раздел 1C:Enterprise Development Tools (см. рис. 0.5). Выберите последнюю версию релиза 2022.1, в данном случае это версия 2022.1.5 (рис. 0.9).

Рис. 0.9. Последняя версия 1C:EDT {https://ai2b.pro/wp-content/uploads/1/00_009.png}
Зайдите в раздел с этой версией, нажмите Дистрибутив 1C:EDT для ОС Windows 64 бит, скачайте архив, разахивируйте его в отдельную папку и запустите 1ce-installer.exe от имени администратора (рис. 0.10).

Рис. 0.10. Запуск от имени администратора {https://ai2b.pro/wp-content/uploads/1/00_010.png}
Ничего не меняя, нажмите Установить (рис. 0.11).

Рис. 0.11. Установка 1C:EDT {https://ai2b.pro/wp-content/uploads/1/00_011.png}
В результате на ваш компьютер будет установлена программа запуска и обновления 1C:EDT Start. Использование этой программы – это основной способ работы с 1C:EDT. С ее помощью устанавливаются новые версии, обновляются существующие версии, создаются и запускаются проекты, в которых разрабатываются приложения.
Достаточно один раз запустить 1C:EDT Start, после чего она помещается в панель задач, откуда вы можете в любой момент открыть ее.
Запустите 1C:EDT Start. Это можно сделать с помощью ярлыка на рабочем столе или с помощью меню Пуск (раздел Недавно добавленные) (рис. 0.12).

Рис. 0.12. Первый запуск 1C:EDT Start {https://ai2b.pro/wp-content/uploads/1/00_012.png}
Нажмите Создать новый проект, а затем Войти с помощью портала 1С:ИТС (рис 0.13).

Рис. 0.13. Авторизация 1C:EDT Start {https://ai2b.pro/wp-content/uploads/1/00_013.png}
Программа откроет новую вкладку браузера.
Если ваша сессия авторизации на портале ИТС уже истекла, программа попросит вас авторизоваться (см. рис. 0.4). Если сессия еще не закончилась, то программа попросит вас разрешить доступ к данным профиля. Нажмите Разрешить доступ (рис. 0.14).

Рис. 0.14. Разрешить доступ к данным профиля {https://ai2b.pro/wp-content/uploads/1/00_014.png}
Если вы удачно авторизовались на портале ИТС или разрешили доступ, то вы увидите следующее сообщение (рис. 0.15).

Рис. 0.15. Успешный вход {https://ai2b.pro/wp-content/uploads/1/00_015.png}
Сверните браузер и вернитесь к программе 1C:EDT Start (рис.0.16).

Рис. 0.16. Список проектов {https://ai2b.pro/wp-content/uploads/1/00_016.png}
Это ее основное рабочее окно. На следующих занятиях вы создадите проект, который будет отображаться здесь. А пока можете нажать на кнопку закрытия окна – 1C:EDT Start свернется в панель задач и не будет вам мешать (рис. 0.17).

Рис. 0.17. 1C:EDT Start в панели задач {https://ai2b.pro/wp-content/uploads/1/00_017.png}

## Занятие 1 (0:40). Знакомство, создание проекта
продолжительность
Ориентировочная продолжительность занятия – 40 минут.
Первое занятие книги будет посвящено знакомству с системой «1С:Предприятие» и ее средой разработки 1C:EDT (1C:Enterprise Development Tools).
Вы узнаете, что обозначается терминами «платформа», «проект» «конфигурация» и «прикладное решение». Узнаете, что такое объекты конфигурации, как с их помощью можно конструировать прикладное решение.
В заключение вы создадите новый проект, который будете разрабатывать на протяжении всей книги.
ПРИМЕЧАНИЕ
В конце книги находится «Список действий». Если вы будете читать книгу выборочно, не по порядку, то в этом списке можете быстро найти незнакомое действие, которое вы пропустили.

### Программирование или разработка?
«Что же я делаю?!» – такой вопрос периодически возникает у всех, кто сталкивался или просто интересовался разработками на «1С:Предприятии».
«Пишу программу», – вот наиболее частый ответ. «На чем?» – «На 1С». «На чем вы работаете?» – «На 1С». «На чем это написано?» – «На 1С». «Требуется бухгалтер со знанием 1С», «Требуется программист 1С на неполный рабочий день…» и т. д.
Такие фразы можно встретить постоянно, и вам они наверняка хорошо знакомы. Для непосвященного человека в них нет ничего особенного. Однако тех, кто имеет представление о разработке на «1С:Предприятии», они зачастую могут поставить в тупик, потому что в этих фразах термином 1С обозначаются совершенно разные предметы, а термин программа и вовсе сбивает с толку…
Если ваша цель – научиться «программировать на 1С», то это цель не совсем верная. В системе «1С:Предприятие» есть встроенный язык, но он занимает далеко не главное место в процессе разработки. И книга не учит программированию в общепринятом понимании этого слова. Она учит разработке прикладных решений на платформе «1С:Предприятие» – процессу, в котором программирование, безусловно, присутствует, но лишь как один из инструментов разработки.
Это важно понимать с самого начала, еще до того, как вы начнете делать первые шаги в «1С:Предприятии».
А чтобы было понятно, что именно вы будете «делать» на протяжении этой книги, вам нужно узнать сначала, что представляет собой система «1С:Предприятие» вообще.

### Общие сведения о системе
«1С:Предприятие» является универсальной системой автоматизации экономической и организационной деятельности предприятия. Поскольку такая деятельность может быть довольно разнообразной, система «1С:Предприятие» может приспосабливаться к особенностям конкретной области, в которой она применяется. Для обозначения такой способности используется термин конфигурируемость, то есть возможность настройки системы с учетом особенностей конкретного предприятия и класса решаемых задач.
Это достигается благодаря тому, что «1С:Предприятие» – не просто программа, существующая в виде набора неизменяемых файлов, а совокупность различных программных инструментов, с которыми работают разработчики и пользователи. Логически всю систему можно разделить на две большие части, которые тесно взаимодействуют друг с другом: конфигурацию и платформу, которая управляет работой конфигурации.
Для того чтобы легче понять взаимодействие этих частей системы, сравним ее с проигрывателем компакт-дисков. Как вы хорошо знаете, проигрыватель служит для того, чтобы слушать музыку. На вкус и цвет товарищей нет, поэтому существует множество разнообразных компакт-дисков, на которых записаны музыкальные произведения на любой вкус.
Чтобы прослушать какую-либо композицию, нужно вставить компакт-диск в проигрыватель, и проигрыватель воспроизведет записанное на диске музыкальное произведение. Более того, современный проигрыватель даже позволит вам записать собственную подборку музыкальных произведений, то есть создать новый компакт-диск.
Сам по себе проигрыватель совершенно бесполезен без компакт-диска, точно так же как компакт-диск не может принести вам никакой пользы (кроме как стать подставкой под чашку кофе), если у вас нет проигрывателя.
Возвращаясь к системе «1С:Предприятие», можно сказать, что платформа является своеобразным «проигрывателем», а конфигурация – «компакт-диском». Платформа обеспечивает работу конфигурации и позволяет вносить в нее изменения или создавать собственную конфигурацию.
Существует одна платформа («1С:Предприятие») и множество конфигураций. Для функционирования какого-либо прикладного решения всегда необходима платформа и какая-либо (одна) конфигурация (рис. 1.1).

Рис. 1.1. Конфигураций много, а платформа одна {https://ai2b.pro/wp-content/uploads/1/01_001.png}
Сама по себе платформа не может выполнить никаких задач автоматизации, так как она создана для обеспечения работы какой-либо конфигурации. То же самое с конфигурацией: чтобы выполнить те задачи, для которых она создана, необходимо наличие платформы, управляющей ее работой.

### Конфигурация и прикладное решение
Теперь уже можно ответить на вопрос, который был задан в предыдущем разделе: в процессе чтения этой книги и выполнения демонстрационного примера вы разработаете конфигурацию.
Здесь следует сказать о небольшой двойственности терминологии, которая будет использоваться в дальнейшем. Двойственность заключается в употреблении разных терминов для обозначения одного и того же предмета: конфигурация и прикладное решение.
Эти термины обозначают ту часть системы «1С:Предприятие», которая работает под управлением платформы и которую видят все пользователи. Бывает, конечно, что пользователи работают и с инструментальными средствами платформы, но это продвинутые пользователи. Употребление одного или другого термина зависит от контекста, в котором ведется изложение.
Если речь идет о действиях разработчика, то употребляется термин «конфигурация», поскольку это точный термин «1С:Предприятия». Термин «прикладное решение», напротив, является более общепринятым и понятным для пользователя системы «1С:Предприятие».
Итак, поскольку задачи автоматизации, как было упомянуто выше, могут быть самыми разными, фирма «1С» и ее партнеры выпускают прикладные решения, каждое из которых предназначено для автоматизации одной определенной области человеческой деятельности. В качестве примеров можно привести следующие типовые решения:
«1С:Корпорация»,
«1С:ERP.Управление холдингом»,
«1С:Управление холдингом 8»,
«1С:ERP Управление предприятием»,
«1С:Комплексная автоматизация»,
«1С:Управление нашей фирмой»,
«1С:Управление торговлей 8»,
«1С:Розница» и др.
Существует также множество других типовых прикладных решений. Более подробно о них можно узнать на сайте http://v8.1c.ru/.
Типовое прикладное решение является, по сути, универсальным и способно удовлетворить потребности самых разных предприятий, работающих в одной области. И это хорошо.
С другой стороны, такая универсальность неизбежно приведет к тому, что на конкретном предприятии будут использоваться далеко не все возможности прикладного решения, а каких-то возможностей в нем будет недоставать (нельзя угодить всем).
Вот тут и выходит на передний план конфигурируемость системы, поскольку платформа, помимо управления работой конфигурации, содержит средства, позволяющие вносить изменения в используемую конфигурацию.
Кроме того, платформа позволяет создать свою собственную конфигурацию с нуля, если по каким-либо причинам использование типовой конфигурации представляется нецелесообразным.
Обратите внимание, что в предыдущих пояснениях легко и просто произошел переход от прикладного решения к конфигурации. Ничего не поделаешь, для пользователя понятнее так, а для разработчика – по-другому.
Таким образом, если вернуться к сравнению с проигрывателем компакт-дисков, вы можете изменять по своему вкусу мелодии, которые были ранее записаны на компакт-диске, и даже создавать диски со своими собственными музыкальными произведениями. При этом вам не потребуются какие-либо музыкальные инструменты: все необходимое для создания мелодий уже есть в проигрывателе компакт-дисков.

### Режимы работы системы
Для того чтобы обеспечить такие возможности, система «1С:Предприятие» имеет два режима работы: 1С:Предприятие и Конфигуратор. Кроме этого есть еще отдельное приложение 1C:EDT, предназначенное для разработки конфигураций.
Режим 1С:Предприятие является основным и служит для работы пользователей системы. В этом режиме пользователи вносят данные, обрабатывают их и получают итоговые результаты.
Режим Конфигуратор предназначен для разработчиков и администраторов информационных баз. Раньше вся разработка прикладных решений выполнялась именно в этом режиме.
1С:EDT (1C:Enterprise Development Tools) – это среда разработки нового поколения. Она является самостоятельным приложением, которое устанавливается отдельно от платформы «1С:Предприятие». С одной стороны, 1С:EDT поддерживает ключевые принципы создания прикладных решений, которые используются в режиме Конфигуратор. С другой стороны, она содержит большое количество инструментов автоматизации разработки, делающих работу программиста более быстрой и комфортной.
Прикладное решение, разрабатываемое в 1С:EDT, можно запустить в режиме 1С:Предприятие, чтобы отладить его работу или чтобы выполнить какие-то пользовательские действия.
Поскольку задача этой книги состоит в том, чтобы научить вас создавать собственные конфигурации и изменять существующие, дальнейшее повествование будет в основном посвящено работе с системой в 1С:EDT. Периодически, чтобы проверить результаты своей работы, вы будете запускать прикладное решение в режиме 1С:Предприятие.

### В 1C:EDT
В этом разделе вы создадите проект, в котором будете разрабатывать прикладное решение, и запустите его.
Затем в проекте вы создадите новую конфигурацию и запустите ее в режиме отладки.

#### Создание и запуск проекта
Откройте 1C:EDT Start, она свернута у вас в панели задач (рис. 0.17).
Нажмите Новый проект (рис. 1.2).

Рис. 1.2. Добавить проект {https://ai2b.pro/wp-content/uploads/1/01_002.png}
1C:EDT Start предложит вам выбрать тип проекта (рис. 1.3).

Рис. 1.3. Выбор типа проекта {https://ai2b.pro/wp-content/uploads/1/01_003.png}
Вам нужен тип проекта Прикладное решение 1С:Предприятия. Помимо него есть и другие типы, которые в рамках этой книги вам не понадобятся.
Плагины для 1C:EDT – это проекты, которые позволяют дорабатывать саму среду разработки 1C:EDT. Они пишутся на языке Java.
Скрипты для 1С:Исполнитель – старый тип проекта, и, возможно, когда вы будете читать эту книгу, этого типа уже не будет в списке. 1С:Исполнитель позволяет запускать скрипты, автоматизирующие развертывание и обслуживание информационных систем на платформе «1С:Предприятие». Раньше такие скрипты можно было писать с помощью 1C:EDT, теперь для этого используется плагин для среды разработки Visual Studio Code. Поэтому эта строчка со временем должна исчезнуть из списка.
При выборе типа проекта у вас есть возможность автоматически установить последнюю версию среды разработки либо выбрать одну из предыдущих версий.
Эта книга использует версию 2022.1.5. Если это та версия, которая показывается у вас в подсказке (рис. 1.4), то нажимайте и устанавливайте ее.

Рис. 1.4. Установка версии по умолчанию {https://ai2b.pro/wp-content/uploads/1/01_004.png}
Если у вас в подсказке по умолчанию предлагается новая версия, то мы все равно рекомендуем выбирать ее, но при этом иметь в виду, что какие-то детали интерфейса новой версии могут отличаться от тех картинок, которые приведены в книге. Если же вы хотите установить именно 2022.1.5, то выберите ее из списка, нажав на > (рис. 1.5).

Рис. 1.5. Выбор версии 2022.1.5 {https://ai2b.pro/wp-content/uploads/1/01_005.png}
Итак, вы выбрали версию по умолчанию, и 1C:EDT Start предложит вам задать название проекта. Поскольку ООО «На все руки мастер», которое вы автоматизируете, оказывает бытовые услуги, назовите проект Услуги (рис. 1.6) и нажмите ОК.

Рис. 1.6. Название проекта {https://ai2b.pro/wp-content/uploads/1/01_006.png}
После этого 1C:EDT Start предложит вам изменить местонахождение проекта. Ничего не меняйте и нажмите Добавить проект (рис. 1.7).

Рис. 1.7. Добавить проект {https://ai2b.pro/wp-content/uploads/1/01_007.png}
1C:EDT Start начнет загрузку среды разработки выбранной версии (рис. 1.8).

Рис. 1.8. Загрузка среды разработки {https://ai2b.pro/wp-content/uploads/1/01_008.png}
Такая загрузка выполняется только один раз. Если в дальнейшем вы будете создавать другие проекты на этой же версии среды разработки, они будут создаваться быстро: 1C:EDT Start будет использовать уже загруженную версию.
Через некоторое время проект будет создан и вы увидите его в списке (рис. 1.9).

Рис. 1.9. Новый проект в списке {https://ai2b.pro/wp-content/uploads/1/01_009.png}
Под названием проекта Услуги указана версия среды разработки – 1C:EDT 2022.1.5.
После загрузки среды разработки нужно один раз указать ей путь к виртуальной машине Java. Среда разработки будет использовать этот путь для всех своих проектов. Для этого выполните следующие действия.
Чтобы открыть настройки среды разработки, нажмите на значок шестеренки, затем на установленную среду разработки, а затем на значок шестеренки у этой среды (рис. 1.10).

Рис. 1.10. Открыть настройки среды разработки {https://ai2b.pro/wp-content/uploads/1/01_010.png}
Вы увидите настройки среды разработки (рис. 1.11).

Рис. 1.11. Настройки среды разработки {https://ai2b.pro/wp-content/uploads/1/01_011.png}
Укажите путь к виртуальной машине Java (рис. 1.12):
C:\Program Files\BellSoft\LibericaJDK-11-Full\bin\javaw.exe

Рис. 1.12. Путь к виртуальной машине Java {https://ai2b.pro/wp-content/uploads/1/01_012.png}
Закройте настройки среды разработки.
Теперь вы можете запустить проект. Для этого нажмите на картинку с зеленым треугольником.

Рис. 1.13. Запуск проекта {https://ai2b.pro/wp-content/uploads/1/01_013.png}


#### Интерфейс 1C:EDT
После запуска проекта 1C:EDT откроет панель Добро пожаловать. Она открывается автоматически только при первом запуске и содержит полезную информацию о возможностях среды разработки. Также в ее нижней части есть ссылки на документацию и методические материалы.
Чтобы начать работу нажмите Начать работу (рис. 1.14). В дальнейшем вы можете открыть эту страницу, нажав Справка > Начальная страница.

Рис. 1.14. Начальная страница 1C:EDT {https://ai2b.pro/wp-content/uploads/1/01_014.png}
1C:EDT откроет перспективу 1С:Enterprise. Это основное рабочее пространство для разработки прикладных решений. Она содержит все инструменты, необходимые для создания и модификации конфигураций, редактирования форм, модулей, текстов запросов и т. п. (рис. 1.15).

Рис. 1.15. Перспектива «1С:Enterprise» {https://ai2b.pro/wp-content/uploads/1/01_015.png}
Интерфейс 1С:EDT устроен следующим образом. Всю работу вы ведете в основном окне, в котором поочередно может быть открыто несколько перспектив. В данный момент у вас открыта одна перспектива – 1С:Enterprise. Вы можете видеть значок этой перспективы  в панели перспектив, в правом верхнем углу основного окна 1С:EDT (см. рис. 1.12).
В процессе выполнения примеров вы будете использовать и другую перспективу – Отладка. Когда вы откроете ее, ее значок  тоже появится в панели перспектив, а текущая перспектива, в которой вы в данный момент находитесь, будет выделена. С помощью панели перспектив вы можете быстро переключаться между открытыми перспективами.
Каждая перспектива содержит набор инструментов для выполнения ограниченной области задач. Каждый такой инструмент реализован в виде панели. Например, сейчас вы видите открытую панель Навигатор, в которой будет находиться конфигурация, разрабатываемая вами.
Некоторые панели могут быть свернуты, потому что они нужны не постоянно, а лишь время от времени. Например, очень скоро вам понадобится панель Информационные базы, которая сейчас свернута. Чтобы открыть такую панель, достаточно нажать на ее значок  (рис. 1.15).
Конечно, трудно сразу воспринять всю эту информацию. Да и не нужно прямо сейчас в это глубоко вдумываться. Но по мере разработки учебного примера шаг за шагом вы будете осваивать 1С:EDT, и постепенно у вас сложится общая картина, описанная выше.
подробнее
Установка, назначение и работа с 1С:EDT описаны в документации в руководстве разработчика 1C:Enterprise Development Tools.

#### Создание новой конфигурации
Чтобы создать новую конфигурацию, в панели Навигатор нажмите Создать новую конфигурацию (рис. 1.17).

Рис. 1.17. Создать новую конфигурацию {https://ai2b.pro/wp-content/uploads/1/01_017.png}
Задайте имя конфигурации – «Услуги» и, больше ничего не меняя, нажмите Готово (рис. 1.18).

Рис. 1.18. Параметры новой конфигурации {https://ai2b.pro/wp-content/uploads/1/01_018.png}
1C:EDT откроет:
слева, в панели Навигатор – структуру будущего приложения;
в центре, в области редакторов – редактор конфигурации (он вам не понадобится);
справа, в панели Свойства – свойства того элемента, который выделен в панели Навигатор. В данном случае выделена сама конфигурация (рис. 1.19).
Закройте редактор конфигурации, для этого нажмите Х на вкладке редактора (рис. 1.19).

Рис. 1.19. Открыта новая конфигурация {https://ai2b.pro/wp-content/uploads/1/01_019.png}

#### Отключение дополнительных проверок
1С:EDT предназначена в первую очередь для разработки больших прикладных решений командами разработчиков. Чтобы разные разработчики легко понимали код, написанный друг другом, у фирмы «1С» существуют стандарты разработки. Эти стандарты содержат правила оформления кода, правила использования тех или иных инструкций и т. д.
По умолчанию в 1С:EDT подключен плагин, который автоматически проверяет разрабатываемое прикладное решение на соответствие этим стандартам.
Поскольку цель книги – научиться разрабатывать прикладные решения, вы сейчас отключите эти проверки, чтобы они не мешали вам своими избыточными сообщениями. После окончания учебы, когда встроенный язык «1С:Предприятия» будет вам знаком и понятен, вы можете включить эти проверки обратно.
Чтобы отключить проверки в панели Навигатор, нажмите Свойства > V8 > Валидация в контекстном меню проекта. Снимите флажок с ветки 1С:Стандарты разработки V8 и нажмите Применить и Закрыть (рис. 1.16).

Рис. 1.16. Отключение дополнительных проверок {https://ai2b.pro/wp-content/uploads/1/01_016.png}

#### Дерево объектов конфигурации
Итак, в панели Навигатор находится новый проект, содержащий дерево объектов конфигурации (рис. 1.20).

Рис. 1.20. Новая конфигурация {https://ai2b.pro/wp-content/uploads/1/01_020.png}
В корне дерева находится ваш проект. У него есть контекстное меню, которое позволяет выполнять действия, связанные с самим проектом: взаимодействие с информационной базой, изменение свойств проекта и т. д.
Внутри проекта находится конфигурация. Конфигурация также имеет свое контекстное меню, с помощью которого можно выполнять действия, связанные с конфигурацией: открывать те или иные редакторы, создавать объекты и т. д.
Под конфигурацией находится дерево объектов конфигурации.
Наверняка у вас уже возник вопрос: почему в дереве что-то есть, если вы пока еще ничего не создавали?
Дело в том, что для облегчения вашей работы все, из чего состоит конфигурация, сгруппировано, и сейчас дерево и показывает вам эти группы. Если вы будете перемещаться по дереву и нажимать на 4, то увидите, что ни в одной группе нет ни одного объекта конфигурации. Исключение составит лишь группа Общие > Языки, в которой вы обнаружите «нечто» под названием Русский. Это основной язык, который будет использоваться для разработки интерфейса конфигурации.
Хотелось бы уже начать что-нибудь делать, но прежде следует определиться с терминами и рассказать про объекты конфигурации.

#### Что такое объекты конфигурации
Конфигурация представляет собой описание. Она описывает структуру данных, которые пользователь будет использовать в прикладном решении.
Кроме того, конфигурация описывает всевозможные алгоритмы обработки этих данных, содержит информацию о том, как эти данные должны будут выглядеть на экране и на принтере, и т. д. В дальнейшем платформа «1С:Предприятие» на основании этого описания создаст базу данных, которая будет иметь необходимую структуру и предоставит пользователю возможность работать с этой базой данных.
Для того чтобы систему «1С:Предприятие» можно было быстро и легко настраивать на нужные прикладные задачи, все описание, которое содержит конфигурация, состоит из неких логических единиц, называемых объектами конфигурации. Возможно, вы уже успели заглянуть в книгу документации «1С:Предприятие 8.3. Руководство разработчика» (https://its.1c.ru/db/v83doc#bookmark:dev:TI000000018), в которой дается краткое описание объекта конфигурации.
Но задача этой книги – не изложить концепцию построения системы «1С:Предприятие» как структуры метаданных, описанной в терминах классов проблемно-ориентированных бизнес-сущностей, а научить вас методически правильно и грамотно использовать возможности «1С:Предприятия».
Поэтому объясним, что такое объекты конфигурации, просто на бытовом уровне. Однако это даст вам возможность правильно понимать назначение объектов применительно к тем задачам, которые вы будете решать.
С одной стороны, объекты конфигурации представляют собой детали «конструктора», из которого собирается конфигурация. Обычно в конструкторе существует некоторый набор деталей. Детали могут быть разного вида: длинные, короткие, квадратные, прямоугольные и т. д. Теперь представьте, что деталей каждого вида вы можете создавать столько, сколько вам нужно (скажем, 5 длинных и 3 короткие). Детали между собой можно соединять различными способами.
То же и с объектами конфигурации. Вы можете создавать только объекты определенных классов. Но объектов каждого класса вы можете создать столько, сколько вам нужно. Объекты одного класса отличаются от объектов другого класса тем, что имеют разные свойства (точнее говоря, разный набор свойств). Объекты могут взаимодействовать друг с другом, и вы можете описать такое взаимодействие.
В чем еще сходство объектов конфигурации с деталями конструктора? В конструкторе обычно есть блоки, которые можно скрепить между собой, и есть другие детали, например колеса, которые скрепить между собой нельзя, зато их можно соединить с осью, и тогда колеса будут вращаться. То есть разные детали конструктора по-разному ведут себя.
Объекты конфигурации также обладают различным поведением, и оно зависит от класса объекта. Одни объекты могут выполнять какие-то действия, другие этих действий выполнять не могут, зато у них есть свой собственный набор действий.
Следующую особенность объектов конфигурации можно продемонстрировать на примере автомобиля. Автомобиль состоит из большого количества деталей. Одна из деталей автомобиля – это двигатель. Но двигатель, в свою очередь, тоже состоит из набора деталей, причем в разных двигателях могут использоваться одни и те же детали.
Так же «сложные» объекты конфигурации состоят из более «простых», и одни и те же «простые» объекты могут входить в состав сложных объектов. Такая структура позволяет упростить работу с объектами конфигурации, поскольку если вы знаете, как работать с каким-либо «простым» объектом, то в любом «сложном» объекте, в состав которого он входит, вы будете работать с ним таким же образом.
И, наконец, самое важное качество объектов конфигурации – это их прикладная направленность. Объекты конфигурации – не просто некие абстрактные конструкции, при помощи которых разработчик пытается описать поставленную перед ним задачу. Они представляют собой аналоги реальных объектов, которыми оперирует предприятие в ходе своей работы.
Например, на каждом предприятии существуют различные документы, с помощью которых оно фиксирует факты совершения хозяйственных операций. Точно так же в конфигурации существуют объекты класса Документ.
Кроме того, на каждом предприятии обязательно ведется список сотрудников, справочник номенклатуры или товаров. В конфигурации тоже есть специальные объекты класса Справочник, которые позволяют вам создавать компьютерные аналоги таких списков.
Как уже говорилось, на основе объектов конфигурации платформа создает в базе данных таблицы, в которых будут храниться данные. В литературе, как правило, объект конфигурации и соответствующий ему набор таблиц базы данных принято называть одинаково.
Например, если в конфигурации существует объект справочник Сотрудники, то набор таблиц, созданный платформой на основе этого объекта конфигурации, также называют справочник Сотрудники.
Но в этой книге, в тех местах, где речь пойдет о конфигурации, будем использовать явное уточнение – объект конфигурации справочник Сотрудники. Там же, где речь пойдет о базе данных, будем говорить просто: справочник Сотрудники.
Прежде чем приступать к созданию первых объектов конфигурации, нужно понять, что для разработки собственной конфигурации, автоматизирующей хозяйственную деятельность предприятия, вы можете использовать только ограниченный набор классов объектов конфигурации, жестко «зашитый» в платформе. Вам не дано возможности создавать собственные классы объектов конфигурации. Вы можете только добавлять в конфигурацию какой-либо объект из стандартных классов, поставляемых платформой.

#### Панель «Свойства»
Итак, начнем!
Прежде чем добавлять объекты конфигурации, внесите небольшое изменение в свойства конфигурации – измените ее синоним. Это можно сделать в панели Свойства, которая открыта у вас справа.
Панель Свойства показывает свойства элемента, выделенного в другой панели или в другом редакторе.
В панели Навигатор выделите строку Услуги. В панели Свойства будут показаны свойства конфигурации в целом. Задайте значение свойства Синоним как Бытовые услуги (рис. 1.21).

Рис. 1.21. Панель «Свойства» {https://ai2b.pro/wp-content/uploads/1/01_021.png}
Свойство Синоним есть у многих элементов конфигурации. Оно определяет то, как данный элемент будет называться в интерфейсе прикладного решения. В данном случае вы задали название всего вашего прикладного решения. Вы увидите это название в заголовке, когда запустите приложение.
Свойств, отображаемых в панели Свойства, может быть довольно много. Поэтому, чтобы быстрее найти нужное вам свойство, а не прокручивать весь список, достаточно ввести в строку поиска этой панели несколько символов, содержащихся в имени свойства.
Попробуйте найти свойство Синоним и введите для этого «син». В результате список свойств сократится до двух свойств (рис. 1.22). Очистив строку поиска, вы снова увидите весь список свойств вашей конфигурации.

Рис. 1.22. Панель «Свойства» {https://ai2b.pro/wp-content/uploads/1/01_022.png}

#### Быстрая отладка
Теперь проверьте ваши первые изменения в прикладном решении.
Для этого нужно запустить проект. Запустить проект можно просто на исполнение или в режиме отладки. Поскольку вся книга посвящена разработке конфигурации, то и запускать проект вы будете в режиме отладки.
Для этого выделите проект в панели Навигатор и нажмите F11 – это самый быстрый способ. Если вдруг вы забудете эту клавишу, можете нажать  в командной панели основного окна – результат будет тот же.
Сейчас вы первый раз запускаете отладку своего проекта, поэтому 1С:EDT поможет вам создать некоторые отсутствующие пока части проекта: конфигурацию запуска и информационную базу. В дальнейшем, когда вы будете запускать отладку, эти элементы уже создаваться не будут.
Итак, после нажатия F11 1С:EDT начнет создавать конфигурацию запуска. Она содержит информацию о том, какой проект нужно запустить, какую информационную базу использовать для запуска и др.
Сначала 1С:EDT спросит вас о том, какое клиентское приложение запускать. Выберите Тонкий клиент 1С:Предприятия и нажмите ОК (рис. 1.23).

Рис. 1.23. Выбор клиентского приложения {https://ai2b.pro/wp-content/uploads/1/01_023.png}
После этого 1С:EDT предложит вам выбрать одну из имеющихся информационных баз, чтобы загрузить в нее конфигурацию и запустить прикладное решение. Поскольку у вас пока еще нет ни одной информационной базы, нужно создать новую.
Чтобы создать новую базу, нажмите на значок  (рис. 1.24)

Рис. 1.24. Создать новую информационную базу {https://ai2b.pro/wp-content/uploads/1/01_024.png}
1С:EDT запустит мастер добавления информационной базы. На первом шаге ничего не меняйте (вам действительно надо создать новую информационную базу) и нажмите Далее (рис. 1.25).

Рис. 1.25. Добавление информационной базы {https://ai2b.pro/wp-content/uploads/1/01_025.png}
На следующем шаге выберите пункт Создание информационной базы без конфигурации… и нажмите Далее (рис. 1.26).

Рис. 1.26. Начальное содержание информационной базы {https://ai2b.pro/wp-content/uploads/1/01_026.png}
На следующем шаге задайте имя информационной базы. Чтобы не запутаться, назовите ее так же, как и проект – Услуги (рис. 1.27).

Рис. 1.27. Настройка размещения информационной базы {https://ai2b.pro/wp-content/uploads/1/01_027.png}
Остальные параметры менять не нужно, они вас устраивают: для создания базы 1C:EDT выберет самую старшую версию платформы «1С:Предприятие 8.3», которая есть на вашем компьютере, а располагаться эта база будет тоже на вашем компьютере. Нажмите Далее.
На следующем шаге ничего не меняйте и нажмите Далее (рис. 1.28).

Рис. 1.28. Настройки локального размещения информационной базы {https://ai2b.pro/wp-content/uploads/1/01_028.png}
На следующем шаге тоже ничего не меняйте и нажмите Готово (рис. 1.29).

Рис. 1.29. Установка параметров запуска для информационной базы {https://ai2b.pro/wp-content/uploads/1/01_029.png}
В результате 1C:EDT создаст информационную базу и задаст вопрос, на который вы можете ответить Нет (рис. 1.30).

Рис. 1.30. Безопасное хранилище {https://ai2b.pro/wp-content/uploads/1/01_030.png}
Дело в том, что 1C:EDT сохраняет настройки доступа к информационным базам в защищенном внутреннем хранилище. Это хранилище шифрует данные, здесь можно задать пароль и наводящий вопрос для него. Для учебного примера это не нужно, поэтому нажмите Нет.
После этого мастер создания информационной базы закончит свою работу и 1C:EDT подставит только что созданную информационную базу в исходный диалог (рис. 1.31).

Рис. 1.31. Новое приложение информационной базы {https://ai2b.pro/wp-content/uploads/1/01_031.png}
На этом все подготовительные действия, которые нужны для первого запуска приложения (создание информационной базы, создание конфигурации запуска), закончены. Если сейчас вы нажмете Готово, то запустится проект в режиме отладки и вы увидите приложение «1С:Предприятия».
Теперь, когда в дальнейшем будете нажимать F11, чтобы запустить проект в режиме отладки, вы сразу же будете видеть то, что увидите сейчас. Нажмите Готово.

### В прикладном решении
Перед вами пустое прикладное решение. В заголовке окна вы видите название (синоним) вашей конфигурации – Бытовые услуги. Пустое пространство – это рабочая область приложения, которая пока ничем не заполнена (рис. 1.32).

Рис. 1.32. Прикладное решение {https://ai2b.pro/wp-content/uploads/1/01_032.png}
Больше ничего не появилось. Так произошло потому, что вы еще не создали никаких объектов конфигурации и не создали никаких подсистем, в которых бы эти объекты отображались.
О подсистемах как основе разработки интерфейса прикладного решения и пойдет речь на следующем занятии. А пока, взглянув на список кратких итогов первого занятия, проверьте, насколько хорошо вы усвоили изложенный материал.

## Занятие 2 (0:45). Подсистемы
Продолжительность
Ориентировочная продолжительность занятия – 45 минут.
На этом занятии вы познакомитесь с объектом конфигурации Подсистема как основой декларативного описания интерфейса «1С:Предприятия».
Вы создадите несколько подсистем, определяющих логическую структуру прикладного решения, настроите их внешний вид и порядок их следования в интерфейсе прикладного решения.
В этой главе вам понадобятся картинки для подсистем, поставляемые с книгой, поэтому скачайте их с портала ИТС, разархивируйте и сохраните к себе на компьютер. Подробнее – в разделе «Что содержится в дополнительных материалах».
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Что такое подсистема
Подсистемы – это основные элементы для построения интерфейса прикладного решения. Поэтому первое, с чего следует начинать разработку конфигурации, – проектирование состава подсистем.
При этом вы как разработчик прикладного решения должны тщательно продумать состав подсистем, а затем аккуратно и осмысленно привязать к подсистемам те объекты конфигурации, которые вы будете создавать.
В простых прикладных решениях можно не использовать подсистемы, но в конфигурации, которую вы будете разрабатывать, подсистемы используются. И дальше вы увидите, насколько это необходимо (даже в небольших, казалось бы, конфигурациях) – «разложить все по местам, а не сваливать в общую кучу».
Объекты конфигурации Подсистема позволяют выделить в конфигурации функциональные части, на которые логически разбивается создаваемое прикладное решение.
Эти объекты располагаются в ветке Общие и позволяют строить древовидную структуру, состоящую из подсистем и подчиненных им подсистем (рис. 2.1).

Рис. 2.1. Структура подсистем конфигурации {https://ai2b.pro/wp-content/uploads/1/02_001.png}
Подсистемы верхнего уровня являются основными элементами интерфейса, так как образуют разделы прикладного решения (рис. 2.2).

Рис. 2.2. Разделы прикладного решения {https://ai2b.pro/wp-content/uploads/1/02_002.png}
Каждый объект конфигурации может быть включен в одну или сразу несколько подсистем, в которых он будет отображаться.
Забегая вперед, скажем, что с помощью подсистем, используя видимость по ролям, можно предоставить пользователю удобный и функциональный интерфейс, не содержащий лишних элементов. Например, кладовщик должен иметь возможность принять и выдать товар, и ему совсем не нужно видеть все, что относится к области бухгалтерского учета и оказанию услуг.
Таким образом, наличие подсистем определяет структуру прикладного решения, организует весь пользовательский интерфейс, позволяет рассортировать различные документы, справочники и отчеты по логически связанным с ними разделам, в которых пользователю будет проще их найти и удобнее с ними работать. При этом каждому конкретному пользователю будут видны лишь те разделы, то есть та функциональность прикладного решения, которые ему нужны в процессе работы.
Конфигурация, которую вы будете разрабатывать, достаточно небольшая, но все равно в ней можно выделить несколько функциональных частей, представляющих собой отдельные предметные области.
Так, можно выделить в отдельную подсистему все, что имеет отношение к бухгалтерскому учету.
Кроме того, отдельной предметной областью является расчет зарплаты сотрудников предприятия.
Всю производственную деятельность фирмы ООО «На все руки мастер», которую вы будете автоматизировать, можно разделить на учет материалов и оказание услуг.
А кроме того, для выполнения специальных административных функций с базой данных вам будет нужна отдельная подсистема, в которую будет иметь доступ только администратор.
Поэтому сейчас вы создадите в вашей конфигурации пять новых объектов конфигурации Подсистема, которые будут иметь имена Бухгалтерия, РасчетЗарплаты, УчетМатериалов, ОказаниеУслуг и Предприятие.

### Создание подсистемы
Создание новых объектов в дереве конфигурации выполняется всегда одним и тем же способом. Дерево заранее содержит все ветки, в которые вы можете что-то добавить. Поэтому в панели Навигатор вам нужно выбрать интересующую вас ветку и в контекстном меню нажать Создать. Далее откроется подменю, которое будет содержать все объекты, которые можно добавить в эту ветку.
После того как вы добавите объект конфигурации «верхнего уровня», например Справочник, подменю Создать этого объекта будет содержать подчиненные ему объекты (реквизиты, табличные части, реквизиты табличных частей и т. п.), которые вы можете создать у этого справочника. То же самое касается и других объектов конфигурации – документов, регистров и т. д.
Но этим вы займетесь на следующих занятиях, пока же вам просто нужно создать несколько подсистем.
Для этого в панели Навигатор нажмите Создать > Подсистема в контекстном меню ветки Общие > Подсистемы (рис. 2.3).

Рис. 2.3. Создание новой подсистемы {https://ai2b.pro/wp-content/uploads/1/02_003.png}
Задайте имя подсистемы – Бухгалтерия. На основании имени автоматически будет создан синоним – Бухгалтерия (рис. 2.4).

Рис. 2.4. Создание новой подсистемы {https://ai2b.pro/wp-content/uploads/1/02_004.png}

#### Имя и синоним объекта конфигурации
Имя является основным свойством любого объекта конфигурации. При создании нового объекта система автоматически присваивает ему некоторое имя.
Можно использовать имя, присвоенное системой, но лучше заменить его своим, понятным. Имя можно задавать любое, главное – чтобы оно начиналось с буквы и не содержало некоторых специальных символов (например, пробелов).
Для удобства чтения конфигурации принято составлять интуитивно понятные имена и, если они состоят из нескольких слов, удалять пробелы между словами и каждое слово начинать с большой буквы. Имя объекта является уникальным и служит для обращения к свойствам и методам объекта на встроенном языке.
Свойство Синоним также есть у любого объекта конфигурации. Оно предназначено для хранения альтернативного наименования объекта конфигурации, которое будет использовано в элементах интерфейса прикладного решения, то есть будет показано пользователю. Поэтому на синоним практически нет никаких ограничений, и его можно задавать в привычном для человека виде.

#### Редактор объекта конфигурации
Нажмите Готово. В результате в панели Навигатор в ветке Подсистемы появится новая подсистема Бухгалтерия. В области редакторов (в центре основного окна) откроется редактор объекта конфигурации подсистемы Бухгалтерия на закладке Основные, а панель Свойства покажет все свойства этой подсистемы (рис. 2.5).

Рис. 2.5. Создание новой подсистемы {https://ai2b.pro/wp-content/uploads/1/02_005.png}
Редактор предназначен для редактирования свойств сложных объектов конфигурации. Все свойства объекта сгруппированы на отдельных закладках Основные, Состав, Права и т. п., расположенных в нижней части окна редактора. Таким образом, перемещаясь между закладками, можно быстро просмотреть или изменить свойства объекта.
При этом редактор каждого нового объекта конфигурации открывается на отдельной закладке в заголовке области редакторов и остается открытым (в том числе в различных сессиях 1С:EDT), пока вы сами не закроете эту закладку. Чтобы снова открыть редактор объекта конфигурации, достаточно дважды щелкнуть мышью на интересующем вас объекте в панели Навигатор.

#### Картинка подсистемы
В интерфейсе прикладного решения новая подсистема будет сопровождаться стандартной картинкой . Но эта картинка «неинтересная» и неинформативная. И поскольку вы собираетесь создать несколько подсистем, то нужно, чтобы разделы прикладного решения отличались друг от друга не только заголовком, но и картинкой.
Чтобы установить картинку для подсистемы, в редакторе подсистемы нажмите кнопку выбора («…») в поле Картинка (см. рис. 2.5).
В окне выбора картинки нажмите Добавить на закладке Из конфигурации. В открывшемся мастере Новая общая картинка задайте имя картинки – Бухгалтерия. Чтобы установить саму картинку, нажмите «…» в поле Выбрать из файла (рис. 2.6).


Рис. 2.6. Выбор картинки для представления подсистемы {https://ai2b.pro/wp-content/uploads/1/02_006.png}
Выберите картинку Бухгалтерия из той папки, в которую вы положили все картинки. Задайте имя картинки – Бухгалтерия. Нажмите Готово (рис. 2.7).

Рис. 2.7. Создание общей картинки {https://ai2b.pro/wp-content/uploads/1/02_007.png}
В результате добавленная вами картинка появится в списке картинок на закладке Из конфигурации. Нажмите ОК (рис. 2.8).

Рис. 2.8. Выбор картинки для представления подсистемы {https://ai2b.pro/wp-content/uploads/1/02_008.png}
После ваших действий в панели Навигатор в ветке Общие картинки появилась картинка Бухгалтерия, которую вы можете редактировать и использовать в дальнейшем в вашей конфигурации (рис. 2.9).

Рис. 2.9. Общие картинки в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/02_009.png}
В редакторе подсистемы Бухгалтерия вы видите, что выбранная вами одноименная картинка установилась в качестве картинки для подсистемы (рис. 2.10).

Рис. 2.10. Картинка, установленная для подсистемы {https://ai2b.pro/wp-content/uploads/1/02_010.png}
На вкладке редактора вы видите звёздочку * – признак модифицированности данных. Чтобы сохранить измененные данные, нажмите Ctrl+S.
Это характерная черта работы в редакторах – измененные данные нужно сохранять в явном виде. Если бы вы изменяли картинку подсистемы через панель Свойства, то ваши изменения были бы применены автоматически.
Теперь добавьте еще четыре подсистемы с именами УчетМатериалов, ОказаниеУслуг, РасчетЗарплаты и Предприятие. Установите для них в качестве картинок соответственно общие картинки Материалы, Услуги, Зарплата и Предприятие, добавив их из одноименных файлов изображений. Используйте для этого и панель Свойства, и редактор подсистемы.


### Панель разделов прикладного решения
Запустите проект в режиме отладки и оцените результат ваших действий.
Тут надо обратить внимание на следующий момент. Если в конце предыдущего занятия вы оставили приложение запущенным, то, когда вы попытаетесь выполнить отладку, вам будет предложено перезапустить приложение (рис. 2.11).

Рис. 2.11. Перезапуск приложения {https://ai2b.pro/wp-content/uploads/1/02_011.png}
Нажмите Перезапустить приложение – тогда запущенное приложение будет закрыто и запущено заново.
Так как вы изменили проект, 1C:EDT предложит вам обновить приложение. Нажмите Да (рис. 2.12).

Рис. 2.12. Обновление приложения {https://ai2b.pro/wp-content/uploads/1/02_012.png}
Вы видите, что внешний вид разрабатываемого вами приложения изменился (рис. 2.13).

Рис. 2.13. Прикладное решение {https://ai2b.pro/wp-content/uploads/1/02_013.png}
Сразу под заголовком приложения с названием вашей конфигурации располагается панель разделов приложения, где и отражены созданные вами подсистемы. Причем все разделы выводятся с выбранными в их свойствах картинками.
Разделы представлены в форме гиперссылок, нажав на которые, пользователь может открыть связанные с ними документы, справочники, отчеты и т. п. Сейчас состав разделов пуст, так как вы еще не создали наполняющих их объектов конфигурации.
ПРИМЕЧАНИЕ
Обратите внимание, что раздел Главное формируется платформой по умолчанию. Этот раздел всегда располагается первым в панели разделов. Он предназначен для размещения наиболее часто используемых пользователем документов, отчетов и т. п.

### Порядок разделов
В 1C:EDT
Как вы видите, разделы прикладного решения располагаются друг за другом в алфавитном порядке. А хотелось бы сгруппировать их по функциональности и частоте использования.
Перейдите в 1С:EDT и измените порядок следования подсистем. Это можно сделать в редакторе командного интерфейса. Чтобы открыть этот редактор, в панели Навигатор нажмите Открыть командный интерфейс в контекстном меню конфигурации (рис. 2.14).

Рис. 2.14. Вызов редактора командного интерфейса {https://ai2b.pro/wp-content/uploads/1/02_014.png}
В редакторе, в списке слева, вы увидите список созданных вами подсистем (разделов приложения). С помощью кнопок Вверх, Вниз или просто потянув мышью, можно изменить порядок расположения разделов в этом списке.
Расположите сначала подсистемы, отражающие производственную деятельность фирмы: Учет материалов и Оказание услуг, затем бухгалтерскую деятельность и расчет зарплаты сотрудников: Бухгалтерия и Расчет зарплаты, а затем подсистему Предприятие (рис. 2.15). Сохраните изменения.

Рис. 2.15. Редактор командного интерфейса {https://ai2b.pro/wp-content/uploads/1/02_015.png}

#### В 1C:EDT
Как вы видите, разделы прикладного решения располагаются друг за другом в алфавитном порядке. А хотелось бы сгруппировать их по функциональности и частоте использования.
Перейдите в 1С:EDT и измените порядок следования подсистем. Это можно сделать в редакторе командного интерфейса. Чтобы открыть этот редактор, в панели Навигатор нажмите Открыть командный интерфейс в контекстном меню конфигурации (рис. 2.14).

Рис. 2.14. Вызов редактора командного интерфейса {https://ai2b.pro/wp-content/uploads/1/02_014.png}
В редакторе, в списке слева, вы увидите список созданных вами подсистем (разделов приложения). С помощью кнопок Вверх, Вниз или просто потянув мышью, можно изменить порядок расположения разделов в этом списке.
Расположите сначала подсистемы, отражающие производственную деятельность фирмы: Учет материалов и Оказание услуг, затем бухгалтерскую деятельность и расчет зарплаты сотрудников: Бухгалтерия и Расчет зарплаты, а затем подсистему Предприятие (рис. 2.15). Сохраните изменения.

Рис. 2.15. Редактор командного интерфейса {https://ai2b.pro/wp-content/uploads/1/02_015.png}

#### В прикладном решении
Запустите проект в режиме отладки. Теперь вы видите, что порядок расположения подсистем в панели разделов приложения изменился так, как вы задали (рис. 2.16).

Рис. 2.16. Прикладное решение {https://ai2b.pro/wp-content/uploads/1/02_016.png}
ПРИМЕЧАНИЕ
Если пользователь хочет настроить свой индивидуальный порядок следования разделов прикладного решения, то он может это сделать в прикладном решении по команде главного меню Настройки > Настройка панели разделов… (рис. 2.17). При этом необходимо иметь в виду, что настройка панели разделов в 1С:EDT будет актуальна для всех пользователей прикладного решения. В то время как настройка панели разделов в прикладном решении будет доступна только тому пользователю, который ее выполнил.

Рис. 2.17. Настройка панели разделов {https://ai2b.pro/wp-content/uploads/1/02_017.png}
Заметьте, что если список подсистем не помещается на панель разделов, то появляется возможность прокрутки этой панели (рис. 2.18).

Рис. 2.18. Прокрутка панели разделов {https://ai2b.pro/wp-content/uploads/1/02_018.png}
На следующем занятии вы начнете создавать первые объекты конфигурации, привязывать их к различным подсистемам и увидите конкретное применение подсистем в интерфейсе прикладного решения.

### Теория: редактор объекта конфигурации и панель «Свойства»
На первый взгляд, редактор объекта конфигурации и панель Свойства (при совместной работе с панелью Навигатор) дублируют друг друга. В самом деле, в панели Свойства отображены все свойства объекта конфигурации. Зачем было создавать еще и редактор объекта? И если существует редактор объекта, то зачем тогда панель Свойства, которая содержит все то же самое, только в другом виде?
Редактор объекта конфигурации обеспечивает быстрый доступ к таким элементам конфигурации, которые не представлены в панели Свойства или представлены, но в неудобном виде. Например, в редакторе объекта конфигурации есть отдельные закладки для работы с подсистемами, в которые включается объект, для работы с функциональными опциями, связанными с этим объектом, для работы с предопределенными данными объекта и др.
Кроме этого на отдельных закладках редактора находятся модули, принадлежащие этому объекту (например, модуль объекта и модуль менеджера). Поэтому, если вы уже открыли редактор для изменения каких-то свойств объекта, можно быстро перейти к редактированию его модулей. И наоборот.
Что же касается панели Свойства, то она предоставляет одну абсолютно незаменимую возможность. Дело в том, что она не привязана по своей структуре к какому-то конкретному классу объектов конфигурации. Ее содержимое меняется в зависимости от того, какой объект является текущим. Благодаря этому с ее помощью можно быстро просматривать значения некоторого свойства у разных объектов конфигурации, перемещаясь по дереву конфигурации.
Если же вы хотите, наоборот, закрепить информацию, которая есть в панели Свойства, то нажмите  в командной панели. При перемещении по дереву конфигурации содержимое панели Свойства меняться не будет.
Кроме того, чтобы быстро найти нужное вам свойство среди множества свойств объекта в панели Свойства, удобно пользоваться строкой поиска, расположенной в начале панели, с помощью которой вы можете показать только те свойства, имена которых соответствуют введенному фрагменту.

## Занятие 3 (2:10). Справочники
Продолжительность
Ориентировочная продолжительность занятия – 2 часа 10 минут.
На этом занятии вы познакомитесь с объектом конфигурации Справочник. Вы узнаете, для чего используется этот объект, какова его структура и какими основными свойствами он обладает.
На практических примерах вы научитесь создавать справочники, описывать наиболее важные элементы их структуры и заполнять их данными.
Кроме этого вы узнаете еще об одном объекте конфигурации – Форма. Узнаете, какие виды форм существуют у объекта конфигурации Справочник и в каких ситуациях они используются.
В заключение в конце занятия будет сделано теоретическое отступление, касающееся механизма внесения изменений в конфигурацию.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Что такое справочник
Объект конфигурации Справочник предназначен для работы со списками данных. Как правило, в работе любой фирмы используются списки сотрудников, списки товаров, списки клиентов, поставщиков и т. д. Свойства и структура этих списков описываются в объектах конфигурации Справочник, на основе которых платформа создает в базе данных таблицы для хранения информации из этих справочников.
Справочник состоит из элементов. Например, для справочника сотрудников элементом является сотрудник, для справочника товаров – товар, и т. д. Пользователь в процессе работы может самостоятельно добавлять новые элементы в справочник – например, добавить новых сотрудников, создать новый товар или внести нового клиента.
В базе данных каждый элемент справочника представляет собой отдельную запись в основной таблице, хранящей информацию из этого справочника (рис. 3.1).

Рис. 3.1. Справочник «Товары» в 1C:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/03_001.png}
Каждый элемент справочника, как правило, содержит некоторую дополнительную информацию, которая подробнее описывает этот элемент.
Например, все элементы справочника Товары могут содержать дополнительную информацию о производителе, сроке годности и др. Набор такой информации является одинаковым для всех элементов справочника, и для описания такого набора используются реквизиты объекта конфигурации Справочник, которые также, в свою очередь, являются объектами конфигурации (рис. 3.2).

Рис. 3.2. Реквизит, созданный разработчиком {https://ai2b.pro/wp-content/uploads/1/03_002.png}
Поскольку эти объекты конфигурации логически связаны с объектом Справочник, они называются подчиненными этому объекту.
Большинство реквизитов разработчик создает самостоятельно, однако у каждого объекта конфигурации Справочник по умолчанию существует набор стандартных реквизитов: Код, Наименование и пр.
Стандартно эти реквизиты не отображаются в панели Навигатор, но вы можете включить их. Для этого в меню панели Навигатор нажмите Фильтры и настройки… (рис. 3.3).

Рис. 3.3. Фильтры и настройки {https://ai2b.pro/wp-content/uploads/1/03_003.png}
После этого снимите флажок Стандартные реквизиты и табличные части и нажмите ОК (рис. 3.4).

Рис. 3.4. Стандартные реквизиты и табличные части {https://ai2b.pro/wp-content/uploads/1/03_004.png}
В результате ветка со стандартными реквизитами появится в панели Навигатор (рис. 3.5).

Рис. 3.5. Стандартные реквизиты {https://ai2b.pro/wp-content/uploads/1/03_005.png}
Доступность стандартных реквизитов зависит от свойств справочника. Например, если справочник иерархический, у него будет доступен стандартный реквизит Родитель. Если справочник подчинен другому объекту конфигурации, у него будет доступен реквизит Владелец. Если установить длину стандартного реквизита Код равной нулю, то у справочника будет недоступен этот реквизит. То же самое относится к реквизиту Наименование. Однако как минимум либо Код, либо Наименование должны присутствовать в реквизитах справочника, иначе такой справочник не имеет смысла.
Таким образом, в базе данных справочник хранится в виде таблицы, в строках которой расположены элементы списка, а каждому реквизиту (стандартному или созданному разработчиком) в этой таблице соответствует отдельный столбец. Соответственно, в ячейках этой таблицы хранится значение конкретного реквизита для конкретного элемента справочника (рис. 3.6).

Рис. 3.6. Справочник «Товары» в 1C:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/03_006.png}
Кроме этого каждый элемент справочника может содержать некоторый набор информации, которая одинакова по своей структуре, но различна по количеству и предназначена для разных элементов справочника.
Так, например, каждый элемент справочника Сотрудники может содержать информацию о составе семьи сотрудника. Для одного сотрудника это будет только супруга, а у другого семья может состоять из супруги, сына и дочери.
Для описания подобной информации могут быть использованы табличные части объекта конфигурации Справочник, являющиеся подчиненными ему объектами конфигурации. В этом случае в базе данных будут созданы дополнительные таблицы для хранения табличных частей, подчиненных конкретному элементу справочника (рис. 3.7).

Рис. 3.7. Справочник «Сотрудники» в 1C:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/03_007.png}
Причем система скрывает от вас всю «техническую» часть, связанную с хранением данных: в базе данных для справочника создаются несколько таблиц, эти таблицы связываются по уникальному полю (Ссылка), поля таблиц имеют определенные типы и т. д. Все это система делает сама. Вам лишь нужно создать для объекта конфигурации Справочник подчиненный ему объект ТабличнаяЧасть.
Для удобства использования элементы справочника могут быть сгруппированы пользователем по какому-либо принципу.
Например, в справочнике Бытовая техника могут быть созданы следующие группы: Холодильники, Телевизоры, Стиральные машины и т. д. Возможность создания таких групп в справочнике задается свойством Иерархический объекта конфигурации Справочник. В этом случае элемент справочника, представляющий собой группу, будет являться родителем для всех элементов и групп, входящих в эту группу. Такой вид иерархии называется иерархией групп и элементов (рис. 3.8).

Рис. 3.8. Иерархический справочник с иерархией групп и элементов {https://ai2b.pro/wp-content/uploads/1/03_008.png}
Возможен и другой вид иерархии – иерархия элементов. В этом случае в качестве родителя выступает не группа элементов справочника, а непосредственно один из его элементов. Например, такой вид иерархии можно использовать при создании справочника Подразделения, когда одно подразделение является родителем для нескольких других, входящих в его состав (рис. 3.9).

Рис. 3.9. Иерархический справочник с иерархией элементов {https://ai2b.pro/wp-content/uploads/1/03_009.png}
Элементы одного справочника могут быть подчинены элементам или группам другого справочника. Например, справочник КонтактныеЛица может быть подчинен справочнику Партнеры. Тогда для каждого партнера вы сможете указать его сотрудников, с которыми нужно контактировать.
В системе «1С:Предприятие» это достигается путем указания списка владельцев для каждого объекта конфигурации Справочник. В данном случае справочник Партнеры будет владельцем справочника КонтактныеЛица (рис. 3.10).

Рис. 3.10. Справочник «Партнеры» – владелец справочника «Контактные лица» {https://ai2b.pro/wp-content/uploads/1/03_010.png}
Порой возникают ситуации, когда необходимо, чтобы в справочнике некоторые элементы существовали всегда, независимо от действий пользователя. Допустим, логика бизнес-процессов на предприятии такова, что все товары сначала поступают на основной склад, а затем по мере надобности перемещаются на другие склады. В этом случае в справочнике Склады всегда должен существовать склад Основной, иначе оприходование товаров будет выполнено неправильно. Объект конфигурации Справочник позволяет описать любое количество таких элементов справочника. Они называются предопределенными элементами (рис. 3.11).

Рис. 3.11. Справочник «Склады» с предопределенным элементом «Основной» {https://ai2b.pro/wp-content/uploads/1/03_011.png}
Предопределенные элементы отличаются от обычных тем, что они создаются в процессе разработки конфигурации и что к ним можно обращаться из встроенного языка. В интерфейсе предопределенные элементы справочника помечены специальной пиктограммой.

### Формы справочника
В зависимости от того, какие действия вы хотите выполнять со справочником, вам требуется изображать справочник по-разному.
Например, для того чтобы выбрать некоторый элемент справочника, удобнее представить справочник в виде списка, а для того чтобы изменить какой-то элемент справочника, удобнее представить все реквизиты этого элемента справочника в одной форме (рис. 3.12).

Рис. 3.12. Форма списка и форма редактирования элемента справочника «Сотрудники» {https://ai2b.pro/wp-content/uploads/1/03_012.png}
Система может самостоятельно сгенерировать все формы, которые нужны для представления данных, содержащихся в справочнике. Причем система знает, какие именно формы нужно использовать в каких ситуациях.
Вообще говоря, для отображения справочника в различных ситуациях требуется максимум пять форм для справочника.
Обратите внимание, что в мастере Новая форма названия форм немного другие, чем в остальных местах 1С:EDT (табл. 3.1).
Таблица 3.1. Формы справочника
























Различные наименования форм справочника представлены на рис. 3.13, 3.14.

Рис. 3.13. Названия форм справочника в мастере «Новая форма» {https://ai2b.pro/wp-content/uploads/1/03_013.png}

Рис. 3.14. Названия форм справочника в панелях и контекстном меню {https://ai2b.pro/wp-content/uploads/1/03_014.png}
Форма элемента используется для редактирования или создания элемента справочника.
Форма группы используется для редактирования или создания группы справочника. Группа, как правило, содержит гораздо меньше информации, чем сам элемент справочника. Поэтому для нее нужна отдельная форма, отличная от формы элемента (рис. 3.15).

Рис. 3.15. Форма группы и форма элемента справочника {https://ai2b.pro/wp-content/uploads/1/03_015.png}
Форма списка используется для отображения списка элементов справочника.
Форма выбора используется для того, чтобы в поле некоторой формы выбрать один из элементов справочника. При этом форма выбора проще, чем форма списка, так как в форме списка может показываться много реквизитов. А при выборе элемента (в документе, например) вам нужно знать только наименование. Поэтому можно для выбора использовать отдельную, более простую, форму (рис. 3.16).

Рис. 3.16. Форма выбора и форма списка справочника {https://ai2b.pro/wp-content/uploads/1/03_016.png}
Форма выбора группы используется, когда в поле некоторой формы нужно выбрать не просто элемент справочника, а одну из его групп. При этом форма выбора группы проще, чем форма выбора элемента, так как группа, как правило, содержит гораздо меньше информации, чем сам элемент справочника.
При этом для всех ссылочных объектов конфигурации (справочников, документов и т. д.) будет использоваться форма объекта, но нужно понимать, что под объектом здесь понимается объект информационной базы, то есть «элемент» того, что хранит этот объект конфигурации. Для справочника это будет элемент справочника, для документа – документ, для плана счетов – счет и т. д.
Любая форма может быть описана в 1С:EDT. Для создания такого описания существует подчиненный объект конфигурации Форма (рис. 3.17).

Рис. 3.17. Форма элемента справочника в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/03_017.png}
Как правило, объект конфигурации Форма подчинен одному из прикладных объектов, но может существовать и самостоятельно.
На основании описания, содержащегося в объекте конфигурации Форма, в нужный момент работы платформа «1С:Предприятие» создаст программный объект ФормаКлиентскогоПриложения, с которым и будет работать пользователь.
Таким образом, форма служит для визуализации данных, находящихся в базе данных. Она представляет эти данные в удобном для пользователя виде и позволяет описать алгоритмы, которые будут сопровождать работу пользователя с данными, показанными в форме.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы со справочниками, можно прочитать в разделе «Краткий справочник разработчика. Справочники».

### Простой справочник
Теперь, когда вы немного познакомились с возможностями объекта конфигурации Справочник, добавьте несколько таких объектов, чтобы описать справочники, которые будут использоваться в вашей базе данных.
Так как ООО «На все руки мастер», деятельность которого вы автоматизируете, оказывает услуги по ремонту бытовой техники, очевидно, что для ведения учета вам потребуется хранить некоторую списочную информацию.
Для начала вам понадобится список сотрудников предприятия, которые будут оказывать услуги.
Затем вам будет нужен список клиентов, с которыми работает ООО «На все руки мастер».
После этого вам понадобится список материалов, которые могут быть израсходованы на оказываемые услуги.
Кроме этого вам потребуется список складов, на которых могут находиться материалы ООО «На все руки мастер».
Начните с самого простого – списка сотрудников и списка клиентов. Сначала добавьте справочник, в котором будут храниться наименования клиентов.
#### В 1C:EDT
Добавьте в конфигурацию справочник с именем Клиенты.
Кроме имени и синонима справочника вы можете установить дополнительные свойства, определяющие пользовательское представление объектов. Эти свойства задавать не обязательно. Если они не заданы, то для представления объекта в интерфейсе прикладного решения используется синоним объекта конфигурации Справочник. Но, как будет объяснено ниже, это не всегда хорошо.

##### Представления объекта конфигурации
Представление объекта определяет название объекта в единственном числе и используется в названии стандартной команды, например команды создания объекта – Клиент: создать. Представление объекта нужно задавать тогда, когда синоним объекта конфигурации задан во множественном числе или когда он описывает множество объектов, потому что в интерфейсе автоматически формируются команды открытия списка справочника и команды создания нового элемента справочника.
Если синоним задан во множественном числе, то для команды открытия списка это вполне подходит – Клиенты, то есть посмотреть всех клиентов. Но для команды создания элемента справочника – одного клиента – это неудачный вариант.
Для этой команды нужно задать представление в единственном числе – Клиент. Представление объекта как раз и используется для того, чтобы описать, как будет выглядеть в интерфейсе команда создания нового клиента. Также оно будет использовано в заголовке формы клиента (если не указано расширенное представление объекта) и в представлении ссылки на клиент.
Расширенное представление объекта определяет заголовок формы объекта, например формы для создания нового элемента справочника. Если это свойство не задано, то вместо него используется свойство Представление объекта.
Представление списка определяет название списка объектов и используется в названии стандартной команды, например команды открытия списка объектов – Клиенты. Представление списка нужно задавать тогда, когда синоним задан в единственном числе.
Например, это часто бывает у документов (Приходная накладная). Тогда в представлении списка нужно указывать название объекта конфигурации во множественном числе (Приходные накладные).
Расширенное представление списка определяет заголовок формы списка, например формы списка справочника. Если это свойство не задано, то вместо него используется свойство Представление списка.
В редакторе объекта конфигурации на закладке Основные установите значение свойства Представление объекта – Клиент (рис. 3.18).

Рис. 3.18. Установка основных свойств справочника {https://ai2b.pro/wp-content/uploads/1/03_018.png}
##### Принадлежность объекта к подсистемам
Перейдите на закладку Подсистемы редактора объекта конфигурации Справочник. На этой закладке можно настроить список подсистем, в которых будет отображаться справочник. Для этого нажмите  над списком подсистем.
Вы увидите подсистемы, созданные вами ранее при определении структуры приложения. Логично предположить, что список клиентов должен быть доступен в разделе Оказание услуг, так как оказываемые услуги относятся к определенному клиенту. Бухгалтерская отчетность, формируемая в разделе Бухгалтерия, также может быть представлена в разрезе клиентов.
Поэтому отметьте в списке подсистемы Бухгалтерия и ОказаниеУслуг (рис. 3.19).

Рис. 3.19. Выбор подсистем, в которых отображается справочник «Клиенты» {https://ai2b.pro/wp-content/uploads/1/03_019.png}
Справочник Клиенты будет включен в выбранные подсистемы (рис. 3.20).

Рис. 3.20. Список подсистем, в которые включается справочник «Клиенты» {https://ai2b.pro/wp-content/uploads/1/03_020.png}

##### Код и наименование справочника
Теперь перейдите на закладку Данные редактора справочника. Обратите внимание на свойства, определяющие длину кода и длину наименования.
Длина кода – важное свойство справочника. Как правило, код справочника используется для идентификации элементов справочника и содержит уникальные для каждого элемента справочника значения. Платформа может сама контролировать уникальность кодов и поддерживать автоматическую нумерацию элементов справочника. Поэтому от длины кода будет зависеть количество элементов, содержащихся в справочнике.
Стандартная длина кода – 9 символов. В результате вы можете использовать коды от 1 до 999999999 – этого вполне достаточно для такого небольшого предприятия, как ООО «На все руки мастер».
Стандартная длина наименования – 25 символов. Это явно мало, поэтому увеличьте длину наименования до 50.
Кроме того, хотелось бы, чтобы вместо обозначения стандартного реквизита справочника Наименование в интерфейсе прикладного решения выводилось бы более подходящее обозначение для клиентов. Ведь Наименование более подходит для неодушевленных предметов, а тут речь идет о людях.
Поскольку в интерфейсе прикладного решения отображаются синонимы объектов, вам нужно изменить свойство Синоним стандартного реквизита Наименование вашего справочника.
Для этого в группе свойств Стандартные реквизиты выделите реквизит Наименование. В панели Свойства будут показаны свойства этого стандартного реквизита. Установите свойство Синоним как Ф. И. О. (рис. 3.21).

Рис. 3.21. Установка свойств стандартного реквизита справочника {https://ai2b.pro/wp-content/uploads/1/03_021.png}
Теперь во всех формах данный реквизит будет иметь установленный синоним, если, конечно, вы не захотите его изменить при создании своей собственной формы.
Заодно обратите внимание, что свойство Проверка заполнения по умолчанию установлено в значение Выдавать ошибку (см. рис. 3.21). Это означает, что если реквизит Наименование не заполнен, то будет выведено сообщение об ошибке (рис. 3.27).

##### Команда создания нового элемента
Ну вот, можно уже запустить проект и оценить возможность работы с вашим первым справочником. Но, прежде чем это делать, настройте интерфейс прикладного решения, чтобы вам было удобнее вводить новые элементы справочника.
Дело в том, что для размещения стандартных команд открытия списков и создания новых объектов конфигурации в интерфейсе прикладного решения существует общий стандартный алгоритм, который вы увидите на примере справочников. Но это справедливо и для документов, планов счетов и т. п.
Этот алгоритм заключается в том, что команда для открытия списка справочника, как и команда для создания его новых элементов, автоматически добавляется в интерфейс тех разделов (подсистем), в которых будет отображаться справочник. Но команда создания новых элементов по умолчанию невидима в интерфейсе прикладного решения.
Это объясняется тем, что возможность просматривать списки справочника нужна, как правило, всегда. А возможность создания новых элементов справочника используется не так часто. Поэтому соответствующую команду следует включать только для тех справочников (объектов конфигурации), создание новых элементов которых является основной деятельностью для пользователей в данном разделе прикладного решения.
Для того чтобы включить видимость стандартной команды, вам понадобится редактор командного интерфейса.
Откройте этот редактор и выделите подсистему ОказаниеУслуг в списке разделов (подсистем) слева. Справа вы увидите все команды этой подсистемы.
При создании справочника в группу Панель навигации.Обычное добавилась команда Клиенты для открытия этого списка. Она включена по умолчанию. В группу Панель действий.Создать добавилась команда Клиент: создать для создания нового элемента справочника, но она невидима по умолчанию.
Включите видимость у этой команды (рис. 3.22).

Рис. 3.22. Редактор командного интерфейса {https://ai2b.pro/wp-content/uploads/1/03_022.png}
Для подсистемы Бухгалтерия команд для создания новых элементов справочника добавлять не нужно, так как это определяется прикладной логикой работы.
В данном случае предполагается, что основную ежедневную работу с клиентами ведет менеджер, занимающийся оказанием услуг. В том числе он создает в базе новых клиентов, если они появляются. А бухгалтерия просто обрабатывает имеющиеся в базе данные для получения регламентированной отчетности.
Именно поэтому команда создания нового клиента будет показана в разделе Оказание услуг, где работает менеджер, а для бухгалтерии она невидима, так как не предполагается, что бухгалтеры будут вводить новых клиентов.
Однако это не лишает бухгалтера такой возможности – он может создать нового клиента, используя список клиентов (открыть список клиентов и создать нового клиента). Наличие команды создания нового элемента без использования списка элементов – это вопрос удобства работы, а не ограничения прав пользователя, и вы предоставляете эту удобную возможность менеджеру, а не бухгалтеру.
#### В прикладном решении
Запустите проект в режиме отладки.
Поскольку вы создали в конфигурации справочник, при запуске проекта в информационной базе будет создана одна или несколько таблиц для хранения данных справочника. Соответственно, каждый раз после создания объектов конфигурации, вносящих изменения в структуры хранения данных, от вас потребуется подтвердить реорганизацию информационной базы. Нажмите Принять (рис. 3.23).

Рис. 3.23. Реорганизация информации {https://ai2b.pro/wp-content/uploads/1/03_023.png}


##### Панель функций текущего раздела
Перед вами откроется прикладное решение.
Как вы видите, если перейти в раздел Оказание услуг или Бухгалтерия, то под панелью разделов появится панель функций текущего раздела (рис. 3.24).

Рис. 3.24. Прикладное решение {https://ai2b.pro/wp-content/uploads/1/03_024.png}
Панель функций текущего раздела содержит команды, соответствующие выделенному разделу. В начале панели расположены команды, позволяющие открыть какие-либо списки, а затем команды, позволяющие создать новые элементы данных, сформировать какой-нибудь отчет или выполнить обработку.
В редакторе командного интерфейса для подсистемы ОказаниеУслуг (см. рис. 3.22) в группе команд Панель навигации.Обычное вы оставили без изменения видимость команды для открытия справочника Клиенты. Также эта команда по умолчанию доступна и в подсистеме Бухгалтерия. Поэтому при выборе соответствующих разделов прикладного решения в панели команд этих разделов вы видите команду для открытия вашего первого списка – Клиенты.
Обратите внимание, что название команды Клиенты определяется значением синонима объекта конфигурации Справочник, так как свойство Представление списка вы для вашего справочника не задавали.
Команды, с помощью которых можно выполнить какие-то другие действия (кроме открытия списков) в данном разделе, объединены в стандартные группы, представленные в виде подменю: Создать, Отчеты, Сервис – и группы, созданные вами как разработчиком. Подменю Создать включает в себя команды создания новых объектов базы данных – например, документов или элементов справочников.
Вы видите, что в разделе Оказание услуг рядом с командой Клиенты появилось подменю Создать. В этом подменю содержится команда Клиент: создать, которую вы сделали видимой в интерфейсе этого раздела. При помощи этой команды вы будете создавать новые элементы справочника, не открывая при этом список клиентов.
Обратите внимание, что название стандартной команды создания нового элемента Клиент определяется свойством Представление объекта, которое вы задали для этого справочника. Если бы вы это свойство не задали, то в названии команды использовался бы синоним справочника Клиенты – Клиенты. Это неудобно, так как ничем не отличается от команды открытия списка, и не совсем верно, ведь при создании элемента справочника вы создаете только одного нового клиента.
Заметьте, что у других разделов прикладного решения панель команд пуста, так как для этих подсистем вы не устанавливали возможность отображения справочника Клиенты.

##### Создание элементов справочника
Пока ваш справочник пуст, поэтому создайте несколько клиентов. Для этого нажмите Создать > Клиент. Перед вами откроется форма для создания элемента справочника (рис. 3.25).
Задайте Ф. И. О. нового клиента – Иванов Михаил Юрьевич. Код вносить не нужно, так как он генерируется автоматически. Нажмите Записать и закрыть.

Рис. 3.25. Создание нового элемента справочника {https://ai2b.pro/wp-content/uploads/1/03_025.png}
При этом в правом нижнем углу экрана появится информационное сообщение о том, какой элемент был создан либо изменен. Это позволяет не пользоваться списком, для того чтобы убедиться, что нужный элемент записан.
Создайте еще одного клиента с Ф. И. О. – Роман.
Последнего клиента с Ф. И. О. – Спиридонова Галина создайте, пользуясь формой списка клиентов.
Как уже говорилось, добавление новых элементов справочников с помощью команды Создать удобно и используется обычно в тех случаях, когда это требуется делать часто. В остальных случаях создавать новые элементы можно с помощью стандартных команд формы списка.
Для этого нажмите Клиенты. Откроется форма списка клиентов (рис. 3.26).

Рис. 3.26. Основная форма списка клиентов {https://ai2b.pro/wp-content/uploads/1/03_026.png}
Создать новый элемент справочника можно при помощи кнопки Создать в командной панели формы или клавишей Insert.
Нажмите кнопку Создать.
Обратите внимание, что поле Ф. И. О. при вводе нового клиента подсвечено красным пунктиром. Это значит, что для этого поля по умолчанию выполняется проверка заполнения. Если это поле оставить пустым и попытаться записать клиента, то будет получено сообщение об ошибке (рис. 3.27).

Рис. 3.27. Сообщение об ошибке при вводе нового элемента справочника {https://ai2b.pro/wp-content/uploads/1/03_027.png}
Так происходит потому, что система автоматически устанавливает проверку заполнения у некоторых стандартных реквизитов объектов, например у наименования справочника (если основное представление справочника в виде наименования).
Заполните Ф. И. О. клиента – Спиридонова Галина.
После создания элементов справочник будет выглядеть следующим образом (рис. 3.28).

Рис. 3.28. Список клиентов {https://ai2b.pro/wp-content/uploads/1/03_028.png}
Чтобы открыть существующий элемент справочника для редактирования, нужно дважды щелкнуть на нем мышью.
Для быстрого доступа к недавно открытым, созданным или отредактированным объектам базы данных (документам, элементам справочников и др.) можно воспользоваться историей работы пользователя, которую сохраняет «1С:Предприятие». Команда для открытия панели истории  находится в панели инструментов (рис. 3.29).

Рис. 3.29. Форма истории работы пользователя {https://ai2b.pro/wp-content/uploads/1/03_029.png}
Из панели истории можно быстро открыть недавно созданный объект базы данных (например, элемент справочника) или выполнить команду прикладного решения. Если список истории достаточно большой, то можно воспользоваться строкой поиска, находящейся вверху формы.
Однако для начинающих пользователей может быть удобно, чтобы панель истории была всегда открыта.

#### Настройка отображения панелей прикладного решения
По умолчанию панель истории не отображается в интерфейсе прикладного решения. Пользователь может самостоятельно включить отображение этой панели в прикладном решении (Главное меню > Настройки > Настройка панелей…). Или это может сделать разработчик в 1С:EDT.
Таким образом, существуют два варианта настройки отображения панелей прикладного решения: в 1С:EDT и в прикладном решении. При этом нужно понимать, что настройка панелей в 1С:EDT будет актуальна для всех пользователей прикладного решения, в то время как настройка панелей в прикладном решении будет доступна только тому пользователю, который ее выполнил. Рассмотрим оба варианта.
##### В 1C:EDT
Перейдите в 1С:EDT и измените настройку отображения панелей в редакторе интерфейса клиентского приложения. Чтобы открыть этот редактор, в панели Навигатор нажмите Открыть интерфейс клиентского приложения в контекстном меню конфигурации (рис. 3.30).

Рис. 3.30. Вызов редактора интерфейса клиентского приложения {https://ai2b.pro/wp-content/uploads/1/03_030.png}
Перетащите мышью панель истории из невидимой области внизу окна редактора, выделенной серым цветом, в нижний белый прямоугольник под рабочей областью приложения (рис. 3.31).

Рис. 3.31. Настройка расположения панелей прикладного решения {https://ai2b.pro/wp-content/uploads/1/03_031.png}
Таким образом, если вы не хотите, чтобы какая-то панель интерфейса отображалась в прикладном решении, достаточно перетащить ее в невидимую серую часть внизу окна редактора. Кроме того, при помощи перетаскивания мышью вы можете поменять расположение видимых панелей в окне прикладного решения.

##### В прикладном решении
Запустите проект в режиме отладки. Как вы видите, в нижней части окна приложения отображается панель истории работы пользователя. Нажав на ссылку в этой панели, можно открыть для редактирования один из последних измененных элементов справочника (рис. 3.32).

Рис. 3.32. Вызов клиентов из панели истории работы пользователя {https://ai2b.pro/wp-content/uploads/1/03_032.png}
Но если вы как пользователь считаете, что постоянно панель истории на экране не нужна (она только занимает лишнее место), то можете скрыть отображение этой панели в прикладном решении. Для этого в главном меню приложения нажмите Настройки > Настройка панелей.
В редакторе перетащите мышью панель истории в невидимую область, выделенную серым цветом, внизу окна (рис. 3.33).

Рис. 3.33. Настройка расположения панелей прикладного решения {https://ai2b.pro/wp-content/uploads/1/03_033.png}
Нажмите ОК. В результате панель станет невидимой в окне прикладного решения, но она всегда может быть открыта в виде отдельной формы из панели инструментов при нажатии .
Путем перетаскивания мышью можно не только изменить видимость любой панели, но и поменять ее расположение в окне прикладного решения.

### Справочник с табличной частью
Теперь вы можете перейти к созданию второго справочника, который будет использоваться в вашей конфигурации, – справочника Сотрудники.
Этот справочник будет устроен несколько сложнее, чем справочник Клиенты. Дело в том, что в нем будут храниться не только фамилия, имя и отчество сотрудника, но и информация о его прошлой трудовой деятельности.
Эта информация однородна по своей структуре (организация, начало, окончание работы, занимаемая должность), но количество предыдущих мест работы у разных сотрудников может быть различным. Поэтому для хранения такой информации вам нужно использовать табличную часть справочника.
#### В 1C:EDT
Добавьте в конфигурацию справочник с именем Сотрудники.
Задайте Представление объекта как Сотрудник, а Расширенное представление списка как Список сотрудников.
По логике конфигурации список сотрудников должен быть доступен в разделах Оказание услуг и Расчет зарплаты. Действительно, при оказании услуг должен быть указан сотрудник, оказавший эти услуги, и по результатам этой работы будет начисляться зарплата каждому сотруднику.
Поэтому включите справочник Сотрудники в подсистемы Оказание услуг и Расчет зарплаты.
Затем увеличьте длину наименования до 50 символов.
Так же как и для предыдущего справочника, измените свойство Синоним стандартного реквизита Наименование на Ф. И. О., так как речь идет о сотрудниках.
##### Табличная часть
Добавьте справочнику Сотрудники табличную часть. Для этого в панели Навигатор нажмите Создать > Табличная часть в контекстном меню справочника (рис. 3.34).

Рис. 3.34. Создание новой табличной части справочника {https://ai2b.pro/wp-content/uploads/1/03_034.png}
Задайте имя табличной части – ТрудоваяДеятельность. Нажмите Готово.
В результате в панели Навигатор в ветке Табличные части справочника Сотрудники появится новая табличная часть ТрудоваяДеятельность. Редактор справочника переключится на закладку Данные, а панель Свойства покажет свойства новой табличной части.
Теперь добавьте реквизиты табличной части. Для этого в панели Навигатор нажмите Создать > Реквизит табличной части в контекстном меню этой табличной части (рис. 3.35):

Рис. 3.35. Создание нового реквизита табличной части справочника {https://ai2b.pro/wp-content/uploads/1/03_035.png}
Табличная часть ТрудоваяДеятельность должна содержать следующие реквизиты:
Организация – тип Строка, длина 100;
НачалоРаботы – тип Дата, состав даты – Дата;
ОкончаниеРаботы – тип Дата, состав даты – Дата;
Должность – тип Строка, длина 100.
В мастере Новый реквизит укажите имя и тип перечисленных выше реквизитов и нажмите Готово (рис. 3.36).

Рис. 3.36. Свойства реквизита табличной части справочника {https://ai2b.pro/wp-content/uploads/1/03_036.png}
Для реквизитов НачалоРаботы и ОкончаниеРаботы вы выбрали состав даты – Дата, поскольку в системе «1С:Предприятие» значения типа Дата содержат как дату, так и время. В данном случае время начала и окончания работы не имеют значения.
В заключение отредактируйте командный интерфейс подсистемы Расчет зарплаты, чтобы вам было удобнее вводить новые элементы справочника. Сделайте видимой стандартную команду Сотрудник: создать.
На этом создание справочника Сотрудники завершено.

#### В прикладном решении
Запустите проект в режиме отладки.
Как вы видите, в разделах Оказание услуг и Расчет зарплаты появилась команда Сотрудники для открытия списка сотрудников. Кроме того, в разделе Расчет зарплаты появилось подменю Создать, содержащее команду Сотрудник, для создания новых сотрудников (рис. 3.37).

Рис. 3.37. Раздел «Расчет зарплаты» {https://ai2b.pro/wp-content/uploads/1/03_037.png}
Воспользуйтесь этой командой для создания новых элементов справочника, не открывая при этом списка сотрудников.

##### Заполнение табличной части
Нажмите Создать > Сотрудник. Откроется форма для создания элемента справочника с заголовком Сотрудник. Этот заголовок определяется свойством Представление объекта.
Эта форма содержит табличную часть с реквизитами, которые вы описали при конфигурировании этого справочника.
Создайте следующих сотрудников:
Гусаков Николай Дмитриевич (рис. 3.38). Трудовая деятельность:
Организация – ЗАО «НТЦ»,
Начало работы – 01.02.2017,
Окончание работы – 16.04.2022,
Должность – Ведущий специалист
Деловой Иван Сергеевич (рис. 3.39). Трудовая деятельность:
1:
Организация – ООО «Автоматизация»,
Начало работы – 22.01.2014,
Окончание работы – 31.03.2022,
Должность – Инженер.
2:
Организация – ЗАО «НПО СпецСвязь»,
Начало работы – 20.05.2004,
Окончание работы – 21.01.2014,
Должность – Начальник производства.
Симонов Валерий Михайлович (рис. 3.40). Трудовая деятельность:
Организация – ООО «СтройМастер»,
Начало работы – 05.02.2017,
Окончание работы – 03.04.2020,
Должность – Прораб.
Строки табличной части справочника можно добавлять кнопкой Добавить, Insert или просто перемещением курсора вниз из последней строки таблицы.

Рис. 3.38. Заполнение элемента справочника «Сотрудники» {https://ai2b.pro/wp-content/uploads/1/03_038.png}
Если табличная часть состоит из нескольких строк, то расположить их в произвольном порядке можно путем перетаскивания мышью в нужное место или с помощью команд Переместить вверх, Переместить вниз из подменю Еще, находящегося в командной панели таблицы. Для того чтобы удалить только что созданную пустую строку табличной части, достаточно просто установить курсор на другую, заполненную, строку таблицы.

Рис. 3.39. Заполнение элемента справочника «Сотрудники» {https://ai2b.pro/wp-content/uploads/1/03_039.png}

Рис. 3.40. Заполнение элемента справочника «Сотрудники» {https://ai2b.pro/wp-content/uploads/1/03_040.png}
Чтобы просмотреть список созданных вами сотрудников, нажмите Сотрудники в панели команд раздела Расчет зарплаты.
Откроется форма списка сотрудников (рис. 3.41).

Рис. 3.41. Список сотрудников {https://ai2b.pro/wp-content/uploads/1/03_041.png}

Теперь можно приступить к созданию следующего справочника – Номенклатура.

### Иерархический справочник
Справочник Номенклатура будет содержать информацию о материалах, которые закупаются и расходуются в ООО «На все руки мастер».
Этот справочник не будет сложным. Единственная особенность, которой он будет обладать, – наличие иерархической структуры.
Поскольку ООО «На все руки мастер» оказывает самые разные услуги, материалы, которые при этом используются, будут логически собраны в несколько групп.
#### В 1C:EDT
Добавьте в конфигурацию справочник с именем Номенклатура.
Понятие Номенклатура обычно подразумевает перечень чего-то. Поэтому, хотя имя справочника и задано в единственном числе, свойство Представления объекта нужно задать как Материал, а вместо Представления списка будет использоваться Синоним объекта – Номенклатура.
Ваша задача состоит в создании иерархического справочника. Поэтому установите свойство справочника Иерархический справочник.
По логике конфигурации список номенклатуры должен быть доступен в разделах Учет материалов, Оказание услуг и Бухгалтерия. Действительно, к первым двум разделам этот справочник имеет прямое отношение, а для бухгалтерского анализа всегда может понадобиться список материалов и услуг. Поэтому включите справочник в эти подсистемы.
Затем увеличьте длину наименования до 100 символов.
Измените свойство Синоним стандартного реквизита Родитель на более понятное обозначение – Группа материалов.
Прежде чем запускать проект, настройте интерфейс прикладного решения, чтобы вам было удобнее вводить новые элементы справочника. В подсистемах Учет материалов и Оказание услуг сделайте доступной команду Материал: создать.

#### В прикладном решении
Заполните справочник Номенклатура. В процессе заполнения вы научитесь создавать группы иерархического справочника и переносить элементы из одной группы в другую.
Запустите проект в режиме отладки.
Как вы видите, в разделах Учет материалов, Оказание услуг и Бухгалтерия появилась команда Номенклатура для открытия списка материалов. Кроме того, в разделах Учет материалов и Оказание услуг появилось подменю Создать, содержащее команду Материал, для создания новых материалов (рис. 3.41).
##### Создание элементов в иерархическом справочнике
Не открывая пока список материалов, создайте новые материалы, нажав Создать > Материал в разделе Учет материалов. Откроется форма для создания элемента справочника (рис. 3.42).

Рис. 3.42. Создание элементов справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/03_042.png}

Создайте четыре элемента. Заполняйте только наименование, а поле Группа материалов пока оставляйте пустым. В результате в корне списка должно появиться четыре материала:
Строчный трансформатор Samsung,
Транзистор Philips 2N2369,
Шланг резиновый,
Кабель электрический.
Ниже будут рассмотрены несколько полезных и удобных примеров ввода элементов иерархического справочника. В результате вы научитесь создавать новые элементы при вводе, быстро находить существующий элемент по первым буквам названия, переносить элементы между группами и т. п.

##### Перенос элементов в другие группы
Справочник Номенклатура иерархический, то есть он может содержать группы и подчиненные им группы и элементы. Пользуясь этим, вы можете разложить все материалы по смысловым группам, чтобы в них было легче ориентироваться, особенно в случае если их станет много.
Например, можно создать в списке материалов две группы: Радиодетали и Прочее. В группу Прочее поместить Кабель электрический и Шланг резиновый, а остальные материалы переместить в группу Радиодетали.
Нажмите Создать группу и создайте группу Радиодетали (рис. 3.43).

Рис. 3.43. Создание новых групп материалов {https://ai2b.pro/wp-content/uploads/1/03_043.png}

Для того чтобы переместить материалы в соответствующие группы, можно просто мышью перетащить выделенный элемент справочника в нужную группу.
Или же можно открыть для редактирования выделенный элемент справочника и изменить поле Группа материалов (рис. 3.44).

Рис. 3.44. Перенос элемента справочника в другую группу {https://ai2b.pro/wp-content/uploads/1/03_044.png}

Причем при выборе значения в поле Группа материалов можно воспользоваться удобной возможностью поиска по строке нужного значения из справочника. Достаточно ввести первые несколько букв искомого наименования, и подходящее значение будет предложено для выбора.
Теперь создайте группу Прочее. Этой группы еще нет в справочнике, но вовсе не обязательно создавать ее заранее. На этом примере вы увидите, как можно создавать недостающие элементы справочников во время их выбора в других полях.
Для материала Шланг резиновый вам нужно указать группу Прочее. Откройте этот элемент справочника и в поле Группа номенклатуры наберите «Прочее». Затем в окне выбора значения нажмите Создать (кнопка со знаком +). Таким образом платформа «поймет», что вы хотите создать новую группу, и откроет форму для создания группы справочника (рис. 3.45).

Рис. 3.45. Создание группы номенклатуры при выборе в поле «Группа материалов» {https://ai2b.pro/wp-content/uploads/1/03_045.png}

Название Прочее автоматически подставится в качестве наименования группы. Вам останется только нажать Записать и закрыть. После этого в списке номенклатуры будет создана группа Прочее и ссылка на нее будет подставлена в поле Группа номенклатуры для элемента номенклатуры Шланг резиновый.
Теперь можно обычным образом мышью перетащить оставшийся материал Кабель электрический в только что созданную группу Прочее.

##### Создание элементов справочника в текущей группе
Теперь откройте группу Радиодетали и создайте в ней еще один элемент – Строчный трансформатор LG.
Для этого нажмите Создать над списком материалов. При этом если новый элемент добавляется из формы списка в некоторую открытую группу, то система автоматически подставляет в качестве группы материалов текущую группу (рис. 3.46).

Рис. 3.46. Создание элементов в группе «Радиодетали» {https://ai2b.pro/wp-content/uploads/1/03_046.png}

В заключение, чтобы оценить результат вашей работы, представьте список материалов в виде дерева. Для этого в подменю Еще в командной панели формы списка номенклатуры нажмите Режим просмотра > Дерево. В результате список материалов будет выглядеть следующим образом (рис. 3.47).

Рис. 3.47. Список материалов в виде дерева {https://ai2b.pro/wp-content/uploads/1/03_047.png}


### Справочник с предопределенными элементами
В заключение вы создадите справочник Склады, который будет содержать информацию о складах, используемых ООО «На все руки мастер».
Ваша задача – создать справочник, содержащий предопределенные элементы. Справочник будет включать в себя один предопределенный элемент – склад Основной, на который будут поступать все материалы.
#### В 1C:EDT
Добавьте в конфигурацию справочник с именем Склады.
Задайте Представление объекта как Склад.
По логике конфигурации список складов должен быть доступен в разделах Оказание услуг и Учет материалов, так как поступление материалов и оказание услуг, как правило, учитываются в разрезе складов. Поэтому включите справочник в эти подсистемы.
##### Свойство «Быстрый выбор»
Свойство Быстрый выбор позволяет выбирать элементы не из отдельной формы, а из небольшого выпадающего списка, заполненного элементами этого справочника (рис. 3.48).

Рис. 3.48. Выбор склада из выпадающего списка {https://ai2b.pro/wp-content/uploads/1/03_048.png}

Дело в том, что по умолчанию при нажатии кнопки выбора («…») в поле, содержащем ссылку на элемент справочника, платформа открывает форму выбора элемента справочника. Это может быть не всегда удобно, особенно в том случае, когда справочник неиерархический и заведомо содержит небольшое количество элементов.
Поэтому быстрый выбор из списка складов наиболее удобен, так как их, вероятно, будет немного.
Для справочника Склады установите флажок Быстрый выбор.

##### Предопределенные элементы
Вам нужно создать справочник с предопределенными данными. Создайте у справочника предопределенный элемент с именем Основной.
Для этого в редакторе справочника на вкладке Предопределенные данные нажмите Создать в контекстном меню списка предопределенных элементов (рис. 3.49).

Рис. 3.49. Создание предопределенного элемента справочника {https://ai2b.pro/wp-content/uploads/1/03_049.png}

Задайте имя элемента – Основной. На основании имени автоматически будет создано наименование элемента – Основной. Нажмите Готово (рис. 3.50).

Рис. 3.50. Создание предопределенного элемента справочника {https://ai2b.pro/wp-content/uploads/1/03_050.png}

Обратите внимание на то, что при создании предопределенного элемента его имя и наименование одинаковы, но их назначение принципиально разное.
Наименование предопределенного элемента справочника пользователь увидит в интерфейсе прикладного решения и сможет его изменить, если потребуется. А вот имя предопределенного элемента пользователь не видит и изменить его не может. Потому что, как будет показано в дальнейшем, имя предопределенного элемента будет использоваться вами как разработчиком для обращения к этому элементу справочника с помощью встроенного языка.
Подробнее об этом рассказывается в теоретическом разделе «Предопределенные элементы» в конце этого занятия.
Прежде чем запускать проект, настройте интерфейс прикладного решения, чтобы вам было удобнее вводить новые элементы справочника. В подсистеме Учет материалов сделайте доступной стандартную команду Склад: создать.

#### В прикладном решении
Запустите проект в режиме отладки.
Как вы видите, в разделе Учет материалов в подменю Создать появилась команда Склад для создания новых складов. Кроме того, в разделах Оказание услуг и Учет материалов появилась команда Склады для открытия списка складов (рис. 3.51).

Рис. 3.51. Раздел «Учет материалов» {https://ai2b.pro/wp-content/uploads/1/03_051.png}
Нажмите Склады в разделе Учет материалов. Откроется форма списка складов.
В списке складов уже есть один элемент с наименованием Основной. Это предопределенный элемент, который вы создали в 1С:EDT. Он помечен пиктограммой .
Нажмите Создать > Склад и создайте еще один склад с наименованием Розничный (рис. 3.52).

Рис. 3.52. Элементы справочника «Склады» {https://ai2b.pro/wp-content/uploads/1/03_052.png}
На этом подготовительная работа по созданию справочников закончена.
Прочтите и обдумайте теперь небольшое теоретическое отступление, касающееся предопределенных элементов и тех вопросов, которые постоянно появляются у вас на экране при запуске и продолжении отладки.

### Теория
#### Предопределенные элементы
Обратите внимание, что система отмечает различными пиктограммами обычные и предопределенные элементы справочника (рис. 3.52).
Несмотря на то что можно изменить код или наименование у обоих элементов, имя предопределенного элемента, которое вы задали в 1C:EDT (Основной), остается неизменным, и в дальнейшем вы сможете обратиться к предопределенному элементу справочника по этому имени из встроенного языка.
Таким образом, на предопределенные элементы могут опираться алгоритмы работы конфигурации.
Из этого видно, в чем заключается принципиальная с точки зрения конфигурации разница между обычными и предопределенными элементами справочника.
Обычные элементы непостоянны для конфигурации. В процессе работы пользователя они могут появиться, исчезнуть. Поэтому конфигурация хоть и может отличить их друг от друга, но рассчитывать на них в выполнении каких-либо алгоритмов она не может в силу их непостоянства.
Предопределенные элементы, напротив, постоянны. В процессе работы пользователя они находятся всегда на своих местах и исчезнуть не могут.
То есть теоретически пользователь может их удалить, но для облегчения задачи у пользователей, которых вы создадите в дальнейшем (см. занятие 23 «Список пользователей и их роли»), не будет прав не только на интерактивное удаление предопределенных элементов, но и на интерактивное удаление объектов вообще.
Поэтому конфигурация может работать с ними вполне уверенно и опираться на них при отработке различных алгоритмов. По этой причине каждый из предопределенных элементов имеет уникальное имя – чтобы к нему можно было обратиться средствами встроенного языка.
#### Основная конфигурация и конфигурация базы данных
До сих пор структура системы «1С:Предприятие» не рассматривалась подробно, но теперь пришло время сказать об этом несколько слов.
Вспомните, на первом занятии говорилось, что с точки зрения пользователя «программа 1С» состоит из платформы и конфигурации. И что в каждом конкретном случае используется одна из множества возможных конфигураций. Настало время сказать, что это не совсем так.
Почему не так? Потому что в каждой информационной базе существуют как минимум две конфигурации.
Почему не совсем так? Потому что пользователи действительно работают всегда только с одной конфигурацией. Вторая конфигурация предназначена для разработчика или человека, который должен вносить изменения в конфигурацию (например, администратора базы данных). Для пользователей она «не видна».
Конфигурация, предназначенная для разработчика, называется основная конфигурация (или просто конфигурация – та, которую вы редактировали в 1С:EDT).
Конфигурация, с которой работают пользователи, называется конфигурация базы данных.
Основную конфигурацию можно редактировать. Конфигурацию базы данных редактировать нельзя, можно только произвести обновление конфигурации базы данных на основе основной конфигурации.
Таким образом, взаимодействие двух конфигураций можно представить следующим образом (рис. 3.53).

Рис. 3.53. Взаимодействие двух конфигураций  {https://ai2b.pro/wp-content/uploads/1/03_053.png}
Когда вы изменяете конфигурацию в панели Навигатор, 1C:EDT хранит эти изменения у себя и не передает их в информационную базу до тех пор, пока вы не решите запустить проект.
При запуске отладки 1С:EDT сначала сохраняет основную конфигурацию, а затем производит ее сравнение с конфигурацией базы данных. Если конфигурации отличаются, выдается запрос на обновление конфигурации базы данных, который вы видели в предыдущих примерах.
При перезапуске отладки, в случае если прикладное решение уже запущено, 1С:EDT предлагает еще и перезапустить приложение, чтобы прекратить текущий сеанс, запущенный в режиме отладки.
Таким образом 1С:EDT старается облегчить жизнь разработчика и автоматизировать часто выполняемые операции.
Важным является то, что именно в момент обновления конфигурации базы данных система создает (модифицирует) в базе данных те структуры хранения данных, которые вы описали в виде объектов конфигурации.
Таким образом, обычные элементы справочника пользователь добавляет в ту структуру базы данных, которую создала система на основе объекта конфигурации Справочник.
Предопределенные элементы этого справочника система добавляет в эту структуру сама на основе того описания, которое содержится в объекте конфигурации Справочник.
Отсюда следует немаловажный факт (о котором говорилось в предыдущем разделе): если простые элементы справочника «безразличны» для конфигурации, то предопределенные элементы важны для нее, поскольку на них могут быть завязаны алгоритмы работы конфигурации.

## Занятие 4 (0:45). Документы
Продолжительность
Ориентировочная продолжительность занятия – 45 мин.
На этом занятии вы познакомитесь с объектом конфигурации Документ. Вы узнаете, для чего он нужен, какова его структура и какими основными свойствами он обладает.
Затем вы создадите несколько документов и узнаете, что такое типообразующие объекты конфигурации.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Что такое документ
Объект конфигурации Документ предназначен для описания информации о совершенных хозяйственных операциях или о событиях, произошедших в жизни организации вообще. Как правило, в работе любой фирмы используются такие документы, как приходные накладные, приказы о приеме на работу, платежные поручения, счета и т. д. Свойства и структура этих документов описываются в объектах конфигурации Документ, на основе которых платформа создает в базе данных таблицы для хранения информации из этих документов.
Логика работы документов отличается от логики работы других объектов конфигурации. Документ обладает способностью проведения. Факт проведения документа означает, что событие, которое он отражает, повлияло на состояние учета.
До тех пор, пока документ не проведен, состояние учета неизменно и документ – не более чем черновик, заготовка. Как только документ будет проведен, изменения, вносимые документом в учет, вступят в силу и состояние учета будет изменено.
Поскольку документ вносит изменения в состояние учета, он всегда «привязан» к конкретному моменту времени. Это позволяет отражать в базе данных фактическую последовательность событий.
Следующим важным фактом, вытекающим из двух предыдущих, является то, что система «1С:Предприятие» имеет механизмы, позволяющие отслеживать правильность состояния учета. Предположим, вы изменили один из проведенных ранее документов и снова провели его задним числом. В этом случае система «1С:Предприятие» способна отследить, повлияют ли внесенные вами изменения на последующие проведенные документы, и, если это так, система способна перепровести необходимые документы.
В процессе работы пользователь может самостоятельно создавать новые документы: приходные и расходные накладные, счета и т. п.
В базе данных каждый документ представляет собой отдельную запись в основной таблице, хранящей информацию об этом виде документов (рис. 4.1).

Рис. 4.1. Стандартные реквизиты документа «Приходная накладная» в 1C:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/04_001.png}
Каждый документ, как правило, содержит информацию, которая подробнее описывает этот документ. Например, каждый документ Приходная накладная может содержать информацию о поставщике товаров, складе, на который приходуется товар, и т. д.
Набор такой информации является одинаковым для всех документов одного вида, и для описания такого набора используются реквизиты объекта конфигурации Документ, являющиеся подчиненными объектами конфигурации (рис. 4.2).

Рис. 4.2. Реквизит «Поставщик» документа «Приходная накладная» в 1C:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/04_002.png}
Большинство реквизитов разработчик создает самостоятельно, однако у каждого объекта конфигурации Документ по умолчанию существуют стандартные реквизиты. Два наиболее важных из них – это Дата и Номер. Поскольку тип данных Дата содержит дату и время с точностью до секунды, этот реквизит и определяет в основном положение документа на оси времени.
Кроме этого каждый документ содержит, как правило, некоторый набор информации, которая одинакова по своей структуре, но различна по количеству и предназначена для разных документов. Так, например, каждый документ Приходная накладная может содержать список приходуемых товаров.
Для описания подобной информации служат табличные части объекта конфигурации Документ. В этом случае в базе данных будут созданы дополнительные таблицы для хранения табличных частей, подчиненных конкретному документу (рис. 4.3).

Рис. 4.3. Табличная часть «Товары» документа «Приходная накладная» в 1С:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/04_003.png}

### Формы документа
Для визуализации документа существует несколько основных форм, которые, как уже говорилось, имеют несколько вариантов названий (табл. 4.1).
Таблица 4.1. Основные формы документа
















Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с документами, можно прочитать в разделе «Краткий справочник разработчика. Документы».

### Теория: типы данных, типообразующие объекты конфигурации
Прежде чем приступить к практическому созданию документов, необходимо сделать отступление о том, какие типы данных могут использоваться в системе «1С:Предприятие».
На предыдущем занятии, когда вы создавали реквизиты справочников или табличных частей, вы всегда указывали тип значения, которое может принимать этот реквизит. Это были примитивные типы данных: Число, Строка, Дата и Булево. Примитивные типы данных изначально определены в системе, и их набор ограничен.
Наряду с такими изначально определенными в любой конфигурации типами могут существовать типы данных, определяемые только конкретной конфигурацией. То есть такие типы, которые не присутствуют в конфигурации постоянно, а появляются в результате того, что в ней созданы некоторые объекты конфигурации.
Например, после того как вы добавили объект конфигурации – справочник Склады, сразу же появилось несколько новых типов данных, связанных с этим справочником. Среди них, например, СправочникСсылка.Склады. И если теперь вы укажете какому-либо реквизиту этот тип данных, то сможете хранить в нем ссылку на конкретный объект справочника Склады.
Объекты конфигурации, которые могут образовывать новые типы данных, называются типообразующими.
Например, после создания нового справочника Номенклатура становятся доступны следующие типы данных:
СправочникМенеджер.Номенклатура,
СправочникСсылка.Номенклатура,
СправочникОбъект.Номенклатура,
СправочникВыборка.Номенклатура.
Следует еще раз отметить, что эти типы данных не поддерживаются платформой изначально и существуют только в конкретном прикладном решении.
Это небольшое отступление было необходимо потому, что уже при создании первого документа вы столкнетесь с использованием типов данных СправочникСсылка.Склады и СправочникСсылка.Номенклатура, которые появились в вашей конфигурации в результате создания справочников Склады и Номенклатура.

### Документ «Приходная накладная»
После того как вы познакомились с объектом конфигурации Документ, создайте в вашей конфигурации несколько таких объектов, чтобы иметь возможность фиксировать события, происходящие в ООО «На все руки мастер».
Одними из самых популярных услуг этого предприятия являются ремонт телевизоров и установка стиральных машин. И в том и в другом случае требуются некоторые материалы, которые расходуются в процессе оказания этих услуг. Поэтому двумя важнейшими событиями в хозяйственной жизни вашей организации будут являться поступление материалов и оказание услуг.
Для отражения этих событий в базе данных вы создадите два документа: Приходная накладная и Оказание услуги.
Документ Приходная накладная будет фиксировать факт поступления в вашу организацию необходимых материалов, а документ Оказание услуги – фиксировать оказание услуг и расход материалов, которые используются при оказании этих услуг.
#### В 1С:EDT
Создание документа
Добавьте в конфигурацию документ с именем ПриходнаяНакладная.
Затем определите, как будет представлен документ в интерфейсе прикладного решения. Представление списка документов задайте во множественном числе как Приходные накладные.
По логике конфигурации список приходных накладных должен быть доступен в разделах Учет материалов и Бухгалтерия. Действительно, к первому разделу этот документ имеет прямое отношение, а для бухгалтерского анализа всегда может понадобиться список документов, отражающих поступление материалов. Поэтому включите документ в эти подсистемы.
##### Создание документа
Добавьте в конфигурацию документ с именем ПриходнаяНакладная.
Затем определите, как будет представлен документ в интерфейсе прикладного решения. Представление списка документов задайте во множественном числе как Приходные накладные.
По логике конфигурации список приходных накладных должен быть доступен в разделах Учет материалов и Бухгалтерия. Действительно, к первому разделу этот документ имеет прямое отношение, а для бухгалтерского анализа всегда может понадобиться список документов, отражающих поступление материалов. Поэтому включите документ в эти подсистемы.

##### Реквизиты ссылочного типа
Теперь создайте у документа ПриходнаяНакладная реквизит с именем Склад.
Поскольку реквизит документа – подчиненный объект конфигурации, то это делается по аналогии с созданием реквизита табличной части справочника. Но вот при выборе типа реквизита вам нужно указать не примитивный, а ссылочный тип данных СправочникСсылка.Склады, который появился в вашей конфигурации после создания справочника Склады.
Для этого в мастере Новый реквизит нажмите кнопку выбора («…») в поле Тип. В окне выбора типа данных раскройте группу СправочникСсылка. Вы увидите все ранее созданные справочники вашей конфигурации. Отметьте справочник Склады и нажмите ОК (рис. 4.4). Затем нажмите Готово.

Рис. 4.4. Свойства ссылочного реквизита документа {https://ai2b.pro/wp-content/uploads/1/04_004.png}
В результате в панели Навигатор в ветке Реквизиты документа ПриходнаяНакладная появится новый реквизит Склад. Редактор документа переключится на закладку Данные, а панель Свойства покажет свойства нового реквизита.

##### Свойство «Значение заполнения» реквизита объекта конфигурации
Теперь посмотрите, как можно облегчить жизнь пользователя при приходовании материалов. Работа в автоматизируемой вами фирме построена таким образом, что, как правило, все поступающие товары приходуются на основной склад.
Поэтому хотелось бы, чтобы при создании нового документа склад заполнялся бы сразу предопределенным значением справочника Склады – Основной, тогда пользователю не придется делать это вручную.
Для этого у свойства реквизита Значение заполнения нажмите кнопку выбора и укажите предопределенный элемент справочника Склады – Основной (рис. 4.5).

Рис. 4.5. Выбор значения заполнения по умолчанию для реквизита «Склад» {https://ai2b.pro/wp-content/uploads/1/04_005.png}
Заметьте, что после нажатия кнопки выбора в поле Значение заполнения открывается список предопределенных элементов того справочника, на который ссылается реквизит. В данном случае реквизит Склад имеет тип СправочникСсылка.Склады, поэтому вы можете выбирать из предопределенных данных справочника Склады.

##### Проверка заполнения табличной части
Создайте у документа табличную часть с именем Материалы – так же, как вы это делали для справочника Сотрудники.
Свойство Проверка заполнения для табличной части установите в значение Выдавать ошибку. Тем самым вы зададите условие, что документ Приходная накладная обязательно должен содержать табличную часть, то есть список приходуемых материалов. Иначе будет выдано сообщение об ошибке и документ не будет сохранен.
Табличная часть Материалы должна содержать следующие реквизиты:
Материал, тип СправочникСсылка.Номенклатура;
Количество, тип Число, длина 15, точность 3, неотрицательное;
Цена, тип Число, длина 15, точность 2, неотрицательное;
Сумма, тип Число, длина 15, точность 2, неотрицательное.
Для каждого реквизита табличной части также установите свойство Проверка заполнения в значение Выдавать ошибку. Тем самым при записи документа будет проверяться на заполнение не только табличная часть в целом, но и ее отдельные реквизиты (рис. 4.6).

Рис. 4.6. Свойство «Проверка заполнения» реквизитов табличной части {https://ai2b.pro/wp-content/uploads/1/04_006.png}
Прежде чем запускать проект, настройте интерфейс прикладного решения, чтобы вам было удобнее вводить новые документы. В подсистеме Учет материалов сделайте доступной команду Приходная накладная: создать.

#### В прикладном решении
Запустите проект в режиме отладки и протестируйте получившийся документ.
Как вы видите, в разделах Бухгалтерия и Учет материалов появилась команда Приходные накладные для открытия списка приходных накладных. Кроме того, в разделе Учет материалов в подменю Создать появилась команда Приходная накладная для создания новых документов этого вида (рис. 4.7).

Рис. 4.7. Раздел «Учет материалов» {https://ai2b.pro/wp-content/uploads/1/04_007.png}

##### Создание приходных накладных
Нажмите Создать > Приходная накладная в разделе Учет материалов и создайте новую приходную накладную. Откроется форма документа.
Система автоматически подставит текущую дату создания документа и нулевое время, так как документ еще не проведен. В качестве времени документа при оперативном проведении ему присваивается оперативная отметка времени.
Поле Номер не заполнено, но система сама сгенерирует для нового документа уникальный номер, так как свойство Автонумерация для документа включено по умолчанию. Новый номер будет сохранен в момент записи документа.
Обратите внимание, что склад уже заполнен значением Основной, как вы и задали в свойствах этого реквизита.
Вам осталось только заполнить табличную часть приходной накладной материалами для ремонта телевизоров так, как показано на рисунке (рис. 4.8).

Рис. 4.8. Создание нового документа «Приходная накладная № 1» {https://ai2b.pro/wp-content/uploads/1/04_008.png}
Обратите внимание, что при переходе к еще не заполненной колонке Материал (в табличной части документа) автоматически открывается окно выбора значения из справочника Номенклатура, так как этот реквизит имеет ссылочный тип данных и ссылается на справочник Номенклатура.
Как только вы начнете вводить название материала в это поле, платформа автоматически найдет материалы, наименование которых начинается с введенных вами символов, и предложит их для выбора. А также при нажатии кнопки Показать все открывается форма для выбора элементов этого справочника.
Нажмите Провести и закрыть.
Документ будет сохранен и проведен, ему будет присвоен автоматически сгенерированный системой номер и текущее время проведения документа.
Аналогичным образом создайте второй документ, который будет приходовать на Основной склад материалы для установки стиральных машин (рис. 4.9).

Рис. 4.9. Создание нового документа «Приходная накладная № 2» {https://ai2b.pro/wp-content/uploads/1/04_009.png}
Нажмите Провести и закрыть.
Обратите внимание, что при вводе нового документа табличная часть в целом и каждая ее колонка подсвечены красным пунктиром. Это значит, что для них выполняется проверка заполнения. Если не ввести ни одной строки в табличную часть документа или оставить незаполненной какую-либо колонку табличной части и попытаться записать документ, то будет получено сообщение об ошибке (рис. 4.10).

Рис. 4.10. Сообщение об ошибке при вводе нового элемента документа {https://ai2b.pro/wp-content/uploads/1/04_010.png}
Чтобы просмотреть список созданных документов, нажмите Приходные накладные.
В форме списка вы видите два созданных вами документа, отмеченных пиктограммой, указывающей на то, что документы проведены (зеленая галочка в пиктограмме документа, рис. 4.11).

Рис. 4.11. Список приходных накладных {https://ai2b.pro/wp-content/uploads/1/04_011.png}

### Теория: справочники и документы
Интересно обратить внимание на разницу в употреблении единственного и множественного числа при именовании объектов вида Справочник и Документ.
Если вы откроете дерево объектов какого-нибудь тиражного прикладного решения, то увидите, что все объекты, расположенные в ветке Справочники, как правило, именованы во множественном числе. В ветке же Документы, как правило, в единственном числе.
Может сложиться впечатление, что, добавляя объект конфигурации Справочник, вы делаете хранилище для элементов этого справочника, а создавая объект конфигурации Документ, – некий шаблон одного конкретного документа. На самом деле это не так.
Создавая в 1C:EDT объект класса Справочник, вы даете ему наименование во множественном числе (Товары). При этом подразумевается, что в базе данных этот объект будет состоять из элементов, описывающих конкретные товары (в единственном числе).
Создавая в 1C:EDT объект класса Документ, вы даете ему наименование в единственном числе (ПриходнаяНакладная), однако на самом деле вы создаете такое же хранилище, как и в случае со справочником. Каждая запись этого хранилища будет описывать один документ, одну приходную накладную (в единственном числе). Поэтому концептуально правильно было бы в 1C:EDT задавать наименование объекта вида Документ во множественном числе, подчеркивая тем самым описание набора документов этого вида (например, ПриходныеНакладные).
Однако психология человека такова, что, открывая ветку Документы, он ожидает увидеть перечисление их в единственном числе, а никак не во множественном. Так происходит потому, что в реальной жизни трудно найти подходящий термин для описания совокупности документов одного вида (совокупность записей одного вида обозначить гораздо проще – справочник, план и т. д.). Поэтому соответствующая ветка объектов конфигурации имеет название Документы, а объекты конфигурации, создаваемые в этой ветке, именуются в единственном числе, хотя, по сути, сама ветка содержит описания хранилищ документов разных видов, а каждый элемент в этой ветке описывает набор всех документов одного вида.

### Документ «Оказание услуги»
Теперь аналогичным образом создайте второй необходимый вам документ – Оказание услуги. Для этого потребуется выполнить уже знакомые действия, которые вы выполняли по созданию документа Приходная накладная.
#### В 1C:EDT
Добавьте в конфигурацию документ с именем ОказаниеУслуги.
Свойство документа Представление списка задайте как Оказание услуг.
После этого включите документ в подсистемы Оказание услуг и Бухгалтерия.
Теперь создайте у документа следующие реквизиты и укажите их свойства:
Склад, тип СправочникСсылка.Склады. Выберите для свойства Значение заполнения предопределенный элемент Основной справочника Склады;
Клиент, тип СправочникСсылка.Клиенты. Установите свойство Проверка заполнения в значение Выдавать ошибку;
Мастер, тип СправочникСсылка.Сотрудники. Установите свойство Проверка заполнения в значение Выдавать ошибку.
Создайте табличную часть этого документа ПереченьНоменклатуры с реквизитами:
Номенклатура, тип СправочникСсылка.Номенклатура;
Количество, тип Число, длина 15, точность 3, неотрицательное;
Цена, тип Число, длина 15, точность 2, неотрицательное;
Сумма, тип Число, длина 15, точность 2, неотрицательное.
Установите для табличной части в целом и для каждого ее реквизита свойство Проверка заполнения в значение Выдавать ошибку.
Прежде чем запускать проект, в подсистеме Оказание услуг сделайте доступной команду Оказание услуги: создать.
Проконтролируйте себя – в результате ваших действий в панели Навигатор в ветке Документы должна быть создана следующая структура объектов конфигурации (рис. 4.12).

Рис. 4.12. Документы «ПриходнаяНакладная», «ОказаниеУслуги» в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/04_012.png}

#### В прикладном решении
Запустите проект в режиме отладки.
В разделе Оказание услуг нажмите Создать > Оказание услуги и заполните новый документ следующим образом (рис. 4.13).

Рис. 4.13. Создание документа «Оказание услуги № 1» {https://ai2b.pro/wp-content/uploads/1/04_013.png}
Обратите внимание, что склад Основной подставляется по умолчанию, а для полей Мастер и Клиент выполняется проверка заполнения. Нажмите Провести и закрыть.

## Занятие 5 (0:50). Регистры накопления
Продолжительность
Ориентировочная продолжительность занятия – 50 минут.
На этом занятии вы познакомитесь с объектом конфигурации Регистр накопления. Вы узнаете, для чего используется этот объект, какой структурой он обладает и каковы его отличительные особенности.
Затем вы создадите один из регистров накопления, который будет использоваться в вашей конфигурации и отражать изменение данных в процессе работы ранее созданных вами документов.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Зачем нужен регистр накопления
Итак, вы подошли к одному из главных моментов разработки любой конфигурации – созданию механизма учета накопления данных.
Казалось бы, все необходимое вы уже создали: у вас есть что расходовать и приходовать (справочники) и у вас есть чем расходовать и приходовать (документы). Осталось только построить несколько отчетов, и автоматизация ООО «На все руки мастер» будет закончена.
Однако это не так.
Во-первых, путем анализа документов можно, конечно, получить требуемые вам выходные данные. Но представьте, что завтра ООО «На все руки мастер» решит немного изменить свои бизнес-процессы и вам потребуется ввести в конфигурацию еще один документ (или несколько документов).
Например, сейчас вы предполагаете, что товары поступают в ООО «На все руки мастер» и затем расходуются. Затем руководство захотело усилить материальный контроль и решило приходовать товары на основной склад организации и затем выдавать их материально ответственным лицам. В этом случае вам придется создать в конфигурации еще один документ, который будет фиксировать перемещение материалов между основным складом и материально ответственными лицами. И, очевидно, вам придется переработать все отчеты, которые были вами созданы к этому моменту, с тем чтобы они учитывали изменения, вносимые новым документом. А представьте, если в вашей конфигурации не два, а двадцать документов?!
Во-вторых, отчеты, анализирующие документы, будут работать довольно медленно, что будет вызывать раздражение пользователей и недовольство руководителей.
Поэтому в системе «1С:Предприятие» есть несколько объектов конфигурации, которые позволяют создавать в базе данных структуры, предназначенные для накопления информации в удобном для последующего анализа виде. Использование таких хранилищ данных позволяет вам, с одной стороны, накапливать в них данные, поставляемые различными документами (или другими объектами базы данных), а с другой стороны, легко создавать нужные вам отчеты или использовать эти данные в алгоритмах работы конфигурации (рис. 5.1).

Рис. 5.1. Алгоритм работы конфигурации {https://ai2b.pro/wp-content/uploads/1/05_001.png}
В конфигурации существует несколько объектов, называемых регистрами, для описания подобных хранилищ. Рассмотрим один из них.

### Что такое регистр накопления
Объект конфигурации Регистр накопления предназначен для описания структуры накопления данных. На основе объекта конфигурации Регистр накопления платформа создает в базе данных таблицы, в которых будут накапливаться данные, поставляемые различными объектами базы данных.
Эти данные будут храниться в таблицах в виде отдельных записей, каждая из которых имеет одинаковую, заданную при конфигурировании регистра структуру (рис. 5.2).

Рис. 5.2. Регистр накопления «Остатки товаров» в 1C:EDT, в прикладном решении и в базе данных  {https://ai2b.pro/wp-content/uploads/1/05_002.png}
На основании таблицы движений регистра накопления система рассчитывает таблицу итогов регистра, которая хранит в базе данных итоги на момент времени последнего движения (актуальные итоги).
Отличительной особенностью регистра накопления является то, что он не предназначен для интерактивного редактирования пользователем.
Разработчик может при необходимости предоставить пользователю возможность редактировать регистр накопления. Но предназначение регистра накопления в том, чтобы его модификация производилась на основе алгоритмов работы других объектов базы данных, а не в результате непосредственных действий пользователя.
Основным назначением регистра накопления является накопление числовой информации в разрезе нескольких измерений, которые описываются разработчиком в соответствующем объекте конфигурации Регистр накопления и являются подчиненными объектами конфигурации.
Виды числовой информации, накапливаемой регистром накопления, называются ресурсами, также являются подчиненными объектами и описываются при конфигурировании регистра.
Например, регистр может накапливать информацию о количестве и сумме товаров на складах. В этом случае он будет иметь измерения Товар и Склад и ресурсы Количество и Сумма (рис. 5.2).
Изменение состояния регистра накопления происходит, как правило, при проведении документа и заключается в том, что в регистр добавляется некоторое количество записей. Каждая запись содержит значения измерений, значения приращений ресурсов, ссылку на документ, который вызвал эти изменения (регистратор), и «направление» приращения (приход или расход). Такой набор записей называется движениями регистра накопления. Каждому движению регистра накопления всегда должен соответствовать регистратор – объект информационной базы (как правило, документ), который произвел эти движения.
Кроме того, регистр накопления может хранить дополнительную информацию, описывающую каждое движение. Набор такой дополнительной информации задается разработчиком при помощи реквизитов объекта конфигурации Регистр накопления.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с регистрами накопления, можно прочитать в разделе «Краткий справочник разработчика. Регистры накопления».

### Создание регистра накопления
Теперь, когда вы знаете, для чего предназначены регистры накопления, посмотрите, как можно их использовать, в учебном примере.
Прежде всего вас интересует информация о том, сколько и каких материалов есть у вас на складах. Для накопления такой информации вы создадите регистр ОстаткиМатериалов.
#### В 1C:EDT
Добавьте объект конфигурации – регистр накопления с именем ОстаткиМатериалов.
Задайте свойство регистра Расширенное представление списка как Движения по регистру Остатки материалов. Этот заголовок будет отображаться в окне списка записей регистра.
По логике конфигурации данный регистр должен быть доступен в разделах Учет материалов, Оказание услуг и Бухгалтерия. Поэтому включите регистр в эти подсистемы.
Теперь создайте измерения и ресурсы регистра, которые будут определять структуру регистра. Как уже говорилось, измерения и регистры являются подчиненными объектами конфигурации для регистра накопления, поэтому они создаются по аналогии с созданием, например, реквизитов документа.
Ваш регистр будет содержать следующие измерения:
Материал, тип СправочникСсылка.Номенклатура;
Склад, тип СправочникСсылка.Склады.
Затем создайте ресурс Количество с длиной 15 и точностью 3.
В результате этих действий в панели Навигатор регистр ОстаткиМатериалов должен иметь следующий вид (рис. 5.3).

Рис. 5.3. Регистр «ОстаткиМатериалов» в панели «Навигатор»
 {https://ai2b.pro/wp-content/uploads/1/05_003.png}
Если вы сейчас попытаетесь запустить проект в режиме отладки, то система выдаст сообщение об ошибке: «РегистрНакопления.ОстаткиМатериалов: Ни один из документов не является регистратором для регистра». Это сообщение еще раз подтверждает: назначение регистра накопления в том, чтобы аккумулировать данные, поставляемые различными документами.
Впрочем, даже не запуская отладку, предупреждение об ошибке можно увидеть и в панели Навигатор (рис. 5.3 – пиктограмма  рядом с самим регистром, в ветке регистров накопления и рядом с вашим проектом), и в редакторе регистра (рис. 5.4).

Рис. 5.4. Предупреждение об ошибке  {https://ai2b.pro/wp-content/uploads/1/05_004.png}
Поэтому сначала вам нужно написать код на встроенном языке, который сформирует движения регистра накопления ОстаткиМатериалов в процессе проведения двух созданных вами документов: ПриходнаяНакладная и ОказаниеУслуг.
##### Движения документа «Приходная накладная»
Движения документа – это записи в регистрах, которые создаются в процессе проведения документа и отражают изменения, производимые документом.
На данном этапе обучения вы пока еще не знакомы со встроенным языком системы «1С:Предприятия». Позже, когда вы научитесь им пользоваться (см. занятие № 7 «Знакомство со встроенным языком»), вы сможете самостоятельно вручную формировать движения документа в модуле документа при его проведении. А пока, не особо вдаваясь в детали, воспользуйтесь конструктором движений, который сделает всю работу за вас.
Сначала создайте движения документа ПриходнаяНакладная. Чтобы открыть конструктор движений, в панели Навигатор нажмите Конструкторы > Конструктор движений в контекстном меню документа ПриходнаяНакладная (рис. 5.5).

Рис. 5.5. Вызов конструктора движений документа «ПриходнаяНакладная»  {https://ai2b.pro/wp-content/uploads/1/05_005.png}
В конструкторе слева вы видите исходные данные для формирования движений: реквизиты и табличные части документа ПриходнаяНакладная. Справа показываются регистры, для которых этот документ является регистратором (рис. 5.6).

Рис. 5.6. Конструктор движений  {https://ai2b.pro/wp-content/uploads/1/05_006.png}
Пока этот список пуст, потому что вы еще не назначали документ регистратором для вашего регистра. Поэтому в командной панели конструктора нажмите . В окне выбора регистров нажмите  (Показать все регистры) и отметьте регистр ОстаткиМатериалов. Нажмите ОК и подтвердите, что документ ПриходнаяНакладная будет являться регистратором для регистра.
Теперь в поле Выражения вам нужно задать формулы, по которым будут вычисляться значения измерений и ресурсов регистра при записи движений. Чтобы конструктор автоматически заполнил эти выражения, нажмите  (Заполнить выражения).
В результате будет сформировано соответствие измерений и ресурсов регистра и выражений для их расчета (рис. 5.7).

Рис. 5.7. Заполнение выражений для расчета движений регистра  {https://ai2b.pro/wp-content/uploads/1/05_007.png}
Как видите, конструктор движений установил соответствия подходящим образом: в качестве материала в регистр будет записан материал из табличной части документа, в качестве склада – склад, указанный в шапке документа, а в качестве количества – количество из табличной части документа.
В строке ВидДвиженияНакопления выбрано значение Приход. Это вас устраивает, так как документ ПриходнаяНакладная должен приходовать материалы.
Нажав Результат, вы можете просмотреть текст, сформированный конструктором. После нажатия ОК этот текст будет помещен в модуль документа ПриходнаяНакладная (листинг 5.1) и редактор документа перейдет на закладку Модуль объекта (рис. 5.8).

Рис. 5.8. Текст процедуры проведения документа, созданный конструктором  {https://ai2b.pro/wp-content/uploads/1/05_008.png}
Листинг 5.1. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ,Режим)
//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
//Данный фрагмент построен конструктором.
//При повторном использовании конструктора, внесенные вручную данные будут утеряны!
 
// регистр ОстаткиМатериалов
Движения.ОстаткиМатериалов.Записывать = Истина;
Для Каждого ТекСтрокаМатериалы из Материалы Цикл
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаМатериалы.Количество;
КонецЦикла;
 
//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры
Как уже говорилось, на данном этапе вам не нужно разбирать и анализировать текст процедуры обработчика. Когда вы познакомитесь со встроенным языком (см. занятие № 7 «Знакомство со встроенным языком»), вы можете вернуться к этой процедуре и внести в нее изменения, если это потребуется.
Если вы теперь перейдете на закладку Регистраторы в редакторе регистра ОстаткиМатериалов, то в списке регистраторов регистра увидите документ ПриходнаяНакладная, так как вы только что сформировали движения этого документа в регистре с помощью конструктора.
Прежде чем запускать проект, настройте интерфейс прикладного решения, чтобы в разделах Бухгалтерия, Оказание услуг и Учет материалов была доступна команда ОстаткиМатериалов.
Дело в том, что команды открытия регистров также добавляются в панель команд разделов, но по умолчанию они невидимы, в отличие от команд открытия справочников и документов.
В разделе Учет материалов перетащите мышью команду Остатки материалов в группу Панель навигации.См.также (рис. 5.9).

Рис. 5.9. Настройка командного интерфейса подсистем  {https://ai2b.pro/wp-content/uploads/1/05_009.png}
Эти же действия выполните в разделах Бухгалтерия и Оказание услуг.
Тем самым вы переносите команды открытия списка регистров накопления в конец списка подобных команд раздела, так как эти команды не так часто используются и их приоритет невысок.

#### В прикладном решении
Запустите проект в режиме отладки и протестируйте внесенные вами изменения.
Вы видите, что в разделах Бухгалтерия, Оказание услуг и Учет материалов справа от команд для открытия различных списков, перед подменю Создать, Отчеты (если они есть) появилась команда для открытия списка регистра Остатки материалов (рис. 5.10).

Рис. 5.10. Команда открытия записей регистра накопления «ОстаткиМатериалов»  {https://ai2b.pro/wp-content/uploads/1/05_010.png}
Чтобы проследить связь между проведением документов и накоплением информации в регистре, откройте список приходных накладных, нажав Приходные накладные в разделе Учет материалов.
Откройте «Приходную накладную № 1» и нажмите Провести и закрыть, то есть перепроведите ее. То же самое сделайте для «Приходной накладной № 2».
Перепровести документы можно и не открывая документов. Для этого можно выделить нужный документ в списке (или выделить мышью группу документов, удерживая клавишу Ctrl) и нажать Провести в контекстном меню одного из выделенных документов (рис. 5.11).

Рис. 5.11. Проведение документов  {https://ai2b.pro/wp-content/uploads/1/05_011.png}
Теперь нажмите Остатки материалов и откройте список вашего регистра накопления (рис. 5.12).

Рис. 5.12. Список регистра накопления «ОстаткиМатериалов»  {https://ai2b.pro/wp-content/uploads/1/05_012.png}
Вы видите, что при проведении приходных накладных появились соответствующие записи в регистре накопления Остатки материалов. Обратите внимание, что добавилось пять записей: первые три после проведения первого документа, что соответствует количеству строк в его табличной части, и последние две после проведения второго документа.
Все поля регистра заполнились данными документов так, как вы задали в обработчике проведения документа ПриходнаяНакладная. Пиктограмма со знаком + слева от каждой записи указывает на тип движения – Приход.

### Движения документа «Оказание услуги»
Теперь сформируйте аналогичным образом движения документа ОказаниеУслуги. Для этого потребуется выполнить уже знакомые вам действия.
#### В 1C:EDT
Основные действия по формированию движений вам уже знакомы по документу Приходная накладная, но для документа Оказание услуги будет несколько отличий.
Во-первых, поскольку документ ОказаниеУслуги должен расходовать материалы, поэтому в конструкторе движений в строке ВидДвиженияНакопления вам нужно выбрать Расход.
Во-вторых, после автоматического заполнения (после нажатия ) поле Материал не заполнится.
Так происходит потому, что имя поля табличной части Номенклатура не совпадает с именем измерения регистра – Материал, поэтому 1C:EDT не может автоматически сопоставить эти два поля. Если оставить это как есть, то в регистре накопления в строках с типом Движение регистра – расход номенклатура фиксироваться не будет.
Поэтому нужно вручную указать 1C:EDT, какое значение использовать для измерения Материал. Для этого нужно выделить поле регистра Материал и в окне реквизитов документа дважды щелкнуть по строке ТекСтрокаПереченьНоменклатуры.Номенклатура. Или же можно просто мышью перетащить эту строку слева направо в нужное место (рис. 5.13).

Рис. 5.13. Конструктор движений  {https://ai2b.pro/wp-content/uploads/1/05_013.png}
После нажатия OK конструктор создаст обработчик события ОбработкаПроведения документа ОказаниеУслуги и поместит его в модуль объекта (листинг 5.2).
Листинг 5.2. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ, Режим)
//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
// Данный фрагмент построен конструктором.
// При повторном использовании конструктора внесенные вручную изменения будут утеряны!!!
 
// регистр ОстаткиМатериалов Расход
Движения.ОстаткиМатериалов.Записывать = Истина;
Для Каждого ТекСтрокаПереченьНоменклатуры из ПереченьНоменклатуры Цикл
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ТекСтрокаПереченьНоменклатуры.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаПереченьНоменклатуры.Количество;
КонецЦикла;
 
//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры

#### В прикладном решении
Запустите проект в режиме отладки. Перепроведите документ Оказание услуги № 1.
Теперь откройте список регистра Остатки материалов (рис. 5.14).

Рис. 5.14. Список регистра накопления «ОстаткиМатериалов»  {https://ai2b.pro/wp-content/uploads/1/05_014.png}
Вы видите, что в регистре накопления Остатки материалов появилась еще одна запись, что соответствует количеству строк в табличной части проведенного документа.
Все поля регистра заполнились данными документа так, как вы задали в обработчике проведения документа Оказание услуги. Пиктограмма со знаком минус слева от записи указывает на тип движения – Расход.

## Занятие 6 (0:25). Простой отчет
Продолжительность
Ориентировочная продолжительность занятия – 25 минут.
На этом занятии вы познакомитесь с объектом конфигурации Отчет. Вы узнаете, для чего он используется, и создадите отчет, который будет показывать движения и остатки материалов на вашем предприятии.
Данное занятие преследует цель лишь проиллюстрировать на простом примере механизм создания отчетов. Поэтому здесь вы не будете углубляться в систему компоновки данных, с помощью которой строится любой отчет. Более подробно этот вопрос будет рассмотрен в занятии № 14 «Отчеты».
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Что такое отчет
Объект конфигурации Отчет предназначен для описания алгоритмов, при помощи которых пользователь сможет получать необходимые ему выходные данные. Алгоритм формирования выходных данных описывается при помощи визуальных средств или с использованием встроенного языка. В реальной жизни объектам конфигурации Отчет соответствуют всевозможные таблицы выходных данных, сводных данных, диаграммы и пр.

### Создание отчета

#### В 1C:EDT
Теперь у вас все готово для того, чтобы получать выходные данные. Поэтому можно приступить к созданию отчета, который будет показывать приход, расход и остатки материалов (рис. 6.1).

Рис. 6.1. Результат отчета {https://ai2b.pro/wp-content/uploads/1/06_001.png}
На этом примере вы увидите, как быстро и легко разработать отчет с использованием только визуальных средств разработки «без единой строчки кода».
Добавьте объект конфигурации – отчет с именем Материалы.
Теперь вам нужно создать основу для построения любого отчета – схему компоновки данных. Для этого нажмите кнопку открытия со значком лупы у свойства отчета Основная схема компоновки данных (рис. 6.2).
##### Макет
Так как у вашего отчета еще не существует схемы компоновки данных, 1С:EDT предложит создать новую схему. Схема компоновки данных с точки зрения конфигурации является макетом, поэтому будет открыт мастер макета, предлагающий выбрать единственный тип макета – Схема компоновки данных. Нажмите Готово (рис. 6.2).
Примечание
На то, чтобы открыть конструктор схемы компоновки данных, может потребоваться 20–30 секунд.

Рис. 6.2. Создание схемы компоновки данных отчета {https://ai2b.pro/wp-content/uploads/1/06_002.png}

##### Схема компоновки данных
1С:EDT создаст новый макет, содержащий схему компоновки данных, установит этот макет в качестве основной схемы компоновки данных для отчета и сразу же откроет редактор макета на закладке Макет.
При конструировании схемы компоновки данных имеется много различных возможностей для визуального проектирования отчетов, но вы сейчас будете использовать только самые простые возможности и определите те данные, которые вы хотите видеть в результате работы вашего отчета.
###### Набор данных
Набор данных – это основа любого отчета. Он описывает, откуда должны быть получены данные. В данном случае данные будут получены с помощью запроса к базе данных.
На закладке Наборы данных конструктора схемы компоновки данных нажмите Добавить набор данных – запрос в подменю Создать (рис. 6.3).

Рис. 6.3. Добавление набора данных в конструкторе схемы компоновки {https://ai2b.pro/wp-content/uploads/1/06_003.png}

###### Текст запроса
Запрос с помощью собственного языка описывает, из каких таблиц какие данные должны быть получены.
Для того чтобы создать текст запроса, запустите конструктор запроса, нажав Конструктор запроса (рис. 6.4).

Рис. 6.4. Вызов конструктора запроса {https://ai2b.pro/wp-content/uploads/1/06_004.png}
Конструктор запроса – инструмент, созданный для помощи разработчику, позволяющий визуально конструировать запрос. Даже пользователь, незнакомый с языком запросов, может с помощью конструктора создать синтаксически правильный запрос.
На данном этапе обучения вам не нужны более подробные знания про язык запросов и про конструктор запроса. Сейчас вы просто создадите запрос с помощью конструктора. Позже, когда вы познакомитесь с языком запросов (на занятии № 11 «Знакомство с языком запросов»), вы сможете проанализировать и, если потребуется, изменить запрос. В данном случае, как и для многих других отчетов, этого можно не делать.
В окне конструктора запроса, в списке База данных представлены таблицы для создания запроса. На основе их данных вы имеете возможность построить отчет.
Если раскрыть ветку РегистрыНакопления, то вы увидите, что в этой ветке присутствуют несколько таблиц (рис. 6.5).

Рис. 6.5. Таблицы для создания запроса {https://ai2b.pro/wp-content/uploads/1/06_005.png}
Поскольку вы хотите видеть как остатки материалов, так и информацию об их поступлении и расходовании, вас будет интересовать таблица ОстаткиМатериалов.ОстаткиИОбороты. Перетащите мышью эту таблицу в список Таблицы и раскройте ее структуру (рис. 6.6).

Рис. 6.6. Таблица «ОстаткиМатериалов.ОстаткиИОбороты» {https://ai2b.pro/wp-content/uploads/1/06_006.png}
Как вы видите, эта таблица содержит измерения регистра ОстаткиМатериалов: Материал, Склад и кроме этого начальные и конечные остатки, а также значения прихода, расхода и оборотов для всех ресурсов регистра ОстаткиМатериалов.
Выберите поля таблицы двойным щелчком мыши в следующем порядке: Склад, Материал, КоличествоНачальныйОстаток, КоличествоПриход, КоличествоРасход, КоличествоКонечныйОстаток.
ПРИМЕЧАНИЕ
Выделенные элементы можно перенести из одного списка в другой перетаскиванием мышью или двойным щелчком на них. Либо можно использовать кнопки , , , .
В результате окно Поля должно быть заполнено следующим образом (рис. 6.7).

Рис. 6.7. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/06_007.png}
Нажмите OK. Вы вернетесь в конструктор схемы компоновки данных (рис. 6.8).

Рис. 6.8. Конструктор схемы компоновки данных {https://ai2b.pro/wp-content/uploads/1/06_008.png}
Текст запроса, который был создан с помощью конструктора, платформа поместит в поле Запрос.
На основании текста запроса 1C:EDT автоматически сформировала набор полей (в верхней части конструктора), которыми вы можете оперировать в этом отчете.
Итак, вы описали, каким образом будут извлекаться данные для отчета. Но, пока вы не создадите настройки вашего отчета, вы ничего не увидите в результате.
В вашем случае это будут записи таблицы ОстаткиМатериалов, выбранные в линейном порядке по мере попадания их в эту таблицу.

###### Настройки
Перейдите на закладку Настройки. В верхнем правом окне будет находиться иерархическая структура вашего отчета.
Для добавления записей в отчет нажмите Новая группировка в контекстном меню корневого элемента Отчет. После этого, не указывая поле группировки, сразу нажмите OK (рис. 6.9).

Рис. 6.9. Добавление новой группировки в отчет {https://ai2b.pro/wp-content/uploads/1/06_009.png}
В структуре отчета появится группировка Детальные записи.
Теперь настройте поля, которые будут выводиться в результат отчета.
Для этого перейдите в нижнем окне настроек на закладку Выбранные поля и перенесите мышью из списка доступных полей:
Склад,
Материал,
КоличествоНачальныйОстаток,
КоличествоПриход,
КоличествоРасход,
КоличествоКонечныйОстаток.
ПРИМЕЧАНИЕ
Добавление доступных полей в список выбранных полей можно осуществить перетаскиванием мышью, двойным щелчком на доступных полях либо нажатием кнопки Добавить справа от списка выбранных полей. Порядок выбранных полей можно изменить позже кнопками Вверх, Вниз или перетаскиванием мышью.
В результате окно настроек отчета будет иметь следующий вид (рис. 6.10).

Рис. 6.10. Окно настроек отчета {https://ai2b.pro/wp-content/uploads/1/06_010.png}
Затем перейдите на закладку Параметры и укажите, что параметры отчета Дата начала и Дата окончания будут включены в пользовательские настройки и эти настройки будут находиться непосредственно в форме отчета, то есть будут быстрыми настройками.
Сначала укажите, что оба эти параметра будут использоваться в отчете, – установите флажки слева от параметров.
Затем выделите каждый из параметров, нажмите  (Свойства элемента пользовательских настроек) и установите флажок Включать в пользовательские настройки (рис. 6.11).

Рис. 6.11. Окно настроек отчета {https://ai2b.pro/wp-content/uploads/1/06_011.png}
Таким образом, перед формированием отчета пользователь сможет задать отчетный период. Более подробно о параметрах и пользовательских настройках отчета будет рассказано позже на занятии № 14 «Быстрые пользовательские настройки».
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистемы Учет материалов, Оказание услуг и Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки и проверьте работу вашего отчета.
Вы видите, что в разделах Бухгалтерия, Оказание услуг и Учет материалов появилось новое подменю Отчеты, содержащее команды для выполнения отчетов, и в нем команда для формирования отчета Материалы (рис. 6.12).

Рис. 6.12. Команда для формирования отчета «Материалы» {https://ai2b.pro/wp-content/uploads/1/06_012.png}
Выполните ее. Откроется автоматически сформированная системой форма отчета.
Задайте даты начала и окончания отчетного периода и нажмите Сформировать (рис. 6.13).

Рис. 6.13. Отчет «Материалы» {https://ai2b.pro/wp-content/uploads/1/06_013.png}
Как видите, ваш отчет вполне презентабелен и полностью отражает движение материалов в вашей организации.
ПРИМЕЧАНИЕ
Вы можете сравнить свое прикладное решение с эталонным приложением Занятие 06. Как это сделать, описано в разделе «Эталонные проекты».

## Занятие 7 (4:00). Знакомство со встроенным языком
Продолжительность
Ориентировочная продолжительность занятия – 4 часа.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала, то можете загрузить приложение Занятие 06, которое должно получиться у вас к этому моменту. Как это сделать, описано в разделе «Эталонные проекты».
Это занятие будет посвящено знакомству со встроенным языком. В зависимости от своей подготовки вы можете пропустить это занятие или прочитать только некоторые разделы.
Чтобы было проще сориентироваться, попробуйте ответить на следующие вопросы.
Если вы знаете:
зачем нужны модули и события;
чем значение отличается от типа и от представления;
вы можете пропустить первые разделы и перейти к разделу «Где писать примеры и чем пользоваться».
Если кроме этого вы знаете:
почему текст программы разноцветный;
когда нужна переменная, а когда нужен литерал;
какие инструкции используются чаще всего;
как написать условие и выполнить цикл;
в чем разница между функцией и процедурой;
что такое контекст и область видимости;
вы можете перейти к разделу «Объекты встроенного языка».
Если кроме этого вы знаете:
чем массив отличается от структуры;
как знакомиться с незнакомыми объектами;
как выполнить программу по шагам и посмотреть значения переменных;
что называют коллекцией значений, а что – объектом встроенного языка;
вы можете перейти к разделу «Прикладные типы».
Если кроме этого вы знаете:
чем объектные данные отличаются от необъектных;
что такое контекст клиента и контекст сервера;
как прочитать или записать документ;
как работать с формой документа из встроенного языка;
вы можете полностью пропустить это занятие и перейти к следующему.

### Ваша первая программа – заголовок приложения
Встроенный язык позволяет вам написать свои команды, которые прикладное решение выполнит в определенный момент.
Чтобы понять, как это работает, выполните сначала небольшой пример.
Сейчас в заголовке вашего приложения написано Бытовые услуги. Потому что на первом занятии вы дали своей конфигурации такой синоним (рис. 7.1).

Рис. 7.1. Заголовок приложения {https://ai2b.pro/wp-content/uploads/1/07_001.png}
Теперь вы сделаете так, чтобы при запуске прикладного решения в его заголовке появлялись ваши имя и фамилия. Чтобы было понятно, что это именно ваше прикладное решение.
Перейдите в 1C:EDT. В панели Навигатор нажмите Открыть модуль приложения в контекстном меню конфигурации (рис. 7.2).

Рис. 7.2. Открыть модуль приложения {https://ai2b.pro/wp-content/uploads/1/07_002.png}
Вы увидите пустой модуль приложения.
В контекстном меню модуля нажмите Добавить обработчик события (рис. 7.3).

Рис. 7.3. Добавить обработчик события {https://ai2b.pro/wp-content/uploads/1/07_003.png}
В строку поиска введите «принач», выберите ПриНачалеРаботыСистемы() и нажмите ОК (рис. 7.4).

Рис. 7.4. Событие «ПриНачалеРаботыСистемы()» {https://ai2b.pro/wp-content/uploads/1/07_004.png}
В модуле появится заготовка процедуры (рис. 7.5).

Рис. 7.5. Заготовка процедуры «ПриНачалеРаботыСистемы» {https://ai2b.pro/wp-content/uploads/1/07_005.png}
Вместо текста // Вставить содержимое обработчика напишите следующую команду (листинг 7.1).
Листинг 7.1. Установка заголовка приложения
КлиентскоеПриложение.УстановитьКраткийЗаголовок("Иванов Петр");
Здесь вместо Иванов Петр напишите свои фамилию и имя. В результате у вас получится такая программа (рис. 7.6).

Рис. 7.6. Обработчик «ПриНачалеРаботыСистемы» {https://ai2b.pro/wp-content/uploads/1/07_006.png}
Запустите проект в режиме отладки и посмотрите на заголовок приложения (рис. 7.7).

Рис. 7.7. Новый заголовок приложения {https://ai2b.pro/wp-content/uploads/1/07_007.png}
Заголовок изменился.
Теперь несколько слов о том, что вы сейчас сделали.

### События
Каждое прикладное решение «1С:Предприятия» имеет одинаковый жизненный цикл. Прикладное решение запускается. Открывается основной раздел. После этого прикладное решение ждет действия пользователя.
Пользователь может открыть какую-то форму, изменить в ней данные, закрыть форму.
В конце концов пользователь решает, что он сделал все, что хотел. Тогда он закрывает программу. Работа прикладного решения завершается.
Этот жизненный цикл фиксирован. Он определен платформой, и изменить его нельзя. Но в нем есть отдельные моменты, в которые вы можете вмешаться. Вот, например, в один из таких моментов вы только что вмешались и заставили прикладное решение выполнить вашу команду. В результате этого изменился заголовок приложения.
Такие моменты, когда вы можете вмешаться в «жизнь» прикладного решения, называются события. Набор этих событий фиксирован, постоянен. Его определяет платформа. Придумать какое-то свое событие вы не можете. Но вы можете использовать любое событие из тех, которые имеются.
Когда прикладное решение запускается и начинает работать, происходят два события. Первое называется ПередНачаломРаботыСистемы, а второе – ПриНачалеРаботыСистемы.
Слова «перед» и «при» встречаются во многих событиях «1С:Предприятия». Слово «перед» обозначает тот момент, когда действие еще не наступило. В данном случае – когда система еще не начала работать.
Слово «при» означает тот момент, когда действие уже выполняется. В данном случае – когда система уже начинает работать.
Когда вы устанавливали заголовок приложения, вы как раз и вмешались в одно из этих событий. В событие ПриНачалеРаботыСистемы. В этом событии вы заставили программу выполнить вашу команду.

### Модули
Каким образом вы вмешались в событие ПриНачалеРаботыСистемы? Вы открыли какой-то модуль и что-то в нем написали. Модуль – это такое место в конфигурации, куда вы можете написать свои команды. В конфигурации много модулей, они расположены в разных ее частях.
Когда в жизни прикладного решения возникает очередное событие, платформа идет в один из модулей и смотрит, есть ли там команды, которые нужно выполнить. Если есть, то сначала выполняет их, а потом – все то, что она обычно делает в этом случае.
Как платформа узнает, в какой модуль ей нужно идти? Очень просто. Для каждого события заранее известно, в каком модуле нужно искать команды.
Например, когда вы запускаете приложение, возникают два события. Сначала возникает событие ПередНачаломРаботыСистемы. Платформа знает, что команды, которые она должна выполнить при наступлении этого события, находятся в модуле приложения. Она идет в этот модуль и смотрит, есть ли там команды для события ПередНачаломРаботыСистемы (рис. 7.8).

Рис. 7.8. Модуль приложения {https://ai2b.pro/wp-content/uploads/1/07_008.png}
Для этого события там нет команд. Вы их не добавляли. Значит, платформа просто продолжает делать то, что она обычно делает в этой ситуации. Начинает запускать ваше приложение.
Тут возникает второе событие – ПриНачалеРаботыСистемы. Платформа снова идет в модуль приложения. Потому что она знает, что команды для этого события (если они есть) написаны именно в этом модуле. И они есть!
Тогда она сначала выполняет вашу команду – устанавливает краткий заголовок приложения. А затем уже делает все то, что она обычно делает в этой ситуации. То есть показывает на экране ваше приложение, показывает начальную страницу и т. д.
После этого она ждет ваших дальнейших действий (рис. 7.9).

Рис. 7.9. Приложение запустилось и ждет ваших действий {https://ai2b.pro/wp-content/uploads/1/07_009.png}
Вы, например, решаете посмотреть, какие материалы поступали в вашу компанию. Открываете список документов Приходные накладные и дважды щелкаете мышью по одному из них. В этот момент платформа открывает вам форму документа ПриходнаяНакладная и показывает ее.
Когда форма открывается, тоже происходит несколько событий. Но эти события связаны уже не со всей конфигурацией, а именно с этой формой. Поэтому команды для этих событий платформа будет искать уже в модуле формы документа ПриходнаяНакладная.
Когда вы решите закончить работу со своим прикладным решением, также будут вызваны два события, связанные с завершением работы. Команды для этих событий платформа снова будет искать в модуле приложения.
Модули в конфигурации расположены в тех местах, которые логически связаны с происходящими событиями.
Например, если события относятся ко всему приложению в целом, то модуль расположен в корне конфигурации – вы это видели. Если события относятся к какой-то форме, то модуль расположен рядом с этой формой.
Модуль формы есть у каждой формы, которую вы добавите в конфигурацию. Открыть его очень просто. В панели Навигатор нужно выбрать форму и нажать Открыть модуль формы в контекстном меню (рис. 7.10).

Рис. 7.10. Открыть модуль формы  {https://ai2b.pro/wp-content/uploads/1/07_010.png}
Кроме модуля приложения и модулей форм в конфигурации есть и другие модули. Они расположены в конфигурации точно по такому же принципу. Некоторые из них вы позже рассмотрите.

### Встроенный язык
Теперь рассмотрим, что вы написали в модуле приложения. Вы написали небольшую программу на встроенном языке «1С:Предприятия» (рис. 7.11).

Рис. 7.11. Программа в модуле  {https://ai2b.pro/wp-content/uploads/1/07_011.png}
Встроенный язык – это язык программирования, который создала фирма «1С». Он разработан для того, чтобы вы могли на нем описать собственный набор действий, который должно выполнить прикладное решение.
С одной стороны, встроенный язык имеет много общих черт с другими языками, такими как Pascal, Java Script, Basic. С другой стороны, встроенный язык специально разрабатывался так, чтобы его могли использовать не только профессиональные программисты.
Например, все ключевые слова и инструкции языка имеют русское написание. Поэтому вам не нужно знать английский язык, для того чтобы написать собственную программу.
Прежде чем вы перейдете к изучению самого языка, нужно овладеть тремя очень важными понятиями: значение, тип и представление. Без них вам будет сложно разбираться в текстах программ.

### Значение
Что делает программа? Вы можете сказать, что любая программа выполняет какой-то набор действий. Что она содержит последовательность команд, которые выполняются друг за другом. Да, это правильно. Если смотреть на программу, так сказать, издалека.
Но что если взглянуть на нее более внимательно и пристально? В этом случае вы увидите, что любая программа занята исключительно тем, что выполняет какие-то действия со значениями. Причем все эти действия совершенно четко делятся на три большие группы.
Сначала программа получает какие-то значения. Может быть, эти значения были записаны на диске. Тогда она читает их с диска. Может быть, вы сами ввели эти значения с клавиатуры. Например, когда вы добавляли материалы, вы набрали наименование – Строчный трансформатор LG. Это значение, которое вы передали программе. Есть много способов, которыми программа может получить значения. Это не важно. Самое главное, что программа их откуда-то получает.
Затем, например, вы ввели количество поступившего материала и его цену. Тогда программа может одно значение умножить на другое и получить третье значение – сумму.
В конце концов любая программа завершает свою работу тем, что выводит значения. Например, она показывает их вам на экране, когда вы выполняете отчет Материалы. Или записывает их на диск. Или печатает на принтере. Или передает другому компьютеру. Конкретный способ тоже не важен. Важно лишь то, что значения являются еще и результатом деятельности программы.
Таким образом, основные сущности, которыми оперирует программа, – это значения. Она их получает, выполняет с ними какие-то действия и показывает.

### Тип
В компьютере может существовать много самых разных значений. Чтобы программа могла что-то делать с этими значениями, она должна знать их тип. С типами вы уже сталкивались, когда добавляли сотрудников и информацию об их трудовой деятельности. Например, чтобы записывать названия организаций, вы выбрали тип Строка. А чтобы записывать даты приема на работу и увольнения, вы выбрали тип Дата.
Чтобы вышел какой-то толк, программа прежде всего должна знать, какой тип имеют те значения, с которыми ей предстоит работать. Например, если это числа, то их можно складывать, делить, умножать, вычитать. А если это строки, то умножать и делить их нельзя. Их можно только сложить. На языке компьютера это будет означать, что к одной строке нужно дописать другую строку. А если значения имеют разные типы (например, одно значение имеет тип Число, а другое значение – тип Строка), то с такими значениями вообще никаких действий произвести нельзя.
Для чего еще программе нужно знать типы значений? Чтобы записать их на диск, например. Потому что числа хранятся одним образом, а строки – другим. А если вы захотите записать на диск картинку, то программа выберет для этого третий способ хранения данных.
Таким образом, каждое значение относится к какому-либо типу. Говорят: «Значение имеет тип Строка». Или: «Значение имеет тип Число».

### Представление
Пока программа записывает значения на диск или передает их другому компьютеру, она это делает так, как удобно ей, и в такой форме, которая ей удобна. Но когда эти значения нужно показать на экране или напечатать, программа не может делать это так, как ей хочется. Она должна сделать это так, чтобы любому пользователю было понятно, что это за значения.
Как раз для этого и нужно представление. Каждый тип имеет собственное представление. То есть способ, которым значения такого типа нужно показывать на экране.
Например, представление типа Число – это последовательность цифр. В этой последовательности может встретиться одна запятая. Она отделяет целую часть числа от дробной части. Например, 346,45 или 58,2. В этой последовательности может встретиться пробел. Он отделяет друг от друга группы разрядов. Это помогает легче читать большие числа. Например, 1 475 или 395 987,41.
А у типа Строка представление другое. Это просто последовательность любых символов. В этой последовательности тоже может встретиться пробел или запятая. Но никакого особенного смысла они не имеют. Например, «Давыдова А. В.» или «математика, мой любимый предмет».
Таким образом, каждый тип имеет представление. Это правило, по которому обозначаются значения этого типа.
Соответственно, и каждое значение тоже имеет свое представление – набор символов, которым обозначается это значение на экране или на принтере.
Теперь, когда вы познакомились с основными понятиями, вы можете перейти к упражнениям.

### Где писать примеры и чем пользоваться
Чтобы познакомиться со встроенным языком, вы будете использовать самый простой способ. Примеры вы будете писать в модуле приложения, вместо той строчки, которая там уже есть (рис. 7.12).

Рис. 7.12. Модуль приложения  {https://ai2b.pro/wp-content/uploads/1/07_012.png}
При этом вы сразу же будете использовать все инструменты, которые используют разработчики.
Во-первых, это синтакс-помощник. В нем описаны все команды, которые есть во встроенном языке. Описаны типы данных, которые вы можете использовать. Также в нем описаны операции, которые можно выполнять со значениями этих типов. То есть это такой большой справочник.
Кроме того, вы сразу же будете использовать основной, наверное, инструмент разработчика – отладчик. Он позволяет найти ошибки в программе. Позволяет остановиться в нужном месте программы. Он даже позволяет выполнить программу по отдельным шагам, чтобы вы могли посмотреть, что получается на каждом шаге.
Кроме этого вы научитесь пользоваться контекстной подсказкой. Она облегчает написание текста программы. Позволяет вам избежать многих ошибок и описок. Она может подсказать вам, какие слова или команды вы можете использовать в том или ином месте программы.

### Простые типы
#### Почему текст разноцветный
Откройте в 1C:EDT модуль приложения.
Почему слова, которые написаны в модуле, разного цвета? Почему некоторые из них фиолетовые, некоторые черные, а некоторые – голубые?
Все очень просто. Они разного цвета, для того чтобы вы не запутались. Чтобы вам было легче читать то, что написано.
Когда вы что-то пишете в модуле, вы на самом деле объясняете компьютеру, что он должен сделать. Объясняете на встроенном языке, который понятен и ему, и вам. Этот язык очень похож на наш обычный язык. Только он гораздо проще. И в нем есть только такие предложения, которые выражают приказ, просьбу или совет.
Чтобы было понятно, представьте, что вы позвали друга к себе в гости. Вы объясняете ему, как добраться до вашего дома. Только вы очень спешите, поэтому говорите быстро и коротко:
– Садись в автобус № 395. Выйди на 4-й остановке. Перейди на другую сторону улицы. Заходи в дом № 15. Если автобус проедет мимо магазина «Продукты», значит, ты пропустил нужную остановку. Выйди из автобуса на следующей остановке и вернись на одну остановку назад.
В обычной жизни вы слышите и понимаете эти предложения последовательно, одно за другим. Если переставить предложения местами, получится ерунда. В результате ваш друг вообще не сможет никуда уехать или уедет в другой конец города.
Точно так же и в компьютере. Текст, который вы будете писать на встроенном языке, состоит из отдельных предложений. Каждое такое предложение называется инструкция. Порядок этих предложений (инструкций) важен, потому что компьютер «читает» их одно за другим. В той последовательности, в которой они написаны.
В обычной жизни мы отделяем одно предложение от другого точкой и пробелом. Иногда могут использоваться и другие символы, но чаще всего это точка. Во встроенном языке одна инструкция от другой отделяется символом «точка с запятой» – «;». Кроме того, каждую инструкцию принято писать на новой строке. Поэтому записка для вашего друга, написанная на языке компьютера, была бы оформлена таким образом (листинг 7.2).
Листинг 7.2. Записка для вашего друга на языке компьютера
Садись в автобус № 395;
Выйди на 4-й остановке;
Перейди на другую сторону улицы;
Заходи в дом № 15;
Если автобус проедет мимо магазина «Продукты», значит, ты пропустил нужную остановку;
Выйди из автобуса на следующей остановке и вернись на одну остановку назад;
Сейчас в модуле приложения вы написали одну инструкцию. Эта инструкция помещена внутрь процедуры – это специальная конструкция языка, которая позволяет собрать вместе несколько инструкций и обращаться к ним как единому целому.
Фиолетовым цветом 1C:EDT раскрасила ключевые слова языка – «Процедура» и «КонецПроцедуры». Ключевые слова являются обязательными, без них не получится правильная инструкция или правильное предложение.
Черным цветом 1C:EDT раскрасила то, что ей известно о вашей конфигурации и о том, как она будет исполняться. Например, «ПриНачалеРаботыСистемы» – это стандартное имя события, а «УстановитьКраткийЗаголовок» – это одно из действий, которое можно выполнить в этот момент.
И, наконец, голубым цветом 1C:EDT выделила значение. Значение, которое вы написали прямо в тексте программы. Такие значения, написанные прямо в тексте программы, называются литералами.
Не все литералы записываются одинаково. Существуют определенные правила.
Если значение, которое вы хотите написать в тексте программы, имеет тип Число, то вы пишете его так, как привыкли. Между цифрами не ставите пробелы, а вот дробную часть отделяете от целой части с помощью точки, а не с помощью запятой. Литералы типа Число могут выглядеть так (листинг 7.3).
Листинг 7.3. Литералы типа «Число»
395
2016
3.14
29748.0021
А если значение, которое вы хотите написать, имеет тип Строка, то эту строку вы обязательно должны заключить в прямые кавычки. Причем на клавиатуре есть две похожих кнопки. Одинарная кавычка – «’» и двойная кавычка – «"». Вам нужно использовать двойную кавычку. Литералы типа Строка могут выглядеть так (листинг 7.4).
Листинг 7.4. Литералы типа «Строка»
"Иванов Сергей Николаевич"
"	сегодня 1 апреля 2016 года"
"если я дочитаю до конца, я стану крутым программистом      	"
совет
Обратите внимание, что в начале и в конце строкового литерала могут находиться пробелы. Это вполне нормальная ситуация.

#### Какие бывают инструкции
Во встроенном языке нельзя писать какие угодно инструкции. Существует всего лишь 5 основных инструкций, которые применяются наиболее часто. Это:
инструкция присваивания;
инструкция Если;
инструкция вызова процедуры;
инструкция Цикл;
инструкция Попытка.
Вы изучите первые четыре и, поверьте, этого вам хватит для большинства задач. На самом деле во встроенном языке есть еще несколько инструкций, но используются они редко.
Кстати, инструкция, которую вы написали в модуле приложения (листинг 7.5), – это инструкция вызова процедуры.
Листинг 7.5. Инструкция вызова процедуры
КлиентскоеПриложение.УстановитьКраткийЗаголовок("Иванов Петр");

#### Инструкция присваивания
Самая простая и самая популярная инструкция во встроенном языке – это инструкция присваивания. Выглядит она очень просто (листинг 7.6).
Листинг 7.6. Инструкция присваивания
СтоимостьМатериала = 10 * 3;
Отличительным признаком инструкции присваивания является знак равенства «=». Это обязательный символ в этой инструкции.
Сначала платформа вычисляет все, что находится справа от знака равенства. И только после этого она помещает результат в то место, которое обозначено слева от знака равенства.
Есть два случая, когда используется инструкция присваивания.
Во-первых, для того чтобы получить (вычислить) какое-то значение и использовать его в другом месте. В этом случае схематически инструкция выглядит так:
<Имя переменной> = <Выражение>;
Слева находится имя переменной, а справа – некоторое выражение. Это вы сейчас и рассмотрите.
Во-вторых, инструкция присваивания используется тогда, когда значение, которое вы получите или вычислите, нужно вам прямо тут, прямо в этом месте. Тогда схематически инструкция выглядит так:
<Имя свойства> = <Выражение>;
Слева находится имя свойства, а справа – снова какое-то выражение. Этот случай вы тоже рассмотрите, но позже.
Итак, справа от знака равенства находится непонятное для вас пока «выражение». А слева – тоже непонятная пока для вас «переменная». Сначала вы познакомьтесь с переменными.

#### Переменная
Так вот, переменная – это область оперативной памяти компьютера. В переменную можно положить только одно значение.
Одну переменную от другой компьютер отличает по имени. Имя вы придумываете сами.
Переменных может быть сколько угодно, пока у компьютера не закончится оперативная память.
Переменные существуют не всегда, а только в то время, пока выполняется ваша программа. Поэтому, когда ваша программа перестанет выполняться, все переменные исчезнут.
Для того чтобы создать переменную, вам не нужно ничего делать. Нужно только придумать для нее имя и написать это имя слева от знака равенства в инструкции присваивания. Когда компьютер начнет выполнять вашу программу, он сам создаст переменную и поместит в нее значение, которое вы написали справа от знака равенства.
Попробуйте. Напишите, сколько вам лет (листинг 7.7).
Листинг 7.7. Мой возраст
МойВозраст = 25;
В компьютере у вас должно получиться то же самое, что на рис. 7.13.

Рис. 7.13. Переменная «МойВозраст»  {https://ai2b.pro/wp-content/uploads/1/07_013.png}
СОВЕТ
Сразу возьмите себе за правило ставить пробелы перед знаком «=» и после него. Тогда текст программы будет читаться легко.
В «1С:Предприятии» существует несколько правил, которых надо придерживаться, когда вы придумываете имена. Имя должно начинаться с буквы и не должно содержать пробелов. Если хочется составить имя из нескольких слов, каждое следующее слово принято писать с большой буквы. Букву «ё» в именах не используют, вместо нее пишут букву «е».
СОВЕТ
Придумывайте такие имена, чтобы они были понятны и вам, и другому человеку. Не стесняйтесь использовать несколько слов для составления имени. Два, три слова – это нормально.
Когда имя очень короткое или оно является каким-то сокращением, другому человеку будет трудно понять, что вы имели в виду. Да и вы, если посмотрите на свою программу через несколько месяцев, с трудом вспомните, что вы хотели сказать таким именем. Вот, например, плохие имена: «доб», «стро», «квоТТ».
Очень длинное имя – это тоже нехорошо. Например, ДеньгиНалИБезНалМеждуНамиИКонтрагентами. Использовать такую переменную в каких-нибудь формулах будет очень неудобно.
В общем, старайтесь быть краткими и в то же время понятными.
Теперь познакомьтесь с тем, как работает эта инструкция присваивания. Вы не будете никуда ничего выводить, чтобы где-то в прикладном решении можно было увидеть значение этой переменной. Вы сразу поступите как настоящие профессиональные программисты. «Возьмете в руки» отладчик и увидите, как все происходит на самом деле.

#### Точки останова и просмотр значений
Никаких особенных действий, чтобы воспользоваться отладчиком, производить не нужно. Почти все вам уже известно. Единственное, чего вы пока не знаете, это как сказать программе, чтобы она остановилась в нужном месте.
Для этого используются точки останова. Точка останова – это специальная отметка (рис. 7.14). Она показывает, перед выполнением какой инструкции прикладное решение должно остановиться и ждать дальнейших команд от вас.

Рис. 7.14. Точка останова  {https://ai2b.pro/wp-content/uploads/1/07_014.png}
Чтобы установить точку останова, нужно дважды щелкнуть мышью на серой полосе слева. В той строке, перед выполнением которой нужно остановиться.
Если на точке останова снова дважды щелкнуть мышью, то точка останова пропадет.
Теперь все, что вам нужно, это запустить проект в режиме отладки.
В результате вы не увидите привычного интерфейса прикладного решения. Как только платформа дойдет до выполнения инструкции, которую вы отметили, она остановится и откроет перспективу Отладка. Вы увидите такую картинку (рис. 7.15).

Рис. 7.15. Перспектива «Отладка»  {https://ai2b.pro/wp-content/uploads/1/07_015.png}
В частности, редактор встроенного языка будет выглядеть следующим образом (рис. 7.16).

Рис. 7.16. Работа программы остановлена на строке «МойВозраст = 25»  {https://ai2b.pro/wp-content/uploads/1/07_016.png}
Синяя стрелка на серой полосе слева показывает, какую инструкцию 1C:EDT приготовилась выполнять. То есть сейчас она приготовилась выполнять инструкцию присваивания, которую вы написали.
Как посмотреть значение переменной МойВозраст? Для этого есть несколько способов.
Первый и самый простой – подвести к ней указатель мыши и немного подождать. Значение переменной будет показано во всплывающем окне (рис. 7.17).

Рис. 7.17. Быстрый просмотр значения переменной  {https://ai2b.pro/wp-content/uploads/1/07_017.png}
Другой способ – панель Переменные. В ней 1C:EDT автоматически покажет все переменные (и их значения), которые доступны в данный момент.
Эта панель обычно расположена в правом верхнем углу перспективы Отладка (рис. 7.18).

Рис. 7.18. Панель «Переменные»  {https://ai2b.pro/wp-content/uploads/1/07_018.png}
Это окно устроено очень просто. Каждая переменная в нем занимает одну строку. В первой колонке показано имя переменной.
Во второй колонке – ее значение. Пока у переменной МойВозраст нет никакого значения, поэтому во второй колонке написано Неопределено.
В третьей колонке – тип этой переменной. Вы пока ничего не помещали в переменную МойВозраст, поэтому 1C:EDT не знает, какой тип у этой переменной. В таких случаях она пишет Неопределено.
Теперь нужно сказать платформе, чтобы она выполнила вашу инструкцию. Ту, перед которой она остановилась.
Для выполнения программы по одному шагу (или по нескольким шагам сразу) есть ряд кнопок. Они расположены в командной панели наверху (рис. 7.19).

Рис. 7.19. Кнопка «Шаг в»  {https://ai2b.pro/wp-content/uploads/1/07_019.png}
Первая из них – Шаг в – именно та, что вам нужна. Она используется чаще всего. Если подвести к ней указатель мыши и подождать, то появится подсказка. В подсказке написано, какой клавишей можно сделать то же самое действие, – F5.
Нажмите F5 на клавиатуре. Это самый простой и удобный способ, которым пользуются программисты. Платформа выполнит одну инструкцию и остановится перед выполнением следующей (рис. 7.20).

Рис. 7.20. Остановка на второй инструкции  {https://ai2b.pro/wp-content/uploads/1/07_020.png} 
Строка, перед выполнением которой платформа остановилась, опять отмечена синей стрелкой. То есть ваша инструкция присвоения выполнилась.
Существует еще один способ просмотра значений переменных, который называется встроенная отладка. Значения локальных переменных, используемых в модуле, можно видеть прямо в тексте модуля (серым цветом). Чтобы включить этот режим, нажмите кнопку в командной панели (рис. 7.21).

Рис. 7.21. Переключение режима встроенной отладки  {https://ai2b.pro/wp-content/uploads/1/07_021.png}
Совет
Чтобы увидеть результаты встроенной отладки, добавьте в модуль еще одну строку, как на картинке, снова запустите отладку и сделайте один шаг.
Этот способ удобен, когда вы используете простые инструкции. Для сложных инструкций он может быть менее удобным, поэтому в любой момент вы можете отключить режим встроенной отладки, нажав кнопку еще раз.
В то же время, если вернуться к известным способам просмотра значений, при наведении мыши на переменную вы также увидите ее новое значение (рис. 7.22).

Рис. 7.22. Новое значение переменной во всплывающем окне  {https://ai2b.pro/wp-content/uploads/1/07_022.png}
Это же значение вы можете увидеть и в панели Переменные (рис. 7.23).

Рис. 7.23. Новое значение переменной в панели «Переменные»  {https://ai2b.pro/wp-content/uploads/1/07_023.png}
После того как вы посмотрели все, что вам нужно, вы можете сказать 1C:EDT, чтобы она завершила отладку. Для этого нажмите в командной панели кнопку Прекратить (рис. 7.24).

Рис. 7.24. Прекратить отладку  {https://ai2b.pro/wp-content/uploads/1/07_024.png}
Отладка будет завершена, но вы останетесь в перспективе Отладка. В этой перспективе, так же как и в перспективе 1C:Enterprise, вы можете редактировать модули. Поэтому вы можете продолжать работать в ней, а можете переключиться в перспективу 1C:Enterprise, – это дело вкуса. Чтобы переключиться, используйте панель перспектив (рис. 7.25).

Рис. 7.25. Панель перспектив  {https://ai2b.pro/wp-content/uploads/1/07_025.png}
Выполняя примеры, которые расположены дальше, придерживайтесь этой последовательности действий:
Внесите изменения в модуль (напишите новую команду или измените старую).
Установите точку останова на той строке, которая вам нужна.
Запустите проект в режиме отладки.
После того как вы посмотрели все интересующие вас значения, завершите отладку.
СОВЕТ
Когда вы в очередной раз решите посмотреть значение какой-нибудь переменной, не забывайте, что запускать проект нужно обязательно в режиме отладки (F11). Если вы запустите его просто на выполнение (Ctrl + F11), 1C:EDT не будет обращать внимание на точки останова.
ПРИМЕЧАНИЕ
Даже если вы запустили проект в режиме отладки, 1C:EDT не всегда будет останавливаться на точках останова. Есть особенные режимы работы программы (они в этой книге не используются), когда требуется дополнительная настройка. Подробнее о настройке разных режимов отладки вы можете прочитать в документации «Настройка автоматического подключения предметов отладки».

#### Изменение значений переменных
Теперь вы умеете создавать переменные и помещать в них значения. Познакомьтесь с тем, как можно изменять значения переменных.
Редко бывает так, что программист создал переменную, поместил в нее какое-то значение, а дальше только пользуется этим значением. Чаще бывает по-другому.
Программист создал переменную, поместил в нее значение, использовал тут, там. Потом поместил в нее другое значение. И тоже использовал эту переменную где-то. Потом опять изменил значение переменной. И так далее.
Изменить значение переменной очень просто. Нужно снова написать инструкцию присваивания.
Например, в переменной МойВозраст находится значение 25. Чтобы изменить значение этой переменной, напишите еще одну инструкцию (рис. 7.26) и поставьте на ней точку останова.

Рис. 7.26. Вторая инструкция присваивания  {https://ai2b.pro/wp-content/uploads/1/07_026.png}
Запустите проект в режиме отладки и посмотрите, как будет изменяться значение переменной МойВозраст.
Сначала оно будет равно 25. Когда вы сделаете один шаг (F5), вторая инструкция выполнится и значение переменной станет 30 (рис. 7.27).

Рис. 7.27. Результат выполнения второй инструкции присваивания  {https://ai2b.pro/wp-content/uploads/1/07_027.png}
На этой картинке хорошо видно, что одинаковые на первый взгляд инструкции имеют совершенно разный смысл.
Первая инструкция присваивания создает переменную МойВозраст и помещает туда значение 25.
Вторая инструкция присваивания ничего не создает. В ту переменную, которая уже существует, она помещает значение 30.

#### Контекстная подсказка
Сейчас подходящее время для того, чтобы познакомиться с еще одним важным инструментом разработчика – контекстной подсказкой. Она значительно упрощает жизнь программиста и позволяет избежать большого количества нелепых ошибок. Особенно на первом этапе, когда многие слова во встроенном языке являются для вас новыми и непривычными.
Когда вы писали вторую инструкцию присваивания, очень важно было не сделать ошибку в имени переменной МойВозраст. Если бы вы написали «МойВозратс» (случайно переставили местами две последние буквы), 1C:EDT подумала бы, что вы хотите создать новую переменную. И вместо того, чтобы поместить значение 30 в переменную МойВозраст, создала бы новую переменную и значение 30 поместила бы в нее.
Попробуйте написать еще одну инструкцию присваивания, но уже используя контекстную подсказку. В переменную МойВозраст нужно поместить значение 12.
В новой строке напишите начало имени вашей переменной «Мо» и вызовите контекстную подсказку. Для этого нужно нажать сочетание клавиш Ctrl + Пробел (рис. 7.28).

Рис. 7.28. Контекстная подсказка  {https://ai2b.pro/wp-content/uploads/1/07_028.png}
Список контекстной подсказки будет содержать все, что платформа «знает». Все, что вы можете использовать в этом месте без каких-либо дополнительных «объяснений». Причем этот список отсортирован по вероятности использования, и в нем в первой строке находится ваша переменная МойВозраст. Платформа тоже «знает» ее, потому что эту переменную вы создали парой строк выше.
Справа от контекстной подсказки открывается дополнительное окно, которое содержит синтаксическую подсказку для каждого элемента, выбранного в левом окне.
Нажмите клавишу Ввод – и строка МойВозраст подставится в текст программы. Попробуйте.
На будущее: если нужный вам элемент контекстной подсказки находится не на первом месте, вы можете прокручивать список, передвигаться по нему клавишами Вверх и Вниз, выделять элемент мышью и читать синтаксическую подсказку к нему.
Также вы можете не искать глазами нужную строчку в этом списке, а уже после того, как окно контекстной подсказки открыто, продолжать набирать имя переменной на клавиатуре. Постепенно в списке останутся только подходящие строки.
Есть еще более интересный способ. Например, вы точно знаете, а со временем вы будете это знать, что с букв «мойвоз» начинается только нужная вам переменная – и больше ничего. Тогда вы можете написать эти буквы (рис. 7.29) и вызвать контекстную подсказку.

Рис. 7.29. Момент, в который нужно вызвать контекстную подсказку  {https://ai2b.pro/wp-content/uploads/1/07_029.png}
В этом случае у 1C:EDT выбора не будет. Поскольку в этом месте есть единственная известная ей переменная, которая начинается на «мойвоз». Тогда 1C:EDT не будет предлагать вам ничего выбрать, а сразу же подставит имя переменной в текст программы (рис. 7.30). Попробуйте.

Рис. 7.30. Контекстная подсказка сразу подставит имя переменной  {https://ai2b.pro/wp-content/uploads/1/07_030.png}
Использовать контекстную подсказку удобно, полезно и нужно. Во-первых, это поможет вам избежать многих орфографических ошибок. Во-вторых, значительно сэкономит ваше время, потому что большинство слов вам не нужно будет дописывать до конца: 1C:EDT допишет за вас.
Кроме контекстной подсказки есть и другой инструмент, который поможет вам не допускать ошибок. Это выделение текущих идентификаторов. Если вы установите курсор в любое место на имени переменной МойВозраст, 1C:EDT подсветит вам эту переменную везде, где она встречается в тексте модуля (рис. 7.31).

Рис. 7.31. Подсветка текущего идентификатора  {https://ai2b.pro/wp-content/uploads/1/07_031.png}
Использовать этот инструмент можно следующим образом. Если вы сомневаетесь, что набрали имя переменной правильно, установите курсор на ней. Тогда подсветятся все остальные упоминания этой переменной в модуле (рис. 7.31).
Если же имя переменной набрано неправильно, подсвечена будет только текущая переменная (рис. 7.32).

Рис. 7.32. Ошибка в имени переменной  {https://ai2b.pro/wp-content/uploads/1/07_032.png}
И теперь последний интересный эксперимент, который вы тут выполните. Он еще раз продемонстрирует вам, что в первой инструкции вы создаете переменную, а во второй инструкции присваиваете значение той переменной, которая уже существует.
Чтобы было удобнее, отредактируйте текст так, как показано на рис. 7.33. Добавьте две пустые строки между инструкциями.

Рис. 7.33. Как отредактировать модуль  {https://ai2b.pro/wp-content/uploads/1/07_033.png}
Теперь перед первой инструкцией присваивания напишите «мо» и вызовите контекстную подсказку (рис. 7.34).

Рис. 7.34. Контекстная подсказка до описания переменной  {https://ai2b.pro/wp-content/uploads/1/07_034.png}
Посмотрите: в списке контекстной подсказки нет вашей переменной МойВозраст. Потому что в этом месте она еще не объявлена. Только в следующей строке 1C:EDT узнает, что вы хотите использовать такую переменную.
А теперь напишите «мо» между инструкциями присваивания и вызовите контекстную подсказку (рис. 7.35).

Рис. 7.35. Контекстная подсказка после объявления переменной  {https://ai2b.pro/wp-content/uploads/1/07_035.png}
А в этом месте 1C:EDT уже знает, что есть такая переменная МойВозраст. Потому что она объявлена строчкой выше. И, значит, инструкции присваивания, которые идут дальше, могут изменять ее значение.

#### Выбор имени для переменной
Важно, чтобы имя переменной, которую вы хотите создать, не совпало с тем, что 1C:EDT уже знает в этом месте модуля. А как узнать, что знает 1C:EDT? Правильно! Вызвать контекстную подсказку.
Попробуйте сделать такой пример (рис. 7.36).

Рис. 7.36. Неправильный выбор имени переменной  {https://ai2b.pro/wp-content/uploads/1/07_036.png}
1C:EDT покажет вам ошибку в четвертой строке. Если вы подведете курсор к подчеркнутому идентификатору, то увидите причину этой ошибки (рис. 7.37).

Рис. 7.37. Сообщение об ошибке  {https://ai2b.pro/wp-content/uploads/1/07_037.png}
Причина заключается в том, что в этом месте программы уже существует свойство РазмерКартинки и это свойство предназначено только для чтения. Своей инструкцией присваивания вы попытались изменить его значение. Но сделать это невозможно. О чем 1C:EDT вам и сказала.
Чтобы обезопасить себя от подобных ошибок, поступайте следующим образом. Когда вы пишете инструкцию присваивания, которая создает новую переменную, пользуйтесь контекстной подсказкой (рис 7.38).

Рис. 7.38. Контекстная подсказка при вводе имени переменной  {https://ai2b.pro/wp-content/uploads/1/07_038.png}
Наберите первые буквы вашей переменной, откройте контекстную подсказку и продолжайте вводить имя переменной. Если оно случайно совпадет с чем-то, что 1C:EDT уже известно, вы тут же об этом узнаете.

#### Выражение
Теперь вы знаете, как создавать переменные, как придумывать им имена, как присваивать значения переменным. Еще раз посмотрите, как схематически выглядит инструкция присваивания, которой вы сейчас занимаетесь:
<Имя переменной> = <Выражение>;
Теперь ваша задача – понять, что это за выражение, которое находится справа от знака равенства. В этом вам поможет инструкция присваивания, которую вы уже видели (листинг 7.8):
Листинг 7.8. Инструкция присваивания
СтоимостьМатериала = 10 * 3;
Выражение – это математическая, или логическая, или строковая формула, по которой вычисляется значение. В примере это 10 * 3.
Выражение обычно состоит из одной или нескольких операций. В примере одна операция – это операция умножения, которая обозначается знаком звездочка – «*».
Самое простое выражение может не содержать ни одной операции, только значение. Такой пример вы уже писали (листинг 7.9).
Листинг 7.9. Пример самого простого выражения
МойВозраст = 25;
В этом примере значение – это 25, то есть литерал типа Число.
В выражениях можно использовать не только литералы, но и переменные. Например, вы можете взять пример из листинга 7.8 и изменить его так, чтобы умножались не два числа, а две переменные (рис. 7.39).

Рис. 7.39. Выражение с двумя переменными  {https://ai2b.pro/wp-content/uploads/1/07_039.png}
Попробуйте. При вводе имен переменных в шестой строке не забывайте пользоваться контекстной подсказкой.
СОВЕТ
Сразу возьмите себе за правило ставить пробелы перед знаками операций (+, -, *, / ) и после них. Тогда текст программы будет читаться легко.
Установите точку останова в первой строке примера и пройдите его по шагам в режиме отладки. Посмотрите, как меняются значения переменных.
В 1C:EDT есть специальная команда, с помощью которой вы можете посмотреть, какое значение получается в результате вычисления выражения справа, еще до того, как это значение будет помещено в переменную. Познакомьтесь с этой командой.
В последнем примере поставьте точку останова на шестой строке и запустите отладку (рис. 7.40).

Рис. 7.40. Остановка на 6-й строке  {https://ai2b.pro/wp-content/uploads/1/07_040.png}
Обратите внимание, что значение переменной СтоимостьМатериала пока еще не определено. Потому что эта инструкция еще не выполнялась. Но значения переменных Количество и Цена уже известны.
Теперь с помощью мыши выделите все выражение, которое находится справа от знака равенства. И нажмите сочетание клавиш Shift + F9. Откроется окно вычисления выражений (рис. 7.41).

Рис. 7.41. Окно вычисления выражений  {https://ai2b.pro/wp-content/uploads/1/07_041.png}
В этом окне вы увидите и свое выражение, и значение, которое получится в результате его вычисления. В вашем примере выражение простое. Поэтому кажется, что такая функция не очень-то и нужна. Но в реальных программах выражения могут быть сложными. С помощью этой функции вы легко можете выделить все выражение (или только его часть) и посмотреть, какое значение получится.
Платформа, так же как и вы, сначала вычисляет выражение, а потом помещает его в переменную слева. Поэтому переменную, которая находится слева от знака равенства, можно использовать в выражении в этой же инструкции присваивания.
Попробуйте сделать такой пример. Сначала в переменную запишите свой возраст. А теперь представьте, что прошел один год и в следующей строке вам нужно записать в эту переменную свой возраст через год. Как вы это сделаете?
Ответ находится на следующем рисунке (рис. 7.42). Если у вас получилось то же самое – замечательно! Если нет – не расстраивайтесь, скопируйте пример к себе в проект.

Рис. 7.42. Вы стали на год взрослее  {https://ai2b.pro/wp-content/uploads/1/07_042.png}
На первый взгляд такая «конструкция» кажется странной. Но только не для компьютера.
Установите точку останова на пятой строке и в режиме отладки посмотрите, как изменится значение переменной МойВозраст. Сначала в ней будет значение 25. А после выполнения второй строки значение изменится на 26.

#### Арифметические операции
Как вы теперь знаете, в выражении можно использовать разные операции. Также вы знаете, что не со всеми значениями можно выполнять одни и те же операции.
Например, если ваши значения имеют тип Число, то с ними можно выполнять арифметические операции: сложение, вычитание, умножение и деление. Эти операции вам хорошо известны. Единственное, что может вызвать трудность, это каким знаком обозначать умножение и деление.
Но и это вы уже знаете. Умножение обозначается знаком звездочка «*», а деление – знаком косая черта «/».
Одновременно в выражении может участвовать любое количество арифметических операций. Но выполняются они не в той последовательности, как они написаны. Вам это известно из математики. В математике существует определенный порядок выполнения операций. А кроме этого используются скобки, чтобы указать именно тот порядок, который вам нужен.
Во встроенном языке то же самое:
если в выражении есть скобки, то сначала вычисляется то, что в скобках;
если скобок нет, то в первую очередь выполняются операции умножения и деления в том порядке, в котором они написаны;
в самую последнюю очередь выполняются операции сложения и вычитания (в том порядке, в котором они написаны).

#### Операции со строками
Если ваши значения имеют тип Строка, то они тоже могут участвовать в выражении. Но операций, которые часто используются при работе со строками, всего лишь две. Одну из них вы сейчас и рассмотрите.
Эта операция заключается в том, чтобы к одной строке дописать другую строку. Называется она конкатенация, а обозначается знаком «+».
Сделайте такой пример. В одной переменной сохраните название вашего города. В другой переменной – название улицы, на которой вы живете. А в третью переменную с помощью выражения запишите ваш адрес, который будет состоять из названия города и улицы.
Чтобы проверить себя, можете посмотреть на рисунок 7.43.

Рис. 7.43. Пример конкатенации строк {https://ai2b.pro/wp-content/uploads/1/07_043.png}
Установите точку останова на конце процедуры и в режиме отладки посмотрите, какое значение получилось в переменной Адрес.
Вы увидите, что две строки действительно «склеились» и получилась строка КрасноярскЦветочная.
С одной стороны, это хорошо, потому что конкатенация работает. С другой стороны, не очень хорошо, потому что результат выглядит «не очень».
Поэтому при конкатенации строк очень часто используют литералы типа Строка, чтобы отделить одно строковое значение от другого. И для того, чтобы это понятно читалось и хорошо выглядело.
В вашем примере хотелось бы вместо КрасноярскЦветочная видеть Красноярск, Цветочная. Чтобы добиться такого результата, измените последнюю строку так, как показано в листинге 7.10.
Листинг 7.10. Использование литерала для разделения строк
Адрес = Город + ", " + Улица;
Запустите этот пример в режиме отладки и посмотрите, какой получается результат.

#### Тип «Дата» и операции с датами
Дата – это первый необычный тип данных, с которым вам придется столкнуться. В повседневной жизни вы используете даты очень часто и часто делаете с ними какие-то операции. Но в жизни вы привыкли воспринимать даты отдельными частями.
Например, когда вас спрашивают: «Сколько вам лет?» – вы из одного года вычитаете другой год. То есть из одного числа вычитаете другое. Когда вас спрашивают, через сколько минут начнется фильм, вы тоже из одного числа (количество минут) вычитаете другое число (количество минут).
В «1С:Предприятии» не так. В «1С:Предприятии» значение типа Дата – это всегда календарная дата вместе со временем с точностью до секунд. Например, «17.10.2022 18:19:10». Это значит «восемнадцать часов девятнадцать минут десять секунд семнадцатого октября две тысячи двадцать второго года».
Чтобы убедиться в этом, вы можете выполнить простой пример. Напишите в модуле инструкцию, которая показана на рисунке 7.44. Когда будете писать ТекущаяДата(), не забывайте пользоваться контекстной подсказкой.

Рис. 7.44. Текущая дата {https://ai2b.pro/wp-content/uploads/1/07_044.png}
Установите точку останова на конце процедуры, запустите проект в режиме отладки и посмотрите значение переменной Сейчас. В ней будет текущее время, установленное на вашем компьютере.
Значения типа Дата, так же как числа и строки, можно записывать прямо в тексте программы. Это используется не очень часто, но используется. Поэтому посмотрите, как выглядит литерал типа Дата (рис. 7.45).

Рис. 7.45. Литерал типа «Дата» {https://ai2b.pro/wp-content/uploads/1/07_045.png}
Он обязательно обрамляется символами одинарная кавычка – «’». А внутри разные части даты указываются в такой последовательности: год, месяц, день, час, минуты, секунды. При этом вы можете отделять их друг от друга какими-нибудь символами, чтобы легче читалось, или не отделять. И так и так будет правильно. Лишь бы соблюдалась последовательность, в которой они указаны. Попробуйте.
Литералы типа Дата используют нечасто, потому что выглядят они довольно сложно, а читать их не очень удобно. Гораздо чаще для работы с датами используют функции встроенного языка. Просто запомните это название. Позже вы узнаете, что это такое.
Посмотреть, какие есть функции для работы с датами, очень просто. Для этого вам понадобится синтакс-помощник. Чтобы его открыть, нажмите сочетание клавиш Shift + F1, а затем в появившемся окне справки нажмите кнопку Показать в оглавлении.

Рис. 7.46. Показать в оглавлении {https://ai2b.pro/wp-content/uploads/1/07_046.png}
Примечание
Другой способ открыть синтакс-помощник: нажмите в главном меню Справка > Оглавление справки и далее выберите 1С:Предприятие (синтакс-помощник) > 1С:Предприятие > Версия 8.3.21 > Синтакс помощник (рис. 7.47).

Рис. 7.47. Синтакс-помощник {https://ai2b.pro/wp-content/uploads/1/07_047.png}
Синтакс-помощник – это большой справочник по встроенному языку. В левом окне находится его «оглавление». В нем вы можете выбрать интересующий вас раздел, и в правом окне откроется содержимое этого раздела.
Встроенные функции, предназначенные для работы с датами, находятся в разделе Глобальный контекст > Функции работы со значениями типа Дата (рис. 7.48).

Рис. 7.48. Функции для работы со значениями типа «Дата» {https://ai2b.pro/wp-content/uploads/1/07_048.png}
А кроме них в разделе Глобальный контекст > Функции преобразования значений находится еще одна полезная функция – Дата() (рис. 7.49). С ней вы познакомитесь прямо сейчас.

Рис. 7.49. Функция «Дата()» {https://ai2b.pro/wp-content/uploads/1/07_049.png}
Она создает значение типа Дата из года, месяца, дня и т. д., которые вы перечислите в скобках через запятую. Попробуйте написать эту функцию с помощью контекстной подсказки. Наберите «дат» и вызовите контекстную подсказку (рис. 7.50).

Рис. 7.50. Контекстная подсказка {https://ai2b.pro/wp-content/uploads/1/07_050.png}
Вы видите, что существуют три варианта для написания этой функции: краткий (год, месяц, день), полный (с часами, минутами и секундами) и вариант с указанием значения. Выберите полный вариант (рис. 7.51).

Рис. 7.51. Шаблон функции «Дата()» {https://ai2b.pro/wp-content/uploads/1/07_051.png}
1C:EDT вставит в модуль шаблон вызова этой функции и покажет подсказку, которая поможет вам установить параметры этой функции.
Первый параметр – это год. Напишите 2022 и поставьте курсор перед следующей запятой (рис. 7.52)

Рис. 7.52. Контекстная подсказка функции {https://ai2b.pro/wp-content/uploads/1/07_052.png}
Подсказка сообщит вам, что второй параметр – это месяц и он имеет тип Число. Значит, если вам нужен месяц март, то вы можете написать не 03, как в литерале, а просто 3.
СОВЕТ
Если окно контекстной подсказки параметров закрылось, вы в любой момент можете снова открыть его. Для этого используйте комбинацию клавиш Ctrl + Shift + Пробел.
Вот так, пользуясь контекстной подсказкой, допишите инструкцию до конца. Не забудьте закончить ее точкой с запятой (рис. 7.53).

Рис. 7.53. Функция «Дата()» {https://ai2b.pro/wp-content/uploads/1/07_053.png}
После этого запустите проект в режиме отладки и убедитесь, что в переменной Сейчас то же значение, которое было и в предыдущем примере (см. рис. 7.45).
СОВЕТ
Сразу возьмите себе за правило ставить пробелы после запятой. Тогда текст программы будет читаться легко.
Теперь вернемся к функциям для работы с датами. Одну из них вы уже знаете и использовали. Это функция ТекущаяДата() (рис. 7.44).
Очень часто в прикладном решении вам могут понадобиться такие даты, как начало некоторого дня и конец некоторого дня. Для их получения существуют две функции с аналогичными именами: НачалоДня() и КонецДня(). Познакомьтесь с тем, где в «1С:Предприятии» день начинается и где он заканчивается.
В одну переменную поместите текущую дату, а в другую переменную – результат функции НачалоДня(), примененной к первой переменной (рис. 7.54).

Рис. 7.54. Начало дня {https://ai2b.pro/wp-content/uploads/1/07_054.png}
Запустите проект в режиме отладки и посмотрите, чему равно НачалоСегодня. Это будет сегодняшняя дата и нулевое время. Например, 17.10.2022 0:00:00.
СОВЕТ
Довольно часто встречаются прикладные задачи, когда нужно знать дату, но точное время не важно. В таких случаях обычно используют начало дня.
Теперь посмотрите, чему равен конец дня. Создайте другую переменную, в которую будет помещен результат функции КонецДня(). Но внутри скобок у этой функции напишите не имя переменной ТекДата, а саму функцию ТекущаяДата() (рис. 7.55).

Рис. 7.55. Использование результата функции в качестве параметра {https://ai2b.pro/wp-content/uploads/1/07_055.png}
Так тоже можно делать. Потому что внутри скобок может быть не только литерал или переменная, но и выражение. То есть некоторая формула, результатом которой может быть значение. Например, функция, возвращающая значение.
Запустите проект в режиме отладки и посмотрите, чему равно КонецСегодня. Это будет сегодняшняя дата и время 23:59:59. Например, 17.10.2022 23:59:59.
Теперь познакомьтесь с тем, какие операции можно выполнять с датами. Для значений типа Дата и типа Число во встроенном языке определены операции сложения и вычитания. То есть к дате можно прибавить некоторое количество секунд. Это используется для того, чтобы прибавить или убавить какой-то фиксированный промежуток времени.
Например, в одной переменной у вас находится текущее время. Как в другой переменной получить время на один час больше? Попробуйте выполнить это самостоятельно.
Для сравнения посмотрите на рисунок 7.56.

Рис. 7.56. Дата на час больше {https://ai2b.pro/wp-content/uploads/1/07_056.png}
Чтобы получить дату на час больше, нужно к дате прибавить 60 раз по 60 секунд. То есть то количество секунд, которое содержится в одном часе.
Операция сложения (вычитания) даты с числом часто используется тогда, когда нужно получить начало следующего дня или конец предыдущего дня. Поскольку они отличаются всего на одну секунду, нужно эту секунду прибавить или отнять.
Попробуйте самостоятельно получить конец предыдущего дня. А потом сравните свой вариант с тем, что показано на рисунке 7.57.

Рис. 7.57. Конец предыдущего дня {https://ai2b.pro/wp-content/uploads/1/07_057.png}
Еще одна операция, которая определена для значений типа Дата, – это вычитание. Из одной даты можно вычесть другую дату. Что получится в этом случае?
Правильно. В результате получится некоторое количество секунд. К сожалению, во встроенном языке нет никакой функции, которая могла бы преобразовать количество секунд к виду, привычному для нас. Например: от одной даты до другой «прошло 2 месяца, 11 дней, 5 часов и 48 минут». И в рамках этой книги решать такие задачи вам не понадобится.
Но если вам интересно, вы можете попробовать самостоятельно написать программу из нескольких инструкций, которая будет это делать. Для этого вам потребуются операция деления, функция получения целой части Цел() и операция получения остатка от деления % (рис. 7.58).

Рис. 7.58. Функция, формирующая представление периода {https://ai2b.pro/wp-content/uploads/1/07_058.png}
В панели Переменные вы увидите следующий результат (рис. 7.59).

Рис. 7.59. Значения переменных {https://ai2b.pro/wp-content/uploads/1/07_059.png}

#### Тип «Булево» и логические операции
Настало время познакомиться с логическими операциями и новым типом данных – Булево.
Самая простая логическая операция – это операция Равно. Она выясняет, равны между собой два значения или нет.
Эта операция определена для значений любых типов: для чисел, строк, дат и так далее. Важно лишь, чтобы оба значения, которые вы сравниваете, были одного и того же типа. Например, два числа или две строки.
Логическая операция Равно обозначается знаком «=». В подавляющем большинстве случаев логические операции используются в инструкциях Если и Цикл. Но эти инструкции вам пока незнакомы.
Поэтому знакомиться с операцией Равно вы будете с помощью инструкции присваивания. В ней эта операция будет выглядеть немного странно, поэтому для пущей важности вы заключите ее в скобки (рис. 7.60).

Рис. 7.60. Заготовка для операции «Равно» {https://ai2b.pro/wp-content/uploads/1/07_060.png}
Теперь внутри скобок напишите операцию Равно. Например, 5 = 5.
Затем напишите еще одну инструкцию присваивания, но так, чтобы в операции Равно участвовали разные числа. Например, 5 и 2.
Запустите проект в режиме отладки и посмотрите, чему равны переменные в этих инструкциях (рис. 7.61).

Рис. 7.61. Значение «Истина» и значение «Ложь» {https://ai2b.pro/wp-content/uploads/1/07_061.png}
Вы увидите, что там, где сравниваются два одинаковых числа, результатом является значение Истина. А там, где сравниваются разные числа, результатом является значение Ложь. К тому же оба этих значения имеют тип Булево (ударение на букву «у»).
Значения типа Булево – это значения, получаемые в результате логических операций. Значений типа Булево не бесконечное множество, как чисел или строк, а всего лишь два: Истина и Ложь.
Логических операций во встроенном языке, как и в жизни, довольно много. Все они интуитивно понятны, и нет особой надобности в том, чтобы тренироваться в их использовании. Единственное, что может вызвать трудность, – это то, какими символами они обозначаются. Но в этом вам поможет таблица 3.1.
Таблица 7.1. Операции сравнения
















































































Все перечисленные в этой таблице операции называются операциями сравнения. Потому что они сравнивают два значения. Причем операции Равно и Не равно можно применять к значениям любых типов. Главное, чтобы типы были одинаковыми с одной и с другой стороны операции.
А вот оставшиеся четыре операции (больше/меньше) можно применять только к двум числам, двум строкам или к двум датам.
В этом разделе вы не будете выполнять примеры с операциями сравнения. Но когда вы познакомитесь с инструкцией Если, у вас будет возможность как следует поупражняться в написании разных операций сравнения.

#### Булевы операции
А сейчас можно познакомиться с самыми интересными логическими операциями. Кроме операций сравнения есть еще группа логических операций, которые называются булевы операции.
Если операции сравнения можно было выполнять (в основном) над числами, строками и датами, то булевы операции выполняются только со значениями типа Булево. То есть со значениями Истина и Ложь.
В следующих примерах вам понадобится записывать булевы значения прямо в тексте программы, то есть использовать литералы. Так вот, литералы типа Булево выглядят очень просто. Значение Истина обозначается Истина, а значение Ложь обозначается Ложь.
Например, если вы хотите создать переменную, которая будет описывать погоду за окном, вы можете написать так (рис. 7.62).

Рис. 7.62. Литерал значения «Истина» {https://ai2b.pro/wp-content/uploads/1/07_062.png}
А если в другой переменной вы хотите уточнить, есть на улице дождь или нет, вы можете написать так (рис. 7.63). Попробуйте и посмотрите, чему равны переменные.

Рис. 7.63. Литерал значения «Ложь» {https://ai2b.pro/wp-content/uploads/1/07_063.png}
Обратите внимание, что 1C:EDT раскрашивает слова Истина и Ложь малиновым цветом. Потому что это специальные зарезервированные слова. И это значит, что переменную с таким именем, если вам вдруг захочется, создать нельзя.
Чтобы познакомиться с первой булевой операцией, создайте две переменные: ЯУмеюПлавать и РядомЕстьМоре. Задайте им те значения, которые есть на самом деле. А в книге для примера они будут иметь значение Истина (рис. 7.64).

Рис. 7.64. Переменные «ЯУмеюПлавать» и «РядомЕстьМоре» {https://ai2b.pro/wp-content/uploads/1/07_064.png}
Теперь вам нужно с помощью логической операции узнать, будете вы плавать в море или нет.
Сначала попробуйте сказать это обычными словами. Наверное, получится что-то вроде «если я умею плавать и если рядом есть море, то тогда я буду плавать в море».
А теперь посмотрите (рис. 7.65), как эта же фраза выглядит на встроенном языке.

Рис. 7.65. Операция «И» {https://ai2b.pro/wp-content/uploads/1/07_065.png}
Чтобы сказать то же самое на встроенном языке, используется операция И. Как она работает, вы можете проверить сами на этом примере, изменив значения переменных.
Плавать в море вы будете только в том случае, когда оно есть рядом и вы умеете плавать. Если моря рядом нет, то плавать просто негде. А если вы не умеете плавать, то у вас тоже ничего не получится. Это очень опасно, вы можете утонуть. Ну, а если и моря нет, и плавать вы не умеете, то тем более поплавать в море вам не удастся.
Итак, операция И возвращает значение Истина только в том случае, когда оба операнда имеют значение Истина. Во всех остальных случаях она возвращает значение Ложь.
Теперь решите другую задачу. Создайте две переменные УМеняЕстьЛодка и УМеняЕстьПлот. Можете задать им любые значения. А в книге для примера они будут иметь значение Истина (рис. 7.66).

Рис. 7.66. Переменные «УМеняЕстьЛодка» и «УМеняЕстьПлот» {https://ai2b.pro/wp-content/uploads/1/07_066.png}
Теперь вам нужно с помощью логической операции узнать, сможете вы переплыть через озеро или нет.
Сначала попробуйте сказать это обычными словами. Наверное, получится что-то вроде «если у меня есть плот или лодка, то я могу переплыть через озеро».
А теперь посмотрите (рис. 7.67), как эта же фраза выглядит на встроенном языке.

Рис. 7.67. Операция «ИЛИ» {https://ai2b.pro/wp-content/uploads/1/07_067.png}
Чтобы сказать то же самое на встроенном языке, используется операция ИЛИ. Как она работает, вы можете проверить сами на этом примере, изменив значения переменных.
Если у вас есть лодка, вы можете переплыть через озеро? Да.
А если у вас не лодка, а плот – тогда сможете? Да, сможете.
А если у вас есть и лодка, и плот? Конечно!
А в каком случае вам не удастся переплыть через озеро? Правильно. Когда у вас нет ни лодки, ни плота.
Итак, операция ИЛИ работает аналогично операции И, только в отношении значения Ложь. Она возвращает значение Ложь только в том случае, когда оба операнда имеют значение Ложь. Во всех остальных случаях она возвращает значение Истина.
Теперь усложните свой пример и познакомьтесь с тем, что в одном выражении могут использоваться сразу несколько булевых операций.
Создайте три переменные: ЯУмеюПлавать, РядомЕстьМоре и РядомЕстьБассейн. Задайте им те значения, которые есть на самом деле. А в книге они снова будут иметь значение Истина (рис. 7.68).

Рис. 7.68. Переменные «ЯУмеюПлавать», «РядомЕстьМоре» и «РядомЕстьБассейн» {https://ai2b.pro/wp-content/uploads/1/07_068.png}
А вопрос, решением которого вы займетесь, будет практически тем же самым. Чему будет равна переменная ЯБудуПлавать?
Если вы будете отвечать словами, то скажете: «Я буду плавать, если я умею плавать и рядом есть море или бассейн». Попробуйте записать это на встроенном языке (рис. 7.69).

Рис. 7.69. Переменная «ЯБудуПлавать» {https://ai2b.pro/wp-content/uploads/1/07_069.png}
На первый взгляд кажется, что все хорошо. Но нужно проверить.
Например, вы не умеете плавать. В этом случае не важно, есть рядом бассейн или нет: плавать вы не должны. Но что говорит вам программа? Попробуйте (рис. 7.70).

Рис. 7.70. «ЯБудуПлавать» = «Истина» {https://ai2b.pro/wp-content/uploads/1/07_070.png}
Программа говорит вам, что плавать вы будете. В чем же дело? Может быть, вы написали неправильные операции? Нет, правильные.
Просто вы не учли, что если несколько булевых операций встречаются в одном выражении, у них есть определенный порядок выполнения. Точно так же, как было с арифметическими операциями +, -, * и /.
Сначала выполняется операция И, а затем уже выполняется операция ИЛИ. А если подряд встречаются несколько одинаковых операций, то они выполняются в той последовательности, в которой написаны.
Поэтому в примере выражение было посчитано таким образом (рис. 7.71). Рис. 7.70. «ЯБудуПлавать» = «Истина» 

Рис. 7.71. Порядок вычисления выражения {https://ai2b.pro/wp-content/uploads/1/07_071.png}
Сначала была выполнена операция И, которая дала Ложь. А затем операция ИЛИ, результатом которой явилась Истина.
На самом же деле для вас в этом выражении важны две вещи. Что вы умеете плавать и что есть, где плавать. А море это или бассейн – не так важно.
Поэтому правильным решением будет РядомЕстьМоре ИЛИ РядомЕстьБассейн заключить в скобки (рис. 7.72). Попробуйте.

Рис. 7.72. «ЯБудуПлавать» = «Ложь» {https://ai2b.pro/wp-content/uploads/1/07_072.png}
Тогда платформа сначала вычислит то выражение, которое в скобках. То есть узнает: есть, где плавать, или плавать негде. А потом уже поинтересуется вашим умением плавать (рис. 7.73).

Рис. 7.73. Порядок вычисления выражения {https://ai2b.pro/wp-content/uploads/1/07_073.png}
Чтобы закрепить этот пример, немного измените его условие. Создайте три переменные: ЯУмеюПлавать, РядомЕстьМоре и РядомЕстьВанна. Задайте им те значения, которые были в последнем примере: Ложь, Истина и Истина (рис. 7.74).

Рис. 7.74. Переменные «ЯУмеюПлавать», «РядомЕстьМоре» и «РядомЕстьВанна» {https://ai2b.pro/wp-content/uploads/1/07_074.png}
А вычислить нужно будет переменную, которая называется ЯБудуКупаться. Будьте внимательны: имя переменной изменилось не просто так.
Попробуйте записать выражение на встроенном языке и потом сравните с тем, что на рисунке 7.75.

Рис. 7.75. «ЯБудуКупаться» = «Истина» {https://ai2b.pro/wp-content/uploads/1/07_075.png}
Запустите проект в режиме отладки и посмотрите, какой получается результат, если изменить значения переменных.
Почему в этом случае скобки не понадобились, хотя пример внешне очень похож на предыдущий? Скобки не понадобились потому, что «естественный» порядок выполнения логических операций в этом выражении вполне вас устраивает (рис. 7.76).

Рис. 7.76. Порядок вычисления выражения {https://ai2b.pro/wp-content/uploads/1/07_076.png}
Действительно, умение плавать важно только тогда, когда вы собираетесь зайти в море. Если вы хотите искупаться в ванне, то умение плавать вам совершенно не нужно.
Поэтому совершенно правильно, что сначала выполняется операция И и выясняется, можете ли вы купаться в море. А затем уже проверяется наличие ванны, для использования которой способность плавать не требуется.
В заключение нужно сказать еще об одной булевой операции – операции НЕ. Она очень простая. Она возвращает булево значение, противоположное тому, которое имеется.
Чтобы посмотреть, как она работает, вы можете использовать пример, показанный на рисунке 7.77.

Рис. 7.77. Операция «НЕ» {https://ai2b.pro/wp-content/uploads/1/07_077.png}
Обычно с использованием этой операции никаких трудностей не возникает. Единственное, что может вам понадобиться, это порядок выполнения булевых операций. Полностью он выглядит так:
сначала выполняется то, что в скобках;
затем операция НЕ;
затем операция И;
затем операция ИЛИ.

#### Инструкция «Если»
Наконец настало время познакомиться с еще одной инструкцией, которая используется во встроенном языке.
Если бы вы использовали только инструкцию присваивания, то ваша программа выглядела бы, как прямая дорога из пункта «А» в пункт «Б». От начала к завершению – потому что инструкции присваивания выполняются одна за другой в том порядке, в котором они написаны.
На самом деле большинство программ выглядят по-другому. Между началом программы и ее завершением существует много разных путей, по которым может пойти исполнение программы.
Для того чтобы направить исполнение программы по одному или другому пути, существует инструкция Если. Выглядит она очень просто (рис. 7.78).

Рис. 7.78. Инструкция «Если» {https://ai2b.pro/wp-content/uploads/1/07_078.png}
Она позволяет выделить несколько инструкций, которые будут выполняться не всегда, а только тогда, когда в результате вычисления логического выражения получается Истина.
Слова Если, Тогда и КонецЕсли являются обязательными в этой инструкции. Логическое выражение пишется между словами Если и Тогда. А КонецЕсли показывает, где заканчиваются инструкции, выполнение которых зависит от условия.
Чтобы посмотреть, как это работает, сделайте небольшой пример. Создайте переменную и запишите в нее свой возраст. А затем создайте другую переменную, ЯИдуВДетскийСад, и присвойте ей значение Истина. Но эту переменную создайте только в том случае, если вы еще не достигли школьного возраста. Чтобы не запутаться, будем считать, что школьный возраст начинается с 7 лет.
Когда вы сделаете свой пример, сравните его с тем, что на рисунке 7.79.

Рис. 7.79. Пример {https://ai2b.pro/wp-content/uploads/1/07_079.png}
Установите точку останова на строке Если…, запустите проект в режиме отладки и посмотрите значение выражения МойВозраст < 7 (Shift + F9) (рис. 7.80).

Рис. 7.80. Значение выражения «МойВозраст < 7» {https://ai2b.pro/wp-content/uploads/1/07_080.png}
Вы увидите, что оно равно Ложь. И это правильно. Ваш возраст больше, чем 7 лет.
Раз выражение ложно, значит, платформа должна пропустить все инструкции, которые написаны внутри инструкции Если. Проверьте это с помощью пошагового исполнения (F5). Сделайте один шаг (рис. 7.81).

Рис. 7.81. Один шаг исполнения {https://ai2b.pro/wp-content/uploads/1/07_081.png}
Действительно, 1C:EDT перейдет на строку КонецЕсли. А если вы шагнете еще раз, то она остановится на строке КонецПроцедуры. При этом значение переменной ЯИдуВДетскийСад будет Неопределено, потому что эта инструкция не выполнялась и такая переменная даже не создавалась.
А теперь познакомьтесь с тем, как поведет себя платформа в том случае, когда выражение истинно. Для этого вы не будете изменять текст программы. Вы воспользуетесь возможностью изменения значений переменных прямо в процессе отладки.
Если вы уже, как обычно, завершили отладку, запустите ее снова и шагните один раз, чтобы исполнение остановилось на строке КонецЕсли.
Чтобы перезапустить отладку, достаточно просто нажать F11. 1C:EDT обнаружит, что процесс отладки у вас уже запущен, и спросит, что делать дальше (рис. 7.82).

Рис. 7.82. Перезапустить отладку {https://ai2b.pro/wp-content/uploads/1/07_082.png}
Нажмите Перезапустить приложение. Текущий сеанс отладки будет завершен, будет запущен новый, и исполнение снова остановится на строке Если…
Теперь в панели Переменные щелкните по ячейке со значением 25 (рис. 7.83).

Рис. 7.83. Изменение значения переменной {https://ai2b.pro/wp-content/uploads/1/07_083.png}
Она перейдет в режим редактирования. Введите 6 и нажмите Enter.
С этого момента значение переменной МойВозраст будет равно 6. А вы можете продолжать отладку так же, как и раньше.
Посмотрите значение выражения МойВозраст < 7. Теперь оно будет равно Истина (рис. 7.84).

Рис. 7.84. Значение выражения «МойВозраст < 7» {https://ai2b.pro/wp-content/uploads/1/07_084.png}
Сделайте один шаг. Исполнение зайдет «внутрь» инструкции Если (рис. 7.85).

Рис. 7.85. Один шаг исполнения {https://ai2b.pro/wp-content/uploads/1/07_085.png}
Теперь, если вы сделаете еще несколько шагов, то дойдете до конца процедуры. А значение переменной ЯИдуВДетскийСад будет равно Истина.
До сих пор вы рассматривали самую простую форму инструкции Если. На самом деле она может быть более сложной. Смотрите.
В вашем примере «особенные» действия выполняются только в том случае, когда ваш возраст меньше 7 лет. Но представьте, что вам нужно принять решение из двух вариантов. Если меньше 7 лет, вы идете в детский сад. А во всех других случаях вы идете в школу. Как это записать на встроенном языке?
Оказывается, очень просто. Для этого используется ключевое слово Иначе (рис. 7.86).

Рис. 7.86. Ключевое слово «Иначе» {https://ai2b.pro/wp-content/uploads/1/07_086.png}
Доработайте пример так, чтобы в результате его работы у вас создавались две переменные: ЯИдуВДетскийСад и ЯИдуВШколу. И чтобы они принимали правильные значения (Истина или Ложь) в зависимости от возраста, указанного в переменной МойВозраст.
Сравните свой результат с тем, что показано на рис. 7.87.

Рис. 7.87. Доработанный пример {https://ai2b.pro/wp-content/uploads/1/07_087.png}
Запустите проект в режиме отладки и проверьте по шагам правильность работы примера для разных значений возраста. Изменяйте возраст прямо в процессе отладки.
Очень часто в инструкции Если анализируется не одно, а несколько условий. Например, в одно прекрасное утро вы проснулись и вспомнили, что вам нужно идти учиться. Но вы не помните, куда именно: в детский сад, в школу или в институт.
Зато вам известны правила. До 7 лет нужно идти в детский сад. После детского сада нужно идти в школу. Учиться в школе заканчивают в 18 лет. А в 19 лет поступают в институт.
Чтобы записать этот алгоритм на встроенном языке, вам понадобится еще одно ключевое слово – ИначеЕсли (рис. 7.88).

Рис. 7.88. Ключевое слово «ИначеЕсли» {https://ai2b.pro/wp-content/uploads/1/07_088.png}
В вашем примере его нужно будет написать вместо ключевого слова Иначе. А затем написать условие, при котором вам нужно идти в школу.
А в конце примера вы снова добавите слово Иначе и укажете, что во всех остальных случаях вы идете в институт. Попробуйте сделать пример самостоятельно.
Чтобы проверить свой результат, сравните его с рисунком 7.89.

Рис. 7.89. Пример «Я иду в институт» {https://ai2b.pro/wp-content/uploads/1/07_089.png}
В режиме отладки пройдите по разным веткам инструкции Если и посмотрите, как она работает.
Вы увидите, что выражения, которые указаны в инструкции Если, вычисляются и анализируются по очереди. В том порядке, в котором они написаны. Как только попадается истинное выражение, выполняется соответствующая ветка инструкции Если. После этого исполнение переходит на КонецЕсли. То есть инструкции, расположенные в тех ветках, где выражение было ложно, или в тех ветках, до которых проверка выражений не дошла, просто не выполняются.
В этом заключается особенность инструкции Если, о которой нужно помнить и которую нужно учитывать. Если вы откроете локальные переменные, то увидите, что после выполнения примера переменная ЯИдуВИнститут может оказаться не определена. Например, если ваш возраст равен 15 (рис. 7.90).

Рис. 7.90. Переменная «ЯИдуВИнститут» не определена {https://ai2b.pro/wp-content/uploads/1/07_090.png}
А если возраст равен 20, то не определены окажутся переменные ЯИдуВДетскийСад и ЯИдуВШколу (рис. 7.91).

Рис. 7.91. Не определены переменные «ЯИдуВДетскийСад» и «ЯИдуВШколу» {https://ai2b.pro/wp-content/uploads/1/07_091.png}
А ведь в «живой» программе вы наверняка будете создавать подобные переменные не просто так, а для того чтобы использовать их в дальнейшем. И если какой-то из этих переменных не окажется, ваша программа работать не сможет.
Какой выход из этой ситуации? Дотошно в каждой ветке инструкции Если прописывать создание всех переменных, которые вам могут понадобиться? Нет.
Есть гораздо более простое и удобное решение. Прямо перед инструкцией Если вы создаете все переменные, которые вам понадобятся. И присваиваете им некоторое стандартное значение – значение «по умолчанию». Например, Ложь.
А дальше, в ветках инструкции Если, вы меняете значения только тех переменных, которым это действительно нужно. Посмотрите пример на рисунке 7.92.

Рис. 7.92. Другой вариант примера {https://ai2b.pro/wp-content/uploads/1/07_092.png}
Сделайте этот пример в своем проекте и посмотрите, как он работает.
При любых значениях возраста будут существовать все переменные. И они будут иметь правильные значения (рис. 7.93).

Рис. 7.93. Все переменные определены {https://ai2b.pro/wp-content/uploads/1/07_093.png}

#### Красивая программа
Вы, наверное, уже привыкли к тому, что 1C:EDT сама раскрашивает слова в вашей программе. И это удобно. Еще, может быть, вы обратили внимание, что 1C:EDT сама делает отступ, когда вы пишете инструкцию Если.
Если вы этого не заметили, то поставьте маленький эксперимент. В модуле напишите Если а = 2 Тогда. И нажмите клавишу Enter (рис. 7.94).

Рис. 7.94. Синтаксический отступ {https://ai2b.pro/wp-content/uploads/1/07_094.png}
Вы увидите, что на новой строке курсор встанет не под буквой Е, а с некоторым сдвигом вправо. Этот сдвиг называется синтаксический отступ. Он помогает вам лучше и легче читать текст программы. Потому что «подчиненные» инструкции, расположенные внутри одной ветки, оказываются выделены визуально (рис. 7.95).

Рис. 7.95. Есть синтаксический отступ {https://ai2b.pro/wp-content/uploads/1/07_095.png}
Посмотрите, какая «каша» получилась бы, если бы синтаксического отступа не было (рис. 7.96).

Рис. 7.96. Нет синтаксического отступа {https://ai2b.pro/wp-content/uploads/1/07_096.png}
Прочитать такую «кашу» и разобраться в ней очень сложно.
Поэтому синтаксический отступ – это важная обязательная часть программы. Именно поэтому 1C:EDT делает его автоматически, когда вы набираете текст инструкции последовательно.
Но далеко не всегда вы работаете именно так. Даже при выполнении ваших простых примеров вы видите, что приходится изменять то, что уже написано. Вставлять новые строки. Копировать из одного места в другое. В этих случаях 1C:EDT не может автоматически сделать синтаксический отступ. В результате у вас вполне может получиться такой текст (рис. 7.97).

Рис. 7.97. Текст с нарушенным форматированием {https://ai2b.pro/wp-content/uploads/1/07_097.png}
Как с ним быть? Двигать каждую строку вручную, чтобы было «красиво»? Это скучно, долго и неинтересно.
Поэтому в 1C:EDT есть команда, которая может сделать это автоматически. Нажмите в контекстном меню редактора Источник – Формат. Текст сразу станет красивым и отформатированным.
Помимо синтаксического отступа есть и другие способы сделать текст более понятным. Например, один из хороших способов – это добавление пустых строк в текст программы. Они позволяют разделить текст на несколько отдельных смысловых блоков.
Если взять пример с инструкцией Если, то такие смысловые блоки напрашиваются сами собой. Каждая ветка этой инструкции является отдельным смысловым блоком. Поэтому, если перед началом ветки вы добавите пустую строку, это только улучшит читаемость вашей программы (рис. 7.98).

Рис. 7.98. Использование пустых строк {https://ai2b.pro/wp-content/uploads/1/07_098.png}
Другой хороший и очень часто используемый прием – создание комментариев. Комментарий – это пояснение к программе, которое находится прямо в тексте программы (рис. 7.99).

Рис. 7.99. Комментарий {https://ai2b.pro/wp-content/uploads/1/07_099.png}
Комментарии всегда начинаются с пары косых черт – //. 1C:EDT выделяет комментарии зеленым цветом.
Комментарии, конечно, могут быть разными. Сформулировать правило: «Комментарии должны быть вот такими...» – невозможно. Ситуации бывают разные.
Но в большинстве случаев нужно стремиться к тому, чтобы описать не ЧТО делается, а чтобы пояснить, ЗАЧЕМ это делается.
Главная сложность тут заключается в том, что в тот момент, когда вы пишете программу, вы прекрасно понимаете, зачем вы делаете то или это. И вам кажется, что писать по этому поводу комментарии совершенно не нужно. Ведь и так все понятно!
Но проходит неделя, месяц, год… Вы открываете свою старую программу и вдруг с удивлением обнаруживаете, что в ней вообще ничего не понятно. Иногда даже бывает такое ощущение, что все это писали не вы, а кто-то другой.
Поэтому всегда нужно самого себя немного «заставлять» писать комментарии. В этот момент можно представить, что вы пишете программу не «для себя», а для другого программиста, которому нужно будет разобраться с ней без вашей помощи.
Если вы себе это представите, то сразу поймете, например, что такой комментарий будет бесполезен (рис. 7.100).

Рис. 7.100. Бесполезный комментарий {https://ai2b.pro/wp-content/uploads/1/07_100.png}
А если вы напишете комментарий так (рис. 7.101), то он, наоборот, очень поможет и вам, и другим.

Рис. 7.101. Полезный комментарий {https://ai2b.pro/wp-content/uploads/1/07_101.png}
Умение писать нужные и полезные комментарии можно приобрести только с опытом. Поэтому пробуйте, пишите, не ленитесь.
Чтобы комментарии выглядели понятно и красиво, придерживайтесь нескольких простых правил.
Большие комментарии и комментарии к блоку инструкций пишите с начала строки. Начинайте их с большой буквы. Между // и комментарием оставляйте пробел. Предложение завершайте точкой. Перед комментарием вставляйте пустую строку.
Например, так (рис. 7.102).

Рис. 7.102. Однострочный комментарий {https://ai2b.pro/wp-content/uploads/1/07_102.png}
Или так (рис. 7.103).

Рис. 7.103. Многострочный комментарий {https://ai2b.pro/wp-content/uploads/1/07_103.png}
Комментарии к отдельным строкам программы пишите в этих же строках. С маленькой буквы и без точки в конце (рис. 7.104).

Рис. 7.104. Небольшие комментарии в строках {https://ai2b.pro/wp-content/uploads/1/07_104.png}

#### Инструкция «Цикл»
Представьте себе такую задачу. Вам нужно напечатать список. В этом списке должно быть указано, сколько рабочих часов у вас в понедельник, во вторник и так далее:
в 1-й день – 8 рабочих часов;
во 2-й день – 8 рабочих часов;
…
в 6-й день – 0 рабочих часов;
в 7-й день – 0 рабочих часов.
Чтобы это сделать, у вас есть две переменные. Одна – ДеньНедели. В ней вы можете хранить порядковый номер дня недели. Другая – РабочихЧасов. В ней вы можете хранить количество часов.
Печатать вы пока не умеете. Поэтому упростим задачу. Вместо того чтобы напечатать, вам будет достаточно выполнить такую инструкцию (листинг 7.11):
Листинг 7.11. Пример инструкции
Сказать = "В " + Строка(ДеньНедели) + "-й день " + Строка(РабочихЧасов) + " рабочих часов.";
То есть в переменную Сказать вы просто поместите ту строку, которую надо было бы напечатать.
Эта строка «склеивается» из нескольких частей, из нескольких строк. В ней используются переменные ДеньНедели и РабочихЧасов. Но поскольку эти переменные содержат числа, то в «голом» виде их в этой инструкции использовать нехорошо. Сначала нужно сделать из них строки. Для этого и используется два раза функция встроенного языка Строка(). То значение, которое указано у нее в скобках, она преобразует к значению типа Строка.
Итак, у вас есть две переменные и есть инструкция. Нужно с их помощью «напечатать» список.
Если бы вы знали только инструкцию присваивания, вы бы стали делать эту задачу так (рис. 7.105).

Рис. 7.105. Последовательный способ решения задачи {https://ai2b.pro/wp-content/uploads/1/07_105.png}
Не поленитесь, сделайте в своем проекте этот пример. Чтобы два раза не писать одно и то же, напишите только для первого дня. А затем скопируйте эти строки. В скопированных строках измените день недели.
В режиме отладки пройдите по шагам и посмотрите, какие строки получаются в переменной Сказать (рис. 7.106).

Рис. 7.106. Результат {https://ai2b.pro/wp-content/uploads/1/07_106.png}
Почему вы не стали доделывать этот пример до конца? Потому что каждый день делается одно и то же. Зная порядковый номер дня недели, вы выясняете, сколько занятий в этот день. А для этого очень хорошо подходит инструкция Если (рис. 7.107).

Рис. 7.107. Пример использования инструкции «Если» {https://ai2b.pro/wp-content/uploads/1/07_107.png}
Рабочий график у вас таков, что в будние дни у вас 8 рабочих часов, а в выходные – 0 рабочих часов. Напишите это с помощью инструкции Если.
У вас получится такой пример (рис. 7.108).

Рис. 7.108. Инструкция «Если» {https://ai2b.pro/wp-content/uploads/1/07_108.png}
Если теперь после инструкции Если добавить вашу «печать», то получится именно то, что нужно сделать для каждого дня (рис. 7.109). Вы узнаете количество рабочих часов и «печатаете».

Рис. 7.109. Инструкция «Если» и «печать» {https://ai2b.pro/wp-content/uploads/1/07_109.png}
Весь вопрос теперь в том, как выполнить эти строки программы для каждого дня недели. А для этого как раз и нужна инструкция Цикл. Она «снаружи» обрамляет тот фрагмент, который нужно выполнить несколько раз, и выглядит следующим образом (рис. 7.110). Сделайте такой же пример в своем проекте.

Рис. 7.110. Инструкция «Цикл» {https://ai2b.pro/wp-content/uploads/1/07_110.png}
Работает она следующим образом. Когда исполнение программы доходит до цикла, переменной цикла присваивается начальное значение. В вашем случае переменная цикла – ДеньНедели, а начальное значение для нее 1.
Затем начинают выполняться те инструкции, которые расположены внутри цикла.
Когда исполнение доходит до строки КонецЦикла, переменная цикла автоматически увеличивается на единицу и все возвращается в начало цикла.
Если переменная цикла не превысила свое конечное значение (в вашем случае 7), инструкции внутри цикла выполняются еще раз. Если переменная цикла превысила свое конечное значение, исполнение переходит дальше, к тем строкам, которые расположены после инструкции КонецЦикла.
Запустите пример в режиме отладки и, двигаясь по шагам, посмотрите, как это работает. День недели будет последовательно изменяться от 1 до 7. И в переменной Сказать у вас будут получаться строки с количеством рабочих часов в каждый из дней.
Это не единственная форма инструкции Цикл. Есть еще две другие формы этой инструкции. С ними вы познакомитесь позже.

#### Функции
Продолжим исследовать и улучшать ваш пример с количеством рабочих часов в каждый из дней. Посмотрите на ту его часть, которая, зная день недели, узнает вам количество часов (рис. 7.111).

Рис. 7.111. Часть примера, которая определяет день недели {https://ai2b.pro/wp-content/uploads/1/07_111.png}
В вашем примере она выглядит довольно просто, но в реальной программе это может быть большой и сложный алгоритм. Он по сложным правилам, в зависимости от многих условий решает, сколько будет рабочих часов.
Представьте себе, что этот алгоритм вам нужно использовать не только здесь, где он написан, но и в каком-то другом месте вашего проекта. Только там, например, вам нужно просто вычислить, сколько рабочих часов будет в какой-то один определенный день, который вы заранее не знаете.
Что делать? В том, другом, месте заново еще раз писать весь этот алгоритм? Это нехорошо.
А если таких мест не одно, а несколько? А если вы потом захотите изменить этот алгоритм? Придется изменять его во всех местах, где он написан? Тогда легко допустить ошибку и что-то пропустить.
Но выход есть! Нужно просто оформить этот алгоритм в виде функции. Тогда он будет написан у вас в одном-единственном месте, а использовать его вы сможете в разных местах своего проекта.
Функция – это не инструкция. Это просто специальная форма записи нескольких инструкций вместе.
Чтобы не было скучно, воспользуйтесь контекстной подсказкой. Установите курсор парой строк ниже строки КонецПроцедуры. Напишите «фун» и вызовите контекстную подсказку.
Первый же шаблон, который предложит вам подсказка, это и будет шаблон функции (рис. 7.112).

Рис. 7.112. Шаблон функции {https://ai2b.pro/wp-content/uploads/1/07_112.png}
Выберите этот шаблон, и 1C:EDT вставит в ваш модуль заготовку функции (рис. 7.113).

Рис. 7.113. Заготовка функции {https://ai2b.pro/wp-content/uploads/1/07_113.png}
Теперь перетащите внутрь функции всю инструкцию Если, которая выделена на рис. 7.111. Используйте форматирование, чтобы 1C:EDT сама расставила синтаксические отступы. У вас получится такая конструкция (рис. 7.114).

Рис. 7.114. Тело функции {https://ai2b.pro/wp-content/uploads/1/07_114.png}
То, что находится между строкой Функция … () и строкой КонецФункции, называется телом функции. Это те инструкции, которые будут выполнены при вызове функции.
Первая строка – Функция … () – это объявление функции. Им вы сейчас и займетесь. Потому что пока у вас есть только заготовка.
Объявление функции всегда начинается с ключевого слова Функция. За ним, через пробел, нужно указать имя этой функции. Имя вы придумываете сами. Оно нужно для того, чтобы вызвать эту функцию из другого места. Назовите функцию СколькоРабочихЧасов (рис. 7.115).

Рис. 7.115. Имя функции – «СколькоРабочихЧасов» {https://ai2b.pro/wp-content/uploads/1/07_115.png}
После имени, без пробела, всегда следуют круглые скобки – (). В них может быть что-то написано, а может и не быть. Это зависит от того, нужны вашей функции специальные, особенные данные для работы или нет.
В вашем случае функция должна сказать, сколько рабочих часов в тот день недели, который вас интересует. Поэтому такие специальные данные ей нужны. Ей нужно сказать, какой именно день недели вас интересует.
Посмотрите на тело функции. Функция ожидает, что этот день недели будет находиться в переменной ДеньНедели. То есть значение, которое будет в этой переменной, функция должна получить откуда-то «снаружи».
Чтобы 1C:EDT это поняла, напишите имя переменной ДеньНедели внутри круглых скобок вместо слова «Параметры» (рис. 7.116).

Рис. 7.116. Параметр функции {https://ai2b.pro/wp-content/uploads/1/07_116.png}
Теперь 1C:EDT знает, что значение для переменной ДеньНедели будет получено в тот момент, когда вы вызовете эту функцию. Если это сейчас непонятно, не расстраивайтесь. Чуть позже вы увидите, как это происходит.
Такие переменные, написанные в объявлении в скобках после имени функции, называются формальными параметрами функции.
В данном случае слово «формальный» нужно понимать в значении «ожидаемый», «планируемый». Например, формально вы должны просыпаться в 7 часов утра, чтобы успеть на работу. Но фактически вы можете проспать или, наоборот, проснуться раньше. Формально спектакль должен начаться в 7 часов вечера. Но фактически он может начаться позже, потому что не все зрители успели зайти в зал.
То есть формальные параметры – это то, что функция ожидает получить в тот момент, когда вы ее вызовете.
У вашей функции всего один формальный параметр. Другую переменную, РабочихЧасов, она создаст сама в процессе работы. Поэтому объявление функции готово.
После объявления функции принято вставлять пустую строку. Так текст программы читается лучше. Не забудьте вставить ее и вы.
Теперь переместитесь в конец функции. В вашем случае функция должна вернуть количество рабочих часов. Для того чтобы указать, какое значение возвращает функция, используется ключевое слово Возврат.
Количество рабочих часов у вас получится в переменной РабочихЧасов. Поэтому напишите Возврат и через пробел укажите имя этой переменной (рис. 7.117).

Рис. 7.117. Возвращаемое значение {https://ai2b.pro/wp-content/uploads/1/07_117.png}
Последняя строка – это КонецФункции. Перед ней тоже принято вставлять пустую строку, чтобы программа читалась лучше.
Обратите внимание, что после слова КонецФункции нет точки с запятой. Это еще раз говорит о том, что функция не является инструкцией, которая будет выполняться. Функция – это просто специальная форма записи нескольких инструкций вместе.
В стандартных настройках 1C:EDT указано, что нужно группировать процедуры и функции. Поэтому она автоматически дорисовала слева от вашей функции значок «-» (рис. 7.118).

Рис. 7.118. Группировка и сворачивание функций {https://ai2b.pro/wp-content/uploads/1/07_118.png}
Если вы нажмете мышью на «-», текст процедуры свернется, останется только ее объявление. А «-» изменится на «+» (рис. 7.119).

Рис. 7.119. Свернутая функция {https://ai2b.pro/wp-content/uploads/1/07_119.png}
Это удобно в тех случаях, когда в одном модуле находится много функций. Тогда их можно быстро просмотреть и открыть ту, которая нужна.
Другой удобный способ навигации по модулям заключается в использовании панели Схема. Эта панель находится в перспективе 1C:Enterprise. (рис. 7.120).
 
Рис. 7.120. Панель «Схема» {https://ai2b.pro/wp-content/uploads/1/07_120.png}
Как видите, в этой панели есть все процедуры и функции, которые присутствуют в модуле. Если вы нажмете на любую из них в панели, редактор переместится на объявление этой процедуры.
Если вы раскроете ветку События, то увидите в этой панели все события, которые могут быть обработаны в этом модуле. Одно из этих событий – ПриНачалеРаботыСистемы() – вы уже обрабатываете, поэтому оно выделено голубым цветом.
Итак, теперь ваша функция полностью готова. Если хотите, можете раскрыть ее обратно. Если не хотите, можете не раскрывать.
Теперь вам нужно вызвать эту функцию в том месте, в котором нужно. А в котором нужно? Наверное, вы уже догадались. В том самом месте, откуда вы «утащили» инструкцию Если.
Чтобы вызвать функцию, нужно написать ее имя, а в скобках – выражение или переменную. Значение этого выражения или переменной будет передано в функцию.
А поскольку функция вернет вам количество рабочих часов, то вызов функции нужно написать в инструкции присваивания. И присвоить это значение той переменной, которая вам нужна. То есть переменной РабочихЧасов (рис. 7.121).

Рис. 7.121. Вызов функции {https://ai2b.pro/wp-content/uploads/1/07_121.png}
Как будет работать эта инструкция? Сначала, как вы знаете, платформа вычислит выражение, которое находится справа от знака равенства. То есть она вызовет функцию СколькоРабочихЧасов(). В эту функцию она передаст значение переменной ДеньНедели.
В этом месте – там, где функция вызывается, – переменные, указанные в скобках, называются фактическими параметрами. То есть это то, что на самом деле будет передано в функцию.
Результатом вычисления выражения справа от знака равенства будет значение, которое вернет ваша функция. И это значение будет присвоено переменной РабочихЧасов. После чего вы используете эту переменную, чтобы сформировать «печатаемую» строку.
Чтобы убедиться, что вы не допустили ошибки, посмотрите на рисунок 7.122. Ваш модуль должен выглядеть так. Заодно еще раз обратите внимание на то, что называется фактическим параметром, а что – формальным.

Рис. 7.122. Модуль с процедурой {https://ai2b.pro/wp-content/uploads/1/07_122.png}
Теперь самое интересное! Установите точку останова в начале цикла и запустите проект в режиме отладки. Посмотрите, как это работает.
Сделайте один шаг. 1C:EDT остановится на инструкции присваивания. Она приготовится ее исполнять (рис. 7.123).

Рис. 7.123. Перед вызовом функции {https://ai2b.pro/wp-content/uploads/1/07_123.png}
Это первый «проход» цикла, поэтому день недели равен 1.
Шагните еще раз. 1C:EDT «провалится» в функцию (рис. 7.124).

Рис. 7.124. Исполнение «провалилось» в функцию {https://ai2b.pro/wp-content/uploads/1/07_124.png}
Обратите внимание, что платформа передала сюда значение дня недели 1. И теперь есть все необходимые данные для того, чтобы выполнить инструкцию Если.
Сделайте еще три шага. 1C:EDT остановится перед выполнением инструкции Возврат (рис. 7.125).

Рис. 7.125. Инструкция «Возврат» {https://ai2b.pro/wp-content/uploads/1/07_125.png}
Вы можете посмотреть, какое значение функция собирается возвращать. Это значение 8.
Сделав еще шаг, вы перейдете на строку КонецФункции. Это значит, что исполнение функции закончилось.
А шагнув еще раз, вы вернетесь обратно к инструкции присваивания (рис. 7.126).

Рис. 7.126. Возврат в место вызова функции {https://ai2b.pro/wp-content/uploads/1/07_126.png}
Сейчас у вас картинка очень похожа на то, что было на рис. 7.122, когда платформа приготовилась выполнить инструкцию присваивания. Но если раньше платформа собиралась вычислить выражение, находящееся справа, то теперь она его уже вычислила. И сейчас она готова поместить получившееся значение в переменную.
Сделайте один шаг. Исполнение перейдет к следующей строке. А в переменной РабочихЧасов появится значение 8. Это то значение, которое вернула функция (рис. 7.127).

Рис. 7.127. Инструкция присваивания выполнена {https://ai2b.pro/wp-content/uploads/1/07_127.png}
И если вы шагнете еще раз, то сформируется строка, предназначенная «для печати» (рис. 7.128).

Рис. 7.128. Сформирован текст «для печати» {https://ai2b.pro/wp-content/uploads/1/07_128.png}
После этого исполнение цикла продолжится, но день недели будет равен 2. И так далее. Можете пройти несколько итераций цикла и посмотреть еще раз, как работает этот пример.
Итак, чтобы закрепить свои знания, посмотрите на рис. 7.129. На нем стрелками показана последовательность исполнения встроенного языка при вызове функции.

Рис. 7.129. Последовательность исполнения при вызове функции {https://ai2b.pro/wp-content/uploads/1/07_129.png}
В тот момент, когда платформа встречает вызов функции, исполнение «проваливается» в функцию (2). После того как функция выполнит инструкции, написанные в ее теле, исполнение возвращается в ту точку, из которой была вызвана функция. И только после этого исполнение встроенного языка переходит к следующей инструкции (3).

#### Контекст и область видимости
Вы, наверное, обратили внимание на то, что в вашем примере имена фактического и формального параметров совпали – ДеньНедели (рис. 7.130).

Рис. 7.130. Имена фактического и формального параметров {https://ai2b.pro/wp-content/uploads/1/07_130.png}
У вас это получилось случайно. Просто потому, что вы перетаскивали фрагмент программы из одного места в другое.
На самом деле имена формальных и фактических параметров не совпадают. В этом нет необходимости.
Чтобы разобраться с этим, упростите пример. В процедуре создайте переменную и напишите вызов функции. А функцию тоже упростите, чтобы она возвращала только два значения: 8 или 0. И обратите внимание, что в этом примере имена переменных специально изменены так, чтобы они были разными внутри функции и снаружи нее (рис. 7.131).

Рис. 7.131. Упрощенный пример {https://ai2b.pro/wp-content/uploads/1/07_131.png}
Установите точку останова на инструкции вызова функции, запустите проект в режиме отладки и откройте панель Переменные. Они вам сейчас очень помогут разобраться с тем, что будет происходить (рис. 7.132).

Рис. 7.132. Локальный контекст процедуры {https://ai2b.pro/wp-content/uploads/1/07_132.png}
Сейчас вы находитесь в процедуре ПриНачалеРаботыСистемы(). Вы пока еще не знакомились с тем, что такое процедуры. Но это не страшно. Для этого примера будет достаточно представить, что процедура – это то же самое, что и функция.
Вы находитесь внутри процедуры. И здесь вам доступны переменные НомерДняНедели и РабочихЧасов. Они показаны в окне локальных переменных. Это те переменные, которые создаются и определяются в этой процедуре.
Теперь сделайте шаг, чтобы перейти в функцию (рис. 7.133).

Рис. 7.133. Локальный контекст функции {https://ai2b.pro/wp-content/uploads/1/07_133.png}
Обратите внимание на то, что вы видите в окне локальных переменных. НомерДняНедели и РабочихЧасов исчезли. Зато вместо них появились ДеньНедели и КоличествоРабочихЧасов, которые определены внутри этой функции.
Теперь, если вы пройдете всю функцию и вернетесь обратно в процедуру, состав локальных переменных снова изменится (рис. 7.134).

Рис. 7.134. Локальный контекст процедуры {https://ai2b.pro/wp-content/uploads/1/07_134.png}
Он станет таким, каким он был в самом начале.
Для обозначения этой ситуации во встроенном языке используют слово контекст. Контекст – это то, что доступно вам в том месте программы, в котором вы находитесь в данный момент.
Если переменная определена в какой-то функции, то она доступна только в ней. И недоступна в других функциях. Поэтому в разных функциях вы можете создавать переменные с разными именами или с одинаковыми именами. В любом случае это будут разные переменные.
Это правило относится и к параметрам функций. Переменные, которые указаны в качестве фактического и формального параметров, могут иметь одинаковые имена. Или разные имена. Это неважно. Потому что каждая из этих переменных существует только в контексте «своей» процедуры или функции.
ПРИМЕЧАНИЕ
На самом деле понятие контекста во встроенном языке гораздо шире. В этом примере речь идет о локальном контексте. Локальный контекст –только одна из частей, входящих в понятие «контекст». Об этом вы узнаете позже.
Теперь познакомьтесь с другим термином, который часто используется при написании программ. Это область видимости.
Вы уже знаете, что область видимости переменных ограничивается той функцией или процедурой, внутри которой они созданы.
Если быть совсем точными, область видимости переменной начинается с инструкции присваивания, в которой она создается, и заканчивается концом функции или процедуры (рис. 7.135).

Рис. 7.135. Область видимости переменной «НомерДняНедели» {https://ai2b.pro/wp-content/uploads/1/07_135.png}
Ради развлечения попробуйте использовать переменную НомерДняНедели в самом начале процедуры. Например, так, как на рисунке 7.136.

Рис. 7.136. Попытка использовать процедуру до ее объявления {https://ai2b.pro/wp-content/uploads/1/07_136.png}
Вы сразу же получите сообщение об ошибке. Действительно, в третьей строке переменная НомерДняНедели еще не определена. И 1C:EDT о ней ничего не знает. Эта переменная появится только двумя строками ниже.
ПРИМЕЧАНИЕ
Область видимости переменных может быть и шире. Но эти возможности находятся за рамками данной книги, поэтому они рассматриваться не будут.
У процедур и функций тоже есть своя область видимости. Это весь модуль, в котором они определены. Именно поэтому и существует возможность вызвать функцию или процедуру из любого места модуля. Например, как в вашем примере, из другой процедуры.
ПРИМЕЧАНИЕ
Область видимости процедур и функций может быть и шире. С этим вы познакомитесь в следующих разделах книги.

#### Процедуры
Теперь, когда вы умеете создавать и использовать функции, можно заняться изучением процедур.
Процедуры очень похожи на функции. Есть только одно отличие. Процедура ничего не возвращает. Она просто выполняет инструкции, которые находятся в ее теле.
Во всем остальном процедуры выглядят точно так же, как функции, которые вам уже хорошо известны. Вместо слова Функция используется Процедура, а вместо КонецФункции используется КонецПроцедуры (рис. 7.137).

Рис. 7.137. Пример процедуры {https://ai2b.pro/wp-content/uploads/1/07_137.png}
В этом примере у процедуры нет параметров, но если нужно, вы можете их указать так же, как и в функции.
Напишите в своем проекте этот пример. Процедура в этом примере проверяет, какой сейчас день недели. Если номер дня недели меньше 6 (суббота), она выводит на экран оповещение о том, что сегодня рабочий день.
Запустите этот пример и посмотрите, как выглядит это оповещение. Но не забывайте, что оно появится только в будний день. Если вы читаете книгу в выходные – измените условие Если.
Оповещение появится в небольшом окне в правой нижней части экрана, а затем постепенно пропадет (рис. 7.138).

Рис. 7.138. Оповещение пользователя {https://ai2b.pro/wp-content/uploads/1/07_138.png}
Для вывода такого оповещения вы использовали встроенную процедуру ПоказатьОповещениеПользователя(). Вы о ней ничего не знаете, просто написали так, как было на рисунке. Но наверняка вы хотите узнать, для чего нужна эта процедура и как ею пользоваться.
В этом вам помогут синтаксическая подсказка или панель Синтакс-помощник. Пользоваться ими очень просто.
Когда в тексте программы вам попадается незнакомая процедура или функция встроенного языка, вы можете просто подвести к ней курсор. Откроется синтаксическая подсказка (рис. 7.139).

Рис. 7.139. Синтаксическая подсказка {https://ai2b.pro/wp-content/uploads/1/07_139.png}
Если вы переместите курсор внутрь этого окна, вы сможете прокручивать текст, а в нижней части появятся кнопки управления, в том числе кнопка открытия панели Синтакс-помощник (рис. 7.140).

Рис. 7.140. Кнопка открытия панели «Синтакс-помощник» {https://ai2b.pro/wp-content/uploads/1/07_140.png}
Панель Синтакс-помощник показывает ту же информацию, но она всегда открыта и связана с редактором встроенного языка. Это может быть полезно вам как начинающим программистам (рис. 7.141).

Рис. 7.141. Панель «Синтакс-помощник» {https://ai2b.pro/wp-content/uploads/1/07_141.png}
Например, если установить курсор на функцию ДеньНедели(), в панели автоматически появится подсказка по этой функции (рис. 7.142).

Рис. 7.142. Подсказка по текущей функции {https://ai2b.pro/wp-content/uploads/1/07_142.png}
Если вы захотите узнать, какие еще есть процедуры и функции, похожие на ПоказатьОповещениеПользователя(), откройте синтакс-помощник в разделе Глобальный контекст > Процедуры и функции интерактивной работы (рис. 7.143).

Рис. 7.143. Синтакс-помощник {https://ai2b.pro/wp-content/uploads/1/07_143.png}

#### Чтение и отладка процедур и функций
Процедуры и функции могут быть расположены в самых разных частях конфигурации. Совсем не обязательно, что объявление функции будет находиться где-то рядом с тем местом, откуда она вызывается. Это так только в вашем примере.
Чаще всего вызов функции и ее объявление находятся далеко друг от друга. Может быть, даже в разных модулях конфигурации. Как в этом случае быстро найти объявление функции, чтобы посмотреть, какие действия она выполняет?
Для этого есть очень удобный способ. Нужно зажать клавишу Ctrl и подвести курсор к имени процедуры или функции (в том месте, где она вызывается). Имя процедуры превратится в гиперссылку (рис. 7.144).

Рис. 7.144. Перейти к объявлению процедуры {https://ai2b.pro/wp-content/uploads/1/07_144.png}
Нажмите на гиперссылку – и 1C:EDT перейдет к объявлению этой функции и выделит его в тексте (рис. 7.145).

Рис. 7.145. Переход к объявлению процедуры {https://ai2b.pro/wp-content/uploads/1/07_145.png}
Чтобы вернуться назад, в командной панели основного окна нажмите кнопку Назад. Курсор вернется на ту строку, где находится вызов функции (рис. 7.146).

Рис. 7.146. Возврат к вызову процедуры {https://ai2b.pro/wp-content/uploads/1/07_146.png}
После этого станет активна соседняя кнопка Вперед. С ее помощью, если нужно, вы сможете опять перейти к объявлению процедуры.
Еще несколько интересных приемов связаны с отладкой процедур и функций. Вы прекрасно умеете выполнять отладку по шагам и используете для этого клавишу F5. Она позволяет вам останавливаться на каждой инструкции, которая исполняется.
Но это не всегда удобно. Бывают случаи, когда хочется выйти из функции раньше, чем закончатся все инструкции, которые в ней выполняются. Бывают случаи, когда не нужно заходить внутрь процедуры, а нужно, чтобы она просто выполнилась, без остановки на каждой инструкции.
Для этого есть еще две команды пошаговой отладки. Чтобы познакомиться с ними, немного модифицируйте пример. Допишите две инструкции присваивания – до и после вызова процедуры. Например, как на рисунке 7.147.

Рис. 7.147. Доработанный пример {https://ai2b.pro/wp-content/uploads/1/07_147.png}
Установите точку останова на первой инструкции присваивания. Запустите проект в режиме отладки и по одному шагу дойдите до строки Если …
Теперь представьте: вы отлаживаете программу, чтобы найти ошибку. Вы посмотрели на текст функции и поняли, что ошибка не в ней, а где-то дальше. Поэтому нет смысла проходить всю функцию по шагам. Нужно вернуться к тому месту, откуда функция вызывалась.
В этом вам поможет команда Шаг возврата (рис. 7.148).

Рис. 7.148. Команда «Шаг возврата» {https://ai2b.pro/wp-content/uploads/1/07_148.png}
В результате выполнения этой команды инструкции, содержащиеся в процедуре, будут исполнены без остановки. А остановка произойдет тогда, когда исполнение вернется к той строке, в которой процедура была вызвана (рис. 7.149). Попробуйте.

Рис. 7.149. Переход к вызову процедуры {https://ai2b.pro/wp-content/uploads/1/07_149.png}
Теперь рассмотрим второй случай. Завершите отладку и запустите ее заново.
Например, вы отлаживаете свою программу и заранее точно знаете, что внутри процедуры ПредупредитьОПонедельнике() все работает правильно и нет никакой необходимости заходить внутрь нее.
Тогда вы можете использовать команду Шаг через (рис. 7.150).

Рис. 7.150. Команда «Шаг через» {https://ai2b.pro/wp-content/uploads/1/07_150.png}
Она позволит вам не заходить внутрь процедуры, а переходить от строки к строке (рис. 7. 151). Попробуйте.

Рис. 7.151. Переход через вызов процедуры {https://ai2b.pro/wp-content/uploads/1/07_151.png}
ПРИМЕЧАНИЕ
Подробнее про пошаговое выполнение вы можете прочитать в документации «1С:Предприятие 8. Руководство разработчика. Раздел 32.2.4. "Пошаговое выполнение"».

### Объекты встроенного языка
До сих пор вы имели дело со значениями типа Число, Строка, Дата, Булево. Такие значения являются простыми и неделимыми. В них нельзя выделить отдельные составляющие.
Однако во встроенном языке есть более сложные типы – коллекции значений. В коллекцию могут входить значения разных типов. Но чаще всего в коллекцию входят значения одинакового типа.
В зависимости от того, каким образом значения объединяются в коллекции, существуют разные типы, которые являются коллекциями значений. И таких типов гораздо больше, чем два.
Значения таких типов сильно отличаются от значений примитивных типов (число, строка). И поэтому все они имеют собственное название. Такие значения называются объектами встроенного языка, или просто объектами.
Объект встроенного языка – это сложная конструкция. У нее есть характерные особенности, связанные именно с тем, что объект содержит в себе множество примитивных значений. С этими особенностями вы будете знакомиться постепенно, не сразу.
#### Методы, конструкторы
Первая особенность связана с тем, что объект «из чего-то состоит». А это значит, что вам могут понадобиться какие-то действия, чтобы изменить его состав.
Такие действия, которые можно выполнять над объектом, называются методами.
У каждого сложного типа есть собственный набор методов.
Вторая особенность объектов тоже связана с тем, что они «из чего-то состоят». И это «что-то» не может в один миг собраться вместе, как по мановению волшебной палочки.
Практически у всех объектов есть специальное действие, которое создает «заготовку» объекта. И это действие, в отличие от других методов, имеет собственное название – конструктор.
ПРИМЕЧАНИЕ
Конструкторы многих объектов позволяют не только создать «заготовку», но и заполнить объект какими-то значениями. С этим вы познакомитесь позднее. В этом разделе говорится про коллекции значений. А для них более типичны конструкторы, создающие пустые объекты, без данных.
Возможно, прямо сейчас вам сложно привыкнуть ко всем этим новым словам: объекты, методы, конструкторы, коллекции значений. Но не расстраивайтесь. Дальше вы познакомитесь с двумя универсальными коллекциями значений, выполните ряд упражнений, и все сразу прояснится.

#### Универсальные коллекции значений
Универсальные коллекции значений – это несколько типов, которые можно использовать для самых разных задач. Поэтому они и называются «универсальные».
Значения этих типов, объекты, существуют только в то время, пока выполняется ваша программа. Поэтому, когда ваша программа перестанет выполняться, все эти объекты универсальных коллекций исчезнут. То есть они существуют только в оперативной памяти компьютера и в вашем воображении.
Все эти типы, универсальные коллекции значений, описаны в синтакс-помощнике, и вы можете их посмотреть. Откройте синтакс-помощник, раскройте ветку Универсальные коллекции значений. Вот они (рис. 7.152).

Рис. 7.152. Универсальные коллекции значений {https://ai2b.pro/wp-content/uploads/1/07_152.png}
Вы познакомитесь только с двумя из них: Массив и Структура. Остальные коллекции устроены аналогичным образом. Поэтому, если вы разберетесь с массивами и структурами, остальное сможете освоить самостоятельно.

#### Массив
Начните с массива. Представьте, что вам нужно где-то хранить мячики. Каждый мячик – это одно значение. Тогда массив – это стеллаж, в котором на каждую полку можно положить только один мячик (рис. 7.153).

Рис. 7.153. Массив – мячики на стеллаже {https://ai2b.pro/wp-content/uploads/1/07_153.png}
Полки пронумерованы. Когда вы захотите взять один из мячиков, вы скажете, например: «Дайте мне мячик со второй полки».
Вот так устроен массив, все очень просто.
В синтакс-помощнике раскройте ветку Универсальные коллекции значений > Массив. Вот то, о чем говорилось раньше: Методы и Конструкторы (рис. 7.154).

Рис. 7.154. Методы и конструкторы массива {https://ai2b.pro/wp-content/uploads/1/07_154.png}
Зачем нужен тот или иной метод, вы наверняка поймете прямо сейчас и даже без объяснений. Не про все методы, но про многие. Например, Добавить() наверняка добавляет один мячик на свободную полку. А Удалить() – удаляет. Количество() – это наверняка для того, чтобы посчитать, сколько мячиков на полках. А Очистить() – освобождает все полки. Так что ничего сложного тут нет.
Конструкторов два. Но это не должно вас смущать. Один конструктор (По количеству элементов) создает пустой массив, пустой стеллаж. Им вы будете пользоваться. Чаще всего используется именно он.
А второй конструктор (На основании фиксированного массива) делает буквально следующее: «Сделайте мне такой же стеллаж с мячиками, как на этой картинке». Им вы пользоваться не будете, используется он нечасто.
Теперь приступим к делу. Создайте массив, в котором будут содержаться названия дней недели. Каждое название дня недели – это «мячик».
Значение типа Массив (объект встроенного языка) будет храниться у вас в переменной ДниНедели. Поэтому напишите следующую инструкцию (рис. 7.155).

Рис. 7.155. Конструктор массива {https://ai2b.pro/wp-content/uploads/1/07_155.png}
Конструкторы всех объектов выглядят одинаково. Они начинаются с обязательного слова Новый, а затем пишется имя типа. Вы хотите создать объект типа Массив, поэтому после Новый пишете Массив.
После имени типа в скобках могут указываться, а могут и не указываться дополнительные параметры. Что нужно указывать в случае с массивом, вы можете сами посмотреть в синтакс-помощнике (рис. 7.156), если нажмете на конструктор ПоКоличествуЭлементов.

Рис. 7.156. Синтаксическая подсказка для типа «Массив» {https://ai2b.pro/wp-content/uploads/1/07_155.png}
В простом случае вы можете сразу указать там количество элементов, которое будет содержаться в массиве. То есть сколько полок должно быть в стеллаже. Это одномерный массив.
Вы будете создавать одномерный массив, но количество заранее указывать не будете. То есть у вас будет массив с неограниченным количеством элементов.
Бывают и многомерные массивы. Их вы рассматривать не будете. Но если у вас хорошее воображение и вы хотите представить себе двухмерный массив 3х2, то это стеллаж из трех полок (первое измерение), на каждой полке которого стоит еще один стеллаж из двух полок (второе измерение).
Теперь заполните массив названиями дней недели. Это делается просто (рис. 7.157). Но пока ничего не пишите.

Рис. 7.157. Добавить значение в массив {https://ai2b.pro/wp-content/uploads/1/07_157.png}
В переменной ДниНедели у вас находится объект типа Массив. Чтобы заставить этот объект выполнить какое-то действие, нужно через точку написать имя метода. Напишите это с помощью контекстной подсказки.
##### Контекстная подсказка
Чтобы не ошибиться в имени переменной, напишите «дни» и вызовите контекстную подсказку (рис. 7.158).

Рис. 7.158. Контекстная подсказка для ввода имени переменной
{https://ai2b.pro/wp-content/uploads/1/07_158.png}
Первый же вариант, который предложит вам 1C:EDT, – это имя вашей переменной. Выберите его нажатием Enter (рис. 7.159).

Рис. 7.159. Правильное имя переменной {https://ai2b.pro/wp-content/uploads/1/07_159.png}
1C:EDT подставит правильное имя.
Теперь поставьте точку. Произойдет следующее: 1C:EDT уже знает, что в этой переменной находится не «что-то там», а объект совершенно конкретного типа. Типа Массив. Поэтому она сразу откроет контекстную подсказку и предложит вам все методы, которые есть у этого объекта (рис. 7.160).

Рис. 7.160. Контекстная подсказка методов объекта {https://ai2b.pro/wp-content/uploads/1/07_160.png}
ПРИМЕЧАНИЕ
Символом f(), от английского слова function, 1C:EDT обозначает те методы, которые возвращают какое-то значение. То есть методы, которые внутри платформы реализованы как функции. А символом p(), от английского слова procedure, – методы, которые ничего не возвращают. Такие методы реализованы как процедуры.
Методов много, поэтому, чтобы не искать нужный в большом списке, просто продолжите набирать имя нужного вам метода – «до». В списке останутся только подходящие методы (рис. 7.161).

Рис. 7.161. Подходящие методы {https://ai2b.pro/wp-content/uploads/1/07_161.png}
Теперь двойным кликом или нажатием Enter выберите метод Добавить(Значение). Второй вариант, Добавить(), вам не подходит – это шаблон метода без параметра.
1C:EDT вставит метод в модуль и предложит вам ввести его параметр (рис. 7.162).

Рис. 7.162. Метод «Добавить()» {https://ai2b.pro/wp-content/uploads/1/07_162.png}
Для ввода параметра 1C:EDT предлагает вам либо переменную ДниНедели, либо значение Неопределено. Ни то, ни другое вам не подходит. Вам нужно ввести собственное значение – название дня недели. Это строковый литерал, который должен быть заключен в кавычки. Введите открывающую кавычку – и 1C:EDT сразу же добавит закрывающую (рис. 7. 163)

Рис. 7.163. Кавычки для строкового литерала {https://ai2b.pro/wp-content/uploads/1/07_163.png}
Вам останется только ввести название дня недели (рис. 7.164).

Рис. 7.164. Название дня недели {https://ai2b.pro/wp-content/uploads/1/07_164.png}
Теперь вы можете нажать Tab и продолжить редактирование модуля (рис. 7.165).

Рис. 7.165. Оператор «Добавить()» {https://ai2b.pro/wp-content/uploads/1/07_165.png}
А теперь маленькая программистская хитрость. По условиям задачи вам нужно добавить в массив еще шесть элементов. То есть написать такие же инструкции, только с другими днями недели. Писать одно и то же скучно. Поэтому сейчас вы просто шесть раз скопируете эту строку, а потом только поменяете названия дней недели. Делается это так.
Тройным щелчком выделяете строку (рис. 7.166).

Рис. 7.166. Выделить строку {https://ai2b.pro/wp-content/uploads/1/07_166.png}
Нажимаете сочетание клавиш Ctrl + Insert, чтобы скопировать выделенное в буфер обмена. А теперь сразу же нажимаете шесть раз сочетание клавиш Shift + Insert, чтобы вставить содержимое буфера обмена. В результате у вас получается семь одинаковых строк (рис. 7.167).

Рис. 7.167. Вставить строку семь раз {https://ai2b.pro/wp-content/uploads/1/07_167.png}
Теперь в третьей строке дважды щелкаете мышью на слове Вторник и меняете его на Среда. И так четыре раза (рис. 7.168).

Рис. 7.168. Массив заполнен названиями дней недели. {https://ai2b.pro/wp-content/uploads/1/07_168.png}
Все! Пример готов. Можете установить точку останова на конец процедуры и запустить проект в режиме отладки.

##### Быстрый просмотр значений и панель «Переменные»
Чтобы посмотреть, что находится в массиве, вы можете использовать либо быстрый просмотр значений, либо панель Переменные.
Быстрый просмотр выражений удобен тем, что в случае длинных строковых значений вы можете увидеть их полностью в нижнем окне (рис. 7.169).

Рис. 7.169. Быстрый просмотр выражений {https://ai2b.pro/wp-content/uploads/1/07_169.png}
Панель Переменные удобна тем, что она все время открыта и в ней вы можете увидеть и значения других переменных модуля (рис. 7.170).

Рис. 7.170. Панель «Переменные» {https://ai2b.pro/wp-content/uploads/1/07_170.png}

##### Методы массива
Итак, вот ваш массив. Он даже тут похож на стеллаж, только перевернутый вверх ногами.
Массив – это нумерованная коллекция. То есть ее элементы расположены не просто так, а в определенном порядке друг за другом. Для этого у каждого элемента массива есть индекс. Индекс – это как номер по порядку, только начинается он не с единицы, а с нуля.
совет
Везде во встроенном языке, где вам попадется слово «индекс», знайте: индекс первого элемента всегда равен нулю, а индекс последнего элемента вычисляется по формуле: «количество элементов минус единица».
Итак, у каждого элемента массива есть индекс, а значение элемента массива – это само то значение, которое вы туда поместили. Если вспомнить стеллаж, то в данном случае он будет выглядеть так (рис. 7.171).

Рис. 7.171. Массив – стеллаж {https://ai2b.pro/wp-content/uploads/1/07_171.png}
Теперь о методах, которые есть у массива. То есть о тех действиях, которые можно выполнять с объектом типа Массив.
Метод Добавить() вы уже знаете. Он добавляет новое значение в конец массива.
Методы Вставить() и Установить() тоже добавляют одно значение. Но не в конец, а в ту позицию, которую вы укажете. При этом Вставить() раздвигает элементы, а Установить() замещает тот элемент, который уже есть в этой позиции.
Например, если вы захотите вставить или установить число 2 во вторую позицию массива, то результат будет такой (рис. 7.172).

Рис. 7.172. «Вставить()» и «Установить()» {https://ai2b.pro/wp-content/uploads/1/07_172.png}
Метод Количество() сообщает, сколько элементов в массиве. А метод ВГраница() нужен только для того, чтобы быстро узнать индекс последнего элемента и не писать вместо этого Количество() – 1.
Метод Очистить() удаляет все элементы, а метод Удалить() удаляет только один элемент.
Метод Получить() возвращает значение, которое находится по указанному индексу. А метод Найти() возвращает индекс того значения, которое вы ищете.
То есть ДниНедели.Найти("Вторник") вернет вам число 1, а ДниНедели.Получить(1) вернет вам строку "Вторник". Можете попробовать.

#### Обрабатывайте ошибочные ситуации
Сейчас вы узнаете несколько программистских «секретов». Все они связаны с коллекциями значений. Вот первый из них.
Некоторые методы объектов не всегда могут выполняться успешно. Пример этого вы можете увидеть уже в массиве. Например, если в синтакс-помощнике вы посмотрите описание метода Найти(), то увидите, что он возвращает Число или Неопределено. Число он возвращает тогда, когда выполняется успешно и в массиве есть то, что вы ищете. Но вполне может быть такая ситуация, что в массиве не окажется того, что вы ищете. И тогда он вернет значение Неопределено.
Начинающие программисты часто забывают об этой особенности. И это естественно: когда вы пишете программу, вы совершенно точно знаете, что у вас будет в массиве, а чего не будет. Но дело в том, что, когда пользователи (да и вы сами) начинают работать с вашей программой, они могут выполнить такую последовательность действий, которую вы не предусматривали в своей программе. И в результате в массиве не окажется того значения, которое, по вашему мнению, там обязательно должно быть.
Совет
Если вы думаете, что такого не может быть, то знайте, что такое может быть! Потому что пользователи думают совсем не так, как думаете вы!
А раз так, то правилом хорошего тона в программировании является обработка не только успешных действий, но и ошибочных ситуаций, которые могут возникнуть.
В данном случае в том месте, где вы бы написали просто Найти() (рис. 7.173), лучше обработать неудачную ситуацию, которая может возникнуть (рис. 7.174).

Рис. 7.173. Метод «Найти()» {https://ai2b.pro/wp-content/uploads/1/07_173.png}

Рис. 7.174. Метод «Найти()» и обработка ошибочной ситуации  {https://ai2b.pro/wp-content/uploads/1/07_174.png}
То есть для того случая, когда метод возвращает значение Неопределено, написать условие Если. В нем обработать ошибочную ситуацию. Например, вывести какое-то информационное сообщение. А если в этой ситуации дальнейшая работа вашего алгоритма невозможна, то и завершить его с помощью инструкции Возврат.
Тогда получится, что если «все хорошо», исполнение пройдет мимо условия Если. А если «все плохо», выполнится тело условия и вы выйдете из процедуры, не выполняя остальные инструкции.
совет
Можете самостоятельно посмотреть с помощью синтаксической подсказки, что делает процедура ПоказатьПредупреждение(). У нее несколько параметров.
Обязательным параметром является только один – <ТекстПредупреждения>. Его вы и указали. Необязательные параметры, которые находятся после него, можно не указывать и не ставить запятые.
А вот «место» необязательного параметра, который находится перед ним, нужно обозначить запятой. Чтобы платформа понимала, что вашу строку «Вторник не найден…» нужно передать именно во второй параметр, а не в первый.
Смоделируйте ошибочную ситуацию – поставьте символ комментария в седьмой строке (рис. 7.175). Чтобы проверить, как это работает, запустите проект не в режиме отладки, а в обычном рабочем режиме. Для этого нажмите Ctrl+F11.

Рис. 7.175. Замените значение «Вторник» значением 2 {https://ai2b.pro/wp-content/uploads/1/07_175.png}
Если теперь вы запустите проект, то увидите сообщение: «Вторник не найден!»
Чтобы посмотреть, как этот пример будет работать без условия Если, можете временно закомментировать это условие и тем самым исключить его из исполнения. Чтобы закомментировать сразу несколько строк, выделите их и нажмите Источник > Переключить комментарий в их контекстном меню (рис. 7.176).

Рис. 7.176. Добавить комментарий {https://ai2b.pro/wp-content/uploads/1/07_176.png}
Если после этого вы запустите проект, то увидите, что было бы, если бы вы не обрабатывали ошибочную ситуацию (рис. 7.177).

Рис. 7.177. Сообщение об ошибке {https://ai2b.pro/wp-content/uploads/1/07_177.png}
Смысл этого сообщения в том, что платформа не может выполнить операцию сложения ИндексВторника + 1. Потому что в переменной ИндексВторника у вас оказалось значение Неопределено, а для него не существует операции сложения с числом.
Самое неприятное в этом сообщении то, что платформа не может продолжить дальнейшую работу. Поэтому не спешите, не ленитесь, обращайте внимание на то, какие значения возвращают методы. Если возможна ситуация, когда выполнение метода заканчивается неудачей, обрабатывайте такие ситуации. Во-первых, ваше собственное сообщение поможет быстро понять, в чем проблема. А во-вторых, даже если ваш небольшой алгоритм закончился неудачей, пользователь сможет продолжить работу с вашей программой. Сможет воспользоваться другими ее возможностями.

#### Используйте операцию […]
Вот второй «секрет». Вы уже видели (а может быть, даже и пробовали), как получить значение по его индексу. Для этого можно использовать метод Получить() (листинг 7.12).
Листинг 7.12. Метод Получить()
ВторойДень = ДниНедели.Получить(1);
Но на самом деле есть более простой и короткий способ сделать то же самое. Чаще всего именно этот способ используют при работе не только с массивами, но и с любыми коллекциями значений.
Во встроенном языке существует операция «квадратные скобки». Выглядит она так (листинг 7.13).
Листинг 7.13. Операция «квадратные скобки»
ВторойДень = ДниНедели[1];
Две эти инструкции абсолютно идентичны. И в первом, и во втором случае в переменной ВторойДень окажется одно и то же значение – Вторник. Но вторая инструкция короче и читается легче. Сразу после имени переменной, в которой находится коллекция, ставятся квадратные скобки. А в них указывается индекс того элемента, который нужно получить.
Попробуйте самостоятельно получить, например, третий и пятый элементы массива с помощью квадратных скобок.

#### Используйте инструкцию «Для Каждого … Цикл»
Вот третий «секрет». Ранее вы уже познакомились с инструкцией Цикл. Она позволяет многократно выполнять некоторый набор инструкций. Цикл часто используется при работе с коллекциями. Например, для того чтобы перебрать все элементы коллекции и выполнить с ними какие-то действия.
Чтобы не усложнять, напишите самый простой пример. У вас есть массив с названиями дней недели. Вам нужно выбрать из него только будние дни и скопировать их в новый массив.
С помощью цикла это можно выполнить следующим образом (листинг 7.14).
Листинг 7.14. Перебор элементов коллекции в цикле
БудниеДни = Новый Массив();
Для Индекс = 0 По ДниНедели.ВГраница() Цикл
ТекущийЭлемент = ДниНедели[Индекс];
Если ТекущийЭлемент = "Суббота" ИЛИ ТекущийЭлемент = "Воскресенье" Тогда
Продолжить;
 
Иначе
БудниеДни.Добавить(ТекущийЭлемент);
 
КонецЕсли;
 
КонецЦикла;
Можете дописать этот пример к своему массиву и посмотреть с помощью отладки, как он работает. Особенно наглядно вы увидите это в панели Переменные (рис. 7.178).

Рис. 7.178. Пример в панели «Переменные» {https://ai2b.pro/wp-content/uploads/1/07_178.png}
Сначала вы создаете новый массив, в который будете помещать будние дни. После этого последовательно, от нуля до последнего индекса, перебираете все элементы массива.
Значение текущего элемента вы получаете по его индексу с помощью операции «квадратные скобки». Если это значение Суббота или Воскресенье, то вы ничего не делаете и переходите к следующей итерации цикла. То есть к его началу. Для этого используется новая для вас инструкция Продолжить.
А во всех других случаях вы добавляете название буднего дня в свой заранее созданный массив.
Сделайте этот пример в своей конфигурации и в режиме отладки посмотрите по шагам, как он работает. В том числе посмотрите, как работает инструкция Продолжить.
Такие задачи, когда нужно перебрать все элементы коллекции, встречаются очень часто. Поэтому во встроенном языке существует специальная форма инструкции Цикл. Она обозначается Для Каждого Цикл. И тот же самый пример с ее использованием будет выглядеть так (листинг 7.15).
Листинг 7.15. Инструкция «Для Каждого Цикл»
БудниеДни = Новый Массив();
Для Каждого ТекущийЭлемент Из ДниНедели Цикл
Если ТекущийЭлемент = "Суббота" ИЛИ ТекущийЭлемент = "Воскресенье" Тогда
Продолжить;
 
Иначе
БудниеДни.Добавить(ТекущийЭлемент);
 
КонецЕсли;
 
КонецЦикла;
Вы видите, что выглядит этот пример проще и читается легче.
Если сравнить оба примера, то видно, что по сути инструкция Для Каждого Цикл заменила собой сразу две строки, которые были в вашем старом примере (рис. 7.179).

Рис. 7.179. Инструкции «Для Каждого Цикл» и «Для Цикл» {https://ai2b.pro/wp-content/uploads/1/07_179.png}
Инструкцию Для Каждого Цикл используют тогда, когда порядок обхода коллекции не важен. А важно лишь перебрать все элементы, которые есть в коллекции.
Попробуйте в своей конфигурации, как работает второй вариант этого примера.
В инструкции Продолжить, с которой вы познакомились в этом примере, нет ничего сложного. Она используется только внутри циклов и только для такой задачи, которая показана в этом примере. Когда нужно перейти к очередной итерации цикла, не выполняя операторы, следующие далее.
Кроме Продолжить внутри цикла может использоваться и другая инструкция – Прервать. Она тоже очень простая. Она без всяких условий прекращает исполнение цикла и переходит к инструкции, которая расположена после КонецЦикла.
Инструкция Прервать может понадобиться вам тогда, когда вы точно знаете, что перебирать коллекцию дальше нет смысла. Например, в вашем массиве дни недели всегда расположены в правильном порядке. Поэтому если вы перебираете их с начала и дошли до субботы, то понятно, что дальше их перебирать нет смысла. Потому что следующий за субботой день тоже будет выходной. Значит, в условии Если вы можете написать Если ТекущийЭлемент = "Суббота" Тогда. А затем – Прервать.
Небольшое пояснение. Фрагмент, показанный в листинге 7.15, вы вряд ли встретите в реальной программе. Здесь он показан только в учебных целях. В реальной программе такой фрагмент может появиться разве что в процессе разработки, когда вы по очереди пишете алгоритмы для каждой ветки условия. И, чтобы была возможность проверить написанное, в той ветке, которая еще не готова, вы просто пропускаете весь цикл.
Другое небольшое пояснение касается инструкции Прервать. Тут объяснение этой инструкции пришлось к слову и к месту. Но именно в цикле Для Каждого эта инструкция используется редко. Потому что порядок обхода элементов в таком цикле не определен. Гораздо чаще эта инструкция используется в циклах, которые имеют определенный порядок обхода.

#### Удаляйте элементы с конца
И вот последний, четвертый, «секрет». Инструкция Для Каждого Цикл очень удобная и простая. Так и хочется ею пользоваться! Но тут главное – не переусердствовать. Потому что бывают задачи, когда элементы коллекции обязательно нужно перебирать в определенном порядке. Хотя, на первый взгляд, в этом нет никакой необходимости.
Чтобы все увидеть своими глазами, сделайте простой пример (листинг 7.16).
Листинг 7.16. Удалить все числа, которые меньше 10. Неправильный вариант
Числа = Новый Массив();
Числа.Добавить(10);
Числа.Добавить(8);
Числа.Добавить(4);
Числа.Добавить(15);
 
Для Каждого ТекущееЧисло Из Числа Цикл
Если ТекущееЧисло < 10 Тогда
Числа.Удалить(Числа.Найти(ТекущееЧисло));
 
КонецЕсли;
 
КонецЦикла;
Задача очень простая. У вас есть массив из четырех чисел. Вам нужно удалить из этого массива все числа, которые меньше 10.
Поставьте точку останова на инструкции Если и запустите проект в режиме отладки.
Не ожидая подвоха, вы написали Для Каждого Цикл, и дальше происходит вот что. На первой итерации цикла ТекущееЧисло у вас – 10 (рис. 7.180).

Рис. 7.180. Первая итерация цикла {https://ai2b.pro/wp-content/uploads/1/07_180.png}
На второй итерации цикла ТекущееЧисло у вас будет 8 (рис. 7.181).

Рис. 7.181. Вторая итерация цикла {https://ai2b.pro/wp-content/uploads/1/07_181.png}
И тут вы обнаруживаете, что этот элемент нужно удалить. Коллекции не терпят пустых мест. Как только вы его удаляете, остальные элементы коллекции перемещаются, чтобы занять освободившееся место (рис. 7.182).

Рис. 7.182. После удаления элемента 8 {https://ai2b.pro/wp-content/uploads/1/07_182.png}
Получается, что на втором месте оказалось число 4, которое вы еще не обрабатывали. Но цикл продолжается, и на третьей итерации вы, естественно, переходите к следующему элементу коллекции (рис. 7.183).

Рис. 7.183. Третья итерация цикла {https://ai2b.pro/wp-content/uploads/1/07_183.png}
Теперь ваше текущее число 15. А 4 «проскочила» мимо вас. И осталась в массиве.
Если вспомнить, что вы представляли массив как стеллаж, то, когда вы удаляете один из мячиков, все остальные, которые находятся выше него, «проваливаются» вниз (рис. 7.184).

Рис. 7.184. Остальные мячики проваливаются вниз {https://ai2b.pro/wp-content/uploads/1/07_184.png}
И мячик, который вы должны были бы обработать на следующем шаге, проскакивает мимо вас.
Чтобы такого не случалось, нужно двигаться сверху вниз, то есть от конца к началу (рис. 7.185).

Рис. 7.185. Обход массива с конца {https://ai2b.pro/wp-content/uploads/1/07_185.png}
Тогда, если вы удалите элемент 4, вниз «провалится» элемент с той полки, которую вы уже обрабатывали, – 15. И это не страшно.
Как все то же самое сделать на встроенном языке? Довольно просто. Но для этого нужно будет использовать еще один вид инструкции цикла – Пока Цикл (листинг 7.17).
Листинг 7.17. Удалить все числа, которые меньше 10. Правильный вариант
ТекущийИндекс = Числа.ВГраница();
Пока ТекущийИндекс >= 0 Цикл
Если Числа[ТекущийИндекс] < 10 Тогда
Числа.Удалить(ТекущийИндекс);
 
КонецЕсли;
 
ТекущийИндекс = ТекущийИндекс - 1;
 
КонецЦикла;
В такой форме записи цикл выполняется до тех пор, пока выражение, записанное между Пока и Цикл, равно Истина. Как только это выражение становится равно Ложь, выполнение цикла прекращается.
Чтобы обходить цикл, вы создаете переменную ТекущийИндекс. В ней будет находиться индекс того элемента массива, который нужно обработать. Сначала вы помещаете в эту переменную индекс последнего элемента (листинг 7.18).
Листинг 7.18. Помещаете индекс самого последнего элемента
ТекущийИндекс = Числа.ВГраница();
В конце тела цикла вы каждый раз уменьшаете этот индекс на единицу. Это позволяет вам двигаться от конца к началу (листинг 7.19).
Листинг 7.19. Уменьшаете индекс на единицу
ТекущийИндекс = ТекущийИндекс – 1;
А в условии цикла вы проверяете, не стал ли текущий индекс отрицательным. Как только он становится меньше нуля, исполнение цикла завершается (листинг 7.20).
Листинг 7.20. Проверяете, не стал ли текущий индекс отрицательным
Пока ТекущийИндекс >= 0 Цикл
Таким образом вы обходите все индексы от последнего к нулевому. Сделайте этот пример в своей конфигурации. Пройдите его в режиме отладки по шагам, посмотрите, как он работает. Убедитесь, что в результате в массиве останутся только два значения: 10 и 15.
#### Структура
Еще одна коллекция, с которой вы познакомитесь, называется структура. Она, как и массив, может содержать в себе набор некоторых значений. Но только если массив – это стеллаж, на котором значения-мячики находятся в порядке, друг за другом, то структура похожа на обычную коробку, в которой эти мячики лежат в полном беспорядке (рис. 7.186).

Рис. 7.186. Структура – мячики в коробке {https://ai2b.pro/wp-content/uploads/1/07_186.png}
Как же тогда отличить один мячик от другого, если у них нет никакого порядка? В структуре для этого используется имя. Например, «желтый», «красный», «синий» и так далее. Отсюда следует очень простой вывод: в структуре все имена мячиков-элементов должны быть разными. Повторяться они не могут.
Описание типа Структура вы можете найти в синтакс-помощнике рядом с массивом (рис. 7.187).

Рис. 7.187. Тип «Структура» {https://ai2b.pro/wp-content/uploads/1/07_187.png}
Значение типа Структура – это тоже объект встроенного языка, как и значение типа Массив. Поэтому у структуры тоже есть методы и конструкторы. Но, обратите внимание, у структуры есть еще одна незнакомая вам «вещь», которая называется Свойства.
В чем отличие методов от свойств? В том, что, когда вы вызываете метод, объект обязательно выполняет какое-то действие. И в результате, возможно, вернет вам какое-то значение. А когда вы обращаетесь к свойству, объект не выполняет никаких действий. Но обязательно сообщает вам какую-то информацию о себе, то есть обязательно возвращает некоторое значение.
У структуры есть единственное свойство – имя ключа. Почему оно написано в угловых скобках? Ведь имена методов написаны без всяких скобок.
Все дело в том, что имена методов – это именно те самые имена, которые вы должны использовать в программе. А <Имя ключа> – это просто обозначение того, что в программе вы должны будете написать имя того элемента коллекции, к которому хотите обратиться. Ведь заранее неизвестно, какие имена вы придумаете своим элементам.
Чтобы все прояснилось, сделайте простой пример. Создайте структуру и получите некоторые ее элементы (листинг 7.21).
Листинг 7.21. Структура «МестоРаботы»
МестоРаботы = Новый Структура();
МестоРаботы.Вставить("Должность", "Ведущий специалист");
МестоРаботы.Вставить("НачалоРаботы", Дата(2018, 9, 1));
МестоРаботы.Вставить("Оклад", 40000 );
 
// Обращение к элементам структуры.
ДолжностьСотрудника = МестоРаботы.Должность;
ОкладСотрудника = МестоРаботы.Оклад;
 
Вы создали структуру и добавили в нее три элемента. Первый элемент имеет имя Должность. Его значение – это строка с названием занимаемой должности. Второй элемент с именем НачалоРаботы – это дата начала работы. Ну, и третий элемент с именем Оклад имеет значение 40 000. Это число.
Теперь вы видите: чтобы узнать должность, нужно обратиться к свойству структуры. Обращение к свойству объекта выглядит точно так же, как к методу, только без круглых скобок в конце. То есть после точки вы пишете имя свойства. В вашем случае это будет имя нужного вам элемента – Должность. Ну, а чтобы узнать оклад сотрудника, вы обращаетесь к свойству Оклад.
примечание
Структура – это именованная коллекция. То есть ее элементы расположены в беспорядке. А обратиться к конкретному элементу можно по имени. И это имя уникально (не повторяется) в пределах одного объекта встроенного языка.
Теперь посмотрите, как выглядит структура «внутри». Запустите проект в режиме отладки и остановитесь на инструкции КонецПроцедуры. Откройте панель Переменные (рис. 7.188).

Рис. 7.188. Значение структуры «МестоРаботы» {https://ai2b.pro/wp-content/uploads/1/07_188.png}
Строки, выделенные на этом рисунке, показывают элементы структуры в том виде, в котором вы обращались бы к ним во встроенном языке: <имя структуры>.< имя ключа>. Но на самом деле структура устроена сложнее.
Раскройте ветку Элементы. Она показывает физическое устройство структуры (рис. 7.189).

Рис. 7.189. Физическое устройство структуры «МестоРаботы» {https://ai2b.pro/wp-content/uploads/1/07_189.png}
Если сравнить структуру с массивом, то вы увидите, что элементами массива являлись сами примитивные значения, то есть строки Понедельник, Вторник и так далее.
Элементами структуры, как вы видите, являются не строки («Ведущий специалист», 1 сентября, 40 000), а какие-то КлючИЗначение. КлючИЗначение – это тоже объект встроенного языка. Он нужен исключительно для того, чтобы связать вместе некоторое значение и его имя (ключ).
Если вы раскроете ветки элементов структуры, то 1C:EDT покажет вам эти объекты (рис. 7.190).

Рис. 7.190. «КлючИЗначение» {https://ai2b.pro/wp-content/uploads/1/07_190.png}
Как видите, у объекта КлючИЗначение всего два свойства: значение, которое вы поместили в структуру, и его ключ, то есть имя. По ключу вы можете обратиться к этому значению.
Структура – удобный объект для того, чтобы познакомиться с еще одной панелью 1C:EDT, панелью Значения. В структуре каждый элемент представлен объектом, который имеет несколько свойств. В случае структуры это два свойства, но их может быть и больше. Просматривать такие сложные объекты удобнее в панели Значения. Стандартно она расположена в нижней части перспективы Отладка (рис. 7.191).

Рис. 7.191. Панель «Значения» {https://ai2b.pro/wp-content/uploads/1/07_191.png}
Эта панель связана с панелью Переменные. Выделите переменную МестоРаботы – и вы увидите ее значение в этой панели.
Здесь каждому элементу структуры соответствует своя строка. В этой строке сначала показан тип значения – КлючИЗначение. А дальше в отдельных колонках перечислены значения его свойств. Таким образом, вы можете охватить всю структуру одним взглядом, не раскрывая ветки ее элементов, как это было в панели Переменные.
Выполнить «путешествие внутрь структуры» вы можете не только в режиме отладки, но и в синтаксической подсказке (рис. 7.192).

Рис. 7.192. Описание структуры в синтаксической подсказке {https://ai2b.pro/wp-content/uploads/1/07_192.png}
Вы видите, что здесь не просто написано, что элементами коллекции являются объекты КлючИЗначение. На этом имени есть гиперссылка. Если вы нажмете на нее, вы перейдете к описанию объекта КлючИЗначение. А чтобы вернуться обратно, вы можете нажать кнопку в командной панели (рис. 7.193).

Рис. 7.193. Описание объекта «КлючИЗначение» {https://ai2b.pro/wp-content/uploads/1/07_193.png}
Теперь, когда вы представляете, как устроена структура, познакомьтесь с ее методами.
В примере вы создавали пустую структуру, а потом добавляли в нее значения. У структуры, в отличие от массива, есть единственный метод, с помощью которого можно добавить элемент. Это метод Вставить(). В нем, как вы уже поняли, нужно указать имя элемента и его значение. Если элемента с таким именем в структуре еще нет, он появится. А если элемент с таким именем есть, его значение изменится на то, которое указали вы.
Если вы сразу же знаете, какие значения будут в вашей структуре, вы можете создавать не пустую структуру, а структуру со значениями. Их имена и значения нужно указать в конструкторе. Для структуры, которая сейчас в вашем примере, это будет выглядеть так (листинг 7.22). Можете попробовать.
Листинг 7.22. Создание структуры с элементами
МестоРаботы = Новый Структура("Должность, НачалоРаботы, Оклад", "Ведущий специалист", Дата(2018, 9, 1), 40000);
В первом параметре перечисляются все имена будущих элементов, а потом через запятую в том же порядке перечисляются значения этих параметров.
Еще один метод, о котором важно рассказать, называется Свойство(). На первый взгляд непонятно, зачем он нужен. Но сделайте простой пример.
Часто бывает так, что структура создается в одном месте, а используете вы ее совсем в другом. И вы заранее не знаете, будут в ней все элементы, которые вы ожидаете, или нет. В примере с местом работы может быть такая ситуация. Не всегда заранее известен оклад, он может быть и не указан.
Но ваша программа ожидает, что в структуре оклад будет. Поэтому где-то в своей программе вы получаете оклад из структуры (листинг 7.23).
Листинг 7.23. В структуре нет оклада сотрудника
// Где-то создается структура.
МестоРаботы = Новый Структура("Должность, НачалоРаботы", "Ведущий специалист", Дата(2018, 9, 1));
 
// Здесь вы хотите использовать оклад.
ОкладСотрудника = МестоРаботы.Оклад;
Если в структуре не будет оклада, вы получите такую ошибку (можете запустить и проверить) – рис. 7.194.

Рис. 7.194. Ошибка: в структуре нет оклада сотрудника {https://ai2b.pro/wp-content/uploads/1/07_194.png}
Именно для таких случаев и нужен метод Свойство(). Он позволяет избежать ошибки в тех случаях, когда вы не уверены на 100 %, что нужный вам элемент есть в структуре (листинг 7.24).
Листинг 7.24. Использование метода «Свойство()»
// Здесь вы хотите использовать оклад.
ОкладСотрудника = Неопределено;
Если НЕ МестоРаботы.Свойство("Оклад", ОкладСотрудника) Тогда
ПоказатьПредупреждение( , "Оклад сотрудника отсутствует.");
Возврат;
 
КонецЕсли;
 
ОкладСотрудника = МестоРаботы.Оклад;
Сначала нужно создать переменную, в которой будет сохранен оклад. Потом в условии Если вы вызываете метод Свойство(). В параметрах передаете ему имя элемента, которое надеетесь получить, и переменную, в которую нужно будет поместить значение этого элемента.
Если все хорошо, то в переменной оказывается значение элемента, Если не выполняется и продолжается ваш алгоритм.
А если элемента с таким именем нет, метод вернет значение Ложь и выполнится условие Если. В этом условии вы каким-то образом обрабатываете ошибку. Например, выводите сообщение. И если без оклада сотрудника продолжение вашей программы невозможно, можете даже написать Возврат.
Сделайте этот пример в своем проекте и посмотрите, как он работает.
Точно так же, как и любую другую коллекцию, все элементы структуры можно перебрать с помощью инструкции Для Каждого Цикл.
Точно так же, как в массиве, в структуре можно обратиться к элементу с помощью операции «квадратные скобки». Только внутри скобок нужно указать не индекс (у элементов структуры нет индексов), а имя.
Например, в вашем примере узнать размер оклада можно двумя способами (листинг 7.25).
Листинг 7.25. Узнать размер оклада
ОкладСотрудника = МестоРаботы.Оклад;
ОкладСотрудника = МестоРаботы["Оклад"];
Вторая строка выглядит немного странно, правда? Зачем так усложнять, когда имя можно написать сразу после точки?
Вы абсолютно правы. В подавляющем большинстве случаев именно так и пишут. Точка, а после нее имя.
Но есть случаи, когда вы заранее не знаете имя. Например, где-то в форме пользователь указал, что его интересует оклад. И вы запомнили желание пользователя в переменной ЧтоХочетПользователь.
Теперь, в другом месте программы, у вас есть только структура ОкладСотрудника и только переменная ЧтоХочетПользователь. Как получить из структуры нужный пользователю элемент? Посмотрите на листинг 7.26.
Листинг 7.26. Получение элемента структуры с помощью квадратных скобок
МестоРаботы = Новый Структура;
МестоРаботы.Вставить("Должность", "Ведущий специалист");
МестоРаботы.Вставить("НачалоРаботы", Дата(2018, 9, 1));
МестоРаботы.Вставить("Оклад", 40000);
 
// Где-то в форме пользователь указал, какая именно информация ему нужна.
ЧтоХочетПользователь = "Оклад";
 
// В переменной ЧтоХочетПользователь находится имя того элемента, который ему нужен.
// Как этот элемент получить из структуры?
ВернутьПользователю = МестоРаботы[ЧтоХочетПользователь];
Именно для таких случаев и нужна операция «квадратные скобки» при работе со структурой.


### Прикладные типы
До сих пор вы учились работать с данными, которые хранятся в оперативной памяти. Переменные, массивы, структуры – все эти данные существуют только в то время, пока выполняется ваша программа, пока работает компьютер.
Но вместе с этим вы видите, что есть и другие данные, которые вы ввели, и они никуда не исчезают. Это номенклатура, это списки клиентов, сотрудников и складов, приходные накладные и документы оказания услуг. Эти данные прикладное решение хранит на компьютере специальным образом. И сейчас вы познакомитесь с тем, как «добраться» до этих данных и как с ними работать.
Но прежде вы узнаете о том, как устроена платформа «1С:Предприятие».
#### База данных
В большинстве привычных вам компьютеров есть два вида памяти: оперативная память и жесткий диск.
Вся информация, которая есть на компьютере, хранится на жестком диске. Он имеет большой объем и может хранить информацию даже тогда, когда компьютер выключен. Но, к сожалению, жесткий диск работает не очень быстро.
Поэтому любая программа, которую вы запускаете, с жесткого диска загружается в оперативную память и в ней работает. Оперативная память умеет работать быстро, но, к сожалению, она небольшого объема. А второй ее недостаток заключается в том, что ей обязательно нужно электричество. Если вы выключите компьютер, все данные из оперативной памяти исчезнут.
Те данные, которые нужно хранить долго, прикладное решение записывает на жесткий диск. Вспомните: когда вы создавали элементы справочников, вы каждый раз нажимали кнопку Записать и закрыть. Именно в этот момент прикладное решение сохраняло ваши данные на жесткий диск.
Все ваши данные прикладное решение хранит на жестком диске в специальном виде, который называется база данных. База данных представляет собой один файл, который имеет стандартное имя 1Cv8.1CD. В этом же файле платформа хранит и всю структуру объектов конфигурации, которую вы создали, и все тексты модулей на встроенном языке.

#### Клиент и сервер
До сих пор вы не интересовались тем, что работает в оперативной памяти вашего компьютера, когда вы запускаете прикладное решение. Говорилось, что это некоторая программа.
На самом деле платформа «1С:Предприятие» – это не одна программа, а совокупность нескольких программ, которые взаимодействуют друг с другом. Сейчас, на вашем компьютере, это незаметно, потому что вы используете самый простой вариант работы – файловый. На больших предприятиях используется другой режим работы – клиент-серверный.
Особенность платформы заключается в том, что прикладные решения разрабатываются одним и тем же образом независимо от того, в каком режиме они будут работать в дальнейшем. То есть ваше прикладное решение можно запустить и в клиент-серверном режиме работы. При этом в нем ничего переделывать или доделывать не придется.
Это очень хорошая и удобная особенность платформы. Но она приводит к тому, что принципы клиент-серверного взаимодействия нужно понимать всем: и тем, кто делают сложные программы, и тем, кто, как вы, делают самые простые программы для работы в файловом варианте.
Итак, начните знакомиться с этим по порядку.
Как вы уже знаете, платформа «1С:Предприятие» – это несколько программ. Их можно разделить на три главных блока: клиентское приложение, сервер «1С:Предприятия» и система управления базой данных (рис. 7.195).

Рис. 7.195. Клиент-серверная архитектура {https://ai2b.pro/wp-content/uploads/1/07_195.png}
Клиентское приложение – это та программа, которую вы запускаете, когда нажимаете F11.
Сервер «1С:Предприятия» – это та часть платформы, которая позволяет большому количеству пользователей одновременно работать с одной и той же информационной базой. Сейчас только вы работаете со своим прикладным решением – вносите туда данные, изменяете их. Но на больших предприятиях, в больших учетных системах данные вносят и изменяют одновременно многие сотрудники.
Система управления базой данных (СУБД) – это та часть платформы, которая записывает данные в базу данных и получает их оттуда.
Цепочка взаимодействия этих частей платформы выглядит следующим образом. Например, вы захотели посмотреть, какие материалы поступили в вашу организацию. Для этого вы используете клиентское приложение и открываете список приходных накладных. Клиентское приложение обращается с этим запросом к серверу «1С:Предприятия». Сервер «1С:Предприятия» передает этот запрос СУБД в том виде, в котором он ей понятен. СУБД выбирает из базы данных нужную информацию о документах.
После этого все идет в обратную сторону. СУБД передает данные серверу «1С:Предприятия». Сервер «1С:Предприятия» отдает их клиентскому приложению в том виде, который будет понятен для вас. И, наконец, клиентское приложение показывает их вам на экране.
Сейчас, на вашем компьютере, в файловом варианте работы, эти три части платформы практически не видны. Потому что сервер «1С:Предприятия» и файловая СУБД «спрятаны» внутри вашего клиентского приложения. Но в клиент-серверном варианте все эти три части платформы очень хорошо видны. Чаще всего они располагаются на разных компьютерах. И эти компьютеры могут находиться даже не в разных частях одного здания, а в разных частях света (рис. 7.196).

Рис. 7.196. Клиент-серверный вариант работы {https://ai2b.pro/wp-content/uploads/1/07_196.png}
Практически все программы на встроенном языке (за небольшим исключением) всегда начинают работать в клиентском приложении, или «на клиенте». Если им нужно получить какие-то данные из базы данных, они переходят на сервер «1С:Предприятия», или просто «на сервер». После того как они выполнили все операции с данными, они возвращаются на клиент (рис. 7.197).

Рис. 7.197. Исполнение встроенного языка на клиенте и на сервере {https://ai2b.pro/wp-content/uploads/1/07_197.png}
Глядя на рисунок 7.197, можно хорошо увидеть, что встроенный язык имеет разные возможности на клиенте и на сервере. Например, на клиенте нет базы данных. Поэтому что-то прочитать из нее или записать в нее невозможно. Для этого обязательно нужно перейти на сервер.
С другой стороны, на сервере практически отсутствуют средства взаимодействия с пользователем. Для того чтобы показать что-то пользователю или вывести ему какое-нибудь оповещение, нужно вернуться на клиент.
Поэтому, когда вы пишете программу на встроенном языке, вы всегда должны точно представлять, где будет исполняться та или иная ее часть: на клиенте или на сервере. Или, говоря другими словами, в каком контексте она будет исполняться: в контексте клиента или в контексте сервера.
Некоторые модули, например модуль приложения, в котором вы выполняли все предыдущие задания, существуют только в единственном контексте. Модуль приложения исполняется только в контексте клиента. На сервере он никогда не бывает.
Но другие модули могут существовать в разных контекстах, и вам нужно в явном виде указывать, где должен исполняться тот или иной модуль.
Более того, некоторые модули (например, модуль формы) устроены так, что могут исполняться и на клиенте, и на сервере. В таких модулях вы должны будете для каждой процедуры или функции отдельно указывать место ее исполнения.
Сейчас это может показаться вам сложным, но не пугайтесь. На самом деле все очень просто, и скоро вы в этом убедитесь.
В зависимости от того, на клиенте или на сервере исполняется ваш фрагмент программы, вы можете использовать те или иные типы, методы, функции. Или не можете их использовать. Разобраться в этом поможет синтакс-помощник.
Во-первых, для каждого типа, метода, свойства в нем указано, в каком контексте его можно использовать. Например, если вы откроете хорошо знакомый вам тип Массив, то в разделе Доступность увидите следующее (рис. 7.198).

Рис. 7.198. Доступность типа «Массив» {https://ai2b.pro/wp-content/uploads/1/07_198.png}
Слово «сервер» означает, что этот тип можно использовать на сервере. «Тонкий клиент», «веб-клиент», «внешнее соединение» – это разные виды клиентских приложений. Мобильное приложение в рамках этой книги не рассматривается, поэтому не обращайте на него внимания.
Таким образом, как только вы решите использовать тот или иной тип в своей программе, вы всегда можете посмотреть, доступен ли он в том контексте, в котором вы сейчас находитесь.

#### Прикладные типы
Для работы с данными, хранимыми в базе данных, существует большой набор типов. Все их вы можете найти в синтакс-помощнике в ветке Прикладные объекты (рис. 7.199).

Рис. 7.199. Прикладные типы {https://ai2b.pro/wp-content/uploads/1/07_199.png}
Как вы можете заметить, названия веток в этом разделе соответствуют тем объектам конфигурации, которые вы можете добавлять: Справочники, Документы и так далее. Именно поэтому все эти типы называются «прикладными».
Если вы раскроете, например, ветку Справочники, то увидите, что большинство типов имеют очень странное обозначение с использованием косых скобок (рис. 7.200).

Рис. 7.200. Типы для работы со справочниками {https://ai2b.pro/wp-content/uploads/1/07_200.png}
Это потому, что они описывают лишь общую «структуру» такого типа, правила, по которым будут формироваться типы для работы со справочниками. В каждой конфигурации, каждом прикладном решении они будут свои собственные, уникальные.
В разделе «Теория: типы данных, типообразующие объекты конфигурации» вы уже знакомились с типообразующими объектами и помните, что после добавления справочника Номенклатура стали доступны следующие типы:
СправочникМенеджер.Номенклатура,
СправочникСсылка.Номенклатура,
СправочникОбъект.Номенклатура,
СправочникВыборка.Номенклатура.
То же самое происходит и с другими объектами конфигурации, например с документами. После того как вы добавили в конфигурацию документ ОказаниеУслуги, стали доступны новые типы, которые как раз и описываются в синтакс-помощнике (рис. 7.201):

Рис. 7.201. Типы для работы с документом «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/07_201.png}

Тут у вас наверняка возникнет два вопроса. Во-первых, почему для работы с одним документом нужно целых пять разных типов? А во-вторых, почему для работы с документом ОказаниеУслуги и с документом ПриходнаяНакладная нужны разные типы?
Пять разных типов нужны потому, что они предназначены для разных задач.
Тип ДокументМенеджер.ОказаниеУслуги нужен для того, чтобы создавать новые документы, находить существующие, выбирать все или некоторые документы.
Тип ДокументСсылка.ОказаниеУслуги нужен для того, чтобы отображать документы в интерфейсе: в списках, в полях ввода. Также он нужен, чтобы указывать на конкретный документ.
Тип ДокументОбъект.ОказаниеУслуги нужен для того, чтобы изменить конкретный документ.
Тип ДокументВыборка.ОказаниеУслуги нужен для того, чтобы последовательно, друг за другом, перебирать те документы, которые были выбраны из базы данных.
А тип ДокументСписок.ОказаниеУслуги – это наследие прошлых версий платформы, которое сейчас практически нигде не используется.
Теперь о том, почему при добавлении в дерево объектов конфигурации нового документа ОказаниеУслуги появляются новые типы. Проще всего это будет понять на примере типа ДокументОбъект.<Имя документа>.
Если вы раскроете свойства этого типа, то увидите, что одно из свойств обозначается <Имя реквизита> (рис. 7.202).
 
Рис. 7.202. Свойства типа «ДокументОбъект» {https://ai2b.pro/wp-content/uploads/1/07_202.png}

Это значит, что у объекта встроенного языка, имеющего тип ДокументОбъект.ОказаниеУслуги, будет три свойства: Склад, Клиент и Мастер (помимо стандартных свойств этого типа). А у документа ПриходнаяНакладная всего один реквизит – Склад. Значит, у объекта типа ДокументОбъект.ПриходнаяНакладная будет только одно «дополнительное» свойство – Склад.
И это только часть отличий. А еще есть табличные части. А еще реквизиты с одними и теми же именами могут иметь разные свойства у разных объектов. Например, реквизит Примечание у одного документа может быть строкой неограниченной длины, а у другого – длиной всего 20 символов.
Поэтому хорошо и правильно, что платформа создает для каждого объекта конфигурации свой собственный уникальный набор типов встроенного языка.

#### Объектные данные
Все данные, которые прикладное решение сохраняет в базе данных, можно разделить на две большие группы: объектные и необъектные. Разницу между ними легко будет понять, если сравнить их с людьми.
Бывают ситуации, когда для вас важно, какие именно это люди. Например, вы позвали гостей на день рождения. В этом случае для вас важно, чтобы к вам в гости пришел именно Сергей Соколов, который работает вместе с вами. А не какой-то его тезка или однофамилец, который, может быть, и одет так же, и внешне на него похож.
В этом случае ваши гости являются объектными данными. Каждый из них уникален и важен сам по себе. Даже если он оделся в другую одежду и сильно вырос за то время, что вы его не видели. Все равно он остался Сергеем Соколовым, а не стал кем-то другим.
Другая ситуация. Вы заходите в автобус, и вам нужно понять, много там пассажиров или нет – поедете вы на этом автобусе или подождете следующего? В этом случае вам совершенно не важно, какие конкретно люди находятся в автобусе, как их зовут. Не важно, кто именно стоит в проходе с большими сумками. Важно только то, что проход занят и дальше пройти нельзя.
В этом случае пассажиры автобуса являются необъектными данными. Их уникальность не имеет для вас никакого значения. Важно лишь, что они есть и что они занимают место в автобусе.
Какие данные в «1С:Предприятии» объектные, а какие необъектные, понять очень просто. Это зависит от того объекта конфигурации, которому они принадлежат.
Если это справочник или документ, то в них всегда хранятся только объектные данные.
Если это регистр накопления или любой другой регистр (сведений, бухгалтерии, расчета), то в них бывают только необъектные данные.
ПРИМЕЧАНИЕ
Кроме справочников и документов для описания объектных данных используются планы видов характеристик, планы счетов, планы видов расчета, бизнес-процессы, задачи, планы обмена.
Для описания необъектных данных кроме перечисленных регистров используются последовательности и перерасчеты регистров расчета.
Итак, вернемся к объектным данным. «Паспорт», «идентификатор», по которому можно отличить один объект данных от другого, – это его ссылка. Во встроенном языке для работы со ссылками используются типы СправочникСсылка.<Имя справочника>, ДокументСсылка.<Имя документа> и так далее. С этими типами вы уже знакомы.
Вспомните: когда вы добавляли в конфигурацию документ ПриходнаяНакладная, вы создавали у нее реквизит Склад. Он нужен для того, чтобы указать, на какой именно склад поступают материалы. И в качестве типа этого реквизита вы выбирали тип СправочникиСсылка.Склады (рис. 7.203).

Рис. 7.203. Тип реквизита «СправочникСсылка.Склады» {https://ai2b.pro/wp-content/uploads/1/07_203.png}

Именно благодаря тому, что вы выбрали такой тип, вы имеете возможность выбирать в этом реквизите один конкретный склад из нескольких (рис. 7.204).

Рис. 7.204. Выбор одного склада из нескольких {https://ai2b.pro/wp-content/uploads/1/07_204.png}

Теперь, когда вы знаете о базе данных, сервере и объектных данных, вы можете посмотреть, как до них «добраться» и как они выглядят.
Принципы работы со всеми объектными данными одинаковы. Вы будете знакомиться с ними на примере документа ОказаниеУслуги.

#### Передача исполнения на сервер
Итак, чтобы познакомиться с документами, вам нужно попасть на сервер. До сих пор вы выполняли все задания в модуле приложения. Этот модуль всегда исполняется только на клиенте. Чтобы из него попасть на сервер, вы добавите в конфигурацию модуль, который исполняется только на сервере. А затем из модуля приложения вызовете процедуру, которую напишете в этом серверном модуле. На схеме это будет выглядеть следующим образом (рис. 7.205).

Рис. 7.205. Передача исполнения с клиента на сервер {https://ai2b.pro/wp-content/uploads/1/07_205.png}

Таким модулем, который исполняется только на сервере, будет общий модуль. Общие модули не существуют в конфигурации заранее. Вы их создаете сами. Столько, сколько вам нужно. Общие модули доступны из всех других модулей конфигурации. В общих модулях вы можете описывать собственные алгоритмы, которые вы используете в разных местах конфигурации.
Общему модулю можно указать, где он будет исполняться: на клиенте или на сервере. Поэтому еще одно назначение общих модулей заключается в том, что именно с их помощью вы можете перейти на сервер. Например, чтобы получить какие-то данные из базы данных. Этим вы сейчас и займетесь.
Общие модули располагаются в ветке конфигурации Общие. Добавьте в конфигурацию общий модуль и назовите его Серверный (рис. 7.206).

Рис. 7.206. Общий модуль «Серверный» {https://ai2b.pro/wp-content/uploads/1/07_206.png}

После добавления у него стандартно уже будет установлен флажок Сервер. Это означает, что все процедуры и функции, написанные в этом модуле, будут исполняться на сервере. Это то, что вам нужно.
Но кроме этого вам еще нужно попасть в этот модуль с клиента. А для этого вам понадобится установить флажок Вызов сервера. Именно он позволит вызывать процедуры и функции этого модуля с клиента. Установите этот флажок.
Общий модуль уже открыт у вас. Напишите в нем пустую процедуру с именем НаСервере. У этой процедуры не будет параметров. А в описании процедуры, после круглых скобок, добавьте через пробел слово Экспорт (листинг 7.27).
Листинг 7.27. Пустая процедура «НаСервере()»
Процедура НаСервере() Экспорт
 
 
 
КонецПроцедуры
Ключевое слово Экспорт, которое вы здесь использовали, позволяет расширить область видимости этой процедуры. Без него процедура видна только в пределах этого модуля. А с этим словом процедура станет видна и из других модулей вашей конфигурации.
Сохраните изменения в модуле и установите точку останова на строке КонецПроцедуры. Пока вам этот модуль больше не понадобится.
Откройте модуль приложения. Если у вас там остался какой-то текст от предыдущих примеров, можете его удалить – кроме объявления процедуры ПриНачалеРаботыСистемы(), естественно.
Внутри этой процедуры вам нужно вызвать процедуру из общего модуля. Делается это просто. Сначала вы пишете имя общего модуля, а затем, через точку, имя процедуры. Контекстная подсказка вам поможет. В результате у вас получится такая инструкция (листинг 3.21).
Листинг 7.28. Вызов процедуры из общего модуля
Серверный.НаСервере();
Отлично. Теперь у вас все готово для того, чтобы попасть на сервер. Запустите проект в режиме отладки. Вы остановитесь в общем модуле на строке КонецПроцедуры.
Для знакомства с документами вы будете использовать панель Выражения (она расположена рядом с панелью Переменные).
Панель Выражения позволяет вычислять любые выражения, которые могут встретиться в модуле.
Нажмите Добавить выражение, напишите там Документы и нажмите Enter (рис. 7.207).

Рис. 7.207. Свойство «Документы» {https://ai2b.pro/wp-content/uploads/1/07_207.png}

У вас получился объект типа ДокументыМенеджер.

#### Глобальный контекст
Откуда взялось слово Документы, которое вы написали в поле Выражение? И почему нужно было написать именно его?
Тут надо вспомнить про контекст, который вы изучали, когда знакомились с процедурами и функциями. Тогда вы узнали только о локальном контексте модуля, который состоит из переменных, процедур и функций, которые определены в этом модуле. Но кроме локального контекста во встроенном языке «1С:Предприятия» существует еще и глобальный контекст.
Глобальный контекст – это набор свойств, процедур и функций, которые доступны в любых модулях конфигурации. Например, раньше именно благодаря глобальному контексту вы могли использовать функции работы с датой, такие как НачалоДня(), КонецДня(), Дата() и другие.
Весь глобальный контекст описан в синтакс-помощнике в ветке, которая так и называется. В том числе у него есть свойства, и одно из свойств называется Документы. Именно его вы и набрали в поле Выражение (рис. 7.208).

Рис. 7.208. Свойство «Документы» {https://ai2b.pro/wp-content/uploads/1/07_208.png}


#### Менеджеры объектов конфигурации
Итак, для всех классов объектов конфигурации в глобальном контексте есть одноименные свойства: Справочники, Документы, РегистрыСведений, РегистрыНакопления и так далее. Эти свойства возвращают объект, который сам по себе практически никогда не используется. Он содержит в себе коллекцию менеджеров, управляющих конкретными справочниками, документами и так далее.
В панели Выражения раскройте свойство Документы, и вы увидите, что в коллекции есть два элемента: ДокументМенеджер.ПриходнаяНакладная и ДокументМенеджер.ОказаниеУслуги (рис. 7.209).

Рис. 7.209. Менеджеры документов «ПриходнаяНакладная» и «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/07_209.png}

Их два потому, что в вашей конфигурации два документа: ПриходнаяНакладная и ОказаниеУслуги.
Если вы хотите посмотреть, как аналогичная коллекция выглядит у справочников, добавьте еще одно выражение – Справочники (рис. 7.210).

Рис. 7.210. Менеджеры справочников {https://ai2b.pro/wp-content/uploads/1/07_210.png}

Менеджеров справочников будет четыре штуки, потому что в вашей конфигурации четыре справочника.
Теперь перейдите в синтакс-помощник. Посмотрите, как все то же самое выглядит там.
Откройте свойства глобального контекста и щелкните по свойству Документы. Вы увидите его описание (рис. 7.211).

Рис. 7.211. Описание свойства «Документы» {https://ai2b.pro/wp-content/uploads/1/07_211.png}

Это свойство вернет вам объект ДокументыМенеджер. Чтобы узнать, что это за объект, щелкните по гиперссылке на нем (рис. 7.212).

Рис. 7.212. Описание типа «ДокументыМенеджер» {https://ai2b.pro/wp-content/uploads/1/07_212.png}

Тут вы увидите, что этот объект является коллекцией, которая состоит из менеджеров конкретных документов. Чтобы узнать, что за объекты содержатся в этой коллекции, щелкните по гиперссылке на типе элемента коллекции (ДокументМенеджер.<Имя документа>), рис. 7.213.

Рис. 7.213. Описание типа «ДокументМенеджер.<Имя документа> {https://ai2b.pro/wp-content/uploads/1/07_213.png}

Кстати, если вы вернетесь назад (рис. 7.212), то увидите, что у менеджера всех документов в качестве свойства можно указать имя нужного вам объекта конфигурации Документ. Таким образом, чтобы получить менеджер конкретного документа, вам не нужно перебирать всю коллекцию. Можно написать просто Документы.ОказаниеУслуги.
Этот принцип – через свойство глобального контекста получить доступ к менеджеру всех объектов, а затем по имени получить менеджер нужного вам объекта конфигурации – одинаков и для объектных, и для необъектных данных. Различия начнутся дальше.
Поэтому сейчас самостоятельно потренируйтесь еще раз. Посмотрите эту цепочку с помощью панели Выражения. Для справочников, для документов. А затем то же самое посмотрите с помощью синтакс-помощника. Вы должны понимать, как то, что вы видите в панели Выражения, связано с тем, что вы видите в синтакс-помощнике. Это важно.
Чтобы вам было проще, далее следуют несколько картинок. Они помогут вам в самостоятельных упражнениях.

Рис. 7.214. С помощью свойства глобального контекста вы получаете менеджер всех объектов {https://ai2b.pro/wp-content/uploads/1/07_214.png}

Рис. 7.215. Он является коллекцией менеджеров конкретных объектов конфигурации
{https://ai2b.pro/wp-content/uploads/1/07_215.png}

Рис. 7.216. К каждому менеджеру конкретного объекта можно получить доступ по имени этого объекта в 1C:EDT {https://ai2b.pro/wp-content/uploads/1/07_216.png}

Рис. 7.217. Результатом выполнения «Документы.ОказаниеУслуги» является менеджер этого документа {https://ai2b.pro/wp-content/uploads/1/07_217.png}

#### Выборка документов
Чтобы знакомиться с документами дальше, придется написать небольшую программу. Завершите отладку.
Сейчас в общем модуле Серверный в процедуре НаСервере() вы выберете несколько документов. Для этого вам понадобится метод Выбрать(), который хорошо видно на рис. 7.217.
Посмотрите в синтакс-помощнике, что делает метод Выбрать() объекта ДокументМенеджер.<Имя документа>. Ему можно указать несколько параметров, но все они необязательные. Поэтому вы их сейчас использовать не будете. А возвращает он выборку документов. Поэтому вы можете написать так, как показано в листинге 7.29.
Листинг 7.29. Выборка документов
Выборка = Документы.ОказаниеУслуги.Выбрать();
Объект ДокументВыборка.<Имя документа>, который вы таким образом получите, имеет метод Следующий(). Посмотрите его описание в синтакс-помощнике. Метод позволяет обходить всю полученную выборку, и выглядит это так (листинг 7.30). Сделайте этот пример в своей конфигурации.
Листинг 7.30. Обход выборки документов
Выборка = Документы.ОказаниеУслуги.Выбрать();
Пока Выборка.Следующий() Цикл
 
КонецЦикла;
После того как вы получили выборку методом Выбрать(), она не спозиционирована ни на каком своем элементе. Чтобы перейти к первому элементу этой выборки или к следующему элементу, нужно выполнить метод Следующий(). Если первый или следующий элемент получен, метод вернет значение Истина. Если элементов больше нет, метод вернет значение Ложь.
Именно поэтому для обхода выборки используется инструкция Пока Цикл, где на каждой итерации цикла выполняется метод Следующий(). Как только выборка закончится и метод вернет Ложь, выполнение цикла тоже прекратится.
Установите точку останова на строке Пока Выборка.Следующий() Цикл и запустите проект в режиме отладки. Посмотрите, как это работает.
До того как первый раз выполнится метод Следующий(), в объекте выборки нет никаких данных (рис. 7.218).

Рис. 7.218. В объекте выборки нет данных {https://ai2b.pro/wp-content/uploads/1/07_218.png}
Сделайте один шаг. Вы увидите, что в выборке появятся данные одного из документов (рис. 7.219).

Рис. 7.219. В объекте выборки данные документа {https://ai2b.pro/wp-content/uploads/1/07_219.png}
При выполнении метода Выбрать() вы не указывали порядок, в котором нужно выбирать документы. Поэтому неизвестно, в каком порядке они будут появляться, но вам это и не нужно сейчас.
Выборка содержит значения всех свойств документа, а также все его табличные части. К каждой табличной части вы можете обратиться по ее имени.
Объект табличной части содержит коллекцию строк. Каждая строка содержит значения реквизитов, которые есть у табличной части. Содержимое табличной части удобнее смотреть с помощью панели Значения. Она находится в нижней части экрана.
Справа в панели Переменные выделите табличную часть – и внизу, в панели Значения, вы увидите ее содержимое (рис. 7.220).

Рис. 7.220. Табличная часть документа {https://ai2b.pro/wp-content/uploads/1/07_220.png}
Табличная часть – это индексированная коллекция. Поэтому к каждой строке табличной части вы можете обращаться по ее индексу.
Перейдите в панель Выражения и добавьте выражение Выборка.ПереченьНоменклатуры[0] (рис. 7.221). Табличную часть вы получаете по имени (ПереченьНоменклатуры), а дальше по индексу получаете первую ее строку.

Рис. 7.221. Строка табличной части {https://ai2b.pro/wp-content/uploads/1/07_221.png}
Вот таким нехитрым способом, «путешествуя» только с помощью отладчика, вы можете самостоятельно узнать очень многое об устройстве объектов встроенного языка. А после этого недостающую информацию об их методах вы можете получить из синтакс-помощника.
Объекты встроенного языка, описывающие табличную часть и ее строки, одинаковы для всех объектов конфигурации, у которых могут быть табличные части. Поэтому в синтакс-помощнике они описаны в ветке Прикладные объекты > Универсальные объекты > Табличная часть (рис. 7.222).

Рис. 7.222. Типы табличной части в синтакс-помощнике {https://ai2b.pro/wp-content/uploads/1/07_222.png}
Серверный модуль и обработка события ПриНачалеРаботыСистемы вам больше не понадобятся. Поэтому завершите отладку, удалите общий модуль Серверный и очистите модуль приложения.

#### Выборка, ссылка и объект
Итак, теперь вы знаете, как выбрать документы из базы данных и узнать значения их свойств. Для этого используется тип ДокументВыборка.ОказаниеУслуги.
Есть и другой тип, который по своим свойствам очень похож на выборку, –ДокументСсылка.ОказаниеУслуги. Этот тип вы встретите в формах, в тех местах, где пользователь выбрал конкретный документ (как устроена форма, будет рассказано в одном из следующих разделов).
Важным моментом здесь является то, что оба этих типа не позволяют вам изменить данные документа. Они предназначены только для их просмотра.
Если вы хотите изменять данные документа, вам нужно получить значение типа ДокументОбъект.ОказаниеУслуги. Для этого и у выборки, и у ссылки есть метод ПолучитьОбъект().
Дальше вы познакомитесь с этим типом подробнее.

#### События объектов
Если вы думаете, что встроенный язык – это только «для вас», а платформа использует какие-то свои особенные способы работы, то ошибаетесь. Когда в прикладном решении вы открываете документ ОказаниеУслуги, когда нажимаете в нем кнопку Записать и закрыть, платформа использует те же самые прикладные типы, о которых вы уже знаете: ДокументСсылка.ОказаниеУслуги и ДокументОбъект.ОказаниеУслуги. Посмотрите на рисунок 7.223.

Рис. 7.223. Открытие и запись документа {https://ai2b.pro/wp-content/uploads/1/07_223.png}
Когда вы видите на экране список документов ОказаниеУслуги, на самом деле вы видите объект встроенного языка ФормаКлиентскогоПриложения. Когда вы дважды щелкаете мышью по строке этого списка, платформа отправляет на сервер команду о том, что нужно открыть документ ОказаниеУслуги. Какой именно документ нужно открыть, платформа определяет по ссылке на документ (ДокументСсылка.ОказаниеУслуги). Эта ссылка есть в каждой строке списка документов.
Сервер, имея ссылку, читает из базы данных всю информацию, которая относится к этой ссылке. Помещает эту информацию в объект (ДокументОбъект.ОказаниеУслуги). Затем из данных этого объекта платформа создает форму, которая отправляется на клиент.
Вы, например, изменяете в этом документе количество материалов. И нажимаете Записать и закрыть.
Форма отправляется на сервер. Там из ее данных платформа создает объект (ДокументОбъект.ОказаниеУслуги) и записывает его в базу данных.
Теперь вспомните: в самом начале занятий встроенным языком вы узнали о том, что у платформы есть события. Это такие моменты, когда вы можете вмешаться в работу прикладного решения.
В процессе описанных действий происходит большое количество событий. И все эти события связаны не с конфигурацией вообще, а с конкретными объектами встроенного языка. С теми объектами, которые участвуют в этих действиях.
Такой подход очень удобен, потому что исчезает разница между тем, что делает пользователь, и тем, что делаете вы, когда пишете программу. Неважно, в результате чего началась запись документа. Может быть, это пользователь нажал кнопку Записать, может быть, это вы в своей программе написали ДокументОбъект.Записать(). В любом случае у объекта встроенного языка ДокументОбъект.ОказаниеУслуги возникнут события, связанные с записью документа. И если вы в каком-то из этих событий напишете свою программу, то она обязательно выполнится.

#### Процедура проведения документа
Чтобы посмотреть, какие события есть у типа ДокументОбъект.<Имя документа>, откройте описание этого типа в синтакс-помощнике (рис. 7.224).

Рис. 7.224. События типа «ДокументОбъект.<Имя документа> {https://ai2b.pro/wp-content/uploads/1/07_224.png}
Одно из событий, которые могут происходить с объектом документа, – это проведение документа. В синтакс-помощнике это событие называется ОбработкаПроведения. Обработчик этого события уже есть у вашего документа ОказаниеУслуги – вы создавали его с помощью конструктора в занятии № 5 «Движения документа "Оказание услуги"». Сейчас пришло время поговорить о нем подробнее.
Все события, перечисленные на рис. 7.224, вы можете обработать в модуле объекта. Модули объекта есть у всех объектов конфигурации, которые предназначены для работы с объектными данными (справочники, документы и др.).
Для лучшего понимания взгляните на рис. 7.225. В данном случае речь идет об объектах встроенного языка, тип которых содержит в своем названии слово «объект».

Рис. 7.225. Команды «Открыть модуль объекта» и «Открыть модуль менеджера» {https://ai2b.pro/wp-content/uploads/1/07_225.png}
Кстати, тут же находится команда Открыть модуль менеджера. В модуле менеджера вы можете обработать события объекта ДокументМенеджер.<Имя документа>.
Другие объекты конфигурации, которые используются для описания объектных данных, устроены так же. Например, у справочников есть аналогичные команды и аналогичные модули (рис. 7.226).

Рис. 7.226. Команды справочника {https://ai2b.pro/wp-content/uploads/1/07_226.png}
Откройте модуль объекта документа ОказаниеУслуги – и вы увидите процедуру, которая обрабатывает событие ОбработкаПроведения. Эту процедуру автоматически сформировал конструктор движений, но если вы хотите самостоятельно обработать какое-то событие, то для этого в контекстном меню редактора встроенного языка есть команда Добавить обработчик события.
Она открывает диалог, где перечислены все события, которые можно обработать в этом модуле, и, заметьте, событие ОбработкаПроведения выделено серым цветом. Это значит, что обработчик этого события уже есть в модуле (рис. 7.227).

Рис. 7.227. Добавление обработчика события {https://ai2b.pro/wp-content/uploads/1/07_227.png}
Сейчас не нужно добавлять новые обработчики, сейчас ваша задача понять, что написано в обработке проведения. Поэтому установите точку останова на строке Движение.Период = Дата;, запустите проект в режиме отладки, откройте список документов ОказаниеУслуги и проведите единственный документ. Исполнение встроенного языка остановится в модуле документа ОказаниеУслуги.
Перейдите в панель Переменные (рис. 7.228).

Рис. 7.228. Локальный контекст модуля объекта {https://ai2b.pro/wp-content/uploads/1/07_228.png}
Здесь вы видите локальный контекст модуля, то есть те переменные, которые были объявлены в коде программы. Например, Отказ и Режим – это переменные, которые передает в эту процедуру платформа. Они указаны в объявлении процедуры. Движение – это переменная, которая используется в цикле, а ТекСтрокаПереченьНоменклатуры – это итератор цикла, в который каждый раз передается следующее значение из коллекции ПереченьНоменклатуры.
Но откуда взялась в объявлении цикла переменная ПереченьНоменклатуры или что такое переменная Движения строчкой выше, пока непонятно.
Раскройте ветку Свойства модуля (рис. 7.229).
 
Рис. 7.229. Свойства модуля объекта {https://ai2b.pro/wp-content/uploads/1/07_229.png}
Вы уже знаете, что кроме локального контекста модуля существует и глобальный контекст, доступный во всех модулях. Но в модулях объектов присутствует еще и весь контекст того программного объекта, для работы с которым предназначен этот модуль. В данном случае это объект типа ДокументОбъект.ОказаниеУслуги (рис. 7.230).

Рис. 7.230. Контекст объекта документа {https://ai2b.pro/wp-content/uploads/1/07_230.png}
Таким образом, сразу становится понятно, что ПереченьНоменклатуры – это обращение к табличной части документа (<Имя табличной части>), а Клиент, Мастер и Склад – это реквизиты документа (<Имя реквизита>).
Теперь подробнее о свойстве Движения. Одно из основных назначений документа – изменять состояние учета путем создания записей в регистрах. Поэтому для облегчения формирования этих записей в свойстве Движения содержатся готовые пустые наборы данных для каждого регистра, в котором документ может создавать движения (рис. 7.231).

Рис. 7.231. Набор записей регистра «ОстаткиМатериалов» {https://ai2b.pro/wp-content/uploads/1/07_231.png}
У документа ОказаниеУслуги такой регистр один – ОстаткиМатериалов. Если вы раскроете эту ветку, то увидите, что набор записей действительно подготовлен – в нем установлен отбор по документу Оказание услуги № 1, то есть все записи этого набора данных будут относиться именно к этому документу (рис. 7.232).

Рис. 7.232. Отбор по документу {https://ai2b.pro/wp-content/uploads/1/07_232.png}
Поскольку вы остановились в начале первой итерации цикла, то новая запись уже добавлена в этот набор, но значения ее свойств пока не установлены (рис. 7.233).

Рис. 7.233. Новая запись {https://ai2b.pro/wp-content/uploads/1/07_233.png}
Если вы пройдете по шагам до конца тела цикла, то увидите, что все необходимые свойства записи будут заполнены (рис. 7.234).

Рис. 7.234. Запись с заполненными свойствами {https://ai2b.pro/wp-content/uploads/1/07_234.png}
После того как исполнение процедуры ОбработкаПроведения будет закончено, платформа самостоятельно запишет этот набор записей, а свойство Регистратор заполнит тем значением, которое было указано в отборе на рис. 7.232.

Рис. 7.235. Движения документа «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/07_235.png}

#### Как работать с регистрами
Обратите внимание, что в процессе исследования процедуры проведения документа вы познакомились еще и с тем, как работать с необъектными данными – с записями регистра накопления.
Основные типы, которые при этом используются, хорошо видно на рис. 7.234:
РегистрНакопленияНаборЗаписей.<Имя регистра накопления>;
РегистрНакопленияЗапись.<Имя регистра накопления>.
Описание этих типов вы можете посмотреть в синтакс-помощнике.
Если вы захотите где-то самостоятельно записать данные в регистр накопления, то общая последовательность действий такова:
Создать набор записей, например:
НаборЗаписей = РегистрыНакопления.ОстаткиМатериалов.СоздатьНаборЗаписей();
Установить отбор, например по регистратору:
НаборЗаписей.Отбор.Регистратор.Установить(Ссылка);
Заполнить набор записей.
Записать набор записей:
НаборЗаписей.Записать();

### Форма
Последний объект, который вы рассмотрите на этом занятии, – форма. Чаще всего формы используются для просмотра списка объектов или для редактирования данных конкретного объекта. Но есть и множество других форм, например формы отчетов, обработок и др.
Буквально на следующем занятии вы займетесь некоторыми улучшениями форм документов, поэтому сейчас в качестве примера познакомитесь с формой документа ОказаниеУслуги.
Чтобы создать форму в панели Навигатор, нажмите Создать > Форма в контекстном меню документа ОказаниеУслуги. Ничего не меняйте в диалоге и нажмите Готово. 1C:EDT откроет редактор формы, в котором вы увидите форму документа (рис. 7.236).

Рис. 7.236. Форма документа «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/07_236.png}
Сейчас вас будут интересовать лишь несколько самых важных моментов.
Во-первых, форма содержит элементы, которые перечислены в дереве слева вверху. Эти элементы показывают данные документа (значения его реквизитов, значения реквизитов его табличной части) и позволяют пользователю изменять эти данные. Здесь важно понимать, что элементы только показывают данные, но не хранят сами данные. Поэтому, обращаясь к элементам формы, нельзя узнать, какое именно значение содержится в элементе.
У элементов есть события, используя которые, вы можете узнать, например, что пользователь изменил данные в некотором поле. На основании этого вы можете, например, изменить данные в других реквизитах документа.
Во-вторых, сами данные документа, отображаемые в элементах формы, находятся в реквизите формы с именем Объект (справа вверху). В данном случае это тип ДокументОбъект.ОказаниеУслуги, который уже знаком вам по предыдущему разделу. Реквизиты формы доступны в ее модуле по своим именам, поэтому если вы напишете в модуле Объект, то получите доступ к объекту документа.
Каждый элемент формы имеет свойство ПутьКДанным, в котором указано, с каким именно реквизитом формы связан этот элемент (рис. 7.237).

Рис. 7.237. Путь к данным {https://ai2b.pro/wp-content/uploads/1/07_237.png}
Таким образом, если вы обрабатываете событие изменения данных в каком-то элементе, то, чтобы узнать само значение, введенное пользователем, вам нужно обратиться к тому реквизиту формы, данные которого отображает элемент.
В-третьих, есть одно исключение из описанного принципа, оно касается таблицы, в которой отображается табличная часть документа. Таблица содержит несколько строк, и какая из этих строк текущая (какую из них выделил пользователь), известно только в самом элементе формы Таблица. Поэтому за данными, содержащимися в текущей строке таблицы, нужно обращаться не к реквизиту формы, а к элементу Таблица. Для этого у таблицы есть специальное свойство, дальше вы его увидите.
В-четвертых, поскольку это форма, то в ее модуле вам будет доступен контекст (свойства, методы, события) типа ФормаКлиентскогоПриложения. Этот тип описан в синтакс-помощнике в ветке Интерфейс (управляемый) > Форма клиентского приложения > ФормаКлиентскогоПриложения, рис. 7.238.

Рис. 7.238. Тип «ФормаКлиентскогоПриложения» {https://ai2b.pro/wp-content/uploads/1/07_238.png}
Теперь, чтобы исследовать форму «изнутри», создайте обработчик события, которое возникает в тот момент, когда активизируется строка таблицы, отображающей табличную часть документа.
Выделите элемент, содержащий таблицу (ПереченьНоменклатуры), и в контекстном меню нажмите События – <ПриАктивизацииСтроки> (рис. 7.239).

Рис. 7.239. Обработчик события «ПриАктивизацииСтроки» {https://ai2b.pro/wp-content/uploads/1/07_239.png}
Выберите вариант Создать на клиенте и процедуру на сервере. В модуле появятся две процедуры (рис. 7.240).

Рис. 7.240. Модуль формы {https://ai2b.pro/wp-content/uploads/1/07_240.png}
Форма может существовать и в контексте клиента (когда пользователь изменяет данные), и в контексте сервера (когда требуется прочитать данные объекта из базы данных или записать их туда). Поэтому в модуле формы для каждой процедуры отдельно указывается контекст, в котором она должна выполняться.
Активизация строки таблицы происходит на клиенте, поэтому первая процедура имеет директиву компиляции &НаКлиенте. Вторая процедура создана в учебных целях, она исполняется на сервере.
Установите точку останова на строке, в которой вызывается серверная процедура, запустите проект в режиме отладки и откройте документ ОказаниеУслуги № 1. Исполнение встроенного языка остановится в модуле формы документа.
#### Значения, отображаемые в элементах
Сначала изучите, как получить значения, отображаемые в полях формы. Например, в поле Склад. Из рисунка 7.237 вы знаете, что это значение хранится в реквизите Склад реквизита формы Объект. А реквизиты формы доступны прямо в контексте модуля.
Поэтому откройте панель Переменные, раскройте ветку Свойства модуля.
Найдите в ней реквизит Объект. Раскройте его (рис. 7.241).

Рис. 7.241. Реквизит «Объект» {https://ai2b.pro/wp-content/uploads/1/07_241.png}
Вы видите, что он содержит все данные документа, в том числе значение реквизита Склад. В поисках этого реквизита вы забрались не очень глубоко, и понятно, что в модуле нужно будет написать Объект.Склад.
Но бывают более сложные ситуации (вы это увидите прямо сейчас), поэтому воспользуйтесь следующим приемом. То значение, которое вы нашли, добавьте в отслеживаемые выражения (в панель Выражения). Для этого в контекстном меню нажмите Наблюдение (рис. 7.242).

Рис. 7.242. Добавить в панель «Выражения» {https://ai2b.pro/wp-content/uploads/1/07_242.png}
В панели Выражения вы увидите ровно то выражение, которое нужно вставить в модуль, и сможете его скопировать (рис. 7.243)

Рис. 7.243. Панель «Выражения» {https://ai2b.pro/wp-content/uploads/1/07_243.png}

#### Значения, отображаемые в таблице
Теперь рассмотрите случай, который является исключением из общих правил. Например, вам понадобилось узнать значение поля Количество, которое содержится в текущей строке таблицы, отображающей табличную часть документа.
Для этого вам нужно будет обратиться к коллекции элементов формы. Она содержится в свойстве Элементы объекта ФормаКлиентскогоПриложения. А весь контекст этого объекта доступен в модуле формы.
Поэтому в панели Переменные вернитесь в самое начало, в группу Свойства модуля, и найдите в ней свойство Элементы. Раскройте его.
Найдите в нем таблицу, которая отображает табличную часть. Ее имя – ПереченьНоменклатуры. Раскройте ее.
Найдите свойство ТекущиеДанные и раскройте его (рис. 7.244).

Рис. 7.244. Свойство «ТекущиеДанные» {https://ai2b.pro/wp-content/uploads/1/07_244.png}
Например, в модуле вам понадобилось получить количество, которое содержится в текущей строке табличной части. Чтобы не вспоминать весь путь, которым вы сюда попали, добавьте количество в отслеживаемые выражения, как вы уже делали ранее.
В панели Выражения вы увидите строку, которую можете скопировать и вставить в модуль (рис. 7.245).

Рис. 7.245. Панель «Выражения» {https://ai2b.pro/wp-content/uploads/1/07_245.png}

#### Реквизиты ссылочных значений
В заключение рассмотрите особенность форм, которая касается ссылочных значений. В панели Переменные снова вернитесь в самое начало и раскройте ветку Свойства модуля – Объект (рис. 7.246).

Рис. 7.246. Ссылочные значения на клиенте {https://ai2b.pro/wp-content/uploads/1/07_246.png}
Реквизиты документа Склад, Клиент, Мастер имеют тип СправочникСсылка.<Имя реквизита>. Сейчас вы находитесь в клиентской процедуре, и кроме собственно самой ссылки вы не можете получить какую-либо более подробную информацию об этих объектах: ни значения их реквизитов, ни состав их табличных частей.
Теперь выполните один шаг отладки, чтобы перейти в серверную процедуру. Снова откройте ветку Свойства модуля – Объект (рис. 7.247).

Рис. 7.247. Ссылочные значения на сервере {https://ai2b.pro/wp-content/uploads/1/07_247.png}
Ситуация изменилась. Теперь вы находитесь на сервере и вам доступны все реквизиты ссылочных объектов. Например, вы можете раскрыть ветку Мастер, найти табличную часть ТрудоваяДеятельность и посмотреть, где раньше работал Деловой Иван Сергеевич (рис. 7.248).

Рис. 7.248. Ссылочные значения на сервере {https://ai2b.pro/wp-content/uploads/1/07_248.png}
Суть этого примера в следующем. Если вам понадобились какие-либо реквизиты от ссылки, находящейся в форме, за их получением надо обращаться на сервер. Например, в функцию, которая исполняется в контексте сервера.
Обращение на сервер – довольно затратная операция. Поэтому, если по ходу вашего алгоритма требуется несколько таких обращений за разными данными, нужно постараться объединить их в одно, чтобы сразу получить с сервера все необходимые вам данные.

## Занятие 8 (1:30). Дополнительный сервис в формах документа
Продолжительность
Ориентировочная продолжительность занятия – 1 час 30 минут.
На этом занятии вы начнете применять на практике те знания о встроенном языке, которые получили на предыдущем занятии № 7 «Знакомство со встроенным языком».
Вы создадите форму документа ПриходнаяНакладная и опишете в ней нужные вам алгоритмы выполнения тех или иных действий, связанных с работой документа. Также вы отредактируете форму документа ОказаниеУслуги.
Кроме того, на этом занятии вы познакомитесь с новым объектом конфигурации – Макет. Вы узнаете о его назначении и создадите макет документа, на основе которого будет формироваться печатная форма документа.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Теория: механизм основных форм
У всех прикладных объектов конфигурации существует некоторое количество основных форм. Они служат для отображения данных объекта в том или ином виде.
Если разработчик не назначит в качестве основных форм объекта свои собственные, система будет генерировать необходимые формы объекта самостоятельно, в те моменты, когда к ним происходит обращение.
Наличие такого механизма позволяет разработчику не тратить время на создание форм для тестирования своей разработки, а воспользоваться теми, что платформа создаст по умолчанию.
Создание этих форм происходит динамически, в процессе работы системы. Форма создается в тот момент, когда к ней происходит обращение. Причем неважно, интерактивное это обращение или программное.
Так, форма списка для справочника Клиенты будет создана как при интерактивном выборе в меню Оказание услуг > Клиенты, так и при программном вызове глобального метода ПолучитьФорму() (листинг 8.1).
Листинг 8.1. Программный вызов метода «ПолучитьФорму()»
ФормаСписка = ПолучитьФорму("Справочник.Клиенты.ФормаСписка");
Также примечательным является факт, что состав основных форм, определенных для объекта конфигурации, может не совпадать с перечнем тех форм, которые вообще можно создать для данного объекта, используя конструктор форм.
Например, для большинства регистров в их редакторах можно задать основную форму списка (вкладка Формы). Однако если открыть конструктор форм для регистра (Создать > Форма… в контекстном меню), то вы увидите, что кроме формы списка предлагается создать и форму набора записей регистра, которая отсутствует в перечне основных форм.
Дело в том, что состав основных форм определяется исходя из того, какое представление данных может понадобиться в процессе интерактивной работы пользователя. Для этих представлений разработчик может создать свои формы и указать их в качестве основных, а может использовать те формы, которые система создаст автоматически.
Конструктор форм, напротив, исходит из потребностей разработчика. Если разработчик посчитает нужным использовать для какого-либо регистра вместо обычной формы списка форму набора записей, он сможет это сделать, воспользовавшись конструктором и определив ее в качестве основной формы регистра. Но для логики работы системы это не будет иметь принципиального значения.

### Автоматический пересчет суммы в строках документа
Наверняка вы обратили внимание на то, что при заполнении документа ПриходнаяНакладная приходится вводить сумму в каждой строке. Это неудобно, и возникает естественное желание автоматизировать работу документа так, чтобы сумма вычислялась автоматически каждый раз при изменении цены или количества материалов в строке.
Итак, у вас возникла необходимость слегка изменить логику работы формы документа, поэтому вам нужно создать свою собственную форму документа ПриходнаяНакладная, чтобы в ней с помощью встроенного языка описать тот алгоритм, который вам нужен. И система будет использовать вашу форму вместо формы по умолчанию.
#### В 1C:EDT
##### Форма документа
Чтобы создать форму документа ПриходнаяНакладная, в панели Навигатор нажмите Создать > Форма в контекстном меню документа.
Откроется мастер Новая форма. По умолчанию в нем уже выбран тип формы, который вам нужен, – Форма документа – и установлен флажок Назначить форму основной (рис. 8.1).

Рис. 8.1. Мастер создания формы {https://ai2b.pro/wp-content/uploads/1/08_001.png}
Таким образом, вы создаете форму документа ПриходнаяНакладная с именем ФормаДокумента и назначаете эту форму основной. В результате в прикладном решении при любом открытии формы документа (интерактивном или программном) будет открываться уже не автоматически сгенерированная платформой форма, а именно эта форма, которую вы только что создали и в дальнейшем будете дорабатывать.
Нажмите Готово. В результате в панели Навигатор у объекта конфигурации Документ ПриходнаяНакладная в ветке Формы появится форма ФормаДокумента, а в области редакторов откроется редактор формы (рис. 8.2).

Рис. 8.2. Новая форма документа в 1C:EDT {https://ai2b.pro/wp-content/uploads/1/08_002.png}
Редактор формы позволяет вам редактировать структуру элементов формы (на закладке Форма), также вы можете редактировать модуль этой формы на закладке редактора Модуль.
Редактор формы объединяет несколько связанных между собой редакторов: реквизитов, элементов, команд и т. п. Однако в книге будут подробно рассматриваться только те моменты, которые нужны для выполнения простейших действий, связанных с вашим учебным примером.
Пока обратите внимание на область предпросмотра формы документа, расположенную внизу, и область дерева элементов формы, расположенную слева в верхней части редактора формы.
Прежде всего, необходимо понимать, что при разработке форм объектов конфигурации нет необходимости рисовать форму. Достаточно только указать, из каких элементов будет состоять форма, а система уже сама самостоятельно расположит эти элементы в форме.
Элементы формы в верхней левой области редактора образуют иерархическую структуру, из которой следует, что чем выше в списке находится элемент, тем выше и левее он будет располагаться в форме.
Эта структура редактируется на закладке Элементы и позволяет управлять отображением и редактированием данных в форме.
Вы видите, что на основе описания в конфигурации документа ПриходнаяНакладная 1С:EDT создала структуру элементов, которая определяет, как будет выглядеть форма.
Эти элементы имеют разное назначение и разное поведение. Однако все они служат для того, чтобы отображать информацию, хранящуюся в базе данных, и организовывать интерактивную работу с этой информацией.
Вы можете попробовать перетащить мышью поля в дереве элементов и поменять местами, например, реквизиты табличной части. Результат изменений сразу отразится в форме документа в нижней части редактора.
Вы можете через панель Свойства изменить свойства элемента, которые повлияют на его отображение в форме. Вы можете также изменить структуру элементов формы: создать новое поле, группу полей, создать табличную часть, связав эти элементы с данными формы.
Но пока вам ничего этого не нужно делать. Вас интересуют три элемента табличной части: МатериалыКоличество, МатериалыЦена и МатериалыСумма (см. рис. 8.2).
Вам нужно сделать так, чтобы каждый раз, когда меняется значение в поле Количество или в поле Цена, в поле Сумма автоматически устанавливалось бы значение, равное произведению значений полей Количество и Цена.
Очевидно, что для этого нужно написать на встроенном языке команду, похожую на Сумма = Количество * Цена, которая будет выполняться при изменении значения поля Количество или Цена. Но как «поймать» эти моменты изменения?
##### Обработчик события
Поскольку вы хотите организовать пересчет суммы в строке табличной части при изменении количества и цены, очевидно, вам понадобится событие ПриИзменении, которое возникает после изменения значения соответствующих полей формы. Вам нужно создать собственный обработчик этого события, и тогда описанные в нем на встроенном языке алгоритмы будут выполняться при возникновении этого события поля.
Для этого в редакторе формы, в дереве элементов формы, нажмите События в контекстном меню элемента МатериалыКоличество. Вы увидите перечень событий, которые могут быть связаны с этим полем. Выберите <ПриИзменении> (рис. 8.3).

Рис. 8.3. Создание обработчика события «ПриИзменении» поля табличной части «Количество» {https://ai2b.pro/wp-content/uploads/1/08_003.png}
1С:EDT предложит окно для выбора контекста обработчика события, который вы хотите создать (рис. 8.4).

Рис. 8.4. Окно для выбора контекста создаваемого обработчика события {https://ai2b.pro/wp-content/uploads/1/08_004.png}
Оставьте без изменения вариант Создать на клиенте, предложенный по умолчанию. Про тип обработчика события подробно рассказывалось на предыдущем занятии в разделе «Форма».
После этого в модуле формы будет создан шаблон процедуры обработчика этого события, а редактор формы перейдет на закладку Модуль (рис. 8.5).

Рис. 8.5. Шаблон обработчика события «ПриИзменении» поля табличной части «Количество» {https://ai2b.pro/wp-content/uploads/1/08_005.png}
Процедуру обработчика – МатериалыКоличествоПриИзменении() – заполните следующим образом (листинг 8.2).
Листинг 8.2. Процедура «МатериалыКоличествоПриИзменении()»
СтрокаТабличнойЧасти = Элементы.Материалы.ТекущиеДанные;
СтрокаТабличнойЧасти.Сумма = СтрокаТабличнойЧасти.Количество * СтрокаТабличнойЧасти.Цена;
В первой строке процедуры в переменную СтрокаТабличнойЧасти вы помещаете объект, содержащий данные той строки табличной части, которую вам нужно пересчитать.
Поскольку вы находитесь в модуле формы, в нем доступны все свойства и методы объекта встроенного языка ФормаКлиентскогоПриложения. Поэтому вы можете обращаться к ним напрямую. В данном случае после знака равенства вы обращаетесь к коллекции элементов формы, используя одно из свойств объекта ФормаКлиентскогоПриложения – свойство Элементы.
Коллекция элементов формы является объектом встроенного языка ВсеЭлементыФормы, содержащим все элементы формы. То есть это программный аналог корня дерева элементов формы.
Каждый элемент формы можно получить, указав его имя в качестве свойства этого объекта, то есть через точку от него. В данном случае вы обращаетесь к табличной части документа Материалы (Элементы.Материалы).
Табличная часть документа представляет собой объект встроенного языка ТаблицаФормы. Получить ту строку, в которой в настоящее время осуществляется редактирование, можно при помощи свойства этого объекта – ТекущиеДанные (Элементы.Материалы.ТекущиеДанные).
Таким образом, в результате выполнения первой строки процедуры обработчика переменная СтрокаТабличнойЧасти будет содержать объект ДанныеФормыСтруктура. Этот объект содержит данные, находящиеся в текущей строке табличной части документа (Элементы.Материалы.ТекущиеДанные).
Получив этот объект, вы можете обратиться к данным конкретной колонки табличной части, указав имя колонки в качестве свойства объекта. Например, используя обращение СтрокаТабличнойЧасти.Количество, вы получаете число, которое находится в редактируемой строке в колонке Количество.
Таким образом, во второй строке процедуры обработчика вычисляется значение колонки Сумма как произведение значений колонок Количество и Цена.


#### В прикладном решении
Теперь проверьте, как это работает. Запустите проект в режиме отладки, вызовите список документов Приходные накладные и откройте любой из двух созданных вами документов. Если теперь вы поменяете количество в любой строке документа, то сумма в строке будет пересчитана автоматически.

#### Одна процедура для обработки нескольких событий
Итак, вы убедились, что при изменении количества в любой строке документа Приходная накладная сумма в этой строке пересчитывается автоматически.
Замечательно. Но теперь хотелось бы и для поля Цена сделать то же самое. А если заглянуть вперед, то вы увидите, что подобное автоматическое заполнение поля Сумма может вам понадобиться и в других документах.
Поэтому лучше будет поместить расчет суммы в некоторое «общедоступное» место, чтобы разные документы, имеющие аналогичные реквизиты табличной части, могли использовать этот алгоритм.
Для описания таких «общедоступных» мест служат объекты конфигурации Общий модуль, расположенные в ветке Общие > Общие модули. Процедуры и функции, содержащиеся в этих модулях, могут быть доступны для любых объектов конфигурации.
Поэтому вам нужно создать общий модуль и перенести в него вашу процедуру расчета суммы. А в документе просто оставить вызовы этой процедуры из общего модуля.
##### В 1C:EDT
###### Документ «Приходная накладная»
Добавьте объект конфигурации – общий модуль с именем РаботаСДокументами.
Установите в свойствах модуля флажок Клиент (управляемое приложение), а флажок Сервер снимите. Это означает, что экземпляры этого модуля будут скомпилированы в контексте тонкого клиента и в контексте веб-клиента (рис. 8.6).

Рис. 8.6. Свойства общего модуля {https://ai2b.pro/wp-content/uploads/1/08_006.png}
Внесите в модуль следующий текст (листинг 8.3).
Листинг 8.3. Процедура «РассчитатьСумму()»
Процедура РассчитатьСумму(СтрокаТабличнойЧасти) Экспорт
 
СтрокаТабличнойЧасти.Сумма = СтрокаТабличнойЧасти.Количество * СтрокаТабличнойЧасти.Цена;
 
КонецПроцедуры
В процедуру РассчитатьСумму() вы передадите переменную СтрокаТабличнойЧасти, которую вы определили в обработчике события ПриИзменении поля Количество (см. листинг 8.2). Она содержит данные редактируемой строки табличной части документа ПриходнаяНакладная.
Теперь, используя эту переменную, вы можете получить доступ к данным колонок табличной части и рассчитать сумму как произведение цены на количество.
Теперь в модуле вашей формы измените текст обработчика МатериалыКоличествоПриИзменении (листинг 8.4).
Листинг 8.4. Процедура «МатериалыКоличествоПриИзменении()»
&НаКлиенте
Процедура МатериалыКоличествоПриИзменении(Элемент)
 
СтрокаТабличнойЧасти = Элементы.Материалы.ТекущиеДанные;
РаботаСДокументами.РассчитатьСумму(СтрокаТабличнойЧасти);
 
КонецПроцедуры
Изменения в процедуре выделены жирным шрифтом. Как вы видите, первая строка процедуры осталась без изменений. А во второй строке вместо непосредственного расчета суммы вызывается процедура РассчитатьСумму() из общего модуля РаботаСДокументами. В качестве параметра в эту процедуру передается текущая строка табличной части.
Проверьте, как это работает, и убедитесь, что ничего не изменилось.
Теперь осталось и для поля Цена установить такой же обработчик. Так как однажды вы уже написали в модуле формы нужную вам процедуру, вы просто могли бы сопоставить ее также и другому событию другого элемента управления, расположенного в форме. Однако стандарты разработки конфигураций фирмы «1С» не рекомендуют такое решение.
Узнай больше!
Согласно стандартам разработки фирмы «1С» у каждого события должен быть свой обработчик. Если одинаковые действия должны выполняться при изменении разных элементов управления (например, при нажатии нескольких кнопок), то в этом случае следует поступать следующим образом:
– создается отдельная процедура (функция), выполняющая необходимые действия;
– для каждого элемента управления создается отдельный обработчик с именем, назначаемым по умолчанию;
– из каждого обработчика вызывается требуемая процедура (функция).
Поэтому создайте обработчик события ПриИзменении для поля табличной части МатериалыЦена так же, как вы делали это для поля МатериалыКоличество, и повторите в нем вызов процедуры РассчитатьСумму() из общего модуля (листинг 8.5).
Листинг 8.5. Процедура «МатериалыЦенаПриИзменении()»
&НаКлиенте
Процедура МатериалыЦенаПриИзменении(Элемент)
 
СтрокаТабличнойЧасти = Элементы.Материалы.ТекущиеДанные;
РаботаСДокументами.РассчитатьСумму(СтрокаТабличнойЧасти);
 
КонецПроцедуры

###### Документ «Оказание услуги»
Теперь сделайте все то же самое для документа ОказаниеУслуги.
Для этого вам нужно использовать ту форму, которая уже создана у документа ОказаниеУслуги в занятии № 7 (см. раздел «Форма»). Если вы пропустили это занятие, то тогда создайте ее.
Для полей ПереченьНоменклатурыКоличество и ПереченьНоменклатурыЦена создайте обработчики событий ПриИзменении и заполните их следующим образом (листинги 8.6, 8.7).
Листинг 8.6. Процедура «ПереченьНоменклатурыКоличествоПриИзменении()»
&НаКлиенте
Процедура ПереченьНоменклатурыКоличествоПриИзменении(Элемент)
 
СтрокаТабличнойЧасти = Элементы.ПереченьНоменклатуры.ТекущиеДанные;
РаботаСДокументами.РассчитатьСумму(СтрокаТабличнойЧасти);
 
КонецПроцедуры
Листинг 8.7. Процедура «ПереченьНоменклатурыЦенаПриИзменении()»
&НаКлиенте
Процедура ПереченьНоменклатурыЦенаПриИзменении(Элемент)
 
СтрокаТабличнойЧасти = Элементы.ПереченьНоменклатуры.ТекущиеДанные;
РаботаСДокументами.РассчитатьСумму(СтрокаТабличнойЧасти);
 
КонецПроцедуры

##### В прикладном решении
Запустите проект в режиме отладки и убедитесь, что теперь сумма в строках табличной части документов ПриходнаяНакладная и ОказаниеУслуги пересчитывается как при изменении количества, так и при изменении цены.

### Команда перехода к движениям в форме документа
#### В 1C:EDT
Поскольку вы уже создали основную форму документа, вы можете отобразить в ней команду, показывающую движения регистра накопления ОстаткиМатериалов, произведенные тем документом, который отображается в форме.
Этот дополнительный сервис не потребует от вас никакого программирования, однако будет очень полезен. Ведь при реальной работе записей в регистре будет много и будет трудно понять, какие записи относятся к определенному документу.
Чтобы реализовать такую возможность, надо лишь включить видимость команды открытия списка регистра в форме документа на закладке Командный интерфейс.
Для этого в формах документов ПриходнаяНакладная и ОказаниеУслуги перейдите на закладку Командный интерфейс (в левой верхней части редактора формы) и в разделе Панель навигации раскройте группу Перейти. Вы видите там команду Остатки материалов. Эта команда была автоматически помещена в панель навигации формы документа, так как он является регистратором, то есть создает движения в регистре.
Установите флажок в колонке Видимость для этой команды (рис. 8.7). Флажок меняется в два клика: первым кликом активизируете ячейку, вторым кликом – меняете флажок.

Рис. 8.7. Настройка командного интерфейса формы документа {https://ai2b.pro/wp-content/uploads/1/08_007.png}

#### В прикладном решении
Запустите проект в режиме отладки и откройте документ Приходная накладная № 2 (рис. 8.8).

Рис. 8.8. Панель навигации формы документа «Приходная накладная» {https://ai2b.pro/wp-content/uploads/1/08_008.png}
Под заголовком формы документа появилась панель навигации, в которой вы можете переходить к списку записей регистра ОстаткиМатериалов, связанному с документом (рис. 8.9), и обратно к содержимому документа (ссылка Основное).

Рис. 8.9. Переход к регистру накопления из формы документа {https://ai2b.pro/wp-content/uploads/1/08_009.png}
Обратите внимание, что до этого панель навигации в форме приходной накладной была не видна, так как в ней не было отображено ни одной команды.
Аналогично изменится и форма документа Оказание услуги.

### Макет документа. Редактирование макета
Еще одна доработка, которую вы сделаете – предоставите пользователю возможность печати документа непосредственно из его формы.
Для этого вам нужно создать макет печатной формы документа с помощью конструктора печати. А затем, если понадобится, вы сможете отредактировать его, используя встроенный язык.
#### Что такое макет
Объект конфигурации Макет предназначен для хранения различных форм представления данных, которые могут потребоваться каким-либо объектам конфигурации или всему прикладному решению в целом.
Макет может содержать табличный или текстовый документ, двоичные данные, HTML-документ, графическую или географическую схему, схему компоновки данных и другое.
Макеты могут существовать как сами по себе (общие макеты), так и быть подчинены какому-либо объекту конфигурации.
Одно из предназначений макета, подчиненного объекту конфигурации и содержащего табличный документ, – создание печатной формы этого объекта. Создание печатной формы заключается в конструировании ее составных частей – именованных областей, из которых затем «собирается» готовая печатная форма.
Порядок заполнения областей данными и вывода их в итоговую форму описывается при помощи встроенного языка. Печатная форма может включать в себя различные графические объекты: картинки, диаграммы и т. д.
Помимо создания макета «вручную» разработчик может воспользоваться специальным инструментом – конструктором печати, который берет на себя большинство рутинной работы по созданию макета.

#### Макет печатной формы
##### В 1C:EDT
Ваша цель – создать макет печатной формы документа Оказание услуги.
Для этого воспользуйтесь конструктором печати, который сделает большую часть работы за вас.
Чтобы открыть этот конструктор, в панели Навигатор нажмите Конструкторы > Конструктор печати в контекстном меню документа ОказаниеУслуги (рис. 8.10).

Рис. 8.10. Запуск конструктора печати {https://ai2b.pro/wp-content/uploads/1/08_010.png}
На первом шаге конструктора согласитесь, что будет создана новая команда Печать для формирования печатной формы документа. Нажмите Далее (рис. 8.11).

Рис. 8.11. Конструктор печати. Шаг 1 {https://ai2b.pro/wp-content/uploads/1/08_011.png}
На втором шаге нажатием кнопки  укажите, что все реквизиты вашего документа будут отображены в шапке печатной формы. Нажмите Далее (рис. 8.12).

Рис. 8.12. Конструктор печати. Шаг 2 {https://ai2b.pro/wp-content/uploads/1/08_012.png}
На третьем шаге точно так же укажите, что все реквизиты табличной части документа будут отображены в печатной форме. Нажмите Далее (рис. 8.13).

Рис. 8.13. Конструктор печати. Шаг 3 {https://ai2b.pro/wp-content/uploads/1/08_013.png}
На четвертом шаге конструктор предложит сформировать подвал (нижнюю часть) печатной формы. Не нужно ничего указывать (подвал в данном случае вы использовать не будете). Нажмите Далее и перейдите к пятому шагу (рис. 8.14).

Рис. 8.14. Конструктор печати. Шаг 5 {https://ai2b.pro/wp-content/uploads/1/08_014.png}
Здесь ничего изменять не нужно. Тем самым вы согласитесь с тем, что команда для вызова процедуры формирования печатной формы будет помещена в командную панель формы, в раздел Важное. Нажмите Готово.
В области редакторов откроются модуль команды Печать, модуль менеджера документа ОказаниеУслуги и макет этого документа (рис. 8.15).

Рис. 8.15. Макет документа «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/08_015.png}
Вы, конечно, могли бы создать макет печатной формы с нуля и для ее вывода создать соответствующую команду и кнопку в форме документа, но в данном случае всю работу сделал за вас конструктор печати. В результате:
Создан макет печатной формы документа ОказаниеУслуги с именем Печать.
Создана команда документа ОказаниеУслуги с именем Печать. В модуль этой команды помещен обработчик, вызывающий процедуру печати документа, выполняющуюся на сервере. Сама процедура печати помещена в модуль менеджера документа ОказаниеУслуги (рис. 8.16).

Рис. 8.16. Структура документа «Оказание услуги» в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/08_016.png}
В командную панель формы документа ОказаниеУслуги помещена команда Печать для формирования печатной формы документа (рис. 8.17).

Рис. 8.17. Макет документа «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/08_017.png}
Причем, поскольку команда Печать принадлежит документу ОказаниеУслуги в целом, а не конкретной его форме, эту команду можно будет помещать в любую форму, созданную для документа.
В будущем вы будете самостоятельно создавать процедуры обработчиков команд и размещать соответствующие им кнопки в форме, но пока воспользуйтесь результатами работы конструктора печати и проверьте макет в работе.

##### В прикладном решении
Запустите проект в режиме отладки и откройте документ Оказание услуги № 1. Обратите внимание, что в командной панели документа появилась новая кнопка Печать (рис. 8.18).

Рис. 8.18. Форма документа «Оказание услуги» с новой кнопкой «Печать» {https://ai2b.pro/wp-content/uploads/1/08_018.png}
Кнопка Печать добавилась также и в командную панель формы списка документов Оказание услуги. Поэтому распечатать документ можно, не открывая его, а просто выделив в списке и нажав кнопку Печать.
Нажмите эту кнопку (в форме списка или в форме документа). Вы увидите печатную форму вашего документа (рис. 8.19).

Рис. 8.19. Печатная форма документа «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/08_019.png}
Как видите, конструктор сформировал вполне подходящую печатную форму для вашего документа. Единственное, чего не хватает в данной форме, это итоговой суммы документа.
В следующем разделе на примере добавления итоговой суммы документа вы познакомитесь с тем, как можно редактировать макеты и формы объектов конфигурации.

#### Редактирование макета
##### В 1C:EDT
Прежде всего добавьте итоговую сумму в печатную форму документа ОказаниеУслуги.
Откройте редактор макета Печать на закладке Макет.
Как видите, макет документа состоит из именованных областей, которые в определенном порядке выводятся на печать.
Те именованные области, которые вы видите слева («Заголовок», «Шапка» и др.), были созданы с помощью конструктора. Но вы можете самостоятельно создавать или удалять области, переименовывать их и т. п.
Добавьте новую область для вывода итоговой суммы документа. Для этого выделите мышью две пустые строки под табличной частью документа и нажмите Таблица > Имена > Назначить имя… в главном меню 1С:EDT (рис. 8.20).

Рис. 8.20. Создание области ячеек для вывода итоговой строки {https://ai2b.pro/wp-content/uploads/1/08_020.png}
Назовите область Всего и нажмите ОК.
Чтобы формат добавленных вами строк совпадал с имеющимся форматом заголовка и табличной части документа, измените ширину колонок.
Для этого потяните мышью в заголовке таблицы за правую границу колонки 2 так, чтобы ее ширина совпала с шириной колонки № в шапке таблицы документа. Отпустите мышь.
Платформа предложит создать новый формат для выделенных строк. Согласитесь. Аналогичные действия выполните и для колонок 3, 4, 5 и 6.
В созданной области в колонке Цена напишите ВСЕГО, а в колонке Сумма напишите ВсегоПоДокументу (рис. 8.21).

Рис. 8.21. Создание ячеек для вывода итога {https://ai2b.pro/wp-content/uploads/1/08_021.png}
В свойстве Заполнение ячейки ВсегоПоДокументу укажите, что в этой ячейке будет находиться не текст, а параметр (рис. 8.22).

Рис. 8.22. Свойства ячейки «ВсегоПоДокументу» {https://ai2b.pro/wp-content/uploads/1/08_022.png}
Каждая ячейка редактируемого вами табличного документа может содержать либо текст, либо некоторый параметр, либо шаблон.
Текст, содержащийся в ячейке, будет показан на экране.
Параметр будет заменен некоторым значением, которое может быть присвоено ему средствами встроенного языка. Текст, содержащийся в ячейке, является именем этого параметра.
Шаблон представляет собой текстовую строку, в определенные места которой будут вставлены значения параметров.
Поэтому, указав для ячейки в качестве заполнения Параметр, вы определили параметр области с именем ВсегоПоДокументу, которому будет присвоено определенное значение при формировании печатной формы.
Откройте модуль менеджера документа ОказаниеУслуги.
Найдите в нем процедуру Печать() (созданную конструктором) и отредактируйте ее следующим образом (новые строки выделены жирным шрифтом) – листинг 8.8.
Листинг 8.8. Печать формы документа (фрагмент)
ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
Шапка = Макет.ПолучитьОбласть("Шапка");
ОбластьПереченьНоменклатурыШапка = Макет.ПолучитьОбласть("ПереченьНоменклатурыШапка");
ОбластьПереченьНоменклатуры = Макет.ПолучитьОбласть("ПереченьНоменклатуры");
ОбластьИтог = Макет.ПолучитьОбласть("Всего");
 
ТабДок.Очистить();
 
ВставлятьРазделительСтраниц = Ложь;
Пока Выборка.Следующий() Цикл
Если ВставлятьРазделительСтраниц Тогда
ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
КонецЕсли;
 
ТабДок.Вывести(ОбластьЗаголовок);
 
Шапка.Параметры.Заполнить(Выборка);
ТабДок.Вывести(Шапка, Выборка.Уровень());
 
ТабДок.Вывести(ОбластьПереченьНоменклатурыШапка);
ВыборкаПереченьНоменклатуры = Выборка.ПереченьНоменклатуры.Выбрать();
СуммаИтог = 0;
Пока ВыборкаПереченьНоменклатуры.Следующий() Цикл
ОбластьПереченьНоменклатуры.Параметры.Заполнить(ВыборкаПереченьНоменклатуры);
ТабДок.Вывести(ОбластьПереченьНоменклатуры, ВыборкаПереченьНоменклатуры.Уровень());
СуммаИтог = СуммаИтог + ВыборкаПереченьНоменклатуры.Сумма;
КонецЦикла;
 
ОбластьИтог.Параметры.ВсегоПоДокументу = СуммаИтог;
ТабДок.Вывести(ОбластьИтог);
 
ВставлятьРазделительСтраниц = Истина;
КонецЦикла;
…
Смысл добавленного фрагмента прост. Вы обращаетесь к макету документа ОказаниеУслуги по его имени – Макет.
Используя его метод ПолучитьОбласть(), получаете область Всего (ту, которую вы только что добавили к макету) и сохраняете ее в переменной ОбластьИтог.
В цикле обхода строк табличной части документа, полученных в результате выполнения запроса, вы накапливаете в переменной СуммаИтог значение суммы табличной части документа по колонке Сумма.
Затем вы обращаетесь к параметру ВсегоПоДокументу (ОбластьИтог.Параметры.ВсегоПоДокументу), находящемуся в области Всего, и присваиваете ему значение переменной СуммаИтог.
В заключение вы выводите итоговую область в табличный документ, который будет показан на экране и распечатан пользователем, – ТабДок.Вывести(ОбластьИтог).
Отображение табличного документа на экране выполняется в обработчике команды Печать, в модуле этой команды на клиенте, в то время как сама процедура заполнения печатной формы данными, описанная в модуле менеджера документа, выполняется на сервере.
##### В прикладном решении
Запустите проект в режиме отладки, откройте документ Оказание услуги № 1 и проверьте результат ваших изменений (рис. 8.23).

Рис. 8.23. Печатная форма документа «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/08_023.png}
Подобным образом, создавая именованные области и ячейки макета, используя их свойства и управляя порядком их вывода c помощью встроенного языка, вы можете создать печатную форму любого дизайна.


## Занятие 9 (0:50). Периодические регистры сведений
Продолжительность
Ориентировочная продолжительность занятия – 50 минут.
На этом занятии вы познакомитесь с объектом конфигурации Регистр сведений, а точнее, с одним из его видов – периодическим регистром сведений. Вы узнаете, для чего предназначен этот объект конфигурации и какова его структура.
Вы создадите периодический регистр сведений, который будет использоваться в вашей конфигурации, и узнаете, каким образом можно получать из него данные средствами встроенного языка.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Зачем нужен периодический регистр сведений
Сначала еще раз обратите ваше внимание на документ Оказание услуги. Как вы помните, в этом документе после выбора материала в табличной части нужно указать его цену.
В ООО «На все руки мастер» существует перечень материалов, который хранится в справочнике Номенклатура. Казалось бы, стоимость материала является его неотъемлемым свойством, и поэтому ее следует добавить в качестве реквизита справочника.
Однако стоимость материалов имеет особенность меняться со временем. И может сложиться такая ситуация, когда вам потребуется внести изменения или уточнения в один из ранее проведенных документов Оказание услуги. В этом случае вы не сможете получить правильную стоимость материала, поскольку в реквизите справочника будет храниться последнее введенное значение.
Кроме того, не исключено, что руководство ООО «На все руки мастер» пожелает видеть зависимость прибыли предприятия от изменения стоимости материалов, израсходованных на услуги, оказываемые предприятием. И тогда просто необходимо будет иметь возможность анализировать изменение стоимости материалов во времени.
Поэтому для хранения стоимости материалов вы будете использовать новый пока еще для вас объект – Регистр сведений.

### Что такое регистр сведений
Объект конфигурации Регистр сведений предназначен для описания структуры хранения данных в разрезе нескольких измерений. На основе объекта конфигурации Регистр сведений платформа создает в базе данных таблицу, в которой может храниться произвольная информация, «привязанная» к набору измерений (рис. 9.1).

Рис. 9.1. Независимый периодический регистр сведений «Цены» в 1C:EDT, в прикладном решении и в базе данных {https://ai2b.pro/wp-content/uploads/1/09_001.png}

Принципиальное отличие регистра сведений от регистра накопления заключается в том, что каждое движение регистра сведений устанавливает новое значение ресурса, в то время как движение регистра накопления изменяет существующее значение ресурса. По этой причине регистр сведений может хранить любые данные (а не только числовые, как регистр накопления).
Следующей важной особенностью регистра сведений является его способность (при необходимости) хранить данные с привязкой ко времени. Благодаря этому регистр сведений может хранить не только актуальные значения данных, но и историю их изменения во времени. Регистр сведений, использующий привязку ко времени, называют периодическим регистром сведений.
Периодичность регистра сведений можно определить одним из следующих значений:
в пределах секунды;
в пределах дня;
в пределах месяца;
в пределах квартала;
в пределах года;
в пределах регистратора (если установлен режим записи Подчинение регистратору).
Периодический регистр сведений всегда содержит служебное поле Период, добавляемое системой автоматически. Оно имеет тип Дата и служит для указания факта принадлежности записи к какому-либо периоду. При записи данных в регистр платформа всегда приводит значение этого поля к началу того периода, в который он попадает.
Например, если в регистр сведений с периодичностью в пределах месяца записать данные, в которых период указан как 08.10.2022, то регистр сохранит эти данные со значением периода, равным 01.10.2022.
Как и для других регистров, система контролирует уникальность записей для регистра сведений. Однако если для прочих регистров уникальным идентификатором записи является регистратор и номер строки, то для регистра сведений применяется другой принцип формирования ключевого значения.
Ключом записи, однозначно идентифицирующим запись, является в данном случае совокупность значений измерений регистра и периода (в случае если регистр сведений периодический). Например, для периодического регистра сведений с измерением Товар и ресурсом Цена (рис. 9.1) ключом записи будет набор значений полей Период и Товар. Регистр сведений не может содержать несколько записей с одинаковыми ключами.
Если продолжать сравнение с регистром накопления, то можно сказать, что регистр сведений предоставляет больше свободы в редактировании хранимых данных. Наряду с возможностью использования в режиме подчинения регистратору (когда записи регистра сведений «привязаны» к документу-регистратору) регистр сведений может применяться и в независимом режиме, в котором пользователю предоставляется полная свобода интерактивной работы с данными регистра. Регистр сведений, не использующий подчинение регистратору, называют независимым регистром сведений.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с регистрами сведений, можно прочитать в разделе «Краткий справочник разработчика. Регистры сведений».

### Создание периодического регистра сведений
Итак, для продолжения вашего учебного примера вам понадобится периодический регистр сведений, который будет хранить развернутые во времени розничные цены материалов, израсходованных на услуги, оказываемые ООО «На все руки мастер».

#### В 1C:EDT
Добавьте объект конфигурации – регистр сведений с именем Цены.
Установите свойство регистра Периодичность – Секунда.
Такая периодичность нужна для того, чтобы иметь возможность отслеживать цены несколько раз в течение дня. Если же так часто изменять цены не предполагается, то можно выбрать, вообще говоря, периодичность День.
Задайте свойство регистра Представление записи как Цена, а Представление списка как Цены на номенклатуру.
Обратите внимание на свойство Режим записи. По умолчанию оно имеет значение Независимый, то есть вы создаете независимый регистр сведений и сможете в дальнейшем вводить в него данные без использования регистратора, вручную.
По логике конфигурации данный регистр должен быть доступен в разделах Учет материалов, Оказание услуг и Бухгалтерия. Поэтому включите регистр в эти подсистемы.
##### Измерения и ресурсы
Теперь создайте измерения и ресурсы регистра аналогично другим подчиненным объектам конфигурации.
Создайте измерение Номенклатура с типом СправочникСсылка.Номенклатура. Укажите, что это измерение будет ведущим (установите флажок Ведущее).
Свойство Ведущее имеет смысл использовать лишь тогда, когда измерение имеет тип ссылки на объект базы данных. Установка свойства Ведущее будет говорить о том, что запись регистра сведений представляет интерес, пока существует тот объект, ссылка на который выбрана в качестве значения этого измерения в этой записи. При удалении объекта все записи регистра сведений по этому объекту тоже будут автоматически удалены.
Также в результате того, что это измерение регистра вы сделали ведущим, в форме элемента справочника Номенклатура, в панели навигации, в группе Перейти появится ссылка. По ней возможен переход к записям этого регистра, которые содержат в измерении Номенклатура ссылку на этот элемент справочника.
Затем создайте ресурс Цена – тип Число, длина 15, точность 2, неотрицательное.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите, как работает ваш периодический регистр сведений Цены.
Вы видите, что в разделах Бухгалтерия, Оказание услуг и Учет материалов появилась команда для открытия списка регистра Цены на номенклатуру (рис. 9.2).

Рис. 9.2. Команда для открытия периодического регистра сведений «Цены» {https://ai2b.pro/wp-content/uploads/1/09_002.png}
Команда для открытия регистра сведений по умолчанию доступна в интерфейсе разделов, в которых отображается регистр, так как в отличие от регистров накопления предполагается изменение данных регистра пользователем. Поэтому вам не пришлось включать ее видимость в командном интерфейсе подсистем.

##### Создание записей в регистре сведений
Откройте список регистра сведений и нажмите Создать.
Задайте стоимость материалов, как показано на рис. 9.3. При этом период задайте задним числом, так как он должен быть меньше или равен дате создания документа об оказании услуг, в вашем случае 15.10.2022.

Рис. 9.3. Цены на материалы в регистре сведений «Цены» {https://ai2b.pro/wp-content/uploads/1/09_003.png}
Итак, вы имеете очень полезную возможность – устанавливать цены на материалы. Поскольку цены хранятся с привязкой к дате, вы можете заранее установить новые цены и быть уверены в том, что новые цены вступят в действие не раньше указанного для них времени.

### Автоматическая подстановка цены в документ при выборе номенклатуры
Теперь с помощью встроенного языка вы можете реализовать следующую полезную возможность.
Цена номенклатуры теперь хранится в отдельном регистре сведений. Когда вы создаете или изменяете документ ОказаниеУслуги и добавляете в табличную часть какую-либо номенклатуру, было бы удобно, чтобы одновременно с этим в документ подставлялась бы сразу и актуальная цена этой номенклатуры, полученная из регистра сведений и соответствующая дате документа.
Для этого вам нужно сделать две вещи.
Сначала написать некую функцию, которая будет возвращать актуальную цену номенклатуры из регистра сведений, а затем вызвать эту функцию в тот момент, когда в документ добавляется номенклатура, и подставить в документ цену номенклатуры, которую вернет эта функция.
Поскольку такой сервис понадобится вам, скорее всего, не только в этом, но и в других документах, которые содержат в табличной части номенклатуру, поместите функцию в некоторое общедоступное место – в общий модуль.
#### В 1C:EDT
##### Функция, возвращающая цену номенклатуры
Сначала вы создадите функцию РозничнаяЦена(), которая будет возвращать вам актуальную розничную цену номенклатуры, и поместите ее в общий модуль конфигурации.
Добавьте объект конфигурации – общий модуль с именем РаботаСоСправочниками.
В панели Свойства у этого модуля по умолчанию установлен флажок Сервер. Это означает, что экземпляры этого модуля будут скомпилированы только на стороне сервера. Кроме этого установите флажок Вызов сервера, для того чтобы экспортные процедуры и функции этого модуля можно было вызывать с клиента.
Поместите в модуль следующий текст (листинг 9.1).
Листинг 9.1. Функция «РозничнаяЦена()»
Функция РозничнаяЦена(АктуальнаяДата, ЭлементНоменклатуры) Экспорт
 
// Создать вспомогательный объект "Отбор".
Отбор = Новый Структура("Номенклатура", ЭлементНоменклатуры);
 
// Получить актуальные значения ресурсов регистра.
ЗначенияРесурсов = РегистрыСведений.Цены.ПолучитьПоследнее(АктуальнаяДата, Отбор);
 
Возврат ЗначенияРесурсов.Цена;
 
КонецФункции
Для получения розничной цены вы будете передавать в функцию два параметра:
АктуальнаяДата – параметр типа Дата, определяет точку на оси времени, в которой вас интересует значение розничной цены;
ЭлементНоменклатуры – ссылка на элемент справочника Номенклатура, для которого вы хотите получить розничную цену.
В теле функции вы сначала создаете вспомогательный объект Отбор.
Это структура, содержащая отбор по измерениям регистра. С его помощью вы определяете, что вас будут интересовать записи регистра, в которых измерение регистра Номенклатура равно переданной в функцию ссылке на элемент справочника.
Имя ключа структуры (Номенклатура) должно совпадать с именем измерения регистра, заданного в 1C:EDT, а значение элемента структуры (ЭлементНоменклатуры) задает отбираемое по данному измерению значение.
Во второй строке вы обращаетесь к менеджеру регистра сведений Цены (РегистрыСведений.Цены) и выполняете метод ПолучитьПоследнее(), который возвращает вам значения ресурсов самой поздней записи регистра, соответствующей передаваемой в функцию дате (АктуальнаяДата) и значениям измерений регистра (Отбор).
Метод ПолучитьПоследнее() возвращает структуру, содержащую значения ресурсов, которая сохраняется в переменной ЗначенияРесурсов. Вообще говоря, у регистра может быть несколько ресурсов. В вашем регистре ресурс один, но все равно будет возвращена структура, содержащая единственный элемент.
Поэтому в следующей строке вы получаете искомую розничную цену, просто указав имя нужного вам ресурса регистра через точку (ЗначенияРесурсов.Цена), и возвращаете ее при выполнении функции.
Теперь эту функцию нужно вызвать в некоторый момент работы документа.

##### Вызов функции при выборе номенклатуры и заполнение цены в документе
Итак, задача, которая перед вами стоит, заключается в следующем. При редактировании документа ОказаниеУслуги вам необходимо обеспечить автоматическое заполнение поля Цена, после того как пользователь выберет материал. Причем цена материала должна определяться исходя из даты создаваемого документа.
Откройте форму ФормаДокумента документа ОказаниеУслуги.
Создайте обработчик события ПриИзменении, выполняющийся на клиенте, для поля табличной части ПереченьНоменклатурыНоменклатура так же, как вы делали это для поля ПереченьНоменклатурыКоличество, ПереченьНоменклатурыЦена в предыдущем занятии, и заполните его следующим образом (листинг 9.2).
Листинг 9.2. Процедура «ПереченьНоменклатурыНоменклатураПриИзменении()»
// Получить текущую строку табличной части.
СтрокаТабличнойЧасти = Элементы.ПереченьНоменклатуры.ТекущиеДанные;
 
// Установить цену.
СтрокаТабличнойЧасти.Цена = РаботаСоСправочниками.РозничнаяЦена(Объект.Дата, СтрокаТабличнойЧасти.Номенклатура);
 
// Пересчитать сумму строки.
РаботаСДокументами.РассчитатьСумму(СтрокаТабличнойЧасти);
Первая строка обработчика вам уже знакома по процедурам ПереченьНоменклатурыКоличествоПриИзменении() и ПереченьНоменклатурыЦенаПриИзменении(). Сначала вы получаете текущую строку табличной части документа, так как она вам понадобится в дальнейшем, и сохраняете ее в переменной СтрокаТабличнойЧасти.
Затем вы вызываете вашу функцию РозничнаяЦена() из общего модуля РаботаСоСправочниками.
Первым параметром в эту функцию передается дата документа, на которую необходимо получить цену. Дату документа вы получаете из основного реквизита формы – Объект.Дата.
Вторым параметром передается ссылка на элемент справочника Номенклатура, который содержится в текущей строке табличной части документа (СтрокаТабличнойЧасти.Номенклатура).
Функция возвращает последнее значение цены, и это значение вы присваиваете полю Цена в текущей строке табличной части документа (СтрокаТабличнойЧасти.Цена).
Затем вы вызываете процедуру РассчитатьСумму() из общего модуля РаботаСДокументами. Эту процедуру вы создали на предыдущем занятии для того, чтобы при изменении цены или количества в документе пересчитывать сумму в строке документа.
Заметьте, что сама процедура ПереченьНоменклатурыНоменклатураПриИзменении() начинает работать в модуле формы на стороне клиента, так как это обработчик интерактивного события формы.
Затем вызывается функция РозничнаяЦена(). Поскольку эта функция не будет найдена на стороне клиента, исполнение будет передано в общий модуль РаботаСоСправочниками, который выполняется на сервере. После завершения функции программный код продолжит исполняться на клиенте.

#### В прикладном решении
Теперь проверьте, как работает ваш документ.
Запустите проект в режиме отладки и откройте регистр сведений Цены.
Для транзистора Philips добавьте новую цену другим числом (рис. 9.4).

Рис. 9.4. Регистр сведений «Цены» {https://ai2b.pro/wp-content/uploads/1/09_004.png}
Теперь откройте документ Оказание услуги № 1. Как вы помните, этим документом вы как раз «израсходовали» один такой транзистор.
Оставьте дату документа без изменения и повторите выбор транзистора в колонке Номенклатура табличной части документа. Автоматически установится значение цены транзистора от 15.10.2022. Это последнее значение цены на дату документа (рис. 9.5).

Рис. 9.5. Заполнение документа «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/09_005.png}
Теперь измените дату документа на 01.11.2022 и снова повторите выбор транзистора. Будет установлено новое значение цены, последнее на эту дату (рис. 9.6).

Рис. 9.6. Заполнение документа «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/09_006.png}
Таким образом, в документе появилась актуальная на момент создания документа цена материала.
Закройте документ не сохраняя изменения.



##Занятие 10 (0:40). Перечисления
Продолжительность
Ориентировочная продолжительность занятия – 40 минут.
До сих пор на предприятии ООО «На все руки мастер» автоматизировали только складской учет – приход и расход материалов. Стоимость оказанных услуг бухгалтерия учитывала отдельно. Но теперь руководство решило, что вся финансовая информация должна учитываться в вашей программе, поэтому вам нужно добавить услуги в справочник Номенклатура.
«Для порядка» лучше разложить все элементы справочника по смысловым группам: Материалы и Услуги. Однако это само по себе не может определять принадлежность элемента справочника к материалам или к услугам, поскольку группы можно удалить, переименовать, сгруппировать элементы по другим принципам и т. п.
Поэтому на этом занятии вы создадите у справочника Номенклатура специальный реквизит, тип значения которого образуется новым пока еще для вас объектом конфигурации Перечисление. Это поможет вам в дальнейшем легко определять, чем является элемент справочника Номенклатура: услугой или материалом.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Что такое перечисление
Объект конфигурации Перечисление предназначен для описания структуры хранения постоянных наборов значений, не изменяемых в процессе работы конфигурации. На основе объекта конфигурации Перечисление платформа создает в базе данных таблицу, в которой может храниться набор некоторых постоянных значений.
В реальной жизни этому объекту может соответствовать, например, перечисление вариантов указания цены («включая НДС», «без НДС»). Набор всех возможных значений, которые содержит перечисление, задается при конфигурировании прикладного решения, и пользователь не может изменять их, удалять или добавлять новые.
Из этого следует важная особенность перечисления: значения перечисления не «обезличены» для конфигурации, на них могут опираться алгоритмы работы программы.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с перечислениями, можно прочитать в разделе «Краткий справочник разработчика. Перечисления».

### Создание перечисления
Добавьте объект конфигурации – перечисление с именем ВидыНоменклатуры.
Создайте два значения перечисления: Материал и Услуга.

### Привязка номенклатуры к значениям перечисления «ВидНоменклатуры»
Чтобы привязать номенклатуру к значениям перечисления, вы должны сделать следующее:
в 1С:EDT у справочника Номенклатура создать реквизит, который будет хранить значение перечисления;
в прикладном решении проставить нужные значения этого реквизита для всех элементов справочника Номенклатура.
#### В 1C:EDT
Поскольку справочник Номенклатура будет содержать не только материалы, но и услуги, измените свойство Представление объекта этого справочника на Материал/Услуга, а свойство Синоним стандартного реквизита Родитель измените на Группа материалов/услуг.
Создайте у справочника новый реквизит ВидНоменклатуры с типом ПеречислениеСсылка.ВидыНоменклатуры (рис. 10.1).

Рис. 10.1. Реквизит «ВидНоменклатуры» справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/10_01.png}


#### В прикладном решении
После этого запустите проект в режиме отладки.
Добавьте услуги в справочник Номенклатура. Поскольку там уже содержатся материалы, сначала в корне справочника создайте две группы: Материалы и Услуги. Перетащите две группы материалов (Прочее и Радиодетали) внутрь группы Материалы. В группе Услуги создайте две подгруппы: Телевизоры и Стиральные машины.
В группу Телевизоры внесите услуги: Диагностика, Ремонт отечественного телевизора, Ремонт импортного телевизора. Задайте для них значение реквизита Вид номенклатуры как Услуга (рис. 10.2).

Рис. 10.2. Ввод услуг в справочник «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/10_02.png}
В группу Стиральные машины внесите услуги: Подключение воды, Подключение электричества. Задайте для них значение реквизита Вид номенклатуры как Услуга.
Для всех материалов задайте значение реквизита Вид номенклатуры как Материал. В результате данные в справочнике Номенклатура будут выглядеть следующим образом (рис. 10.3).

Рис. 10.3. Данные справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/10_03.png}


### Произвольное представление номенклатуры
Теперь, используя реквизит Вид номенклатуры, задайте произвольное представление номенклатуры в интерфейсе прикладного решения.
Представление номенклатуры используется везде, где отображаются поля, ссылающиеся на элементы справочника Номенклатура. Такие поля вы видите в табличной части ваших документов, в регистре сведений, в регистре накопления и т. д.
Стандартное представление номенклатуры (как и любого другого элемента справочника) определяется свойством справочника Основное представление. По умолчанию это свойство установлено в значение В виде наименования (рис. 10.4).

Рис. 10.4. Свойство справочника «Основное представление» {https://ai2b.pro/wp-content/uploads/1/10_04.png}
Поэтому, например, в табличной части документов в колонке Номенклатура вы видите не ссылку на номенклатуру, а ее наименование (рис. 10.5).

Рис. 10.5. Документ «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/10_05.png}
Было бы удобно, чтобы при отображении ссылок на номенклатуру в интерфейсе прикладного решения рядом с наименованием номенклатуры показывался бы и ее вид (материал или услуга). Выполните это изменение.
#### В 1C:EDT
Механизм формирования представления объекта конфигурации состоит из двух этапов: определение реквизитов, участвующих в формировании представления, и собственно формирование представления. Для этого используются обработчики событий ОбработкаПолученияПолейПредставления и ОбработкаПолученияПредставления менеджера соответствующего объекта.
Откройте модуль менеджера справочника Номенклатура. Пока он пустой. Нажмите Добавить обработчик события в контекстном меню (рис. 10.6).

Рис. 10.6. Создание обработчика события в модуле менеджера справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/10_06.png}
Вы увидите список событий, для которых вы можете создать обработчики в модуле менеджера. При выделении события в нижней части окна показывается синтаксическая подсказка для этого события (рис. 10.7).

Рис. 10.7. Создание обработчика события в модуле менеджера справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/10_07.png}
Выберите ОбработкаПолученияПолейПредставления() и нажмите ОК. В результате в модуле менеджера появится объявление процедуры обработчика события. Заполните его следующим образом (листинг 10.1).
Листинг 10.1. Процедура «ОбработкаПолученияПолейПредставления()»
Процедура ОбработкаПолученияПолейПредставления(Поля, СтандартнаяОбработка)
 
СтандартнаяОбработка = Ложь;
Поля.Добавить("Наименование");
Поля.Добавить("ВидНоменклатуры");
 
КонецПроцедуры
Таким же образом создайте обработчик события ОбработкаПолученияПредставления() и заполните его следующим образом (листинг 10.2).
Листинг 10.2. Процедура «ОбработкаПолученияПредставления()»
Процедура ОбработкаПолученияПредставления(Данные, Представление, СтандартнаяОбработка)
 
СтандартнаяОбработка = Ложь;
Если ЗначениеЗаполнено(Данные.ВидНоменклатуры) Тогда
Представление = Данные.Наименование + " (" + НРег(Строка(Данные.ВидНоменклатуры)) + ")";
 
Иначе
Представление = Данные.Наименование;
 
КонецЕсли;
 
КонецПроцедуры
В обработчике события ОбработкаПолученияПолейПредставления вы описываете, какие реквизиты будут участвовать в формировании представления документа. Для этого сначала вы устанавливаете параметр СтандартнаяОбработка в значение Ложь, а затем добавляете в массив Поля нужные реквизиты справочника. Если параметр СтандартнаяОбработка в обработчике не установлен в значение Ложь, то массив Поля будет заполнен именами реквизитов, используемыми для формирования стандартного представления данного объекта (в данном случае это Наименование и ВидНоменклатуры).
В обработчике события ОбработкаПолученияПредставления вы описываете алгоритм получения параметра Представление из массива полей, заданных вами в предыдущем обработчике. Данные, необходимые для формирования представления, передаются с помощью параметра Данные типа Структура. Для этого сначала вы устанавливаете параметр СтандартнаяОбработка в значение Ложь, а затем получаете представление номенклатуры путем добавления к ее наименованию вида номенклатуры, заключенного в скобки. Если параметр СтандартнаяОбработка в обработчике не установлен в значение Ложь, то система попытается сформировать стандартное представление объекта исходя из переданных данных.

#### В прикладном решении
Запустите проект в режиме отладки.
Открыв документ Оказание услуги в табличной части, вы видите заданное вами представление номенклатуры (рис. 10.8).

Рис. 10.8. Документ «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/10_08.png}
По аналогии с рассмотренным примером произвольные представления объектов конфигурации можно задавать не только для справочников, но и для документов, планов видов характеристик, планов счетов и т. п.
В завершение добавьте цены на появившиеся услуги в регистр сведений Цены (рис. 10.9).

Рис. 10.9. Цены на услуги {https://ai2b.pro/wp-content/uploads/1/10_09.png}
Обратите внимание, что представление номенклатуры формируется в регистре сведений абсолютно так же, как и в документе. Поскольку алгоритм формирования представления номенклатуры задан в модуле менеджера справочника Номенклатура, во всех полях, ссылающихся на номенклатуру, ее представление будет одинаковым.
ПРИМЕЧАНИЕ
Вы можете сравнить свое прикладное решение с эталонным приложением Занятие 10. Как это сделать, описано в разделе «Эталонные проекты».



## Занятие 11 (01:30). Знакомство с языком запросов
Продолжительность
Ориентировочная продолжительность занятия – 1 час 30 минут.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала, то можете загрузить приложение Занятие 10, которое должно получиться у вас к этому моменту. Как это сделать, описано в разделе «Эталонные проекты».
В этой главе вам понадобится внешняя обработка КонсольЗапросов.epf, поставляемая с книгой, поэтому скачайте ее с портала ИТС к себе на компьютер. Подробнее – в разделе «Что содержится в дополнительных материалах».

### Как хранятся данные в «1С:Предприятии»
Прежде чем начинать осваивать язык запросов, важно понять, как хранятся данные в «1С:Предприятии». Для хранения данных «1С:Предприятие» использует реляционные базы данных.
Реляционная база данных представляет собой совокупность различной информации, представленной в виде двумерных таблиц. Таблица базы данных состоит из набора строк и столбцов. Каждая строка (запись) этой таблицы характеризуется рядом значений, содержащихся в ее столбцах (полях).
Для примера можно привести данные о клиентах компании, хранящиеся в справочнике Клиенты. В самом упрощенном виде данные о клиентах хранятся в одной – основной – таблице, где каждому клиенту соответствует одна запись, имеющая один и тот же набор полей, например: Код, Ф. И. О. и др. (табл. 11.1).
Таблица 11.1. Справочник клиентов в информационной базе (основная таблица)
























Рассмотрите подробнее, как формируется структура таблицы справочника в информационной базе «1С:Предприятия».
Например, при создании в 1C:EDT справочника Клиенты платформа автоматически создает в информационной базе основную таблицу этого справочника с полями Ссылка, Код, Наименование, ПометкаУдаления, Предопределенный и ВерсияДанных.
ПРИМЕЧАНИЕ
Имена полей Код, Наименование и т. п. здесь используются для простоты изложения. На самом деле имена полей таблиц в базе данных являются техногенными, например: _Code, _Description и т. п.
Затем пользователь в прикладном решении заполняет справочник данными, которые сохраняются в базе данных (рис. 11.1).

Рис. 11.1. Структура простого справочника в 1C:EDT, в «1С:Предприятии» и в информационной базе {https://ai2b.pro/wp-content/uploads/1/ch11_001.png}

Поле Ссылка является уникальным идентификатором записи о клиенте, поля Код, Наименование, ПометкаУдаления, Предопределенный и ВерсияДанных являются стандартными реквизитами, которые платформа добавляет в любой справочник.
На рис. 11.1 также показаны три понятия, которые важно различать. В 1C:EDT добавляется объект конфигурации – справочник Клиенты. Данные этого объекта конфигурации (все записи справочника) вводятся в прикладном решении, затем эти данные записываются в таблицу справочника Клиенты в информационной базе. В этой таблице объектом базы данных является одна запись (данные одного элемента справочника), однозначно идентифицируемая значением поля Ссылка.
Документы устроены аналогичным образом. У них есть поле Ссылка, которая однозначно идентифицирует каждый документ. Кроме этого у них также есть набор стандартных полей, таких как Дата, Номер, ПометкаУдаления, Проведен и ВерсияДанных.
Кроме стандартных реквизитов каждый элемент справочника или документ, как правило, содержит некоторую дополнительную информацию, которая подробнее описывает этот элемент. Для описания этой информации используются реквизиты справочника или документа, которые вы добавляете в дереве конфигурации в 1C:EDT.
Например, все документы ОказаниеУслуги содержат дополнительную информацию о складе, клиенте и мастере. При добавлении реквизитов документа в 1C:EDT платформа создает поля соответствующего типа в основной таблице документа (рис. 11.2).

Рис. 11.2. Структура документа «ОказаниеУслуги», имеющего реквизиты, в 1C:EDT, в информационной базе и в «1С:Предприятии» {https://ai2b.pro/wp-content/uploads/1/ch11_002.png}
Кроме реквизитов каждый документ обычно содержит табличную часть. В ней хранится набор информации, которая одинакова по своей структуре, но различна по количеству и относится к разным документам. Например, каждый документ ОказаниеУслуги содержит информацию о количестве, цене, сумме и стоимости номенклатуры, которая была использована при оказании услуги.
При добавлении в документ табличной части в информационной базе создается таблица, подчиненная основной таблице документа. Она содержит стандартные поля Ссылка, НомерСтроки и поля, соответствующие реквизитам табличной части, добавленным в 1C:EDT. Таблица, содержащая табличную часть, связана с основной таблицей по полю Ссылка. Благодаря этому можно получить информацию из табличной части, относящуюся к конкретному документу (рис. 11.3).

Рис. 11.3. Документ с табличной частью в 1C:EDT, в информационной базе и в «1С:Предприятии» {https://ai2b.pro/wp-content/uploads/1/ch11_003.png}
В информационной базе создается столько подчиненных таблиц, сколько табличных частей создано у документа.
Таким образом, на примере документа, имеющего табличную часть, вы видите, что одному объекту конфигурации в информационной базе могут соответствовать несколько таблиц: основная и одна или несколько подчиненных ей по полю Ссылка. При этом одному объекту базы данных соответствует одна запись в основной таблице и одна или несколько записей в подчиненных таблицах, содержащих табличные части (рис. 11.3).
Теперь рассмотрите другой пример, когда поле ссылочного типа служит для связи данных двух разных объектов конфигурации. Как вы знаете из занятия по встроенному языку, ссылочные типы данных не существуют изначально в конфигурации, а появляются при создании соответствующих объектов конфигурации. Причем для каждого объекта конфигурации во встроенном языке создается свой тип ссылки. То есть при создании справочника Номенклатура появляется ссылочный тип данных СправочникСсылка.Номенклатура, при создании справочника Клиенты – тип СправочникСсылка.Клиенты, при создании документа ОказаниеУслуги – тип ДокументСсылка.ОказаниеУслуги и т. д. Поля, содержащие данные такого типа, называются ссылочными полями.
Например, документ ОказаниеУслуги имеет поле, ссылающееся на справочник Клиенты (рис. 11.4).

Рис. 11.4. Документ, имеющий поле ссылочного типа, в 1C:EDT, в информационной базе и в «1С:Предприятии» {https://ai2b.pro/wp-content/uploads/1/ch11_004.png}
ПРИМЕЧАНИЕ
Поле Клиент документа ОказаниеУслуги на самом деле хранит ссылку на запись справочника Клиенты, но для большей ясности в таблице на рис. 11.4 в этом поле отражено представление ссылки в виде наименования.
В приведенном примере поле Клиент документа ОказаниеУслуги имеет ссылочный тип СправочникСсылка.Клиенты, а значениями этого поля являются ссылки на конкретные элементы справочника Клиенты. В этом случае, обращаясь к полю Клиент в документе, вы можете получить любые данные о клиенте, на которого ссылается данное поле.
Таким образом, вы рассмотрели некоторые примеры хранения в информационной базе «1С:Предприятия» ссылочных типов данных, таких как справочники, документы, планы видов характеристик и т. д.
В заключение посмотрите, как хранятся в информационной базе «1С:Предприятия» нессылочные данные, доступ к которым нельзя получить через поле Ссылка.
Например, периодический регистр сведений Цены предназначен для хранения данных (ресурс Цена) в разрезе измерений (измерение Номенклатура) с привязкой ко времени. Благодаря стандартному полю Период регистр сведений может хранить не только актуальные значения данных, но и историю их изменения во времени.
На основе объекта конфигурации Регистр сведений платформа создает в информационной базе таблицу, в которой может храниться произвольная информация, «привязанная» к набору измерений и периоду. Например, периодический регистр сведений Цены, имеющий измерение Номенклатура и ресурс Цена, хранит изменяющуюся во времени информацию о ценах на товары (рис. 11.5).

Рис. 11.5. Периодический регистр сведений в 1C:EDT, в «1С:Предприятии» и в информационной базе {https://ai2b.pro/wp-content/uploads/1/ch11_005.png}
ПРИМЕЧАНИЕ
Поле Номенклатура в таблице регистра на самом деле хранит ссылку на запись справочника Номенклатура, но для большей ясности на рис. 11.5 в этом поле отражено представление ссылки в виде наименования.
Как вы видите, в таблице регистра нет поля Ссылка, посредством которого можно сослаться на конкретную запись регистра. Ключом записи, однозначно идентифицирующим запись, является в случае периодического регистра сведений совокупность значений измерений регистра и периода.
В целом для нессылочных данных вы не можете получить какую-то конкретную запись из таблицы. Но можете получить некоторый набор записей по какому-либо условию (например, отобрать данные регистра сведений по периоду) и затем перебирать его в цикле.

### Исходные таблицы для запросов
Прежде чем переходить к конкретным примерам использования языка запросов, познакомьтесь с составом таблиц базы данных, являющихся источниками запросов. Состав таблиц, доступных для запроса, и их описание вы можете увидеть в синтакс-помощнике в разделе Работа с запросами – Таблицы запросов.
Важно понимать, что прямого доступа к физическим таблицам, в которых хранится информация в базе данных, из «1С:Предприятия» получить нельзя. Это связано с тем, что в прикладном решении могут использоваться разные СУБД, имеющие свою специфику, а текст запроса должен быть универсальным и одинаково работать на любой используемой СУБД. Поэтому при выполнении запроса платформа автоматически транслирует текст запроса в набор инструкций, которые «понимает» конкретная СУБД. Кроме того, физические таблицы и поля в них имеют имена, из которых непонятно, какие именно прикладные данные хранятся в данном поле.
Поэтому с помощью запросов вы обращаетесь к данным не напрямую, а через специальную «прослойку» в виде таблиц языка запросов. Этот процесс проиллюстрирован на следующей схеме (рис. 11.6).

Рис. 11.6. Доступ к данным в «1С:Предприятии» {https://ai2b.pro/wp-content/uploads/1/ch11_006.png}
Таким образом, все таблицы, к которым можно обратиться с помощью языка запросов, являются придуманными, воображаемыми, в большей или меньшей степени соответствующими реальным физическим таблицам СУБД. Однако по степени похожести на физические таблицы их принято разделять на реальные и виртуальные.
#### Реальные таблицы
Отличительной особенностью реальных таблиц является то, что они содержат данные какой-либо одной физической таблицы, хранящейся в базе данных, а также то, что реальная таблица очень похожа на свою физическую таблицу. Например, реальной является таблица Справочник.Клиенты, соответствующая справочнику Клиенты, или таблица РегистрСведений.Цены, соответствующая регистру сведений Цены.
Для примера сравните структуру реальной и физической таблицы, хранящей данные справочника (табл. 11.2).
Таблица 11.2. Реальная и физическая таблица справочника «Клиенты»




























































Как вы видите, не все поля реальной и физической таблицы соответствуют друг другу. Например, поле Представление – виртуальное, то есть оно не хранится в физической таблице базы данных, а генерируется в момент выполнения запроса.
Но в целом реальная таблица очень похожа на физическую по набору полей, а количество записей в обеих таблицах одинаково.
Реальные таблицы подразделяются на объектные (ссылочные) и необъектные (нессылочные).
В объектных (ссылочных) таблицах представлена информация ссылочных типов данных (справочники, документы, планы видов характеристик и т. д.). А в необъектных (нессылочных) – всех остальных типов данных (константы, регистры и т. д.).
Отличительной особенностью объектных (ссылочных) таблиц является то, что они включают в себя стандартное поле Ссылка, которое позволяет однозначно идентифицировать каждую запись (данные об объекте базы данных). Эти таблицы могут быть иерархическими, подчиненными, и поля таких таблиц могут содержать вложенные таблицы (табличные части).

#### Виртуальные таблицы
Виртуальные таблицы формируются в момент выполнения запроса на основе реальных таблиц базы данных. Например, виртуальная таблица РегистрСведений.Цены.СрезПоследних формируется на основе таблицы регистра сведений Цены (рис. 11.7).

Рис. 11.7. Физическая и виртуальная таблица регистра сведений {https://ai2b.pro/wp-content/uploads/1/ch11_007.png}
Как вы видите, при заполнении цен номенклатуры в регистре сведений Цены в «1С:Предприятии» данные за период по каждой единице номенклатуры сохраняются в физической таблице регистра сведений в базе данных.
Вы уже знакомы с периодическим регистром сведений (рис. 11.5). Благодаря стандартному полю Период регистр может хранить изменяющуюся во времени информацию для одних и тех же измерений, но для различных периодов.
При обращении к виртуальной таблице РегистрСведений.Цены.СрезПоследних вы получите не все записи физической таблицы, а только последние по времени данные о ценах на номенклатуру. То есть срез последних записей регистра сведений возвращает по каждому значению измерения (Номенклатура) одну наиболее позднюю (по времени, по значению поля Период) запись.
Таким образом, виртуальные таблицы мало похожи на какую-то физическую таблицу и содержат иной состав записей, чем реальные таблицы.

### Язык запросов «1С:Предприятия»
Механизм запросов позволяет получить доступ к разнообразной информации, хранящейся в базе данных «1С:Предприятия». Путем выполнения запроса к информационной базе из всей совокупности информации можно получить различные выборки данных из одной или нескольких взаимосвязанных таблиц, отобранных по определенному условию, отсортированных определенным образом и пр. Далее полученные данные могут быть проанализированы для решения различных прикладных задач, построения отчетов и т. п.
Однако следует иметь в виду, что с помощью запросов можно только прочитать нужную информацию из базы данных, но изменить ее и записать обратно при помощи запроса нельзя – для этого нужно использовать средства встроенного языка.
#### Общая схема выполнения запросов
Запрос формируется вами и выполняется из встроенного языка. Для этого предназначены следующие программные объекты:
Запрос,
РезультатЗапроса,
ВыборкаИзРезультатаЗапроса.
Не углубляясь в детали, рассмотрите самую распространенную и простейшую схему выполнения запроса.
Сначала во встроенном языке создается объект Запрос (листинг 11.1).
Листинг 11.1. Создание запроса
Запрос = Новый Запрос;
У объекта Запрос есть свойство Текст, в которое нужно поместить текст запроса, написанный на языке запросов. В тексте запроса описывается, какие данные из каких таблиц нужно получить и как эти данные представить (листинг 11.2).
Листинг 11.2. Заполнение текста запроса
Запрос.Текст =
"ВЫБРАТЬ
|	Наименование
|ИЗ
|	Справочник.Номенклатура";
Далее запрос выполняется с помощью метода Выполнить() объекта Запрос. Именно в этот момент и происходит чтение данных из базы данных. Прочитанные данные возвращаются в виде объекта РезультатЗапроса, содержащего выбранные данные из базы данных (листинг 11.3).
Листинг 11.3. Выполнение запроса
РезультатЗапроса = Запрос.Выполнить();
Чтобы обработать данные, содержащиеся в объекте РезультатЗапроса, из результата запроса получается выборка с помощью метода Выбрать(), который возвращает новый объект ВыборкаИзРезультатаЗапроса, то есть коллекцию данных, предназначенную для последовательного обхода ее элементов (листинг 11.4).
Листинг 11.4. Получение выборки из результата запроса
ВыборкаЗапроса = РезультатЗапроса.Выбрать();
Далее выборка обходится с помощью цикла Пока Выборка.Следующий() Цикл, а в теле цикла производятся какие-то действия над данными, полученными с помощью запроса (листинг 11.5).
Листинг 11.5. Обход выборки
Пока ВыборкаЗапроса.Следующий() Цикл
Сообщить(ВыборкаЗапроса.Наименование);
 
КонецЦикла;
В результате, если соединить вместе тексты листингов 11.1–11.5, вы получите процедуру встроенного языка, в которой создается и выполняется запрос, в данном примере выводящий наименования всей номенклатуры из справочника Номенклатура в окно сообщений (листинг 11.6).
Листинг 11.6. Вывод наименований всей номенклатуры в окно сообщений
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	Наименование
|ИЗ
|	Справочник.Номенклатура";
 
РезультатЗапроса = Запрос.Выполнить();
ВыборкаЗапроса   = РезультатЗапроса.Выбрать();
 
Пока ВыборкаЗапроса.Следующий() Цикл
Сообщить(ВыборкаЗапроса.Наименование);
 
КонецЦикла;
Чтобы не усложнять восприятие материала, вы пока не будете подробно останавливаться на выводе и обработке результатов запросов. Сначала вы начнете изучать сам язык запросов, то есть научитесь правильно составлять текст запросов.
Для выполнения запросов и просмотра результатов вы будете использовать специальную обработку Консоль запросов (КонсольЗапросов.epf). Данная обработка помогает отлаживать и просматривать результаты выполнения запросов в прикладном решении.

#### Синтаксис текста запросов
Язык запросов «1С:Предприятия» основан на стандартном SQL, но при этом содержит значительное количество расширений, ориентированных на финансово-экономические задачи, и значительно облегчает разработку бизнес-приложений.
Из этого следует, что язык запросов – мощный инструмент, предоставляющий разнообразные возможности получения данных. Но вы начнете его изучение с самых простых примеров, основанных на реальных небольших задачах, расположенных от простого к сложному. Сначала немного теории.
Текст запроса состоит из нескольких частей (секций):
описание запроса,
объединение запросов,
упорядочивание результатов,
автоупорядочивание,
описание итогов.
Обязательной частью запроса является только первая – описание запроса. Все остальные присутствуют в запросе по необходимости. Назначение каждой секции запроса вы рассмотрите ниже на конкретных примерах.
Для ознакомления посмотрите на запрос, в котором присутствуют все указанные секции (рис. 11.8).

Рис. 11.8. Секции запроса {https://ai2b.pro/wp-content/uploads/1/ch11_008.png}
Синтаксически текст запроса состоит из набора секций, имеющих определенное назначение. Например, выбрать записи из базы данных, отсортировать их, подсчитать итоги и т. д. Секции состоят из предложений, которые, в свою очередь, содержат ключевые слова (например, ВЫБРАТЬ, ИЗ, ГДЕ и т. п.), обозначающие определенное действие, которое нужно выполнить с базой данных. Ключевое слово, с которого начинается предложение, обычно дает название предложению языка запросов.
Одной из существенных особенностей языка запросов «1С:Предприятия» является то, что все ключевые слова имеют два варианта написания: на русском и английском языках. Поэтому язык написания запроса – дело привычки и вкуса, а результат выполнения запроса будет одинаков в обоих случаях.
Итак, начните изучать язык запросов на конкретных примерах, от самых простых к более сложным. В процессе изучения вы узнаете, как и для чего используются различные ключевые слова языка запросов.

#### Как получить все данные из таблицы
В вашем проекте существует справочник Клиенты. Предположим, вам нужно получить все данные из таблицы базы данных, соответствующей этому справочнику. Это можно сделать с помощью простейшего запроса, а результат посмотреть в консоли запросов.
Консоль запросов нужно открывать из запущенного клиентского приложения. Поэтому сначала запустите проект (в режиме отладки или нет – не имеет значения).
В главном меню нажмите Файл – Открыть (рис. 11.9), выберите файл КонсольЗапросов.epf и ответьте утвердительно на вопрос об открытии внешней обработки.

Рис. 11.9. Главное меню {https://ai2b.pro/wp-content/uploads/1/ch11_009.png}
В среднем окне Текст запроса введите следующий текст (листинг 11.7).
Листинг 11.7. Вывод всех полей из таблицы
ВЫБРАТЬ
Справочник.Клиенты.*
Нажмите Выполнить – и в нижнем окне Результат запроса вы увидите результат выполнения запроса (рис. 11.10).

Рис. 11.10. Вывод всех полей из таблицы {https://ai2b.pro/wp-content/uploads/1/ch11_010.png}
После выполнения запроса в заголовке окна Результат запроса появится также количество строк в результате запроса и время выполнения запроса.
Теперь рассмотрите подробно текст вашего запроса (см. листинг 11.7).
Текст любого запроса всегда содержит секцию описания запроса, в которой определяются источники данных для запроса, список полей выборки и т. д. Все секции запроса были показаны на рис. 11.8.
Описание запроса начинается с ключевого слова ВЫБРАТЬ. За ним следует список имен полей выборки запроса, перечисленных через запятую. Таким образом, с помощью ключевого слова ВЫБРАТЬ определяются требуемые поля результата запроса.
Справочник.Клиенты – это имя одной из исходных таблиц запроса, описанных выше. В языке запросов имена таблиц формируются по принципу:
<Имя класса объектов>.<Имя объекта конфигурации>
Полное имя поля содержит имя таблицы и имя поля. Например, в строке Справочник.Клиенты.Код Справочник.Клиенты – это имя таблицы, а Код – это имя поля.
Подробнее
Посмотреть состав таблиц, доступных для запроса, и их описание можно в синтакс-помощнике в разделе Работа с запросами – Таблицы запросов.
В данном случае вам нужны все поля таблицы, поэтому вместо перечисления имен полей можно использовать звездочку «*».
Обратите внимание на структуру написания запроса. Правила оформления запросов предписывают все ключевые слова выделять заглавными буквами, каждое поле из списка выборки начинать с новой строки, со сдвигом относительно слова ВЫБРАТЬ.
Если вы напишете в одну строку – выбрать справочник.клиенты.*, то платформа вас поймет и так, результат запроса не изменится. Но так писать – это моветон.
С остальными правилами оформления запросов вы будете знакомиться по ходу следующих примеров.

#### Примеры использования языка запросов для получения данных из одной таблицы
##### Как получить только определенные поля для всех записей из таблицы
В реальных задачах обычно требуется получить не все, а только некоторые конкретные поля из таблицы. В данном примере для всех записей документа ПриходнаяНакладная нужно получить только поля Дата, Номер и Склад.
Это можно сделать с помощью следующего запроса (листинг 11.8).
Листинг 11.8. Вывод определенных полей для всех записей из таблицы
ВЫБРАТЬ
Документ.ПриходнаяНакладная.Дата,
Документ.ПриходнаяНакладная.Номер,
Документ.ПриходнаяНакладная.Склад
Здесь после ключевого слова ВЫБРАТЬ перечислены полные имена требуемых полей результата запроса.
Результат выполнения запроса будет выглядеть следующим образом (рис. 11.11).

Рис. 11.11. Вывод определенных полей для всех записей из таблицы {https://ai2b.pro/wp-content/uploads/1/ch11_011.png}

Итак, вы получили требуемые поля из таблицы с помощью ключевого слова ВЫБРАТЬ. Однако неудобно то, что для каждого поля нужно писать полный путь к нему – Документ.ПриходнаяНакладная. Имя таблицы документа, служащей источником для запроса, можно написать один раз после ключевого слова ИЗ (листинг 11.9).
Листинг 11.9. Указание таблицы источника запроса
ВЫБРАТЬ
Дата,
Номер,
Склад
ИЗ
Документ.ПриходнаяНакладная
Результат запроса будет аналогичен выполнению предыдущего запроса (рис. 11.11), то есть результат выполнения двух следующих запросов будет одинаковым (листинг 11.10).
Листинг 11.10. Указание таблицы источника запроса
// Первый вариант
ВЫБРАТЬ
Документ.ПриходнаяНакладная.Дата,
Документ.ПриходнаяНакладная.Номер,
Документ.ПриходнаяНакладная.Склад
 
// Второй вариант
ВЫБРАТЬ
Дата,
Номер,
Склад
ИЗ
Документ.ПриходнаяНакладная
Также с помощью ключевого слова ИЗ можно переписать текст запроса первого примера, то есть результат выполнения двух следующих запросов будет одинаковым (листинг 11.11).
Листинг 11.11. Указание таблицы источника запроса
// Первый вариант
ВЫБРАТЬ
Справочник.Клиенты.*
 
// Второй вариант
ВЫБРАТЬ
*
ИЗ
Справочник.Клиенты
Итак, после ключевого слова ИЗ через запятую перечисляются таблицы, являющиеся источниками для запроса.
В реальных задачах запросы могут быть сложными и источников в них может быть несколько. Поэтому, следуя правилам оформления запросов, желательно давать псевдонимы источникам и использовать их затем в других частях запроса. В некоторых случаях это является обязательным – например, когда из разных таблиц выбираются поля с одинаковыми именами.
Псевдонимы задаются с помощью ключевого слова КАК, после которого следует имя псевдонима. Имя псевдонима может писаться сразу после имени таблицы (например, Документ.ПриходнаяНакладная ПриходнаяНакладная), но наличие ключевого слова КАК повышает наглядность и удобочитаемость текста запроса.
Таким образом, запрос, представленный в листинге 11.9, может быть изменен следующим образом (листинг 11.12).
Листинг 11.12. Псевдоним таблицы запроса
// Первый вариант без псевдонимов
ВЫБРАТЬ
Дата,
Номер,
Склад
ИЗ
Документ.ПриходнаяНакладная
 
// Рекомендуемый вариант с псевдонимом таблицы-источника
ВЫБРАТЬ
ПриходнаяНакладная.Дата,
ПриходнаяНакладная.Номер,
ПриходнаяНакладная.Склад
ИЗ
Документ.ПриходнаяНакладная КАК ПриходнаяНакладная
Также псевдонимы рекомендуется присваивать полям выборки. Дело в том, что на имена полей выборки могут быть завязаны алгоритмы обработки результатов запроса.
Если не присваивать псевдонимы полям выборки, то поля выборки будут иметь «стандартные» имена, соответствующие их именам в таблице запросов. В этом случае при выборе другого поля в запросе у поля выборки будет другое имя. А если использовать псевдонимы полей выборки, то имя поля выборки в результате запроса можно оставить без изменений, только оно уже будет указывать на другое поле в таблице запроса. Таким образом, при изменении полей выборки запроса алгоритм обработки результатов будет работать так же, как и раньше.
Представьте, что в справочнике Номенклатура есть еще один реквизит, в котором хранится наименование на английском языке, – АнглоязычноеНаименование. Для примера сравните две процедуры, в которых выполняется запрос и обрабатываются его результаты (листинги 11.13, 11.14).
Листинг 11.13. Псевдоним поля выборки запроса
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|    Наименование КАК Название
|ИЗ
|	Справочник.Номенклатура";
 
РезультатЗапроса = Запрос.Выполнить();
ВыборкаЗапроса = РезультатЗапроса.Выбрать();
 
Пока ВыборкаЗапроса.Следующий() Цикл
Сообщить(ВыборкаЗапроса.Название);
 
КонецЦикла;
Листинг 11.14. Вывод англоязычных наименований всех товаров
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|    АнглоязычноеНаименование КАК Название
|ИЗ
|	Справочник.Номенклатура";
 
РезультатЗапроса = Запрос.Выполнить();
ВыборкаЗапроса = РезультатЗапроса.Выбрать();
 
Пока ВыборкаЗапроса.Следующий() Цикл
Сообщить(ВыборкаЗапроса.Название);
 
КонецЦикла;
То есть в алгоритме обработки результатов запроса ничего не меняется, меняется только строка (или строки) в тексте запроса. И в результате в окно сообщений выводятся разные поля таблицы.

##### Как расположить полученные записи в нужном порядке
Следующий пример, который вы рассмотрите, показывает простую, но очень важную возможность языка запросов – возможность упорядочивания записей в результате запроса.
Важно понимать, что упорядочивание результата запроса – это обязательное правило хорошего тона при написании работоспособных запросов в «1С:Предприятии». Если не использовать упорядочивание, то порядок записей в результате запроса будет не определен. Предугадать его заранее не может ни пользователь, ни даже вы как разработчик.
Например, один и тот же запрос, выполненный на разных СУБД, может дать разный порядок записей. С точки зрения пользователя это может показаться странным, а с вашей точки зрения вообще может привести к ошибкам при обработке результатов запроса, если алгоритм обработки рассчитан на определенный порядок записей.
Поэтому в запросе очень важно всегда явно указывать, как должны быть упорядочены записи. Даже тогда, когда, на первый взгляд, порядок записей не влияет на обработку результата. Потому что заранее неизвестно, как и кем будет дорабатываться дальше прикладное решение.
Порядок расположения записей в результате запроса определяется в секции Упорядочивание результатов текста запроса. Все секции запроса приведены на рис. 11.8.
Рассмотрите реальную задачу. Часто требуется выводить записи из регистра сведений Цены не в случайном порядке, а в порядке возрастания даты изменения цен товаров.
Для этого в языке запросов предназначено ключевое слово УПОРЯДОЧИТЬ ПО, после которого следуют список полей упорядочивания и тип упорядочивания (по возрастанию, по убыванию, по иерархии) для каждого поля.
Например, чтобы вывести записи регистра сведений Цены в порядке возрастания поля Период, нужно выполнить следующий запрос (листинг 11.15).
Листинг 11.15. Упорядочивание записей регистра сведений по возрастанию поля «Период»
ВЫБРАТЬ
Цены.Период КАК Период,
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Период
Обратите внимание: предложение УПОРЯДОЧИТЬ ПО относится к секции упорядочивания результатов запроса, а предложения ВЫБРАТЬ и ИЗ – к секции описания запроса. В правилах оформления запросов принято отделять одну секцию запроса от другой, поэтому между секциями находится пустая строка.
Результат выполнения запроса будет следующим (рис. 11.12).

Рис. 11.12. Вывод записей из таблицы в определенном порядке {https://ai2b.pro/wp-content/uploads/1/ch11_012.png}

Вы видите, что записи таблицы в результате запроса расположены по возрастанию поля, указанного в предложении УПОРЯДОЧИТЬ ПО, хотя тип упорядочивания не задан. Дело в том, что упорядочивание записей результата запроса по возрастанию выполняется по умолчанию, хотя можно указать явно тип упорядочивания. Для этого после имени поля нужно указать ключевое слово ВОЗР (листинг 11.16).
Листинг 11.16. Упорядочивание записей регистра сведений по возрастанию поля «Период»
ВЫБРАТЬ
Цены.Период КАК Период,
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Период ВОЗР
При этом поле, по которому производится упорядочивание, не обязательно должно входить в список выборки запроса (листинг 11.17).
Листинг 11.17. Упорядочивание записей регистра сведений по возрастанию поля «Период»
ВЫБРАТЬ
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Цены.Период
При выполнении данного запроса записи регистра сведений Цены будут расположены в порядке возрастания поля Период, но само это поле в результате запроса отражено не будет.
Чтобы расположить записи результата запроса по убыванию какого-либо поля, нужно в предложении упорядочивания указать после имени поля ключевое слово УБЫВ.
В предложении УПОРЯДОЧИТЬ ПО могут участвовать несколько полей, каждое из этих полей может использовать разный способ упорядочивания (листинг 11.18). В этом случае записи результата запроса будут упорядочены сначала по первому полю, затем – по второму полю (в случае если существует несколько записей с одинаковым значением первого поля), и т. д.
Листинг 11.18. Упорядочивание записей регистра сведений по нескольким полям
ВЫБРАТЬ
Цены.Период КАК Период,
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Период УБЫВ,
Цена
Обратите внимание, что в тексте запроса принято не только поля в списке выборки, но и поля в списке упорядочивания располагать на разных строках со смещением относительно ключевого слова УПОРЯДОЧИТЬ ПО.
В результате вы видите, что записи регистра сведений расположены в порядке убывания поля Период, а внутри одного периода – в порядке возрастания поля Цена (рис. 11.13).

Рис. 11.13. Вывод записей из таблицы в определенном порядке {https://ai2b.pro/wp-content/uploads/1/ch11_013.png}
##### Как упорядочить записи таблицы по ссылочному полю
В предыдущем примере вы рассматривали, как упорядочить данные результата запроса по полям примитивных типов – Дата, Число и т. п. Но как упорядочить данные по ссылочному полю?
Ведь ссылка на самом деле представляет собой некоторый произвольный уникальный идентификатор, никак не связанный с прикладной сущностью данных (набором символов), которые содержатся в этом поле. У элементов справочников – одна прикладная сущность, которая может выражаться кодом или наименованием. У документов – совсем другая прикладная сущность, которая выражается датой, номером документа и т. д.
Чтобы расположить объекты базы данных (записи ссылочных таблиц) в порядке, соответствующем их прикладной сущности, используется режим автоматического упорядочивания записей результата запроса.
В тексте запроса этот режим задается в секции Автоупорядочивание. Все секции запроса приведены на рис. 11.8.
С помощью автоупорядочивания можно вывести записи таблицы в наиболее естественном (ожидаемом пользователем) порядке. Для этого нужно упорядочить записи таблицы непосредственно по ссылочному полю, а затем использовать ключевое слово АВТОУПОРЯДОЧИВАНИЕ (листинг 11.19).
Листинг 11.19. Автоматическое упорядочивание записей таблицы
ВЫБРАТЬ
ПриходнаяНакладная.Дата КАК Дата,
ПриходнаяНакладная.Номер КАК Номер,
ПриходнаяНакладная.Склад КАК Склад
ИЗ
Документ.ПриходнаяНакладная КАК ПриходнаяНакладная
 
УПОРЯДОЧИТЬ ПО
ПриходнаяНакладная.Ссылка
АВТОУПОРЯДОЧИВАНИЕ
Вы видите, что при автоупорядочивании списка документов ПриходнаяНакладная записи результата запроса расположены в порядке возрастания поля Дата, а в том случае, если даты у документов одинаковые, записи упорядочиваются в порядке возрастания поля Номер (рис. 11.14).

Рис. 11.14. Вывод записей из таблицы в автоматическом порядке {https://ai2b.pro/wp-content/uploads/1/ch11_014.png}

Так произошло потому, что при выполнении данного запроса для каждого ссылочного поля были получены реальные поля, по которым его необходимо упорядочить (для документа это дата и номер, для справочника – основное представление), и произведено упорядочивание по ним.
Таким образом, такого же результата можно было добиться, явно указав поля Дата и Номер при упорядочивании таблицы документа (листинг 11.20).
Листинг 1.20. Упорядочивание списка документов по полям «Дата» и «Номер»
ВЫБРАТЬ
ПриходнаяНакладная.Дата КАК Дата,
ПриходнаяНакладная.Номер КАК Номер,
ПриходнаяНакладная.Склад КАК Склад
ИЗ
Документ.ПриходнаяНакладная КАК ПриходнаяНакладная
 
УПОРЯДОЧИТЬ ПО
ПриходнаяНакладная.Дата,
ПриходнаяНакладная.Номер
Но в общем случае, чтобы расположить записи результата запроса в наиболее ожидаемом (естественном) порядке, рекомендуется более универсальный первый вариант – упорядочить записи таблицы непосредственно по ссылочному полю, а затем использовать конструкцию АВТОУПОРЯДОЧИВАНИЕ. В остальных случаях использовать автоупорядочивание записей результата запроса не рекомендуется.

##### Как получить записи, в которых определенные поля не содержат одинаковых значений
Часто записи в таблицах имеют одинаковые значения какого-то поля (полей), а нужно получить только записи с неповторяющимися значениями этого поля.
Например, если вы выполните запрос к регистру Цены (листинг 11.20), то увидите, что существует несколько записей для одной и той же номенклатуры (рис. 11.15).
Листинг 11.20. Запрос к регистру «Цены»
ВЫБРАТЬ
Цены.Номенклатура КАК Номенклатура
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Номенклатура
АВТОУПОРЯДОЧИВАНИЕ

Рис. 11.15. Запрос к регистру «Цены» {https://ai2b.pro/wp-content/uploads/1/ch11_015.png}

Вас же интересует вопрос, для какой вообще номенклатуры устанавливались цены. Как в этом случае получить только уникальные позиции номенклатуры без повторений?
Для этого следует использовать конструкцию ВЫБРАТЬ РАЗЛИЧНЫЕ (листинг 11.21).
Листинг 11.21. Запрос к регистру «Цены»
ВЫБРАТЬ РАЗЛИЧНЫЕ
Цены.Номенклатура КАК Номенклатура
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Номенклатура
АВТОУПОРЯДОЧИВАНИЕ
В результате выполнения этого запроса вы получите только те записи, которые содержат неповторяющиеся комбинации значений полей выборки. Так как поле выборки у вас всего одно – Номенклатура – то это будут неповторяющиеся значения номенклатуры (рис. 11.16).

Рис. 11.16. Вывод различных позиций номенклатуры из регистра «Цены» {https://ai2b.pro/wp-content/uploads/1/ch11_016.png}


##### Как получить записи из таблицы, отобранные по некоторому условию
Теперь рассмотрите распространенную задачу, когда из большой таблицы нужно получить только некоторые записи, удовлетворяющие заданному условию.
В регистре сведений Цены существуют записи за октябрь и за ноябрь (рис. 11.17). Нужно отобрать записи только о тех товарах, цена на которые устанавливалась в ноябре.

Рис. 11.17. Регистр сведений «Цены» {https://ai2b.pro/wp-content/uploads/1/ch11_017.png}

Условие отбора данных из таблицы задается после ключевого слова ГДЕ. В результат запроса будут включены только те записи, которые удовлетворяют условию отбора.
Для того чтобы отобрать документы за ноябрь, в условии отбора сравните поле Период с литералом даты ДАТАВРЕМЯ(2022, 11, 01) – листинг 11.22.
Листинг 11.22. Вывод записей регистра «Цены» за ноябрь
ВЫБРАТЬ РАЗЛИЧНЫЕ
Цены.Период КАК Период,
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
ГДЕ
Цены.Период >= ДАТАВРЕМЯ(2022, 11, 1)
 
УПОРЯДОЧИТЬ ПО
Период
В результате выполнения этого запроса вы получите записи, относящиеся только к месяцу ноябрю (рис. 11.18).

Рис. 11.18. Отбор записей регистра «Цены» по условию {https://ai2b.pro/wp-content/uploads/1/ch11_018.png}

Литералы – это строковые константы, которые могут использоваться в тексте запроса. Литералы могут быть различных примитивных типов: Булево (ИСТИНА, ЛОЖЬ), Число (например, 222.77), Строка (например, «Мария»). Использование этих литералов вы рассмотрите в следующих примерах.
В данном запросе в условии отбора вы используете литерал типа Дата, значения которого задаются с помощью ключевого слова ДАТАВРЕМЯ, после которого в скобках последовательно указываются год, месяц, день, час, минута, секунда. Последние три значения указывать необязательно.

##### Как получить данные из таблицы, на которую ссылается поле другой таблицы
В языке запросов «1С:Предприятия» существует очень удобная возможность – обращаться не только к полям исходных таблиц запроса, перечисленным в предложении ИЗ, но и к полям таблицы, на которую ссылается поле исходной таблицы запроса.
В начале главы (рис. 11.4) вы рассматривали, как хранятся данные таблиц, имеющих ссылочные поля на другие таблицы в информационной базе «1С:Предприятия».
Например, пусть в качестве исходной таблицы выступает регистр Цены, который имеет ссылочное поле Номенклатура. Это поле имеет тип ссылки на справочник Номенклатура, а значениями этого поля в таблице регистра являются ссылки на конкретные элементы справочника Номенклатура.
В этом случае, обращаясь к полю Номенклатура в регистре, вы можете получить из справочника Номенклатура любые данные об элементе, на который ссылается это поле.
Теперь посмотрите, как это реализуется с помощью языка запросов. Допустим, вам нужно вывести список номенклатуры из регистра Цены и при этом для каждой номенклатуры отобразить ее вид: товар или услуга. Это можно сделать с помощью следующего запроса (листинг 11.23, рис. 11.19).
Листинг 11.23. Вывод полей из таблицы, на которую ссылается поле исходной таблицы запроса
ВЫБРАТЬ
Цены.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Номенклатура
АВТОУПОРЯДОЧИВАНИЕ

Рис. 11.19. Вывод полей из таблицы, на которую ссылается поле исходной таблицы запроса {https://ai2b.pro/wp-content/uploads/1/ch11_019.png}

В списке выборки запроса перечислены поля Номенклатура и Цена исходной таблицы запроса – регистра Цены, а также поле ВидНоменклатуры таблицы справочника Номенклатура, на которую ссылается поле регистра Номенклатура. Имя поля таблицы справочника пишется через точку – Номенклатура.ВидНоменклатуры.
Обращение к полям через точку называется операцией разыменования ссылочного поля. Причем в общем случае в цепочке разыменования может быть перечислено через точку несколько полей – например, Номенклатура.Родитель.Наименование.

##### Как получить данные из табличной части некоторого документа
Часто может понадобиться вывести все данные из табличной части определенного документа или элемента справочника или другого объекта конфигурации, имеющего табличную часть.
Для этого в языке запросов существует удобная возможность – обращаться к табличной части как к отдельной таблице. При этом в тексте запроса можно использовать все ранее изученные вами конструкции: ВЫБРАТЬ, ИЗ и т. п. Синтаксис обращения к таблице-источнику включает также имя табличной части – <Имя класса объектов>.<Имя объекта конфигурации>.<Имя табличной части>, например Документ.ПриходнаяНакладная.Материалы.
Следующий запрос выводит данные табличной части Материалы для всех документов ПриходнаяНакладная (листинг 11.24).
Листинг 11.24. Вывод данных табличной части «Материалы» для всех документов «ПриходнаяНакладная»
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Количество КАК Количество,
ПриходнаяНакладнаяМатериалы.Цена КАК Цена,
ПриходнаяНакладнаяМатериалы.Сумма КАК Сумма
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
В начале главы (рис. 11.3) вы рассматривали, как хранятся данные табличных частей в информационной базе «1С:Предприятия». Поля выборки запроса Материал, Количество, Цена и Сумма – это реквизиты табличной части документа, находящиеся в отдельной таблице базы данных, к которой вы обращаетесь запросом. В этой таблице хранятся данные всех табличных частей документов определенного вида.
Результат выполнения запроса представлен на рис. 11.20.

Рис. 11.20. Вывод данных табличной части «Материалы» из всех документов «ПриходнаяНакладная» {https://ai2b.pro/wp-content/uploads/1/ch11_020.png}

Однако в таком виде вы не можете сказать, к какому складу или к какому документу относится каждая из записей результата запроса. Для повышения информативности данных вы можете добавить в список полей выборки реквизиты документа Номер и Склад.
Вы знаете, что эти поля хранятся в основной таблице документа. Поскольку в примере источником запроса является подчиненная таблица документа Документ.ПриходнаяНакладная.Материалы, то, чтобы получить данные из основной таблицы документа, нужно обращаться к полям этой таблицы через точку от поля Ссылка, которое есть в табличной части. Это поле указывает на документ, которому принадлежит запись табличной части (листинг 11.25).
Листинг 11.25. Вывод данных из основной и подчиненной таблицы документов «ПриходнаяНакладная»
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер,
ПриходнаяНакладнаяМатериалы.Ссылка.Склад КАК Склад,
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Количество КАК Количество,
ПриходнаяНакладнаяМатериалы.Цена КАК Цена,
ПриходнаяНакладнаяМатериалы.Сумма КАК Сумма
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
Результат выполнения запроса представлен на рис. 11.21.

Рис. 11.21. Вывод данных из основной и подчиненной таблицы документов «ПриходнаяНакладная» {https://ai2b.pro/wp-content/uploads/1/ch11_021.png}
Конечно, когда данных много, обычно требуется отобрать информацию из определенного документа. Для этого нужно добавить в запрос условие, содержащее параметр, имеющий тип ссылки на документ ПриходнаяНакладная (листинг 11.26).
Листинг 11.26. Вывод данных из определенного документа
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер,
ПриходнаяНакладнаяМатериалы.Ссылка.Склад КАК Склад,
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Количество КАК Количество,
ПриходнаяНакладнаяМатериалы.Цена КАК Цена,
ПриходнаяНакладнаяМатериалы.Сумма КАК Сумма
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка = &Документ
Нажмите кнопку Заполнить параметры, и параметр Документ будет добавлен в окно параметров консоли запросов. Причем консоль запросов из текста запроса автоматически определяет не только имя, но и тип параметра. В данном случае параметр запроса имеет ссылочный тип – ДокументСсылка.ПриходнаяНакладная.
Выберите приходную накладную, например № 2, и выполните запрос. В результате выполнения запроса вы увидите только те записи, которые относятся к конкретной приходной накладной (рис. 11.22).

Рис. 11.22. Вывод данных из определенного документа {https://ai2b.pro/wp-content/uploads/1/ch11_022.png}

##### Как узнать среднюю цену, по которой продавался товар
Часто значения некоторых полей в таблицах могут повторяться. Например, вводится несколько заказов для одного и того же клиента, или один и тот же товар продается в расходных накладных. Обычно в прикладных задачах требуется узнать, какова максимальная сумма заказа для каждого клиента, сколько и по каким ценам продали каждого товара и т. п.
Для решения подобных задач применяется группировка записей. Суть этой операции заключается в том, что вместо нескольких записей из исходной таблицы, имеющих одинаковое значение некоторого поля, в результат запроса включается одна запись, в которой от значений других полей вычисляется некоторое обобщенное значение (рассчитывается агрегатная функция). Например, значения другого поля для группируемых записей суммируются, вычисляются максимальное, минимальное значение, количество и т. д.
Рассмотрите данную задачу на примере регистра Цены. Для начала вы просто выведете все записи из регистра, упорядочив их по ссылкам номенклатуры. Делается это простым запросом к таблице регистра (листинг 11.27).
Листинг 11.27. Вывод всех записей из регистра «Цены», упорядоченных по ссылкам номенклатуры
ВЫБРАТЬ
Цены.Номенклатура КАК Номенклатура,
Цены.Цена КАК Цена
ИЗ
РегистрСведений.Цены КАК Цены
 
УПОРЯДОЧИТЬ ПО
Номенклатура
АВТОУПОРЯДОЧИВАНИЕ
Результат вы видите на рис. 11.23.

Рис. 11.23. Вывод всех записей из регистра «Цены», упорядоченных по ссылкам номенклатуры {https://ai2b.pro/wp-content/uploads/1/ch11_023.png}
Итак, в результате запроса содержится две записи для номенклатуры Транзистор Philips, что говорит о том, что цена одной и той же номенклатуры может быть разной. Допустим, вас интересует минимальная, максимальная и средняя цена, которая была установлена для каждой позиции номенклатуры.
Для решения этой задачи нужно собрать вместе записи исходной таблицы с одинаковым значением поля Номенклатура и использовать агрегатные функции МИНИМУМ(), МАКСИМУМ() и СРЕДНЕЕ() со значением цены в качестве параметра этих функций.
Для этого в языке запросов предназначено ключевое слово СГРУППИРОВАТЬ ПО, после которого следует список полей, по которым нужно сгруппировать записи исходной таблицы (листинг 11.28).
Листинг 11.28. Вывод минимальной, максимальной и средней цены каждой позиции номенклатуры
ВЫБРАТЬ
Цены.Номенклатура КАК Номенклатура,
МИНИМУМ(Цены.Цена) КАК ЦенаМин,
МАКСИМУМ(Цены.Цена) КАК ЦенаМакс,
СРЕДНЕЕ(Цены.Цена) КАК ЦенаСред
ИЗ
РегистрСведений.Цены КАК Цены
 
СГРУППИРОВАТЬ ПО
Цены.Номенклатура
 
УПОРЯДОЧИТЬ ПО
Номенклатура
АВТОУПОРЯДОЧИВАНИЕ
Обратите внимание, что в списке полей выборки запроса помимо полей, по которым группируются записи исходной таблицы, могут присутствовать только агрегатные функции СУММА(), МИНИМУМ(), МАКСИМУМ(), СРЕДНЕЕ(), КОЛИЧЕСТВО(), применяемые к исходным записям с одинаковым значением поля группировки.
Агрегатные функции МИНИМУМ(), МАКСИМУМ() и СРЕДНЕЕ() вычисляют соответственно минимальное, максимальное и среднее значение из всех записей с одинаковым значением поля группировки.
В результате выполнения запроса выводится 10 записей вместо 11, так как записи исходной таблицы для номенклатуры Транзистор Philips «сворачиваются» в одну запись, в которой помимо самого поля группировки выводятся значения агрегатных функций (рис. 11.24).

Рис. 11.24. Вывод минимальной, максимальной и средней цены каждой позиции номенклатуры {https://ai2b.pro/wp-content/uploads/1/ch11_024.png}


#### Примеры использования языка запросов для получения данных из нескольких таблиц
##### Как использовать данные одного запроса внутри другого запроса
Иногда внутри одного запроса необходимо использовать данные другого запроса. Например, требуется ограничить выборку значений в условии отбора одного запроса данными другого запроса. Второй запрос по отношению к первому является вложенным, а первый запрос по отношению ко второму является основным, или внешним. Причем уровней вложенности запросов друг в друга в общем случае может быть несколько.
Рассмотрите эту ситуацию на примере. Допустим, необходимо узнать, в каких документах ОказаниеУслуги и каким клиентам продавались материалы, перечисленные в конкретной приходной накладной. Для этого нужно выполнить следующий запрос (листинг 11.29).
Листинг 11.29. Использование вложенного запроса в условии отбора основного запроса
ВЫБРАТЬ
ОказаниеУслуги.Ссылка КАК Ссылка,
ОказаниеУслуги.Клиент КАК Клиент
ИЗ
Документ.ОказаниеУслуги КАК ОказаниеУслуги
ГДЕ
ОказаниеУслуги.ПереченьНоменклатуры.Номенклатура В
(ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка = &Документ)
УПОРЯДОЧИТЬ ПО
Ссылка
АВТОУПОРЯДОЧИВАНИЕ
В условии отбора (ОказаниеУслуги.ПереченьНоменклатуры.Номенклатура В ()) значение поля Номенклатура из табличной части ПереченьНоменклатуры документа ОказаниеУслуги проверяется на попадание в перечень возможных значений. Для получения этого набора значений используется вложенный запрос. Описание вложенного запроса начинается с предложения ВЫБРАТЬ и ничем не отличается от обычного запроса.
Обратите внимание, что текст вложенного запроса принято располагать со смещением относительно основного запроса для повышения наглядности и структурированности запроса в целом.
Напишите в консоли запросов текст, показанный в листинге 11.29, задайте параметр запроса – «Приходная накладная № 1». Если вы не помните, как задавать значения параметров запроса, посмотрите рис. 11.22.
После этого выполните только вложенный запрос. Для этого выделите его текст мышью и нажмите Выполнить (рис. 11.25).

Рис. 11.25. Выполнение вложенного запроса в консоли запросов {https://ai2b.pro/wp-content/uploads/1/ch11_025.png}
В результате будет получен перечень товаров из табличной части приходной накладной, выбранной в качестве значения параметра Документ.
При выполнении внешнего запроса сначала выполняется вложенный запрос, и результат его выполнения подставляется в условие отбора внешнего запроса.
Теперь снимите выделение в консоли запросов и выполните весь запрос целиком. В результате выполнения основного запроса (листинг 11.29) вы увидите список документов ОказаниеУслуги, в которых продавались товары, перечисленные в конкретной приходной накладной, указанной в параметре Документ (рис. 11.26).

Рис. 11.26. Использование вложенного запроса в условии отбора {https://ai2b.pro/wp-content/uploads/1/ch11_026.png}
Таким же образом вложенные запросы могут использоваться в условии отбора, передаваемом в качестве параметра в виртуальную таблицу. В этом случае при формировании виртуальной таблицы на основе исходной (реальной) таблицы базы данных выборка значений из исходной таблицы будет ограничена набором значений, полученным в результате выполнения вложенного запроса.
Например, виртуальная таблица РегистрНакопления.ОстаткиМатериалов.Остатки возвращает остатки по каждому материалу на указанную дату. Эта таблица имеет параметры Период и Условие, которые вы можете использовать в языке запросов.
В параметре Период вы можете задать дату, на которую должны быть получены остатки. В параметре Условие вы можете задать условие отбора записей из исходной (реальной) таблицы регистра накопления при формировании виртуальной таблицы.
Допустим, вам нужно увидеть актуальные остатки материалов на сегодняшнюю дату. Но не для всех материалов, а только для тех, которые перечислены в конкретной приходной накладной. Для этого нужно выполнить следующий запрос (листинг 11.30).
Листинг 11.30. Использование вложенного запроса в условии отбора, передаваемом в параметр виртуальной таблицы
ВЫБРАТЬ
ОстаткиМатериаловОстатки.Материал КАК Материал,
ОстаткиМатериаловОстатки.Склад КАК Склад,
ОстаткиМатериаловОстатки.КоличествоОстаток КАК КоличествоОстаток
ИЗ
РегистрНакопления.ОстаткиМатериалов.Остатки(
,
Материал В (ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка = &Документ))
КАК ОстаткиМатериаловОстатки
УПОРЯДОЧИТЬ ПО
Материал
АВТОУПОРЯДОЧИВАНИЕ
В данном запросе нет ничего необычного, кроме того, что после имени виртуальной таблицы РегистрНакопления.ОстаткиМатериалов.Остатки в скобках вы можете задать параметры для отбора записей регистра накоплений в эту таблицу.
Поскольку вы хотите увидеть актуальные остатки, параметр Период вы не указываете. В параметре Условие вы задаете произвольное условие на языке запросов, использующее любые поля регистра накопления ОстаткиМатериалов.
В этом условии (Материал В ()) значение поля регистра накопления Материал проверяется на попадание в перечень возможных значений. Для получения этого набора значений используется вложенный запрос. Таким образом, при формировании виртуальной таблицы из исходной (реальной) таблицы регистра накопления ОстаткиМатериалов будут отбираться записи об изменении цен только тех материалов, которые перечислены в приходной накладной, выбранной в качестве значения параметра Документ.
В результате выполнения запроса вы увидите актуальные остатки материалов, перечисленных в конкретной приходной накладной (рис. 11.27).

Рис. 11.27. Использование вложенного запроса в условии отбора, передаваемом в параметр виртуальной таблицы {https://ai2b.pro/wp-content/uploads/1/ch11_027.png}

##### Как получить данные из разных таблиц для одного и того же поля
Часто в результате запроса требуется вывести данные из разных таблиц, связав их по значению некоторого поля, то есть какие-то поля вывести из одной таблицы, какие-то – из другой для одного и того же значения поля из этих таблиц. Например, можно вывести для одного и того же товара количество его поступлений и продаж.
В этом случае используются несколько источников данных, которые перечисляются после ключевого слова ИЗ. В качестве источников запроса могут выступать реальные и виртуальные таблицы, а также вложенные запросы, но для упрощения примера вы будете рассматривать ситуацию, когда в качестве источников запроса выступают две таблицы базы данных.
Исходные таблицы запроса обычно связываются (соединяются) между собой по некоторому условию – условию связи. Поле, по которому производится связь, обычно имеет ссылочный тип. При соединении данных из исходных таблиц запроса для каждой записи из этих таблиц проверяется условие равенства значений ссылочных полей этого типа. Условие связи источников запроса задается в предложении ИЗ, после ключевого слова ПО. Например, спрНоменклатура.Ссылка = ЦеныСрезПоследних.Номенклатура.
В зависимости от того, должны ли записи каждой из таблиц удовлетворять условию связи, таблицы соединяются внутренним, левым, правым или полным внешним соединением. В этом примере вы рассмотрите только один вид соединения – левое соединение. Ключевые слова, определяющие тип соединения (например, ЛЕВОЕ СОЕДИНЕНИЕ), располагаются между именами таблиц в предложении ИЗ.
Допустим, вы хотите вывести список номенклатуры из справочника Номенклатура и при этом показать для каждого элемента номенклатуры последнюю установленную на него цену.
У вас есть регистр сведений Цены, который хранит информацию об изменении цен номенклатуры во времени. Виртуальная таблица СрезПоследних этого регистра сведений позволяет получить информацию о последних ценах, установленных для каждого элемента номенклатуры.
Для выполнения поставленной задачи вам нужно соединить в запросе данные из таблиц Справочник.Номенклатура и РегистрСведений.Цены.СрезПоследних.
Регистр сведений Цены содержит поле Номенклатура, ссылающееся на справочник Номенклатура. По этому полю и будет осуществляться связь таблиц в запросе, то есть в условии связи для каждой записи из обеих таблиц будут сравниваться значения уникального поля Ссылка из справочника и ссылочного поля Номенклатура из среза последних записей регистра сведений.
Исходные данные, используемые в примере о соединении таблиц в запросе, представлены на рис. 11.28.

Рис. 11.28. Исходные записи справочника «Номенклатура» и регистра сведений «Цены» {https://ai2b.pro/wp-content/uploads/1/ch11_028.png}
Однако, как вы видите на рисунке, не для всех элементов справочника Номенклатура существует соответствующая им цена в срезе последних записей регистра сведений Цены. В частности, для записей справочника Радиодетали, Материалы, Телевизоры и других записей, являющихся группами, не найдено соответствий в регистре сведений, так как цены на них не имеют смысла.
Если связать таблицы справочника и регистра левым соединением, то в результат запроса попадут записи из обеих таблиц, удовлетворяющие условию связи, и кроме того – записи из первой таблицы, расположенной слева от ключевого слова СОЕДИНЕНИЕ, для которых не найдено соответствия во второй таблице (листинг 11.31).
Листинг 11.31. Левое внешнее соединение справочника «Номенклатура» и среза последних записей регистра сведений «Цены»
ВЫБРАТЬ
спрНоменклатура.Код КАК Код,
спрНоменклатура.Наименование КАК Наименование,
ЦеныСрезПоследних.Цена КАК Цена
ИЗ
Справочник.Номенклатура КАК спрНоменклатура
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних КАК ЦеныСрезПоследних
ПО (спрНоменклатура.Ссылка = ЦеныСрезПоследних.Номенклатура)
 
УПОРЯДОЧИТЬ ПО
Код
Результат этого запроса представлен на рис. 11.29.

Рис. 11.29. Левое внешнее соединение данных справочника «Номенклатура» и среза последних записей регистра сведений «Цены» {https://ai2b.pro/wp-content/uploads/1/ch11_029.png}
Вы видите, что в результат запроса попали все 16 записей из справочника Номенклатура (рис. 11.28) независимо от того, была найдена соответствующая им запись из среза последних записей регистра сведений Цены или нет. Так произошло потому, что таблица Справочник.Номенклатура расположена слева от слова СОЕДИНЕНИЕ.
Строки результата запроса, для которых не найдено соответствующих условию записей из второго источника, будут содержать значение NULL в полях, формируемых на основании записей из этого источника. Обратите внимание, что значения NULL не являются нулем или пустой строкой. Значения данного типа обозначают неуказанные (отсутствующие) значения или значения, не имеющие смысла. В данном случае в поле Цена для номенклатуры Радиодетали, Прочее, Материалы, Услуги, Телевизоры и Стиральные машины будет находиться значение NULL.
Из второй таблицы в результат запроса попадут только записи, удовлетворяющие условию связи, то есть если в справочнике Номенклатура не существует товара, для которого установлена цена в регистре сведений, то такая запись не попадет в результат запроса.

##### Как получить данные из разных таблиц, связанных несколькими соединениями
Рассмотрите теперь более сложную задачу, когда в результате запроса используется несколько соединений данных из нескольких таблиц, и проанализируйте подробно каждый этап такого соединения. Например, вам необходимо вывести список номенклатуры и при этом показать не только цену каждого элемента, но и его остаток.
Для выполнения этой задачи вам нужно соединить в запросе данные из таблиц Справочник.Номенклатура, РегистрСведений.Цены.СрезПоследних и РегистрНакопления.ОстаткиМатериалов.Остатки.
Регистр сведений Цены содержит поле Номенклатура, а регистр накопления ОстаткиТоваров – поле Материал. Эти поля ссылаются на справочник Номенклатура. По этим полям и будет производиться связь таблиц в запросе.
Исходные данные представлены на рис. 11.30.

Рис. 11.30. Исходные записи справочника «Номенклатура» и виртуальных таблиц регистров «Цены» и «ОстаткиТоваров» {https://ai2b.pro/wp-content/uploads/1/ch11_030.png}
Вы видите, что в справочнике Номенклатура содержится десять записей, которые не являются группой, так как на таблицу справочника наложено соответствующее условие. Также вы видите, что записи всех трех таблиц, используемых в примере, не полностью соответствуют друг другу по полю Номенклатура / Материал. Есть целый ряд элементов номенклатуры, которые еще не поступали в компанию и поэтому не имеют остатка. Эти особенности будут отражены в результате запроса, когда вы будете связывать данные всех таблиц между собой.
Свяжите данные всех трех таблиц левыми соединениями и выведите из справочника Номенклатура поля Код и Наименование, из виртуальной таблицы регистра накопления Цены.СрезПоследних – поле Цена и из виртуальной таблицы регистра накопления ОстаткиТоваров.Остатки – поле КоличествоОстаток (листинг 11.32).
Листинг 11.32. Левое соединение данных справочника «Номенклатура» и виртуальных таблиц цен и остатков
ВЫБРАТЬ
спрНоменклатура.Код КАК Код,
спрНоменклатура.Наименование КАК Наименование,
ЦеныСрезПоследних.Цена КАК Цена,
ОстаткиМатериаловОстатки.КоличествоОстаток КАК КоличествоОстаток
ИЗ
Справочник.Номенклатура КАК спрНоменклатура
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних КАК ЦеныСрезПоследних
ПО (спрНоменклатура.Ссылка = ЦеныСрезПоследних.Номенклатура)
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиМатериалов.Остатки КАК ОстаткиМатериаловОстатки
ПО (спрНоменклатура.Ссылка = ОстаткиМатериаловОстатки.Материал)
ГДЕ
спрНоменклатура.ЭтоГруппа = ЛОЖЬ
 
УПОРЯДОЧИТЬ ПО
спрНоменклатура.Ссылка
АВТОУПОРЯДОЧИВАНИЕ
Результат запроса представлен на рис. 11.31.

Рис. 11.31. Левое соединение данных справочника «Номенклатура» и виртуальных таблиц цен и остатков {https://ai2b.pro/wp-content/uploads/1/ch11_031.png}
Вы видите, что в результат запроса попали все записи (10 элементов) из справочника Номенклатура, как и должно быть при левом соединении. Для каждого элемента номенклатуры были найдены соответствующие записи в виртуальных таблицах цен и остатков и подставлены в результат запроса.

##### Временные таблицы и пакетные запросы
Довольно часто бывают ситуации, когда в качестве источника запроса необходимо использовать не таблицы базы данных, а данные, полученные в результате выполнения другого запроса. Например, источником запроса могут служить данные приходных накладных, сгруппированные по товарам или отобранные по дате документа.
Запрос, служащий источником данных, является вложенным, а запрос, который эти данные использует, является основным, или внешним.
Рассмотрите эту ситуацию на примере. Допустим, вам нужно вывести данные обо всей номенклатуре с соблюдением иерархии справочника Номенклатура. Для каждого элемента справочника вы хотите видеть дату его поступления и номер приходной накладной.
Казалось бы, в этом нет ничего особенно сложного. Свяжите левым соединением таблицы справочника Номенклатура и документа ПриходнаяНакладная по ссылкам товаров и выведите требуемые поля из обеих таблиц. При этом упорядочьте результат запроса по наименованиям товаров в порядке иерархии справочника (листинг 11.33).
Листинг 11.33. Вывод всех товаров в порядке иерархии справочника «Номенклатура» с данными об их поступлении
ВЫБРАТЬ
Номенклатура.Наименование КАК Наименование,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ИЗ
Справочник.Номенклатура КАК Номенклатура
ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ПО Номенклатура.Ссылка = ПриходнаяНакладнаяМатериалы.Материал
 
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
Результат выполнения запроса представлен на рис. 11.32.

Рис. 11.32. Вывод всех товаров в порядке иерархии справочника «Номенклатура» с данными об их поступлении {https://ai2b.pro/wp-content/uploads/1/ch11_032.png}
На реальной базе, конечно, список товаров может быть очень большим. Предположим, вы хотите получить тот же список, но с данными о поступлениях товаров только из приходной накладной № 1.
Для этого наложите условие на поле Номер приходной накладной (листинг 11.34).
Листинг 11.34. Вывод всех товаров в порядке иерархии справочника «Номенклатура» с данными об их поступлении из приходной накладной № 1
ВЫБРАТЬ
Номенклатура.Наименование КАК Наименование,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ИЗ
Справочник.Номенклатура КАК Номенклатура
ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ПО (Номенклатура.Ссылка = ПриходнаяНакладнаяМатериалы.Материал)
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"
 
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
Вы видите, что результат запроса несколько не такой, как вы ожидали (рис. 11.33).

Рис. 11.33. Вывод товаров в порядке иерархии справочника «Номенклатура» с данными об их поступлении из приходной накладной № 1 {https://ai2b.pro/wp-content/uploads/1/ch11_033.png}
В результате выполнения запроса отражена только та номенклатура, которая присутствует в приходной накладной № 1, и отсутствует иерархия справочника Номенклатура, так как в результате запроса нет данных для построения иерархии. Так произошло потому, что при накладывании условия отбора на поле правой таблицы (ПриходнаяНакладнаяМатериалы) при левом соединении тип соединения становится внутренним.
В этом и в некоторых других случаях выходом из ситуации является использование вложенного запроса в качестве источника для внешнего запроса. Поэтому предыдущий запрос можно переписать следующим образом (листинг 11.35).
Листинг 11.35. Вывод всех товаров в порядке иерархии справочника «Номенклатура» с данными об их поступлении из приходной накладной № 1
ВЫБРАТЬ
Номенклатура.Наименование КАК Наименование,
НакладнаяМатериалы.Дата КАК Дата,
НакладнаяМатериалы.Номер КАК Номер
ИЗ
Справочник.Номенклатура КАК Номенклатура
ЛЕВОЕ СОЕДИНЕНИЕ
(ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001") КАК НакладнаяМатериалы
ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
 
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
В тексте основного запроса вложенный запрос НакладнаяМатериалы выделен жирным шрифтом. При выполнении основного запроса сначала выполняется вложенный запрос, в котором получаются данные о поступлении номенклатуры из приходной накладной. Затем справочник Номенклатура связывается левым соединением с результатом вложенного запроса по ссылкам номенклатуры, и в итоге вы получаете требуемый результат (рис. 11.34).

Рис. 11.34. Вывод всех товаров в порядке иерархии справочника «Номенклатура» с данными об их поступлении из приходной накладной № 1 {https://ai2b.pro/wp-content/uploads/1/ch11_034.png}
Однако вы видите, что текст запроса (см. листинг 11.35) стал довольно громоздким и сложным для восприятия. С этой точки зрения лучше поместить результат вложенного запроса во временную таблицу и затем использовать ее как источник вашего основного запроса.
Временная таблица не существует в базе данных. Это просто некоторая область в памяти компьютера, которая создается на ограниченное время, как, например, это происходит при создании какой-либо переменной встроенного языка. Эта область создается и заполняется данными при выполнении запроса, содержащего ключевое слово ПОМЕСТИТЬ, после которого следует произвольное имя временной таблицы.
Возьмите только текст вложенного запроса и дополните его предложением ПОМЕСТИТЬ, которое располагается сразу после списка полей выборки (листинг 11.36).
Листинг 11.36. Помещение данных о поступлениях товаров во временную таблицу
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ПОМЕСТИТЬ НакладнаяМатериалы
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"
Примечание
Заметьте, что для быстрой и эффективной выборки данных из временной таблицы желательно проиндексировать эту таблицу по полям, которые будут затем участвовать в условии отбора или в условии соединения. Делается это с помощью предложения ИНДЕКСИРОВАТЬ ПО.
Чтобы увидеть данные, помещенные во временную таблицу, в консоли запросов нажмите Выполнить запрос с временными таблицами рядом с кнопкой Выполнить (рис. 11.35).

Рис. 11.35. Данные временной таблицы «НакладнаяМатериалы» {https://ai2b.pro/wp-content/uploads/1/ch11_035.png}
Итак, в результате выполнения запроса (листинг 11.36) вы поместили данные о поступлениях товаров во временную таблицу с именем НакладнаяМатериалы.
Теперь эту таблицу можно использовать в качестве источника других запросов точно так же, как и таблицу базы данных. Но сделать это можно либо из встроенного языка с помощью менеджера временных таблиц (этот вариант вы рассмотрите позже, в разделе «Использование временных таблиц с помощью встроенного языка»), либо с помощью пакетного запроса. Этот вариант вы рассмотрите сейчас.
Пакетный запрос содержит последовательность запросов, разделенных символом «;» (точка с запятой). При выполнении пакетного запроса входящие в него запросы выполняются друг за другом. При этом если при выполнении одного из запросов была создана временная таблица, то следующие за ним запросы при их выполнении могут использовать данные этой временной таблицы.
Таким образом, после запроса из листинга 11.36 поставьте точку с запятой и допишите выборку из справочника Номенклатура с левым соединением с временной таблицей НакладнаяМатериалы (листинг 11.37).
Листинг 11.37. Вывод номенклатуры в порядке иерархии с данными о ее поступлении
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ПОМЕСТИТЬ НакладнаяМатериалы
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"
;
ВЫБРАТЬ
Номенклатура.Наименование КАК Наименование,
НакладнаяМатериалы.Дата КАК Дата,
НакладнаяМатериалы.Номер КАК Номер
ИЗ
Справочник.Номенклатура КАК Номенклатура
ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
 
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
В первом запросе вы помещаете данные о поступлении товаров во временную таблицу с именем НакладнаяМатериалы. Затем следует символ «;» (точка с запятой), который указывает на то, что это – пакетный запрос. В следующем запросе справочник товаров связывается левым соединением с временной таблицей по ссылкам номенклатуры, и в итоге вы получаете результат, аналогичный результату при выполнении запроса, содержащего вложенный запрос (рис. 11.34).
Таким образом, можно сделать вывод, что текст запроса в случае использования временных таблиц становится более понятным и осмысленным, чем при использовании вместо них вложенных запросов.
Также использование временных таблиц вместо вложенных запросов почти всегда делает запрос более оптимальным. С точки зрения эффективности исполнения запросов крайне не рекомендуется использовать соединения с вложенными запросами, так как в этом случае СУБД может выбрать неоптимальный план запроса, что на больших объемах данных приводит к временным задержкам и другим неприятностям при выполнении таких запросов.


### Конструктор запроса
Вы познакомились с азами языка запросов, научились создавать синтаксически правильные тексты запросов и выполнять их в консоли запросов. Для решения небольших демонстрационных задач вы писали текст запросов вручную, в специальном окне консоли запросов, и затем сразу же могли увидеть результат выполнения запроса. На начальном этапе это было очень полезно, чтобы набраться опыта при создании простых запросов и закрепить понимание пройденного материала.
Но в дальнейшем для решения реальных задач написание запросов вручную может быть довольно утомительным. Кроме того, помимо знания всех синтаксических конструкций и правил составления запросов это потребует от вас знания имен таблиц языка запросов, их полей и параметров, что потребует постоянного обращения к синтакс-помощнику или встроенной справке.
Поэтому в 1C:EDT существуют инструменты для облегчения вашего труда при написании запросов – конструктор запроса и конструктор запроса с обработкой результата.
С помощью конструктора запроса можно визуально сконструировать запрос, то есть выбрать мышью и перетащить нужные таблицы, поля, установить связи между ними, условия отбора и т. д. После нажатия кнопки ОК конструктор запроса создаст синтаксически правильный текст запроса.
С помощью конструктора запроса с обработкой результата можно помимо самого текста запроса создать готовый фрагмент кода для получения данных с помощью запроса и вывода их, например, в табличный документ.
Чтобы научиться работать с конструктором запроса, вы будете использовать обработку, которую добавите в 1C:EDT в состав вашего проекта.
Перейдите в 1C:EDT и добавьте в конфигурацию новую обработку. Назовите ее РаботаСЗапросами, включите ее в подсистему Предприятие.
Создайте форму обработки и в модуле формы добавьте обработчик события ПриСозданииНаСервере. Это событие формы (в дереве элементов нужно выделить корень – Форма). В этом обработчике вы и будете писать все дальнейшие примеры, а для их запуска вам достаточно будет запустить прикладное решение в режиме отладки, а в нем – эту обработку.
#### Создание простого запроса
Первый запрос, который вы создадите с помощью конструктора – это запрос для отображения в порядке иерархии всех элементов справочника Номенклатура (листинг 11.38).
Листинг 11.38. Вывод записей справочника «Номенклатура», расположенных в порядке иерархии
ВЫБРАТЬ
Номенклатура.Код,
Номенклатура.Наименование,
Номенклатура.Родитель,
Номенклатура.ЭтоГруппа
ИЗ
Справочник.Номенклатура КАК Номенклатура
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
Сначала напишите в модуле формы заготовку программного кода, который будет формировать запрос (листинг 11.39).
Листинг 11.39. Заготовка для создания запроса
Запрос = Новый Запрос;
Запрос.Текст = "";
Затем поместите курсор между кавычек и нажмите Конструктор запроса… в контекстном меню (рис. 11.36).

Рис. 11.36. Вызов конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_036.png}
После этого откроется конструктор запроса (рис. 11.37).

Рис. 11.37. Конструктор запроса {https://ai2b.pro/wp-content/uploads/1/ch11_037.png}
Сначала вы попадаете на основную закладку конструктора Таблицы и поля. На этой закладке в списке База данных можно выбрать реальные и виртуальные таблицы в качестве источников запроса.
Раскройте группу Справочники, выберите таблицу Номенклатура и перетащите ее в список Таблицы. В этом списке можно выбрать поля для отображения в запросе.
Раскройте структуру выбранной таблицы и перенесите в список Поля поля Код, Наименование, Родитель, ЭтоГруппа (рис. 11.38).

Рис. 11.38. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_038.png}
ПРИМЕЧАНИЕ
Выделенные элементы можно перенести из одного списка в другой перетаскиванием мышью или двойным щелчком на них. Либо можно использовать кнопки >, >>, <, <<.
На любом этапе создания запроса, не выходя из конструктора запроса (не нажимая ОК), можно увидеть, как изменяется текст запроса в процессе работы. Для этого нужно нажать кнопку Запрос в правом нижнем углу окна конструктора запроса.
Нажмите эту кнопку и посмотрите, какой текст запроса создал конструктор (рис. 11.39). В этом же окне при необходимости вы можете отредактировать текст запроса вручную.

Рис. 11.39. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_039.png}
Вы видите, что в запросе выбираются поля Код, Наименование, Родитель, ЭтоГруппа из справочника Номенклатура. Таким образом, на закладке Таблицы и поля конструктора запроса формируются основные предложения языка запросов ВЫБРАТЬ, ИЗ.
Нажмите ОК или Отмена, чтобы закрыть окно редактора запроса.
Теперь перейдите на закладку Объединения/Псевдонимы, чтобы задать псевдонимы полей запроса. Задайте псевдоним КодТовара для поля Код (рис. 11.40).

Рис. 11.40. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_040.png}
Нажмите Запрос и посмотрите, как изменился текст запроса (рис. 11.41).

Рис. 11.41. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_041.png}
Вы видите, что к тексту запроса конструктор добавляет псевдонимы полей и ключевое слово КАК.
В заключение перейдите на закладку Порядок и задайте упорядочивание записей результата запроса. Из списка полей выберите поле Номенклатура.Ссылка, установите тип упорядочивания – Возрастание иерархии и установите флажок Автоупорядочивание (рис. 11.42).

Рис. 11.42. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_042.png}
Нажмите Запрос и посмотрите, как изменился текст запроса (рис. 11.43).

Рис. 11.43. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_043.png}
Вы видите, что к тексту запроса конструктор добавляет предложение УПОРЯДОЧИТЬ ПО.
Закройте редактор запроса, а затем нажмите ОК в конструкторе запроса. Вы вернетесь в модуль формы.
Запрос, сформированный с помощью конструктора запроса, будет выглядеть следующим образом (листинг 11.40).
Листинг 11.40. Запрос, созданный конструктором
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	Номенклатура.Код КАК КодТовара,
|	Номенклатура.Наименование,
|	Номенклатура.Родитель,
|	Номенклатура.ЭтоГруппа
|ИЗ
|	Справочник.Номенклатура КАК Номенклатура+
|
|УПОРЯДОЧИТЬ ПО
|	Номенклатура.Ссылка ИЕРАРХИЯ
|АВТОУПОРЯДОЧИВАНИЕ";
Для дальнейшего изменения запроса можно поместить курсор внутрь текста запроса и снова вызвать конструктор запроса из контекстного меню. Если при этом текст запроса содержит ошибки, то конструктор запроса укажет на них и не будет открыт, пока эти ошибки вручную не будут исправлены. Таким образом, конструктор запроса помогает вам создать запрос с нуля, а также найти собственные ошибки уже в существующем запросе, если вы написали его в модуле вручную.
Откройте существующий запрос в конструкторе запроса и доработайте его. Добавьте в запрос условие отбора, чтобы в результате запроса отображались только те записи из справочника Номенклатура, которые не являются группой.
Для этого перейдите на закладку Условия и перетащите в список условий поле ЭтоГруппа из таблицы Товары. Платформа автоматически создаст условие с этим полем, но в данном случае вам нужно другое условие (рис. 11.44).

Рис. 11.44. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_044.png}
Чтобы изменить условие отбора, дважды щелкните на нем мышью. Откроется окно редактирования выражений (рис. 11.45).

Рис. 11.45. Окно редактирования произвольного выражения {https://ai2b.pro/wp-content/uploads/1/ch11_045.png}
Задайте условие Номенклатура.ЭтоГруппа = ЛОЖЬ и нажмите ОК (рис. 11.46).

Рис. 11.46. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_046.png}
Нажмите Запрос и посмотрите, как изменился текст запроса (рис. 11.47).

Рис. 11.47. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_047.png}
Вы видите, что к тексту запроса конструктор добавляет предложение ГДЕ.
Закройте окно редактора запроса и нажмите ОК. Вы вернулись в модуль формы. Текст запроса, сформированный с помощью конструктора запроса, заменил собой прежний вариант (рис. 11.48).

Рис. 11.48. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_048.png}

#### Связи источников запроса
Теперь создайте с помощью конструктора запрос, выводящий перечень номенклатуры и показывающий актуальную цену для каждого элемента (листинг 11.41).
Листинг 11.41. Левое внешнее соединение справочника «Номенклатура» и среза последних записей регистра сведений «Цены»
ВЫБРАТЬ
спрНоменклатура.Код,
спрНоменклатура.Наименование,
ЦеныСрезПоследних.Цена
ИЗ
Справочник.Номенклатура КАК спрНоменклатура
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних КАК ЦеныСрезПоследних
ПО ЦеныСрезПоследних.Номенклатура = спрНоменклатура.Ссылка
ГДЕ
спрНоменклатура.ЭтоГруппа = ЛОЖЬ
УПОРЯДОЧИТЬ ПО
спрНоменклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
Если у вас остался запрос от предыдущего примера – удалите его текст из модуля и откройте конструктор, чтобы создать новый запрос.
Из текста запроса вы видите, что в качестве источников запроса здесь выступают две таблицы: Справочник.Номенклатура и РегистрСведений.Цены.СрезПоследних, которые связаны между собой левым внешним соединением.
Для того чтобы получить такой запрос с помощью конструктора запроса, нужно на закладке Таблицы и поля перенести обе эти таблицы в список источников запроса.
Чтобы исключить неоднозначность полей в запросе, таблицу справочника Номенклатура нужно переименовать – например, в спрНоменклатура. Для этого нажмите Переименовать таблицу в ее контекстном меню (рис. 11.49).

Рис. 11.49. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_049.png}
После этого выберите из таблицы спрНоменклатура поля Код и Наименование, а из таблицы Цены.СрезПоследних – поле Цена (рис. 11.50).

Рис. 11.50. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_050.png}
В случае если в запросе участвуют несколько таблиц, в конструкторе запроса становится доступной закладка Связи, на которой задаются тип связи и условие связи между таблицами. В тех случаях, когда это возможно, платформа сама устанавливает связь между источниками запроса по ссылочным полям (рис. 11.51).

Рис. 11.51. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_051.png}
В этом условии вас все устраивает, кроме того, что таблица регистра – слева, а таблица справочника – справа. Чтобы поменять таблицы местами, выделите таблицу регистра и нажмите Переместить в контекстном меню (рис. 11.52).

Рис. 11.52. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_052.png}
После этого выберите таблицу спрНоменклатура. Таблицы поменяются местами.
После этого вам останется только задать условие отбора (рис. 11.46) и сортировку результата запроса (рис. 11.42).
В результате в модуле формы вы получите следующий текст (рис. 11.53).

Рис. 11.53. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_053.png}

#### Создание пакетного запроса, использующего временную таблицу
В этом разделе вы узнаете, как с помощью конструктора запроса создать временную таблицу и затем использовать ее в пакетном запросе. Например, вам нужно вывести все элементы номенклатуры в порядке иерархии и показать, какие из них были получены в приходной накладной № 1 (листинг 11.42). Этот пример вы рассматривали в разделе «Временные таблицы и пакетные запросы».
Листинг 11.42. Вывод номенклатуры в порядке иерархии справочника «Номенклатура» с данными об их поступлении в приходной накладной № 1
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ПОМЕСТИТЬ НакладнаяМатериалы
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"
;
ВЫБРАТЬ
Номенклатура.Наименование КАК Наименование,
НакладнаяМатериалы.Дата КАК Дата,
НакладнаяМатериалы.Номер КАК Номер
ИЗ
Справочник.Номенклатура КАК Номенклатура
ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
 
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
Чтобы получить такой запрос с помощью конструктора, нужно:
Сформировать первый запрос для заполнения данными временной таблицы.
На закладке Пакет запросов добавить в пакет запросов запрос, который будет использовать данные этой таблицы.
На закладке Таблицы и поля создать описание этой временной таблицы и использовать ее как источник второго запроса.
Если у вас остался запрос от предыдущего примера – удалите его текст из модуля и откройте конструктор, чтобы создать новый запрос.
Итак, сначала создайте запрос для получения временной таблицы, содержащей информацию о поступлении товаров из приходной накладной № 1.
Для этого на закладке Таблицы и поля перенесите табличную часть Материалы документа ПриходнаяНакладная в список источников запроса и выберите из этой таблицы поля (рис. 11.54):
Материал,
Ссылка.Дата,
Ссылка.Номер.

Рис. 11.54. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_054.png}
На закладке Условия задайте произвольное условие отбора записей из приходных накладных так, чтобы во временную таблицу попадали только данные из накладной № 1 (рис. 11.55):
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"

Рис. 11.55. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_055.png}
На закладке Дополнительно включите опцию Создание временной таблицы и укажите, что результат запроса нужно поместить во временную таблицу с именем НакладнаяМатериалы (рис. 11.56).

Рис. 11.56. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_056.png}
Примечание
Обратите внимание, что при создании временной таблицы в конструкторе запроса исчезают закладки Порядок и Итоги и появляется закладка Индекс, на которой можно задать поля, по которым временная таблица будет проиндексирована.
Кроме того, на закладке Дополнительно можно задать дополнительные критерии отбора записей в результат запроса (флажки Первые, Без повторяющихся, Разрешенные) и задать необходимость блокировки таблиц – источников запроса.
Нажмите Запрос и посмотрите, как изменился текст запроса (рис. 11.57).

Рис. 11.57. Текст запроса, созданный конструктором {https://ai2b.pro/wp-content/uploads/1/ch11_057.png}
Вы видите, что в тексте запроса появилась конструкция ПОМЕСТИТЬ, с помощью которой данные помещаются во временную таблицу.
Итак, вы сформировали первый запрос из пакетного запроса (см. листинг 11.42).
Теперь закройте окно редактора запроса и перейдите на закладку Пакет запросов.
Вы видите, что в пакете запросов уже присутствует один запрос НакладнаяМатериалы для получения данных временной таблицы. Нажмите Добавить и добавьте в пакет запросов еще один запрос (рис. 11.58).

Рис. 11.58. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_058.png}
Конструктор запроса добавит новый запрос и сразу же переключится на его редактирование. О том, что в конструкторе запроса содержится два запроса, вы можете узнать из поля Редактируемый запрос. Оно содержит список запросов и показывает тот запрос, который редактируется в данный момент (рис. 11.59).

Рис. 11.59. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_059.png}
Теперь создайте второй запрос из пакета.
На закладке Таблицы и поля нажмите значок Создать описание временной таблицы, задайте имя временной таблицы и опишите поля, указанные в первом запросе. Обратите внимание, что нужно указать также тип значения полей временной таблицы (рис. 11.60).

Рис. 11.60. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_060.png}
После описания временной таблицы она попадает в список источников второго запроса и вы можете выбирать из нее поля, как из любой другой таблицы базы данных.
Сформируйте исходные данные для второго запроса. Перенесите справочник Номенклатура в список источников запроса и выберите из этой таблицы поле Наименование. Из временной таблицы НакладнаяМатериалы выберите поля Дата и Номер (рис. 11.61).

Рис. 11.61. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_061.png}
Поскольку в списке источников запроса содержатся две таблицы, свяжите левым соединением таблицу Номенклатура с временной таблицей НакладнаяМатериалы (рис. 11.62).

Рис. 11.62. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_062.png}
В заключение на закладке Порядок задайте упорядочивание записей результата запроса по наименованиям товаров в порядке иерархии (рис. 11.63).

Рис. 11.63. Окно конструктора запроса {https://ai2b.pro/wp-content/uploads/1/ch11_063.png}
Нажмите ОК и вернитесь в модуль формы. Запрос, сформированный с помощью конструктора запроса, будет выглядеть следующим образом (листинг 11.43).
Листинг 11.43. Запрос, созданный конструктором
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ПОМЕСТИТЬ НакладнаяМатериалы
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = ""000000001""
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	Номенклатура.Наименование,
|	НакладнаяМатериалы.Дата,
|	НакладнаяМатериалы.Номер
|ИЗ
|	Справочник.Номенклатура КАК Номенклатура
|     	ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
|     	ПО НакладнаяМатериалы.Материал = Номенклатура.Ссылка
|
|УПОРЯДОЧИТЬ ПО
|	Номенклатура.Ссылка ИЕРАРХИЯ
|АВТОУПОРЯДОЧИВАНИЕ";

### Выполнение запросов из встроенного языка
На данном этапе изучения языка запросов вы можете наконец более подробно остановиться на том моменте, который раньше опускали в целях упрощения восприятия материала. Речь пойдет о выполнении запросов и обработке их результатов во встроенном языке.
В разделе «Общая схема выполнения запросов» вы рассматривали в самом простейшем виде схему выполнения запроса. Теперь рассмотрите ее более подробно.
Выполнение запроса во встроенном языке состоит из следующих этапов:
Создание объекта типа Запрос с нужным текстом запроса на языке запросов.
Установка параметров запроса с помощью метода УстановитьПараметр().
Выполнение запроса.
Затем либо:
Получение выборки из результата запроса.
Обход выборки и обработка данных, то есть выполнение действий, для которых был нужен запрос (например, вывод области при формировании табличного документа).
Либо:
Выгрузка результата в таблицу значений или дерево значений.
Обработка данных таблицы/дерева значений (например, перебор строк).
Графически это можно представить следующим образом (рис. 11.64):

Рис. 11.64. Схема выполнения запроса {https://ai2b.pro/wp-content/uploads/1/ch11_064.png}
Для формирования и выполнения запроса, а также для получения и обработки его результатов во встроенном языке предназначены следующие программные объекты:
Запрос,
РезультатЗапроса,
ВыборкаИзРезультатаЗапроса.
Важно помнить, что вся работа с запросами выполняется только на сервере.
Все дальнейшие примеры вы будете выполнять в обработке РаботаСЗапросами, которую вы создали в предыдущем разделе.
Если вы пропустили предыдущий раздел, создайте эту обработку сейчас. Перейдите в 1C:EDT и добавьте в конфигурацию новую обработку. Назовите ее РаботаСЗапросами, включите ее в подсистему Предприятие.
Создайте форму обработки и в модуле формы добавьте обработчик события ПриСозданииНаСервере. В этом обработчике вы и будете писать все дальнейшие примеры, а для их запуска вам достаточно будет запустить прикладное решение в режиме отладки, а в нем – эту обработку.
#### Создание запроса
Прежде всего нужно во встроенном языке создать объект Запрос. Затем, используя свойство Текст объекта Запрос, нужно поместить в него текст запроса, написанный на языке запросов. В тексте запроса описывается, какие данные из каких таблиц нужно получить и как эти данные представить.
Например, в следующем фрагменте кода создается программный объект Запрос, в тексте которого описывается, что нужно извлечь значения полей Материал, Ссылка.Дата и Ссылка.Номер из табличной части Материалы документов ПриходнаяНакладная (листинг 11.44).
Листинг 11.44. Пример запроса, созданного во встроенном языке
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы";
Этот этап выполнения запроса вам уже хорошо знаком.

#### Передача параметров в запрос
Допустим, вы хотите выбирать данные не из всех приходных накладных, а только из накладной № 1. Раньше, для упрощения, вы задавали отбор по номеру прямо в тексте запроса (листинг 11.45).
Листинг 11.45. Отбор записей из табличной части документа «ПриходнаяНакладная» по параметризуемому условию
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"
Однако далеко не всегда значение отбора известно заранее, поэтому в общем случае такие значения передаются в запрос через параметры. Вы уже использовали этот способ ранее (см. листинг 11.26), когда работали в консоли запросов в прикладном решении.
Теперь познакомьтесь с тем, как это действие выглядит во встроенном языке (листинг 11.46).
Листинг 11.46. Отбор записей из табличной части документа «ПриходнаяНакладная» по параметризуемому условию
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной
В этом запросе вы использовали параметр НомерНакладной. Если текст запроса содержит параметры, то перед выполнением запроса значения параметров должны быть переданы в запрос.
Это делается с помощью метода УстановитьПараметр() объекта Запрос (листинг 11.47).
Листинг 11.47. Установка параметров запроса во встроенном языке
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
 
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
Первым параметром в метод УстановитьПараметр() передается строка с именем параметра запроса ("НомерНакладной"), а вторым параметром передается значение этого параметра.

#### Получение выборки из результата запроса
После присвоения текста и установки параметров запрос запускается на выполнение с помощью метода Выполнить() объекта Запрос. Именно в этот момент и происходит чтение данных из базы данных. Прочитанные данные возвращаются в виде объекта РезультатЗапроса, содержащего выбранные данные из базы данных (листинг 11.48).
Листинг 11.48. Выполнение запроса
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
 
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
 
РезультатЗапроса = Запрос.Выполнить();
Таким образом, происходит третий этап выполнения запроса, показанный на схеме (рис. 11.64).
Результат выполнения запроса может не содержать строк. Проверку этого следует выполнять с помощью метода Пустой() объекта РезультатЗапроса (листинг 11.49).
Листинг 11.49. Проверка результата запроса на наличие записей
…
РезультатЗапроса = Запрос.Выполнить();
 
Если РезультатЗапроса.Пустой() Тогда
Сообщить("Записей по условию не найдено");
Возврат;
КонецЕсли;
 
Выборка = РезультатЗапроса.Выбрать();
…
Проверку на пустой результат запроса следует выполнять до получения выборки из результата запроса методом Выбрать(), поскольку на получение выборки будет затрачиваться дополнительное время.
Далее, чтобы обработать данные, содержащиеся в объекте РезультатЗапроса, из него получается выборка с помощью метода Выбрать(), который возвращает новый объект ВыборкаИзРезультатаЗапроса, то есть коллекцию данных, предназначенную для обхода ее элементов (листинг 11.50).
Листинг 11.50. Получение выборки из результата запроса
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
 
РезультатЗапроса = Запрос.Выполнить();
Выборка = РезультатЗапроса.Выбрать();
Таким образом, происходит четвертый этап выполнения запроса, показанный на схеме (рис. 11.64).

#### Обход выборки из результата запроса
Теперь рассмотрите подробно пятый этап выполнения запроса, показанный на схеме (рис. 11.64). На этом этапе и происходит то, ради чего, собственно, создавался и выполнялся запрос, – программная обработка результатов запроса для последующего представления их пользователю, например для вывода результатов запроса в табличный документ.
Для обхода выборки из результата запроса нужно организовать цикл, в котором перебираются элементы коллекции данных, содержащихся в объекте ВыборкаИзРезультатаЗапроса. Для этого используется метод выборки Следующий(), который позволяет перейти к следующей записи результата запроса в соответствии с порядком обхода выборки.
Этот метод вызывается в цикле Пока Выборка.Следующий() … Цикл до тех пор, пока не будет получено значение Ложь. При первом проходе цикла метод Следующий() позиционирует выборку на первую запись.
Следует иметь в виду, что если выборка из результата запроса получена, но ее метод Следующий() еще ни разу не вызывался (то есть выборка еще не спозиционирована), то значения полей выборки будут не определены – например, их нельзя будет посмотреть в отладчике.
При обходе выборки в теле цикла производятся необходимые действия над данными, полученными с помощью запроса (листинг 11.51).
Листинг 11.51. Обход выборки
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
 
РезультатЗапроса = Запрос.Выполнить();
Выборка = РезультатЗапроса.Выбрать();
 
Пока Выборка.Следующий() Цикл
Сообщить(Выборка.Материал);
 
КонецЦикла;
Результат запроса может содержать записи, не имеющие иерархии (например, список документов), или, наоборот, записи, обладающие иерархией (например, справочник Номенклатура). Поэтому существует несколько разных способов обхода выборки: в линейном порядке, в иерархическом порядке или по группировкам. Сейчас вы рассмотрите самый простой способ обхода выборки – линейный.
При линейном обходе выборка будет выдавать записи в той последовательности, в которой они располагаются в результате запроса.
Для получения линейной выборки из результата запроса необходимо вызвать метод Выбрать() объекта РезультатЗапроса без параметров либо с параметром ОбходРезультатаЗапроса.Прямой (листинг 11.52).
Листинг 11.52. Прямой порядок обхода выборки
Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
 
РезультатЗапроса = Запрос.Выполнить();
Выборка = РезультатЗапроса.Выбрать();
 
Пока Выборка.Следующий() Цикл
Сообщить("Материал: " + Выборка.Материал + " Дата: " + Выборка.Дата + " Номер: " + Выборка.Номер);
 
КонецЦикла;
Поместите этот код в обработку РаботаСЗапросами, запустите приложение и запустите эту обработку. В окно сообщений будут последовательно выданы данные о поступлении номенклатуры из приходной накладной № 1.

#### Использование временных таблиц с помощью встроенного языка
В этом разделе вы рассмотрите, как использовать данные временной таблицы с помощью встроенного языка. В разделе «Временные таблицы и пакетные запросы» вы использовали данные временной таблицы в пакетном запросе.
В первом запросе пакета создавалась временная таблица НакладнаяМатериалы, содержащая данные о поступлении товаров из приходной накладной № 1. Во втором запросе пакета таблица справочника Номенклатура связывалась левым соединением с этой временной таблицей. В результате выполнения данного пакетного запроса в консоли запросов вы получали список номенклатуры в порядке иерархии с данными о ее поступлении (листинг 11.53).
Листинг 11.53. Вывод номенклатуры в порядке иерархии с данными о ее поступлении
ВЫБРАТЬ
ПриходнаяНакладнаяМатериалы.Материал КАК Материал,
ПриходнаяНакладнаяМатериалы.Ссылка.Дата КАК Дата,
ПриходнаяНакладнаяМатериалы.Ссылка.Номер КАК Номер
ПОМЕСТИТЬ НакладнаяМатериалы
ИЗ
Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
ГДЕ
ПриходнаяНакладнаяМатериалы.Ссылка.Номер = "000000001"
;
ВЫБРАТЬ
Номенклатура.Наименование КАК Наименование,
НакладнаяМатериалы.Дата КАК Дата,
НакладнаяМатериалы.Номер КАК Номер
ИЗ
Справочник.Номенклатура КАК Номенклатура
ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
 
УПОРЯДОЧИТЬ ПО
Номенклатура.Ссылка ИЕРАРХИЯ
АВТОУПОРЯДОЧИВАНИЕ
Используя имеющиеся знания, вы без труда можете выполнить этот запрос из встроенного языка. В этом случае временная таблица НакладнаяМатериалы будет использоваться только в этом запросе.
Однако в прикладных решениях встречаются такие задачи, в которых одна и та же временная таблица, полученная запросом, должна использоваться не в одном, а в нескольких запросах, которые могут находиться в разных частях модуля.
Такая возможность реализуется с помощью объекта встроенного языка МенеджерВременныхТаблиц, который предназначен для хранения данных временных таблиц. Сначала вы создаете программный объект МенеджерВременныхТаблиц, затем создаете объект Запрос и связываете его с менеджером временных таблиц через свойство запроса МенеджерВременныхТаблиц (листинг 11.54).
Листинг 11.54. Создание менеджера временных таблиц и установка его связи с запросом
МенеджерВТ = Новый МенеджерВременныхТаблиц;
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
После этого все временные таблицы, созданные при помощи этого запроса, будут доступны в других запросах, использующих этот же менеджер временных таблиц.
Таким образом, пакетный запрос (см. листинг 11.53) можно переписать следующим образом (листинг 11.55).
Листинг 11.55. Вывод всех товаров в порядке иерархии справочника «Товары» с данными об их поступлении за ноябрь
МенеджерВТ = Новый МенеджерВременныхТаблиц;
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ПОМЕСТИТЬ НакладнаяМатериалы
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
Запрос.Выполнить();
 
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|	Номенклатура.Наименование КАК Наименование,
|	НакладнаяМатериалы.Дата КАК Дата,
|	НакладнаяМатериалы.Номер КАК Номер
|ИЗ
|	Справочник.Номенклатура КАК Номенклатура
|     	ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
|     	ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
|
|УПОРЯДОЧИТЬ ПО
|	Номенклатура.Ссылка ИЕРАРХИЯ
|АВТОУПОРЯДОЧИВАНИЕ";
 
РезультатЗапроса = Запрос2.Выполнить();
 
Выборка = РезультатЗапроса.Выбрать();
Пока Выборка.Следующий() Цикл
Сообщить("Материал: " + Выборка.Наименование + " Дата: " + Выборка.Дата + " Номер: " + Выборка.Номер);
 
КонецЦикла;
В процедуре сначала создается менеджер временных таблиц МенеджерВТ, затем создается запрос Запрос, выбирающий данные о поступлении товаров. С ним связывается менеджер временных таблиц. При выполнении этого запроса (Запрос.Выполнить()) данные, выбранные запросом, помещаются во временную таблицу НакладнаяМатериалы.
Результат выполнения первого запроса (Запрос.Выполнить()) не используется. Он включает одну колонку Количество, содержащую количество строк, помещенных во временную таблицу.
Затем создается второй запрос Запрос2. В качестве менеджера временных таблиц для него также указывается МенеджерВТ. Это значит, что второй запрос получает доступ к временной таблице, созданной при выполнении первого запроса. То есть он может использовать временную таблицу НакладнаяМатериалы в качестве источника данных точно так же, как и таблицу базы данных.
После выполнения второго запроса выполняется обход выборки результата запроса, и в итоге в окне сообщений вы получаете следующий результат (рис. 11.65).

Рис. 11.65. Использование данных временной таблицы с помощью встроенного языка {https://ai2b.pro/wp-content/uploads/1/ch11_065.png}
Запросов, использующих общий менеджер временных таблиц, может быть несколько, и во всех этих запросах будут доступны данные всех временных таблиц, созданных с помощью запросов с использованием того же менеджера временных таблиц.
Необходимо учитывать, что временные таблицы будут существовать в памяти компьютера до закрытия менеджера временных таблиц (автоматически или принудительно методом Закрыть()) или до исполнения запроса, связанного с этим менеджером, уничтожающего временную таблицу с помощью конструкции УНИЧТОЖИТЬ.
В одном прикладном решении может быть создано произвольное количество менеджеров временных таблиц, каждый из которых хранит свой набор временных таблиц. Каждая временная таблица однозначно идентифицируется своим именем, и в пределах одного менеджера временных таблиц все временные таблицы должны иметь уникальные имена.

#### Использование функции ЕСТЬNULL()
Ранее в разделе «Как получить данные из разных таблиц для одного и того же поля» (рис. 11.29) вы узнали, что в результате соединения таблиц могут быть получены значения NULL. Они обозначают неуказанные (отсутствующие) значения.
Например, в предыдущем примере (рис. 11.65) такие значения содержатся в полях Дата и Номер для элемента Шланг резиновый и для группы Радиодетали, потому что для этих элементов нет подходящих записей в таблице регистра Цены.
Особенность значения NULL заключается в том, что это значение существует только в языке запросов. Во встроенном языке попытка использовать такое значение приведет к ошибке исполнения.
Для того чтобы во встроенном языке можно было свободно анализировать поля результата запроса, которые могут содержать значение NULL, используется функция языка запросов ЕСТЬNULL(). Первым параметром в эту функцию передается поле выборки запроса, а вторым параметром – значение, которое будет использовано в том случае, если переданное поле содержит NULL (листинг 11.56).
Листинг 11.56. Использование функции ЕСТЬNULL()
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|	Номенклатура.Наименование КАК Наименование,
|    ЕСТЬNULL(НакладнаяМатериалы.Дата, 0) КАК Дата,
|    ЕСТЬNULL(НакладнаяМатериалы.Номер, 0) КАК Номер
|ИЗ
|	Справочник.Номенклатура КАК Номенклатура
|     	ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
|     	ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
|
|УПОРЯДОЧИТЬ ПО
|	Номенклатура.Ссылка ИЕРАРХИЯ
|АВТОУПОРЯДОЧИВАНИЕ";
Если теперь к этому запросу вы добавите поле Номенклатура.ЭтоГруппа, то вывод результата можно сделать более понятным и удобным (листинг 11.57, рис. 11.66).
Листинг 11.57. Использование функции ЕСТЬNULL()
МенеджерВТ = Новый МенеджерВременныхТаблиц;
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ПОМЕСТИТЬ НакладнаяМатериалы
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
Запрос.Выполнить();
 
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|    Номенклатура.ЭтоГруппа КАК ЭтоГруппа,
|	Номенклатура.Наименование КАК Наименование,
|    ЕСТЬNULL(НакладнаяМатериалы.Дата, 0) КАК Дата,
|    ЕСТЬNULL(НакладнаяМатериалы.Номер, 0) КАК Номер
|ИЗ
|	Справочник.Номенклатура КАК Номенклатура
|     	ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
|     	ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
|
|УПОРЯДОЧИТЬ ПО
|	Номенклатура.Ссылка ИЕРАРХИЯ
|АВТОУПОРЯДОЧИВАНИЕ";
 
РезультатЗапроса = Запрос2.Выполнить();
 
Выборка = РезультатЗапроса.Выбрать();
Пока Выборка.Следующий() Цикл
Если Выборка.ЭтоГруппа Тогда
Сообщить("Группа: " + Выборка.Наименование);
ИначеЕсли Выборка.Дата = 0 Тогда
Сообщить("Материал: " + Выборка.Наименование + " – поступлений нет");
Иначе    
Сообщить("Материал: " + Выборка.Наименование + " Дата: " + Выборка.Дата + " Номер: " + Выборка.Номер);
 
КонецЕсли;
 
КонецЦикла;

Рис. 11.66. Использование функции «ЕСТЬNULL()» {https://ai2b.pro/wp-content/uploads/1/ch11_066.png}

#### Просмотр результата запроса в режиме отладки
В процессе написания и отладки запросов часто возникает необходимость посмотреть результат запроса до того, как получена его выборка и написан алгоритм ее обработки.
Конечно, вы всегда можете воспользоваться консолью запросов в прикладном решении – скопировать в нее текст запроса из 1C:EDT, выполнить его и увидеть результат. Однако это не всегда удобно. Если запрос содержит большое количество параметров, которые вычисляются на разных этапах выполнения алгоритма, вам будет трудно указать все эти параметры в консоли запросов и не ошибиться.
В этом случае вы можете воспользоваться простым приемом, который позволит вам увидеть результат запроса прямо в 1C:EDT, остановившись в отладчике. Этот прием демонстрирует еще одну возможность, которая обозначена на схеме (рис. 11.64) как шестой этап – выгрузка результата в таблицу значений или дерево значений.
В качестве примера вы можете использовать запрос, полученный в предыдущем разделе. В него надо добавить всего одну строку: ТЗ = РезультатЗапроса.Выгрузить() (листинг 11.58).
Листинг 11.58. Вывод результата запроса в таблицу значений
МенеджерВТ = Новый МенеджерВременныхТаблиц;
Запрос = Новый Запрос;
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос.Текст = "ВЫБРАТЬ
|	ПриходнаяНакладнаяМатериалы.Материал,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Дата,
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер
|ПОМЕСТИТЬ НакладнаяМатериалы
|ИЗ
|	Документ.ПриходнаяНакладная.Материалы КАК ПриходнаяНакладнаяМатериалы
|ГДЕ
|	ПриходнаяНакладнаяМатериалы.Ссылка.Номер = &НомерНакладной";
Запрос.УстановитьПараметр("НомерНакладной", "000000001");
Запрос.Выполнить();
 
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|	Номенклатура.ЭтоГруппа КАК ЭтоГруппа,
|	Номенклатура.Наименование КАК Наименование,
|	ЕСТЬNULL(НакладнаяМатериалы.Дата, 0) КАК Дата,
|	ЕСТЬNULL(НакладнаяМатериалы.Номер, 0) КАК Номер
|ИЗ
|	Справочник.Номенклатура КАК Номенклатура
|     	ЛЕВОЕ СОЕДИНЕНИЕ НакладнаяМатериалы КАК НакладнаяМатериалы
|     	ПО Номенклатура.Ссылка = НакладнаяМатериалы.Материал
|
|УПОРЯДОЧИТЬ ПО
|	Номенклатура.Ссылка ИЕРАРХИЯ
|АВТОУПОРЯДОЧИВАНИЕ";
 
РезультатЗапроса = Запрос2.Выполнить();
ТЗ = РезультатЗапроса.Выгрузить();
 
Выборка = РезультатЗапроса.Выбрать();
Пока Выборка.Следующий() Цикл
Если Выборка.ЭтоГруппа Тогда
Сообщить("Группа: " + Выборка.Наименование);
ИначеЕсли Выборка.Дата = 0 Тогда
Сообщить("Материал: " + Выборка.Наименование + " – поступлений нет");
Иначе    
Сообщить("Материал: " + Выборка.Наименование + " Дата: " + Выборка.Дата + " Номер: " + Выборка.Номер);
 
КонецЕсли;
 
КонецЦикла;
Метод Выгрузить() выгружает результат запроса в таблицу значений, создавая в ней колонки, соответствующие полям выборки запроса.
Вам останется только установить точку останова на следующей инструкции и запустить проект в режиме отладки. После того как вы запустите обработку РаботаСЗапросами, исполнение встроенного языка будет остановлено.
В панели Переменные вы увидите переменную ТЗ. Выделите ее и перейдите в панель Значения. В панели вы увидите содержимое этой таблицы значений в удобном для анализа виде (рис. 11.67).

Рис. 11.67. Просмотр результата запроса в отладчике {https://ai2b.pro/wp-content/uploads/1/ch11_067.png}
Если результат запроса вас устраивает и ваш дальнейший алгоритм не предполагает выгрузку результата запроса в таблицу значений или в дерево значений, не забудьте удалить строку ТЗ = РезультатЗапроса.Выгрузить() из модуля.


## Занятие 12 (2:00). Проведение документа по нескольким регистрам
Продолжительность
Ориентировочная продолжительность занятия – 2 часа.
Это занятие будет посвящено изучению того, как один и тот же документ может поставлять информацию в различные регистры конфигурации и для чего может понадобиться такая возможность.
Пользуясь знаниями о языке запросов, полученными на предыдущем занятии № 11 «Знакомство с языком запросов», вы измените процедуру проведения документа Оказание услуги так, чтобы движения в регистрах накопления формировались с помощью запроса к данным документа и чтобы в регистры попадали записи только о той номенклатуре, которая является материалом.
На этом занятии вы создадите еще один регистр накопления в вашей конфигурации и измените процедуру проведения документов так, чтобы они записывали необходимые данные как в один, так и в другой регистр.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
Прежде чем приступить непосредственно к каким-либо действиям, следует сказать несколько слов об особенностях хранения и использования ссылочных данных в системе «1С:Предприятие».

### Теория: особенности использования ссылочных данных
В этом разделе вы узнаете об особенностях использования ссылочных данных. Используя доступ к этим данным с помощью запросов, вы можете значительно повысить скорость проведения документа и оптимизировать этот процесс.
Под термином «ссылочные данные» в этой книге понимаются данные, хранящиеся в базе данных, доступ к которым возможен при помощи объектов встроенного языка вида Ссылка: СправочникСсылка.<имя>, ДокументСсылка.<имя> и т. д. Для того чтобы дальнейшее изложение было понятнее, объяснение будет строиться на примере получения ссылки на вид номенклатуры при проведении документа ОказаниеУслуги.
Не все данные, хранящиеся в базе данных, являются ссылочными. Это связано с тем, что в модели данных «1С:Предприятия» существует деление на данные, представляющие объектные сущности (справочники, планы счетов, документы и т. д.), и данные, представляющие необъектные сущности (регистры сведений, регистры накопления и т. д.).
С точки зрения платформы некоторая совокупность объектных данных определяется не только значениями своих полей, но и самим фактом своего существования. Другими словами, удалив из базы некоторую совокупность объектных данных, вы уже не сможете вернуть систему в то же состояние, которое было до удаления. Даже если вы заново создадите ту же самую совокупность объектных данных с теми же самыми значениями полей, с точки зрения системы это будет ДРУГАЯ совокупность объектных данных.
Каждую такую совокупность объектных данных, уникальную с точки зрения системы, называют объектом базы данных.
Для того чтобы система могла отличить один объект базы данных от другого, каждый объект базы данных (совокупность объектных данных) имеет внутренний идентификатор. Различные объекты базы данных всегда будут иметь разные внутренние идентификаторы. Этот идентификатор хранится вместе с остальными данными объекта в специальном поле Ссылка.
Необъектные данные хранятся в виде записей и с точки зрения системы определяются исключительно значениями своих полей. Таким образом, удалив некоторую запись и записав после этого новую, с точно такими же значениями всех полей, вы можете получить то же самое состояние базы данных, которое было до удаления.
Поскольку вы можете однозначно указать на каждый объект базы данных, у вас появляется возможность хранить такой указатель в полях других таблиц базы данных, выбирать его в поле ввода, указывать в параметрах запроса при поиске по ссылке и т. д.
Во всех этих случаях как раз и будет использоваться объект встроенного языка вида Ссылка. Фактически этот объект хранит только внутренний идентификатор, находящийся в поле Ссылка.
Например, если взять документ ОказаниеУслуги, то в поле, хранящем реквизит табличной части Номенклатура, на самом деле находится внутренний идентификатор, указывающий на элемент справочника Номенклатура (рис. 12.1).

Рис. 12.1. Ссылка на элемент справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/12_01.png}
Когда вы присваиваете значение реквизита табличной части Номенклатура какой-либо переменной, вы имеете дело с объектом встроенного языка ДокументОбъект.ОказаниеУслуги.
Этот объект содержит в себе значения всех реквизитов документа и реквизитов его табличных частей.
Поэтому обращение (листинг 12.1) приводит к тому, что вы просто читаете данные, хранящиеся в оперативной памяти, в этом самом объекте встроенного языка (рис. 12.2).
Листинг 12.1. Обращение к реквизиту объекта
Движение.Материал = ТекСтрокаПереченьНоменклатуры.Номенклатура;

Рис. 12.2. Чтение данных из оперативной памяти {https://ai2b.pro/wp-content/uploads/1/12_02.png}
Однако, когда вы обращаетесь к виду номенклатуры как к реквизиту того элемента справочника, ссылка на который указана в табличной части документа (листинг 12.2), происходит буквально следующее (рис. 12.3).
Листинг 12.2. Обращение к реквизиту ссылки
Если ТекСтрокаПереченьНоменклатуры.Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда

Рис. 12.3. Использование кеша объектов {https://ai2b.pro/wp-content/uploads/1/12_03.png}
Поскольку в объекте ДокументОбъект.ОказаниеУслуги есть только ссылка на элемент справочника Номенклатура и больше никаких данных об этом элементе нет, платформа возьмет эту ссылку и обратится по ней в кеш объектов в надежде найти там данные того объекта, ссылка на который у нее есть.
Если кеш объектов не будет иметь нужных данных, он обратится к базе данных, с тем чтобы прочитать все данные объекта, ссылкой на который он обладает.
После того как все данные, хранящиеся в реквизитах нужного элемента справочника и в реквизитах его табличных частей, будут считаны в кеш объектов, кеш объектов вернет запрашиваемую ссылку, хранящуюся в реквизите ВидНоменклатуры справочника Номенклатура.
Как несложно догадаться, подобное обращение к базе данных требует большего количества времени, нежели просто чтение из оперативной памяти. При интерактивном заполнении документа подобные задержки ничтожно малы по сравнению со скоростью работы пользователя. Однако при выполнении большого количества расчетов (например, при проведении больших документов, содержащих несколько тысяч строк) разница во времени может быть довольно заметной.
Из всего вышесказанного можно сделать следующий вывод: если алгоритм проведения документа использует только те данные, которые присутствуют в реквизитах документа (и его табличных частей), вполне достаточно использовать конструктор движений документа (как это было у вас в случае с документом ПриходнаяНакладная).
Если же в алгоритме проведения требуется анализировать дополнительные реквизиты объектов, ссылки на которые содержатся в документе, а также использовать результаты расчета итогов регистров, то следует использовать запросы для более быстрой выборки данных из базы данных.
То же самое справедливо в отношении выполнения любых участков программы, критичных по производительности. Механизм запросов лучше «читает» информационную базу и может за один раз выбрать только те данные, которые необходимы. Поэтому, например, в типовых решениях вы практически не увидите использования объекта встроенного языка СправочникВыборка.<имя>. Вместо этого повсеместно используются запросы к базе данных.

### Регистрация расхода только той номенклатуры, которая является материалом
Прежде чем создавать еще один регистр и формировать движения в нем, вам нужно исправить движения документа ОказаниеУслуги по регистру накопления ОстаткиМатериалов, которые вы сформировали на пятом занятии с помощью конструктора движений.
Дело в том, что после принятия решения об учете услуг на предприятии оказалось, что существующая программа не совсем подходит, поскольку в регистр будут попадать не только записи об израсходованных материалах, но и записи об оказанных услугах (листинг 12.3).
Листинг 12.3. Процедура «ОбработкаПроведения()» документа «ОказаниеУслуги»
Процедура ОбработкаПроведения(Отказ, Режим)
//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
//Данный фрагмент построен конструктором.
//При повторном использовании конструктора, внесенные вручную данные будут утеряны!
 
// регистр ОстаткиМатериалов
Движения.ОстаткиМатериалов.Записывать = Истина;
Для Каждого ТекСтрокаПереченьНоменклатуры из ПереченьНоменклатуры Цикл
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ТекСтрокаПереченьНоменклатуры.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаПереченьНоменклатуры.Количество;
КонецЦикла;
 
//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры
Теперь вам нужно в 1С:EDT доработать обработку проведения документа таким образом, чтобы в регистре появлялись только записи, относящиеся к расходу материалов.
И после этого в прикладном решении нужно перепровести все документы Оказание услуги, чтобы данные в регистре изменились в соответствии с новым алгоритмом проведения документа.
Как объяснялось выше, для определения того, чем является номенклатура, указанная в табличной части документа: материалом или услугой, не нужно использовать обращение вида ТекСтрокаПереченьНоменклатуры.Номенклатура.ВидНоменклатуры.
Это будет методически неправильно и неэффективно, поскольку такое обращение может сильно замедлить скорость выполнения процедуры проведения при больших объемах табличной части документа.
В целях оптимизации и повышения скорости проведения документа вы будете получать все нужные вам данные запросом, а при обходе результата запроса запишете в регистр ОстаткиМатериалов только те строки, в которых находятся материалы.
#### В 1C:EDT
Откройте модуль документа ОказаниеУслуги и найдите в нем обработчик события ОбработкаПроведения.
Удалите все комментарии конструктора движений. Теперь вы будете формировать движения документа самостоятельно с помощью запроса к табличной части документа.
Все данные, связанные с номенклатурой, которая содержится в табличной части документа, вы будете получать с помощью запроса к базе данных. А данные, связанные с самим документом (например, дата документа, склад), вы по-прежнему будете получать из документа. Такой подход позволит вам читать только нужные данные и за счет этого максимально ускорить проведение документа.
Итак, запросом вы будете получать:
номенклатуру,
вид номенклатуры,
количество.
Из документа вы возьмете следующие данные:
дата,
клиент,
мастер,
склад.
Хотя вы уже знакомы с языком запросов, проще и быстрее создать запрос с помощью конструктора запроса, а не писать его с нуля. А потом, если понадобится, вы можете вручную отредактировать текст запроса, который создал для вас конструктор.
Причем с помощью конструктора можно не только создать текст запроса, но и получить синтаксически правильный фрагмент встроенного языка, включающий в себя шаблон для обхода результата запроса. Последним вариантом вам и нужно сейчас воспользоваться.
В процедуре обработки проведения установите курсор перед циклом обхода табличной части документа и в контекстном меню нажмите Конструктор запроса с обработкой результата (рис. 12.4).

Рис. 12.4. Вызов конструктора запроса {https://ai2b.pro/wp-content/uploads/1/12_04.png}
В конструкторе запросов перейдите на закладку Таблицы и поля и выберите таблицу ОказаниеУслугиПереченьНоменклатуры – это табличная часть документа ОказаниеУслуги.
Из этой таблицы выберите поля Номенклатура, Номенклатура.ВидНоменклатуры, Количество (рис. 12.5).

Рис. 12.5. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/12_05.png}
Но вам нужны не все записи этой таблицы, а только те, которые относятся к вашему документу.
Поэтому на закладке Условия задайте условие отбора из таблицы документа только строк проводимого документа.
Для этого перетащите поле Ссылка в список условий запроса (листинг 12.4).
Листинг 12.4. Условие отбора из таблицы документа
ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
Ссылку на этот документ вы передадите в параметр запроса Ссылка (рис. 12.6).

Рис. 12.6. Условие отбора из таблицы документа {https://ai2b.pro/wp-content/uploads/1/12_06.png}
Также следует учесть, что в табличной части документа одна и та же номенклатура может встречаться несколько раз.
Поэтому на закладке Группировка перетащите поля Номенклатура и Номенклатура.ВидНоменклатуры в список Поле группировки, а поле Количество – в список Суммируемое поле.
Благодаря этому в результате запроса значения номенклатуры повторяться не будут, и для каждого из них будут посчитаны суммарные значения по полю Количество, если в табличной части документа содержится несколько строк с одинаковой номенклатурой (рис. 12.7).

Рис. 12.7. Группировка строк таблицы документа {https://ai2b.pro/wp-content/uploads/1/12_07.png}
На закладке Объединения/Псевдонимы задайте псевдонимы для полей Количество – КоличествоВДокументе, а для поля Номенклатура.ВидНоменклатуры задайте псевдоним ВидНоменклатуры просто для облегчения чтения запроса (рис. 12.8).

Рис. 12.8. Псевдонимы полей {https://ai2b.pro/wp-content/uploads/1/12_08.png}
Нажмите ОК. В результате конструктор поместит следующий фрагмент в процедуру обработки проведения документа (листинг 12.5).
Листинг 12.5. Текст запроса с обходом результата
// {{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
// Данный фрагмент построен конструктором.
// При повторном использовании конструктора внесенные вручную изменения будут утеряны!
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
// Вставить обработку выборки ВыборкаДетальныеЗаписи
КонецЦикла;
 
//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
Комментарии конструктора запроса в начале и конце фрагмента можно удалить.
Поскольку для построения запроса вы использовали Конструктор запроса с обработкой результата, конструктор написал за вас код для выполнения и обхода записей запроса.
После создания запроса в переменной Запрос сначала устанавливается собственно текст запроса, а затем устанавливается значение параметра запроса &Ссылка как ссылка на тот документ, в модуле которого вы сейчас находитесь (листинг 12.6).
Листинг 12.6. Установка параметра запроса
Запрос.УстановитьПараметр("Ссылка", Ссылка);
В результате выполнения запроса в переменную ВыборкаДетальныеЗаписи помещается выборка записей из результата запроса.
Далее, используя метод выборки Следующий() (ВыборкаДетальныеЗаписи.Следующий()), вы будете в цикле обходить выборку записей запроса.
Чтобы в цикле получить значение какого-либо поля выборки из результата запроса, вы будете обращаться к полям запроса через точку от переменной ВыборкаДетальныеЗаписи, которая содержит текущую строку выборки запроса. Например, так: ВыборкаДетальныеЗаписи.Номенклатура.
Таким образом, обходя выборку результата запроса, вы пошагово получаете доступ к строкам табличной части документа ПереченьНоменклатуры, сгруппированным по номенклатуре.
Теперь вам осталось перенести существовавшие ранее в процедуре проведения документа строки, описывающие движения регистра ОстаткиМатериалов, внутрь цикла обхода результата запроса вместо комментария «// Вставить обработку выборки ВыборкаДетальныеЗаписи» (листинг 12.7).
Листинг 12.7. Цикл обхода записей запроса
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ТекСтрокаПереченьНоменклатуры.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаПереченьНоменклатуры.Количество;
 
КонецЦикла;
Поскольку вы находитесь теперь не в цикле обхода записей табличной части документа, а в цикле обхода результата запроса, вам нужно заменить обращение ТекСтрокаПереченьНоменклатуры на ВыборкаДетальныеЗаписи (листинг 12.8).
Листинг 12.8. Формирование движений регистра
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.Количество;
 
КонецЦикла;
ПРИМЕЧАНИЕ
Для упрощения восприятия новый текст в листингах выделен жирным шрифтом.
Не забудьте, что для поля Количество вы задали псевдоним в запросе, поэтому замените его на КоличествоВДокументе (листинг 12.9).
Листинг 12.9. Формирование движений регистра
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
КонецЦикла;
Теперь почти все готово. Но вам нужно исключить выполнение операторов цикла для тех записей выборки, в которых номенклатура не является материалом (листинг 12.10).
Листинг 12.10. Формирование движений регистра только для материалов
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
КонецЕсли;
 
КонецЦикла;
Используя обращение ВыборкаДетальныеЗаписи.ВидНоменклатуры, вы можете проанализировать значение реквизита ВидНоменклатуры для номенклатуры, содержащейся в текущей записи результата запроса.
Полученное значение вы сравниваете со значением Материал перечисления ВидыНоменклатуры (Перечисления.ВидыНоменклатуры.Материал).
Если значения совпадают, операторы цикла выполняются. Если нет, исполнение кода переходит к следующей итерации цикла.
Оставшийся цикл обхода табличной части можно удалить (листинг 12.11).
Листинг 12.11. Ненужные строки
Для Каждого ТекСтрокаПереченьНоменклатуры Из ПереченьНоменклатуры Цикл
 
КонецЦикла;
В результате процедура проведения примет следующий вид (листинг 12.12).
Листинг 12.12. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ,Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
КонецЕсли;
 
КонецЦикла;
 
КонецПроцедуры

#### В прикладном решении
Запустите проект в режиме отладки и проверьте работу процедуры проведения документа Оказание услуги.
Откройте документ Оказание услуги № 1 и внесите в него следующие изменения:
удалите из табличной части строку, содержащую Транзистор Philips;
добавьте услугу Подключение воды;
добавьте материал Шланг резиновый (рис. 12.9).

Рис. 12.9. Измененный документ «Оказание услуги № 1» {https://ai2b.pro/wp-content/uploads/1/12_09.png}
Обратите внимание, что цены подставляются автоматически из регистра сведений Цены.
Нажмите Провести в командной панели формы документа.
Затем нажмите Остатки материалов в панели навигации формы, чтобы перейти к записям регистра Остатки материалов, связанным с данным документом (рис. 12.10).

Рис. 12.10. Записи регистра «Остатки материалов» {https://ai2b.pro/wp-content/uploads/1/12_10.png}
Как вы видите, в движения по регистру Остатки материалов включаются только строки, содержащие материалы. Запись про услугу Подключение воды в движения не попала.
Это особенно заметно, так как теперь в поле Материал регистра Остатки материалов представление номенклатуры включает также и вид номенклатуры, как вы задали на предыдущем занятии.

### Зачем нужно проведение документа по нескольким регистрам
До сих пор вы учитывали только количественное движение материалов в ООО «На все руки мастер». Для этих целей вы создали регистр накопления ОстаткиМатериалов.
Однако, как вы, наверное, догадываетесь, одного только количественного учета совершенно недостаточно для нужд вашего предприятия. Очевидно, что необходимо также знать, какие денежные средства были затрачены на приобретение тех или иных материалов и каковы материальные запасы ООО «На все руки мастер» в денежном выражении.
После того как вы начали автоматизировать предприятие ООО «На все руки мастер», руководство высказало пожелание, чтобы весь суммовой учет материалов велся бы теперь по средней стоимости.
То есть при закупке материалов они должны учитываться в ценах приобретения, а при расходе – по средней стоимости, которая рассчитывается исходя из общей суммы закупок данного материала и общего количества этого материала, находящегося в ООО «На все руки мастер».
Поскольку подобная информация имеет совершенно другую структуру, нежели в количественном учете, для хранения данных об общей стоимости тех или иных материалов вы будете использовать еще один регистр накопления – СтоимостьМатериалов.
Таким образом, документы ПриходнаяНакладная и ОказаниеУслуги должны будут создавать движения не только в регистре ОстаткиМатериалов, но одновременно и в регистре СтоимостьМатериалов, отражая изменения суммового учета.

### Добавление еще одного регистра накопления
Добавьте объект конфигурации – регистр накопления с именем СтоимостьМатериалов.
Свойство регистра Расширенное представление списка задайте как Движения по регистру Стоимость материалов.
Включите регистр в подсистемы Бухгалтерия, Учет материалов и Оказание услуг.
Создайте для регистра одно измерение – Материал типа СправочникСсылка.Номенклатура и один ресурс – Стоимость типа Число длиной 15 и точностью 2.
В разделах Бухгалтерия, Учет материалов и Оказание услуг включите видимость команды Стоимость материалов и мышью перетащите ее в группу Панель навигации.См.также.
Теперь можно приступить к внесению изменений в процедуры проведения ваших документов.
Начните с самого простого – документа ПриходнаяНакладная.

### Проведение приходной накладной по двум регистрам
#### В 1C:EDT
##### Изменение процедуры проведения
В список регистров, в которых документ ПриходнаяНакладная будет создавать движения, добавьте еще один регистр СтоимостьМатериалов. Для этого в редакторе документа на закладке Движения нажмите  над списком регистров установите флажок у регистра и нажмите ОК (рис. 12.11).

Рис. 12.11. Регистры, в которых документ «Приходная накладная» производит движения {https://ai2b.pro/wp-content/uploads/1/12_11.png}
Поскольку вы уже знакомы со встроенным языком, теперь вы сможете разобраться с тем фрагментом, который вы сформировали с помощью конструктора движений в процедуре ОбработкаПроведения() документа ПриходнаяНакладная. И затем по аналогии самостоятельно сформировать движения по регистру СтоимостьМатериалов.
Откройте модуль документа ПриходнаяНакладная. Процедура ОбработкаПроведения(), находящаяся в этом модуле, сейчас выглядит следующим образом (листинг 12.13).
Листинг 12.13. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ,Режим)
//{{__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
//Данный фрагмент построен конструктором.
//При повторном использовании конструктора, внесенные вручную данные будут утеряны!
 
// регистр ОстаткиМатериалов
Движения.ОстаткиМатериалов.Записывать = Истина;
Для Каждого ТекСтрокаМатериалы из Материалы Цикл
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаМатериалы.Количество;
КонецЦикла;
 
//}}__КОНСТРУКТОР_ДВИЖЕНИЙ_РЕГИСТРОВ
КонецПроцедуры
Объект встроенного языка ДокументОбъект.ПриходнаяНакладная имеет свойство Движения. Оно возвращает объект КоллекцияДвижений, содержащий коллекцию наборов записей регистров, по которым этот документ может формировать движения.
К конкретному набору записей этой коллекции можно обратиться, указав через точку имя регистра, которому принадлежит этот набор записей. Например, Движения.ОстаткиМатериалов.
Затем через точку можно использовать различные методы набора записей регистра – например, Движения.ОстаткиМатериалов.Добавить(). Метод Добавить() добавляет новую запись в набор записей.
В первой строке процедуры свойство Записывать набора записей регистра устанавливается в значение Истина. То есть в явном виде указывается, что после завершения обработки проведения платформа должна будет записать этот набор записей в базу данных.
Внутри обработчика расположен цикл Для Каждого … Из … Цикл. Он предназначен для перебора строк табличной части документа.
В цикле обращение к табличной части документа происходит по имени (Материалы). Переменная ТекСтрокаМатериалы содержит объект с данными текущей строки табличной части документа. Эта переменная создается в начале цикла и меняется по мере его прохождения.
В первой строке тела цикла, используя метод Добавить(), к набору записей, который создает документ в регистре, добавляется новая запись. Тем самым создается объект РегистрНакопленияЗапись.ОстаткиМатериалов и сохраняется в переменной Движение.
Используя этот объект, вы можете обратиться к полям этой записи, указав имя поля через точку от этой переменной (например, Движение.Количество).
Причем Движение.Материал, Движение.Склад – это измерения регистра, Движение.Количество – это ресурс регистра, а Движение.ВидДвижения и Движение.Период – стандартные реквизиты регистра, которые создаются автоматически.
Чтобы присвоить полям новой записи регистра соответствующие значения полей документа, можно обратиться к полям табличной части, указав имя поля через точку от переменной ТекСтрокаМатериалы (например, ТекСтрокаМатериалы.Материал).
Заметьте, что Склад – это реквизит шапки документа, а Дата – стандартный реквизит документа, который создается автоматически. Причем в цикле меняются только значения полей табличной части документа: ТекСтрокаМатериалы.Материал и ТекСтрокаМатериалы.Количество. Остальные поля не меняются, так как относятся к документу в целом и не зависят от текущей строки табличной части документа.
ВидДвиженияНакопления.Приход – это значение системного перечисления, которое определяет вид движения регистра накопления как Приход.
Таким образом, в цикле перебора всех строк документа присваиваются нужные значения всем полям новой записи. После завершения цикла в этом наборе записей (Движения.ОстаткиМатериалов) будет содержаться столько записей, сколько строк в табличной части проводимого документа.
Теперь по аналогии с разобранным выше фрагментом добавьте в цикл обхода строк табличной части приходной накладной фрагмент для формирования движений по регистру СтоимостьМатериалов. Движения будут очень похожи на движения по регистру ОстаткиМатериалов – с той лишь разницей, что значение измерения Стоимость вычисляется на основе значения колонки Сумма текущей строки табличной части документа.
Удалите комментарии конструктора движений, а в начало процедуры проведения добавьте строку, в которой свойство Записывать набора записей этого регистра устанавливается в значение Истина.
В результате процедура ОбработкаПроведения() должна выглядеть следующим образом (листинг 12.14).
Листинг 12.14. Движения документа «ПриходнаяНакладная»
Процедура ОбработкаПроведения(Отказ, Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
 
Для Каждого ТекСтрокаМатериалы Из Материалы Цикл
 
// Регистр ОстаткиМатериалов Приход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
Движение.Период = Дата;
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаМатериалы.Количество;
 
// Регистр Стоимость Материалов Приход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
Движение.Период = Дата;
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.Стоимость = ТекСтрокаМатериалы.Сумма;
 
КонецЦикла;
 
КонецПроцедуры

##### Команда перехода к записям регистра
В заключение отредактируйте командный интерфейс формы документа, чтобы в панели навигации формы иметь возможность переходить к списку записей регистра СтоимостьМатериалов, связанному с документом.
Для этого в панели навигации формы документа на закладке Командный интерфейс установите флажок в колонке Видимость для этой команды.

#### В прикладном решении
В прикладном решении вам нужно провести еще раз (перепровести) все приходные накладные. Это необходимо для того, чтобы эти документы создали новые записи в регистрах в соответствии с алгоритмом проведения, который вы только что изменили.
Запустите проект в режиме отладки. Откройте список приходных накладных, выделите и перепроведите все документы.
Затем откройте первый документ (рис. 12.12) и, перейдя к регистрам Остатки материалов и Стоимость материалов, убедитесь, что документ создает желаемые записи как в одном (рис. 12.13), так и в другом регистре накопления (рис. 12.14).

Рис. 12.12. «Приходная накладная № 1» {https://ai2b.pro/wp-content/uploads/1/12_12.png}

Рис. 12.13. Записи регистра «Остатки материалов» {https://ai2b.pro/wp-content/uploads/1/12_13.png}

Рис. 12.14. Записи регистра «Стоимость материалов» {https://ai2b.pro/wp-content/uploads/1/12_14.png}

### Проведение документа «Оказание услуги» по двум регистрам
В заключение вам нужно внести изменения в процедуру обработки проведения документа ОказаниеУслуги.
При этом нужно учесть пожелание, высказанное руководством ООО «На все руки мастер». Суть его заключается в том, что на первом этапе при списании материалов, израсходованных в процессе оказания услуги, должна быть возможность указывать различную стоимость для одного и того же материала, которая рассчитана руководством исходя из текущих конъюнктурных соображений.
Поскольку в документе ОказаниеУслуги у вас отражена только цена номенклатуры, вам понадобится:
Добавить в табличную часть документа еще один реквизит, в котором будет указываться стоимость номенклатуры.
После этого изменить процедуру проведения документа ОказаниеУслуги.
И в заключение в прикладном решении перепровести все эти документы, чтобы отработал новый, измененный вами алгоритм проведения документов Оказание услуги.
Будьте внимательны! На данном этапе выполнения учебного примера стоимость материала вы должны указывать вручную в табличной части документа, а позже (в занятии № 15 «Оптимизация проведения документа "Оказание услуги"») будет реализован автоматический расчет стоимости.
#### В 1C:EDT
##### Новый реквизит документа
Создайте новый реквизит табличной части документа с именем Стоимость, типом Число, длиной 15 и точностью 2, неотрицательное.
После этого добавьте в таблицу ПереченьНоменклатуры формы документа ОказаниеУслуги поле, отображающее новый реквизит Стоимость.
Для этого в правом верхнем окне редактора формы на закладке Реквизиты раскройте реквизит формы Объект (рис. 12.15).

Рис. 12.15. Изменение формы документа «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/12_15.png}
Как вы видите, он содержит все реквизиты документа ОказаниеУслуги.
Найдите в табличной части реквизит Стоимость и с помощью мыши перетащите его в окно элементов формы, расположенное слева в верхней части редактора формы.
Расположите новый элемент в структуре элементов формы после поля Номенклатура.
Новый элемент будет автоматически связан с реквизитом и сразу же отобразится в окне просмотра формы документа, расположенном в нижнем окне редактора формы (рис. 12.16).

Рис. 12.16. Изменение формы документа «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/12_16.png}

##### Изменение процедуры проведения
Теперь создайте движения документа ОказаниеУслуги.
В список регистров, в которых документ ОказаниеУслуги будет создавать движения, добавьте еще один регистр СтоимостьМатериалов.
Ранее в разделе «Регистрация расхода только той номенклатуры, которая является материалом» вы изменили процедуру проведения документа ОказаниеУслуги так, чтобы движения в регистрах накопления формировались с помощью запроса к данным документа и чтобы в регистры попадали записи только о той номенклатуре, которая является материалом.
Откройте модуль документа ОказаниеУслуги. Процедура ОбработкаПроведения(), находящаяся в этом модуле, сейчас выглядит следующим образом (листинг 12.15).
Листинг 12.15. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ,Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
КонецЕсли;
 
КонецЦикла;
 
КонецПроцедуры
Теперь вам нужно добавить в цикл обхода записей результата запроса формирование движений по регистру СтоимостьМатериалов.
Но, в отличие от приходной накладной, здесь измерение регистра Стоимость должно вычисляться как произведение стоимости и количества, указанных в табличной части документа.
Поэтому вам нужно немного изменить запрос к табличной части документа, чтобы получать из нее значение поля Стоимость.
Для того чтобы изменить уже имеющийся запрос, установите курсор внутрь текста запроса и в контекстном меню нажмите Конструктор запроса. Конструктор заполнит все вкладки исходя из существующего текста запроса.
На закладке Таблицы и поля добавьте поле Стоимость в список полей, выбранных из табличной части ПереченьНоменклатуры документа ОказаниеУслуги (рис. 12.17).

Рис. 12.17. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/12_17.png}
Конструктор сразу же сигнализирует вам об ошибке появлением пиктограммы  рядом с выбранным полем. При наведении курсора на это поле появится окно с подсказкой – «Поле должно присутствовать в секции СГРУППИРОВАТЬ ПО».
Действительно, поскольку в табличной части документа одна и та же номенклатура может встречаться несколько раз, данные в запросе сгруппированы по полям Номенклатура и ВидНоменклатуры.
Поэтому на закладке Группировка перетащите поле Стоимость в список суммируемых полей. Вместо стандартной функции Сумма укажите, что будете рассчитывать по нему, например, функцию Максимум (рис. 12.18).

Рис. 12.18. Группировка строк таблицы документа {https://ai2b.pro/wp-content/uploads/1/12_18.png}
На самом деле подразумевается, что для разных строк одной и той же номенклатуры стоимость будет одинаковой, поэтому функция Максимум нужна вам лишь для того, чтобы получить одно из имеющихся значений стоимости.
Нажмите ОК. В результате конструктор изменит текст запроса следующим образом (листинг 12.16).
Листинг 12.16. Текст запроса
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|    МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
Теперь в самом конце цикла обхода записей результата запроса перед строкой КонецЕсли добавьте строки кода, создающие движения регистра СтоимостьМатериалов, производимые документом ОказаниеУслуги (листинг 12.17).
Листинг 12.17. Движения документа «ОказаниеУслуги» (фрагмент)
// Регистр СтоимостьМатериалов Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
В начало процедуры проведения добавьте строку, в которой свойство Записывать набора записей этого регистра устанавливается в значение Истина.
В результате процедура ОбработкаПроведения будет выглядеть следующим образом (листинг 12.18).
Листинг 12.18. Движения документа «ОказаниеУслуги»
Процедура ОбработкаПроведения(Отказ,Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
// Регистр СтоимостьМатериалов – Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
 
КонецЕсли;
 
КонецЦикла;
 
КонецПроцедуры
В заключение установите видимость команды СтоимостьМатериалов в панели навигации формы документа.

#### В прикладном решении
В прикладном решении вам нужно провести еще раз (перепровести) документ об оказании услуг. Это необходимо для того, чтобы этот документ создал новые записи в регистрах в соответствии с алгоритмом проведения, который вы только что изменили.
Запустите проект в режиме отладки. Откройте список документов об оказании услуг, откройте документ Оказание услуги № 1 и укажите в нем стоимость резинового шланга – 100 (рис. 12.19).

Рис. 12.19. Документ «Оказание услуги № 1» {https://ai2b.pro/wp-content/uploads/1/12_19.png}
Проведите документ Оказание услуги № 1 и перейдите к движениям этого документа в регистре Стоимость материалов (рис. 12.20).

Рис. 12.20. Записи регистра «Стоимость материалов» {https://ai2b.pro/wp-content/uploads/1/12_20.png}
Теперь создайте и проведите еще два документа Оказание услуги.
Эти документы понадобятся вам в дальнейшем, поэтому будьте внимательны и обратите внимание на то, что эти документы созданы другими датами (рис. 12.21, рис. 12.22). 

Рис. 12.21. Документ «Оказание услуги № 2» {https://ai2b.pro/wp-content/uploads/1/12_21.png}

Рис. 12.22. Документ «Оказание услуги № 3» {https://ai2b.pro/wp-content/uploads/1/12_22.png}
Движения документов Оказание услуги № 2 и № 3 по регистру Стоимость материалов должны выглядеть, соответственно, следующим образом (рис. 12.23, рис. 12.24)

Рис. 12.23. Движения документа «Оказание услуги № 2» {https://ai2b.pro/wp-content/uploads/1/12_23.png}

Рис. 12.24. Движения документа «Оказание услуги № 3» {https://ai2b.pro/wp-content/uploads/1/12_24.png}


## Занятие 13 (0:50). Оборотные регистры накопления
Продолжительность
Ориентировочная продолжительность занятия – 50 минут.
На этом занятии вы познакомитесь с еще одним видом регистра накопления – оборотным регистром накопления.
Вы узнаете о некоторых важных принципах выбора измерений и реквизитов регистров накопления.
Вы создадите оборотный регистр накопления и добавите в один из ваших документов движения еще и по этому регистру.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Зачем нужно создавать еще один регистр
Продолжим рассматривать работу документа ОказаниеУслуги.
До сих пор вы создавали в регистрах накопления движения только для строк документа, которые содержат материалы. Услуги, содержащиеся в документе, вы никак не учитывали.
Дело в том, что при учете услуг важны совершенно другие критерии, нежели при учете материалов.
Прежде всего, бессмысленно говорить о том, сколько услуг было и сколько их осталось, важны только сумма и количество услуг, которые были оказаны за определенный промежуток времени.
Кроме того, интересны следующие моменты:
какие именно услуги были оказаны (чтобы составить рейтинг услуг);
какому именно клиенту оказывались услуги (чтобы, например, предоставить ему скидку от объема оплаченных ранее услуг);
какой мастер предоставлял услуги (чтобы начислить ему заработную плату).
Очевидно, что существующие регистры накопления совершенно не подходят для решения таких задач.
Поэтому вы создадите еще одно хранилище данных, которое будет использоваться в вашей программе, – оборотный регистр накопления Продажи.

### Что такое оборотный регистр накопления
Когда вы создавали регистры ОстаткиМатериалов и СтоимостьМатериалов, в книге специально не заострялось внимание на видах регистров накопления, которые существуют в системе «1С:Предприятие». Сейчас пришло время сказать об этом несколько слов.
Регистры накопления могут быть регистрами остатков и регистрами оборотов.
Существующие в вашей учебной конфигурации регистры ОстаткиМатериалов и СтоимостьМатериалов являются регистрами остатков.
Если вы помните, при создании отчета Материалы в конструкторе запроса вы видели, что для таких регистров система создает три виртуальные таблицы: таблицу остатков, таблицу оборотов и совокупную таблицу остатков и оборотов.
Оборотный регистр накопления очень похож на знакомый уже вам регистр остатков, но для него понятие «остаток» не имеет смысла. Оборотный регистр накапливает только обороты, остатки ему безразличны. Поэтому единственной виртуальной таблицей, которую будет создавать система для такого регистра, будет таблица оборотов. В остальном оборотный регистр ничем не отличается от регистра остатков.
Следует сказать об одной особенности конструирования регистров накопления, напрямую связанной с возможностью получения остатков. При создании оборотного регистра накопления нет особой сложности в определении того, какие именно данные должны являться измерениями регистра: вы можете назначить в качестве его измерений любые нужные вам данные.
Совсем иная ситуация в случае регистра накопления, поддерживающего накопление остатков. Для него выбор измерений должен выполняться исходя из того, что движения регистра могут быть осуществлены в две стороны: приход и расход. Таким образом, в качестве измерений нужно выбирать те данные, по которым движения точно будут осуществляться как в одну, так и в другую сторону.
Например, если ведется учет материалов в разрезах номенклатуры и склада, очевидно, что и номенклатура, и склад могут быть измерениями, поскольку как приход, так и расход материалов всегда будут осуществляться с указанием конкретной номенклатуры и конкретного склада. Если же в этой ситуации появляется желание отразить учет материалов еще и в разрезе поставщика, то здесь уже нужно исходить из конкретной схемы учета, принятой на предприятии.
Скорее всего, при поступлении материалов поставщик будет указан, а вот при расходовании материалов с большой долей вероятности поставщик указываться не будет. В большинстве случаев это совершенно лишняя информация.
Значит, поставщика следует добавить не как измерение, а как реквизит регистра накопления.
Если же при расходе материалов поставщик будет указываться наверняка, имеет смысл добавить поставщика в измерения регистра.
Иными словами, по каждому из измерений регистра накопления остатков ресурсы обязательно должны изменяться в обе стороны: приход и расход. Не должно существовать таких измерений, по которым осуществляется только приход или только расход.
Нарушение этого принципа построения регистров накопления будет вести к непроизводительному использованию ресурсов системы и как следствие – к замедлению работы и падению производительности.
Для реквизитов же регистра этот принцип не важен. По реквизитам регистра ресурсы могут только приходоваться или только расходоваться.

### Добавление оборотного регистра накопления
Теперь, когда вы знаете практически все о регистрах накопления, добавьте объект конфигурации – регистр накопления с именем Продажи.
Установите свойство Вид регистра – Обороты.
Кроме того, задайте свойство регистра Расширенное представление списка как Движения по регистру Продажи.
Включите регистр в подсистемы Бухгалтерия, Учет материалов и Оказание услуг.
Регистр будет иметь следующие измерения:
Номенклатура, тип СправочникСсылка.Номенклатура;
Клиент, тип СправочникСсылка.Клиенты;
Мастер, тип СправочникСсылка.Сотрудники.
У регистра будет три ресурса:
Количество, тип Число, длина 15, точность 3;
Выручка, тип Число, длина 15, точность 2;
Стоимость, тип Число, длина 15, точность 2.
В разделах Бухгалтерия, Учет материалов и Оказание услуг включите видимость команды Продажи и мышью перетащите ее в группу Панель навигации.См.также.

### Проведение документа «Оказание услуги» по трем регистрам
В этом разделе вы сначала измените процедуру проведения документа ОказаниеУслуги, а затем в прикладном решении перепроведете эти документы, чтобы отработал новый, измененный вами алгоритм проведения документов Оказание услуги.
#### В 1C:EDT
В список регистров, в которых документ ОказаниеУслуги будет создавать движения, добавьте еще один регистр Продажи.
На предыдущем занятии вы изменили процедуру проведения документа ОказаниеУслуги так, чтобы движения в регистрах накопления формировались с помощью запроса к данным документа.
Откройте модуль документа ОказаниеУслуги. Процедура ОбработкаПроведения(), находящаяся в этом модуле, сейчас выглядит следующим образом (листинг 13.1).
Листинг 13.1. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ,Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
// Регистр СтоимостьМатериалов – Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
 
КонецЕсли;
 
КонецЦикла;
 
КонецПроцедуры
Теперь вам нужно добавить в цикл обхода записей результата запроса формирование движений по регистру Продажи.
Но в отличие от первых двух регистров накопления регистр Продажи содержит еще и ресурс Выручка, который заполняется значением колонки Сумма, указанной в табличной части документа.
Поэтому вам нужно немного изменить запрос к табличной части документа, чтобы получать из нее значение поля Сумма.
Откройте конструктор запроса для существующего текста запроса и на закладке Таблицы и поля добавьте поле Сумма в список полей, выбранных из табличной части ПереченьНоменклатуры документа ОказаниеУслуги (рис. 13.1).

Рис. 13.1. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/13_01.png}
Конструктор сразу же сигнализирует вам об ошибке появлением пиктограммы  рядом с выбранным полем. При наведении курсора на это поле появится окно с подсказкой – «Поле должно присутствовать в секции СГРУППИРОВАТЬ ПО».
Действительно, поскольку в табличной части документа одна и та же номенклатура может встречаться несколько раз, данные в запросе сгруппированы по полям Номенклатура и ВидНоменклатуры.
Поэтому на закладке Группировка перетащите поле Сумма в список суммируемых полей (рис. 13.2).

Рис. 13.2. Группировка строк таблицы документа {https://ai2b.pro/wp-content/uploads/1/13_02.png}
Благодаря этому в результате запроса значения номенклатуры повторяться не будут, и для каждого из них будут посчитаны суммарные значения по полю Сумма, если в табличной части документа содержится несколько строк с одинаковой номенклатурой.
На закладке Объединения/Псевдонимы задайте псевдоним для поля Сумма как СуммаВДокументе просто для облегчения чтения запроса (рис. 13.3).

Рис. 13.3. Псевдонимы полей запроса {https://ai2b.pro/wp-content/uploads/1/13_03.png}
Нажмите ОК. В результате конструктор изменит текст запроса следующим образом (листинг 13.2).
Листинг 13.2. Текст запроса
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость,
|    СУММА(ОказаниеУслугиПереченьНоменклатуры.Сумма) КАК СуммаВДокументе
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
Теперь в самом конце цикла обхода записей результата запроса после строки КонецЕсли добавьте строки кода, создающие движения регистра Продажи, производимые документом ОказаниеУслуги (листинг 13.3).
Листинг 13.3. Движения документа «ОказаниеУслуги» (фрагмент)
// Регистр Продажи
Движение = Движения.Продажи.Добавить();
Движение.Период = Дата;
Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Клиент = Клиент;
Движение.Мастер = Мастер;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.Выручка = ВыборкаДетальныеЗаписи.СуммаВДокументе;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
В начало процедуры проведения добавьте строку, в которой свойство Записывать набора записей этого регистра устанавливается в значение Истина.
В результате процедура ОбработкаПроведения будет выглядеть следующим образом (листинг 13.4).
Листинг 13.4. Движения документа «ОказаниеУслуги»
Процедура ОбработкаПроведения(Отказ,Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
Движения.Продажи.Записывать = Истина;
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Сумма) КАК СуммаВДокументе
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
// Регистр СтоимостьМатериалов – Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
 
КонецЕсли;
 
// Регистр Продажи
Движение = Движения.Продажи.Добавить();
Движение.Период = Дата;
Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Клиент = Клиент;
Движение.Мастер = Мастер;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.Выручка = ВыборкаДетальныеЗаписи.СуммаВДокументе;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
 
КонецЦикла;
 
КонецПроцедуры
Все добавленные конструкции вам уже хорошо известны.
Обратите внимание лишь на то, что у оборотного регистра отсутствует свойство ВидДвижения, поскольку отражение вида движения (приход или расход) имеет смысл лишь при учете остатков. В случае регистра оборотов вас интересует только значение, которое должно быть записано в ресурс регистра.
Также заметьте, что вы разместили команды, создающие движения в регистре Продажи, в конце цикла обхода результата запроса, после условия выполнения цикла только для материалов. Это важно, так как движения в этом регистре создаются как для материалов, так и для услуг.
В заключение установите видимость команды Продажи в панели навигации формы документа.

#### В прикладном решении
В прикладном решении вам нужно провести еще раз (перепровести) все документы об оказании услуг. Это необходимо для того, чтобы эти документы создали новые записи в регистрах в соответствии с алгоритмом проведения, который вы только что изменили.
Запустите проект в режиме отладки. Откройте список документов об оказании услуг, выделите и перепроведите все документы.
Теперь откройте по очереди каждый документ Оказание услуги и перейдите к списку движений этих документов по регистру Продажи. Они должны иметь следующий вид (рис. 13.4, 13.5, 13.6).

Рис. 13.4. Движения документа «Оказание услуги № 1» в регистре «Продажи» {https://ai2b.pro/wp-content/uploads/1/13_04.png}

Рис. 13.5. Движения документа «Оказание услуги № 2» в регистре «Продажи» {https://ai2b.pro/wp-content/uploads/1/13_05.png}

Рис. 13.6. Движения документа «Оказание услуги № 3» в регистре «Продажи» {https://ai2b.pro/wp-content/uploads/1/13_06.png}
На рисунках видно, что в регистр Продажи попадают записи о любой номенклатуре, которая является как материалом, так и услугой.
Теперь у вас есть практически вся необходимая информация для анализа деятельности ООО «На все руки мастер».
На следующем занятии вы создадите несколько отчетов, предоставляющих вам итоговую информацию о работе предприятия.


## Занятие 14 (4:00). Отчеты
Продолжительность
Ориентировочная продолжительность занятия – 4 часа.
Поскольку общая продолжительность занятия довольно велика, можно делать его частями, прерываясь после каждого из шести отчетов, разрабатываемых на этом занятии.
Настало время познакомиться с одним важным инструментом платформы «1С:Предприятие» – системой компоновки данных. На этом занятии вы построите несколько отчетов, которые будут использоваться в вашей конфигурации, и на их примере познакомитесь с основными возможностями системы компоновки данных.
Любой отчет, как правило, подразумевает получение сложной выборки данных, сгруппированных и отсортированных определенным образом. Система компоновки данных представляет собой мощный и гибкий механизм, позволяющий выполнить все необходимые действия – от получения данных из различных источников до представления этих данных в виде, удобном для пользователя.
Чаще всего исходные данные, необходимые для отчета, находятся в базе данных. Для того чтобы указать системе компоновки данных, какая информация и откуда должна быть получена, используется язык запросов системы «1С:Предприятие». Более подробно о языке запросов рассказано в занятии № 11 «Знакомство с языком запросов».
Вы не будете писать запросы вручную. Для большинства отчетов, разрабатываемых с помощью системы компоновки данных, запрос можно создать при помощи конструктора запросов.
На этапе разработки отчета можно задать стандартные настройки отчета, для того чтобы пользователь мог сразу же запустить отчет на выполнение. В то же время пользователь может самостоятельно изменить настройки отчета и выполнить его. При этом система компоновки данных сгенерирует другой запрос и другим образом представит конечные данные – в соответствии с новыми настройками, заданными пользователем.
В начале этого занятия вы познакомитесь с общими сведениями о системе компоновки данных.
Затем на примерах создания конкретных отчетов вы научитесь использовать систему компоновки данных для решения различных практических задач.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Теория: способы доступа к данным
Система «1С:Предприятие» поддерживает два способа доступа к данным, хранящимся в базе данных:
объектный (для чтения и записи);
табличный (для чтения).
Объектный способ доступа к данным реализован посредством использования объектов встроенного языка. Об этом подробно рассказано на занятии № 7 в разделе «Объекты встроенного языка».
С некоторыми из этих объектов вы уже познакомились на предыдущих занятиях.
Важной особенностью объектного способа доступа к данным является то, что, обращаясь к какому-либо объекту встроенного языка, вы обращаетесь к некоторой совокупности данных, находящихся в базе данных, как к единому целому.
Например, объект ДокументОбъект.ОказаниеУслуги будет содержать значения всех реквизитов документа Оказание услуги и всех его табличных частей.
Объектная техника обеспечивает сохранение целостности объектов, кеширование объектов, вызов соответствующих обработчиков событий и т. д.
Табличный доступ к данным в «1С:Предприятии» реализован с помощью запросов к базе данных, которые составляются на языке запросов. Более подробно о языке запросов рассказано в занятии № 11 «Знакомство с языком запросов».
В этой технике вы получаете возможность оперировать отдельными полями таблиц базы данных, в которых хранятся те или иные данные.
Табличная техника предназначена для получения информации из базы данных по некоторым условиям (отбор, группировка, сортировка, объединение нескольких выборок, расчет итогов и т. д.). Табличная техника оптимизирована для обработки больших объемов информации, расположенной в базе данных, и получения данных, отвечающих заданным критериям.

### Система компоновки данных
Система компоновки данных предназначена для создания произвольных отчетов в системе «1С:Предприятие» и состоит из нескольких основных частей.
Исходные данные для компоновки отчета содержит в себе схема компоновки данных. Это наборы данных и методы работы с ними (рис. 14.1).

Рис. 14.1. Общая схема работы с системой компоновки данных {https://ai2b.pro/wp-content/uploads/1/14_01.png}
Вы создаете схему компоновки данных, в которой описываете текст запроса, наборы данных, связи между ними, доступные поля, параметры получения данных и задаете первоначальные настройки компоновки: структуру отчета, макет оформления данных и др.
Например, схема компоновки может содержать следующий набор данных (рис. 14.2).

Рис. 14.2. Пример схемы компоновки (набор данных и запрос, его использующий) {https://ai2b.pro/wp-content/uploads/1/14_02.png}
На приведенном рисунке показан конструктор схемы компоновки данных, в котором содержатся источник данных, текст запроса и поля, выбранные запросом.
Отчет системы компоновки данных, который получит пользователь, представляет собой не просто таблицу записей, удовлетворяющих условиям запроса.
Отчет системы компоновки имеет сложную иерархическую структуру и может состоять из различных элементов, таких как группировки, таблицы и диаграммы.
При этом пользователь может изменить существующую структуру отчета или вообще создать совершенно новую. Может настроить необходимый ему отбор, оформление элементов структуры отчета, получить расшифровку по каждому элементу и т. д.
Например, может быть задана такая структура отчета, состоящая из одной таблицы и одной диаграммы (рис. 14.3).

Рис. 14.3. Возможная структура отчета {https://ai2b.pro/wp-content/uploads/1/14_03.png}
В этом случае сформированный отчет будет иметь следующий вид (рис. 14.4).

Рис. 14.4. Пример отчета {https://ai2b.pro/wp-content/uploads/1/14_04.png}
В данном отчете содержится информация из регистра накопления ПродажиОбороты о клиентах и оказанных им услугах, представленная в виде таблицы и диаграммы.
Как уже говорилось в начале раздела, система компоновки данных представляет собой совокупность нескольких объектов. При формировании и исполнении отчета происходит последовательная передача данных от одного объекта системы компоновки данных к другому до получения конечного результата – документа, показанного пользователю.
Алгоритм взаимодействия этих объектов выглядит следующим образом:
Вы создаете схему компоновки данных и настройки по умолчанию. В общем случае на основе одной схемы компоновки данных может быть создано большое количество различных отчетов. Настройки компоновки данных, создаваемые вами или изменяемые пользователем, определяют, какой именно отчет будет получен в конкретном случае.
На основе схемы компоновки и имеющихся настроек компоновщик макета создает макет. Это этап подготовки к исполнению отчета. Макет компоновки данных является уже готовым заданием для выполнения процессором компоновки. Он содержит необходимые запросы, макеты областей отчета и др.
Процессор компоновки данных выбирает данные из информационной базы согласно макету компоновки, агрегирует и оформляет эти данные.
Результат компоновки обрабатывается процессором вывода, и в итоге пользователь получает результирующий табличный документ.
Эту последовательность работы можно представить в виде следующей схемы (рис. 14.5).

Рис. 14.5. Схема работы системы компоновки {https://ai2b.pro/wp-content/uploads/1/14_05.png}

### Выбор данных из одной таблицы
Для начала, используя систему компоновки данных, вы создадите простой линейный отчет Реестр документов оказание услуги.
На примере этого отчета вы узнаете, как выбрать данные из одной таблицы базы данных и как вывести их в определенном порядке. Также вы познакомитесь с тем, как использовать расшифровку в готовом отчете.
Этот отчет будет выводить список существующих в базе данных документов ОказаниеУслуги в порядке их дат и номеров (рис. 14.6).

Рис. 14.6. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_06.png}
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем РеестрДокументовОказаниеУслуги.
Свойство отчета Расширенное представление установите как Список оказанных услуг.
Создайте основную схему компоновки данных отчета.
Добавьте в схему набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите объектную (ссылочную) таблицу документа ОказаниеУслуги.
Из этой таблицы выберите следующие поля (рис. 14.7):
Склад,
Мастер,
Клиент,
Ссылка.

Рис. 14.7. Выбранные поля для запроса {https://ai2b.pro/wp-content/uploads/1/14_07.png}
###### Псевдонимы полей
На закладке Объединения/Псевдонимы укажите, что поле Ссылка будет иметь псевдоним Документ (рис. 14.8).

Рис. 14.8. Установка псевдонимов полей запроса {https://ai2b.pro/wp-content/uploads/1/14_08.png}
СОВЕТ
Имена полей лучше изменять именно сейчас, в запросе, так как в этом случае в схему компоновки данных они перенесутся сразу в три колонки: Поле, Путь и Заголовок – и не нужно будет лишний раз их изменять.

###### Порядок записей
На закладке Порядок укажите, что результат запроса должен быть упорядочен по значению поля Номер документа ОказаниеУслуги (рис. 14.9).

Рис. 14.9. Порядок записей в запросе {https://ai2b.pro/wp-content/uploads/1/14_09.png}

###### Текст запроса
Нажмите ОK и посмотрите, какой запрос сформировал конструктор запроса (листинг 14.1).
Листинг 14.1. Текст запроса
ВЫБРАТЬ
ОказаниеУслуги.Склад,
ОказаниеУслуги.Мастер,
ОказаниеУслуги.Клиент,
ОказаниеУслуги.Ссылка КАК Документ
ИЗ
Документ.ОказаниеУслуги КАК ОказаниеУслуги
УПОРЯДОЧИТЬ ПО
ОказаниеУслуги.Номер

##### Настройки
Теперь в конструкторе схемы компоновки данных на закладке Настройки создайте стандартные настройки, определяющие, как будет выводиться информация в отчет.
Иерархическая структура отчета может содержать в различных сочетаниях три основных элемента:
Группировка – для вывода информации в виде обычного линейного отчета;
Таблица – для вывода информации в виде таблицы;
Диаграмма – для вывода информации в виде диаграммы.
Для добавления нового элемента, в вашем случае – группировки, нажмите Новая группировка в контекстном меню корневого элемента Отчет (рис. 14.10).

Рис. 14.10. Добавление новой группировки в отчет {https://ai2b.pro/wp-content/uploads/1/14_10.png}
После этого, не задавая поле группировки, сразу нажмите OK (тем самым вы указываете, что в группировке будут выводиться детальные записи из информационной базы).
В структуре отчета появится группировка Детальные записи.
На закладке Выбранные поля перенесите из списка доступных полей те поля, которые будут выводиться в отчет:
Документ,
Склад,
Мастер,
Клиент.
ПРИМЕЧАНИЕ
Добавление доступных полей в список выбранных полей можно осуществить перетаскиванием мышью, двойным щелчком на доступных полях либо нажатием кнопки Добавить справа от списка выбранных полей. Порядок выбранных полей можно изменить позже кнопками Вверх, Вниз или перетаскиванием мышью.
В результате окно настроек отчета должно иметь следующий вид (рис. 14.11).

Рис. 14.11. Окно настроек отчета {https://ai2b.pro/wp-content/uploads/1/14_11.png}
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистему Оказание услуг.

#### В прикладном решении
Запустите проект в режиме отладки. Вы видите, что в разделе Оказание услуг в подменю Отчеты, содержащем команды для выполнения отчетов, появилась команда для формирования отчета Реестр документов оказание услуги (рис. 14.12).

Рис. 14.12. Команда для формирования отчета {https://ai2b.pro/wp-content/uploads/1/14_12.png}
Выполните ее. Откроется автоматически сформированная системой форма отчета. Нажмите Сформировать (рис. 14.13).

Рис. 14.13. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_13.png}
Вы видите, что отчет содержит реестр документов Оказание услуги.
Двойным щелчком мыши в колонке Документ вы можете открыть исходный документ, а также правой кнопкой мыши вызвать контекстное меню «расшифровки», содержащее дополнительные действия по расшифровке значений (Открыть, Расшифровать и т. п.), находящихся в этом поле.

### Выбор данных из двух таблиц
Отчет Рейтинг услуг будет содержать информацию о том, выполнение каких услуг принесло ООО «На все руки мастер» наибольшую прибыль в указанном периоде (рис. 14.14).

Рис. 14.14. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_14.png}
На примере отчета Рейтинг услуг вы узнаете, как отбирать данные в некотором периоде, как задавать параметры запроса, как использовать в запросе данные из нескольких таблиц и как включать в результат запроса все данные одного из источников.
Также вы научитесь работать с параметрами системы компоновки данных, использовать стандартные даты и познакомитесь с быстрыми пользовательскими настройками отчетов.
Кроме этого вы научитесь более детально настраивать отбор и условное оформление в отчетах.

#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем РейтингУслуг.
Создайте основную схему компоновки данных отчета.
Откройте конструктор схемы компоновки данных, добавьте набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите объектную (ссылочную) таблицу справочника Номенклатура и виртуальную таблицу регистра накопления Продажи.Обороты.
Чтобы исключить неоднозначность имен в запросе, переименуйте таблицу Номенклатура в спрНоменклатура.
Для этого в списке Таблицы нажмите Переименовать таблицу в контекстном меню таблицы Номенклатура (рис. 14.15).

Рис. 14.15. Переименование таблицы в конструкторе запроса {https://ai2b.pro/wp-content/uploads/1/14_15.png}
В список полей перенесите поля спрНоменклатура.Ссылка и ПродажиОбороты.ВыручкаОборот из этих таблиц (рис. 14.16).

Рис. 14.16. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/14_16.png}
###### Левое соединение двух таблиц
Перейдите на закладку Связи. Так как в запросе теперь участвуют несколько таблиц, требуется определить связь между ними.
Вы видите, что по умолчанию 1С:EDT уже создала связь таблиц по полю Номенклатура. То есть значение измерения Номенклатура регистра Продажи должно быть равно ссылке на элемент справочника Номенклатура. Вас это устраивает.
Тип соединения задан как Левое. Но первой в соединении идет таблица регистра, которая связана левым соединением с таблицей справочника. А вам нужно установить левое соединение справочника с регистром, чтобы в результат запроса были включены все записи справочника Номенклатура и те записи регистра Продажи, которые удовлетворяют условию связи по полю Номенклатура.
То есть вам нужно поменять расположение таблиц в соединении так, чтобы первой (левой) таблицей была таблица справочника Номенклатура. Для этого нужно выделить первую таблицу в соединении, нажать Переместить в контекстном меню и выделить вторую таблицу (рис. 14.17).

Рис. 14.17. Изменение порядка таблиц в соединении {https://ai2b.pro/wp-content/uploads/1/14_17.png}
Таким образом, в результате запроса будут присутствовать все услуги, и для некоторых из них будут указаны обороты выручки. Для тех услуг, которые не производились в выбранном периоде, не будет указано ничего.
Описанную связь двух таблиц схематично можно представить следующим образом (рис. 14.18).

Рис. 14.18. Связь записей таблиц в запросе {https://ai2b.pro/wp-content/uploads/1/14_18.png}

###### Условие отбора записей
На закладке Условия установите отбор, чтобы группы справочника Номенклатура не попадали в отчет.
Для этого раскройте таблицу спрНоменклатура, перетащите мышью поле ЭтоГруппа в список условий, нажмите  и напишите следующий текст условия (листинг 14.2).
Листинг 14.2. Условие запроса
спрНоменклатура.ЭтоГруппа = ЛОЖЬ
Тем самым вы указали, что из базы данных нужно выбрать только те записи справочника Номенклатура, которые не являются группами.
Работу этого условия можно проиллюстрировать на следующем примере. Слева – исходная таблица справочника Номенклатура, а справа – записи, которые будут выбраны из этой таблицы (рис. 14.19).

Рис. 14.19. Отбор записей номенклатуры в запросе {https://ai2b.pro/wp-content/uploads/1/14_19.png}
Вторым условием должно быть то, что выбранный элемент является услугой. Чтобы создать это условие, просто перетащите мышью поле ВидНоменклатуры в список условий.
Конструктор автоматически сформирует условие, согласно которому вид номенклатуры должен быть равен значению параметра ВидНоменклатуры.
В дальнейшем перед выполнением запроса вы будете передавать в параметр ВидНоменклатуры значение перечисления – Услуга.
Работу этого условия тоже можно проиллюстрировать на примере. Слева – записи справочника Номенклатура, выбранные согласно первому условию. Справа – только те записи, которые являются услугами (рис. 14.20).

Рис. 14.20. Отбор записей номенклатуры в запросе {https://ai2b.pro/wp-content/uploads/1/14_20.png}
В результате закладка Условия примет следующий вид (рис. 14.21).

Рис. 14.21. Создание условия запроса {https://ai2b.pro/wp-content/uploads/1/14_21.png}
СОВЕТ
Отбор можно применять и в самом запросе, и в настройках отчета. То же касается сортировки и группировки. Отбор лучше применять в запросе, если записи, не удовлетворяющие условию запроса, наверняка не понадобятся в отчете. Сортировку и группировку лучше применять уже в настройках отчета, чтобы сделать его более гибким.

###### Псевдонимы полей
На закладке Объединения/Псевдонимы укажите, что представление элемента справочника (поле Ссылка) будет иметь псевдоним Услуга, а поле регистра будет иметь псевдоним Выручка (рис. 14.22).

Рис. 14.22. Установка псевдонимов полей запроса {https://ai2b.pro/wp-content/uploads/1/14_22.png}

###### Порядок записей
На закладке Порядок укажите, что результат запроса должен быть отсортирован по убыванию значения поля Выручка (рис. 14.23).

Рис. 14.23. Порядок записей запроса {https://ai2b.pro/wp-content/uploads/1/14_23.png}
Создание запроса закончено, нажмите ОK и вернитесь в конструктор схемы компоновки данных.

###### Текст запроса
Текст запроса, сформированный конструктором, примет следующий вид (листинг 14.3).
Листинг 14.3. Текст запроса
ВЫБРАТЬ
спрНоменклатура.Ссылка КАК Услуга,
ПродажиОбороты.ВыручкаОборот КАК Выручка
ИЗ
Справочник.Номенклатура КАК спрНоменклатура
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Продажи.Обороты КАК ПродажиОбороты
ПО ПродажиОбороты.Номенклатура = спрНоменклатура.Ссылка
ГДЕ
спрНоменклатура.ЭтоГруппа = ЛОЖЬ
И спрНоменклатура.ВидНоменклатуры = &ВидНоменклатуры
УПОРЯДОЧИТЬ ПО
Выручка УБЫВ
Еще раз обратите внимание: в тексте запроса ЛЕВОЕ СОЕДИНЕНИЕ означает, что в результат запроса нужно включить комбинации записей из обоих источников, которые соответствуют указанному после ключевого слова ПО условию. Кроме того, в результат запроса нужно включить еще и записи из первого (указанного слева от слова СОЕДИНЕНИЕ) источника, для которых не найдено соответствующих условию записей из первого источника.

##### Ресурсы
В своем отчете вы хотите видеть итоговые значения выручки для каждой услуги. Для этого вам нужно определить поля ресурсов отчета.
Под ресурсами в системе компоновки данных подразумеваются поля, значения которых рассчитываются на основании детальных записей, входящих в группировку. По сути ресурсы являются групповыми или общими итогами отчета.
Итоговые данные формируются на закладке Ресурсы.
Перейдите на эту закладку и нажмите , чтобы конструктор выбрал все доступные ресурсы, по которым можно вычислять итоги. В вашем случае это единственный ресурс Выручка.
Конструктор автоматически предложит рассчитывать сумму значений этого поля, что вам и нужно (рис. 14.24).

Рис. 14.24. Ресурсы схемы компоновки данных {https://ai2b.pro/wp-content/uploads/1/14_24.png}

##### Параметры
Пользователя, как правило, интересуют данные о хозяйственной деятельности за определенный период. Поэтому практически в любом отчете используются параметры, задающие начало и конец отчетного периода.
Параметры отчета задают условия отбора записей в отчет. В схеме компоновки данных параметры отчета задаются на закладке Параметры (рис. 14.25).

Рис. 14.25. Параметры компоновки данных {https://ai2b.pro/wp-content/uploads/1/14_25.png}
На этой закладке вы увидите три параметра: НачалоПериода, КонецПериода и ВидНоменклатуры. Вы можете спросить: почему параметра три, хотя в запросе вы задавали всего один – ВидНоменклатуры?
Все дело в том, что система компоновки данных самостоятельно анализирует текст запроса и помимо тех параметров, которые указаны в нем в явном виде (ВидНоменклатуры), предоставляет возможность настроить также и параметры виртуальных таблиц, которые участвуют в запросе.
Такими параметрами являются НачалоПериода и КонецПериода. Это первые два параметра виртуальной таблицы РегистрНакопления.Продажи.Обороты, которую вы использовали в запросе в качестве источника данных.
Если в конструкторе запроса выделить в списке таблиц эту таблицу и нажать кнопку Параметры виртуальной таблицы, то появится диалог, где вы увидите параметры НачалоПериода и КонецПериода (рис. 14.26).

Рис. 14.26. Параметры виртуальной таблицы {https://ai2b.pro/wp-content/uploads/1/14_26.png}
Первым параметром передается начало периода расчета итогов, вторым – конец периода. В результате исходная таблица будет содержать только обороты, рассчитанные в переданном периоде.
Здесь всегда следует помнить, что дата содержит и время с точностью до секунды. Поэтому в качестве конца периода следует выбирать либо конец интересующего вас дня, либо начало следующего дня.
Настройте параметр ВидНоменклатуры.
Поскольку отчет должен отображать выручку, полученную только от реализации услуг, значение параметра ВидНоменклатуры пользователь изменять не должен. Оно должно быть задано непосредственно в схеме компоновки как Перечисление.ВидыНоменклатуры.Услуга.
Флажок Ограничение доступности у параметра ВидНоменклатуры конструктор установил по умолчанию, поэтому вам остается только указать нужное значение перечисления ВидыНоменклатуры в ячейке Значение, соответствующей параметру ВидНоменклатуры.
Нажмите  и выберите это значение из списка перечисления видов номенклатуры – Услуга (рис. 14.27).

Рис. 14.27. Установка значения параметра «ВидНоменклатуры» {https://ai2b.pro/wp-content/uploads/1/14_27.png}

##### Настройки
Теперь сформируйте структуру отчета. На закладке Настройки добавьте группировку Детальные записи.
На закладке Выбранные поля выберите поля Услуга и Выручка (рис. 14.28).

Рис. 14.28. Структура отчета «РейтингУслуг» {https://ai2b.pro/wp-content/uploads/1/14_28.png}
На закладке Другие настройки задайте заголовок отчета – Рейтинг услуг (рис. 14.29).

Рис. 14.29. Установка заголовка отчета {https://ai2b.pro/wp-content/uploads/1/14_29.png}
ПРИМЕЧАНИЕ
При изменении параметров настроек, которые предполагают выбор некоторого значения, нужно выделить двойным щелчком поле Значение и, нажав кнопку , выбрать из списка значений нужный вариант. При этом флажок использования значения появится автоматически. Этот флажок можно также снять и установить вручную.

##### Быстрые пользовательские настройки
В заключение вы должны предоставить пользователю возможность задавать отчетный период перед формированием отчета. То есть параметры НачалоПериода и КонецПериода должны быть включены в пользовательские настройки.
Причем, поскольку задавать отчетный период требуется практически всегда, эти настройки должны находиться непосредственно в форме отчета.
На закладке Параметры выделите по очереди каждый из этих параметров и нажмите  (Свойства элемента пользовательских настроек).
Установите флажок Включать в пользовательские настройки и оставьте предложенное по умолчанию для свойства Режим редактирования значение Быстрый доступ (рис. 14.30).

Рис. 14.30. Определение пользовательских настроек {https://ai2b.pro/wp-content/uploads/1/14_30.png}
Флажок Включать в пользовательские настройки означает, что эта настройка будет доступна пользователю в отдельном окне (2) по команде Настройки… (то есть такая настройка, которой он может пользоваться, но не очень часто, рис. 14.31).

Рис. 14.31. Быстрые (1) и обычные (2) пользовательские настройки {https://ai2b.pro/wp-content/uploads/1/14_31.png}
А режим редактирования, установленный в значение Быстрый доступ, означает, что эта настройка также будет автоматически отображаться непосредственно в отчетной форме (1). Это быстрая пользовательская настройка – такая настройка, которая нужна пользователю постоянно, чуть ли не при каждом запуске отчета. Поэтому она должна быть всегда «под рукой».
Кроме того, чтобы улучшить интерфейс пользователя, задайте для параметров Начало периода и Конец периода в качестве начальных значений стандартные даты, например: Начало прошлого квартала и Начало следующего дня.
Для этого в поле Значение параметров нажмите кнопку выбора типа , укажите тип – Стандартная дата начала и в выпадающем списке выберите нужное значение.
Таким образом, при открытии отчета даты начала и окончания отчетного периода будут динамически меняться и показывать период с начала прошлого квартала по начало следующего дня, и пользователю, возможно, не придется менять их вручную.
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистемы Оказание услуг и Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите, как работает отчет.
Вы видите, что в разделах Оказание услуг и Бухгалтерия в подменю Отчеты появилась команда для формирования отчета Рейтинг услуг.
Выполните эту команду. Откроется форма отчета, автоматически сформированная системой.
В окне отчета вы видите параметры, определяющие отчетный период. Он по умолчанию задан – с начала прошлого квартала по начало завтрашнего дня. Но можно при желании изменить его, воспользовавшись кнопкой календаря.
Нажмите Сформировать. Результат будет выглядеть следующим образом (рис. 14.32).

Рис. 14.32. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_32.png}
Вы видите, что выручка от услуг из всех трех введенных вами документов Оказание услуги попала в отчет, так как даты создания этих документов входят в отчетный период.
Заметьте, что вверху окна результата отчета выводятся заданный вами заголовок и параметры, определяющие отчетный период.
Обратите внимание, что при прокручивании отчета вниз положение шапки отчета остается зафиксированным. Для удобства пользователя платформа автоматически фиксирует сверху табличный документ, в который выводится результат отчета. Можно также вручную управлять фиксацией строк и столбцов отчета с помощью параметров вывода ФиксацияСлева и ФиксацияСверху.
Также заметьте, что название услуг (поле Ссылка справочника Номенклатура) включает как наименование, так и вид номенклатуры соответственно заданному вами представлению ссылок на номенклатуру.
Теперь измените конец периода на 15.10.2022 (рис. 14.33) и сформируйте отчет.

Рис. 14.33. Выбор конца периода из календаря {https://ai2b.pro/wp-content/uploads/1/14_33.png}
Отчет будет пуст, т.к. вы не задали время конца периода, а оно указывает на начало дня (0:00:00). Документ Оказание услуги № 1 имеет время 16:11:00 и не попадает в выбранный вами период отчета.
Чтобы исправить ситуацию, в поле Конец периода напишите время конца дня (23:59:59) и еще раз сформируйте отчет. Теперь вы увидите в отчете данные документа Оказание услуги № 1. (рис. 14.34).

Рис. 14.34. Данные документа «Оказание услуги» № 1 {https://ai2b.pro/wp-content/uploads/1/14_34.png}
Поскольку в запросе данных для отчета таблица номенклатуры связана левым соединением с таблицей регистра продаж, услуги, для которых нет данных о продажах, все равно показаны в отчете.

#### Настройки в 1C:EDT и в прикладном решении
Далее на примере этого отчета вы научитесь создавать и использовать другие настройки отчета: Условное оформление и Отбор.
В процессе создания этих настроек вы будете выполнять некоторые действия в 1С:EDT и затем смотреть в прикладном решении, что получилось.
На самом деле все то же самое, что вы будете настраивать в 1С:EDT, можно настроить и в прикладном решении по команде Еще > Изменить вариант... При этом пользователю открывается окно настроек отчета, очень похожее на закладку Настройки в схеме компоновки данных.
Различие состоит в том, что настройки, сделанные в 1С:EDT, называются стандартными настройками и будут сохранены в самой схеме компоновки данных, то есть будут являться частью конфигурации. Это означает, что любой пользователь конфигурации будет видеть отчет именно в таком виде, как вы его настроили в 1С:EDT.
Все то же самое можно настроить и в прикладном решении, но эта настройка уже не будет являться частью конфигурации и будет доступна только одному конкретному пользователю конкретной информационной базы, который эту настройку произвел.
Примечание
В конфигурации может быть разработан механизм, позволяющий обмениваться настройками между различными пользователями. Это непростая задача, и в рамках данной книги она рассматриваться не будет, но в принципе такая возможность существует.
Возможность изменения варианта отчета в прикладном решении не предназначена для рядового пользователя (для него – быстрые настройки и пользовательские настройки). Она предназначена для разработчика, осуществляющего внедрение, или для администратора, или для очень опытного пользователя.
Настройки, сделанные в прикладном решении, естественно, «перекрывают» стандартные настройки. И, если пользователь все перестроил в отчете так, что его не узнать, всегда можно вернуться к стандартным настройкам по команде Еще > Установить стандартные настройки.
Сейчас вы настроите отчет для любых пользователей, которые будут им пользоваться, поэтому вы должны изменить стандартные настройки схемы компоновки данных в 1С:EDT.
Но если завтра главный бухгалтер попросит вас «сделать отчет красивым», то вы сможете повторить все то же самое, не меняя конфигурацию и прямо у него на глазах.
##### Условное оформление
В таком отчете, как Рейтинг услуг, было бы удобно выделять цветом записи, содержащие услуги с наименьшей или с наибольшей выручкой, либо еще по какому-либо условию.
###### В 1C:EDT
Итак, откройте схему компоновки данных на закладке Настройки.
В нижней части окна перейдите на закладку Условное оформление и нажмите Добавить в правом верхнем углу окна настроек (рис. 14.35).

Рис. 14.35. Настройка условного оформления {https://ai2b.pro/wp-content/uploads/1/14_35.png}
Сначала укажите Оформление, то есть то, каким образом должны выделяться интересующие вас поля.
Нажмите кнопку выбора  в поле Оформление и установите красный цвет текста. Нажмите ОК.
Затем укажите Условие, при наступлении которого будет применяться оформление, то есть когда в вашем отчете текст будет становиться красным.
Нажмите кнопку выбора  в поле Условие и в появившемся окне добавьте новый элемент отбора. Каждый элемент отбора задает одно условие. Условий может быть несколько.
Перетащите поле Выручка из списка доступных полей в список условий отбора. В графе Вид сравнения выберите значение Меньше, а в графе Правое значение – 1500. Нажмите ОК (рис. 14.36).

Рис. 14.36. Настройка условного оформления {https://ai2b.pro/wp-content/uploads/1/14_36.png}
То есть, когда в поле Выручка окажется значение меньше 1500, «что-то» будет выделено красным цветом текста.
Теперь укажите это «что-то», то есть задайте список оформляемых полей.
Если вы хотите выделить всю строку отчета, то можно оставить этот список пустым. Или же нажать кнопку выбора  в поле Оформляемые поля – тогда в появившемся окне, нажимая кнопку Добавить, можно выбрать поля Услуга и Выручка (рис. 14.37).

Рис. 14.37. Настройка условного оформления {https://ai2b.pro/wp-content/uploads/1/14_37.png}
В данном случае можно было бы этого не делать, так как Услуга и Выручка и есть все поля отчета. Нажмите ОК.
В заключение задайте Представление условного оформления как Непопулярная услуга (рис. 14.38).

Рис. 14.38. Настройка условного оформления {https://ai2b.pro/wp-content/uploads/1/14_38.png}
Непопулярная услуга – это то, что увидит пользователь в своих настройках. То есть вместо пугающей строки «Выручка меньше 1500…» пользователь увидит осмысленное выражение, которое задано в поле Представление.
Итак, вы задали условное оформление отчета, по которому все услуги с выручкой менее 1500 руб. будут считаться «непопулярными» и выделяться красным цветом.
Теперь добавьте это условие в пользовательские настройки. Нажмите  (Свойства элемента пользовательских настроек, рис. 14.38). Установите флажок Включать в пользовательские настройки, а свойство Режим редактирования – в значение Обычный.
Тем самым вы включили созданную вами настройку условного оформления в обычные пользовательские настройки. Эти настройки, в отличие от быстрых настроек, расположены не в форме отчета, а вызываются по команде Настройки… и появляются в отдельном окне, так как они используются значительно реже, чем, например, настройки отчетного периода.

###### В прикладном решении 
Запустите проект в режиме отладки и вызовите отчет.
Нажмите Еще > Установить стандартные настройки, чтобы дата окончания отчета вернулась к тому значению, которое установлено в 1C:EDT, и нажмите Сформировать (рис. 14.39).

Рис. 14.39. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_39.png}
Вы видите, что суммы услуг менее 1500 руб. выделены красным цветом. Нажмите Настройки… в командной панели отчета.
Перед вами появится окно пользовательских настроек отчета, содержащее параметры отчетного периода и настройку условного оформления Непопулярная услуга. Вы можете снять флажок использования этой настройки, нажать кнопку Завершить редактирование (рис. 14.40) и снова сформировать отчет.

Рис. 14.40. Окно пользовательских настроек {https://ai2b.pro/wp-content/uploads/1/14_40.png}
Выделение цветом исчезнет. Настройка Непопулярная услуга не видна в форме отчета, так как вы установили для нее в качестве режима редактирования Обычный, а не Быстрый доступ.
Однако данная настройка условного оформления задана жестко, и пользователь может лишь включить или выключить признак ее использования. Для неопытных пользователей этого, как правило, вполне достаточно.
Но более подготовленным пользователям вы можете предоставить больше свободы в использовании настроек, то есть возможность, например, самостоятельно задавать настройки отчета: отбор, порядок, условное оформление и пр.
Этот вариант показан ниже.

##### Пользовательские настройки
###### В 1C:EDT
На закладке Настройки схемы компоновки данных содержатся полные настройки отчета, которые задает разработчик. Часть из них может быть предоставлена пользователю для создания произвольного отбора, условного оформления отчета и пр.
Для этого нажмите  (Свойства элемента пользовательских настроек) в командной панели окна настроек (рис. 14.41).

Рис. 14.41. Состав пользовательских настроек {https://ai2b.pro/wp-content/uploads/1/14_41.png}
В появившемся окне вы можете редактировать состав пользовательских настроек отчета.
Включите признак использования для настроек Отбор и Условное оформление и установите для них свойство Режим редактирования в значение Обычный.
Таким образом вы включили настройки отбора и условного оформления в пользовательские настройки и предоставили пользователю возможность задавать их в отдельном окне по команде Настройки…

###### В прикладном решении
Запустите проект в режиме отладки, откройте отчет и нажмите Настройки в командной панели отчета.
В окне пользовательских настроек отчета появились вкладки Отбор и Условное оформление, которые вы только что отметили (рис. 14.42).

Рис. 14.42. Окно пользовательских настроек {https://ai2b.pro/wp-content/uploads/1/14_42.png}
На самом деле здесь присутствуют две настройки условного оформления.
Настройку Непопулярная услуга вы заранее создали в схеме компоновки данных. А теперь, добавив настройку условного оформления «вообще», вы предоставили пользователю возможность создавать любое количество собственных условий для условного оформления аналогично тому, как вы это делали в 1С:EDT.
Сейчас задайте отбор в отчете так, чтобы в него попадали только услуги, относящиеся к установке стиральных машин. Для этого в окне пользовательских настроек перейдите на закладку Отбор. Слева вы видите список доступных полей отчета. Раскройте поле Услуга и двойным щелчком мыши на поле Группа материалов/услуг перенесите его в список условий отбора в правой части окна (рис. 14.43).

Рис. 14.43. Настройка отбора {https://ai2b.pro/wp-content/uploads/1/14_43.png}
Вам остается только нажать кнопку выбора  в колонке Значение, ввести первые несколько символов наименования нужной группы номенклатуры и выбрать строку Стиральные машины из выпадающего списка под окном ввода значения (рис. 14.44).

Рис. 14.44. Настройка отбора {https://ai2b.pro/wp-content/uploads/1/14_44.png}
Таким образом вы задали отбор по услугам, родителем которых является группа Стиральные машины справочника Номенклатура.
Нажмите Завершить редактирование и сформируйте отчет (рис. 14.45).

Рис. 14.45. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_45.png}
Вы видите, что в отчет включены только услуги по установке стиральных машин и в заголовке отчета отражена информация об отборе.
При закрытии окна отчета настройки, сделанные пользователем, запоминаются и становятся настройками по умолчанию для текущего пользователя.
Можно удалить настройку отбора или создать ее по другому критерию, нажав кнопку выбора  в колонке Значение (рис. 14.44).
Таким образом, пользователь сможет при наличии определенной квалификации задавать многие настройки по своему желанию.
Если же такого желания или соответствующих знаний у него нет, лучше задавать эти настройки жестко, а пользователю останется только включать или выключать их использование.
Да, собственно, часто достаточно только отчетного периода или еще какой-то жизненно важной настройки, и такие настройки, конечно, нужно размещать непосредственно в отчетной форме.
Если приоритеты пользователя по использованию настроек отличаются от того, как они заданы разработчиком в схеме компоновки данных, то пользователь может изменить состав настроек, выполнив команду Еще > Изменить состав настроек… (рис. 14.46).

Рис. 14.46. Изменение состава настроек в прикладном решении {https://ai2b.pro/wp-content/uploads/1/14_46.png}
В открывшемся окне Состав настроек пользователь может указать, какие настройки будут редактироваться в форме отчета (правый список), то есть будут быстрыми, а какие будут доступны по команде Настройки… (левый список). Кнопками Добавить, Удалить или двойным щелчком мыши можно перенести настройки из левого списка в правый и наоборот (рис. 14.47).

Рис. 14.47. Редактирование состава настроек в режиме «1С:Предприятие» {https://ai2b.pro/wp-content/uploads/1/14_47.png}
Теперь очистите условие отбора в окне отчета, затем вернитесь в 1С:EDT и снимите признак использования у настройки отбора. Это вам понадобится в дальнейших примерах.



### Вывод данных по всем дням в выбранном периоде
Следующий отчет, который вы создадите, будет называться Выручка мастеров.
Он будет содержать информацию о том, какая выручка была получена ООО «На все руки мастер» благодаря работе каждого из мастеров, с детализацией по всем дням в выбранном периоде и разворотом по клиентам, обслуженным в каждый из дней (рис. 14.48).

Рис. 14.48. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_48.png}
На примере этого отчета вы узнаете, как строить многоуровневые группировки в запросе и как обходить все даты в выбранном периоде.
Также вы научитесь настраивать отдельные элементы структуры отчета, выводить данные в диаграмму и создавать несколько вариантов отчета в схеме компоновки данных.

#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем ВыручкаМастеров.
Создайте основную схему компоновки данных отчета.
Добавьте в схему набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите виртуальную таблицу регистра накопления Продажи.Обороты.

###### Параметры виртуальной таблицы
Задайте один из параметров этой виртуальной таблицы – Периодичность – День (рис. 14.49).

Рис. 14.49. Изменение параметров виртуальной таблицы {https://ai2b.pro/wp-content/uploads/1/14_49.png}
После этого выберите из таблицы следующие поля (рис. 14.50):
ПродажиОбороты.Мастер,
ПродажиОбороты.Период,
ПродажиОбороты.Клиент,
ПродажиОбороты.ВыручкаОборот.

Рис. 14.50. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/14_50.png}
На закладке Объединения/Псевдонимы задайте псевдоним Выручка для поля ПродажиОбороты.ВыручкаОборот (рис. 14.51).

Рис. 14.51. «Объединения/Псевдонимы» {https://ai2b.pro/wp-content/uploads/1/14_51.png}

###### Текст запроса
Нажмите ОК. Конструктор сформирует следующий текст запроса (листинг 14.5).
Листинг 14.5. Текст запроса
ВЫБРАТЬ
ПродажиОбороты.Мастер,
ПродажиОбороты.Период,
ПродажиОбороты.Клиент,
ПродажиОбороты.ВыручкаОборот КАК Выручка
ИЗ
РегистрНакопления.Продажи.Обороты( , , День,) КАК ПродажиОбороты
Обратите внимание: благодаря тому, что у таблицы-источника данных задана периодичность, вы можете описать среди выбранных полей поле Период.
##### Ресурсы
На закладке Ресурсы схемы компоновки данных нажмите . В результате конструктор выберет единственный имеющийся у вас ресурс – Выручка.

##### Настройки
Теперь создайте структуру отчета.
Сначала создайте две группировки:
верхнего уровня – по полю Мастер;
вложенная в нее – по полю Период.
Для этого на закладке Настройки нажмите Новая группировка в контекстном меню корневого элемента Отчет и укажите поле группировки Мастер (рис. 14.52).

Рис. 14.52. Добавление новой группировки в отчет {https://ai2b.pro/wp-content/uploads/1/14_52.png}
Затем добавьте в группировку Мастер вложенную группировку по полю Период.
Будьте внимательны!
Группировка (или другой элемент иерархической структуры отчета) добавляется на тот уровень отчета, для которого вызывается контекстное меню. Чтобы добавить группировку верхнего уровня, выделите корневой элемент структуры Отчет. Чтобы вложить одну группировку в другую, выделите родительскую группировку и вызовите ее контекстное меню.
Затем добавьте группировку Детальные записи (без указания группировочного поля), вложенную в группировку по полю Период.
На закладке Выбранные поля перенесите в список выбранных полей поля Клиент и Выручка.
Поля Мастер и Период можно не задавать, так как по этим полям производится группировка данных и их значение будет выведено автоматически.
В результате структура отчета будет иметь следующий вид (рис. 14.53).

Рис. 14.53. Структура и поля отчета {https://ai2b.pro/wp-content/uploads/1/14_53.png}
В заключение на закладке Другие настройки измените следующие параметры.
Для параметра Расположение полей группировок установите значение Отдельно и только в итогах.
По умолчанию поля группировок в отчете располагаются вертикально друг под другом (рис. 14.54).

Рис. 14.54. Расположение полей группировок и итогов по вертикали по умолчанию {https://ai2b.pro/wp-content/uploads/1/14_54.png}
Установка этого свойства в значение Отдельно и только в итогах означает, что каждая группировка будет располагаться в отдельной области отчета слева направо и ее наименование будет выводиться только в данной группировке (рис. 14.55).

Рис. 14.55. Расположение полей группировок «Отдельно и только в итогах» {https://ai2b.pro/wp-content/uploads/1/14_55.png}
Для параметра Расположение общих итогов по вертикали задайте значение Начало.
По умолчанию итоги по вертикали располагаются в конце (рис. 14.58). Установка этого свойства означает, что общие итоги будут отображаться в начале перед строками группировки (рис. 14.56).

Рис. 14.56. Расположение итогов по вертикали в начале {https://ai2b.pro/wp-content/uploads/1/14_56.png}
В результате другие настройки отчета примут следующий вид (рис. 14.57).

Рис. 14.57. Параметры настроек вывода отчета {https://ai2b.pro/wp-content/uploads/1/14_57.png}
Здесь же для параметра Заголовок задайте значение Выручка мастеров.
Затем установите флажки у параметров Начало периода и Конец периода и укажите, что эти параметры будут включены в пользовательские настройки и эти настройки будут находиться непосредственно в отчетной форме, то есть будут «быстрыми» настройками.
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистемы Оказание услуг и Расчет зарплаты.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите, как работает отчет.
Вы видите, что в разделах Оказание услуг и Расчет зарплаты в подменю Отчеты появилась команда для формирования отчета Выручка мастеров.
Выполните эту команду. Задайте отчетный период с 01.10.2022 по 07.11.2022 23:59:59 и сформируйте отчет (рис. 14.58).

Рис. 14.58. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_58.png}
Если отчетный период для пользователя не важен, то он может снять признак использования параметров (флажок слева от параметра). В этом случае отчет будет формироваться по всем записям регистра Продажи, находящимся в базе данных, то есть в данном случае результат отчета будет таким же.

#### Вывод всех дат в выбранном периоде
Если вы помните, в начале раздела говорилось, что этот отчет должен показывать данные с детализацией по всем дням в выбранном периоде.
У вас же отображаются только те дни, для которых существуют ненулевые записи в таблице регистра накопления Продажи.
Для детализации данных в отчете система компоновки данных позволяет указывать для группировок дополнение периодов с заданной периодичностью в указанном интервале.
Для этого вам нужно изменить настройки отчета таким образом, чтобы в отчет попадала каждая дата из периода, за который сформирован отчет.
##### В 1C:EDT
Откройте схему компоновки данных на закладке Настройки и выполните более тонкую настройку структуры отчета.
До сих пор все настройки структуры, которые вы выполняли, относились ко всему отчету в целом. Но система компоновки данных позволяет настраивать также и каждый элемент структуры в отдельности.
ВНИМАНИЕ!
При установке настроек отчета в средней части окна, под деревом структуры отчета, должна быть выделена кнопка, соответствующая режиму настроек. Кнопка Отчет – для настройки отчета в целом или кнопка с именем группировки, например Детальные записи, если настройки относятся только к ней.
В вашем случае потребуется изменить настройку группировки Период.
Для того чтобы перейти к настройкам именно этой группировки, в поле структуры отчета установите курсор на эту группировку, а затем нажмите кнопку Период в средней части окна, под деревом структуры отчета.
В нижней части окна будут отображены настройки, доступные для данной группировки.
Перейдите на закладку Поля группировки. Для поля Период установите Тип дополнения – День (рис. 14.59).

Рис. 14.59. Установка типа дополнения периода {https://ai2b.pro/wp-content/uploads/1/14_59.png}
Тем самым вы указали, что для этой группировки существующие записи с ненулевым значением ресурса будут дополняться записями для каждого из дней.
После этого следует указать, в каком именно периоде будет выполняться такое дополнение.
Указание дат отчетного периода в явном виде вас не устраивает, так как пользователь может сформировать отчет за произвольный период. И вам нужно, чтобы дополнение дат выполнялось не в некотором фиксированном периоде, а именно в том периоде, который выбрал пользователь для всего отчета.
Для того чтобы обеспечить именно такую работу отчета, нажмите кнопку выбора  у поля Тип дополнения. Затем в выпадающем списке поля Дата начала выберите тип данных, отображаемых в этом поле, – Поле компоновки данных. После этого в открывшемся окне выбора поля отметьте параметр НачалоПериода (рис. 14.60).

Рис. 14.60. Настройки группировки «Период» {https://ai2b.pro/wp-content/uploads/1/14_60.png}
Для второго поля ввода аналогичным образом укажите, что дата окончания периода будет получена из параметра КонецПериода (рис. 14.61).

Рис. 14.61. Настройки группировки «Период» {https://ai2b.pro/wp-content/uploads/1/14_61.png}

##### В прикладном решении
Запустите проект в режиме отладки и выполните отчет Выручка мастеров за период с 13.10.2022 по 13.11.2022 (рис. 14.62).

Рис. 14.62. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_62.png}
В результате будет произведена детализация данных из регистра накопления Продажи с разбивкой по дням в указанном периоде, то есть в отчете будут отображаться и те дни, в которые не оказывались услуги.

#### Новый вариант отчета
Для анализа работы мастеров за определенный период может понадобиться представить ту же информацию в другом, более наглядном виде. Например, директору при начислении зарплаты, чтобы понять, какой из мастеров лучше работает, вполне может понадобиться увидеть диаграмму, отражающую вклад каждого мастера в общую выручку предприятия за период.
Для этого вам нужно будет создать другой вариант отчета ВыручкаМастеров, представляющий данные в виде диаграммы.
##### Диаграмма
Логически диаграмма является совокупностью точек, серий и значений серий в точке (рис. 14.63).

Рис. 14.63. Пример диаграммы {https://ai2b.pro/wp-content/uploads/1/14_63.png}
Как правило, в качестве точек используются моменты или объекты, для которых вы получаете значения характеристик, а в качестве серий – характеристики, значения которых вас интересуют. На пересечении серии и точки находится значение диаграммы.
Например, диаграмма продаж видов номенклатуры по месяцам будет состоять из точек – месяцев, серий – видов номенклатуры и значений – оборотов продаж.
Диаграмма как объект встроенного языка имеет три области, которые позволяют управлять оформлением диаграммы: область построения, область заголовка и область легенды (рис. 14.64).

Рис. 14.64. Области диаграммы {https://ai2b.pro/wp-content/uploads/1/14_64.png}
Диаграмма может быть вставлена в структуру отчета как отдельный элемент. В следующем варианте настроек отчета ВыручкаМастеров вы будете использовать диаграмму в структуре настроек схемы компоновки данных.

##### В 1C:EDT
Откройте схему компоновки данных на закладке Настройки.
В левой части окна находится список вариантов отчета.
При создании настроек отчета в первый раз система компоновки данных по умолчанию создает Основной вариант настроек. И вы видите его в списке вариантов вашего отчета.
Чтобы добавить новый вариант, нажмите Добавить над этим списком. Задайте имя варианта – ОбъемВыручки, а представление варианта отчета в интерфейсе как Объем выручки (рис. 14.65).

Рис. 14.65. Добавление нового варианта настроек {https://ai2b.pro/wp-content/uploads/1/14_65.png}
Вы видите, что структура отчета и все его настройки очистились.
Но они не пропали, а стали невидимы, так как относятся к основному варианту настроек.
Если у отчета есть несколько вариантов, то вы видите и можете изменять настройки того варианта, который выделен в данный момент. Причем вся остальная информация в схеме компоновки данных (ресурсы, параметры, наборы данных) осталась без изменений. Данные для отчета будут получены с помощью того же запроса к базе данных. Изменятся лишь настройки, которые определят, как будет представлен отчет.
Добавьте в структуру отчета диаграмму. Для этого нажмите Новая диаграмма в контекстном меню корневого элемента Отчет (рис. 14.66).

Рис. 14.66. Добавление диаграммы в структуру отчета {https://ai2b.pro/wp-content/uploads/1/14_66.png}
Затем выделите ветку Точки и добавьте в нее группировку по полю Мастер. Серии диаграммы оставьте без изменений.
Для демонстрации вклада мастеров в общий объем выручки хорошо подходит измерительная диаграмма. Для этого вида диаграммы достаточно задать только точки, поэтому серии вам задавать не нужно.
В значения диаграммы выводится один или сразу несколько ресурсов отчета. У вас всего один ресурс – Выручка (поле ресурса помечено соответствующей пиктограммой и отличается от обычных полей).
Поэтому на закладке Выбранные поля выберите поле Выручка для вывода в отчет. Структура отчета должна принять следующий вид (рис. 14.67).

Рис. 14.67. Структура отчета и настройки диаграммы {https://ai2b.pro/wp-content/uploads/1/14_67.png}
ВНИМАНИЕ!
В диаграмме обязательно должен выводиться один или несколько ресурсов отчета, иначе будет получена ошибка.
На закладке Другие настройки выберите тип диаграммы – Измерительная (рис. 14.68).

Рис. 14.68. Настройка типа диаграммы {https://ai2b.pro/wp-content/uploads/1/14_68.png}
Прокрутите вниз список свойств измерительной диаграммы и задайте Информационные интервалы значений – Плохо, Хорошо и Отлично (рис. 14.69).

Рис. 14.69. Настройка полос измерительной диаграммы {https://ai2b.pro/wp-content/uploads/1/14_69.png}
В заключение включите параметры Начало периода и Конец периода в быстрые пользовательские настройки.
ВНИМАНИЕ!
Состав пользовательских настроек для каждого варианта отчета нужно настраивать заново, поскольку у каждого варианта отчета – свои пользовательские настройки.

##### В прикладном решении
Запустите проект в режиме отладки и откройте отчет Выручка мастеров.
В форме отчета нажмите Выбрать вариант (рис. 14.70).

Рис. 14.70. Выбор варианта отчета {https://ai2b.pro/wp-content/uploads/1/14_70.png}
В окне вариантов отчета вы видите теперь два варианта: Основной и только что созданный вами вариант Объем выручки. Выделите его и нажмите Выбрать.
Снимите признак использования у параметров отчетного периода и сформируйте отчет (рис. 14.71).

Рис. 14.71. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_71.png}
В результате вы видите те же данные, что и в основном варианте отчета, представленные в виде измерительной диаграммы. На диаграмме хорошо видна доля каждого мастера в общем объеме выручки. Обратите внимание, что при наведении курсора на стрелку диаграммы появляется подсказка.
Заметьте, что вы сформировали отчет, не задавая отчетный период. Но все данные об оказании услуг все равно попали в отчет. В реальной жизни документов будет, конечно, не три, а намного больше. Поэтому возможность указывать отчетный период нужна, чтобы просматривать диаграммы о работе мастеров, например, за месяц и т. п.
Если же понадобится просмотреть данные о работе какого-либо мастера с разбивкой по дням и клиентам, достаточно выбрать Основной вариант отчета и сформировать его.
Таким образом, на примере отчета Выручка мастеров вы узнали, как создавать и использовать различные варианты отчета в целях наилучшего представления информации о работе мастеров.

### Получение актуальных значений из периодического регистра сведений
Следующий отчет – Перечень услуг – будет содержать информацию о том, какие услуги и по какой цене оказывает ООО «На все руки мастер» (рис. 14.72).

Рис. 14.72. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_72.png}
На его примере вы познакомитесь с возможностью получения последних значений из периодического регистра сведений и с возможностью вывода данных из иерархических справочников.
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем ПереченьУслуг.
Создайте основную схему компоновки данных отчета.
Добавьте в схему набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите объектную (ссылочную) таблицу справочника Номенклатура и виртуальную таблицу регистра сведений Цены.СрезПоследних.
Для того чтобы исключить неоднозначность имен в запросе, переименуйте таблицу Номенклатура в спрНоменклатура.
###### Параметры виртуальной таблицы
Вызовите диалог ввода параметров виртуальной таблицы Цены.СрезПоследних и укажите, что период будет передан в параметре ДатаОтчета (рис. 14.73).

Рис. 14.73. Параметры виртуальной таблицы {https://ai2b.pro/wp-content/uploads/1/14_73.png}
Затем выберите из таблиц следующие поля (рис. 14.74):
спрНоменклатура.Родитель,
спрНоменклатура.Ссылка,
ЦеныСрезПоследних.Цена.

Рис. 14.74. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/14_74.png}

###### Левое соединение двух таблиц
Перейдите на закладку Связи и укажите, что из таблицы справочника Номенклатура вы будете выбирать все записи, а из таблицы регистра сведений – только те, которые соответствуют условию связи по полю Номенклатура.
Для этого поменяйте расположение таблиц в соединении так, чтобы первой (левой) таблицей была таблица справочника Номенклатура.

###### Условия отбора
На закладке Условия задайте условие выбора элементов справочника Номенклатура – выбираемые элементы должны соответствовать виду номенклатуры, переданному в параметре запроса ВидНоменклатуры (рис. 14.75).

Рис. 14.75. Условия выбора элементов {https://ai2b.pro/wp-content/uploads/1/14_75.png}

###### Псевдонимы полей
На закладке Объединения/Псевдонимы укажите, что поле Родитель будет иметь псевдоним ГруппаУслуг, а поле Ссылка – Услуга (рис. 14.76).

Рис. 14.76. «Объединения/Псевдонимы» {https://ai2b.pro/wp-content/uploads/1/14_76.png}
На этом создание запроса завершено, нажмите OK.

###### Текст запроса
Текст запроса, сформированный конструктором, будет иметь следующий вид (листинг 14.7).
Листинг 14.7. Текст запроса
ВЫБРАТЬ
спрНоменклатура.Родитель КАК ГруппаУслуг,
спрНоменклатура.Ссылка КАК Услуга,
ЦеныСрезПоследних.Цена
ИЗ
Справочник.Номенклатура КАК спрНоменклатура
ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних(&ДатаОтчета,) КАК ЦеныСрезПоследних
ПО ЦеныСрезПоследних.Номенклатура = спрНоменклатура.Ссылка
ГДЕ
спрНоменклатура.ВидНоменклатуры = &ВидНоменклатуры

##### Ресурсы
На закладке Ресурсы схемы компоновки данных нажмите  и выберите единственный доступный ресурс – Цена. В колонке Рассчитывать по выберите поле Услуга (рис. 14.77).

Рис. 14.77. Ресурсы схемы компоновки {https://ai2b.pro/wp-content/uploads/1/14_77.png}
Это сделано для того, чтобы итоги по цене выводились для конкретной услуги, так как для группировок и общих итогов рассчитывать цену не имеет смысла.

##### Параметры
На закладке Параметры задайте значение параметра ВидНоменклатуры как Перечисление.ВидыНоменклатуры.Услуга.
Кроме того, снимите ограничение доступности для параметра ДатаОтчета.
Для параметра Период, наоборот, установите ограничение доступности (рис. 14.78).

Рис. 14.78. Параметры схемы компоновки {https://ai2b.pro/wp-content/uploads/1/14_78.png}

##### Настройки
На закладке Настройки схемы компоновки данных создайте группировку по полю ГруппаУслуг, указав тип группировки Иерархия (рис. 14.79).

Рис. 14.79. Выбор поля и типа группировки {https://ai2b.pro/wp-content/uploads/1/14_79.png}
ПРИМЕЧАНИЕ
До сих пор вы использовали тип иерархии по умолчанию – Без иерархии. Существуют следующие типы иерархии для группировок отчета:
- Без иерархии – в группировке выводятся только неиерархические записи;
- Иерархия – в группировке выводятся как неиерархические, так и иерархические записи;
- Только иерархия – в группировке выводятся только иерархические записи.
Внутри этой группировки создайте еще одну группировку Детальные записи.
На закладке Выбранные поля укажите, что в отчет будут выводиться поля Услуга и Цена (рис. 14.80).

Рис. 14.80. Структура и поля отчета {https://ai2b.pro/wp-content/uploads/1/14_80.png}
Теперь настройте внешний вид отчета на закладке Другие настройки.
Чтобы запретить вывод общих итогов в отчете, установите параметр Расположение общих итогов по вертикали в значение Нет.
Для параметра Расположение полей группировок укажите значение Отдельно и только в итогах (так отчет будет лучше читаться). Также задайте заголовок отчета – Перечень услуг (рис. 14.81).

Рис. 14.81. Параметры настроек вывода отчета {https://ai2b.pro/wp-content/uploads/1/14_81.png}
Теперь укажите, что параметр Дата отчета будет включен в быстрые пользовательские настройки.
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистемы Оказание услуг и Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки и прежде всего откройте периодический регистр Цены.
Добавьте в него еще одно значение для услуги Диагностика: новая цена услуги на 11.11.2022 – 450 (рис. 14.82). Это позволит вам протестировать отчет.

Рис. 14.82. Добавление новой записи регистра «Цены» для услуги «Диагностика» {https://ai2b.pro/wp-content/uploads/1/14_82.png}
Теперь выполните отчет Перечень услуг по состоянию на 13.10.2022 (рис. 14.83).

Рис. 14.83. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_83.png}
Ваш отчет правильно отражает цену услуги Диагностика на 13.10.2022 – 300 руб.
Еще раз выполните отчет, но теперь уже на другую дату – 11.11.2022 (рис. 14.84).

Рис. 14.84. Результат выполнения отчета {https://ai2b.pro/wp-content/uploads/1/14_84.png}
Как видите, показана новая цена услуги Диагностика – 450 руб.
Таким образом, на примере этого отчета вы научились получать последние значения из периодического регистра сведений и выводить в отчет группировки по иерархии справочника.


### Использование вычисляемого поля в отчете
Следующий отчет – Рейтинг клиентов – будет показывать в графическом виде, каков доход от оказания услуг каждому из клиентов за все время работы ООО «На все руки мастер» (рис. 14.85).

Рис. 14.85. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_85.png}
На его примере вы узнаете, как можно использовать вычисляемое поле в отчете и выводить результат в виде круговой диаграммы и в виде гистограммы.
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем РейтингКлиентов.
Создайте основную схему компоновки данных отчета.
Добавьте в схему набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите виртуальную таблицу регистра накопления Продажи.Обороты. Затем выберите из нее следующие поля (рис. 14.86):
ПродажиОбороты.Клиент,
ПродажиОбороты.ВыручкаОборот,
ПродажиОбороты.СтоимостьОборот.

Рис. 14.86. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/14_86.png}
На закладке Объединения/Псевдонимы укажите, что поле ВыручкаОборот будет иметь псевдоним Выручка, а поле СтоимостьОборот – Стоимость. На этом создание запроса завершено, нажмите OK.

##### Вычисляемые поля
На этом этапе вам необходимо отразить в отчете поле, которого нет в наборе данных. Раньше вы использовали в отчете те поля, которые описывались в наборе данных. Теперь, чтобы отобразить доход от оказания услуг в разрезе клиентов, вам необходимо дополнительное поле, рассчитанное как разница между выручкой и стоимостью оказания услуг.
Для этого в системе компоновки данных есть возможность определения вычисляемого поля.
Вычисляемые поля представляют собой дополнительные поля схемы компоновки данных, значения которых будут вычисляться по некоторой формуле.
Перейдите на закладку Вычисляемые поля схемы компоновки данных, нажмите Добавить и добавьте вычисляемое поле.
Задайте ему имя (Путь к данным) – Доход, а в колонку Выражение введите выражение для расчета вычисляемого поля (листинг 14.8).
Листинг 14.8. Выражение для расчета вычисляемого поля «Доход»
Выручка - Стоимость
Заголовок вычисляемого поля, который будет отображаться в шапке отчета, задается по умолчанию, но можно его изменить (рис. 14.87).

Рис. 14.87. Создание вычисляемого поля {https://ai2b.pro/wp-content/uploads/1/14_87.png}
Вычисляемое поле можно добавить в ресурсы отчета, чтобы вычислять по нему групповые и общие итоги.

##### Ресурсы
На закладке Ресурсы нажмите  и выберите все доступные ресурсы отчета. Вычисляемое поле Доход также добавьте в список ресурсов (рис. 14.88).

Рис. 14.88. Ресурсы схемы компоновки данных {https://ai2b.pro/wp-content/uploads/1/14_88.png}

##### Настройки
Добавьте в структуру отчета диаграмму. В ветку Точки добавьте группировку по полю Клиент. Серии диаграммы оставьте без изменений.
Для демонстрации рейтинга клиентов хорошо подходит круговая диаграмма. Для этого вида диаграммы достаточно задать только точки, поэтому серии задавать не нужно.
На закладке Выбранные поля добавьте поле Доход для вывода в отчет.
Структура отчета должна принять следующий вид (рис. 14.89).

Рис. 14.89. Структура отчета и выбранные поля {https://ai2b.pro/wp-content/uploads/1/14_89.png}
На закладке Другие настройки выберите тип диаграммы – Круговая объемная и включите эту настройку в быстрые пользовательские настройки (рис. 14.90). Также задайте заголовок отчета – Рейтинг клиентов.

Рис. 14.90. Настройка типа диаграммы {https://ai2b.pro/wp-content/uploads/1/14_90.png}
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистемы Оказание услуг и Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки и сформируйте отчет Рейтинг клиентов.
Вы видите данные о доходе от оказания услуг по каждому из клиентов, представленные в виде круговой диаграммы (рис. 14.91).

Рис. 14.91. Круговая объемная диаграмма {https://ai2b.pro/wp-content/uploads/1/14_91.png}
Воспользуйтесь настройкой типа диаграммы, расположенной в форме отчета, и измените тип диаграммы на Гистограмма объемная. Заново сформируйте отчет (рис. 14.92).

Рис. 14.92. Гистограмма объемная {https://ai2b.pro/wp-content/uploads/1/14_92.png}
Таким образом, вы узнали, как можно использовать различные виды диаграмм для визуализации данных отчета.
### Вывод данных в таблицу
На примере создания универсального отчета вы научитесь выводить данные в таблицу (рис. 14.93).

Рис. 14.93. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_93.png}
Вы узнаете, как сделать отчет максимально универсальным, чтобы позволить пользователю в прикладном решении, не обращаясь к полным настройкам отчета (не выполняя Еще > Изменить вариант…), изменять его структуру и внешний вид. Например, поменять местами строки и колонки таблицы или изменить данные, выводящиеся в ячейках таблицы.
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем Универсальный.
Создайте основную схему компоновки данных отчета.
Добавьте в схему набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите виртуальную таблицу регистра накопления Продажи.Обороты. Затем выберите из нее все поля (рис. 14.94).

Рис. 14.94. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/14_94.png}
###### Текст запроса
Нажмите OK. Текст запроса, сформированный конструктором, примет следующий вид (листинг 14.9).
Листинг 14.9. Текст запроса
ВЫБРАТЬ
ПродажиОбороты.Номенклатура,
ПродажиОбороты.Клиент,
ПродажиОбороты.Мастер,
ПродажиОбороты.КоличествоОборот,
ПродажиОбороты.ВыручкаОборот,
ПродажиОбороты.СтоимостьОборот
ИЗ
РегистрНакопления.Продажи.Обороты КАК ПродажиОбороты

##### Ресурсы
На закладке Ресурсы нажмите  выберите все доступные ресурсы отчета.

##### Настройки
Добавьте в структуру отчета таблицу.
Вам не нужно задавать здесь строки и колонки этой таблицы, а также список выбранных полей, так как вы хотите предоставить полную свободу пользователю в этих действиях. Для этого выделите в структуре элементов отчета элемент Таблица и нажмите  (Свойства элемента пользовательских настроек) в командной панели окна настроек.
В появившемся окне вы можете редактировать состав пользовательских настроек таблицы.
Установите признак использования для настроек Выбранные поля, Группировка строк и Группировка колонок и оставьте для них по умолчанию свойство Режим редактирования в значении Быстрый доступ (рис. 14.95).

Рис. 14.95. Состав пользовательских настроек {https://ai2b.pro/wp-content/uploads/1/14_95.png}
Таким образом, вы предоставили пользователю возможность самостоятельно определять состав выбранных полей, группировок строк и колонок таблицы непосредственно в отчетной форме перед формированием отчета.
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистему Оказание услуг.

#### В прикладном решении
Запустите проект в режиме отладки и откройте отчет Универсальный.
Если вы сейчас нажмете Сформировать, то ничего не увидите в результате, так как список выбранных полей, группировок строк и колонок таблицы пуст. Заполните эти быстрые пользовательские настройки.
Нажмите кнопку выбора в строке Выбранные поля и выберите из доступных полей поле ВыручкаОборот.
Добавьте в Строки таблицы группировку по полю Номенклатура с типом Иерархия.
В Колонки таблицы добавьте группировку по полю Мастер.
Нажмите Сформировать.
Отчет примет следующий вид (рис. 14.96).

Рис. 14.96. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_96.png}
Заметьте, что при прокручивании отчета вниз и вправо положение шапки отчета и самой левой колонки таблицы остается зафиксированным. Для удобства пользователя платформа автоматически фиксирует сверху и слева табличный документ, в который выводится результат отчета. Можно также вручную управлять фиксацией строк и столбцов отчета с помощью параметров вывода ФиксацияСлева и ФиксацияСверху.
Теперь добавьте в список выбранных полей поле СтоимостьОборот.
В строки таблицы вместо группировки по полю Номенклатура поместите группировку по полю Клиент.
В результате отчет примет следующий вид (рис. 14.97).

Рис. 14.97. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_97.png}
Теперь исключите из списка выбранных полей поле СтоимостьОборот.
В строках таблицы замените прежнюю группировку на группировку по полю Номенклатура с типом ТолькоИерархия.
В колонки таблицы добавьте группировку по полю Клиент и поместите ее первой в списке группировок.
В результате отчет примет следующий вид (рис. 14.98).

Рис. 14.98. Результат отчета {https://ai2b.pro/wp-content/uploads/1/14_98.png}
Таким образом, в этом универсальном отчете вы предоставили пользователю альтернативную возможность самостоятельно формировать отчет по регистру Продажи.


## Занятие 15 (2:40). Оптимизация проведения документа «Оказание услуги»
Продолжительность
Ориентировочная продолжительность занятия – 2 часа 40 минут.
После изучения занятия № 11 «Знакомство с языком запросов» вы уже достаточно хорошо знакомы с языком запросов и наконец-то можете приступить к одному из самых важных занятий этой книги – к оптимизации документа ОказаниеУслуги и, в частности, к полному изменению его обработчика события ОбработкаПроведения.
«Зачем это нужно?» – можете спросить вы. Тому есть две причины.
Во-первых, руководство ООО «На все руки мастер» решило наконец-то завершить «эксперименты» по ручному вводу стоимости расходуемых материалов и перейти на автоматический расчет стоимости расходуемых материалов «по среднему».
Во-вторых, при проведении документа ОказаниеУслуги необходимо контролировать остатки расходуемых товаров на складе. Если товаров не хватает, то выдавать предупреждение и не проводить документ.
Поэтому изменения, вносимые вами в документ ОказаниеУслуги, будут преследовать две цели:
автоматическое определение стоимости расходуемых материалов при проведении документа;
разделение алгоритма проведения документа на оперативный и неоперативный режимы и контроль остатков в случае оперативного проведения документа.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Теория
#### Оперативное и неоперативное проведение документов
Теперь пришло время узнать о некоторых особенностях, связанных с тем, что в обработке проведения вы будете контролировать наличие достаточного количества материалов на складе при проведении документа.
Делать это вы будете не всегда. А только в том случае, когда документ проводится оперативно. Если документ проводится неоперативно, то вы это делать не будете. Так для чего же предназначено оперативное и неоперативное проведение документа? Как устроен в системе механизм оперативного проведения документов?
При разработке конфигураций на платформе «1С:Предприятие» используется концепция оперативного и неоперативного проведения документов. Эта концепция используется при решении задач оперативного учета (например, при складском учете товаров) и позволяет организовать корректную работу с документами в условиях реальной действительности. Однако можно отключить этот механизм (запретить оперативное проведение документов) и реализовывать собственные алгоритмы, проверять актуальность документов на оси событий и т. д.
Эта концепция подразумевает, что работа пользователей может происходить в двух принципиально разных по своей сути режимах.
Оперативное проведение документов пользователями выполняется в режиме реального времени, то есть отображает изменения, факты, совершающиеся в настоящее время. Оперативное проведение особенно актуально при многопользовательской работе. Поэтому при этом способе проведения документов следует осуществлять максимум проверок, способных исключить ошибки при вводе данных пользователями.
Например, при оперативном проведении следует выполнять контроль остатков на складе списываемой номенклатуры, с тем чтобы исключить одновременную продажу одного товара несколькими продавцами.
При оперативном проведении документа система прежде всего проверит положение даты документа относительно текущей даты сеанса. Текущая дата сеанса равна системной дате компьютера, приведенной к часовому поясу сеанса. Если дата проводимого документа совпадает с текущей датой сеанса, то система будет проводить такой документ в оперативном режиме, и в обработке проведения об этом можно узнать, чтобы выстроить определенный алгоритм проведения документа.
Если дата проводимого документа меньше текущей даты сеанса, то такой документ система будет проводить в неоперативном режиме.
Неоперативное проведение документов подразумевает отражение в базе данных фактов, которые свершились в прошлом или которые точно будут совершены в будущем. Поэтому задача неоперативного проведения документов – просто отразить в информационной базе данные о совершенных операциях.
При неоперативном проведении документов не имеет смысла производить целый ряд проверок, в частности контроль остатков. Подразумевается, что если в процессе неоперативного проведения документов были допущены ошибки (например, списано такое количество номенклатуры, которого не было на складе на дату проведения документа), то анализ полученного состояния базы данных является отдельной задачей, не относящейся к неоперативному проведению и выполняющейся не в момент проведения документа, а тогда, когда в базе имеются достаточные данные для анализа (например, когда введены более ранние документы, приходующие товары).
Таким образом, оперативное проведение служит для того, чтобы в реальном режиме многопользовательской работы определить возможность или невозможность выполнения той или иной операции (и выполнить ее, если возможно). Неоперативное проведение предназначено для безусловного отражения в базе операций, которые уже были совершены (или точно будут совершены).
Зачастую возникает желание провести документ будущей датой, чтобы отразить какие-то события, которые точно наступят в будущем. В этом случае если документу разрешено использовать оперативное проведение, то система не даст провести такой документ будущей датой. Она просто сообщит, что не может оперативно провести такой документ, и не даст никаких вариантов выбора. Пользователю останется только поменять дату документа или на текущую дату (тогда документ будет проведен в оперативном режиме), или на прошедшую (тогда документ будет проведен в неоперативном режиме). Поэтому, если логика учета подразумевает, что какой-то документ должен проводиться будущей датой, для такого документа механизм оперативного проведения должен быть отключен в метаданных (в свойстве Оперативное проведение объекта конфигурации).
#### Понятие момента времени
С оперативным проведением документов связаны понятия оперативной отметки времени и момента времени.
Для определения положения документа на оси времени используется реквизит документа Дата. Дата содержит время с точностью до секунды. Это позволяет контролировать последовательность записи документов. Однако при большом объеме создаваемых документов вероятна ситуация, когда несколько документов будут иметь одинаковое значение даты (т. е. будут созданы в течение одной секунды). Как в этом случае определить последовательность созданных документов?
Для обработки подобных ситуаций было введено понятие момента времени. Момент времени представляет собой совокупность даты, времени и ссылки на объект базы данных. Он позволяет однозначно идентифицировать любой объект ссылочного типа базы данных на оси событий, но имеет смысл в основном только для документов. Кроме того, момент времени позволяет идентифицировать и необъектные данные – например, записи регистров, подчиненных регистратору.
Понятие момента времени реализовано во встроенном языке при помощи универсального объекта МоментВремени. Этот объект имеет свойства Дата и Ссылка, которые позволяют получить «составляющие» момента времени, и один метод – Сравнить(), при помощи которого возможно сравнение двух моментов времени между собой. Кроме того, объект МоментВремени имеет конструктор и может быть создан в явном виде для любого объекта базы данных ссылочного типа.
Для нескольких документов, имеющих одинаковую дату и время, последовательность их на оси событий определяется системой исходя из ссылок на эти документы. Она может не совпадать с последовательностью создания документов, и она недоступна для изменения пользователем, то есть нельзя каким-либо образом повлиять на последовательность документов внутри одной секунды или вычислить, что один документ создан раньше, а другой – позже.
Оперативная отметка времени создается системой каждый раз при оперативном проведении документа. Ее значение формируется исходя из текущей даты сеанса и последней созданной оперативной отметки.
Если последняя оперативная отметка меньше текущей даты сеанса, в качестве новой оперативной отметки принимается текущая дата сеанса.
Если последняя оперативная отметка больше текущей даты сеанса или равна ей, в качестве новой оперативной отметки принимается значение на одну секунду большее, чем старая оперативная отметка времени.
Таким образом, если у объекта конфигурации Документ установлено свойство оперативного проведения (рис. 15.1), последовательность действий системы будет следующей:
При создании нового документа система будет устанавливать ему текущую дату сеанса и «нулевое» время.
При проведении такого документа (с датой, день которой соответствует дню текущей даты сеанса) система установит в качестве даты документа оперативную отметку времени.
Если отменить проведение документа и затем провести его снова (не изменяя даты), система установит документу новую оперативную отметку времени.
Если попытаться перепровести документ, то система также автоматически установит документу новую оперативную отметку времени и проведет его.
При попытке проведения (или перепроведения) оперативно проводимого документа с датой, день которой меньше дня текущей даты сеанса, документ будет проведен неоперативно.
Если попытаться провести (или перепровести) оперативно проводимый документ с датой, день которой больше дня текущей даты сеанса, то система не даст выполнить такое действие.

Рис. 15.1. Разрешение оперативного проведения документа {https://ai2b.pro/wp-content/uploads/1/15_01.png}

### Автоматический расчет стоимости
До сих пор стоимость расходуемых материалов вносилась вручную в документ Оказание услуги при его создании.
Теперь же стоимость номенклатуры будет определяться по среднему: для каждой номенклатуры нужно разделить ее общую, суммарную стоимость на то количество этой номенклатуры, которое имеется на складах ООО «На все руки мастер», и таким образом получить среднюю стоимость одной единицы этой номенклатуры.
Чтобы выполнить такой расчет, вам понадобятся дополнительные данные, которых у вас сейчас нет.
Для каждой номенклатуры из табличной части вам понадобятся:
ее стоимость, хранящаяся в регистре СтоимостьМатериалов;
общее ее количество на всех складах, хранящееся в регистре ОстаткиМатериалов.
Поэтому вам нужно будет доработать запрос в обработчике проведения документа таким образом, чтобы он получал из базы данных и эти данные тоже.
Таким образом, запрос должен возвращать следующие поля для каждой номенклатуры, которая есть в документе (рис. 15.2).

Рис. 15.2. Описание полей запроса {https://ai2b.pro/wp-content/uploads/1/15_02.png}
Первые четыре поля вы можете получить (и уже получаете) из табличной части самого документа, а вот последние два нужно будет получить из других таблиц базы данных:
стоимость – из регистра СтоимостьМатериалов;
остатки на всех складах – из регистра ОстаткиМатериалов (рис. 15.3).

Рис. 15.3. Описание полей и таблиц запроса {https://ai2b.pro/wp-content/uploads/1/15_03.png}
Это значит, что ваш запрос должен содержать два левых соединения таблицы документа с другими таблицами: одно – с таблицей РегистрНакопления.СтоимостьМатериалов.Остатки, другое – с таблицей РегистрНакопления.ОстаткиМатериалов.Остатки.
Казалось бы, все готово для того, чтобы составить запрос.
Но обратите внимание на важную деталь: в предложенной схеме виртуальные таблицы будут возвращать стоимость и остатки номенклатуры абсолютно для всей номенклатуры. А вас интересует только та номенклатура, которая указана в вашем документе.
На маленькой базе эта особенность может почти не проявляться: количество различных элементов номенклатуры в справочнике сравнимо с количеством различных элементов номенклатуры в документе.
Но представьте реальную базу. В справочнике Номенклатура – 15 000 наименований, например. А в документе – всего 5 наименований. Получится, что сначала виртуальная таблица остатков будет усиленно трудиться и рассчитывать вам стоимость (или остатки) по всем 15 000 наименованиям номенклатуры, а в результате, когда вы левым соединением станете соединять ее с таблицей документа, вы из этих 15 000 строк стоимости (или остатков) возьмете всего лишь 5 строк – для той номенклатуры, которая указана в документе. Остальные 14 995 строк будут просто отброшены – система напрасно их рассчитывала.
Естественно, такая расточительность непозволительна в реальных условиях, и такой запрос является очень неоптимальным. Поэтому во все виртуальные таблицы, которые вы будете использовать, нужно добавить условие отбора только той номенклатуры, которая содержится в табличной части вашего документа. В этом случае стоимость и остатки будут рассчитаны не для всей номенклатуры вообще, а только для нужной вам номенклатуры.
В результате схема вашего запроса будет выглядеть следующим образом (рис. 15.4).

Рис. 15.4. Схема запроса {https://ai2b.pro/wp-content/uploads/1/15_04.png}
Обратите внимание, что в обеих виртуальных таблицах используется список номенклатуры из табличной части документа (по нему ограничиваются рассчитываемые данные).
Кроме того, из таблиц документа тоже берутся не все данные, а только данные, относящиеся к одному вашему конкретному документу. Чтобы не получать этот список три раза (для документа и каждой виртуальной таблицы заново), вы можете сформировать его заранее и затем уже использовать в нужных вам условиях запроса.
Выполнить эту задачу вам помогут временные таблицы.
Таким образом, схема вашего запроса приобретает следующий вид (рис. 15.5).

Рис. 15.5. Схема запроса {https://ai2b.pro/wp-content/uploads/1/15_05.png}
#### В 1C:EDT
Первое, что вам нужно сделать, – удалить реквизит табличной части Стоимость документа ОказаниеУслуги, который вам больше не понадобится.
Для этого в панели Навигатор нажмите Удалить в контекстном меню реквизита Стоимость (рис. 15.6).

Рис. 15.6. Удаление реквизита табличной части {https://ai2b.pro/wp-content/uploads/1/15_06.png}
Также следует удалить соответствующее поле из таблицы ПереченьНоменклатуры, расположенной в форме.
Для этого в форме документа ОказаниеУслуги нажмите Удалить в контекстном меню соответствующего элемента формы (рис. 15.7).

Рис. 15.7. Удаление поля табличной части {https://ai2b.pro/wp-content/uploads/1/15_07.png}
Теперь настало время заняться запросом.
На занятии № 12 в разделе «Регистрация расхода только той номенклатуры, которая является материалом» вы изменили процедуру проведения документа ОказаниеУслуги так, чтобы движения в регистрах накопления формировались с помощью запроса к данным документа. И затем вы добавили в процедуру обработки проведения документа формирование движений по регистру СтоимостьМатериалов и регистру Продажи.
Откройте модуль объекта документа ОказаниеУслуги. Процедура ОбработкаПроведения(), находящаяся в этом модуле, сейчас выглядит следующим образом (листинг 15.1).
Листинг 15.1. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ,Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
Движения.Продажи.Записывать = Истина;
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Сумма) КАК СуммаВДокументе
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.Период = Дата;
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
// Регистр СтоимостьМатериалов – Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
 
КонецЕсли;
 
// Регистр Продажи
Движение = Движения.Продажи.Добавить();
Движение.Период = Дата;
Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Клиент = Клиент;
Движение.Мастер = Мастер;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.Выручка = ВыборкаДетальныеЗаписи.СуммаВДокументе;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * ВыборкаДетальныеЗаписи.Стоимость;
 
КонецЦикла;
 
КонецПроцедуры
Временную таблицу вы можете получить с помощью того запроса к данным документа, который у вас уже написан.
Для этого перед созданием запроса создайте менеджер временных таблиц и укажите, что этот запрос будет использовать созданный менеджер временных таблиц (листинг 15.2).
Листинг 15.2. Использование менеджера временных таблиц
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
Движения.Продажи.Записывать = Истина;
 
// Создать менеджер временных таблиц.
МенеджерВТ = Новый МенеджерВременныхТаблиц;
 
Запрос = Новый Запрос;
 
// Указать, какой менеджер временных таблиц использует этот запрос.
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
 
Запрос.Текст =
"ВЫБРАТЬ
|   ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
Теперь измените запрос таким образом, чтобы он создавал временную таблицу, которая будет храниться в вашем менеджере временных таблиц МенеджерВТ.
Чтобы конструктор запроса смог открыть ваш запрос, удалите из него строку (поля Стоимость у вас больше нет) – листинг 15.3.
Листинг 15.3. Изменение запроса
|	МАКСИМУМ(ОказаниеУслугиПереченьНоменклатуры.Стоимость) КАК Стоимость,
Откройте конструктор запроса для существующего текста запроса (рис. 15.8).

Рис. 15.8. Конструктор запроса {https://ai2b.pro/wp-content/uploads/1/15_08.png}
Чтобы результат запроса поместить во временную таблицу, перейдите на закладку Дополнительно и отметьте пункт Создание временной таблицы. Задайте имя временной таблицы – НоменклатураДокумента (рис. 15.9).

Рис. 15.9. Создание временной таблицы {https://ai2b.pro/wp-content/uploads/1/15_09.png}
Нажмите ОК. Конструктор запроса сформирует следующий текст запроса (листинг 15.4).
Листинг 15.4. Текст запроса
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Сумма) КАК СуммаВДокументе
|ПОМЕСТИТЬ НоменклатураДокумента
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
Новым здесь является только строка, выделенная в листинге 15.4 жирным шрифтом.
Она означает, что результат запроса будет сохранен во временной таблице НоменклатураДокумента.
Теперь если вы для другого запроса укажете этот же самый менеджер временных таблиц МенеджерВТ, то в этом другом запросе вы сможете обратиться к данным этой временной таблицы.
Таким образом, вы выполнили первую часть вашего плана – создали запрос, помещающий данные табличной части документа во временную таблицу (рис. 15.10).

Рис. 15.10. Создание первого запроса {https://ai2b.pro/wp-content/uploads/1/15_10.png}
Теперь вам нужно сконструировать второй запрос.
Установите курсор на следующую строку после оператора РезультатЗапроса = Запрос.Выполнить(); (именно здесь выполняется создание временной таблицы) и напишите заготовку будущего запроса (листинг 15.5).
Листинг 15.5. Создание второго запроса
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "";
Вы создали новый объект Запрос и назначили ему тот же самый менеджер временных таблиц, чтобы иметь возможность обращаться к созданной вами ранее временной таблице.
Теперь установите курсор внутрь кавычек и нажмите Конструктор запроса в контекстном меню. Согласитесь на создание нового запроса.
Поскольку вы собираетесь выбирать данные из вашей временной таблицы, создайте в запросе описание этой временной таблицы. Для этого над списком Таблицы нажмите  (Создать описание временной таблицы, рис. 15.11).
В открывшемся окне введите имя вашей временной таблицы НоменклатураДокумента и добавьте описание полей:
Номенклатура, тип СправочникСсылка.Номенклатура;
ВидНоменклатуры, тип ПеречислениеСсылка.ВидыНоменклатуры;
КоличествоВДокументе, тип Число, 15, 3;
СуммаВДокументе, тип Число, 15, 2.
В результате у вас получится следующее описание временной таблицы (рис. 15.11).

Рис. 15.11. Создание описания временной таблицы {https://ai2b.pro/wp-content/uploads/1/15_11.png}
Нажмите ОК. Выберите из этой таблицы все поля (рис. 15.12).

Рис. 15.12. Выбранные поля временной таблицы {https://ai2b.pro/wp-content/uploads/1/15_12.png}
Нажмите Запрос в левом нижнем углу окна конструктора запроса. Текст запроса будет иметь следующий вид (листинг 15.6).
Листинг 15.6. Текст второго запроса
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура,
НоменклатураДокумента.ВидНоменклатуры,
НоменклатураДокумента.КоличествоВДокументе,
НоменклатураДокумента.СуммаВДокументе
ИЗ
НоменклатураДокумента КАК НоменклатураДокумента
Итак, вы создали первую часть второго запроса – выбрали информацию из временной таблицы (рис. 15.13).

Рис. 15.13. Создание второго запроса {https://ai2b.pro/wp-content/uploads/1/15_13.png}
Теперь вы будете соединять эту конструкцию левыми соединениями с таблицами остатков.
Начните со стоимости материалов.
Добавьте в список таблиц запроса виртуальную таблицу РегистрНакопления.СтоимостьМатериалов.Остатки. Из нее выберите поле СтоимостьОстаток.
Теперь перейдите на закладку Связи и задайте связь между таблицами. Вам нужно сделать так, чтобы временная таблица была связана левым соединением с таблицей остатков. При этом из временной таблицы будут получены в любом случае все записи, а из таблицы остатков только записи, удовлетворяющие условию связи таблиц, при котором поле Номенклатура временной таблицы должно быть равно полю Материал таблицы остатков (листинг 15.7).
Листинг 15.7. Условие связи таблиц
НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал
Выделите правую (вторую) таблицу соединения – виртуальную таблицу СтоимостьМатериаловОстатки и перетащите ее мышью на левую (первую) временную таблицу НоменклатураДокумента. При этом автоматически будет создана связь таблиц с типом соединения Левое. Ниже задайте условие связи (рис. 15.14).

Рис. 15.14. Связи между таблицами {https://ai2b.pro/wp-content/uploads/1/15_14.png}
Нужно не забыть ограничить виртуальную таблицу только той номенклатурой, которая есть в вашей временной таблице. То есть материал должен быть среди номенклатуры, выбранной из временной таблицы.
Поэтому на закладке Таблицы и поля вызовите диалог параметров виртуальной таблицы СтоимостьМатериаловОстатки и задайте параметр Условие следующим образом (листинг 15.8).
Листинг 15.8. Условие виртуальной таблицы
Материал В (ВЫБРАТЬ НоменклатураДокумента.Номенклатура ИЗ НоменклатураДокумента)
Кроме того, вам нужно сделать так, чтобы при перепроведении прошлых документов (в неоперативном режиме) стоимость материалов рассчитывалась такой, какой она была на дату документа.
Для этого нужно передать в параметр Период виртуальной таблицы момент времени, на который будет посчитана стоимость материалов. Этот момент будет задан в параметре запроса &Период (рис. 15.15).

Рис. 15.15. Параметры виртуальной таблицы {https://ai2b.pro/wp-content/uploads/1/15_15.png}
Узнай больше!
Следует внимательно подходить к использованию виртуальных таблиц запросов. В частности, необходимо уделять особое внимание максимально возможному использованию параметров этих таблиц.
Например, вашем случае можно было бы и не использовать параметр Условие, а ограничить выбранные поля уже в самом запросе, указав в условии ПО равенство номенклатуры из документа и материала из таблицы остатков. Формально вы получили бы тот же самый результат, однако по производительности этот способ сильно отличался бы от того, который вы используете.
В самом деле, в вашем варианте виртуальная таблица предоставит вам ровно столько записей, сколько различных элементов номенклатуры содержится в проводимом документе. Если же не указывать условие, виртуальная таблица предоставит вам записи по абсолютно всем элементам номенклатуры, информация о которых есть в регистре накопления. И уже в самом запросе вы будете отбирать из этой огромной массы записей лишь несколько, которые вам действительно нужны.
Очевидно, что второй вариант будет работать дольше и время выполнения такого запроса будет зависеть в основном не от количества данных, содержащихся в документе (т. е. реального количества обрабатываемой информации), а от размера регистра накопления.
Кроме того что подобный вариант снижает производительность конфигурации, могут возникать ситуации, когда результаты, полученные одним и другим способом, будут различны. Такое, например, вполне возможно при использовании виртуальной таблицы регистра сведений СрезПоследних. Подробнее можно прочитать об этом на портале ИТС (информационно-технологического сопровождения) в статье «Использование отборов в запросах с виртуальными таблицами» – https://its.1c.ru/db/metod8dev/content/2594/hdoc.
Нажмите Запрос и посмотрите, какой текст запроса сформировал конструктор (листинг 15.9).
Листинг 15.9. Текст запроса
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура,
НоменклатураДокумента.ВидНоменклатуры,
НоменклатураДокумента.КоличествоВДокументе,
НоменклатураДокумента.СуммаВДокументе,
СтоимостьМатериаловОстатки.СтоимостьОстаток
ИЗ
НоменклатураДокумента КАК НоменклатураДокумента
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьМатериалов.Остатки(&Период, Материал В
(ВЫБРАТЬ
НоменклатураДокумента.Номенклатура
ИЗ
НоменклатураДокумента)) КАК СтоимостьМатериаловОстатки
ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал
Тем самым вы добавили к выбранным ранее полям стоимость номенклатуры (рис. 15.16).

Рис. 15.16. Создание второго запроса {https://ai2b.pro/wp-content/uploads/1/15_16.png}
Теперь добавьте виртуальную таблицу остатков регистра ОстаткиМатериалов.Остатки, из которой выберите поле КоличествоОстаток.
Задайте связь между таблицами так, чтобы временная таблица НоменклатураДокумента была связана левым соединением с таблицей остатков ОстаткиМатериаловОстатки.
Задайте условие связи, при котором поле Номенклатура временной таблицы должно быть равно полю Материал таблицы остатков (листинг 15.10).
В результате закладка Связи в конструкторе запроса должна иметь следующий вид (рис. 15.17).

Рис. 15.17. Связи между таблицами {https://ai2b.pro/wp-content/uploads/1/15_17.png}
Листинг 15.10. Условие связи таблиц
НоменклатураДокумента.Номенклатура = ОстаткиМатериаловОстатки.Материал
Затем вызовите диалог параметров виртуальной таблицы ОстаткиМатериаловОстатки и укажите, что период для расчета остатков будет передан в параметре запроса &Период, а также задайте параметр Условие следующим образом (рис. 15.15, листинг 15.11).
Листинг 15.11. Условие виртуальной таблицы
Материал В (ВЫБРАТЬ НоменклатураДокумента.Номенклатура ИЗ НоменклатураДокумента)
В результате текст запроса примет следующий вид (листинг 15.12).
Листинг 15.12. Текст запроса
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура,
НоменклатураДокумента.ВидНоменклатуры,
НоменклатураДокумента.КоличествоВДокументе,
НоменклатураДокумента.СуммаВДокументе,
СтоимостьМатериаловОстатки.СтоимостьОстаток,
ОстаткиМатериаловОстатки.КоличествоОстаток
ИЗ
НоменклатураДокумента КАК НоменклатураДокумента
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьМатериалов.Остатки(&Период, Материал В (
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура
ИЗ
НоменклатураДокумента)) КАК СтоимостьМатериаловОстатки
ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиМатериалов.Остатки(&Период, Материал В (
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура
ИЗ
НоменклатураДокумента)) КАК ОстаткиМатериаловОстатки
ПО НоменклатураДокумента.Номенклатура = ОстаткиМатериаловОстатки.Материал
Тем самым вы добавили к выбранным ранее полям остатки номенклатуры на всех складах (рис. 15.18).

Рис. 15.18. Создание второго запроса {https://ai2b.pro/wp-content/uploads/1/15_18.png}
В заключение на закладке Объединения/Псевдонимы задайте следующие псевдонимы полей (рис. 15.19):
СтоимостьОстаток – Стоимость;
КоличествоОстаток – Количество.

Рис. 15.19. Псевдонимы полей {https://ai2b.pro/wp-content/uploads/1/15_19.png}
В результате текст запроса примет следующий вид (листинг 15.13).
Листинг 15.13. Текст запроса
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура,
НоменклатураДокумента.ВидНоменклатуры,
НоменклатураДокумента.КоличествоВДокументе,
НоменклатураДокумента.СуммаВДокументе,
СтоимостьМатериаловОстатки.СтоимостьОстаток КАК Стоимость,
ОстаткиМатериаловОстатки.КоличествоОстаток КАК Количество
ИЗ
НоменклатураДокумента КАК НоменклатураДокумента
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьМатериалов.Остатки(&Период, Материал В (
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура
ИЗ
НоменклатураДокумента)) КАК СтоимостьМатериаловОстатки
ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал
ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиМатериалов.Остатки(&Период, Материал В (
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура
ИЗ
НоменклатураДокумента)) КАК ОстаткиМатериаловОстатки
ПО НоменклатураДокумента.Номенклатура = ОстаткиМатериаловОстатки.Материал
В качестве последнего штриха вашей работы с запросом нужно предусмотреть тот случай, когда номенклатура в справочнике есть, но у нее нет ни остатков, ни стоимости. Это может быть, например, в том случае, когда номенклатуру создали в справочнике, но она еще не поступала в вашу фирму.
В такой ситуации левые соединения с виртуальными таблицами не вернут ничего. На языке запросов это значит, что в полях Стоимость и Количество будут значения NULL.
Чтобы в дальнейшем вам было удобно работать с результатом вашего запроса, сразу же в самом запросе избавьтесь от этих значений.
Для этого примените функцию ЕСТЬNULL() к полям Стоимость и Количество. Если значение этого поля будет NULL, функция вернет 0. В остальных случаях функция вернет само значение этого поля.
Перейдите на закладку Таблицы и поля и нажмите Изменить в контекстном меню поля СтоимостьМатериаловОстатки.СтоимостьОстаток. Отредактируйте значение поля следующим образом (листинг 15.14, рис. 15.20).

Рис. 15.20. Изменение значения поля в запросе {https://ai2b.pro/wp-content/uploads/1/15_20.png}
Листинг 15.14. Выражение для расчета поля в запросе
ЕСТЬNULL(СтоимостьМатериаловОстатки.СтоимостьОстаток, 0)
Аналогично поступите и с другим полем – ОстаткиМатериаловОстатки.КоличествоОстаток.
Нажмите ОК – текст запроса будет вставлен в модуль (листинг 15.15).
Листинг 15.15. Текст запроса
Запрос2.Текст = "ВЫБРАТЬ
|	НоменклатураДокумента.Номенклатура,
|	НоменклатураДокумента.ВидНоменклатуры,
|	НоменклатураДокумента.КоличествоВДокументе,
|	НоменклатураДокумента.СуммаВДокументе,
|    ЕСТЬNULL(СтоимостьМатериаловОстатки.СтоимостьОстаток, 0) КАК Стоимость,
|    ЕСТЬNULL(ОстаткиМатериаловОстатки.КоличествоОстаток, 0) КАК Количество
|ИЗ
|	НоменклатураДокумента КАК НоменклатураДокумента
|     	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьМатериалов.Остатки(&Период, Материал В (
|          	ВЫБРАТЬ
|                	НоменклатураДокумента.Номенклатура
|          	ИЗ
|                	НоменклатураДокумента)) КАК СтоимостьМатериаловОстатки
|     	ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал
|     	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиМатериалов.Остатки(&Период, Материал В (
|          	ВЫБРАТЬ
|                	НоменклатураДокумента.Номенклатура
|     	 	ИЗ
|                	НоменклатураДокумента)) КАК ОстаткиМатериаловОстатки
|     	ПО НоменклатураДокумента.Номенклатура = ОстаткиМатериаловОстатки.Материал";
Вам остается всего лишь дописать после него оператор установки параметра и оператор выполнения запроса (листинг 15.16).
Листинг 15.16. Фрагмент процедуры «ОбработкаПроведения()»
…
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|	НоменклатураДокумента.Номенклатура,
…
|     	ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал";
 
Запрос2.УстановитьПараметр("Период", МоментВремени());
 
РезультатЗапроса = Запрос2.Выполнить();   
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
…
В первой добавленной строке вы устанавливаете параметр запроса &Период как момент времени документа. Это значит, что остатки из виртуальных таблиц, использующиеся при расчете стоимости материалов, будут получены на момент времени документа, без учета движений самого документа. Как вам и нужно.
Теперь вам нужно немного изменить запись движений.
Все операторы, которые были написаны вами ранее, будут работать без изменений.
Единственное, что потребуется изменить, – это способ получения стоимости. Раньше вы просто брали ее из документа, теперь же вам нужно ее рассчитать на основании тех данных, которые вы получили запросом.
Стоимость материала равна частному от деления всей стоимости, полученной запросом (Стоимость), на общее количество материала на всех складах (Количество).
Но, как уже говорилось, возможна ситуация, когда поле Количество у вас будет равно 0, а на 0 делить нельзя. Поэтому сразу после начала цикла обхода результата запроса рассчитайте стоимость для текущей номенклатуры следующим образом (листинг 15.17).
Листинг 15.17. Фрагмент процедуры «ОбработкаПроведения()»
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.Количество = 0 Тогда
СтоимостьМатериала = 0;
 
Иначе
СтоимостьМатериала = ВыборкаДетальныеЗаписи.Стоимость / ВыборкаДетальныеЗаписи.Количество;
 
КонецЕсли;
 
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
…
Теперь замените расчет стоимости в движениях регистров СтоимостьМатериалов и Продажи (листинг 15.18).
Листинг 15.18. Фрагмент процедуры «ОбработкаПроведения()»
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.Количество = 0 Тогда
СтоимостьМатериала = 0;
 
Иначе
СтоимостьМатериала = ВыборкаДетальныеЗаписи.Стоимость / ВыборкаДетальныеЗаписи.Количество;
 
КонецЕсли;
 
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// Регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.Количество;
 
// Регистр СтоимостьМатериалов – Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * СтоимостьМатериала;
 
КонецЕсли;
 
// Регистр Продажи
Движение = Движения.Продажи.Добавить();
Движение.Период = Дата;
Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Клиент = Клиент;
Движение.Мастер = Мастер;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.Выручка = ВыборкаДетальныеЗаписи.СуммаВДокументе;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * СтоимостьМатериала;
 
КонецЦикла;

#### В прикладном решении
Теперь нужно запустить проект в режиме отладки, перепровести все документы Оказание услуги и проверить, что данные правильно заносятся в регистры.

### Контроль остатков
Общая методика контроля остатков при проведении документа заключается в следующем: сначала, не глядя ни на что, нужно записать движения документа, а затем, когда движения уже записаны, прочитать из базы данных остатки.
Если появились отрицательные остатки, значит, такой документ проводить нельзя. Нужно сообщить пользователю, каких материалов не хватает, и отменить проведение документа.
Если же отрицательных остатков не появилось, тогда можно смело проводить документ.
Полдела у вас уже сделано: вы формируете движения документа и записываете их. Единственное, что вам осталось, – в случае оперативного проведения проконтролировать, что получилось, и, если появились отрицательные остатки, отменить проведение документа.
Итак, сделайте заготовку. После цикла обхода результата запроса и перед концом процедуры напишите следующие строки (листинг 15.19).
Листинг 15.19. Фрагмент процедуры «ОбработкаПроведения()»
…
КонецЦикла;
 
Движения.Записать();
 
Если Режим = РежимПроведенияДокумента.Оперативный Тогда
 
// Проверить отрицательные остатки.
 
КонецЕсли;
 
КонецПроцедуры
Сначала вы записываете движения в регистры.
Затем определяете режим проведения документа. При выполнении процедуры ОбработкаПроведения() вторым параметром (Режим) в нее передается режим проведения документа, и значение этой переменной сравнивается со значением системного перечисления РежимПроведенияДокумента. В случае оперативного проведения вы будете выполнять контроль остатков.
Теперь сделайте заготовку запроса для проверки отрицательных остатков.
Так как вам придется снова получать остатки только для той номенклатуры, которая в документе, укажите, что этот запрос будет использовать тот же самый менеджер временных таблиц МенеджерВТ (листинг 15.20).
Листинг 15.20. Фрагмент процедуры «ОбработкаПроведения()»
Если Режим = РежимПроведенияДокумента.Оперативный Тогда
 
// Проверить отрицательные остатки.
Запрос3 = Новый Запрос;
Запрос3.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос3.Текст = "";
 
КонецЕсли;
Установите курсор внутрь кавычек и откройте конструктор запроса. Подтвердите создание нового запроса.
Выберите таблицу ОстаткиМатериалов.Остатки и из нее два поля: Материал и КоличествоОстаток.
Задайте параметр Условие для этой таблицы (листинг 15.21).
Листинг 15.21. Условие виртуальной таблицы
Материал В (
ВЫБРАТЬ
НоменклатураДокумента.Номенклатура
ИЗ
НоменклатураДокумента)
И Склад = &Склад
То есть вы получаете итоги только для той номенклатуры, которая содержится в вашей временной таблице, и только по складу, который указан в документе.
Затем на закладке Условия перенесите в список условий поле КоличествоОстаток и укажите, что вас интересуют только отрицательные остатки (листинг 15.22).
Листинг 15.22. Условие запроса
ОстаткиМатериаловОстатки.КоличествоОстаток < 0
Нажмите ОК. Текст запроса будет выглядеть следующим образом (листинг 15.23).
Листинг 15.23. Текст запроса
// Проверить отрицательные остатки.
Запрос3 = Новый Запрос;
Запрос3.МенеджерВременныхТаблиц = МенеджерВТ;
 
Запрос3.Текст = "
|ВЫБРАТЬ
|	ОстаткиМатериаловОстатки.Материал,
|	ОстаткиМатериаловОстатки.КоличествоОстаток
|ИЗ
|	РегистрНакопления.ОстаткиМатериалов.Остатки( , Материал В (
|     	ВЫБРАТЬ
|          	НоменклатураДокумента.Номенклатура
|     	ИЗ
|          	НоменклатураДокумента)
|     	И Склад = &Склад) КАК ОстаткиМатериаловОстатки
|ГДЕ
|	ОстаткиМатериаловОстатки.КоличествоОстаток < 0";
Теперь осталось только установить параметр запроса, обойти результат запроса и вывести сообщения об отрицательных остатках (листинг 15.24).
Листинг 15.24. Фрагмент процедуры «ОбработкаПроведения()»
// Проверить отрицательные остатки
Запрос3 = Новый Запрос;
Запрос3.МенеджерВременныхТаблиц = МенеджерВТ;
 
Запрос3.Текст = "
|ВЫБРАТЬ
|	ОстаткиМатериаловОстатки.Материал,
…
|ГДЕ
|	ОстаткиМатериаловОстатки.КоличествоОстаток < 0";
 
Запрос3.УстановитьПараметр("Склад", Склад);
 
РезультатЗапроса = Запрос3.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Сообщение = Новый СообщениеПользователю();
Сообщение.Текст = "Не хватает " + Строка(- ВыборкаДетальныеЗаписи.КоличествоОстаток) + " единиц материала """ + ВыборкаДетальныеЗаписи.Материал + """";
Сообщение.Сообщить();
 
Отказ = Истина;
 
КонецЦикла;
При выполнении проверки в запрос в параметре Склад передается склад, указанный в документе.
Затем выполняется запрос для получения отрицательных остатков номенклатуры, содержащейся во временной таблице и на складе, указанном в параметре Склад.
После этого выборка записей запроса обходится в цикле, и, если есть такие записи, они выводятся в сообщениях пользователю.
При этом параметру Отказ процедуры проведения документа присваивается значение Истина, то есть документ не проводится, начатая транзакция отменяется и состояние данных, измененных в процессе проведения, возвращается в исходное, до начала проведения документа.

### Блокировка данных, которые читаются и изменяются при проведении
Казалось бы, это все? Но нет, есть очень важный момент, о котором также нужно позаботиться.
Сейчас схема вашей процедуры такова:
Вы выполняете первый запрос с именем Запрос. В результате вы формируете временную таблицу из перечня номенклатуры документа.
Вы выполняете второй запрос с именем Запрос2. В результате вы читаете стоимость и остатки для номенклатуры, содержащейся в табличной части документа.
Вы записываете движения регистров (Движения.Записать()).
Вы выполняете третий запрос с именем Запрос3. Тем самым вы проверяете наличие отрицательных остатков.
Обратите внимание, что начиная с выполнения второго запроса и до конца процедуры вам необходимо обеспечить неизменность стоимости и остатков номенклатуры, с которой вы работаете, и запретить другим транзакциям даже читать эти данные. Сама система, естественно, заблокирует изменение этих данных, но лишь начиная с того момента, когда вы запишете движения.
Однако может возникнуть следующая ситуация. Выполняя второй запрос, вы прочитали, что есть 2 шт. некоторого материала. И другая транзакция (другой пользователь), которая собирается списывать материалы, тоже прочитала, что есть 2 шт. этого материала. После этого вы записали движения, и система заблокировала эти данные. Другая транзакция ждет, когда вы освободите данные. Вы провели документ, списали 2 шт. материала и освободили данные. Другая транзакция пытается тоже списать 2 шт. материала, но его уже нет!
Аналогичная ситуация может возникнуть и между п. 3 и п. 4, в результате чего контроль остатков будет работать неверно.
Поэтому, чтобы не происходило таких коллизий, вам необходимо заблокировать остатки от чтения другими транзакциями еще до выполнения второго запроса. То есть, прежде чем читать что-то, что вы собираетесь изменять, нужно запретить чтение этих данных другими транзакциями до тех пор, пока вы не закончите свои изменения (или пока не откажетесь от проведения документа).
Как это сделать? Хороший вопрос. Посмотрите на свойство Режим управления блокировкой данных вашей конфигурации. Оно установлено в значение Управляемый (рис. 15.21).

Рис. 15.21. Режим управления блокировкой данных в свойствах конфигурации {https://ai2b.pro/wp-content/uploads/1/15_21.png}
Это значит, что вам нужно использовать управляемые блокировки, которые устанавливаются средствами встроенного языка.
Необходимо заблокировать те данные, которые вы собираетесь читать и впоследствии изменять. Для этого у наборов записей регистров есть свойство БлокироватьДляИзменения, которым вам и нужно воспользоваться.
Вставьте этот код перед выполнением второго запроса (листинг 15.25).
Листинг 15.25. Фрагмент процедуры «ОбработкаПроведения()»
…
|         ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал";
 
Запрос2.УстановитьПараметр("Период", МоментВремени());
 
// Установить необходимость блокировки данных в регистрах СтоимостьМатериалов и ОстаткиМатериалов.
Движения.СтоимостьМатериалов.БлокироватьДляИзменения = Истина;
Движения.ОстаткиМатериалов.БлокироватьДляИзменения = Истина;
 
РезультатЗапроса = Запрос2.Выполнить();
Управляемая блокировка будет установлена в момент записи этих наборов записей, то есть как раз перед выполнением второго запроса. Что вам и требовалось.

### Выделение произвольных областей модуля
Итак, вы закончили редактирование процедуры ОбработкаПроведения() в модуле документа ОказаниеУслуги. Хотя модуль содержит всего одну процедуру, эта процедура довольно объемная (особенно для неопытного разработчика), и ее нельзя «охватить одним взглядом». Это затрудняет процесс восприятия и понимания текста процедуры, поиск в ней ошибок и т. д.
Для удобства разработчика в редакторе модуля существует возможность выделять произвольные области текста, группировать и сворачивать их подобно тому, как сворачиваются инструкции циклов, условий, процедур и функций. Каждой области текста разработчик может дать собственное имя и таким образом выделить часть модуля, имеющую определенное назначение.
Например, в вашей процедуре можно выделить три логические части: в первой части формируется временная таблица, содержащая перечень номенклатуры документа; во второй части рассчитывается стоимость номенклатуры и формируются движения в регистрах накопления; в третьей части производится контроль остатков номенклатуры при оперативном проведении документа.
Выделите эти три области в тексте процедуры. Для этого нужно выделить текст, который надо окружить (отметить как область), и в контекстном меню нажать Окружить > #Область… В результате выделенный фрагмент будет окружен инструкциями препроцессора #Область <имя области> и #КонецОбласти.
Введите понятные вам имена областей (листинг 15.26).
Листинг 15.26. Процедура «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ, Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
Движения.Продажи.Записывать = Истина;
 
// Создать менеджер временных таблиц.
МенеджерВТ = Новый МенеджерВременныхТаблиц;
 
#Область НоменклатураДокумента
Запрос = Новый Запрос;
 
// Указать, какой менеджер временных таблиц использует этот запрос.
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
 
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Сумма) КАК СуммаВДокументе
|ПОМЕСТИТЬ НоменклатураДокумента
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры";
 
Запрос.УстановитьПараметр("Ссылка", Ссылка);
 
РезультатЗапроса = Запрос.Выполнить();
#КонецОбласти
 
#Область ДвиженияДокумента
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|	НоменклатураДокумента.Номенклатура,
|	НоменклатураДокумента.ВидНоменклатуры,
|	НоменклатураДокумента.КоличествоВДокументе,
|	НоменклатураДокумента.СуммаВДокументе,
|	ЕСТЬNULL(СтоимостьМатериаловОстатки.СтоимостьОстаток, 0) КАК Стоимость,
|	ЕСТЬNULL(ОстаткиМатериаловОстатки.КоличествоОстаток, 0) КАК Количество
|ИЗ
|	НоменклатураДокумента КАК НоменклатураДокумента
|     	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьМатериалов.Остатки(
|          	&Период,
|          	Материал В (
|               	ВЫБРАТЬ
|                     	НоменклатураДокумента.Номенклатура
|               	ИЗ
|                     	НоменклатураДокумента)) КАК СтоимостьМатериаловОстатки
|     	ПО НоменклатураДокумента.Номенклатура = СтоимостьМатериаловОстатки.Материал
|     	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиМатериалов.Остатки(
|          	&Период,
|          	Материал В (
|               	ВЫБРАТЬ
|                     	НоменклатураДокумента.Номенклатура
|               	ИЗ
|                     	НоменклатураДокумента)) КАК ОстаткиМатериаловОстатки
|     	ПО НоменклатураДокумента.Номенклатура = ОстаткиМатериаловОстатки.Материал";
 
Запрос2.УстановитьПараметр("Период", МоментВремени());
 
// Установить необходимость блокировки данных в регистрах СтоимостьМатериалов и ОстаткиМатериалов.
Движения.СтоимостьМатериалов.БлокироватьДляИзменения = Истина;
Движения.ОстаткиМатериалов.БлокироватьДляИзменения = Истина;
 
РезультатЗапроса = Запрос2.Выполнить();
 
// ТЗ = РезультатЗапроса.Выгрузить();
 
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Если ВыборкаДетальныеЗаписи.Количество = 0 Тогда
СтоимостьМатериала = 0;
 
Иначе
СтоимостьМатериала = ВыборкаДетальныеЗаписи.Стоимость / ВыборкаДетальныеЗаписи.Количество;
 
КонецЕсли;
 
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// Регистр ОстаткиМатериалов – Расход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Склад = Склад;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
 
// Регистр СтоимостьМатериалов – Расход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
Движение.Период = Дата;
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * СтоимостьМатериала;
 
КонецЕсли;
 
// Регистр Продажи
Движение = Движения.Продажи.Добавить();
Движение.Период = Дата;
Движение.Номенклатура = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.Клиент = Клиент;
Движение.Мастер = Мастер;
Движение.Количество = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.Выручка = ВыборкаДетальныеЗаписи.СуммаВДокументе;
Движение.Стоимость = ВыборкаДетальныеЗаписи.КоличествоВДокументе * СтоимостьМатериала;
 
КонецЦикла;
 
Движения.Записать();
#КонецОбласти
 
#Область КонтрольОстатков
Если Режим = РежимПроведенияДокумента.Оперативный Тогда
 
// Проверить отрицательные остатки
Запрос3 = Новый Запрос;
Запрос3.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос3.Текст = "ВЫБРАТЬ
|	ОстаткиМатериаловОстатки.Материал,
|	ОстаткиМатериаловОстатки.КоличествоОстаток
|ИЗ
|	РегистрНакопления.ОстаткиМатериалов.Остатки(
|     	,
|     	Материал В
|          	(ВЫБРАТЬ
|                	НоменклатураДокумента.Номенклатура
|          	ИЗ
|                	НоменклатураДокумента)
|          	И Склад = &Склад) КАК ОстаткиМатериаловОстатки
|ГДЕ
|	ОстаткиМатериаловОстатки.КоличествоОстаток < 0";
 
Запрос3.УстановитьПараметр("Склад", Склад);
 
РезультатЗапроса = Запрос3.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Сообщение = Новый СообщениеПользователю();
Сообщение.Текст = "Не хватает " + Строка(- ВыборкаДетальныеЗаписи.КоличествоОстаток) + " единиц материала """ + ВыборкаДетальныеЗаписи.Материал + """";
Сообщение.Сообщить();
 
Отказ = Истина;
 
КонецЦикла;
 
КонецЕсли;
#КонецОбласти
 
КонецПроцедуры
В результате вы можете свернуть выделенные программные области в тексте процедуры (рис. 15.22).

Рис. 15.22. Выделение произвольных областей в модуле {https://ai2b.pro/wp-content/uploads/1/15_22.png}
Затем можно развернуть только нужную область модуля и работать с ней. Текст процедуры станет более компактным и читаемым.
В этом примере вы разбили одну процедуру модуля на три логические части. Но чаще бывает наоборот: когда модуль содержит много различных процедур, сходные по назначению процедуры можно объединить в группы. Например, в модуле формы можно выделить такие области, как ПрограммныйИнтерфейс, ОбработчикиСобытий, СлужебныеПроцедурыИФункции. Названия этих областей задаются самим разработчиком и говорят сами за себя.
Области могут быть вложены друг в друга или в другие группируемые конструкции языка. При расстановке областей в модуле нужно следить за тем, чтобы области не пересекались между собой и с другими группируемыми конструкциями. Потому что группировка по таким областям работать не будет.
### В прикладном решении
Запустите проект в режиме отладки и проверьте работу нового обработчика события ОбработкаПроведения, перепроведя все документы Оказание услуги.
В результате все работает точно так же с точки зрения пользователя, но проведение документов организовано методически правильно и более эффективно с точки зрения доступа к данным.
Чтобы проверить, как работает контроль остатков, создайте новый документ Оказание услуги и попробуйте израсходовать 4 резиновых шланга. При попытке провести документ вы получите сообщение об ошибке, а нажав ОК, получите сообщение о том, что не хватает 2 шлангов.
Закройте этот документ (Х), не сохраняя изменения.

## Занятие 16 (2:50). План видов характеристик
Продолжительность
Ориентировочная продолжительность занятия – 2 часа 50 минут.
На этом занятии вы познакомитесь с новым объектом конфигурации План видов характеристик и узнаете, каким образом можно использовать этот объект для расширения возможностей вашей конфигурации.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Постановка задачи
Задача, которую вам предстоит решить, будет заключаться в следующем: вы создадите механизм, позволяющий пользователю произвольным образом описывать материалы и, что самое главное, вести учет в разрезе всех тех описаний, которые он может задать.
Описывать материалы пользователь сможет следующим образом: для каждого материала будет возможность создать некоторые (произвольные) характеристики (например, цвет, производитель и пр.). Затем при поступлении материалов можно будет задать конкретные значения интересующих характеристик (например, при поступлении электрических кабелей можно будет указать, что они белого цвета и их сечение равно 2,5 мм?, а при поступлении резиновых шлангов указать, что они черного цвета и произведены на фирме Fagumit Sp. z o.o.).
В дальнейшем всегда можно будет получить информацию о том, сколько и каких материалов есть у вас, скажем, белого цвета или сколько было израсходовано черных резиновых шлангов.
Поскольку заранее неизвестно, какими именно характеристиками пользователь захочет описать тот или иной материал, вы должны предоставить ему некоторый механизм, позволяющий создавать любые характеристики и, что самое важное, указывать, какой тип значения должен быть у этих характеристик. Тогда при задании значений определенной характеристики пользователь сможет выбирать значения строго в соответствии с указанным типом.
Такую возможность описания характеристик как раз и обеспечивает объект конфигурации План видов характеристик, с которым вы сейчас познакомитесь.

### Что такое план видов характеристик
Объект конфигурации План видов характеристик предназначен для описания структуры хранения информации о характеристиках, создаваемых пользователем. На основе объекта конфигурации План видов характеристик платформа создает в базе данных набор таблиц, в которых будет храниться информация о существующих видах характеристик и типе значения характеристики каждого вида.
В сущности, план видов характеристик очень напоминает справочник, однако имеет более узкую «специализацию»: хранит, по сути, информацию только о том, какими видами характеристик может описываться какой-либо объект базы данных.
План видов характеристик состоит из видов характеристик. Каждый вид характеристики обязательно описывается наименованием и типом значения.
Разработчик и, что самое важное, пользователь могут задать в нем любое необходимое им количество видов характеристик (рис. 16.1).

Рис. 16.1. План видов характеристик в 1C:EDT, в базе данных и в прикладном решении {https://ai2b.pro/wp-content/uploads/1/16_01.png}
Для того чтобы разработчик мог задать некий набор возможных типов значений, которые могут принимать виды характеристик, у объекта конфигурации План видов характеристик существует свойство Тип.
Это свойство определяет составной тип данных, куда входят все типы, которые могут понадобиться при указании типа значения характеристики (рис. 16.2).

Рис. 16.2. Свойство «Тип» плана видов характеристик {https://ai2b.pro/wp-content/uploads/1/16_01.png}
Кроме того, может случиться так, что пользователю станет недостаточно тех типов данных, которые существуют в конкретной конфигурации.
Например, он захочет вести учет в разрезе цвета товаров, а справочник Цвет в конфигурации отсутствует.
В этом случае он сможет воспользоваться специальным вспомогательным справочником, который вы создадите заблаговременно и укажете в качестве свойства объекта конфигурации План видов характеристик – Дополнительные значения характеристик (рис. 16.3).

Рис. 16.3. Свойство «Дополнительные значения характеристик» {https://ai2b.pro/wp-content/uploads/1/16_03.png}
Тогда пользователь, создав новый вид характеристики Цвет, сможет задать необходимые значения цвета в справочнике дополнительных значений характеристик.
Примечательно, что этот справочник является подчиненным плану видов характеристик. Таким образом, если затем пользователь пожелает создать новый вид характеристик Запах и его значения, он будет создавать их в том же самом справочнике дополнительных характеристик и они не будут «смешиваться» со значениями цвета.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с планами видов характеристик, можно прочитать в разделе «Краткий справочник разработчика. Планы видов характеристик».
План видов характеристик не имеет внутренних предопределенных механизмов привязки вида характеристики к тому объекту, который он должен описывать. Он лишь предоставляет возможность разработчику и пользователю описать некий набор характеристик и задать их тип.
Каким образом хранить соответствие конкретного вида характеристик или значения характеристик конкретному объекту базы данных, решает сам разработчик в зависимости от создаваемого прикладного решения.
С точки зрения реализации пример, который вы будете разрабатывать далее, не является простым.
Поэтому сначала вам нужно понять логическую связь между объектами, которые будут использоваться в этом примере.

### Логическая связь объектов
Для реализации этого примера вам понадобятся три новых объекта конфигурации.
Прежде всего это план видов характеристик. Он будет хранить виды характеристик, которыми в принципе можно описывать материалы.
Кроме этого вам понадобится специальный справочник, подчиненный справочнику Номенклатура. Элементы этого справочника будут идентифицировать партии материалов с некоторым фиксированным набором значений характеристик.
И третий объект – это регистр сведений, в котором, собственно, и будет храниться соответствие конкретных значений характеристик некоторому варианту материала (рис. 16.4).

Рис. 16.4. Логическая связь объектов {https://ai2b.pro/wp-content/uploads/1/16_04.png}
В результате использования такой логической структуры объектов вы получите возможность описывать каждую поступающую партию материала любым количеством видов характеристик, поскольку это соответствие будет храниться в регистре сведений.
И вместе с этим вы получите возможность вести учет в разрезе видов характеристик, добавив в регистры накопления еще одно измерение для хранения ссылки на элемент справочника, подчиненного справочнику Номенклатура (рис. 16.4).
В результате, для того чтобы узнать остатки материалов, обладающих некоторым значением характеристики, достаточно будет выбрать из регистра сведений все элементы подчиненного справочника с этим значением характеристики и затем по ним и их владельцам получить остатки регистра накопления.

### Создание новых объектов конфигурации
Итак, вам понадобится создать несколько новых объектов конфигурации:
справочник ВариантыНоменклатуры, чтобы описывать партии материалов;
справочник ДополнительныеСвойстваНоменклатуры, чтобы задавать значения видов характеристик, для которых нет подходящих типов в конфигурации;
план видов характеристик СвойстваНоменклатуры, чтобы создавать виды характеристик;
регистр сведений ЗначенияСвойствНоменклатуры, чтобы хранить значения видов характеристик для различных партий материалов.
Сначала добавьте объект конфигурации – справочник с именем ВариантыНоменклатуры и укажите, что он будет подчинен справочнику Номенклатура. Для этого в редакторе объекта конфигурации на закладке Владельцы добавьте справочник Номенклатура в список владельцев справочника ВариантыНоменклатуры.
Затем добавьте еще один объект конфигурации – справочник с именем ДополнительныеСвойстваНоменклатуры.
После этого добавьте объект конфигурации – план видов характеристик с именем СвойстваНоменклатуры.
Установите его свойство Тип.
Для этого нажмите кнопку выбора  и задайте составной тип данных следующим образом (рис. 16.5):
Число, длина 15, точность 3;
Строка, длина 25;
Дата;
Булево;
СправочникСсылка.ДополнительныеСвойстваНоменклатуры.

Рис. 16.5. Определение составного типа данных для типа плана видов характеристик {https://ai2b.pro/wp-content/uploads/1/16_05.png}
В окне редактирования типа данных установите флажок Составной тип данных и отметьте нужные типы данных. Обратите внимание, что при выделении типов Число или Строка их квалификаторы (длина, точность и т. п.) задаются внизу окна.
Затем для справочника ДополнительныеСвойстваНоменклатуры укажите владельца – план видов характеристик СвойстваНоменклатуры (рис. 16.6).

Рис. 16.6. Установка владельца справочника «Дополнительные свойства номенклатуры» {https://ai2b.pro/wp-content/uploads/1/16_06.png}
После этого определите, что дополнительные значения характеристик плана видов характеристик будут располагаться в справочнике ДополнительныеСвойстваНоменклатуры (рис. 16.7).

Рис. 16.7. Свойство «Дополнительные значения характеристик» плана видов характеристик {https://ai2b.pro/wp-content/uploads/1/16_07.png}
Теперь добавьте объект конфигурации – регистр сведений с именем ЗначенияСвойствНоменклатуры.
Создайте измерения регистра (рис. 16.8):
НаборСвойств, Ведущее, тип СправочникСсылка.ВариантыНоменклатуры;
ВидСвойства, тип ПланВидовХарактеристикСсылка.СвойстваНоменклатуры.
Затем создайте ресурс регистра:
Значение, тип Характеристика.СвойстваНоменклатуры.

Рис. 16.8. Измерения и ресурсы регистра сведений {https://ai2b.pro/wp-content/uploads/1/16_08.png}
Обратите внимание, что вы имеете возможность определить тип значения ресурса регистра как Характеристика.<имя>. По сути, это определение представляет собой составной тип данных, как он задан в типе значения соответствующего плана видов характеристик. То есть ресурс регистра может иметь значение любого типа из тех, которые описаны в типе плана видов характеристик.
Кроме того, задайте в свойстве Связь по типу этого ресурса измерение регистра ВидСвойства. Связь по типу будет обеспечивать вам соответствие типа значений, вводимых в это поле, и типа характеристики, выбранной в поле Вид свойства. А также заполните еще одно свойство – Связи параметров выбора.
Для этого нажмите кнопку выбора  у этого свойства и перенесите из списка доступных реквизитов в список параметров измерение регистра ВидСвойства.
Установка свойства Связи параметров выбора обеспечит вам то, что при выборе значений, содержащихся в справочнике Дополнительные свойства номенклатуры, для выбора будут предлагаться только те значения, которые относятся к выбранной характеристике, а не все, которые есть в этом справочнике (рис. 16.9).

Рис. 16.9. Свойство ресурса «Значение регистра сведений» {https://ai2b.pro/wp-content/uploads/1/16_09.png}
#### Описание характеристик вариантов номенклатуры
В заключение для справочника ВариантыНоменклатуры опишите его характеристики, то есть укажите, где хранятся свойства вариантов номенклатуры и как получить значения этих свойств. Это описание платформа будет использовать автоматически при выполнении отчетов и при формировании различных динамических списков, в которых задействуются варианты номенклатуры.
Для этого в панели Навигатор нажмите Характеристики в контекстном меню справочника ВариантыНоменклатуры (рис. 16.10).

Рис. 16.10. Переход к характеристикам справочника «ВариантыНоменклатуры» {https://ai2b.pro/wp-content/uploads/1/16_10.png}
Редактор справочника откроется на закладке Характеристики. Нажмите  и добавьте новое описание характеристик.
В первой секции в качестве источника видов характеристик выберите план видов характеристик СвойстваНоменклатуры. Платформа автоматически определит, что полем ключа будет являться поле Ссылка этого объекта конфигурации (рис. 16.11).
Остальные поля в этой секции не меняйте. Вам эти поля не понадобятся.
Во второй секции в качестве источника значений характеристик выберите регистр сведений ЗначенияСвойствНоменклатуры.
Платформа автоматически определит, что в этом регистре полем объекта является измерение НаборСвойств, а полем вида – измерение ВидСвойства. Поэтому единственное, что вам останется указать самостоятельно, – что значения свойств хранятся в ресурсе Значение.
Нажмите Готово. В результате описание характеристик для справочника ВариантыНоменклатуры будет выглядеть следующим образом (рис. 16.11).

Рис. 16.11. Описание характеристик для справочника «ВариантыНоменклатуры» {https://ai2b.pro/wp-content/uploads/1/16_11.png}

### Доработка объектов конфигурации
Итак, вы создали новые объекты конфигурации и задали их основные свойства, необходимые для реализации вашей задачи.
Но, как вы дальше увидите, не все свойства вас полностью устраивают. И вообще при разработке невозможно предусмотреть все заранее. Часто какие-то недочеты становятся видны лишь в процессе работы. То есть, увидев промежуточный результат в прикладном решении, важно уметь оценить недостатки и исправить их прямо по ходу работы.
Поэтому на этом занятии вы познакомитесь с процессом «разработки от обратного». Это тоже очень ценный опыт, который будет вам полезен.
Итак, запустите проект в режиме отладки и посмотрите, как взаимодействуют логически связанные объекты конфигурации справочник Номенклатура, справочник ВариантыНоменклатуры, план видов характеристик СвойстваНоменклатуры и регистр сведений ЗначенияСвойствНоменклатуры.
Обратите внимание, что вы не указывали для этих объектов подсистемы, к которым они относятся. Дело в том, что отображение этих объектов вне их логической связи друг с другом не имеет особого смысла. Поскольку вы задали владельцев справочников, ведущее измерение регистра сведений и т. п., нужные объекты автоматически попадут в панель навигации форм своих владельцев как подчиненная информация.
#### Справочник «Варианты номенклатуры»

##### В прикладном решении
По условию вашей задачи вам нужно создать наборы свойств и составляющие их характеристики для отдельных элементов номенклатуры. Наборы свойств, как уже говорилось, будут храниться в справочнике ВариантыНоменклатуры, подчиненном справочнику Номенклатура.
Сначала создайте набор свойств для элемента номенклатуры Кабель электрический.
В разделе Учет материалов откройте справочник Номенклатура и его элемент Кабель электрический из группы Материалы > Прочее.
Поскольку справочник Номенклатура является владельцем справочника ВариантыНоменклатуры, вы видите в панели навигации формы ссылку для перехода к подчиненному списку. Это значит, что при открытии этого списка вы будете видеть только наборы свойств, относящиеся к редактируемому элементу справочника Номенклатура.
Нажмите Варианты номенклатуры для перехода к списку, где будут храниться наборы свойств элементов номенклатуры (рис. 16.12).

Рис. 16.12. Список вариантов номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_12.png}
Открывшаяся автоматически сгенерированная форма списка вариантов номенклатуры не совсем оптимальна: столбцы Код и Владелец явно лишние.
Код нового варианта номенклатуры генерируется автоматически и ни о чем пользователю не говорит.
Владелец варианта номенклатуры отражен в заголовке формы и тоже в списке не имеет смысла.
Чтобы сделать эти колонки невидимыми, вам нужно создать форму списка справочника ВариантыНоменклатуры и при ее создании проанализировать, откуда она открывается (это можно понять по значению параметра формы Отбор).
Если установлен отбор по владельцу (то есть она открывается из списка номенклатуры), то вы будете в ней скрывать колонки Код и Владелец.
Если же форма открывается другими способами, то эти колонки могут понадобиться, поэтому просто удалить их из формы было бы неправильно.
Поскольку форма создается на сервере, делать это нужно в обработчике события формы ПриСозданииНаСервере.
##### В 1C:EDT
Устраните недостатки формы списка в 1С:EDT.
Создайте основную форму списка для справочника ВариантыНоменклатуры.
Форма, созданная конструктором, в отличие от автогенерируемой формы не содержит поля Владелец. Поэтому ваша задача даже упрощается: вам нужно будет скрыть только одно поле – Код.
В окне элементов формы выделите корневой элемент Форма (поскольку вам нужно событие формы в целом) и создайте обработчик события ПриСозданииНаСервере, выбрав его из списка События в контекстном меню элемента Форма (рис. 16.13).

Рис. 16.13. Создание обработчика события формы «При создании на сервере» {https://ai2b.pro/wp-content/uploads/1/16_13.png}
Обработчик события формы ПриСозданииНаСервере в модуле формы заполните следующим образом (листинг 16.1).
Листинг 16.1. Обработчик события формы «ПриСозданииНаСервере()»
Если Параметры.Отбор.Свойство("Владелец") Тогда
Элементы.Код.Видимость = Ложь;
 
КонецЕсли;
Параметры – это свойство формы клиентского приложения, в модуле которой вы находитесь. Используя это свойство, вы получаете объект, который содержит коллекцию параметров формы.
К элементу этой коллекции Отбор вы обращаетесь по имени. Используя метод Свойство() структуры элементов отбора, вы определяете, установлен ли отбор по полю Владелец.
Если такой отбор установлен, то вы скрываете это поле, то есть устанавливаете видимость поля Код в значение Ложь. Здесь Элементы – это свойство формы клиентского приложения, которое позволяет получить доступ ко всем элементам формы.

##### В прикладном решении
Проверьте результат изменений, запустив проект в режиме отладки.
Форма списка вариантов номенклатуры будет иметь следующий вид (рис. 16.14).

Рис. 16.14. Список вариантов номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_14.png}
Вы видите, что добились желаемого результата (рис. 16.12): было три колонки, а теперь только одна – Наименование.
Теперь нажмите Создать, чтобы создать новый набор свойств для элемента номенклатуры.
Откроется форма элемента справочника ВариантыНоменклатуры (рис. 16.15).

Рис. 16.15. Форма элемента справочника «Варианты номенклатуры» {https://ai2b.pro/wp-content/uploads/1/16_15.png}
Эта форма сгенерирована системой автоматически. Но в ней также есть недостатки:
заголовок формы должен быть задан в единственном числе;
лишние поля Код и Владелец;
команду перехода к подчиненной информации нужно переименовать в более понятную.

##### В 1C:EDT
Устраните эти недостатки в 1С:EDT.
Во-первых, чтобы изменить заголовок формы, свойство Представление объекта справочника ВариантыНоменклатуры задайте в единственном числе – Вариант номенклатуры.
Это свойство будет использоваться в интерфейсе прикладного решения как заголовок формы элемента справочника.
Во-вторых, нужно убрать поля Код и Владелец из этой формы.
Для этого создайте основную форму элемента для справочника ВариантыНоменклатуры.
В окне структуры элементов формы выделите поочередно и удалите эти элементы. В результате в форме элемента будет отображен только один реквизит справочника – Наименование.
Его представление вам тоже нужно немного поправить.
Для этого в редакторе справочника измените свойство Синоним стандартного реквизита Наименование на Название.
В-третьих, не вяжутся друг с другом заголовок формы Вариант номенклатуры и подчиненная ему информация – Значения свойств номенклатуры (рис. 16.15). Это записи одноименного регистра, к которым можно перейти из формы элемента.
Поэтому свойство Представление списка регистра сведений ЗначенияСвойствНоменклатуры задайте как Состав варианта номенклатуры.
Это свойство будет использоваться в интерфейсе прикладного решения как заголовок формы списка регистра.
##### В прикладном решении
Проверьте результат изменений, запустив проект в режиме отладки.
Итак, в разделе Учет материалов откройте справочник Номенклатура и его элемент Кабель электрический из группы Материалы > Прочее.
В форме элемента нажмите Варианты номенклатуры для перехода к списку наборов свойств данного элемента номенклатуры. Пока этот список пуст.
Нажмите Создать. Теперь в открывшейся форме варианта номенклатуры вас все устраивает.
#### Регистр сведений «Значения свойств номенклатуры»
##### В прикладном решении
Создайте вариант номенклатуры Белые кабели (рис. 16.16).

Рис. 16.16. Форма элемента справочника «Вариант номенклатуры» {https://ai2b.pro/wp-content/uploads/1/16_16.png}
Нажмите Состав варианта номенклатуры для перехода к составу редактируемого варианта номенклатуры.
подсказка
Как показывает опыт многих читателей, при выполнении данного занятия может возникнуть проблема – в панели навигации формы варианта номенклатуры не видна команда для перехода к связанным записям регистра сведений ЗначенияСвойствНоменклатуры (Состав варианта номенклатуры). В этом случае, скорее всего, вы забыли установить свойство Ведущее для измерения этого регистра НаборСвойств, имеющего тип СправочникСсылка.ВариантыНоменклатуры.
В результате того, что измерение регистра является ведущим, в панели навигации формы элемента справочника ВариантыНоменклатуры появляется ссылка, по которой возможен переход к записям регистра, содержащим в измерении НаборСвойств ссылку на текущий вариант номенклатуры.
Если новый вариант номенклатуры еще не записан, то появится вопрос о записи данных, на который ответьте утвердительно (рис. 16.17).

Рис. 16.17. Подтверждение записи данных {https://ai2b.pro/wp-content/uploads/1/16_17.png}
После этого откроется форма списка регистра Значения свойств номенклатуры, которая также генерируется по умолчанию (рис. 16.18).

Рис. 16.18. Форма списка регистра «Состав варианта номенклатуры» {https://ai2b.pro/wp-content/uploads/1/16_18.png}
В этой форме также не все хорошо:
заголовок колонки ВидСвойства лучше переименовать,
лишняя колонка НаборСвойств.

##### В 1C:EDT
Устраните эти недостатки в 1С:EDT.
Во-первых, название колонки Вид свойства лучше переименовать в Свойство.
Для этого измените Синоним измерения ВидСвойства регистра сведений ЗначенияСвойствНоменклатуры на Свойство.
Во-вторых, поскольку регистр имеет ведущее измерение НаборСвойств типа СправочникСсылка.ВариантыНоменклатуры, поле Набор свойств – лишнее, так как владелец данного набора свойств отражен в заголовке формы.
Поэтому создайте обработчик события ПриСозданииНаСервере формы списка регистра и в нем сделайте колонку НаборСвойств невидимой в случае открытия формы с отбором по этому полю, то есть если форма списка регистра открыта из формы элемента справочника Варианты номенклатуры.
Создайте основную форму списка для регистра.
Затем создайте для формы обработчик события формы ПриСозданииНаСервере так же, как вы это делали для формы списка справочника Варианты номенклатуры, и заполните следующим образом (листинг 16.2).
Листинг 16.2. Обработчик события формы «ПриСозданииНаСервере()»
Если Параметры.Отбор.Свойство("НаборСвойств") Тогда
Элементы.НаборСвойств.Видимость = Ложь;
 
КонецЕсли;
Этот код аналогичен коду, приведенному выше в листинге 16.1, поэтому в комментариях не нуждается.

##### В 1C:EDT
Устраните эти недостатки в 1С:EDT.
Во-первых, название колонки Вид свойства лучше переименовать в Свойство.
Для этого измените Синоним измерения ВидСвойства регистра сведений ЗначенияСвойствНоменклатуры на Свойство.
Во-вторых, поскольку регистр имеет ведущее измерение НаборСвойств типа СправочникСсылка.ВариантыНоменклатуры, поле Набор свойств – лишнее, так как владелец данного набора свойств отражен в заголовке формы.
Поэтому создайте обработчик события ПриСозданииНаСервере формы списка регистра и в нем сделайте колонку НаборСвойств невидимой в случае открытия формы с отбором по этому полю, то есть если форма списка регистра открыта из формы элемента справочника Варианты номенклатуры.
Создайте основную форму списка для регистра.
Затем создайте для формы обработчик события формы ПриСозданииНаСервере так же, как вы это делали для формы списка справочника Варианты номенклатуры, и заполните следующим образом (листинг 16.2).
Листинг 16.2. Обработчик события формы «ПриСозданииНаСервере()»
Если Параметры.Отбор.Свойство("НаборСвойств") Тогда
Элементы.НаборСвойств.Видимость = Ложь;
 
КонецЕсли;
Этот код аналогичен коду, приведенному выше в листинге 16.1, поэтому в комментариях не нуждается.

##### В 1C:EDT
Устраните эти недостатки в 1С:EDT.
Во-первых, нужно переименовать заголовок формы, чтобы было понятно, что вы создаете в данный момент одно свойство и его значение в составе варианта номенклатуры.
Поэтому свойство Представление записи регистра сведений ЗначенияСвойствНоменклатуры задайте как Свойство и значение.
Это свойство будет использоваться в интерфейсе прикладного решения как заголовок формы записи регистра.
Во-вторых, нужно убрать поле НаборСвойств из этой формы.
Для этого создайте основную форму записи для регистра. В окне структуры элементов формы удалите это поле.

##### В прикладном решении
Проверьте результат изменений, запустив проект в режиме отладки.
В результате форма записи регистра ЗначенияСвойствНоменклатуры примет следующий вид (рис. 16.21).

Рис. 16.21. Форма записи регистра «Значения свойств номенклатуры» {https://ai2b.pro/wp-content/uploads/1/16_21.png}

### Создание видов характеристик номенклатуры
Теперь создайте различные варианты номенклатуры в прикладном решении.
Итак, в разделе Учет материалов откройте справочник Номенклатура и его элемент Кабель электрический из группы Материалы > Прочее.
Затем нажмите Варианты номенклатуры для перехода к списку наборов свойств данного элемента номенклатуры.
В форме списка вариантов номенклатуры откройте набор свойств Белые кабели, который вы создали ранее.
В форме варианта номенклатуры нажмите Состав варианта номенклатуры для перехода к составу редактируемого варианта номенклатуры. Этот список пока пуст.
Нажмите Создать. В открывшейся форме (рис. 16.21) создайте свойство Цвет со значением Белый.
Для этого нажмите кнопку выпадающего списка  в поле Свойство и в этом списке нажмите Показать все (рис. 16.22).
Измерение ВидСвойства(Свойство) регистра ЗначенияСвойствНоменклатуры имеет тип ПланВидовХарактеристикСсылка.СвойстваНоменклатуры. Поэтому перед вами появится форма выбора этого плана видов характеристик. Список видов характеристик пока пуст.
Нажмите Создать. В форме элемента плана видов характеристик введите наименование вида характеристики – Цвет. Тип значения этого вида характеристики оставьте по умолчанию – Дополнительные свойства номенклатуры (рис. 16.22).

Рис. 16.22. Создание вида характеристики в плане видов характеристик {https://ai2b.pro/wp-content/uploads/1/16_22.png}
ПРИМЕЧАНИЕ
Обратите внимание на недостатки: в форме элемента плана видов характеристик (рис. 16.22) и в форме элемента справочника дополнительных характеристик номенклатуры (рис. 16.23) также есть лишнее поле Код. Кроме того, заголовки этих форм желательно задать в единственном числе.
Ранее вы уже исправляли подобные недостатки. Исправьте их самостоятельно и в этой форме, но после того, как закончите вводить данные. Если вы забыли, как это делается, то посмотрите еще раз, как вы дорабатывали форму элемента справочника ВариантыНоменклатуры (см. раздел «Справочник "Варианты номенклатуры"»).
Нажмите Записать и закрыть. В окне выбора плана видов характеристик появится созданный вами вид характеристики.
Нажмите Выбрать. В результате вы вернетесь в форму записи состава варианта номенклатуры с заголовком Свойство и значение.
Введите Белый в поле Значение и в выпадающем списке нажмите (+) Создать (рис. 16.23).
Ресурс Значение регистра ЗначенияСвойствНоменклатуры имеет тип Характеристика.СвойстваНоменклатуры. Это составной тип данных, который описан в свойстве Тип плана видов характеристик СвойстваНоменклатуры.
Так как для вида характеристики Цвет вы задали тип значения СправочникСсылка.ДополнительныеСвойстваНоменклатуры, то перед вами появится форма ввода нового элемента этого справочника.
В наименование дополнительного свойства номенклатуры будет подставлено введенное вами значение Белый, в поле Владелец – значение Цвет (рис. 16.23).

Рис. 16.23. Создание дополнительных свойств номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_23.png}
Нажмите Записать и закрыть.
Вы вернетесь в форму записи состава варианта номенклатуры с заголовком Свойство и значение и увидите там созданное вами свойство Цвет со значением Белый (рис. 16.24).

Рис. 16.24. Свойство и значение в составе варианта номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_24.png}
Нажмите Записать и закрыть. Вы вернетесь в форму списка состава варианта номенклатуры.
Создайте еще одно свойство – Сечение, мм2 – в составе варианта номенклатуры Белые кабели. Для этого повторите только что выполненные действия.
Нажмите Создать (рис. 16.25).

Рис. 16.25. Создание нового свойства в составе варианта номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_25.png}
В открывшейся форме записи состава варианта номенклатуры нажмите  в поле Свойство и в выпадающем списке нажмите Показать все.
В форме выбора плана видов характеристик нажмите Создать.
В открывшемся окне формы элемента плана видов характеристик введите наименование вида характеристики – Сечение, мм2 и выберите Тип значения этого вида характеристики – Число, длина 15, точность 3 (рис. 16.26).

Рис. 16.26. Создание вида характеристики в плане видов характеристик {https://ai2b.pro/wp-content/uploads/1/16_26.png}
Нажмите Записать и закрыть. В окне выбора плана видов характеристик появится созданный вами вид характеристики.
Нажмите Выбрать. Вы вернетесь в форму записи состава варианта номенклатуры с заголовком Свойство и значение.
Введите число 2,5 в поле Значение (рис. 16.27).

Рис. 16.27. Свойство и значение в составе варианта номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_27.png}
Нажмите Записать и закрыть. Вы вернетесь в форму списка состава варианта номенклатуры.
Итак, вы видите два свойства и их значения, которые вы создали для варианта номенклатуры Белые кабели (рис. 16.28).

Рис. 16.28. Свойства и значения в составе варианта номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_28.png}
Теперь аналогичным образом создайте набор свойств для элемента справочника Номенклатура – Шланг резиновый.
Этот набор свойств будет называться Польша (рис. 16.29) и состоять из следующих свойств (рис. 16.30):
Цвет – Черный;
Производитель – Fagumit.

Рис. 16.29. Вариант номенклатуры для элемента номенклатуры «Шланг резиновый» {https://ai2b.pro/wp-content/uploads/1/16_29.png}
При создании свойства Цвет выберите его из уже имеющихся свойств в плане видов характеристик.
Значение этого вида характеристики – Черный – добавьте в справочник дополнительных свойств номенклатуры и выберите из него.
При создании свойства Производитель с типом значения Дополнительные свойства номенклатуры сначала добавьте это свойство в план видов характеристик (тип значения – Дополнительные свойства номенклатуры), а затем выберите из него.
Значение этого вида характеристики – Fagumit – добавьте в справочник дополнительных свойств номенклатуры и выберите из него.

Рис. 16.30. Свойства и значения в составе варианта номенклатуры «Польша» {https://ai2b.pro/wp-content/uploads/1/16_30.png}
Теперь посмотрите на все, что вы создали, не с точки зрения пользователя, а с точки зрения разработчика.
Перейдите в главное меню программы. Для этого нажмите кнопку , расположенную в главной панели, в правом верхнем углу окна приложения. В главном меню нажмите Функции для технического специалиста. Поочередно откройте все объекты конфигурации, в которых хранится информация о созданных вами характеристиках номенклатуры.
В справочнике Варианты номенклатуры хранятся созданные вами наборы свойств номенклатуры. При этом каждый набор свойств подчинен конкретному элементу номенклатуры.
В плане видов характеристик Свойства номенклатуры хранятся созданные вами виды характеристик номенклатуры:
Цвет, тип значения СправочникСсылка.ДополнительныеСвойстваНоменклатуры;
Сечение, мм2, тип значения Число;
Производитель, тип значения СправочникСсылка.ДополнительныеСвойстваНоменклатуры.
В справочнике Дополнительные свойства номенклатуры хранятся значения этих видов характеристик (за исключением вида характеристики Сечение типа Число). А в регистре сведений ЗначенияСвойствНоменклатуры хранятся соответствия видов характеристик и их значений в разрезе наборов свойств.
Взаимодействие этих объектов конфигурации представлено на следующей схеме (рис. 16.31).

Рис. 16.31. Объекты конфигурации, в которых хранится информация о характеристиках номенклатуры {https://ai2b.pro/wp-content/uploads/1/16_31.png}

### Доработка учетных механизмов
Итак, вы добавили возможность указывать произвольные характеристики для номенклатуры и создали несколько таких характеристик – вариантов номенклатуры.
Но это лишь часть работы. Теперь хотелось бы иметь возможность еще и учитывать номенклатуру в разрезе этих характеристик. А именно:
приходовать товар, указывая характеристики;
расходовать товар, указывая характеристики;
получать отчеты не просто по номенклатуре, а по номенклатуре с определенными характеристиками.
Для этого потребуется доработать имеющиеся регистры и создать новый отчет, который позволит получать данные в разрезе свойств номенклатуры.
#### Регистр «Остатки материалов»
Для обеспечения учета материалов по значениям характеристик необходимо изменить структуру регистра накопления ОстаткиМатериалов, чтобы хранить в нем данные еще и в разрезе наборов свойств номенклатуры.
Для этого добавьте в регистр накопления ОстаткиМатериалов новое измерение НаборСвойств с типом СправочникСсылка.ВариантыНоменклатуры.
#### Документ «Приходная накладная»
Теперь вам нужно доработать документ ПриходнаяНакладная, чтобы при приходовании материалов можно было указать набор свойств и чтобы этот набор свойств записывался в регистры при проведении документа.
Для этого создайте новый реквизит табличной части документа с именем НаборСвойств типа СправочникСсылка.ВариантыНоменклатуры.
У этого реквизита необходимо заполнить свойство Связи параметров выбора, чтобы после выбора номенклатуры в этом свойстве выбирать только среди тех наборов свойств, которые относятся к данной номенклатуре.
Для этого нажмите кнопку выбора  у свойства Связи параметров выбора и перенесите из списка доступных реквизитов в список параметров реквизит Материалы.Материал (рис. 16.32).

Рис. 16.32. Связи параметров выбора {https://ai2b.pro/wp-content/uploads/1/16_32.png}

Тем самым вы задали, что при выборе в поле НаборСвойств будет всегда открываться список элементов справочника Варианты номенклатуры, подчиненных материалу, выбранному в колонке Материал.
После этого расположите реквизит НаборСвойств в табличной части формы документа. Новый элемент поместите в структуре элементов формы после поля Материал.
Обратите внимание, что при перетаскивании реквизита в форму с помощью мыши в свойстве ПутьКДанным нового элемента формы будет автоматически указан реквизит табличной части НаборСвойств. Свойство ПутьКДанным устанавливает связь элемента формы с реквизитом формы, то есть с отображаемыми данными. Это свойство обязательно должно быть заполнено, иначе элемент формы не будет показан!
ПРИМЕЧАНИЕ
При добавлении элемента формы с помощью кнопки Добавить свойство ПутьКДанным, устанавливающее связь элемента с реквизитом формы, необходимо заполнять вручную.
Теперь откройте модуль документа ПриходнаяНакладная.
В процедуре обработчика события ОбработкаПроведения добавьте к формируемым движениям присвоение значения измерению НаборСвойств регистра ОстаткиМатериалов (листинг 16.3).
Листинг 16.3. Фрагмент процедуры «ОбработкаПроведения()»
…
// регистр ОстаткиМатериалов Приход
…
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.НаборСвойств = ТекСтрокаМатериалы.НаборСвойств;
Движение.Склад = Склад;
…

#### Документ «Оказание услуги»
Теперь аналогичным образом доработайте документ ОказаниеУслуги.
Для того чтобы при расходовании материалов пользователь мог указывать набор свойств для каждого расходуемого материала, создайте новый реквизит табличной части документа с именем НаборСвойств типа СправочникСсылка.ВариантыНоменклатуры.
У этого реквизита заполните свойство Связи параметров выбора так, чтобы при выборе в поле НаборСвойств открывался список элементов справочника Варианты номенклатуры, подчиненных материалу, выбранному в колонке Номенклатура (отбор по владельцу – ПереченьНоменклатуры.Номенклатура).
После этого расположите этот реквизит в табличной части формы документа. Поместите новый элемент формы в структуре элементов формы после поля Номенклатура.
Теперь откройте модуль документа ОказаниеУслуги.
В процедуре обработчика события ОбработкаПроведения добавьте к формируемым движениям присвоение значения измерению НаборСвойств регистра ОстаткиМатериалов (листинг 16.4).
Листинг 16.4. Фрагмент процедуры «ОбработкаПроведения()»
…
// регистр ОстаткиМатериалов Расход
…
Движение.Материал = ВыборкаДетальныеЗаписи.Номенклатура;
Движение.НаборСвойств = ВыборкаДетальныеЗаписи.НаборСвойств;
Движение.Склад = Склад;
…
Поскольку на предыдущем занятии вы оптимизировали процедуру проведения документа, чтобы все данные документа получались с помощью запроса, в текст запроса нужно также добавить строки для получения нового реквизита документа (листинг 16.5).
Листинг 16.5. Фрагмент процедуры «ОбработкаПроведения()»
…
Запрос = Новый Запрос;
 
// Укажем, какой менеджер временных таблиц использует этот запрос
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
 
Запрос.Текст =
"ВЫБРАТЬ
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
|    ОказаниеУслугиПереченьНоменклатуры.НаборСвойств КАК НаборСвойств,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Количество) КАК КоличествоВДокументе,
|	СУММА(ОказаниеУслугиПереченьНоменклатуры.Сумма) КАК СуммаВДокументе
|ПОМЕСТИТЬ НоменклатураДокумента
|ИЗ
|	Документ.ОказаниеУслуги.ПереченьНоменклатуры КАК ОказаниеУслугиПереченьНоменклатуры
|ГДЕ
|	ОказаниеУслугиПереченьНоменклатуры.Ссылка = &Ссылка
|СГРУППИРОВАТЬ ПО
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура,
|	ОказаниеУслугиПереченьНоменклатуры.Номенклатура.ВидНоменклатуры,
|    ОказаниеУслугиПереченьНоменклатуры.НаборСвойств";
...
Запрос2 = Новый Запрос;
Запрос2.МенеджерВременныхТаблиц = МенеджерВТ;
Запрос2.Текст = "ВЫБРАТЬ
|	НоменклатураДокумента.Номенклатура,
|	НоменклатураДокумента.ВидНоменклатуры,
|    НоменклатураДокумента.НаборСвойств,
|	НоменклатураДокумента.КоличествоВДокументе,
|	НоменклатураДокумента.СуммаВДокументе,
|	ЕСТЬNULL(СтоимостьМатериаловОстатки.СтоимостьОстаток, 0) КАК Стоимость,
|	ЕСТЬNULL(ОстаткиМатериаловОстатки.КоличествоОстаток, 0) КАК Количество
|ИЗ
|	НоменклатураДокумента КАК НоменклатураДокумента
…
Кроме того, понадобится изменить последний запрос, который при оперативном проведении проверяет, не появились ли отрицательные остатки. Теперь вы будете получать остатки не «вообще» для номенклатуры из табличной части документа, а для номенклатуры именно с тем набором свойств, который указан в строках документа (листинг 16.6).
Листинг 16.6. Контроль отрицательных остатков при оперативном проведении
…
Запрос3.Текст = "ВЫБРАТЬ
|	ОстаткиМатериаловОстатки.Материал,
|    ОстаткиМатериаловОстатки.НаборСвойств,
|	ОстаткиМатериаловОстатки.КоличествоОстаток
|ИЗ
|	РегистрНакопления.ОстаткиМатериалов.Остатки( , (Материал, НаборСвойств) В
|     	(ВЫБРАТЬ
|          	НоменклатураДокумента.Номенклатура,
|              НоменклатураДокумента.НаборСвойств
|     	ИЗ
|          	НоменклатураДокумента) И Склад = &Склад)
|	КАК ОстаткиМатериаловОстатки
|ГДЕ
|	ОстаткиМатериаловОстатки.КоличествоОстаток < 0";
 
Запрос3.УстановитьПараметр("Склад", Склад);
 
РезультатЗапроса = Запрос3.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
Сообщение = Новый СообщениеПользователю();
Сообщение.Текст = "Не хватает " + Строка(- ВыборкаДетальныеЗаписи.КоличествоОстаток) + " единиц материала """ + ВыборкаДетальныеЗаписи.Материал + """" + " из набора свойств """ + ВыборкаДетальныеЗаписи.НаборСвойств + """";
Сообщение.Сообщить();
 
Отказ = Истина;
 
КонецЦикла;
…

### Приход/расход номенклатуры с учетом характеристик
Теперь запустите проект в режиме отладки и укажите наборы свойств при приходовании материалов.
Откройте документ Приходная накладная № 2 и укажите, что были закуплены белый электрический кабель в количестве 2 шт. и 5 шт. польских резиновых шлангов.
Затем скопируйте первую строку документа и укажите, что был закуплен еще и черный электрический кабель в количестве 3 шт. (в процессе ввода вам придется создать еще один набор свойств для электрического кабеля – Черные кабели, у которого Цвет – Черный и Сечение – 2,5) – рис. 16.33.

Рис. 16.33. Документ «Приходная накладная № 2» {https://ai2b.pro/wp-content/uploads/1/16_33.png}

Нажмите Провести, затем Остатки материалов в панели навигации формы документа и проверьте движения документа по регистру ОстаткиМатериалов (рис. 16.34).

Рис. 16.34. Движения документа «Приходная накладная № 2» по регистру «Остатки материалов» {https://ai2b.pro/wp-content/uploads/1/16_34.png}

Теперь откройте документ Оказание услуги № 1 и укажите, что был израсходован польский резиновый шланг (рис. 16.35).

Рис. 16.35. Документ «Оказание услуги № 1» {https://ai2b.pro/wp-content/uploads/1/16_35.png}

Нажмите Провести, затем Остатки материалов в панели навигации формы документа и проверьте движения документа по регистру ОстаткиМатериалов (рис. 16.36).

Рис. 16.36. Движения документа «Оказание услуги № 1» по регистру «Остатки материалов» {https://ai2b.pro/wp-content/uploads/1/16_36.png}


### Отчет, использующий характеристики
Для полного завершения картины вы создадите отчет, который будет показывать вам наличие материалов с теми или иными свойствами. При создании этого отчета вы будете использовать те возможности, которые предоставляет вам система компоновки данных для работы с характеристиками (рис. 16.37).

Рис. 16.37. Результат отчета {https://ai2b.pro/wp-content/uploads/1/16_37.png}

Коротко говоря, набором данных для системы компоновки данных будет довольно простой запрос к регистру ОстаткиМатериалов. А свойства вариантов номенклатуры платформа задействует в этом отчете автоматически на основании того описания, которое вы создали у справочника ВариантыНоменклатуры (см. раздел «Описание характеристик вариантов номенклатуры»).
Система компоновки данных сама сформирует достаточно понятный и удобный интерфейс для работы с характеристиками и в зависимости от значений, выбранных пользователем, будет формировать необходимые запросы к базе данных.
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем ОстаткиМатериаловПоСвойствам и запустите конструктор схемы компоновки данных. Добавьте набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
В качестве источника данных для запроса выберите виртуальную таблицу регистра накопления ОстаткиМатериалов.ОстаткиИОбороты. Из этой таблицы выберите следующие поля (рис. 16.38):
Материал,
НаборСвойств,
КоличествоНачальныйОстаток,
КоличествоПриход,
КоличествоРасход,
КоличествоКонечныйОстаток.

Рис. 16.38. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/16_38.png}

После этого на закладке Объединения/Псевдонимы задайте псевдонимы числовых полей без слова Количество (рис. 16.39).

Рис. 16.39. «Объединения/Псевдонимы» {https://ai2b.pro/wp-content/uploads/1/16_39.png}

На этом создание запроса закончено. Нажмите ОK.

##### Ресурсы
В схеме компоновки данных на закладке Ресурсы выберите все доступные ресурсы (рис. 16.40).

Рис. 16.40. Описание ресурсов {https://ai2b.pro/wp-content/uploads/1/16_40.png}


##### Настройки
На закладке Настройки добавьте в структуру отчета группировку Детальные записи.
На закладке Выбранные поля выберите те поля, которые будут выводиться в отчет: Материал, НаборСвойств, НачальныйОстаток, Приход, Расход и КонечныйОстаток (рис. 16.41).

Рис. 16.41. Группировки и поля отчета {https://ai2b.pro/wp-content/uploads/1/16_41.png}

На закладке Другие настройки задайте заголовок отчета – Остатки материалов по свойствам.
Чтобы иметь возможность протестировать отчет, включите настройку Отбор в быстрые пользовательские настройки.
Для этого нажмите кнопку Свойства элемента пользовательских настроек, расположенную вверху в командной панели окна настроек.
В появившемся окне вы можете редактировать состав пользовательских настроек отчета. Установите признак использования для настройки Отбор и оставьте предложенное для нее по умолчанию свойство Режим редактирования в значении Быстрый доступ (рис. 16.42).

Рис. 16.42. Состав пользовательских настроек {https://ai2b.pro/wp-content/uploads/1/16_42.png}

На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистемы Учет материалов и Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите, какие результаты можно получить с помощью вашего отчета.
В разделе Учет материалов откройте отчет Остатки материалов по свойствам (рис. 16.43).

Рис. 16.43. Форма отчета {https://ai2b.pro/wp-content/uploads/1/16_43.png}

Вы видите настройку Отбор, расположенную в отчетной форме, с помощью которой вы можете получать остатки материалов в разрезе их характеристик.
Сначала посмотрите, какие у вас есть материалы с сечением 2,5 мм?.
Для этого в поле Отбор нажмите кнопку выбора  (рис. 16.43). В появившемся окне Редактирование отбора слева вы видите список доступных полей отчета.
Раскройте поле Набор свойств (рис. 16.44).
Обратите внимание, что к стандартным реквизитам справочника ВариантыНоменклатуры система компоновки данных добавила все характеристики, которые определены вами для различных наборов свойств в базе данных: Производитель, Сечение и Цвет. Таким образом, отбор в отчете по значениям каких-либо характеристик является достаточно простым и интуитивно понятным.
Чтобы узнать, какие у вас есть материалы с сечением 2,5 мм?, достаточно выбрать поле Сечение, мм2 и задать для него условие равенства 2,5 (рис. 16.44).

Рис. 16.44. Создание отбора {https://ai2b.pro/wp-content/uploads/1/16_44.png}

Нажмите ОК. В окне отчета нажмите Сформировать. Вы получите следующий результат (рис. 16.45).

Рис. 16.45. Результат отчета {https://ai2b.pro/wp-content/uploads/1/16_45.png}

Затем посмотрите, какие у вас есть материалы черного цвета. Для этого в поле настройки Отбор еще раз нажмите кнопку выбора  и удалите прежний отбор из контекстного меню.
Затем двойным щелчком мыши выберите из списка доступных полей поле Цвет. В поле Значение выберите из списка дополнительных свойств номенклатуры значение Черный (рис. 16.46).

Рис. 16.46. Создание отбора {https://ai2b.pro/wp-content/uploads/1/16_46.png}

Нажмите ОК. В окне отчета нажмите Сформировать. Вы получите следующий результат (рис. 16.47).

Рис. 16.47. Результат отчета {https://ai2b.pro/wp-content/uploads/1/16_47.png}

И в заключение, чтобы убедиться в правильности работы отчета, посмотрите, сколько у вас резиновых шлангов черного цвета.
В поле настройки Отбор еще раз нажмите кнопку выбора  и добавьте еще один элемент отбора. Для этого двойным щелчком мыши выберите из списка доступных полей поле Материал.
Затем в поле Значение выберите из списка номенклатуры значение Шланг резиновый (рис. 16.48).

Рис. 16.48. Создание отбора {https://ai2b.pro/wp-content/uploads/1/16_48.png}

Нажмите ОК. В окне отчета нажмите Сформировать. Вы получите следующий результат (рис. 16.49).

Рис. 16.49. Результат отчета {https://ai2b.pro/wp-content/uploads/1/16_49.png}

Таким образом, вы наглядно убедились в том, что при использовании данной логической схемы можно вести учет материалов в произвольном количестве разрезов свойств и их значений.
Следует заметить, что пример, рассмотренный в этом занятии, не является законченным решением для данной конфигурации. В нем лишь продемонстрирована возможность ведения такого учета. Для того чтобы ваша конфигурация могла полноценно использовать свойства материалов, необходимо внести соответствующие изменения в остальные регистры, документы и некоторые отчеты.
ПРИМЕЧАНИЕ
Вы можете сравнить свое прикладное решение с эталонным приложением Занятие 16. Как это сделать, описано в разделе «Эталонные проекты».

## Занятие 17 (1:50). Бухгалтерский учет
Продолжительность
Ориентировочная продолжительность занятия – 1 час 50 минут.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала, то можете загрузить приложение Занятие 16, которое должно получиться у вас к этому моменту. Как это сделать, описано в разделе «Эталонные проекты».
На этом занятии вы познакомитесь с возможностью ведения бухгалтерского учета средствами «1С:Предприятия». В рамках этого занятия не будут объясняться и рассматриваться основы бухгалтерского учета. Поэтому если у вас нет знаний бухгалтерии, то, конечно, лучше сначала прочитать какую-нибудь популярную литературу о том, как вообще устроен бухгалтерский учет в нашей стране.
Для организации бухгалтерского учета вы будете использовать уже знакомый вам объект конфигурации – план видов характеристик и два новых объекта: План счетов и Регистр бухгалтерии.
Регистр бухгалтерии будет использоваться вами для накопления данных о совершенных хозяйственных операциях.
С помощью плана счетов вы будете описывать счета, в разрезе которых ведется учет, а план видов характеристик будет служить для описания объектов аналитического учета, в разрезе которых должен вестись учет на счетах.
Надо сразу сказать, что план счетов, который будет использоваться в вашей учебной конфигурации, очень сильно упрощен. Он содержит всего несколько условных счетов, которые, однако, позволят вам познакомиться с основными методами организации бухгалтерского учета средствами «1С:Предприятия».
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### План видов характеристик в бухгалтерском учете
Объект конфигурации План видов характеристик был подробно рассмотрен на предыдущем занятии (см. раздел «Что такое "План видов характеристик"»), а сейчас вы узнаете, как можно использовать этот объект в контексте бухгалтерского учета.
Бухгалтерский учет, как правило, подразумевает ведение аналитического учета на большинстве счетов. Для обозначения разрезов аналитического учета будет использоваться термин виды субконто. То есть на каждом счете учет может вестись в разрезе нескольких видов субконто.
А для обозначения конкретных объектов аналитического учета будет использоваться термин субконто.
Например, на счете 41 (Товары) учет ведется обычно в разрезе номенклатуры и складов, которые являются видами субконто. А вот конкретная номенклатура Паста шоколадная и конкретный склад Основной, указанные для некоторой проводки по счету 41, – это субконто.
Так вот, частным случаем использования плана видов характеристик является применение его для описания видов субконто. То есть все разрезы аналитического учета описываются в соответствующем плане видов характеристик, и там же задаются типы значений, которые могут принимать те или иные субконто.

### Создание плана видов характеристик
Итак, вам нужно создать в вашей конфигурации план видов характеристик, который будет содержать описания разрезов аналитического учета – видов субконто.
Добавьте объект конфигурации – план видов характеристик с именем ВидыСубконто. Включите этот план видов характеристик в подсистему Бухгалтерия.
Поскольку вам понадобится некий вспомогательный справочник, в котором пользователи будут осуществлять «свободное творчество» по созданию значений новых объектов аналитического учета, создайте еще один справочник с именем Субконто.
Затем укажите, что этот справочник будет подчинен плану видов характеристик ВидыСубконто (рис. 17.1).

Рис. 17.1. Окно редактирования справочника «Субконто» {https://ai2b.pro/wp-content/uploads/1/17_01.png}
Затем установите свойство Тип плана видов характеристик ВидыСубконто. Задайте составной тип данных следующим образом (рис. 17.2):
СправочникСсылка.Клиенты,
СправочникСсылка.Номенклатура,
СправочникСсылка.Субконто.

Рис. 17.2. Выбор типа значения характеристик плана вида характеристик {https://ai2b.pro/wp-content/uploads/1/17_02.png}
Бухгалтерия ООО «На все руки мастер» ведет учет движения денежных средств только в разрезе материалов и клиентов, но не исключено, что в дальнейшем понадобится дополнительная аналитика (поэтому вы и используете справочник Субконто).
Обратите внимание, что тот справочник, который будет использован в качестве дополнительных значений характеристик, тоже должен входить в составной тип данных типа значений характеристик, иначе 1С:EDT выдаст сообщение об ошибке.
Затем укажите, что Дополнительные значения характеристик будут находиться в справочнике Субконто.
После этого начните ввод предопределенных значений плана видов характеристик, то есть тех видов аналитического учета, в разрезе которых вы будете вести учет.
На закладке Предопределенные данные создайте следующие предопределенные виды субконто (рис. 17.3):
Материалы с кодом 000000001 и типом СправочникСсылка.Номенклатура;
Клиенты с кодом 000000002 и типом СправочникСсылка.Клиенты.

Рис. 17.3. Предопределенные виды характеристик {https://ai2b.pro/wp-content/uploads/1/17_03.png}
На этом создание видов субконто завершено, и вы можете перейти к знакомству со следующим объектом конфигурации, который будет использован вами, – План счетов.

### Что такое «План счетов»
Объект конфигурации План счетов предназначен для описания структуры хранения информации о совокупности синтетических счетов предприятия, которые созданы для группировки данных о его хозяйственной деятельности.
На основе объекта конфигурации План счетов платформа создает в базе данных таблицы, в которых будет храниться информация о том, какие счета и каким образом будет использовать предприятие.
Это может быть система бухгалтерских счетов, установленная государством, план управленческих счетов или произвольный набор счетов, используемых для анализа тех или иных видов деятельности предприятия.
План счетов в системе «1С:Предприятие» поддерживает иерархию субсчетов: к каждому счету первого уровня может быть открыто несколько субсчетов, которые, в свою очередь, могут иметь свои субсчета, и так далее.
Например, законодательно утвержденный план счетов для ведения бухучета в России имеет следующий вид (рис. 17.4).

Рис. 17.4. Российский план счетов {https://ai2b.pro/wp-content/uploads/1/17_04.png}
По любому счету или субсчету может вестись аналитический учет в разрезе субконто, описанных в плане видов характеристик. Связь между планом счетов и планом видов характеристик задается разработчиком на этапе конфигурирования.
Для описания используемых субконто система создает в плане счетов специальную табличную часть ВидыСубконто, которая не видна в 1С:EDT (но доступна средствами встроенного языка).
Для каждого счета есть возможность задать несколько видов учета (например, количественный и валютный). Виды учета задаются при помощи подчиненных объектов конфигурации Признак учета.
Также существует возможность определить несколько видов учета субконто (например, суммовой, валютный или количественный). Виды учета субконто задаются при помощи подчиненных объектов конфигурации Признак учета субконто.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с планами счетов, можно прочитать в разделе «Краткий справочник разработчика. Планы счетов».
Помимо всего вышеперечисленного каждый счет может иметь набор свойств, которые задаются в качестве реквизитов объекта конфигурации План счетов. Они позволяют определять уникальные свойства элементов плана счетов (например, реквизит ЗапретитьИспользоватьВПроводках).

### Создание плана счетов
Как уже говорилось в начале этого занятия, бухгалтерский учет в ООО «На все руки мастер» сильно упрощен. Поэтому план счетов, по которому работает бухгалтерия, будет содержать всего четыре счета:
Товары,
РасчетыСПоставщиками,
Капитал,
Дебиторская задолженность.
Добавьте объект конфигурации – план счетов с именем Основной. Свойство Представление списка задайте как Основной план счетов.
Включите этот план счетов в подсистему Бухгалтерия.
Затем создайте признак учета плана счетов с именем Количественный (рис. 17.5).

Рис. 17.5. Создание реквизита плана счетов в группе «Признаки учета» {https://ai2b.pro/wp-content/uploads/1/17_05.png}
Также создайте признак учета субконто Количественный.
В свойстве ВидыСубконто укажите, что виды субконто для этого плана счетов будут находиться в плане видов характеристик ВидыСубконто. Максимальное количество субконто на счете установите равным двум (рис. 17.6).

Рис. 17.6. Установка свойств «Субконто для плана счетов» {https://ai2b.pro/wp-content/uploads/1/17_06.png}
Затем создайте четыре предопределенных счета (при создании каждого счета, перед тем как нажать Создать, нужно выделить корень структуры счетов – строку Счета):
Товары, код 41, активный, с количественным учетом в разрезе материалов (рис. 17.7).

Рис. 17.7. Предопределенный счет «Товары» {https://ai2b.pro/wp-content/uploads/1/17_07.png}
РасчетыСПоставщиками, код 60, активный/пассивный (рис. 17.8).

Рис. 17.8. Предопределенный счет «РасчетыСПоставщиками» {https://ai2b.pro/wp-content/uploads/1/17_08.png}
ДебиторскаяЗадолженность, код 62, активный/пассивный, в разрезе клиентов (рис. 17.9).

Рис. 17.9. Предопределенный счет «ДебиторскаяЗадолженность» {https://ai2b.pro/wp-content/uploads/1/17_09.png}
Капитал, код 90, активный/пассивный (рис. 17.10).

Рис. 17.10. Предопределенный счет «Капитал» {https://ai2b.pro/wp-content/uploads/1/17_10.png}
В результате план счетов ООО «На все руки мастер» будет выглядеть следующим образом (рис. 17.11).

Рис. 17.11. План счетов «Основной» {https://ai2b.pro/wp-content/uploads/1/17_11.png}
Теперь вы можете перейти к знакомству с последним объектом конфигурации, который понадобится вам для организации бухгалтерского учета, – регистром бухгалтерии.
Узнай больше!
Для плана счетов можно установить свойство «Автопорядок по коду». Это свойство используется для того, чтобы указать системе, что упорядочивание по полю «Порядок» должно всегда подставляться в тех случаях, когда пользователь или разработчик выбирает упорядочивание по коду. Его нужно использовать прежде всего тогда, когда с точки зрения пользователя нужно упорядочивать план счетов по коду с учетом разделителей кода счета. Например, если счета 10.11 и 10.2 упорядочивать по коду счета, то счета будут располагаться так:
10.11
10.2
Это правильно с точки зрения сортировки строк, но не соответствует логическому смыслу кодов.
Но если заданы значения поля «Порядок» 10.11 и 10. 2 (перед 2 – пробел) и установлено свойство «Автопорядок по коду», то при выборе упорядочивания по коду пользователь будет фактически получать порядок, учитывающий разделители:
10.2
10.11
Если свойство не устанавливать, то нужно будет в явном виде выбирать упорядочивание по полю «Порядок».

### Что такое регистр бухгалтерии
Объект конфигурации Регистр бухгалтерии предназначен для описания структуры накопления данных, учет которых ведется исходя из некоторого плана счетов. На основе объекта конфигурации Регистр бухгалтерии платформа создает в базе данных таблицу, в которой будут накапливаться данные о хозяйственных операциях, отображаемых в бухгалтерском учете.
По своему виду регистр бухгалтерии напоминает регистр накопления: он также имеет ресурсы, может иметь измерения и реквизиты.
Измерения позволяют разделять ведение учета (например, используя измерение Организация, можно вести учет в разрезе нескольких юридических лиц).
Реквизиты служат признаком, по которому одни записи регистра можно отделить от других (например, в качестве реквизита может использоваться номер журнала, что позволит отбирать проводки, имеющие одинаковый смысл).
Значительное отличие от регистра накопления заключается в том, что регистр бухгалтерии имеет жесткую связь с используемым планом счетов. Поэтому каждая запись регистра бухгалтерии содержит дополнительные поля, определяемые настройкой используемого плана счетов.
Например, запись регистра может содержать дополнительные поля для указания корреспондирующих счетов, сумм, объектов аналитического учета (субконто), количества, вида валюты и т. д.
Кроме того, отличительной чертой регистра бухгалтерии является возможность поддержки механизма двойной записи, при которой каждая запись регистра содержит обязательные поля для указания счета дебета и счета кредита.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с регистрами бухгалтерии, можно прочитать в разделе «Краткий справочник разработчика. Регистры бухгалтерии».

### Создание регистра бухгалтерии
Добавьте объект конфигурации – регистр бухгалтерии с именем Управленческий.
Свойство Расширенное представление списка задайте как Движения в регистре Управленческий.
Укажите, что с ним будет связан план счетов Основной.
Установите флажок Корреспонденция (рис. 17.12).

Рис. 17.12. Основные свойства регистра бухгалтерии {https://ai2b.pro/wp-content/uploads/1/17_12.png}
Флажок Корреспонденция будет говорить о том, что создаваемый вами регистр поддерживает корреспонденцию. Это означает, что каждая запись регистра имеет дебетовую и кредитовую часть, что позволит вам получать информацию не только об остатках и оборотах по счетам, но и о корреспонденциях между счетами.
Регистры, не поддерживающие корреспонденцию, применяются тогда, когда не нужно использовать принцип двойной записи, регламентированный в бухгалтерском учете, и, соответственно, контролировать баланс хозяйственных средств и их источников.
Включите регистр в подсистему Бухгалтерия.
Теперь создайте у регистра бухгалтерии два ресурса:
Сумма, длина 15, точность 2, Балансовый;
Количество, длина 15, точность 3, небалансовый, Признак учета – Количественный, Признак учета субконто – Количественный (рис. 17.13).

Рис. 17.13. Свойства ресурса «Количество» регистра бухгалтерии {https://ai2b.pro/wp-content/uploads/1/17_13.png}
В заключение настройте командный интерфейс. В разделе Бухгалтерия включите видимость команды Управленческий и мышью перетащите ее в группу Панель навигации.См.также после всех регистров, созданных вами ранее.
На этом создание регистра бухгалтерии завершено.
Теперь настало время познакомиться с тем, каким образом используется созданный вами регистр бухгалтерии Управленческий.

### Доработка приходной накладной
Что вас ждет дальше?
Сначала вы доработаете оба ваших документа (ПриходнаяНакладная и ОказаниеУслуги) так, чтобы они «поставляли» данные не только для регистров накопления, но и для регистра бухгалтерии.
Затем вы создадите бухгалтерский отчет Оборотно-сальдовая ведомость, который будет показывать вам движение денежных средств в ООО «На все руки мастер», основываясь на данных регистра бухгалтерии.
При проведении ваши документы будут создавать следующие бухгалтерские проводки – записи в регистре бухгалтерии (таблица 17.1).
Таблица 17.1. Проводки, создаваемые документами












































Эти проводки вы отразите при создании движений документов в регистре бухгалтерии.
Итак, сначала измените процедуру проведения документа ПриходнаяНакладная, а затем прикладном решении перепроведите все эти документы, чтобы отработал новый, измененный вами алгоритм проведения документа ПриходнаяНакладная.
#### В 1C:EDT
В список регистров, в которых документ ПриходнаяНакладная будет создавать движения, добавьте регистр бухгалтерии Управленческий.
Откройте модуль документа ПриходнаяНакладная и внесите изменения в процедуру обработчика события ОбработкаПроведения. В самом конце цикла перед строкой КонецЦикла добавьте строки кода, создающие движения регистра Управленческий (листинг 17.1).
Листинг 17.1. Движения документа «ПриходнаяНакладная» (фрагмент)
// Регистр Управленческий
Движение = Движения.Управленческий.Добавить();
Движение.СчетДт = ПланыСчетов.Основной.Товары;
Движение.СчетКт = ПланыСчетов.Основной.РасчетыСПоставщиками;
Движение.Период = Дата;
Движение.Сумма = ТекСтрокаМатериалы.Сумма;
Движение.КоличествоДт = ТекСтрокаМатериалы.Количество;
Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Материалы] = ТекСтрокаМатериалы.Материал;
Перед началом цикла установите свойство Записывать набора записей регистра Управленческий в значение Истина для записи изменений регистра в базу данных.
В результате процедура ОбработкаПроведения() будет выглядеть следующим образом (листинг 17.2).
Листинг 17.2. Движения документа «ПриходнаяНакладная»
Процедура ОбработкаПроведения(Отказ, Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
Движения.Управленческий.Записывать = Истина;
 
Для Каждого ТекСтрокаМатериалы Из Материалы Цикл
 
// Регистр ОстаткиМатериалов Приход
Движение = Движения.ОстаткиМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
Движение.Период = Дата;
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.НаборСвойств = ТекСтрокаМатериалы.НаборСвойств;
Движение.Склад = Склад;
Движение.Количество = ТекСтрокаМатериалы.Количество;
 
// Регистр Стоимость Материалов Приход
Движение = Движения.СтоимостьМатериалов.Добавить();
Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
Движение.Период = Дата;
Движение.Материал = ТекСтрокаМатериалы.Материал;
Движение.Стоимость = ТекСтрокаМатериалы.Сумма;
 
// Регистр Управленческий
Движение = Движения.Управленческий.Добавить();
Движение.СчетДт = ПланыСчетов.Основной.Товары;
Движение.СчетКт = ПланыСчетов.Основной.РасчетыСПоставщиками;
Движение.Период = Дата;
Движение.Сумма = ТекСтрокаМатериалы.Сумма;
Движение.КоличествоДт = ТекСтрокаМатериалы.Количество;
Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Материалы] = ТекСтрокаМатериалы.Материал;
 
КонецЦикла;
 
КонецПроцедуры
Как видите, движения для регистра бухгалтерии формируются таким же образом, как и для регистра накопления.
Но платформа (при создании таблицы хранения данных) добавила к созданным вами реквизитам регистра еще ряд полей, которые явились следствием использования плана счетов Основной.
Прежде всего, это поля СчетДт и СчетКт. В этих полях указываются счета, дебет и кредит которых затрагивает данная проводка.
Кроме того, для измерений и ресурсов регистра, связанных с признаками учета, платформа создает пару полей для хранения значения каждого ресурса отдельно по дебету и отдельно по кредиту проводки: КоличествоДт и КоличествоКт. А также для счетов, по которым ведется учет в разрезе субконто, платформа создает коллекции СубконтоДт и СубконтоКт.
Если обратиться к таблице 17.1, то при проведении приходной накладной счетом по дебету должен быть счет Товары (41), а счетом по кредиту – счет РасчетыСПоставщиками (60).
К счету вы обращаетесь с помощью свойства глобального контекста ПланыСчетов. Оно предоставляет доступ ко всем планам счетов, созданным в конфигурации. Через точку от него вы указываете имя нужного вам плана счетов – Основной. А далее, тоже через точку, указываете имя предопределенного счета в этом плане счетов – Товары. Этот счет (и три других) вы создали ранее в 1С:EDT.
Так как количественный учет у вас ведется только для счета Товары (41), поле регистра КоличествоДт заполняется количеством товара из табличной части документа. Поле регистра КоличествоКт не заполняется, так как по счету кредита проводки (РасчетыСПоставщиками) количественный учет не ведется.
Теперь обратите внимание на последнюю строку цикла, в которой присваивается значение субконто дебета.
Дело в том, что количество субконто на счете дебета и на счете кредита в каждой проводке будет различное в зависимости от того, как определены счета в используемом плане счетов. Поэтому для каждой записи движения регистра бухгалтерии платформа хранит две коллекции значений: коллекцию субконто дебета и коллекцию субконто кредита. Каждая из них содержит ровно столько элементов, сколько видов субконто указано использовать для соответствующего счета (дебета или кредита) в плане счетов.
Обратиться к элементу коллекции можно, указав в квадратных скобках ссылку на соответствующий вид субконто (ПланыВидовХарактеристик.ВидыСубконто.Материалы).
Другой способ – в явном виде указать имя предопределенного вида субконто через точку от коллекции субконто дебета.
Другими словами, запись Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Материалы] равносильна записи Движение.СубконтоДт.Материалы.
Коллекция регистра СубконтоКт не заполняется, так как по счету кредита проводки (РасчетыСПоставщиками) учет в разрезе субконто у вас не ведется.
В заключение установите видимость команды Управленческий в панели навигации формы документа, в группе Перейти.

#### В прикладном решении
Запустите проект в режиме отладки.
Откройте документ Приходная накладная № 1 и нажмите Провести.
Нажмите Управленческий и посмотрите, какие движения сформировал документ в регистре бухгалтерии (рис. 17.14, 17.15).

Рис. 17.14. Движения документа «Приходная накладная № 1» в регистре бухгалтерии «Управленческий» {https://ai2b.pro/wp-content/uploads/1/17_14.png}

Рис. 17.15. Движения документа «Приходная накладная № 1» в регистре бухгалтерии «Управленческий» {https://ai2b.pro/wp-content/uploads/1/17_15.png}
Обратите внимание: поскольку на счете 60 (РасчетыСПоставщиками) отсутствует аналитика и ведется только суммовой учет, в записях движений регистра Субконто1Кт, Субконто2Кт и КоличествоКт не указаны.
После этого перепроведите документ Приходная накладная № 2 и убедитесь, что он тоже формирует правильные проводки по регистру бухгалтерии Управленческий.
Теперь вам нужно выполнить более сложную задачу: добавить движения по регистру Управленческий в документ ОказаниеУслуги.

### Доработка документа «Оказание услуги»
Сначала вам нужно изменить процедуру проведения документа ОказаниеУслуги, а затем в прикладном решении перепровести все эти документы, чтобы отработал новый, измененный вами алгоритм проведения документов Оказание услуги.
#### В 1C:EDT
В отличие от документа ПриходнаяНакладная, который создавал всего одну бухгалтерскую проводку, документ ОказаниеУслуги будет создавать уже две.
Как уже говорилось, бухгалтерия вашего ООО «На все руки мастер» не совсем похожа на настоящую, потому что для облегчения работы она учитывает только движения материалов. Услуги, которые оказывает организация, для нее как бы не существуют.
Поэтому документ ОказаниеУслуги будет формировать движения по регистру бухгалтерии только в той части, которая касается расходования материалов.
В список регистров, в которых документ ОказаниеУслуги будет создавать движения, добавьте регистр бухгалтерии Управленческий.
Откройте модуль документа ОказаниеУслуги и внесите изменения в процедуру обработчика события ОбработкаПроведения. Поскольку вас интересует только движение материалов, для внесения дополнений подойдет тело условия Если…, в котором вы формировали движения по регистрам ОстаткиМатериалов и СтоимостьМатериалов.
Добавьте в конец условия, перед строкой КонецЕсли, движения по регистру бухгалтерии Управленческий (листинг 17.3).
Листинг 17.3. Движения документа «ОказаниеУслуги» (фрагмент)
…
Если ВыборкаДетальныеЗаписи.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
 
// Регистр ОстаткиМатериалов Расход
…
 
// Регистр СтоимостьМатериалов Расход
…
 
// Регистр Управленческий
// Первая проводка:  Д 62(ДебиторскаяЗадолженность) – К 90 (Капитал) Розничная сумма
Движение = Движения.Управленческий.Добавить();
Движение.СчетДт = ПланыСчетов.Основной.ДебиторскаяЗадолженность;
Движение.СчетКт = ПланыСчетов.Основной.Капитал;
Движение.Период = Дата;
Движение.Сумма = ВыборкаДетальныеЗаписи.СуммаВДокументе;
Движение.СубконтоДт[ПланыВидовХарактеристик.ВидыСубконто.Клиенты] = Клиент;
 
// Вторая проводка: Д 90 (Капитал) – К 41 (Товары) – себестоимость
Движение = Движения.Управленческий.Добавить();
Движение.СчетДт = ПланыСчетов.Основной.Капитал;
Движение.СчетКт = ПланыСчетов.Основной.Товары;
Движение.Период = Дата;
Движение.Сумма = СтоимостьМатериала * ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.КоличествоКт = ВыборкаДетальныеЗаписи.КоличествоВДокументе;
Движение.СубконтоКт[ПланыВидовХарактеристик.ВидыСубконто.Материалы] = ВыборкаДетальныеЗаписи.Номенклатура;
 
КонецЕсли;
…
В первой проводке вы указываете розничную сумму материала из документа и субконто дебета, поскольку на счете Дебиторская задолженность ведется учет в разрезе клиентов.
Во второй проводке вы указываете стоимость материала, количество и субконто кредита, поскольку на счете Товары ведется количественный учет в разрезе материалов.
Теперь в самом начале процедуры установите свойство Записывать регистра бухгалтерии в значение Истина для записи изменений регистра в базу данных (листинг 17.4).
Листинг 17.4. Запись движений регистров
Процедура ОбработкаПроведения(Отказ, Режим)
 
Движения.ОстаткиМатериалов.Записывать = Истина;
Движения.СтоимостьМатериалов.Записывать = Истина;
Движения.Продажи.Записывать = Истина;
Движения.Управленческий.Записывать = Истина;
…
В заключение установите видимость команды Управленческий в панели навигации формы документа.

#### В прикладном решении
Запустите проект в режиме отладки, откройте документ Оказание услуги № 1 и нажмите Провести.
Нажмите Управленческий и посмотрите, какие движения сформировал документ в регистре бухгалтерии (рис. 17.16, 17.17).

Рис. 17.16. Движения документа «Оказание услуги № 1» в регистре бухгалтерии «Управленческий» {https://ai2b.pro/wp-content/uploads/1/17_16.png}

Рис. 17.17. Движения документа «Оказание услуги № 1» в регистре бухгалтерии «Управленческий» {https://ai2b.pro/wp-content/uploads/1/17_17.png}
После этого перепроведите остальные документы Оказание услуги.

### Оборотно-сальдовая ведомость
Теперь вам осталось только создать отчет для бухгалтерии предприятия ООО «На все руки мастер», и ваше знакомство с использованием регистра бухгалтерии будет закончено.
Единственный отчет, которым пользуется бухгалтерия вашего предприятия, – это отчет Оборотно-сальдовая ведомость (рис. 17.18).

Рис. 17.18. Результат отчета {https://ai2b.pro/wp-content/uploads/1/17_18.png}

#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем ОборотноСальдоваяВедомость и запустите конструктор схемы компоновки данных. Добавьте набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
Бухгалтерский отчет Оборотно-сальдовая ведомость представляет собой таблицу, в строках которой перечислены все имеющиеся в плане счетов счета, а в колонках – начальное сальдо, оборот и конечное сальдо по дебету и кредиту каждого счета.
Поэтому вам для построения такого отчета понадобятся две исходные таблицы:
объектная (ссылочная) таблица плана счетов Основной;
виртуальная таблица регистра бухгалтерии Управленческий.ОстаткиИОбороты (рис. 17.19).

Рис. 17.19. Таблицы запроса {https://ai2b.pro/wp-content/uploads/1/17_19.png}
Из таблицы Основной выберите поле Ссылка, а из таблицы УправленческийОстаткиИОбороты выберите следующие поля (рис. 17.20):
СуммаНачальныйРазвернутыйОстатокДт,
СуммаНачальныйРазвернутыйОстатокКт,
СуммаОборотДт,
СуммаОборотКт,
СуммаКонечныйРазвернутыйОстатокДт,
СуммаКонечныйРазвернутыйОстатокКт.

Рис. 17.20. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/17_20.png}
Перейдите на закладку Связи и укажите, что из таблицы Основной вы будете выбирать все записи, а из таблицы регистра – только те, которые соответствуют условию связи. Для этого поменяйте расположение таблиц в соединении так, чтобы первой (левой) таблицей была таблица плана счетов Основной (рис. 17.21).

Рис. 17.21. Условие связи таблиц {https://ai2b.pro/wp-content/uploads/1/17_21.png}
Затем на закладке Объединения/Псевдонимы задайте псевдонимы полей отчета: Счет, СальдоНачДт, СальдоНачКт, ОборотДт, ОборотКт, СальдоКонДт и СальдоКонКт (рис. 17.22).

Рис. 17.22. «Объединения/Псевдонимы» {https://ai2b.pro/wp-content/uploads/1/17_22.png}
На этом создание запроса закончено, нажмите ОK.

##### Ресурсы
На закладке Ресурсы с помощью кнопки Добавить все ресурсы (>>) выберите все доступные ресурсы.

##### Параметры
Бухгалтерские отчеты, как правило, формируются за определенный период: месяц, квартал, год и т. д. Поэтому в вашем отчете будет использоваться стандартный период для указания периода отчета.
На закладке Параметры добавьте параметр с именем Период типа СтандартныйПериод, а для параметров НачалоПериода и КонецПериода укажите Выражение для расчета и запретите их редактирование пользователем (листинг 17.5).
Листинг 17.5. Выражение для расчета параметров «НачалоПериода» и «КонецПериода»
&Период.ДатаНачала
&Период.ДатаОкончания
Поскольку бухгалтерские отчеты всегда формируются за определенный период, для параметра Период в колонке Использование укажите значение Всегда. В результате в отчетной форме не будет доступен признак использования отчетного периода (флажок слева от параметра), и параметр будет использоваться всегда, независимо от желания пользователя.
Таким образом, параметры компоновки данных примут вид (рис. 17.23):

Рис. 17.23. Параметры схемы компоновки данных {https://ai2b.pro/wp-content/uploads/1/17_23.png}
Заметьте, что даты начала и конца стандартного периода также содержат и время. Однако здесь, в отличие от параметров НачалоПериода и КонецПериода, начальная дата имеет время 00:00:00, а конечная дата – 23:59:59. Таким образом, последний день включается в отчет, и не нужно использовать функцию КонецПериода().

##### Настройки
В заключение создайте структуру отчета на закладке Настройки. Добавьте группировку, содержащую детальные записи. Затем на закладке Выбранные поля выберите поле Счет, затем реквизит этого поля Наименование (для этого раскройте поле Счет), а также все остальные поля для вывода в отчет и разместите их в следующем порядке (рис. 17.24):

Рис. 17.24. Поля и группировки отчета {https://ai2b.pro/wp-content/uploads/1/17_24.png}
На закладке Другие настройки укажите заголовок отчета – Оборотно-сальдовая ведомость. Для параметра Расположение общих итогов по вертикали укажите значение Начало и конец.
Затем на закладке Параметры выберите для параметра Период значение из списка стандартных периодов – Этот год.
Тем самым вы обеспечите, что при открытии формы отчета в настройке отчетного периода всегда будет указан текущий год. Причем даты начала и конца периода будут динамически меняться в зависимости от даты выполнения отчета. А также, нажав кнопку Свойства элемента пользовательских настроек, укажите, что параметр Период будет включен в пользовательские настройки и эта настройка будет находиться непосредственно в отчетной форме (режим редактирования Быстрый доступ) (рис. 17.25).
. 
Рис. 17.25. Создание быстрых настроек отчетного периода {https://ai2b.pro/wp-content/uploads/1/17_25.png}
На этом работа с макетом схемы компоновки завершена.
В заключение включите отчет в подсистему Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите, как работает отчет.
В разделе Бухгалтерия откройте отчет и нажмите Сформировать (рис. 17.26).

Рис. 17.26. Результат отчета {https://ai2b.pro/wp-content/uploads/1/17_26.png}
Вы видите, что стандартный период отчета задан по умолчанию – Этот год. Пользоваться стандартным периодом отчета очень удобно, когда пользователь регулярно выполняет отчет за определенный интервал времени. Тогда можно заранее установить в настройках нужный период, и пользователю не придется задавать его перед формированием отчета. Но при желании в прикладном решении пользователь может выбрать другой период из списка стандартных периодов.

## Занятие 18 (1:00). План видов расчета, регистр расчета
Продолжительность
Ориентировочная продолжительность занятия – 1 час.
На этом занятии вы познакомитесь с объектами конфигурации План видов расчета и Регистр расчета и узнаете об основных понятиях, используемых при создании сложных периодических расчетов.
В конце занятия вы создадите план видов расчета и регистр расчета, которые будут использоваться на следующем занятии для демонстрации работы механизмов периодических расчетов.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Зачем нужны план видов расчета и регистр расчета?
На этом занятии вы узнаете, какие возможности для автоматизации сложных периодических расчетов предоставляет система «1С:Предприятие».
Такие расчеты используются прежде всего при расчете заработной платы. Поэтому дальнейшее их рассмотрение будет строиться на примере расчета заработной платы сотрудников, которые работают в вашем ООО «На все руки мастер».
В общем случае сумма заработной платы сотрудника складывается из множества частей (например, оплата по окладу, премии, штрафы, оплаты по больничному листу, разовые выплаты и т. д.). Каждая из этих частей рассчитывается по некоторому алгоритму, присущему только этой части.
Например, сумма штрафа может определяться просто фиксированной суммой, сумма премии может рассчитываться как процент от оклада, а сумма оплаты по окладу рассчитывается исходя из количества рабочих дней в месяце и количества дней, отработанных сотрудником. Поэтому для обозначения каждой такой части будет использоваться термин вид расчета.
Алгоритм каждого вида расчета опирается в общем случае на две категории параметров: период, за который нужно получить конечные данные, и набор некоторых исходных данных, используемых при расчете.
Как правило, в реальной жизни различные виды расчета существуют не сами по себе, а оказывают некоторое влияние на другие виды расчета. Исходя из того, что вид расчета опирается на две различные категории параметров, такое влияние тоже имеет двойственный характер.
#### Зависимость по базовому периоду
Это может быть влияние на исходные данные, используемые при расчете.
В качестве примера можно привести начисление премии в виде процента от оплаты по окладу. При изменении оплаты по окладу размер премии тоже должен быть пересчитан исходя из новой суммы начисленного оклада. Другими словами, сумма начисленного оклада является базой для расчета премии.
Причем, поскольку оклад рассчитывается за некоторый период, при расчете премии интересно знать не значение оклада вообще, а сумму, начисленную в том периоде, который влияет на расчет премии. Такой период будет называться базовым, а подобная зависимость между видами расчета – зависимостью по базовому периоду.
Например, вам нужно начислить премию за октябрь. Премия должна начисляться в размере 10 % от суммы, начисленной в качестве оплаты по окладу. Следовательно, необходимо проанализировать все записи о начислениях оплаты по окладу, которые попадают в интересующий вас базовый период, а именно октябрь.
Допустим, общая сумма таких начислений составила 79 800 рублей – в этом случае премия должна быть начислена в размере 7 980 рублей (рис. 18.1).

Рис. 18.1. Зависимость премии от оклада по базовому периоду {https://ai2b.pro/wp-content/uploads/1/18_01.png}

#### Вытеснение по периоду действия
Это влияние может быть не на исходные данные, а на сам период, за который производится расчет.
В качестве примера можно привести расчет оплаты по окладу и невыход на работу. Предположим, вы начислили сотруднику оплату по окладу за октябрь. В этом случае период действия такого расчета будет с 01.10.2022 по 31.10.2022.
После этого вы получили информацию от руководителя отдела, что, оказывается, сотрудник отсутствовал на работе с 1 по 10 октября по неизвестной причине. В этом случае вам нужно будет произвести расчет Невыход (в котором можно рассчитать какие-то удержания с сотрудника).
Но кроме этого необходимо будет пересчитать и оклад сотрудника исходя из того, что фактический период действия расчета Оклад стал теперь с 11.10.2022 по 31.10.2022.
Такое влияние будет называться вытеснением по периоду действия.
В результате, если за полный месяц работы сотруднику должно было быть начислено 79 800 рублей, то теперь, за фактический период работы, начисление составит 57 000 рублей (рис. 18.2).

Рис. 18.2. Запись расчета «Невыход» вытесняет запись расчета «Оклад» по периоду действия {https://ai2b.pro/wp-content/uploads/1/18_02.png}
Таким образом, исходя из двух видов взаимного влияния расчетов, можно сказать, что в общем случае с каждым видом расчета будет связано три периода: период действия, фактический период и базовый период.
Период действия является «запрашиваемым». То есть, указывая период действия, вы подтверждаете, что хотели бы, чтобы результат действовал в этом периоде.
Фактический период – это то, что получилось из периода действия после анализа всех периодов действия расчетов, которые вытесняют ваш по периоду действия.
Базовый период – это период, в котором вы анализируете результаты других расчетов, влияющих на ваш по базовому периоду.
Как видите, взаимное влияние между видами расчетов может быть довольно разнообразным и, что самое сложное, многоуровневым. То есть один вид расчета может влиять на другой, который, в свою очередь, влияет на третий, и т. д.
Очевидно, что в этой ситуации требуется некий универсальный механизм, позволяющий описать каждый из видов расчетов (его алгоритм, влияние на другие виды расчетов, зависимость от других видов расчетов), обеспечить хранение данных, полученных в результате этих расчетов, и контроль необходимости перерасчета результатов зависимых расчетов в случае изменения результатов первичных расчетов.
В системе «1С:Предприятие» такой универсальный механизм реализован при помощи планов видов расчета и регистров расчета.
И первым объектом конфигурации, с которым вы познакомитесь на этом занятии, будет План видов расчета.

### Что такое план видов расчета
Объект конфигурации План видов расчета предназначен для описания структуры хранения информации о возможных видах расчетов. На основе объекта конфигурации План видов расчета платформа создает в базе данных таблицу, в которой будет храниться информация о том, какие существуют виды расчета и каковы взаимосвязи между ними.
Отличительной особенностью плана видов расчета является то, что пользователь в процессе работы может добавлять новые виды расчета. Такая возможность делает механизм периодических расчетов более гибким и позволяет пользователю создавать собственные виды расчета помимо тех, которые заданы разработчиком как предопределенные.
Объект конфигурации План видов расчета имеет свойство Использует период действия. С его помощью определяется, будут ли в этом плане находиться виды расчета, которые могут быть вытеснены по периоду действия.
Если это свойство установлено, то разработчик получает возможность указать для каждого вида расчета те виды, которые вытесняют его по периоду действия.
Следующим важным свойством объекта конфигурации План видов расчета является Зависимость от базы. Оно определяет, будут ли в этом плане находиться зависимые по базовому периоду виды расчета.
Если это свойство установлено, появляется возможность указать, в каком плане видов расчета будут находиться базовые виды расчета и, кроме того, как будет определяться эта зависимость.
Существует возможность указать один из двух видов зависимости от базы: Зависимость по периоду действия и Зависимость по периоду регистрации. Оба вида этой зависимости подробно рассмотрены в разделе «Что такое "Регистр расчета"».
Еще одной важной особенностью плана видов расчета является возможность создания предопределенных видов расчета и описания их взаимного влияния. При этом в общем случае разработчик имеет возможность указать три категории видов расчета, влияющих на предопределенный вид расчета:
Базовые – их результаты должны быть использованы при перерасчете этого вида расчета;
Вытесняющие – вытесняют этот вид расчета по периоду действия;
Ведущие – изменение их результатов должно приводить к необходимости перерасчета этого вида расчета.
Здравый смысл подсказывает, что все базовые виды расчета должны быть включены и в категорию ведущих. Кроме того, ведущие виды расчета могут содержать и некоторые другие виды, косвенно влияющие на данный вид расчета.
Например, существует три вида расчета: Невыход, Оклад и Премия. Невыход вытесняет Оклад по периоду действия, а Премия зависит от оклада по базовому периоду.
В этом случае для премии следует указать базовым видом расчета оклад, а ведущими – оклад и невыход, поскольку изменение результата расчета невыхода приведет к изменению результата оклада, что, в свою очередь, должно привести к изменению результата премии (рис. 18.3).

Рис. 18.3. Взаимное влияние видов расчетов {https://ai2b.pro/wp-content/uploads/1/18_03.png}
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с планом видов расчета, можно прочитать в разделе «Краткий справочник разработчика. Планы видов расчета».

### Создание плана видов расчета
Добавьте объект конфигурации – план видов расчета с именем ОсновныеНачисления. Задайте его свойство Представление списка как Виды расчетов.
Включите план видов расчета в подсистему Расчет зарплаты.
Затем на вкладке Расчет укажите, что он будет использовать период действия и зависеть от базы по периоду действия. В качестве базового плана видов расчета укажите сам этот план, поскольку все ваши виды расчетов будут храниться в единственном плане видов расчета (рис. 18.4).

Рис. 18.4. Использование периода действия, зависимость от базы и базовые планы видов расчета {https://ai2b.pro/wp-content/uploads/1/18_04.png}
Теперь задайте предопределенные виды расчета.
Как и в случае с бухгалтерией, расчеты в вашем ООО «На все руки мастер» будут скромные, поэтому создайте всего три элемента (рис. 18.5):
Невыход – с именем и наименованием Невыход и кодом Невыход;
Оклад – с именем, кодом и наименованием Оклад, с вытесняющим его видом расчета Невыход и ведущим видом расчета Невыход;
Премия – с именем, кодом и наименованием Премия, с базовым видом расчета Оклад и ведущими видами расчета Невыход и Оклад.

Рис. 18.5. Предопределенные виды расчета для плана видов расчета «ОсновныеНачисления» {https://ai2b.pro/wp-content/uploads/1/18_05.png}
Теперь вы познакомитесь со вторым объектом, используемым при реализации механизмов сложных периодических расчетов, – регистром расчета.

### Что такое регистр расчета
Объект конфигурации Регистр расчета предназначен для описания структуры накопления данных, являющихся результатами расчетов. На основе объекта конфигурации Регистр расчета платформа создает в базе данных таблицы, в которых будут накапливаться данные, формируемые различными объектами базы данных.
Отличительной особенностью регистра расчета является то, что он не предназначен для интерактивного редактирования пользователем. Разработчик может при необходимости предоставить пользователю возможность редактировать регистр расчета, но предназначение регистра расчета заключается в том, чтобы его модификация производилась на основе алгоритмов работы объектов базы данных, а не в результате непосредственных действий пользователя.
Как и другие регистры, регистр расчета имеет ресурсы, в которых хранит числовые данные; имеет измерения, в разрезе которых можно получать значения ресурсов регистра; имеет реквизиты, которые характеризуют каждую запись регистра расчета.
Отличительными же особенностями регистра расчета являются его периодичность, возможность использования механизмов вытеснения по периоду действия и зависимости по базовому периоду, а также связь с планом видов расчета. Рассмотрим все эти особенности по порядку.
#### Периодичность
Периодичность регистра расчета может быть определена одним из следующих значений:
День,
Месяц,
Квартал,
Год.
Периодичность регистра расчета определяет промежуток времени, к которому будет относиться каждая запись регистра.
Если указана периодичность День, то каждая запись регистра будет относиться к какому-либо дню; если периодичность – Месяц, то к какому-либо месяцу и т. д.
Для указания факта принадлежности записи к какому-либо периоду регистр имеет служебный реквизит ПериодРегистрации типа Дата. При записи данных в регистр платформа всегда приводит значение этого реквизита к началу того периода, в который он попадает.
Например, если в регистр расчета с периодичностью Месяц записать данные, где ПериодРегистрации задан как 08.04.2022, то регистр сохранит эти данные со значением поля ПериодРегистрации 01.04.2022 (рис. 18.6).

Рис. 18.6. Запись данных из документа в регистр расчета видов расчета {https://ai2b.pro/wp-content/uploads/1/18_06.png}
Если в этой же ситуации периодичность регистра будет Год, сохраненное значение периода регистрации будет 01.01.2022 (рис. 18.7).

Рис. 18.7. Запись данных из документа в регистр расчета видов расчета {https://ai2b.pro/wp-content/uploads/1/18_07.png}

#### Вытеснение по периоду действия
Следующей важной особенностью регистра расчета является возможность использования механизма вытеснения одних записей другими по периоду действия.
При этом для каждой записи регистр расчета формирует фактический период действия, который является в общем случае совокупностью нескольких периодов, расположенных внутри периода действия (рис. 18.8).

Рис. 18.8. Запись расчета «Невыход» вытесняет запись расчета «Оклад» по периоду действия {https://ai2b.pro/wp-content/uploads/1/18_08.png}
Если рассмотреть структуру записей таблиц регистра расчета, то после внесения записи о начислении по окладу таблицы регистра будут выглядеть следующим образом (таблицы 18.1, 18.2).
Таблица 18.1. Таблица регистра расчета












Таблица 18.2. Таблица фактического периода действия












После добавления в регистр записи вида расчета Невыход, который вытесняет вид расчета Оклад по периоду действия, записи о начислении по окладу примут следующий вид (таблицы 18.3, 18.4).
Таблица 18.3. Таблица регистра расчета


















Таблица 18.4. Таблица фактического периода действия



















#### Зависимость по базовому периоду
Другим механизмом, который поддерживает регистр расчета, является зависимость записей по базовому периоду. Этот механизм позволяет основывать расчет зависимых (вторичных) записей регистра на данных, полученных в результате расчета первичных записей.
Регистр расчета может поддерживать два вида зависимости от базы: зависимость по периоду действия и зависимость по периоду регистрации.

##### Зависимость по периоду действия
Зависимость по периоду действия означает, что при анализе базовых записей будут выбираться те, для которых найдено пересечение их фактического периода действия и указанного базового периода.
Например, в начале ноября производится расчет зарплаты за октябрь. Премия за октябрь должна быть начислена исходя из оплаты по окладу за октябрь. В этом случае, как правило, используется зависимость по периоду действия (рис. 18.9).

Рис. 18.9. Зависимость по периоду действия {https://ai2b.pro/wp-content/uploads/1/18_09.png}
Следует сделать два замечания к приведенному рисунку.
Поля Начало базового периода и Конец базового периода имеют смысл только для записей тех видов расчета, для которых определена зависимость по базовому периоду (в данном случае для записи расчета премии).
Значение базы, которая будет получена от конкретной влияющей записи, в общем случае не равно результату, который содержит эта запись. База будет рассчитана пропорционально тому, какую часть от фактического интервала влияющей записи составляет перекрывающийся с указанным базовым периодом участок. При этом будут использованы данные графика, связанного с записью.

##### Зависимость по периоду регистрации 
Зависимость по периоду регистрации означает, что при анализе базовых записей будут выбираться те, которые попадают в указанный базовый период значением своего поля Период регистрации.
В качестве примера можно привести расчет штрафов при начислении зарплаты за октябрь. В качестве базы для расчета суммы штрафов должны браться записи о прогулах, зарегистрированные в октябре месяце (это могут быть как записи об октябрьских прогулах, так и записи о прогулах в сентябре). В этом случае, как правило, используется зависимость по периоду регистрации (рис. 18.10).

Рис. 18.10. Зависимость по периоду регистрации {https://ai2b.pro/wp-content/uploads/1/18_10.png}
Важной заключительной особенностью регистра расчета является его связь с планом видов расчета. Именно на основе этой связи работают механизмы вытеснения по периоду действия и зависимости по базовому периоду, поскольку в плане видов расчета описано взаимное влияние видов расчета друг на друга.
У регистра расчета могут существовать подчиненные объекты Перерасчет. Они предназначены для регистрации фактов появления в регистре записей, влияющих на результат расчета уже существующих записей регистра. Объект конфигурации Перерасчет может иметь несколько измерений, каждое из которых устанавливает связь между измерениями данного регистра расчета и влияющих регистров расчета. В частном случае это может быть один и тот же регистр.
В таблице, созданной в базе данных на основе объекта конфигурации Перерасчет, платформа хранит информацию о том, какие записи регистра подлежат перерасчету. Таблицы перерасчета заполняются автоматически – как на основании записей регистров расчета, затронутых ведущими видами расчета, так и на основании записей регистра расчета, для которых изменился фактический период действия. Исходя из этой информации разработчик может принимать решение о необходимости перерасчета записей регистра.
Последним замечанием, которое следует сделать, говоря о регистре расчета, является возможность установки связи регистра расчета с графиком. Такой график должен представлять собой регистр сведений (непериодический, с обязательным измерением типа Дата и ресурсом типа Число), в котором содержится временная схема исходных данных, участвующих в расчетах. Измерениями этого графика могут быть, например, график работы (ссылка на справочник) и дата, а ресурсом – количество рабочих часов в этой дате. В этом случае можно будет связать запись регистра расчета с каким-либо конкретным графиком работы (указав в качестве реквизита записи ссылку на справочник ВидыГрафиковРаботы) и в дальнейшем средствами встроенного языка получать информацию о количестве рабочих часов в периоде действия, фактическом периоде действия или периоде регистрации этой записи.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с регистром расчета, можно прочитать в разделе «Краткий справочник разработчика. Регистры расчета».

### Создание регистра расчета
Прежде чем вы начнете добавлять объект конфигурации, регистр расчета Начисления, вам потребуется создать два дополнительных объекта конфигурации:
регистр сведений ГрафикиРаботы,
справочник ВидыГрафиковРаботы.
Справочник понадобится вам для хранения информации о том, какие графики работы существуют в ООО «На все руки мастер», а регистр сведений – для указания того, какие дни в месяце являются рабочими, поскольку сумма оплаты по окладу будет рассчитываться исходя из того, сколько дней отработал сотрудник в расчетном месяце.

#### В 1C:EDT
Добавьте объект конфигурации – справочник с именем ВидыГрафиковРаботы. Включите этот справочник в подсистему Расчет зарплаты.
Затем создайте в справочнике два предопределенных графика работы (рис. 18.11): ГрафикАдминистрации и ГрафикМастеров.

Рис. 18.11. Предопределенные графики работы {https://ai2b.pro/wp-content/uploads/1/18_11.png}
После этого добавьте объект конфигурации – регистр сведений с именем ГрафикиРаботы.
Этот регистр будет иметь два измерения:
ГрафикРаботы, тип СправочникСсылка.ВидыГрафиковРаботы;
Дата, тип Дата.
Затем добавьте единственный ресурс регистра – Значение с типом Число, длиной 1.
Включите этот регистр сведений в подсистему Расчет зарплаты.
Теперь заполните регистр сведений ГрафикиРаботы данными о рабочих днях графика мастеров.

#### В прикладном решении
Запустите проект в режиме отладки и в разделе Расчет зарплаты нажмите Графики работы. Поочередно создайте 31 запись в регистре (вам нужен график мастеров за октябрь).
Чтобы проще выполнить эту довольно однообразную работу, воспользуйтесь возможностью добавления элементов в регистр копированием текущего элемента (кнопка  – Скопировать (F9)). В качестве измерения ГрафикРаботы вашего регистра выберите предопределенный элемент График мастеров справочника ВидыГрафиковРаботы. В качестве ресурса Значение у рабочих дней проставьте 1, а у выходных – 0 (рис. 18.12).

Рис. 18.12. Записи регистра «Графики работы» {https://ai2b.pro/wp-content/uploads/1/18_12.png}
Теперь все готово для создания регистра расчета.

#### В 1C:EDT
Добавьте объект конфигурации – регистр расчета с именем Начисления. Свойство регистра Расширенное представление списка задайте как Движения в регистре Начисления. В качестве плана видов расчета, используемого регистром, выберите ОсновныеНачисления.
Установите, что регистр будет использовать период действия, график будет задаваться в регистре сведений ГрафикиРаботы, значение графика будет находиться в ресурсе Значение, а дата графика – в измерении Дата.
Укажите, что регистр расчета будет использовать базовый период и периодичность регистра будет Месяц (рис. 18.13).

Рис. 18.13. Свойства регистра расчета «Начисления» {https://ai2b.pro/wp-content/uploads/1/18_13.png}
Включите этот регистр расчета в подсистему Расчет зарплаты.
Затем создайте следующие измерения, ресурсы и реквизиты регистра расчета (рис. 18.14):
измерение Сотрудник, тип СправочникСсылка.Сотрудники, Базовое;
ресурс Результат, тип Число, длина 15, точность 2;
реквизит ГрафикРаботы, тип СправочникСсылка.ВидыГрафиковРаботы, для этого реквизита задайте свойство Связь с графиком по измерению ГрафикРаботы;
реквизит ИсходныеДанные, тип Число, длина 15, точность 2.
Реквизит ГрафикРаботы вы будете использовать для того, чтобы связать запись регистра с используемым графиком работы, а реквизит ИсходныеДанные – чтобы хранить в нем данные, которые могут понадобиться при расчете или перерасчете (в вашем примере это будет расчет оклада).

Рис. 18.14. Измерения, ресурсы и реквизиты регистра расчета {https://ai2b.pro/wp-content/uploads/1/18_14.png}
После этого из контекстного меню регистра расчета добавьте подчиненный ему объект конфигурации – перерасчет с именем Перерасчет.
Из контекстного меню перерасчета создайте измерение Сотрудник, для которого в разделе Связь укажите:
Измерение регистра – Сотрудник;
Данные ведущих регистров – выберите то же самое измерение Сотрудник регистра расчета Начисления (рис. 18.15).

Рис. 18.15. Перерасчеты регистра {https://ai2b.pro/wp-content/uploads/1/18_15.png}
В заключение настройте командный интерфейс. В разделе Расчет зарплаты включите видимость команды Начисления в группе Панель навигации.Обычное.
На этом создание объекта конфигурации, регистра расчета Начисления, завершено.

## Занятие 19 (3:40). Использование регистра расчета
Продолжительность
Ориентировочная продолжительность занятия – 3 часа 40 минут.
Теперь у вас все готово для того, чтобы начать разработку системы расчета заработной платы ООО «На все руки мастер».
В этой главе вы создадите документ, с помощью которого будут выполняться различные виды начислений; узнаете, как и когда платформа формирует записи перерасчета; увидите, как работают механизмы вытеснения по периоду действия и зависимости по базовому периоду.
Кроме того, вы создадите отчет, показывающий начисления сотрудникам ООО «На все руки мастер», и сделаете так, чтобы данные расчетов можно было поддерживать в актуальном состоянии.
В заключение вы познакомитесь с новым элементом формы – Диаграмма Ганта, с помощью которого будет наглядно продемонстрирована работа некоторых механизмов расчета.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Создание документа о начислениях
Для того чтобы иметь возможность регистрировать в базе данных начисления, производимые сотрудникам ООО «На все руки мастер», вам понадобится специальный документ.
#### В 1C:EDT
Добавьте объект конфигурации – документ с именем НачисленияСотрудникам.
Задайте представление объекта как Начисление сотрудникам.
Установите свойства документа, отвечающие за его нумерацию:
Тип номера – Число,
Длина номера – 5.
Включите ваш документ в подсистему Расчет зарплаты.
Затем создайте у документа табличную часть Начисления, содержащую следующие реквизиты:
Сотрудник, тип СправочникСсылка.Сотрудники;
ГрафикРаботы, тип СправочникСсылка.ВидыГрафиковРаботы;
ДатаНачала, тип Дата;
ДатаОкончания, тип Дата;
ВидРасчета, тип ПланВидовРасчетаСсылка.ОсновныеНачисления;
Начислено, Число, длина 15, точность 2.
Реквизиты ДатаНачала и ДатаОкончания понадобятся вам для того, чтобы задавать период, в котором должна действовать запись расчета.
Теперь вам нужно сформировать движения документа. Запретите оперативное проведение документа. Для этого установите свойство Оперативное проведение в значение Запретить. После этого укажите, что документ будет создавать движения по регистру расчета Начисления (рис. 19.1).

Рис. 19.1. Движения документа {https://ai2b.pro/wp-content/uploads/1/19_01.png}
Можно сформировать движения документа в регистре с помощью конструктора движений, или же можно их написать руками в модуле объекта, в обработчике события ОбработкаПроведения.
Текст процедуры должен выглядеть следующим образом (листинг 19.1).
Листинг 19.1. Текст процедуры обработчика «ОбработкаПроведения()»
Процедура ОбработкаПроведения(Отказ, Режим)
 
Движения.Начисления.Записывать = Истина;
 
// Регистр Начисления
Для Каждого ТекСтрокаНачисления Из Начисления Цикл
 
Движение = Движения.Начисления.Добавить();
Движение.Сторно = Ложь;
Движение.ВидРасчета = ТекСтрокаНачисления.ВидРасчета;
Движение.ПериодДействияНачало = ТекСтрокаНачисления.ДатаНачала;
Движение.ПериодДействияКонец = КонецДня(ТекСтрокаНачисления.ДатаОкончания);
Движение.ПериодРегистрации = Дата;
Движение.БазовыйПериодНачало = ТекСтрокаНачисления.ДатаНачала;
Движение.БазовыйПериодКонец = КонецДня(ТекСтрокаНачисления.ДатаОкончания);
Движение.Сотрудник = ТекСтрокаНачисления.Сотрудник;
Движение.ГрафикРаботы = ТекСтрокаНачисления.ГрафикРаботы;
Движение.ИсходныеДанные = ТекСтрокаНачисления.Начислено;
 
КонецЦикла;
 
КонецПроцедуры
В целом в этой процедуре нет ничего принципиально нового по сравнению с прежними обработчиками проведения документов, создающими движения регистров.
Начисления – имя регистра расчета, и в выражениях Движения.Начисления.Записывать() и Движения.Начисления.Добавить() вы обращаетесь к методам набора записей этого регистра.
В строке Для Каждого ТекСтрокаНачисления Из Начисления Цикл вы обращаетесь по имени (Начисления) к табличной части вашего документа и обходите в цикле эту табличную часть.
В этом цикле вы добавляете к движениям новую запись и присваиваете ее полям значения из табличной части документа.
Для присвоения значений полям ПериодДействияКонец, БазовыйПериодКонец используется функция КонецДня(). Аналогичным образом вы поступали при создании отчетов, чтобы последний день периода попал в отчет.
В заключение настройте командный интерфейс. В подсистеме Расчет зарплаты сделайте доступной команду Начисление сотрудникам: создать.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите, как работает ваш документ.
В разделе Расчет зарплаты нажмите Создать – Начисление сотрудникам и начислите оклад за октябрь всем сотрудникам ООО «На все руки мастер» (рис. 19.2).

Рис. 19.2. Документ «Начисления сотрудникам № 1»  {https://ai2b.pro/wp-content/uploads/1/19_02.png}
Проведите документ и посмотрите, какие движения он сформировал в регистре Начисления (рис. 19.3, 19.4). На этих рисунках скрыты поля Период регистрации, Сторно и ГрафикРаботы.

Рис. 19.3. Движения документа «Начисление сотрудникам № 1» в регистре расчета «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_03.png}

Рис. 19.4. Движения документа «Начисление сотрудникам № 1» в регистре расчета «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_04.png}
Обратите внимание на то, что платформа привела период регистрации каждой записи к началу периода регистра расчета – началу месяца (в обработчике проведения вы указывали значение даты документа – 02.11.2022).
Кроме этого заметьте, что в каждой записи вы сохранили в реквизите ИсходныеДанные размер оклада сотрудника, введенный в документе, чтобы в дальнейшем рассчитать сумму оплаты по окладу.
Для дальнейшего изучения работы регистра расчета вам понадобится служебный отчет, с помощью которого вы сможете посмотреть содержимое записей перерасчета.

### Иллюстрация механизмов вытеснения и зависимости от базы
#### Отчет по перерасчетам
Добавьте объект конфигурации – отчет с именем Перерасчет. Создайте основную схему компоновки данных отчета, добавьте источник данных – запрос и откройте конструктор запроса.
В списке База данных раскройте ветвь Перерасчеты и из виртуальной таблицы перерасчета Начисления.Перерасчет выберите все поля:
ВидРасчета,
ОбъектПерерасчета,
Сотрудник (рис. 19.5).

Рис. 19.5. Поля и таблицы запроса {https://ai2b.pro/wp-content/uploads/1/19_05.png}
На этом создание запроса закончено, нажмите ОK.
На закладке Настройки добавьте группировку детальных записей. На закладке Выбранные поля выберите для вывода в отчет поля ОбъектПерерасчета, ВидРасчета и Сотрудник.
На этом создание схемы компоновки данных закончено.
В заключение включите отчет в подсистему Расчет зарплаты.

#### Зависимость по базовому периоду
Если сейчас вы выполните отчет в прикладном решении, то увидите, что ни один перерасчет еще не выполнялся.
Поэтому создайте новый документ Начисление сотрудникам № 2, в котором начислите премию за октябрь Гусакову и Деловому (рис. 19.6).

Рис. 19.6. Документ «Начисления сотрудникам № 2» {https://ai2b.pro/wp-content/uploads/1/19_06.png}
Этим документом вы фиксируете тот факт, что сотрудникам Гусакову и Деловому нужно начислить премию по итогам работы за май. Поскольку размер премии вам неизвестен (он будет рассчитываться по некоторому алгоритму), поле Начислено вы оставляете пустым. Нажмите Провести и закрыть.
Теперь снова откройте документ Начисление сотрудникам № 1 и измените оклад Гусакова с 90 300 на 81 900. Нажмите Провести и закрыть.
Затем сформируйте отчет Перерасчет (рис. 19.7).

Рис. 19.7. Отчет «Перерасчет» {https://ai2b.pro/wp-content/uploads/1/19_07.png}
Как видите, отчет теперь содержит какие-то данные.
В самом деле, вид расчета Премия зависит у вас по базовому периоду от вида расчета Оклад. Как только вы изменили существовавшие в регистре записи по виду расчета Оклад, платформа сразу же сформировала набор записей перерасчета, которые должны быть рассчитаны заново, так как изменилась их база.
Вы можете спросить: почему в перерасчет попали записи как про Делового, так и про Гусакова, хотя оклад вы меняли только Гусакову?
Дело в том, что платформа не отслеживает конкретные изменения, которые пользователь внес в записи документа. Она отслеживает лишь факт изменения набора записей регистра расчета в результате проведения (перепроведения) документа.
Поэтому в набор записей перерасчета она включает информацию обо ВСЕХ записях регистра, значение ресурсов которых МОЖЕТ измениться в результате перепроведения документа, создавшего базовые записи регистра.
Перепроведите документ Начисления сотрудникам № 2 (которым вы начисляли премию) и сформируйте отчет Перерасчет.
Он снова не содержит никаких данных: система отметила тот факт, что вы «пересчитали» зависимые записи, и очистила таблицу перерасчета.
На этом примере вы познакомились с работой механизма поддержки зависимости по базовому периоду у регистра расчета.

#### Вытеснение по периоду действия
Теперь посмотрите, как работает механизм вытеснения по периоду действия.
Для этого вам понадобится создать документ Начисления сотрудникам № 3 (рис. 19.8).

Рис. 19.8. Документ «Начисления сотрудникам № 3» {https://ai2b.pro/wp-content/uploads/1/19_08.png}
Этим документом вы фиксируете тот факт, что Гусаков не выходил на работу с 1 по 10 октября.
Очевидно, что в этом случае потребуется пересчитать его оплату по окладу и, как следствие, начисленную премию.
Нажмите Провести и закрыть и затем сформируйте отчет Перерасчет (рис. 19.9).

Рис. 19.9. Отчет «Перерасчет» {https://ai2b.pro/wp-content/uploads/1/19_09.png}
Как вы видите, в перерасчет попала запись о начислении оклада Гусакову. Это явилось результатом работы механизма вытеснения по периоду действия, ведь вид расчета Невыход вытесняет у вас вид расчета Оклад.
Обратите внимание, что в перерасчет попала и запись о начислении премии Гусакову.
Если вы помните, при создании предопределенных видов расчета вы указали, что результат вида расчета Премия будет зависеть от изменения результата вида расчета Невыход. Эта зависимость косвенная, но, поскольку вы явно указали такую зависимость, платформа ее отследила.
Перепроведите документы Начисления сотрудникам № 1 и № 2 и убедитесь, что таблица перерасчета очистилась.

### Процедура расчета записей регистра расчета
#### В 1C:EDT
До сих пор вы просто заносили в регистр расчета Начисления записи о том, что необходимо выполнить какой-либо вид расчета. Но каким именно образом получать эти результаты, вы не указывали.
Теперь настало время описать алгоритмы формирования различных видов расчетов.
Поскольку эти алгоритмы нужно будет использовать не только в документе Начисление сотрудникам, удобнее всего будет разместить их в отдельном общем модуле.
Откройте в модуле документа НачисленияСотрудникам процедуру обработчика проведения и добавьте в нее после завершения создания движений в регистре Начисления вызов процедуры РассчитатьНачисления() из общего модуля ПроведениеРасчетов (листинг 19.2).
Листинг 19.2. Обработчик проведения документа «НачисленияСотрудникам»
Процедура ОбработкаПроведения(Отказ, Режим)
…
КонецЦикла;
 
// Записать движения регистров.
Движения.Начисления.Записать();
 
// Получить список всех сотрудников, содержащихся в документе.
Запрос = Новый Запрос(
"ВЫБРАТЬ РАЗЛИЧНЫЕ
|   НачисленияСотрудникамНачисления.Сотрудник
|ИЗ
|   Документ.НачисленияСотрудникам.Начисления КАК НачисленияСотрудникамНачисления
|
|ГДЕ
|   НачисленияСотрудникамНачисления.Ссылка = &ТекущийДокумент");
 
Запрос.УстановитьПараметр("ТекущийДокумент", Ссылка);
 
// Сформировать список сотрудников.
ТаблЗнач = Запрос.Выполнить().Выгрузить();
МассивСотрудников = ТаблЗнач.ВыгрузитьКолонку("Сотрудник");
 
// Вызов процедуры РассчитатьНачисления из общего модуля
ПроведениеРасчетов.РассчитатьНачисления(Движения.Начисления, ПланыВидовРасчета.ОсновныеНачисления.Оклад, МассивСотрудников);
Движения.Начисления.Записать( , Истина);
 
ПроведениеРасчетов.РассчитатьНачисления(Движения.Начисления, ПланыВидовРасчета.ОсновныеНачисления.Премия, МассивСотрудников);
Движения.Начисления.Записать( , Истина);
 
КонецПроцедуры
Обратите внимание: при проведении документа вы сначала записываете движения, сформированные документом, в регистр (Движения.Начисления.Записать()), а затем передаете этот набор записей регистра в процедуру расчета РассчитатьНачисления(), которую вы создадите в общем модуле ПроведениеРасчетов.
Эту процедуру вы вызываете сначала для расчета первичных записей (Оклад), а затем для расчета вторичных (Премия).
Процедура расчета на основе описанных в ней алгоритмов и данных, содержащихся в записях регистра, должна сформировать значения ресурсов регистра.
После того как ресурсы будут рассчитаны, вы перезаписываете набор записей регистра без формирования записей перерасчета (второй параметр в методе Записать() – Истина).
Перед вызовом процедуры из общего модуля вы с помощью запроса формируете массив сотрудников, перечисленных в документе, чтобы передать его в вызываемую процедуру.
Для параметра запроса ТекущийДокумент вы устанавливаете значение стандартного реквизита документа – Ссылка. Используя метод запроса Запрос.Выполнить().Выгрузить(), выгружаете результат запроса в таблицу значений (переменную ТаблЗнач). Затем формируете массив МассивСотрудников, содержащий колонку Сотрудник из этой таблицы значений.
Теперь создайте новый общий модуль ПроведениеРасчетов.
Установите флажок Вызов сервера для видимости его экспортных процедур и функций (рис. 19.10).

Рис. 19.10. Свойства общего модуля {https://ai2b.pro/wp-content/uploads/1/19_10.png}
Добавьте в него заготовку процедуры РассчитатьНачисления() (листинг 19.3).
Листинг 19.3. Заготовка процедуры «РассчитатьНачисления()»
Процедура РассчитатьНачисления(НаборЗаписейРегистра, ТребуемыйВидРасчета, СписокСотрудников) Экспорт
 
Регистратор = НаборЗаписейРегистра.Отбор.Регистратор.Значение;
 
// Рассчитать первичные записи.
Если ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Оклад Тогда
 
// Рассчитать вторичные записи.
ИначеЕсли ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Премия Тогда
 
КонецЕсли;
 
КонецПроцедуры
Алгоритм расчета начислений будет различным при расчете первичных (вид расчета – Оклад) и вторичных записей (вид расчета – Премия), и каждая из его частей будет находиться в своей ветке условия Если...
При расчете первичных записей вам понадобятся данные графика из регистра расчета, поэтому добавьте в первую ветку условия запрос к виртуальной таблице регистра расчета РегистрРасчета.Начисления.ДанныеГрафика (листинг 19.4).
Листинг 19.4. Изменение процедуры «РассчитатьНачисления()»
Процедура РассчитатьНачисления(НаборЗаписейРегистра, ТребуемыйВидРасчета, СписокСотрудников) Экспорт
 
Регистратор = НаборЗаписейРегистра.Отбор.Регистратор.Значение;
 
// Рассчитать первичные записи.
Если ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Оклад Тогда
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|   ЕСТЬNULL(НачисленияДанныеГрафика.ЗначениеПериодДействия, 0) КАК Норма,
|   ЕСТЬNULL(НачисленияДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК Факт,
|   НачисленияДанныеГрафика.НомерСтроки КАК НомерСтроки
|ИЗ
|   РегистрРасчета.Начисления.ДанныеГрафика(Регистратор = &Регистратор И ВидРасчета = &ВидРасчета И Сотрудник В (&СписокСотрудников))
|   КАК НачисленияДанныеГрафика";
 
Запрос.УстановитьПараметр("Регистратор", Регистратор);
Запрос.УстановитьПараметр("ВидРасчета", ТребуемыйВидРасчета);
Запрос.УстановитьПараметр("СписокСотрудников", СписокСотрудников);
 
ВыборкаРезультата = Запрос.Выполнить().Выбрать();
 
// Рассчитать вторичные записи.
ИначеЕсли ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Премия Тогда
 
КонецЕсли;    
 
КонецПроцедуры
В этом запросе вы выбираете из виртуальной таблицы данных графика регистра расчета значение графика для периода действия и для фактического периода действия. При задании параметров виртуальной таблицы вы ограничиваете выборку регистратором, нужным вам видом расчета и списком сотрудников, по которым нужно получить значения графика.
Кроме того, вы проверяете на NULL значения полей записей виртуальной таблицы, удовлетворяющих наложенным условиям. Чтобы можно было использовать эти значения в дальнейших математических расчетах, вы используете функцию ЕстьNULL(), которая заменяет все пустые значения на 0.
Однако надо понимать, что использование функции ЕстьNULL()может сыграть с вами злую шутку. Так, если вы забудете ввести данные графика или по ошибке укажете несуществующий вид графика для сотрудника, то вы не получите ошибку исполнения, но при этом результат начислений будет нулевой. И вы далеко не сразу можете понять, в чем же дело. Поэтому проверка на NULL здесь может скорее навредить. Использовать эту проверку или нет – решать вам, но не стоит забывать, что вы выполняете учебный пример, а не разрабатываете готовое прикладное решение.
Теперь добавьте обход переданного в процедуру набора записей и расчет записей, для которых получены значения графика (листинг 19.5).
Листинг 19.5. Добавление обхода набора записей и расчета первичных записей
Процедура РассчитатьНачисления(НаборЗаписейРегистра, ТребуемыйВидРасчета, СписокСотрудников) Эспорт
 
Регистратор = НаборЗаписейРегистра.Отбор.Регистратор.Значение;
 
// Рассчитать первичные записи.
Если ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Оклад Тогда
…
ВыборкаРезультата = Запрос.Выполнить().Выбрать();
 
Для Каждого ЗаписьРегистра Из НаборЗаписейРегистра Цикл
СтруктураНомер = Новый Структура("НомерСтроки");
СтруктураНомер.НомерСтроки = ЗаписьРегистра.НомерСтроки;
ВыборкаРезультата.Сбросить();
 
Если ВыборкаРезультата.НайтиСледующий(СтруктураНомер) Тогда
 
Если ВыборкаРезультата.Норма = 0 Тогда
Сообщение = Новый СообщениеПользователю;
Сообщение.Текст = "Вид расчета: Оклад – Нет рабочих дней в заданном периоде";
Сообщение.Сообщить();
ЗаписьРегистра.Результат = 0;
 
Иначе
 
// Рассчитать оклад по фактическому периоду и исходным данным.
ЗаписьРегистра.Результат = (ЗаписьРегистра.ИсходныеДанные / ВыборкаРезультата.Норма) * ВыборкаРезультата.Факт;
Сообщение = Новый СообщениеПользователю;
Сообщение.Текст = "Выполнен расчет " + ЗаписьРегистра.Регистратор + " – " + ЗаписьРегистра.ВидРасчета + " – " + ЗаписьРегистра.Сотрудник;
Сообщение.Сообщить();
 
КонецЕсли;
 
КонецЕсли;
 
КонецЦикла;
 
// Рассчитать вторичные записи.
ИначеЕсли ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Премия Тогда
 
КонецЕсли;    
 
КонецПроцедуры
Для каждой записи из набора записей регистра расчета вы получаете номер строки, идентифицирующий начисление для конкретного сотрудника, и по этому номеру ищете соответствующую запись в выборке из результата запроса.
Если в результате запроса есть запись с таким номером строки, вы рассчитываете результат записи регистра расчета. То есть вы получаете начисление по окладу для каждого сотрудника как результат от деления начисленной суммы (поле регистра ИсходныеДанные) на количество рабочих дней в месяце (Норма) и умножения на фактически отработанные рабочие дни (Факт).
Затем добавьте текст запроса во вторую ветку условия Если… – с той лишь разницей, что теперь вы будете получать значения базы, используя виртуальную таблицу регистра расчета РегистрРасчета.Начисления.БазаНачисления (листинг 19.6).
Листинг 19.6. Добавление текста запроса во вторую ветку условия
Процедура РассчитатьНачисления(НаборЗаписейРегистра, ТребуемыйВидРасчета, СписокСотрудников) Экспорт
 
Регистратор = НаборЗаписейРегистра.Отбор.Регистратор.Значение;
 
// Рассчитать первичные записи.    
Если ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Оклад Тогда
…
// Рассчитать вторичные записи.
ИначеЕсли ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Премия Тогда
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|   НачисленияБазаНачисления.РезультатБаза КАК База,
|   НачисленияБазаНачисления.НомерСтроки КАК НомерСтроки
|ИЗ
|   РегистрРасчета.Начисления.БазаНачисления(&ИзмеренияОсновного,
|    	&ИзмеренияБазового, , Регистратор = &Регистратор И ВидРасчета = &ВидРасчета И Сотрудник В (&СписокСотрудников))
|   КАК НачисленияБазаНачисления";
 
Измер = Новый Массив(1);
Измер[0] = "Сотрудник";
 
Запрос.УстановитьПараметр("ИзмеренияОсновного", Измер);
Запрос.УстановитьПараметр("ИзмеренияБазового", Измер);
Запрос.УстановитьПараметр("Регистратор", Регистратор);
Запрос.УстановитьПараметр("ВидРасчета", ТребуемыйВидРасчета);
Запрос.УстановитьПараметр("СписокСотрудников", СписокСотрудников);
 
ВыборкаРезультата = Запрос.Выполнить().Выбрать();
 
КонецЕсли;
 
КонецПроцедуры
В параметрах виртуальной таблицы запроса вы кроме привычных для вас регистратора, вида расчета и списка сотрудников задаете еще измерения основного и базового регистров. В вашем случае это будет один и тот же регистр Начисления, а нужное вам измерение – Сотрудник.
В заключение осталось добавить во второе условие Если… обход набора записей регистра расчета и вычисление результата вторичных записей (листинг 19.7).
Листинг 19.7. Добавление обхода набора записей регистра и вычисления результата вторичных записей
Процедура РассчитатьНачисления(НаборЗаписейРегистра, ТребуемыйВидРасчета, СписокСотрудников) Экспорт
 
Регистратор = НаборЗаписейРегистра.Отбор.Регистратор.Значение;
 
// Рассчитать первичные записи.    
Если ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Оклад Тогда
…
// Рассчитать вторичные записи.
ИначеЕсли ТребуемыйВидРасчета = ПланыВидовРасчета.ОсновныеНачисления.Премия Тогда
 
ВыборкаРезультата = Запрос.Выполнить().Выбрать();
 
Для Каждого ЗаписьРегистра Из НаборЗаписейРегистра Цикл
СтруктураНомер = Новый Структура("НомерСтроки");
СтруктураНомер.НомерСтроки = ЗаписьРегистра.НомерСтроки;
ВыборкаРезультата.Сбросить();
 
Если ВыборкаРезультата.НайтиСледующий(СтруктураНомер) Тогда
ЗаписьРегистра.Результат = ВыборкаРезультата.База * (10 / 100);
Сообщение = Новый СообщениеПользователю;
Сообщение.Текст = "Выполнен расчет " + ЗаписьРегистра.Регистратор + " – " + ЗаписьРегистра.ВидРасчета + " – " + ЗаписьРегистра.Сотрудник;
Сообщение.Сообщить();
 
КонецЕсли;
 
КонецЦикла;
 
КонецЕсли;
 
КонецПроцедуры
Сумма начисленной премии рассчитывается как 10 % от рассчитанной оплаты по окладу.

#### В прикладном решении
Запустите проект в режиме отладки и проверьте правильность работы процедуры расчета.
Из контекстного меню отмените проведение документа Начисления сотрудникам № 3 и перепроведите документы Начисления сотрудникам № 1 и № 2.
Регистр расчета Начисления должен выглядеть следующим образом (рис. 19.11, 19.12). На этих рисунках скрыты поля Период регистрации, Сторно и ГрафикРаботы.

Рис. 19.11. Записи регистра «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_11.png}

Рис. 19.12. Записи регистра «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_12.png}
Вы видите, что всем сотрудникам произведены начисления по окладу (поле Результат) за полный месяц в соответствии с исходными данными (поле Исходные данные).
Сотрудникам Гусакову и Деловому начислена премия в размере 10 % от суммы начисления по окладу.
Проведите документ Начисление сотрудникам № 3, а затем № 1 и № 2.
При этом отчет Перерасчет должен быть пуст.
Состояние регистра изменится следующим образом (рис. 19.13, 19.14). На этих рисунках скрыты поля Период регистрации, Сторно и ГрафикРаботы.

Рис. 19.13. Записи регистра «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_13.png}

Рис. 19.14. Записи регистра «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_14.png}
В результате невыхода Гусакова на работу сумма оплаты по окладу будет уменьшена, и соответствующим образом уменьшится начисленная ему премия.

### Отчет о начислениях сотрудникам
Теперь посмотрите, каким образом можно использовать данные, хранящиеся в регистре расчета, для получения в отчете итоговой информации о начислениях сотрудникам (рис. 19.15).

Рис. 19.15. Результат отчета {https://ai2b.pro/wp-content/uploads/1/19_15.png}
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем НачисленияСотрудникам. Создайте основную схему компоновки данных отчета, добавьте набор данных – запрос и откройте конструктор запроса.
##### Запрос для набора данных
Выберите таблицу регистра расчета Начисления (рис. 19.16).

Рис. 19.16. Состав полей таблицы «Начисления» {https://ai2b.pro/wp-content/uploads/1/19_16.png}
Из нее выберите следующие поля:
Сотрудник,
ВидРасчета,
ПериодДействияНачало,
ПериодДействияКонец,
Регистратор,
Результат (рис. 19.17).

Рис. 19.17. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/19_17.png}
На закладке Объединения/Псевдонимы определите следующие псевдонимы полей: ПериодДействияНачало и ПериодДействияКонец (рис. 19.18).

Рис. 19.18. «Объединения/Псевдонимы» {https://ai2b.pro/wp-content/uploads/1/19_18.png}
На этом создание запроса закончено, нажмите ОK.

##### Ресурсы
На закладке Ресурсы схемы компоновки данных укажите, что должна быть рассчитана сумма по полю Результат.

##### Настройки
На закладке Настройки добавьте в структуру отчета группировку по полю Сотрудник и в ней – подчиненную группировку детальных записей.
В качестве полей, выводимых в отчет, выберите поля ВидРасчета, Начало, Окончание, Регистратор и Результат.
В результате окно настроек отчета должно иметь следующий вид (рис. 19.19).

Рис. 19.19. Структура и выбранные поля отчета {https://ai2b.pro/wp-content/uploads/1/19_19.png}
На закладке Сортировка укажите, что сортировка записей отчета должна выполняться по возрастанию значения поля Сотрудник и Регистратор (рис. 19.20).

Рис. 19.20. Настройка сортировки отчета {https://ai2b.pro/wp-content/uploads/1/19_20.png}
И в заключение на закладке Другие настройки задайте заголовок отчета – Начисления сотрудникам.
На этом создание схемы компоновки данных закончено.
Включите отчет НачисленияСотрудникам в подсистемы Расчет зарплаты и Бухгалтерия.

#### В прикладном решении
Запустите проект в режиме отладки.
В группе отчетов в разделе Расчет зарплаты нажмите Начисления сотрудникам и сформируйте отчет (рис. 19.21).

Рис. 19.21. Результат отчета {https://ai2b.pro/wp-content/uploads/1/19_21.png}

### Перерасчет
Итак, в вашем алгоритме работы с данными расчета осталось одно узкое место – контроль актуальности данных, содержащихся в регистре расчета.
До сих пор вы использовали служебный отчет Перерасчет, чтобы определить, являются данные в регистре расчета актуальными (если отчет пуст) или же они требуют перерасчета.
Теперь вы создадите специальную процедуру, которая будет определять, требуется ли перерасчет данных регистра расчета, и, если такая необходимость есть, выполнять перерасчет.
Поскольку единственным способом получения итоговой информации о начислениях сотрудникам в вашей конфигурации является отчет НачисленияСотрудникам, для вызова этой процедуры вы создадите форму этого отчета и добавите в командную панель формы кнопку Перерассчитать, по которой будет выполняться перерасчет данных регистра.
#### В 1C:EDT
Создайте основную форму для отчета НачисленияСотрудникам.
Затем в правом верхнем окне редактора формы перейдите на закладку Команды – Команды формы и добавьте команду формы Перерассчитать (рис. 19.22).

Рис. 19.22. Добавление команды формы {https://ai2b.pro/wp-content/uploads/1/19_22.png}
Теперь нужно установить Действие для этой команды. Для этого нажмите кнопку открытия  в строке Действие.
На запрос о типе обработчика команды ответьте, что вы хотите создать обработчик, выполняющийся на клиенте.
В модуле формы будет создан шаблон клиентской процедуры Перерассчитать(), в которую вам нужно поместить вызов процедуры ПерерассчитатьНачисления() из общего модуля ПроведениеРасчетов (листинг 19.8).
Листинг 19.8. Текст обработчика команды «Перерассчитать»
&НаКлиенте
Процедура Перерассчитать(Команда)
 
ПроведениеРасчетов.ПерерассчитатьНачисления(ПредопределенноеЗначение("ПланВидовРасчета.ОсновныеНачисления.Оклад"));
ПроведениеРасчетов.ПерерассчитатьНачисления(ПредопределенноеЗначение("ПланВидовРасчета.ОсновныеНачисления.Премия"));
 
КонецПроцедуры
Саму процедуру перерасчета поместите в общем модуле ПроведениеРасчетов (листинг 19.9).
Листинг 19.9. Процедура перерасчета начислений
Процедура ПерерассчитатьНачисления(ТребуемыйВидРасчета) Экспорт
 
// Выбрать из набора записей перерасчета записи в следующей последовательности:
// записи документа1 для сотрудников из списка,
// записи документа2 для сотрудников из списка и т. д.
Запрос = Новый Запрос(
"ВЫБРАТЬ
|	НачисленияПерерасчет.ОбъектПерерасчета,
|	НачисленияПерерасчет.Сотрудник
|ИЗ
|	РегистрРасчета.Начисления.Перерасчет КАК НачисленияПерерасчет
|ГДЕ
|	НачисленияПерерасчет.ВидРасчета = &ТребуемыйВидРасчета
|ИТОГИ ПО
|	НачисленияПерерасчет.ОбъектПерерасчета");
 
Запрос.УстановитьПараметр("ТребуемыйВидРасчета", ТребуемыйВидРасчета);
СписокСотрудников = Новый СписокЗначений;
 
// Перебрать группировку по регистратору.
ВыборкаПоРегистратору = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
Пока ВыборкаПоРегистратору.Следующий() Цикл
Регистратор = ВыборкаПоРегистратору.ОбъектПерерасчета;
 
// Перебрать группировку по сотрудникам для выбранного регистратора
// и создать список сотрудников.
ВыборкаПоСотрудникам = ВыборкаПоРегистратору.Выбрать();
СписокСотрудников.Очистить();
Пока ВыборкаПоСотрудникам.Следующий() Цикл
СписокСотрудников.Добавить(ВыборкаПоСотрудникам.Сотрудник);
 
КонецЦикла;
 
// Получить набор записей регистра расчета для выбранного регистратора.
НаборЗаписей = РегистрыРасчета.Начисления.СоздатьНаборЗаписей();
НаборЗаписей.Отбор.Регистратор.Значение = Регистратор;
НаборЗаписей.Прочитать();
 
РассчитатьНачисления(НаборЗаписей, ТребуемыйВидРасчета, СписокСотрудников);
НаборЗаписей.Записать( , Истина);
 
// Очистить перерассчитанные записи в перерасчете.
НаборЗаписейПерерасчета = РегистрыРасчета.Начисления.Перерасчеты.Перерасчет.СоздатьНаборЗаписей();
НаборЗаписейПерерасчета.Отбор.ОбъектПерерасчета.Значение = Регистратор;
НаборЗаписейПерерасчета.Записать();
КонецЦикла;
 
КонецПроцедуры
В самом начале процедуры вы запросом выбираете данные о записях перерасчетов, содержащие переданный вид расчета и сгруппированные по объекту перерасчета.
Далее при обходе результата запроса вы формируете для каждого объекта перерасчета список сотрудников, читаете соответствующие записи регистра расчета и вызываете процедуру РассчитатьНачисления(), которая использовалась вами при расчете записей документа НачисленияСотрудникам.
После того как расчет записей выполнен, вы записываете набор записей без формирования записей перерасчета и очищаете записи перерасчета по тому объекту перерасчета, который только что обработали.
Теперь снова откройте форму отчета НачисленияСотрудникам.
Итак, вы указали для команды Перерассчитать действие, то есть процедуру для ее выполнения. Но, чтобы можно было воспользоваться этой командой, нужно добавить в форму кнопку и связать ее с этой командой (в строке ИмяКоманды).
Проще всего это сделать перетаскиванием команды из окна Команды формы в окно элементов формы.
Перетащите мышью команду Перерассчитать в группу элементов формы ОсновнаяКоманднаяПанель.
При этом в форме появится кнопка Перерассчитать, а связь кнопки с командой будет установлена автоматически (рис. 19.23).

Рис. 19.23. Добавление кнопки в форму {https://ai2b.pro/wp-content/uploads/1/19_23.png}

#### В прикладном решении
Запустите проект в режиме отладки и проверьте, как выполняется перерасчет записей регистра расчета.
Отмените проведение всех документов Начисления сотрудникам и проведите документ Начисления сотрудникам № 1 и затем № 2.
Сформируйте отчет Начисления сотрудникам (рис. 19.24).

Рис. 19.24. Отчет «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/19_24.png}
Теперь откройте документ Начисления сотрудникам № 1, измените оклад Гусакова на 90 300 и проведите документ.
В отчете Начисления сотрудникам нажмите кнопку Перерассчитать.
Будет выполнен перерасчет начисления премии Гусакову и Деловому (рис. 19.25).

Рис. 19.25. Окно служебных сообщений {https://ai2b.pro/wp-content/uploads/1/19_25.png}
Чтобы увидеть в отчете актуальные данные, нажмите Сформировать.
Результат работы отчета будет содержать новые значения премии Гусакова (рис. 19.26).

Рис. 19.26. Отчет «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/19_26.png}
И, наконец, проведите документ Начисления сотрудникам № 3 и нажмите Перерассчитать в отчете Начисления сотрудникам.
Снова будет произведен перерасчет оклада и премии Гусакова (рис. 19.27).

Рис. 19.27. Окно служебных сообщений {https://ai2b.pro/wp-content/uploads/1/19_27.png}
Затем нажмите Сформировать. Данные отчета будут содержать актуальные значения начисления оклада и премии (рис. 19.28).

Рис. 19.28. Отчет «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/19_28.png}

### Диаграмма Ганта
В конце этой главы вы создадите отчет, который в графическом виде будет показывать вам фактический период действия записей расчета.
Помимо наглядной демонстрации работы механизма вытеснения записей по периоду действия этот отчет позволит вам познакомиться с элементом формы, позволяющим создавать диаграммы Ганта.
Диаграмма Ганта представляет собой диаграмму интервалов на шкале времени (рис. 19.29) и отражает использование объектами (точками) ресурсов (серий).
Чтобы проще было представить себе составные части диаграммы Ганта, посмотрите на диаграмму, которая должна получиться в результате работы создаваемого вами отчета.
Как уже говорилось, эта диаграмма будет отображать для каждого сотрудника фактический период действия записи по каждому из видов расчета, имеющих место для этого сотрудника.

Рис. 19.29. Пример диаграммы Ганта {https://ai2b.pro/wp-content/uploads/1/19_29.png}
Итак, диаграмма Ганта представляет собой совокупность точек, серий и значений для каждой пары «точка – серия».
В вашем случае точками диаграммы являются сотрудники, а сериями – виды расчетов. Таким образом, для каждого сотрудника существует некоторое значение диаграммы по каждой из серий, то есть по каждому из видов расчета.
Значение диаграммы Ганта представляет собой специальный объект, который автоматически формируется системой на основании того, какие точки и какие серии определены для данной диаграммы.
Этот объект является совокупностью (коллекцией) интервалов, то есть может содержать не один, а несколько интервалов, которые соответствуют паре «серия – точка» (создаваемый по умолчанию объект ЗначениеДиаграммыГанта не содержит ни одного интервала). Разработчик может получить значение диаграммы, указав интересующую его точку и серию, и затем добавить в коллекцию необходимое количество интервалов.
Все интервалы всех значений диаграммы располагаются с привязкой к единой оси времени, что дает возможность видеть их взаимное расположение.
Итак, последовательность ваших действий будет следующей.
В качестве исходных данных для построения такой диаграммы вы возьмете данные регистра расчета Начисления. Каждая запись этого регистра уже содержит все необходимое для построения диаграммы: сотрудника, вид расчета, начало и конец интервала.
Вам останется только средствами встроенного языка отразить все это в диаграмме.
#### В 1C:EDT
Добавьте объект конфигурации – отчет с именем ДиаграммаНачислений.
Для этого отчета не нужно создавать схему компоновки данных. Вместо этого вам нужно создать основную форму отчета и обеспечить формирование и настройку диаграммы Ганта с помощью кода на встроенном языке.
Создайте основную форму для отчета ДиаграммаНачислений.
В правом верхнем окне редактора формы на закладке Реквизиты находятся реквизиты формы. Вы видите здесь основной реквизит формы Отчет, который был создан автоматически при создании формы.
Нажмите Добавить реквизит и добавьте новый реквизит формы. Назовите его ДиаграммаГанта и выберите его тип – ДиаграммаГанта (рис. 19.30).

Рис. 19.30. Добавление реквизита формы {https://ai2b.pro/wp-content/uploads/1/19_30.png}
Теперь перетащите новый реквизит в окно элементов формы, которое пока пусто.
Ответьте утвердительно на вопрос о добавлении колонок таблицы диаграммы Ганта. В результате в окне элементов формы будет создано новое поле для отображения диаграммы, раскрыв которое, вы увидите ее таблицу.
Выделите эту таблицу в окне элементов формы и уберите отметку со свойства Видимость (рис. 19.31).

Рис. 19.31. Скрыть таблицу диаграммы Ганта {https://ai2b.pro/wp-content/uploads/1/19_31.png}
А также выделите сам элемент формы ДиаграммаГанта и установите свойство ПоложениеЗаголовка в значение Нет (так как отображать заголовок поля диаграммы не нужно).
Итак, вы скрыли отображение таблицы у диаграммы Ганта, но вам нужно установить отображение текста точек в области построения диаграммы. Для этого выделите реквизит ДиаграммаГанта в окне реквизитов формы и нажмите Открыть в строке Настройка в палитре свойств этого реквизита (рис. 19.32).

Рис. 19.32. Открыть настройки диаграммы Ганта {https://ai2b.pro/wp-content/uploads/1/19_32.png}
Затем, щелкнув мышью в области построения диаграммы, выделите эту область, в панели Свойства выберите Область построения диаграммы и установите свойство ОтображатьТекстТочек в значение Отображать (рис. 19.33).

Рис. 19.33. Отображать текст точек {https://ai2b.pro/wp-content/uploads/1/19_33.png}
Затем на закладке Команды в верхнем правом углу редактора форм создайте команду формы Сформировать (рис. 19.34).

Рис. 19.34. Команда «Сформировать» {https://ai2b.pro/wp-content/uploads/1/19_34.png}
Установите действие этой команды.
На запрос 1C:EDT о типе обработчика команды ответьте, что вы хотите создать клиентский обработчик команды формы с вызовом из него процедуры, выполняющейся на сервере без контекста формы (рис. 19.35).

Рис. 19.35. Выбор типа обработчика команды формы {https://ai2b.pro/wp-content/uploads/1/19_35.png}
В модуле формы будут созданы шаблоны двух процедур: клиентской процедуры Сформировать() и серверной внеконтекстной процедуры СформироватьНаСервере(), которая вызывается из процедуры Сформировать().
Как уже говорилось ранее, внеконтекстная процедура выполняется на сервере значительно быстрее за счет того, что на сервер с клиента не передается весь контекст формы.
Однако вам нужно передать в процедуру СформироватьНаСервере() в качестве параметра ссылку на реквизит формы ДиаграммаГанта, чтобы на сервере заполнить его данными. Поэтому измените текст модуля формы следующим образом (листинг 19.10).
Листинг 19.10. Текст обработчика команды «Сформировать»
&НаКлиенте
Процедура Сформировать(Команда)
 
СформироватьНаСервере(ДиаграммаГанта);
 
КонецПроцедуры
 
&НаСервереБезКонтекста
Процедура СформироватьНаСервере(Диаграмма)
// Вставить содержимое обработчика.
КонецПроцедуры
В процедуру СформироватьНаСервере() вставьте заготовку запроса (листинг 19.11).
Листинг 19.11. Процедура «СформироватьНаСервере()»
&НаСервереБезКонтекста
Процедура СформироватьНаСервере(Диаграмма)
 
Запрос = Новый Запрос;
Запрос.Текст = ;
 
КонецПроцедуры
Установите курсор перед точкой с запятой, откройте конструктор запроса и создайте новый запрос.
Выберите виртуальную таблицу регистра расчета Начисления.ФактическийПериодДействия.
Из этой таблицы выберите следующие поля (рис. 19.36):
Сотрудник,
ВидРасчета,
ПериодДействияНачало,
ПериодДействияКонец,
Результат,
Регистратор,
Регистратор.Представление.

Рис. 19.36. Выбранные поля {https://ai2b.pro/wp-content/uploads/1/19_36.png}
Все, запрос готов. Теперь нажмите OK и после текста запроса добавьте в процедуру следующий текст (листинг 19.12).
Листинг 19.12. Процедура «СформироватьНаСервере()»
&НаСервереБезКонтекста
Процедура СформироватьНаСервере(Диаграмма)
 
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ
|	НачисленияФактическийПериодДействия.Сотрудник,
|	НачисленияФактическийПериодДействия.ВидРасчета,
|	НачисленияФактическийПериодДействия.ПериодДействияНачало,
|	НачисленияФактическийПериодДействия.ПериодДействияКонец,
|	НачисленияФактическийПериодДействия.Результат,
|	НачисленияФактическийПериодДействия.Регистратор,
|	НачисленияФактическийПериодДействия.Регистратор.Представление
|ИЗ
|	РегистрРасчета.Начисления.ФактическийПериодДействия КАК НачисленияФактическийПериодДействия";
 
ВыборкаРезультата = Запрос.Выполнить().Выбрать();
 
// Запретить обновление диаграммы.
Диаграмма.Обновление = Ложь;
 
Диаграмма.Очистить();
Диаграмма.ОтображатьЗаголовок = Ложь;
 
// Заполнить диаграмму.
Пока ВыборкаРезультата.Следующий() Цикл
 
// Получить серию, точку и значение для них.
ТекущаяСерия = Диаграмма.УстановитьСерию(ВыборкаРезультата.ВидРасчета);
ТекущаяТочка = Диаграмма.УстановитьТочку(ВыборкаРезультата.Сотрудник);
ТекущееЗначение = Диаграмма.ПолучитьЗначение(ТекущаяТочка, ТекущаяСерия);
 
// Создать нужные интервалы в значении.
ТекущийИнтервал = ТекущееЗначение.Добавить();
ТекущийИнтервал.Начало = ВыборкаРезультата.ПериодДействияНачало;
ТекущийИнтервал.Конец = ВыборкаРезультата.ПериодДействияКонец;
ТекущийИнтервал.Текст = ВыборкаРезультата.РегистраторПредставление;
ТекущийИнтервал.Расшифровка = ВыборкаРезультата.Регистратор;
 
КонецЦикла;
 
// Раскрасить серии своими цветами.
Для Каждого Серия из Диаграмма.Серии Цикл
Если Серия.Значение = ПланыВидовРасчета.ОсновныеНачисления.Оклад Тогда
Серия.Цвет = WEBЦвета.Желтый;
 
ИначеЕсли Серия.Значение = ПланыВидовРасчета.ОсновныеНачисления.Премия Тогда
Серия.Цвет = WEBЦвета.Зеленый;
 
ИначеЕсли Серия.Значение = ПланыВидовРасчета.ОсновныеНачисления.Невыход Тогда
Серия.Цвет = WEBЦвета.Красный;
 
КонецЕсли;
 
КонецЦикла;
 
// Разрешить обновление диаграммы.
Диаграмма.Обновление = Истина;
 
КонецПроцедуры
Сначала вы запрещаете обновление диаграммы на то время, пока будете заполнять ее данными. Это нужно для того, чтобы в процессе заполнения не выполнялись пересчеты при каждом изменении данных диаграммы. После окончания заполнения диаграммы вы разрешите обновление, и все пересчеты будут выполнены один раз.
Затем в цикле обхода выборки результата запроса вы заполняете диаграмму.
Сначала, используя методы УстановитьСерию() и УстановитьТочку(), вы получаете либо существующие, либо новые точку и серию. Точки и серии однозначно идентифицируются своими значениями, в качестве которых вы используете сотрудника и вид расчета из результата запроса.
После того как точка и серия получены, с помощью метода ПолучитьЗначение() вы получаете соответствующее им значение диаграммы.
Затем вы добавляете в значение диаграммы новый интервал, задаете его начало и конец, задаете текст интервала, который будет показываться во всплывающей подсказке, и расшифровку интервала, которая будет выполняться при двойном щелчке мышью на этом интервале.
После того как все значения диаграммы сформированы, вы раскрашиваете серии своими цветами. Серии диаграммы представляют собой коллекцию значений, которую вы перебираете при помощи конструкции Для Каждого … Цикл.
Теперь добавьте в форму отчета кнопку для выполнения команды Сформировать.
В заключение включите отчет ДиаграммаНачислений в подсистему Расчет зарплаты.

#### В прикладном решении
Запустите проект в режиме отладки и посмотрите на результат работы отчета (рис. 19.37).

Рис. 19.37. Отчет «Диаграмма начислений» {https://ai2b.pro/wp-content/uploads/1/19_37.png}
А теперь посмотрите, как выглядит механизм вытеснения по периоду действия на конкретном примере.
Откройте документ Начисления сотрудникам № 3 и вместо одного прогула с 1 по 10 число поставьте Гусакову два прогула: с 3 по 7 число и с 12 по 15 число.
Проведите документ и снова нажмите Сформировать в вашем отчете (рис. 19.38).

Рис. 19.38. Отчет «Диаграмма начислений» {https://ai2b.pro/wp-content/uploads/1/19_38.png}
Теперь вы наглядно видите, как записи вида расчета Невыход вытеснили по периоду действия запись расчета Оклад, изменив ее фактический период действия.
Следует отметить, что существует также возможность интерактивной настройки параметров диаграммы Ганта в прикладном решении, доступная через пункт контекстного меню Настройка…
Также настройку параметров диаграммы, таких как Отображать заголовок, Отображать легенду, Прозрачный фон и т. п., можно выполнить в 1С:EDT, в редакторе формы отчета Диаграмма начислений. Для этого в панели свойств реквизита, содержащего диаграмму, нужно выполнить команду Настройка – Открыть.
## Занятие 20 (0:40). Глобальный поиск
Продолжительность
Ориентировочная продолжительность занятия – 40 минут.
Информационная база вашей фирмы ООО «На все руки мастер» пока еще очень мала. В самом деле, в процессе создания и проверки работы конфигурации вы добавили в нее всего лишь несколько элементов номенклатуры, провели небольшое количество документов.
Однако реальные информационные базы содержат гораздо больше разнообразной информации, и иногда поиск нужных данных становится достаточно сложной задачей, особенно для пользователя, плохо знакомого с номенклатурой товаров (услуг) или с перечнем контрагентов, с которыми работает фирма.
Специально для того, чтобы облегчить поиск незнакомой информации в базе данных, система «1С:Предприятие» содержит механизм полнотекстового поиска в данных. Преимущество этого механизма в том, что он позволяет искать данные, вводя поисковый запрос в простой и естественной форме, например: «телефон абдулова».
Полнотекстовый поиск чрезвычайно удобен в тех случаях, когда вы не знаете точно, где находятся нужные вам данные (например, в каком справочнике). Также полнотекстовый поиск оказывается незаменим тогда, когда вы не знаете точно, что нужно искать (например, не помните точное название номенклатуры или контрагента).
Кроме этих возможностей, полнотекстовый поиск позволяет находить данные там, где другие методы поиска крайне трудоемки или требуют создания специальных алгоритмов и обработок. Например, полнотекстовый поиск хорошо умеет работать с текстовыми полями большой длины и полями типа ХранилищеЗначения.
На этом занятии вы познакомитесь с общими сведениями о механизме полнотекстового поиска в данных, создадите полнотекстовый индекс и на его основе попробуете выполнить глобальный поиск в вашей информационной базе.
Также вы узнаете, как можно программно вмешаться в процесс поиска и настроить его «под себя».
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Общие сведения о механизме полнотекстового поиска в данных
Механизм полнотекстового поиска «1С:Предприятия» основан на использовании двух составляющих:
полнотекстового индекса,
средств выполнения полнотекстового поиска.
Для того чтобы была возможность выполнять полнотекстовый поиск, обязательно должен существовать полнотекстовый индекс. Полнотекстовый индекс создается один раз и затем должен периодически обновляться.
Поиск осуществляется по тем данным, которые содержатся в полнотекстовом индексе. Таким образом, если ведется интенсивная работа с базой данных (например, данные изменяются, добавляются новые), то полнотекстовый индекс следует обновлять как можно чаще. Если же объем изменяемых или новых данных невелик, то обновление полнотекстового индекса можно выполнять реже, например раз в сутки, в период наименьшей загруженности системы.
Создание и обновление полнотекстового индекса может выполняться как интерактивно, в прикладном решении, так и программно, средствами встроенного языка. На следующем занятии вы узнаете, как можно обновлять полнотекстовый индекс в автоматическом режиме.
В процессе работы информационной базы система отслеживает факт изменения данных в тех объектах конфигурации, которые могут участвовать в полнотекстовом поиске. Такими объектами являются, например, планы обмена, справочники, документы, планы видов характеристик, планы счетов, планы видов расчета, регистры (сведений, накопления, бухгалтерии, расчета), бизнес-процессы и задачи.
Впоследствии при создании или обновлении полнотекстового индекса система анализирует данные, содержащиеся в реквизитах этих объектов, и включает эти данные в полнотекстовый индекс. При этом анализироваться могут не все реквизиты, а только те, которые имеют тип Строка, Число, Дата, ХранилищеЗначения или ссылочный тип (например, СправочникСсылка.Номенклатура).
Немного забегая вперед, необходимо отметить, что полнотекстовый поиск выполняется в соответствии с правами пользователя. Таким образом, если какая-то информация недоступна данному пользователю, он не сможет получить ее и при помощи полнотекстового поиска.
Теперь, когда вы в общем виде представляете себе, как работает полнотекстовый поиск, вы можете приступить к первой части необходимых действий – созданию полнотекстового индекса.
Далее с помощью стандартного механизма платформы вы будете, собственно, выполнять полнотекстовый поиск, используя созданный вами индекс.

### Полнотекстовый индекс
Запустите прикладное решение и выполните команду главного меню приложения Функции для технического специалиста. В строку поиска введите «поиск» и запустите Управление полнотекстовым поиском (рис. 20.1).

Рис. 20.1. Вызов обработки управления полнотекстовым поиском {https://ai2b.pro/wp-content/uploads/1/20_01.png}
В результате в основном окне приложения будет открыта стандартная обработка Управление полнотекстовым поиском (рис. 20.2).

Рис. 20.2. Обработка «Управление полнотекстовым поиском» {https://ai2b.pro/wp-content/uploads/1/20_02.png}
Эта обработка позволяет создавать и обновлять полнотекстовый индекс интерактивно. Кроме этого она позволяет разрешать или запрещать вообще все операции, связанные с полнотекстовым поиском: обновление, очистку полнотекстового индекса, полнотекстовый поиск.
Как вы видите, по умолчанию полнотекстовый поиск стандартно включен.
Также система сообщает вам о том, что требуется обновление полнотекстового индекса. Это действительно так, потому что в вашем случае индекс вообще отсутствует (дата актуальности индекса пуста). Для того чтобы создать (или обновить) полнотекстовый индекс, нажмите Обновить индекс.
При больших размерах информационной базы создание и обновление полнотекстового индекса могут занимать несколько минут. Поэтому в процессе обновления индекса в нижнем правом углу экрана всплывает сообщение о том, какая часть данных в данный момент обрабатывается.
После того как создание полнотекстового индекса будет закончено, система сообщит об этом и в обработке управления полнотекстовым поиском будет отображена дата актуальности полнотекстового индекса – дата, когда последний раз выполнялось обновление индекса.
Итак, вы создали полнотекстовый индекс для вашей информационной базы. Теперь, используя этот индекс, выполните полнотекстовый поиск в базе данных.

### Варианты использования глобального поиска
#### Интерактивный поиск
Глобальный поиск в данных на основе полнотекстового индекса является стандартной функцией платформы «1С:Предприятие». Для начала поиска достаточно щелкнуть мышью в строке поиска (со значком лупы) в главной панели приложения (рис. 20.3).

Рис. 20.3. Вызов глобального поиска в базе данных {https://ai2b.pro/wp-content/uploads/1/20_03.png}
Количество данных в вашей базе данных невелико, но даже и на них вы сможете познакомиться с основными возможностями полнотекстового поиска.
Попробуйте найти все данные, содержащие фрагмент «диаг». Введите в строку поиска значение диаг, и сразу под ней появится окно с результатами поиска (рис. 20.4).

Рис. 20.4. Поиск по фрагменту слова {https://ai2b.pro/wp-content/uploads/1/20_04.png}
Найденные слова в элементах результата поиска выделены жирным шрифтом.
Как видите, система нашла и услугу Диагностика, и отчет Диаграмма начислений, так как оба этих элемента содержат искомую подстроку.
Поиск выполняется по избранному, истории, по меню функций, по обсуждениям и сообщениям системы взаимодействия, по данным (полнотекстовый поиск) и по справке. При этом каждый найденный элемент обозначается соответствующей пиктограммой.
Как правило, для получения наилучших результатов полнотекстового поиска рекомендуется использовать в поисковом выражении пару слов.
Например, введите в поисковую строку составное выражение мастер симонов. Результат поиска будет более точным – в нем будут содержаться только данные о сотруднике Симонов (рис. 20.5).

Рис. 20.5. Поиск по составному выражению {https://ai2b.pro/wp-content/uploads/1/20_05.png}
Таким образом, стандартно механизм глобального поиска работает, что называется, «из коробки» и не требует от вас какой-либо настройки и программирования. В большинстве случаев его стандартное поведение покрывает все необходимые сценарии, но при желании вы можете настроить его для выполнения специфических задач.

#### Программная настройка глобального поиска
Во встроенном языке существует объектная модель для работы с глобальным поиском. Она позволяет перехватывать многие события глобального поиска и изменять его стандартное поведение.
Например, можно исключить некоторые виды поиска.
Как уже говорилось, глобальный поиск ищет везде, и, особенно на больших объемах данных, количество элементов результата поиска может быть слишком большим, а сам поиск существенно замедляться.
Например, если ввести в поисковую строку выражение продажи, будет найдено помимо нужных вам данных много разделов справки – с пиктограммой «?» (рис. 20.6).

Рис. 20.6. Поиск по выражению «продажи» {https://ai2b.pro/wp-content/uploads/1/20_06.png}
Чтобы отсечь ненужные вам результаты, вы можете при начале работы системы настроить менеджер глобального поиска. Менеджер доступен через свойство глобального контекста ГлобальныйПоиск. У менеджера есть свойство ПланПоиска – это коллекция, которая содержит те виды поиска, которые будут выполняться.
Если вы не хотите, чтобы выполнялся поиск в справке или где-то еще, просто удалите этот вид поиска из коллекции.
Для этого откройте модуль приложения из контекстного меню вашей конфигурации, создайте в нем обработчик события ПриНачалеРаботыСистемы и заполните его следующим образом (листинг 20.1).
Листинг 20.1. Обработчик события «ПриНачалеРаботыСистемы()»
Процедура ПриНачалеРаботыСистемы()
 
// Получить существующий вид поиска.
ПланПоиска = ГлобальныйПоиск.ПолучитьПлан();
 
// Удалить из плана поиска поиск в меню "Функции для технического специалиста" и поиск по справке.
ПланПоиска.Удалить(СтандартныйВидГлобальногоПоиска.ФункцииДляТехническогоСпециалиста);
ПланПоиска.Удалить(СтандартныйВидГлобальногоПоиска.Справка);
 
// Вернуть план поиска "на место".
ГлобальныйПоиск.УстановитьПлан(ПланПоиска);
 
КонецПроцедуры
В этом обработчике вы сначала методом ПолучитьПлан() получаете полностью всю коллекцию плана поиска менеджера ГлобальныйПоиск. Затем удаляете из этой коллекции ненужные вам стандартные виды глобального поиска. И возвращаете новый усеченный план поиска на место старого с помощью метода УстановитьПлан().
После этого результат поиска по выражению продажи примет следующий вид (рис. 20.7).

Рис. 20.7. Поиск по выражению «продажи» {https://ai2b.pro/wp-content/uploads/1/20_07.png}
Теперь попробуйте решить более сложную задачу – выполнить собственный поиск по псевдокоманде.
Например, в вашем прикладном решении довольно частой задачей является поиск документов об оказании услуг по фрагменту номера документа.
Если вы просто введете в поисковую строку фрагмент номера, то получите очень много результатов (так как глобальный поиск ищет везде), и это может быть недостаточно быстро (так как используется полнотекстовый поиск в данных) – рис. 20.8.

Рис. 20.8. Стандартный поиск по фрагменту номера документа {https://ai2b.pro/wp-content/uploads/1/20_08.png}
Чтобы устранить эту проблему, вы можете выделить задачу поиска по номеру документа в отдельный «вид поиска» и реализовать для него собственный алгоритм поиска «по псевдокоманде».
Например, если пользователь хочет найти документ об оказании услуг по фрагменту номера, то первым символом в поисковую строку он должен ввести «№», а затем фрагмент того номера, который он ищет. Например: «№ 1».
Для этого вы можете воспользоваться событием ПриГлобальномПоиске. Это событие возникает тогда, когда в процессе набора текста в поле поиска сделана пауза. Это событие вы можете обработать в модуле приложения.
Если в строке поиска первый символ «№», вы удаляете все элементы из плана поиска и добавляете свой собственный элемент. Алгоритм его работы написан в процедуре ПоискДокументовПоНомеру(), которая находится в общем модуле ГлобальныйПоискВДанных.
Создайте в модуле приложения обработчик события ПриГлобальномПоиске() и заполните его следующим образом (листинг 20.2).
Листинг 20.2. Обработчик события «ПриГлобальномПоиске()»
Процедура ПриГлобальномПоиске(СтрокаПоиска, ПланПоиска)
 
Если СтрНайти(СтрокаПоиска, "№") = 1 Тогда
 
//Установить собственный вид поиска, в котором есть только поиск по номеру документа.
ПланПоиска.Очистить();
ПланПоиска.Вставить(0, "ПоискДокументовПоНомеру", "ГлобальныйПоискВДанных", Истина, Ложь);
 
КонецЕсли;
 
КонецПроцедуры
Затем создайте в вашей конфигурации общий неглобальный серверный модуль ГлобальныйПоискВДанных (флажок Глобальный снят, а флажок Сервер установлен по умолчанию). Поместите в нем процедуру ПоискДокументовПоНомеру() и заполните ее следующим образом (листинг 20.3).
Листинг 20.3. Процедура «ПоискДокументовПоНомеру()»
Процедура ПоискДокументовПоНомеру(СтрокаПоиска, РезультатПоиска, ДопПараметры) Экспорт
 
ФрагментНомера = Прав(СтрокаПоиска, СтрДлина(СтрокаПоиска) - 1);
 
//Если в строке поиска только "№", то ничего не делать;
Если ФрагментНомера = "" Тогда
Возврат;
КонецЕсли;
 
// Выбрать документы об оказании услуг с номером, содержащим введенную строку.
Запрос = Новый Запрос("ВЫБРАТЬ Ссылка, Номер, Представление
|ИЗ Документ.ОказаниеУслуги
|ГДЕ Номер ПОДОБНО &ФрагментНомера");
Запрос.УстановитьПараметр("ФрагментНомера", "%" + ФрагментНомера + "%");
 
Результат = Запрос.Выполнить();
Выборка = Результат.Выбрать();
 
Пока Выборка.Следующий() Цикл
 
// Создать элемент результата поиска и добавить его в коллекцию.
ЭлементРезультата = Новый ЭлементРезультатаГлобальногоПоиска(
Выборка.Ссылка,
СтрНайтиИВыделитьОформлением(Выборка.Представление, ФрагментНомера));
РезультатПоиска.Добавить(ЭлементРезультата);
 
КонецЦикла;
 
КонецПроцедуры
В этой процедуре запросом вы получаете только те документы об оказании услуг, в номере которых содержится искомый фрагмент строки. Затем в результат глобального поиска вы добавляете собственные элементы. Каждый из них содержит ссылку на найденный документ и представление, в котором выделен найденный фрагмент.
Для выделения элементов используется функция СтрНайтиИВыделитьОформлением(), в которую первым параметром передается строка, которая будет отображаться в результате поиска, а во втором параметре – тот фрагмент, который надо выделить в этой строке.
После этого результат поиска по выражению № 1 примет следующий вид (рис. 20.9).

Рис. 20.9. Поиск по псевдокоманде {https://ai2b.pro/wp-content/uploads/1/20_09.png}
Как видите, результат поиска будет содержать гораздо меньше элементов, и сам поиск будет выполнен значительно быстрее. Если же не вводить «№» первым символом в поисковую строку, глобальный поиск будет работать как обычно, «из коробки».
Теперь в качестве заключительного штриха осталось только дополнить описание поиска новыми возможностями, которые вы только что реализовали.
Глобальный поиск имеет описание, которое открывается по ссылке Что искать или в пустой строке поиска (рис. 20.10).

Рис. 20.10. «Что искать» {https://ai2b.pro/wp-content/uploads/1/20_10.png}
Вы можете изменить это описание.
Для этого добавьте в обработчик события ПриНачалеРаботыСистемы() в модуле приложения выделенный ниже фрагмент кода (листинг 20.4).
Листинг 20.4. Обработчик события «ПриНачалеРаботыСистемы()»
Процедура ПриНачалеРаботыСистемы()
 
// Получить существующий вид поиска.
ПланПоиска = ГлобальныйПоиск.ПолучитьПлан();
 
// Удалить из плана поиска поиск в меню "Функции для технического специалиста" и поиск по справке.
ПланПоиска.Удалить(СтандартныйВидГлобальногоПоиска.ФункцииДляТехническогоСпециалиста);
ПланПоиска.Удалить(СтандартныйВидГлобальногоПоиска.Справка);
 
// Вернуть план поиска "на место".
ГлобальныйПоиск.УстановитьПлан(ПланПоиска);
 
// Установить собственное описание поисковой строки.
ГлобальныйПоиск.УстановитьОписание("Введите строку поиска, ссылку или арифметическое выражение." + Символы.ПС + "Для поиска документов об оказании услуг по номеру введите ""№"" и сразу за ним без пробела часть номера.");
 
КонецПроцедуры
В результате при нажатии на ссылку Что искать пользователь увидит заданное вами описание (рис. 20.11).

Рис. 20.11. Подсказка «Что искать» {https://ai2b.pro/wp-content/uploads/1/20_11.png}
ПРИМЕЧАНИЕ
Вы можете сравнить свое прикладное решение с эталонным приложением Занятие 20. Как это сделать, описано в разделе «Эталонные проекты».


## Занятие 21 (0:35). Выполнение заданий по расписанию
Продолжительность
Ориентировочная продолжительность занятия – 35 минут.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала, то можете загрузить приложение Занятие 20, которое должно получиться у вас к этому моменту. Как это сделать, описано в разделе «Эталонные проекты».
Любая информационная база системы «1С:Предприятие» требует периодического выполнения определенного набора регламентных операций.
Например, по мере изменения существующих данных или добавления новых необходимо выполнять резервное копирование. Тогда, если в результате сбоя информационная база окажется неработоспособной, основную часть данных можно будет восстановить из резервной копии. Поэтому чем чаще выполняется резервное копирование, тем меньшее количество данных придется вводить повторно в случае сбоя.
Другой пример. Для того чтобы использовать полнотекстовый поиск в базе данных, необходимо, чтобы все данные, в которых предполагается выполнять поиск, были проиндексированы. А это значит, что полнотекстовый индекс нужно периодически обновлять. Как часто? Это зависит от интенсивности изменения данных и ввода новых данных. Но очевидно, что делать это нужно с некоторой периодичностью.
Для того чтобы автоматизировать подобные операции, в «1С:Предприятии» существует механизм заданий. Этот механизм позволяет создавать задания, каждое из которых представляет собой некоторую последовательность действий, описанных с помощью встроенного языка. Для каждого задания может быть назначено расписание, в соответствии с которым это задание будет автоматически запущено на исполнение.
На этом занятии вы научитесь использовать механизм заданий на примере автоматизации двух регламентных операций, связанных с полнотекстовым поиском: операции полнотекстового индексирования и операции слияния индексов.
Вы опишете эти операции средствами встроенного языка и установите расписание для их автоматического выполнения.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Постановка задачи
На предыдущем занятии вы узнали, что для возможности выполнения полнотекстового поиска обязательно должен существовать полнотекстовый индекс. Полнотекстовый индекс создается один раз и затем должен периодически обновляться.
На самом деле полнотекстовый индекс состоит из двух индексов: основного и дополнительного. При выполнении полнотекстового поиска поиск осуществляется как в одном, так и в другом индексе. Отличие их заключается в следующем.
Основной индекс спроектирован так, чтобы обеспечивать максимальную скорость поиска при большом объеме данных. Однако оборотной стороной этого является то, что добавление данных в основной индекс осуществляется относительно медленно.
Дополнительный индекс является полной противоположностью основному: добавление данных в дополнительный индекс осуществляется быстро, однако при значительном объеме данных в дополнительном индексе поиск будет выполняться относительно медленно.
Наличие основного и дополнительного индексов предполагает следующую стратегию их использования. Основная масса данных находится в основном индексе, что позволяет выполнять поиск достаточно быстро. Новые данные, измененные или добавленные в систему, добавляются в дополнительный индекс непосредственно в процессе работы пользователей с требуемой периодичностью (например, раз в час или раз в минуту). Такое добавление происходит быстро и оказывает незначительное влияние на производительность системы. Пока объем данных в дополнительном индексе невелик, поиск по нему также выполняется быстро.
В период малой активности пользователей или в период выполнения регламентных действий с информационной базой (например, ночью) выполняется слияние основного и дополнительного индекса (например, раз в сутки). Эта операция может оказывать видимую нагрузку на систему или занимать продолжительное время (в зависимости от накопленных данных). В результате новые данные помещаются в основной индекс, а дополнительный индекс при этом очищается и готов к быстрому приему следующих данных.
Таким образом, чтобы пользователи могли искать во всех данных и не ощущали какого-либо замедления работы системы, дополнительный индекс необходимо обновлять относительно часто (например, раз в час или раз в минуту). В то же время, чтобы пользователи выполняли поиск быстро, необходимо, чтобы дополнительный индекс содержал как можно меньше данных, т. е. нужно периодически выполнять слияние основного и дополнительного индексов (например, ночью, в период минимальной активности пользователей).
В результате для автоматизации полнотекстового индексирования вам понадобятся два задания. Первое задание будет выполнять индексирование без слияния и запускаться каждую минуту. Второе будет выполнять слияние индексов и запускаться один раз в сутки, ночью.

### Что такое регламентное задание
Регламентные задания располагаются в панели Навигатор, в ветке Общие. Каждое регламентное задание содержит два основных свойства: Имя метода и Расписание.
Свойство Имя метода связывает регламентное задание с некоторой процедурой или функцией общего модуля, которая, собственно, и будет исполняться. Эта процедура должна содержать алгоритм на встроенном языке, описывающий все те операции, которые должны быть выполнены.
Свойство Расписание позволяет задать периодичность выполнения этой процедуры.
Кроме перечисленных свойств регламентное задание содержит и другие свойства, например: Интервал повтора при аварийном завершении и Количество повторов при аварийном завершении. Таким образом, если по какой-либо причине выполнение регламентного задания закончится неудачно, система «1С:Предприятие» может автоматически запустить это задание указанное количество раз по прошествии указанного периода времени.

### Создание регламентных заданий
Сначала создайте первое регламентное задание по обновлению индекса.
Сначала добавьте объект конфигурации – регламентное задание с именем ОбновлениеИндекса.
После этого вам нужно создать процедуру, которая и будет выполнять обновление полнотекстового индекса вашей информационной базы.
В качестве такой процедуры может выступать любая процедура или функция неглобального общего модуля, которую можно вызвать на сервере (у общего модуля должно быть установлено свойство Сервер).
Добавьте в конфигурацию общий модуль с именем РегламентныеПроцедуры и установите в его свойствах флажок Вызов сервера для видимости его экспортных процедур и функций (рис. 21.1).

Рис. 21.1. Свойства общего модуля {https://ai2b.pro/wp-content/uploads/1/21_01.png}
В свойствах регламентного задания нажмите кнопку открытия  у поля ввода Имя метода.
1C:EDT откроет окно выбора общего модуля. Выберите модуль РегламентныеПроцедуры (рис. 21.2).

Рис. 21.2. Выбор обработчика события {https://ai2b.pro/wp-content/uploads/1/21_02.png}
В этом модуле будет создан шаблон процедуры ОбновлениеИндекса(). Заполните его следующим образом (листинг 21.1).
Листинг 21.1. Процедура обновления индекса
Процедура ОбновлениеИндекса() Экспорт
 
Если ПолнотекстовыйПоиск.ПолучитьРежимПолнотекстовогоПоиска() = РежимПолнотекстовогоПоиска.Разрешить Тогда
 
Если Не ПолнотекстовыйПоиск.ИндексАктуален() Тогда
ПолнотекстовыйПоиск.ОбновитьИндекс( , Истина);
 
КонецЕсли;
 
КонецЕсли;
 
КонецПроцедуры
Сначала в этой процедуре проверяется возможность выполнения операций, связанных с полнотекстовым поиском (ведь они могут быть запрещены, например, интерактивно, рис. 20.2.).
Если операции полнотекстового поиска разрешены, проверяется, актуален ли полнотекстовый индекс (если после последнего индексирования данные, подлежащие полнотекстовому индексированию, не изменялись, то индекс будет актуален и повторное индексирование не требуется).
В случае необходимости индексирования вызывается метод ОбновитьИндекс() менеджера полнотекстового поиска.
Первый параметр этого метода отвечает за слияние индексов и по умолчанию имеет значение Ложь. Это значит, что слияние индексов выполняться не будет.
Второй параметр метода определяет, какое количество данных будет индексироваться: сразу все, которые необходимо проиндексировать, или порциями. Ваша задача – выполнить индексирование как можно быстрее, поэтому вы указываете, что индексирование будет выполняться порциями (значение Истина).
Размер одной порции фиксирован – 10 000 объектов. Таким образом, если в данный момент требуется проиндексировать, например, 15 000 объектов, то при вызове этого метода из них будет проиндексировано только 10 000 (первая порция), а оставшиеся объекты будут проиндексированы при следующем вызове этого метода (при следующем запуске вашего регламентного задания).
Теперь вам нужно составить расписание запуска регламентного задания.
Перейдите на закладку Расписание в редакторе регламентного задания (в строке Расписание), и система откроет диалог редактирования расписания (рис. 21.3).

Рис. 21.3. Диалог редактирования расписания {https://ai2b.pro/wp-content/uploads/1/21_03.png}
Диалог содержит несколько закладок, которые позволяют задать различные виды расписаний; в нижней части диалога отображается итоговый результат всех установок.
Ваша задача – запускать регламентное задание ежедневно, каждую минуту.
Поэтому прежде всего на закладке Общие укажите, что запуск задания должен повторяться каждый день (Повторять каждые: 1 дн.), – рис. 21.4.

Рис. 21.4. Запуск задания каждый день {https://ai2b.pro/wp-content/uploads/1/21_04.png}
Теперь перейдите на закладку Дневное и задайте порядок запуска задания в течение дня.
Укажите, что запуск задания должен повторяться каждые 60 секунд (Повторять через: 60 сек.), – рис. 21.5.

Рис. 21.5. Запуск задания каждую минуту {https://ai2b.pro/wp-content/uploads/1/21_05.png}
В нижней части диалога отображено созданное вами расписание запуска: Выполнять: каждый день; каждые 60 сек.
Вроде бы вы получили то, что хотели: регламентное задание запускается ежедневно, каждую минуту.
Однако ООО «На все руки мастер» не работает круглосуточно, и запуск этого задания в ночное время будет явно бесполезным: данные в базе данных не изменяются. В то же время вполне возможна ситуация, когда некоторые сотрудники задерживаются после окончания рабочего дня.
Поэтому доработайте расписание следующим образом: укажите Время начала: 08:00:00 (рис. 21.6).

Рис. 21.6. Указание времени начала запуска {https://ai2b.pro/wp-content/uploads/1/21_06.png}
В результате запуск задания будет выполняться не круглые сутки, а только с 8 часов утра. Так как время окончания запуска не указано, запуск задания будет прекращен по окончании текущих суток. Таким образом, с 00:00 до 08:00 часов запуск задания выполняться не будет.
В качестве последнего штриха установите в свойствах регламентного задания флажок Предопределенное (рис. 21.7).

Рис. 21.7. Предопределенное регламентное задание {https://ai2b.pro/wp-content/uploads/1/21_07.png}
Установка этого свойства означает, что после запуска системы в прикладном решении будет создано одно предопределенное регламентное задание. В противном случае такое задание пришлось бы создавать средствами встроенного языка.
На этом создание регламентного задания ОбновлениеИндекса завершено.
Теперь по аналогии создайте второе регламентное задание – СлияниеИндексов. Задайте связанную с ним процедуру из общего модуля РегламентныеПроцедуры.
В этом модуле будет создан шаблон процедуры СлияниеИндексов(). Заполните его следующим образом (листинг 21.2).
Листинг 21.2. Процедура «СлияниеИндексов»
Процедура СлияниеИндексов() Экспорт
 
Если ПолнотекстовыйПоиск.ПолучитьРежимПолнотекстовогоПоиска() = РежимПолнотекстовогоПоиска.Разрешить Тогда
 
Если Не ПолнотекстовыйПоиск.ИндексАктуален() Тогда
ПолнотекстовыйПоиск.ОбновитьИндекс(Истина);
 
КонецЕсли;
 
КонецЕсли;
 
КонецПроцедуры
Эта процедура аналогична показанной в листинге 21.1, за исключением того, что при обновлении индекса выполняется слияние индексов (первый параметр Истина) и индексирование выполняется целиком, для всех данных (второй параметр Ложь по умолчанию), поскольку в данном случае время выполнения индексирования для вас не критично.
В свойствах задания установите также флажок Предопределенное и отредактируйте расписание регламентного задания следующим образом.
На закладке Общее укажите, что задание будет запускаться каждый день (Повторять каждые: 1 дн.), а на закладке Дневное укажите время начала выполнения задания (Время начала: 01:00:00) – рис. 21.8.

Рис. 21.8. Расписание задания «СлияниеИндексов» {https://ai2b.pro/wp-content/uploads/1/21_08.png}
В результате вы получите следующее расписание запуска регламентного задания: Выполнять: каждый день; с 01:00:00 один раз в день.

### Запуск регламентных заданий
Дальнейшее выполнение регламентных заданий не потребует от вас никаких дополнительных действий.
Как уже говорилось на занятии № 7, система «1С:Предприятие» поддерживает два варианта работы: файловый и клиент-серверный.
Ваша демонстрационная информационная база работает в файловом варианте. При старте клиентского приложения примерно через две минуты запускается еще один поток с подключением к базе данных, последовательно выполняющий регламентные задания, инициированные клиентом.
Если бы ваша информационная база работала в клиент-серверном варианте, то для автоматического запуска и выполнения созданных вами заданий также не требовалось бы дополнительных действий. Можно было бы обновить конфигурацию базы данных, и менеджер кластера серверов «1С:Предприятия» начал бы самостоятельно выполнять задания в соответствии с указанным расписанием.
Итак, проверьте, как работают ваши регламентные задания.
Запустите проект в режиме отладки и измените состояние базы данных. Например, добавьте новый элемент номенклатуры и затем удалите его. Подождите пару минут.
Затем выполните команду главного меню приложения Функции для технического специалиста > Стандартные > Управление полнотекстовым поиском. Дата актуальности индекса будет соответствовать дате и времени вашей последней манипуляции с базой данных плюс еще минута (рис. 21.9).

Рис. 21.9. Изменение даты актуальности полнотекстового индекса {https://ai2b.pro/wp-content/uploads/1/21_09.png}
Таким образом, вы видите, что задание обновления индекса запускается каждые 60 секунд, как вы и указали в расписании. Чтобы обеспечить выполнение обоих регламентных заданий, нужно не закрывать хотя бы один экземпляр приложения в течение суток.

## Занятие 22 (0:40). Редактирование движений в форме документа
Продолжительность
Ориентировочная продолжительность занятия – 40 минут.
В вашей информационной базе, как, впрочем, и в любой другой, обязательно следует предусмотреть возможность ввода начальных остатков в регистры. Это необходимо для того, чтобы пользователи могли начать работу с вашей информационной базой не с чистого листа, а с некоторого «исходного состояния», которое было в их прежней системе учета (пусть даже они вели учет на бумаге).
Задача ввода начальных остатков отличается от прочих алгоритмов изменения состояния регистров вашей информационной базы тем, что подразумевает изменение данных непосредственно в регистрах, без использования каких-либо промежуточных алгоритмов (заполнения документов данными, проведения документов, контроля правильности данных, указанных в документах, и пр.).
Например, вам нужно ввести начальные остатки регистра накопления ОстаткиМатериалов.
Для выполнения этой задачи вы создадите документ, в котором будете вручную редактировать его движения по регистру ОстаткиМатериалов прямо в форме документа.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### В 1C:EDT
Добавьте объект конфигурации – документ с именем ВводНачальныхОстатковНоменклатуры.
На закладке Движения редактора документа запретите проведение документа (поскольку вы сами будете формировать записи регистра) и отметьте, что движения документа будут находиться в регистре накопления ОстаткиМатериалов (рис. 22.1).

Рис. 22.1. Запрет проведения документа {https://ai2b.pro/wp-content/uploads/1/22_01.png}
После этого создайте основную форму документа.
В редакторе формы перетащите движения по регистру ОстаткиМатериалов из коллекции движений основного реквизита в дерево элементов формы. На вопрос системы: «Добавить колонки таблицы?» – ответьте утвердительно.
Удалите из таблицы столбцы Регистратор, Активность и Отбор, т. к. они вам не понадобятся (рис. 22.2).

Рис. 22.2. Редактирование формы документа «Ввод начальных остатков номенклатуры» {https://ai2b.pro/wp-content/uploads/1/22_02.png}
Обратите внимание, что в свойстве Путь к данным этой таблицы автоматически будет установлена связь с данными набора записей регистра – Объект.Движения.ОстаткиМатериалов.
Немного измените внешний вид формы. В окне элементов формы добавьте группу полей типа Обычная группа без отображения и перетащите в нее поля документа Номер и Дата.
Также поменяйте местами поля НаборСвойств и Склад таблицы ДвиженияОстаткиМатериалов (рис. 22.3).

Рис. 22.3. Измененная форма документа «Ввод начальных остатков номенклатуры» {https://ai2b.pro/wp-content/uploads/1/22_03.png}
В заключение установите видимость команды РегистрНакопления.ОстаткиМатериалов.ОткрытьПоРегистратору в панели навигации формы документа.
Включите ваш документ в подсистему Бухгалтерия, а также сделайте доступной команду Ввод начальных остатков номенклатуры: создать в этой подсистеме.

### В прикладном решении
Запустите проект в режиме отладки и проверьте работу вашего документа.
Нажмите Ввод начальных остатков номенклатуры в разделе Бухгалтерия.
Создайте документ для ввода начальных остатков в регистр ОстаткиМатериалов и внесите в него следующие данные (рис. 22.4):
Дата документа – 24.09.2022.
Строки табличной части:
1:
Период – 02.09.2022,
Вид движения – Приход,
Материал – Кабель электрический,
Набор свойств – Белые кабели,
Склад – Основной,
Количество – 35.
2:
Период – 09.09.2022,
Вид движения – Приход,
Материал – Шланг резиновый,
Набор свойств – Польша,
Склад – Основной,
Количество – 127.

Рис. 22.4. Документ «Ввод начальных остатков номенклатуры № 1» {https://ai2b.pro/wp-content/uploads/1/22_04.png}
Обратите внимание на то, что дата документа не совпадает с датами отдельных записей, которые вы указали в движениях документа.
Нажмите Записать и для проверки перейдите к движениям вашего документа в регистре ОстаткиМатериалов (рис. 22.5).

Рис. 22.5. Записи регистра «ОстаткиМатериалов» {https://ai2b.pro/wp-content/uploads/1/22_05.png}
Таким образом, вы добились поставленной цели: с одной стороны, задавая дату документа, вы можете фиксировать момент внесения изменений в записи регистра; с другой стороны, для каждой создаваемой вами записи регистра вы можете указать индивидуальное значение поля Период.
Теперь познакомьтесь с тем, как программно синхронизировать дату движений с датой документа. Для этого существуют два типичных варианта.

### Программное редактирование записей регистра
#### Запись движений регистра из формы
##### В 1C:EDT
Итак, вам необходимо сделать так, чтобы записи регистра формировались той же датой, что и дата документа. Это можно программно реализовать как в модуле формы документа, так и в модуле самого объекта.
Чтобы реализовать первый вариант, создайте для формы документа клиентский обработчик события ПередЗаписью и добавьте в него следующий текст (листинг 22.1).
Листинг 22.1. Обработчик события «ПередЗаписью» формы документа
Для Каждого ЗаписьРегистра Из Объект.Движения.ОстаткиМатериалов Цикл
ЗаписьРегистра.Период = Объект.Дата;
 
КонецЦикла;

##### В прикладном решении
Снова запустите проект в режиме отладки, откройте ваш документ и нажмите Записать.
Открыв движения документа в регистре ОстаткиМатериалов, вы видите, что значение поля Период у всех записей стало равно дате документа (рис. 22.6).

Рис. 22.6. Измененные записи регистра «ОстаткиМатериалов» {https://ai2b.pro/wp-content/uploads/1/22_06.png}
Можно сказать, что вы достигли поставленной цели, но лишь в ситуации, когда запись документа выполняется интерактивными средствами.
#### Программная запись движений регистра
Если программно вызвать метод Записать() у объекта вашего документа, он будет записан без участия формы документа. Это значит, что событие ПередЗаписью формы документа вызвано не будет и ваш код обработчика не отработает.
Чтобы предусмотреть возможность синхронизации периода движений документа с датой документа и в случае программной записи объекта Документ, следует использовать обработчик события ПередЗаписью объекта Документ, а не формы документа.
Событие ПередЗаписью в случае интерактивной записи документа сначала будет вызвано у формы документа, а затем у объекта Документ (смотрите схему событий в разделе «Последовательность событий при записи документа из формы документа»).

##### В 1C:EDT
Закомментируйте в модуле формы добавленный вами текст и создайте обработчик события ПередЗаписью в модуле объекта Документ ВводНачальныхОстатковНоменклатуры.
Внесите в него следующий текст (листинг 22.2).
Листинг 22.2. Обработчик события «ПередЗаписью» модуля объекта
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
 
// Определить, нужно ли обновлять дату в движениях.
ОбновитьДатуДвижений = ЭтоНовый() ИЛИ Движения.ОстаткиМатериалов.Модифицированность();
Если Не ОбновитьДатуДвижений Тогда
 
// Проверить, что дата изменилась.
Запрос = Новый Запрос;
Запрос.УстановитьПараметр("ТекущийДокумент", Ссылка);
Запрос.Текст =
"ВЫБРАТЬ
|	Дата
|ИЗ
|	Документ.ВводНачальныхОстатковНоменклатуры
|ГДЕ
|	Ссылка = &ТекущийДокумент";
 
Выборка = Запрос.Выполнить().Выбрать();
Выборка.Следующий();
ОбновитьДатуДвижений = Выборка.Дата <> Дата;
 
КонецЕсли;
 
// Установить всем новую дату, если нужно.
Если ОбновитьДатуДвижений Тогда
 
Если НЕ Движения.ОстаткиМатериалов.Выбран() И НЕ Движения.ОстаткиМатериалов.Модифицированность() Тогда
Движения.ОстаткиМатериалов.Прочитать();
 
КонецЕсли;
 
Для Каждого ЗаписьРегистра Из Движения.ОстаткиМатериалов Цикл
ЗаписьРегистра.Период = Дата;
 
КонецЦикла;
 
КонецЕсли;
 
КонецПроцедуры
Как вы видите, в этом случае обработчик содержит больше кода за счет дополнительных проверок, которые выполняются в результате возможности как интерактивной, так и программной записи объекта.
Если записывается новый документ или были изменены его движения, следует обновить дату движений. В противном случае вы считываете запросом дату документа из базы данных и сравниваете ее с датой, установленной у записываемого объекта. Если даты разные, также следует обновить дату движений.
Перед установкой даты вы проверяете, был ли прочитан набор записей в свойстве Движения объекта и изменялся ли он. Если оба эти условия ложны, значит, набор записей в свойстве Движения объекта пуст и это состояние не связано с его изменением. В этом случае, чтобы предотвратить ошибочное удаление записей в регистре (перезапись пустым набором записей), вы предварительно читаете движения из регистра в набор записей в свойстве Движения.
Затем, как и в предыдущем случае (при записи из формы документа), вы устанавливаете нужную дату для всех записей этого набора. При выполнении записи объекта Документ этот набор будет записан в регистр накопления.

##### В прикладном решении
Запустите проект в режиме отладки и убедитесь, что, указав новую дату (например, 22.09.2022) для вашего документа и записав его, вы получите движения в регистре накопления с новой датой.
В процессе записи вашего документа можно управлять не только периодом записей регистра накопления, но и значениями других полей регистра.
Например, по аналогичному принципу может быть создан документ Операция, позволяющий вводить ручные операции в регистр бухгалтерии.
При этом вероятно, что кроме управления периодом записей регистра вам потребуется управлять значением поля Активность («включать» и «выключать» проводки документа) и т. д.
#### Где создавать обработчики событий
В заключение следует сказать, что выбор обработчика, в который будет помещен текст процедуры, зависит от логики работы создаваемого объекта. Если конфигурация не предусматривает программной записи объекта, можно выбрать обработчик модуля формы. Если предполагается и программная модификация объекта, следует выбирать обработчик модуля объекта.
Заметьте, что оба эти способа не исключают модификацию записей регистра через объект Регистр<…>НаборЗаписей.<имя регистра>. Поэтому, если логика конфигурации подразумевает возможность программной модификации объекта НаборЗаписей, код обработки следует помещать в обработчик события набора записей. Все попытки изменить данные регистра будут сведены в конечном счете к записи именно набора записей.


## Занятие 23 (1:50). Список пользователей и их роли
Продолжительность
Ориентировочная продолжительность занятия – 1 час 50 минут.
После того как созданы все основные объекты конфигурации, можно приступить к определению ролей пользователей. Администрирование списка пользователей «1С:Предприятия» и назначение им ролей в соответствии с их служебными обязанностями – очень важные моменты для организации интерфейса прикладного решения в целом и разграничения прав и действий его отдельных пользователей. Этому вопросу и будет посвящено данное занятие.
До сих пор вы имели полный доступ ко всем разделам приложения и ко всем объектам конфигурации и командам, используемым в этих разделах. Однако при реальной работе пользователей одной из главных возможностей, которую должно обеспечивать прикладное решение, является разграничение прав доступа пользователей к той или иной информации, хранящейся в информационной базе.
Например, руководитель должен, очевидно, иметь доступ ко всей информации, которая содержится в базе данных, а вот кладовщик, напротив, только к информации, касающейся движения товаров на складах, и не иметь возможности просматривать бухгалтерскую или кадровую информацию.
Кроме того, должна существовать возможность ограничить пользователей в выполнении тех или иных действий с объектами базы данных. Например, кладовщик может создавать и изменять приходные накладные, поскольку он отвечает за учет материалов на предприятии. Мастеру может понадобиться просматривать приходные накладные, чтобы знать, какие материалы и когда были получены. Однако мастер не должен иметь возможности вносить какие-либо изменения в приходные накладные.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.
### Что такое роль
Для описания подобных разрешений используются объекты конфигурации Роль. С помощью такого объекта вы получаете возможность описать набор прав на выполнение тех или иных действий над каждым объектом базы данных и над всей конфигурацией в целом.
Как правило, роли создаются отдельно для каждого вида деятельности, и каждому пользователю системы ставится в соответствие одна или несколько ролей.
Если пользователю поставлено в соответствие несколько ролей, предоставление доступа будет осуществляться по следующему алгоритму:
если хотя бы в одной роли есть разрешение, то доступ будет открыт;
если во всех ролях разрешение отсутствует, то доступ будет закрыт.

### Создание ролей
При создании ролей исходят, как правило, из того, какие полномочия требуются различным группам пользователей на доступ к информации. Для этого вы будете использовать подсистемы, которые значительно облегчат вашу задачу.
#### Администратор
Первая роль, которую вы создадите, будет Администратор. Она должна включать в себя полные права на работу с данными информационной базы.
Итак, в панели Навигатор в ветке Общие > Роли добавьте объект конфигурации – роль с именем Администратор.
В редакторе роли на закладке Права вы можете отредактировать права для этой роли. Прежде всего посмотрите на список прав роли на действия с конфигурацией в целом. Как вы видите, любая вновь созданная роль имеет ряд прав для запуска клиентских приложений, использования режимов основного окна и др.
Но в данном случае этого недостаточно, так как Администратор – это роль с наиболее полными правами. Пользователь с этой ролью должен иметь право выполнять любые административные действия с конфигурацией.
Поэтому нажмите  Отметить все элементы в панели действий над списком прав. Для того чтобы ваш Администратор мог работать с объектами, которые вы будете создавать после расстановки прав, задайте для него параметр Устанавливать права для новых объектов (рис. 23.1).

Рис. 23.1. Редактор прав для роли «Администратор» {https://ai2b.pro/wp-content/uploads/1/23_01.png}
Администратор должен иметь права на все объекты и все виды объектов. Поэтому нажмите в панели действий  Добавить права на объекты… и в появившемся окне нажмите  Отметить все элементы слева, над списком объектов конфигурации, и еще раз справа, над списком прав (рис. 23.2).

Рис. 23.2. Добавление прав для роли «Администратор» {https://ai2b.pro/wp-content/uploads/1/23_02.png}
После этого все права для всех объектов будут помечены.
Теперь единственное, что следует сделать, – снять разрешение на интерактивное удаление для всех объектов. Это необходимо для того, чтобы администратор случайно не мог удалить какой-либо объект базы данных. Для этого снимите отметку с права Интерактивное удаление. Заметьте, что одновременно с отключением права на интерактивное удаление объектов снимается также отметка с права Интерактивное удаление предопределенных. Нажмите ОК (рис. 23.2).
В результате для роли Администратор будут установлены все права на все объекты конфигурации за исключением прав Интерактивное удаление и Интерактивное удаление предопределенных, а также все права на административные действия с конфигурацией в целом (рис. 23.3).

Рис. 23.3. Редактор прав для роли «Администратор» {https://ai2b.pro/wp-content/uploads/1/23_03.png}
На этом создание роли Администратор закончено.

#### Директор
Затем создайте еще одну роль с именем Директор.
Директору (как и всем остальным ролям, за исключением администратора) достаточно тех прав на действия с прикладным решением, которые устанавливаются по умолчанию (запуск тонкого и веб-клиентов, вывод данных и сохранение данных пользователя).
Что касается конкретных объектов конфигурации, то вы должны предоставить пользователю с ролью Директор права на просмотр всех объектов.
Поэтому вызовите диалог добавления прав и слева, в списке объектов, выделите все объекты конфигурации, а в списке прав установите право Просмотр (права Чтение и Использование при этом установятся автоматически). Нажмите ОК (рис. 23.4).

Рис. 23.4. Добавление прав для роли «Директор» {https://ai2b.pro/wp-content/uploads/1/23_04.png}
Тем самым вы предоставили директору возможность просматривать все данные информационной базы, а позднее с помощью установки видимости команд по ролям вы исключите из его интерфейса все действия, которые по логике вашей конфигурации не относятся к прикладной ее части.
Вторая роль вашей конфигурации готова.

#### Мастер
Затем создайте еще одну роль с именем Мастер.
Для этой роли вам нужно предоставить доступ не ко всем объектам конфигурации, а только к тем объектам, которые относятся к подсистемам УчетМатериалов и ОказаниеУслуг.
Для более быстрого и удобного отбора этих объектов в окне добавления прав установите фильтр по этим подсистемам. Для этого нажмите , выберите указанные подсистемы и нажмите Установить (рис. 23.5).

Рис. 23.5. Добавление прав для роли «Мастер» {https://ai2b.pro/wp-content/uploads/1/23_05.png}
Затем отметьте все объекты конфигурации и все права, за исключением права Интерактивное удаление.
Вернувшись в редактор прав для роли Мастер, можно при необходимости внести уточнения в установленные права. В частности, для справочника Сотрудники снимите отметку с прав Добавление, Изменение и Удаление (рис. 23.6).

Рис. 23.6. Редактор прав для роли «Мастер» {https://ai2b.pro/wp-content/uploads/1/23_06.png}
Обратите внимание, что при запрете права Добавление исчезла отметка и у права Интерактивное добавление, так как оно является «уточнением» права Добавление. Точно так же уточненные права запрещаются и при отмене прав на изменение и удаление.
Кроме того, существует еще ряд объектов, которые вы не привязывали ни к каким подсистемам, но они будут нужны мастерам для работы с характеристиками номенклатуры. Это:
справочник ВариантыНоменклатуры,
справочник ДополнительныеСвойстваНоменклатуры,
план видов характеристик СвойстваНоменклатуры,
регистр сведений ЗначенияСвойствНоменклатуры.
Вызовите еще раз диалог добавления прав, раскройте соответствующие виды объектов конфигурации, отметьте перечисленные выше объекты и установите все права на эти объекты, кроме права Интерактивное удаление.
А также раскройте ветвь Общие > Подсистемы и отметьте право Просмотр у подсистемы Предприятие. Тем самым вы предоставите мастерам доступ к нормативно-справочной информации, которая будет находиться в этой подсистеме. А ненужную им функциональность вы скроете в дальнейшем с помощью видимости команд по ролям.
Роль Мастер готова.

#### Расчетчик
В заключение вам осталось создать две роли: Бухгалтер и Расчетчик.
В вашем прикладном решении вам нужно разделить права по расчету зарплаты и по ведению бухгалтерского учета.
Дело в том, что в ООО «На все руки мастер» есть бухгалтер и помощник бухгалтера. Помощник бухгалтера занят в основном расчетом зарплаты, но иногда это делает и главный бухгалтер.
Поэтому главному бухгалтеру необходимо будет назначить обе роли, в то время как помощнику – только роль Расчетчик.
Добавьте объект конфигурации – роль с именем Расчетчик.
В окне добавления прав установите отбор по подсистеме РасчетЗарплаты и задайте все права на объекты, кроме права Интерактивное удаление.
А также установите право Просмотр для объектов конфигурации: регистра накопления Продажи, справочника Клиенты и подсистемы Предприятие.
Роль Расчетчик готова.

#### Бухгалтер
В заключение добавьте объект конфигурации – роль с именем Бухгалтер.
В окне добавления прав установите их по подсистеме Бухгалтерия. Задайте все права на объекты и запретите право на интерактивное удаление.
В редакторе прав роли (см. 23.6) для справочника Номенклатура запретите права на добавление, изменение и удаление данных.
Вызовите еще раз диалог добавления прав и установите все права, кроме интерактивного удаления, для справочника Субконто.
А также установите право Просмотр для следующих объектов конфигурации:
справочник Склады,
справочник ВариантыНоменклатуры,
справочник ДополнительныеСвойстваНоменклатуры,
план видов характеристик СвойстваНоменклатуры,
регистр сведений ЗначенияСвойствНоменклатуры,
подсистема Предприятие.

#### Права на запуск клиентских приложений
В заключение проверьте, что у каждой роли есть права на запуск клиентского приложения (тонкого клиента и веб-клиента).
Для этого удобно воспользоваться редактором Все роли. Чтобы вызвать этот редактор в панели Навигатор, нажмите Все роли в контекстном меню ветви Роли. Вы увидите все права, установленные для всех ролей.
Чтобы сузить этот список, отфильтруйте его, нажав  в панели действий редактора. В списке объектов выделите вашу конфигурацию, а в списке ролей – все роли (рис. 23.7). После наложения фильтра в редакторе вы видите, что права Тонкий клиент и Веб-клиент включены для всех ролей.

Рис. 23.7. Окно редактора «Все роли» {https://ai2b.pro/wp-content/uploads/1/23_07.png}
Администратор также имеет возможность подключаться и с помощью других клиентских приложений.

### Добавление новых пользователей
Для того чтобы иметь возможность отличать друг от друга пользователей, работающих с информационной базой, в системе «1С:Предприятие» существует список пользователей.
Можно создавать и удалять пользователей системы, назначать им роли и т. д.
На момент написания книги функции администрирования информационных баз не поддерживаются в 1С:EDT, хотя такая поддержка планируется в будущем. Поэтому сейчас, чтобы создать пользователей вашего прикладного решения, вам нужно обновить конфигурацию базы данных и открыть вашу информационную базу в конфигураторе.
Чтобы обновить конфигурацию информационной базы, в панели Навигатор нажмите Обновить конфигурацию… в контекстном меню проекта (рис. 23.8).

Рис. 23.8. Обновление конфигурации базы данных {https://ai2b.pro/wp-content/uploads/1/23_08.png}
Установите флажок Загрузить конфигурацию полностью… и нажмите ОК (рис. 23.9).

Рис. 23.9. Загрузить конфигурацию полностью… {https://ai2b.pro/wp-content/uploads/1/23_09.png}
Теперь откройте вашу базу в конфигураторе.
Для этого перейдите в панель Информационные базы (обычно она свернута на правой стороне экрана) и нажмите Запустить конфигуратор в контекстном меню базы (рис. 23.10).

Рис. 23.10. Запустить конфигуратор {https://ai2b.pro/wp-content/uploads/1/23_10.png}
В главном меню конфигуратора нажмите Администрирование > Пользователи. Откроется список пользователей системы.
Пока что он пуст, поэтому нажмите Добавить в командной панели окна. Откроется окно редактирования пользователя (рис. 23.11).

Рис. 23.11. Окно редактирования пользователя {https://ai2b.pro/wp-content/uploads/1/23_11.png}
ВНИМАНИЕ!
Если вы используете учебную версию платформы «1С:Предприятие 8.3», то возможность задания паролей пользователей и аутентификация операционной системы будут недоступны. Это ограничения учебной версии.
Имя пользователя – это идентификатор, который будет появляться в окне выбора пользователей при запуске прикладного решения.
Полное имя – строка, которая может быть использована внутри конфигурации при выводе различной справочной информации. Хорошим стилем администрирования считается указание в качестве полного имени фамилии, имени и отчества пользователя (без сокращений).
Следующие две области окна посвящены способам аутентификации пользователя.
Аутентификация средствами «1С:Предприятия» подразумевает, что после запуска системы пользователю будет предложено выбрать имя одного из пользователей системы и ввести пароль. Если введенный пароль соответствует сохраненному в системе для этого идентификатора пользователя, система открывается с правами, которые указаны для этого пользователя. При этом он сможет поменять пароль, если флажок Пользователю запрещено изменять пароль не установлен.
Аутентификация операционной системы подразумевает, что при запуске системы «1С:Предприятие» от пользователя не требуется никакой дополнительной информации. Система «1С:Предприятие» определяет, под каким пользователем запущена операционная система, и затем обращается к своему списку пользователей. Если она находит в нем пользователя, которому поставлен в соответствие текущий пользователь операционной системы, информационная база открывается с правами, указанными для этого пользователя.
Итак, задайте имя пользователя – Администратор, полное имя – тоже Администратор.
Перейдите на закладку Прочие. Отметьте роль Администратор и выберите язык конфигурации Русский (рис. 23.12).

Рис. 23.12. Пользователь «Администратор» {https://ai2b.pro/wp-content/uploads/1/23_12.png}
Нажмите ОК.
После этого создайте остальных пользователей системы (рис. 23.13). Для всех них вы будете использовать аутентификацию «1С:Предприятия» и русский язык.
Таблица 23.1. Новые пользователи







































Рис. 23.13. Список пользователей системы {https://ai2b.pro/wp-content/uploads/1/23_13.png}
ПРИМЕЧАНИЕ
Если некоторые колонки, например Роли, не видны в списке пользователей, можно настроить список, выполнив команду Действия > Настройка списка…, и добавить нужные колонки.
Обратите внимание, что главному бухгалтеру Назаровой поставлены в соответствие две роли: Расчетчик и Бухгалтер, поскольку она должна иметь возможность не только вести бухгалтерский учет, но и рассчитывать зарплату.
Закройте конфигуратор, вернитесь в 1C:EDT.

### Ограничение доступа к данным на уровне записей и полей базы данных
В завершение занятия вы узнаете, как можно ограничить доступ к данным более точно в зависимости от самих данных, которые хранятся в информационной базе.
Для этого в системе «1С:Предприятие» используется механизм ограничения доступа на уровне записей и полей базы данных. Этот механизм позволяет для четырех основных прав (чтение, добавление, изменение и удаление) уточнить, какие же именно данные информационной базы будут доступны пользователю.
Такое уточнение записывается на специальном языке, являющемся подмножеством языка запросов.
Например, вам нужно предоставить возможность мастерам просматривать начисленную им зарплату, но при этом нужно учесть, что руководство запрещает им доступ к информации о начисленной премии.
Другими словами, мастерам нужно запретить просмотр тех документов Начисления сотрудникам, в которых есть записи о начислении премии.
#### В 1C:EDT
Для решения этой задачи откройте редактор роли Мастер на закладке Права и добавьте права этой роли на просмотр еще нескольких объектов конфигурации.
Сначала установите право Просмотр для документа НачисленияСотрудникам.
Поскольку этот документ принадлежит подсистеме РасчетЗарплаты, дайте роли право на просмотр этой подсистемы.
Также дайте права на просмотр справочника ВидыГрафиковРаботы и плана видов расчета Основные начисления, т. к. ссылки на эти объекты используются в документе НачисленияСотрудникам.
В верхней части редактора прав вы видите список объектов конфигурации, на которые вы дали роли права, а в нижней части вы можете задать ограничения доступа к данным этих объектов.
Выделите в списке объектов документ НачисленияСотрудникам.
Как вы видите, при установке права Просмотр право Чтение документа НачисленияСотрудникам установилось автоматически. Выделите его в списке прав в нижней части редактора и нажмите Добавить ограничение доступа (рис. 23.14).

Рис. 23.14. Добавление ограничения доступа для документа «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/23_14.png}
Откроется окно Редактирование ограничения доступа, в котором можно задать текст на специальном языке, являющемся подмножеством языка запросов.
Вам нужно запретить доступ ко всем полям документа Начисления сотрудникам. Поэтому не нужно выбирать поля в левой части редактора.
Внесите выражение, показанное в листинге 23.1, в поле Ограничение доступа (рис. 23.15).

Рис. 23.15. Редактор ограничений доступа {https://ai2b.pro/wp-content/uploads/1/23_15.png}
Листинг 23.1. Ограничение доступа к данным
НачисленияСотрудникам ГДЕ НачисленияСотрудникам.Начисления.ВидРасчета <> ЗНАЧЕНИЕ(ПланВидовРасчета.ОсновныеНачисления.Премия)
Текущий пользователь имеет право прочитать или изменить некоторый объект базы данных только в том случае, если ограничение доступа предоставляет ему такое право. То есть когда условие ограничения истинно.
В вашем случае пользователь сможет прочитать документ Начисления сотрудникам НачисленияСотрудникам ГДЕ… только в том случае, если в его табличной части Начисления … ГДЕ НачисленияСотрудникам.Начисления … есть виды расчета … ГДЕ НачисленияСотрудникам.Начисления.ВидРасчета …, не являющиеся видом расчета Премия … <> ЗНАЧЕНИЕ(ПланВидовРасчета.ОсновныеНачисления.Премия).
Нажмите Готово.
Окно ограничений доступа к данным для документа Начисления сотрудникам роли Мастер будет выглядеть следующим образом (рис. 23.16).

Рис. 23.16. Ограничения доступа для документа «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/23_16.png}

#### В прикладном решении
Теперь для проверки ограничений доступа вам нужно запустить прикладное решение от имени пользователя, обладающего ролью Мастер, например пользователя Гусаков.
Для этого нужно отредактировать ту конфигурацию запуска, которая используется, и сменить пользователя, от имени которого запускается прикладное решение.
Чтобы вызвать редактор конфигураций запуска, в главном меню 1С:EDT нажмите Запуск > Конфигурации запуска… Или же можно для быстроты нажать Запуск > История выполнения, затем, удерживая клавишу CTRL, выбрать вашу последнюю конфигурацию запуска.
В появившемся редакторе на закладке Основное установите переключатель Пользователь клиентского приложения в значение Пользователь информационной базы.
В появившихся полях можно ввести имя пользователя для запуска и его пароль. В поле пользователя введите Гусаков (пароль указывать не нужно, так как вы его не задавали) и нажмите Запуск (рис. 23.17).

Рис. 23.17. Редактор конфигурации запуска {https://ai2b.pro/wp-content/uploads/1/23_17.png}
1C:EDT попытается запустить приложение, однако, так как в информационную базу вы добавили пользователей, теперь 1C:EDT нужно знать, от имени какого пользователя взаимодействовать с базой.
Выберите Тип доступа – Infobase, введите Имя пользователя – Администратор и нажмите ОК (рис. 23.18).

Рис. 23.18. Параметры доступа к базе {https://ai2b.pro/wp-content/uploads/1/23_18.png}
После запуска прикладного решения имя пользователя будет отображено в правом углу основного окна приложения.
В разделе Расчет зарплаты откройте список документов Начисления сотрудникам (рис. 23.19).

Рис. 23.19. Список документов «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/23_19.png}
Как вы видите, в списке показаны только документы № 1 и № 3, так как в документе № 2 начисляется премия.

#### В 1C:EDT
Теперь вам нужно решить более сложную задачу. Хотелось бы, чтобы мастер видел все документы о начислении зарплаты, но не имел возможности открыть документ, содержащий начисление премии.
В уже имеющемся ограничении доступа к данным документа Начисления сотрудникам для роли Мастер вы не задавали никаких полей, поэтому ограничение применяется ко всем полям документа (см. рис. 23.16).
Поэтому сейчас вы должны безусловно разрешить читать те поля документа, которые необходимы для отображения документа в списке.
Тем самым вы разрешите документу отображаться в списке. Но, поскольку существующее условие на прочие поля вы удалять не будете, открыть документ, как и раньше, можно будет только в том случае, если в его табличной части есть виды расчета, отличные от Премия.
Итак, добавьте к ограничениям доступа еще одно условие.
В списке полей выберите поля:
Ссылка,
ПометкаУдаления,
Номер,
Дата,
Проведен.
В ограничении доступа напишите ГДЕ ИСТИНА (рис. 23.20).

Рис. 23.20. Редактор ограничений доступа {https://ai2b.pro/wp-content/uploads/1/23_20.png}
В результате для права Чтение у вас будет два ограничения (рис. 23.21).

Рис. 23.21. Редактор ограничений доступа {https://ai2b.pro/wp-content/uploads/1/23_21.png}

#### В прикладном решении
Снова запустите прикладное решение от имени пользователя, обладающего ролью Мастер (пользователь Гусаков). Поскольку последний раз вы запускали проект от имени этого же пользователя, то вам не надо изменять конфигурацию запуска, а достаточно нажать  на панели инструментов 1С:EDT.
Откройте список документов Начисления сотрудникам (рис. 23.22).

Рис. 23.22. Список документов «Начисления сотрудникам» {https://ai2b.pro/wp-content/uploads/1/23_22.png}
В списке документов вы увидите все документы начислений. Документы № 1 и № 3 вы сможете открыть и просмотреть, но при попытке открыть документ № 2 вы получите сообщение о нарушении прав доступа (рис. 23.23).

Рис. 23.23. Сообщение о нарушении прав доступа к данным {https://ai2b.pro/wp-content/uploads/1/23_23.png}
То есть вы добились того, чего хотели.
Теперь обратите внимание на следующий момент.
Все хорошо, пока в документе № 2 содержатся записи только о расчете премии. Но вспомните, как формулируется ваше ограничение доступа: пользователь сможет прочитать документ Начисления сотрудникам только в том случае, если в его табличной части Начисления есть виды расчета, не являющиеся видом расчета Премия.
Это значит, что если в этом документе окажутся виды расчета, отличные от Премия, то мастер сможет его открыть и просмотреть.
Чтобы убедиться в этом, не закрывая прикладное решение, запустите еще один сеанс от имени пользователя Администратор (используйте значок «1С:Предприятие» на рабочем столе). Если вы используете учебную версию, то сначала закройте сеанс пользователя Гусаков (учебная версия не даст открыть два сеанса одновременно).
Откройте список документов НачисленияСотрудникам.
Откройте документ № 2 и скопируйте любую его строку. В новой строке измените вид расчета на Оклад. Проведите и закройте документ. Завершите сеанс работы.
Теперь перейдите к сеансу, запущенному от имени пользователя Гусаков, обновите данные, нажав F5, и откройте список документов НачисленияСотрудникам.
Откройте документ № 2. Документ откроется, и вы увидите все его строки.

#### В 1C:EDT
Для того чтобы документ невозможно было просмотреть и в этой ситуации, вам нужно будет изменить существующее условие ограничения доступа.
Новое условие будет более сложным, поэтому вы будете использовать шаблоны в ограничениях доступа.
Итак, перейдите на закладку Шаблоны ограничений в редакторе роли Мастер. Добавьте новый шаблон ограничений с именем ЕстьПремия (рис. 23.24).

Рис. 23.24. Добавление шаблона ограничений доступа к данным для роли «Мастер» {https://ai2b.pro/wp-content/uploads/1/23_24.png}
Текст шаблона будет выглядеть следующим образом (листинг 23.2).
Листинг 23.2. Ограничение доступа к данным
ВЫБРАТЬ
1
ИЗ
Документ.НачисленияСотрудникам.Начисления
ГДЕ
Документ.НачисленияСотрудникам.Начисления.ВидРасчета = ЗНАЧЕНИЕ(ПланВидовРасчета.ОсновныеНачисления.Премия)
И Документ.НачисленияСотрудникам.Начисления.Ссылка = #Параметр(1).Ссылка
По сути это запрос к табличной части документа НачисленияСотрудникам, который либо не вернет вам ничего, либо вернет одну запись с одним полем, в котором будет значение 1.
Такую запись он вернет вам в том случае, если в табличной части документа есть вид расчета Премия.
Второе условие в этом запросе нужно вам для того, чтобы указать, табличная часть какого именно документа вас интересует. В этом условии используется возможность указания параметров в шаблоне.
Листинг 23.3. Ограничение доступа к данным
И Документ.НачисленияСотрудникам.Начисления.Ссылка = #Параметр(1).Ссылка
Вместо #Параметр(1) будет подставлена та строка, которую вы укажете при вызове этого шаблона в условии ограничения доступа.
Теперь нажмите Готово и вернитесь на закладку Права в редакторе роли Мастер.
В имеющемся ограничении прав доступа для других полей (в первой строке списка ограничений) замените старый текст новым (листинг 23.4) – рис. 23.25.
Листинг 23.4. Ограничение доступа к данным
ДокНачисления ГДЕ НЕ 1 В (#ЕстьПремия("ДокНачисления"))

Рис. 23.25. Установка ограничений доступа к данным для роли «Мастер» {https://ai2b.pro/wp-content/uploads/1/23_25.png}
Здесь с помощью конструкции #ЕстьПремия("ДокНачисления") вы обращаетесь к созданному вами шаблону. Текст шаблона просто механически будет подставлен в это место, причем строка ДокНачисления заменит собой первый параметр шаблона (#Параметр(1)).
Как уже говорилось, если в табличной части есть начисление Премия, запрос в шаблоне вернет единственную запись со значением 1.
Поэтому это условие (см. листинг 23.4) разрешит вам прочитать ДокНачисления тогда, когда запрос из шаблона не возвращает 1:
ГДЕ НЕ 1 В (#ЕстьПремия("ДокНачисления"))
То есть тогда, когда в табличной части нет начисления Премия.
Можно было бы записать это условие ограничения и без использования шаблонов.
Но, во-первых, такая запись была бы менее читаемой (листинг 23.5), а во-вторых, использование шаблонов позволяет выделить и не дублировать части условий ограничений, которые могут использоваться в разных условиях.
Листинг 23.5. Ограничение доступа к данным
ДокНачисления ГДЕ НЕ 1 В (
ВЫБРАТЬ
1
ИЗ
Документ.НачисленияСотрудникам.Начисления
ГДЕ
Документ.НачисленияСотрудникам.Начисления.ВидРасчета = ЗНАЧЕНИЕ(ПланВидовРасчета.ОсновныеНачисления.Премия)
И Документ.НачисленияСотрудникам.Начисления.Ссылка = ДокНачисления.Ссылка)

#### В прикладном решении
Снова запустите проект от имени пользователя Гусаков и откройте список документов НачисленияСотрудникам.
Как вы помните, в документе № 2 есть строки и с видом расчета Премия, и с видом расчета Оклад. Раньше этот документ у вас открывался.
Попробуйте открыть его теперь.
Вы получите сообщение о нарушении прав доступа, что вам и требовалось (рис. 23.23).

#### В 1C:EDT
Поскольку пример с ограничением прав доступа на уровне записей и полей базы данных вы делали скорее в демонстрационных целях, вернитесь к исходному состоянию конфигурации.
Снимите для роли Мастер право Чтение для документа НачисленияСотрудникам.
Снимите право Просмотр для подсистемы РасчетЗарплаты.
Снимите право Чтение для справочника ВидыГрафиковРаботы и для плана видов расчета Основные начисления.
Запустите проект от имени пользователя Администратор. В разделе Расчет зарплаты откройте список документов НачисленияСотрудникам. Откройте документ № 2 и удалите последнюю строку (которую вы добавляли). Проведите и закройте документ.
## Занятие 24 (1:10). Начальная страница и настройка командного интерфейса
Продолжительность
Ориентировочная продолжительность занятия – 1 час 10 минут.
На этом занятии вы придадите вашей конфигурации «товарный» вид, то есть усовершенствуете командный интерфейс приложения, зададите видимость команд по ролям для созданных вами пользователей, а также настроите командный интерфейс раздела Главное и начальную страницу для каждой роли.
Это сделает интерфейс приложения более лаконичным, интуитивно понятным и, главное, более удобным для пользователя.
На самом деле от внешнего вида и организации интерфейса приложения напрямую зависит, насколько разработанное вами прикладное решение понравится пользователю.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Настройка командного интерфейса разделов
До сих пор вы практически не занимались организацией командного интерфейса разделов (подсистем), так как занимались другими, более важными с точки зрения разработчика вопросами.
Теперь пришло время заняться этим очень существенным для пользователя моментом, то есть осмысленно рассортировать команды, разложить их по группам в зависимости от приоритета и частоты использования.
Кроме того, с помощью видимости команд по ролям вы облегчите интерфейс разделов и сделаете его более «прозрачным» для отдельных пользователей.
#### В 1C:EDT
Если сейчас посмотреть на интерфейс разделов, то вы увидите, что он довольно хаотичен и много места в нем занимают команды для открытия списков и создания новых элементов справочников.
Поскольку работать со справочниками в той или иной мере нужно всем пользователям, то логично все справочники перенести в подсистему Предприятие, доступ к которой вы предоставили всем ролям на предыдущем занятии. Конечно, не все пользователи смогут изменять эти справочники (например, Директор), но удобно, когда вся нормативно-справочная информация находится в одном месте. А интерфейс остальных разделов будет разгружен за счет этой перестановки.
Итак, откройте редактор каждой из подсистем Бухгалтерия, ОказаниеУслуг, РасчетЗарплаты и УчетМатериалов, на закладке Состав удалите из списка объектов этих подсистем все справочники и добавьте их в подсистему Предприятие.
Также добавьте в подсистему Предприятие и те справочники, для которых раньше не было установлено ни одной подсистемы (например, ВариантыНоменклатуры, Субконто и т. п.).
Также добавьте в эту подсистему регистр сведений ЗначенияСвойствНоменклатуры, который содержит соответствие характеристик номенклатуры и их значений.
Теперь вы можете заняться настройкой командного интерфейса для каждого раздела. Расположите команды в порядке их приоритета, установите или скройте их видимость для отдельных ролей.
Откройте редактор командного интерфейса конфигурации и выделите раздел Учет материалов.
Задайте расположение и общую видимость команд раздела следующим образом:
С помощью мыши переместите команду Приходные накладные из группы Панель навигации.Обычное в группу команд Панель навигации.Важное. Это обусловлено тем, что в разделе Учет материалов наиболее часто пользователю может понадобиться создавать приходные накладные и просматривать их список. Команды из группы Важное будут выделены жирным шрифтом в панели команд раздела.
В группе Панель действий.Создать включите видимость команды Цены:создать и задайте следующий порядок расположения этих команд:
Приходная накладная: создать,
Цены:создать.
Следующие группы команд оставьте без изменения:
Группа Панель навигации.Обычное:
Цены.
Группа Панель навигации.См. также:
Остатки материалов,
Стоимость материалов,
Продажи.
Группа Панель действий.Отчеты:
Материалы,
Остатки материалов по свойствам.
То есть вы расположили команды в порядке важности и частоты их использования. У вас должен получиться следующий результат (рис. 24.1).

Рис. 24.1. Командный интерфейс раздела «Учет материалов» {https://ai2b.pro/wp-content/uploads/1/24_01.png}
Теперь вы можете настроить видимость команд по ролям этого раздела.
На подсистему УчетМатериалов имеют права пользователи с ролями Администратор, Директор, Мастер.
Но лучше сразу отметить все роли, которые потом понадобятся для настройки командного интерфейса других подсистем. Для этого нажмите  в командной панели редактора и отметьте все роли (рис. 24.2).

Рис. 24.2. Выбор ролей для настройки ролевой видимости командного интерфейса {https://ai2b.pro/wp-content/uploads/1/24_02.png}
Нажмите ОК. Теперь настройте видимость команд по ролям исходя из следующих соображений:
Просматривать полностью все движения в регистрах накопления (из группы Панель навигации.См. также) может понадобиться только «Администратору», поэтому отключите видимость этих команд для «Директора» и «Мастера».
Команды создания приходной накладной и новой цены (из группы Панель навигации.Создать) нужны только «Мастеру». Директор вообще может только просматривать документы, а Администратор не занимается массовым вводом данных, при необходимости он может создать новые документы через их списки. Поэтому скройте эти команды для «Администратора» и «Директора».
В результате командный интерфейс раздела примет следующий вид (рис. 24.3):

Рис. 24.3. Командный интерфейс раздела «Учет материалов» {https://ai2b.pro/wp-content/uploads/1/24_03.png}
Руководствуясь подобными соображениями, отредактируйте командный интерфейс остальных разделов.
На подсистему ОказаниеУслуг имеют права пользователи с ролями Администратор, Директор, Мастер.
Задайте расположение и общую видимость команд раздела следующим образом:
Группа Панель навигации.Важное:
Оказание услуг.
Группа Панель навигации.Обычное:
Цены.
Группа Панель навигации.См. также:
Остатки материалов,
Стоимость материалов,
Продажи.
Группа Панель действий.Создать:
Оказание услуги: создать,
Цены:создать.
Группа Панель действий.Отчеты:
Материалы,
Реестр документов Оказание услуги,
Рейтинг услуг,
Выручка мастеров,
Перечень услуг,
Рейтинг клиентов,
Универсальный.
Настройте видимость команд по ролям исходя из следующих соображений:
Просматривать полностью все движения в регистрах накопления (из группы Панель навигации.См. также) может понадобиться только «Администратору», поэтому отключите видимость этих команд для «Директора» и «Мастера».
Команды создания документов Оказание услуги и новой цены (из группы Панель навигации.Создать) нужны только «Мастеру». Директор вообще может только просматривать документы, а Администратор не занимается массовым вводом данных, при необходимости он может создать новые документы через их списки. Поэтому скройте эти команды для «Администратора» и «Директора».
В результате командный интерфейс раздела примет следующий вид (рис. 24.4).

Рис. 24.4. Командный интерфейс раздела «Оказание услуг» {https://ai2b.pro/wp-content/uploads/1/24_04.png}
На подсистему Бухгалтерия имеют права пользователи с ролями Администратор, Директор, Бухгалтер.
Задайте расположение и общую видимость команд раздела следующим образом:
Группа Панель навигации.Важное:
Управленческий,
Основной план счетов,
Ввод начальных остатков номенклатуры.
Группа Панель навигации.Обычное:
Приходные накладные,
Оказание услуг,
Цены.
Группа Панель навигации.См. также:
Виды субконто,
Остатки материалов,
Стоимость материалов,
Продажи.
Группа Панель действий.Создать: сделайте все команды невидимыми, так как в этом разделе не предполагается массового создания объектов.
Группа Панель действий.Отчеты:
Оборотно-сальдовая ведомость,
Начисления сотрудникам,
Материалы,
Рейтинг услуг,
Перечень услуг,
Рейтинг клиентов,
Остатки материалов по свойствам.
Настройте видимость команд по ролям исходя из следующих соображений:
Просматривать полностью все движения в регистрах накопления (из группы Панель навигации.См. также) может понадобиться только «Администратору», поэтому отключите видимость этих команд для «Директора» и «Бухгалтера».
Команда для просмотра видов субконто (из группы Панель навигации.См. также) не понадобится «Директору», так как это чисто бухгалтерская специфика. Отключите видимость этой команды для «Директора».
В результате командный интерфейс раздела примет следующий вид (рис. 24.5).

Рис. 24.5. Командный интерфейс раздела «Бухгалтерия» {https://ai2b.pro/wp-content/uploads/1/24_05.png}
На подсистему РасчетЗарплаты имеют права пользователи с ролями Администратор, Директор, Расчетчик.
Задайте расположение и общую видимость команд раздела следующим образом:
Группа Панель навигации.Важное:
Начисления сотрудникам,
Графики работы.
Группа Панель навигации.Обычное:
Виды расчетов,
Начисления.
Группа Панель действий.Создать:
Начисление сотрудникам: создать.
Группа Панель действий.Отчеты:
Начисления сотрудникам,
Диаграмма начислений,
Выручка мастеров.
Настройте видимость команд по ролям исходя из следующих соображений:
Команда для просмотра плана видов расчетов (из группы Панель навигации.Обычное) не понадобится «Директору». Скройте эту команду для «Директора».
Команда для анализа движений в регистре Начисления (из группы Панель навигации.Обычное) может понадобиться только «Администратору». Поэтому скройте эту команду для «Директора» и «Расчетчика».
Команда для создания документов Начисления сотрудникам (из группы Панель навигации.Создать) нужна только «Расчетчику». Поэтому отключите видимость этой команды для «Директора» и «Администратора». А для команд создания графиков работы и видов расчетов (ОсновныеНачисления) вы еще раньше отключили общую видимость, так как массового ввода этих данных не предполагается.
Для отчета Перерасчет отключите общую видимость, так как это чисто технический отчет, который вы использовали в 19-м занятии.
В результате командный интерфейс раздела примет следующий вид (рис. 24.6).

Рис. 24.6. Командный интерфейс раздела «Расчет зарплаты» {https://ai2b.pro/wp-content/uploads/1/24_06.png}
На подсистему Предприятие имеют права все пользователи. В данном разделе будет отображаться нормативно-справочная информация.
Команды для открытия списков справочников расположите в порядке их приоритета и частоты использования, а для команд создания элементов справочников отключите общую видимость. Дело в том, что массового ввода этих данных не предполагается, а там, где возникает необходимость создания таких новых объектов, их удобно создавать прямо из выпадающего списка в поле ввода.
В результате командный интерфейс раздела будет выглядеть следующим образом:
Группа Панель навигации.Важное:
Номенклатура,
Клиенты,
Сотрудники,
Склады.
Группа Панель навигации.Обычное:
Варианты номенклатуры,
Дополнительные свойства номенклатуры,
Субконто,
Виды графиков работы,
Значения свойств номенклатуры.
Для «Директора» отключите видимость команд для просмотра списков справочников из группы Панель навигации.Обычное, так как это несущественные «подробности» для пользователя с этой ролью.
В результате командный интерфейс раздела примет вид (рис. 24.7).

Рис. 24.7. Командный интерфейс раздела «Предприятие» {https://ai2b.pro/wp-content/uploads/1/24_07.png}

#### В прикладном решении
Запустите проект для пользователя с ролью Администратор.
Посмотрите, как структурированно и лаконично выглядит теперь интерфейс приложения, например, в разделе Расчет зарплаты (рис. 24.8).

Рис. 24.8. Командный интерфейс раздела «Расчет зарплаты» {https://ai2b.pro/wp-content/uploads/1/24_08.png}
Группы команд в каждом разделе зрительно отделены друг от друга, а наиболее важные команды в панели команд разделов выделены жирным шрифтом. Те команды, которые не поместились в панели функций текущего раздела, содержатся в подменю Еще.
Итак, вы настроили командный интерфейс разделов согласно вашим представлениям о работе прикладного решения.
Однако если у пользователя другие предпочтения, то в прикладном решении он может настраивать командный интерфейс по своему усмотрению. Для этого нужно вызвать меню функций раздела из главной панели приложения (или дважды щелкнуть мышью на названии раздела) и выполнить команду Настройка навигации или Настройка действий (рис. 24.9).
Помимо этого пользователь может открыть меню функций раздела и пометить как избранные наиболее часто используемые им команды. Они будут помечены звездочкой слева от названия команды (рис. 24.9).

Рис. 24.9. Меню функций раздела «Бухгалтерия» {https://ai2b.pro/wp-content/uploads/1/24_09.png}
Затем, открыв Избранное из главной панели, можно также пометить наиболее важные из списка избранных элементов. Они будут помечены специальной пиктограммой (рис. 24.10). Также они будут выделены жирным шрифтом и расположены вверху списка избранного, чтобы пользователь мог быстро их найти.

Рис. 24.10. Список избранного для пользователя с ролью «Бухгалтер» {https://ai2b.pro/wp-content/uploads/1/24_10.png}

### Раздел «Главное». Настройка начальной страницы
Раздел Главное в интерфейсе приложения предназначен для размещения наиболее часто используемых пользователем документов, отчетов, справочников и т. п.
В рабочей области раздела Главное для каждого пользователя содержится начальная страница, на которую нужно поместить те формы документов, отчетов и пр., работа с которыми входит в его ежедневные должностные обязанности. В панели команд раздела Главное для каждого пользователя нужно поместить наиболее важные для него команды в соответствии с его ролью.
Например, для кладовщика было бы удобно иметь под руками список номенклатуры и список приходных накладных, для менеджера – список клиентов и документов оказания услуг и т. д.
При запуске прикладного решения раздел Главное становится активным по умолчанию и нужные формы сразу открываются в рабочей области основного окна приложения (рис. 24.11).

Рис. 24.11. Раздел «Главное» для пользователя с ролью «Директор» {https://ai2b.pro/wp-content/uploads/1/24_11.png}
Таким образом, пользователю не нужно ходить по разделам, искать в них нужную команду, а можно сразу начинать работать, предварительно включив компьютер и запустив прикладное решение.
Однако не стоит перегружать раздел Главное и начальную страницу различными формами и командами, иначе вместо удобства пользователь будет ощущать дискомфорт.
#### В 1C:EDT
Для настройки командного интерфейса основного раздела достаточно выделить этот раздел в том же редакторе командного интерфейса, в котором вы производили настройку разделов прикладного решения.
Чтобы добавить команды в основной раздел, нажмите  в командной панели редактора и выберите нужные вам команды (рис. 24.12):
Оказание услуги: создать,
Приходная накладная: создать,
Выручка мастеров,
Материалы.

Рис. 24.12. Выбор команд, отображающихся в основном разделе {https://ai2b.pro/wp-content/uploads/1/24_12.png}
Нажмите ОК. Затем установите видимость выбранных команд для каждой роли.
Для роли Мастер наиболее важными будут команды для создания документов Приходная накладная и Оказание услуги, а также команды для открытия отчетов Материалы и Выручка мастеров. Для команд создания документов установите видимость только для роли Мастер. Для команд открытия отчетов снимите видимость для всех ролей, кроме Мастер и Директор (рис. 24.13).

Рис. 24.13. Редактор командного интерфейса основного раздела {https://ai2b.pro/wp-content/uploads/1/24_13.png}
ПРИМЕЧАНИЕ
Если флажок видимости у роли полностью затенен (черный квадратик), это значит, что видимость команды для роли соответствует общей видимости. Чтобы включить видимость для отдельной роли независимо от общей видимости, нужно дважды щелкнуть в окне видимости до появления отметки. Если щелкнуть один раз и снять отметку, то можно отключить видимость команды для конкретной роли, хотя общая видимость этой команды будет включена.
Таким же образом (рис. 24.12) добавьте необходимые команды для остальных ролей и установите их видимость.
Для роли Расчетчик приоритетными командами являются команды для создания документа Начисление сотрудникам и просмотра отчета Начисления сотрудникам. Для команды создания документа установите видимость только для роли Расчетчик. Для команды открытия отчета оставьте видимость только для ролей Расчетчик и Директор.
Для роли Бухгалтер добавьте в панель команд основного раздела команды для создания документа Ввод начальных остатков номенклатуры и просмотра отчета Оборотно-сальдовая ведомость. Для команды создания документа установите видимость только для роли Бухгалтер. Для команды открытия отчета оставьте видимость только для ролей Бухгалтер и Директор.
Для роли Директор приоритетными являются команды для просмотра самых важных отчетов: Материалы, Выручка мастеров, Начисления сотрудникам, Оборотно-сальдовая ведомость. Эти команды вы уже добавили в панель команд основного раздела и сделали их видимыми для роли Директор.
Для роли Администратор панель команд основного раздела остается пока пустой, а позднее вы поместите туда команды управления обменом данными.
В результате редактор командного интерфейса основного раздела примет следующий вид (рис. 24.14).

Рис. 24.14. Редактор командного интерфейса основного раздела {https://ai2b.pro/wp-content/uploads/1/24_14.png}
Теперь выполните настройку начальной страницы. Для этого в панели Навигатор нажмите Открыть рабочую область начальной страницы в контекстном меню вашей конфигурации.
Откроется редактор рабочей области начальной страницы, в котором вы можете добавить формы, созданные в конфигурации, и настроить их ролевую видимость (рис. 24.15). Сначала вверху окна выберите шаблон макета начальной страницы Две колонки, различная ширина (2:1).

Рис. 24.15. Редактор начальной страницы {https://ai2b.pro/wp-content/uploads/1/24_15.png}
Это значит, что формы на начальной странице будут располагаться в две колонки, при этом левая колонка будет в два раза шире правой.
Можно выбрать другой шаблон, при котором колонки будут одинаковой ширины или будет всего одна колонка. Но кажется, что предпочтительнее первый вариант (2:1), так как в этом случае взгляд пользователя сразу будет падать на наиболее приоритетные для работы формы, которые вы расположите в левой колонке.
Следует иметь в виду, что автоматически сгенерированные системой формы нельзя располагать на начальной странице. Поэтому, прежде чем добавлять форму на начальную страницу, нужно создать ее в явном виде в конфигурации. Чтобы не путаться, вы будете создавать нужные формы прямо по ходу.
Итак, сначала настройте начальную страницу для роли Мастер.
ООО «На все руки мастер» – фирма по оказанию услуг, и мастера имеют к этому непосредственное отношение. Поэтому логично, если для мастеров в левой колонке начальной страницы будет располагаться список документов об оказании услуг, а в правой колонке – список приходных накладных.
Перечисленные формы списка отсутствуют в конфигурации, поэтому создайте формы списка для объектов конфигурации:
документ ПриходнаяНакладная,
документ ОказаниеУслуги.
По умолчанию в форме списка документов присутствуют только колонки Дата и Номер. Добавьте вручную в форму списка документа ПриходнаяНакладная колонку Склад (рис. 24.16).

Рис. 24.16. Создание формы списка документа «Приходная накладная» {https://ai2b.pro/wp-content/uploads/1/24_16.png}
Аналогично добавьте в форму списка документа ОказаниеУслуги колонки Склад, Клиент, Мастер.
Теперь в редакторе начальной страницы нажмите Добавить над списком форм левой колонки.
Выберите форму списка документа ОказаниеУслуги (рис. 24.17).

Рис. 24.17. Настройка начальной страницы для пользователя с ролью «Мастер» {https://ai2b.pro/wp-content/uploads/1/24_17.png}
Аналогичным образом в правую колонку добавьте форму списка документа ПриходнаяНакладная.
Теперь для каждой из форм нажмите ссылку в колонке Видимость. В окне настройки видимости снимите общую видимость формы и установите видимость этих форм только для роли Мастер (рис. 24.18).

Рис. 24.18. Настройка начальной страницы для пользователя с ролью «Мастер» {https://ai2b.pro/wp-content/uploads/1/24_18.png}
Теперь настройте начальную страницу для роли Бухгалтер.
Предположим, бухгалтер наиболее часто будет пользоваться оборотно-сальдовой ведомостью. Расположите этот отчет в левой колонке начальной страницы, а правую оставьте пустой.
Сначала создайте форму отчета для отчета ОборотноСальдоваяВедомость. Затем в редакторе начальной страницы добавьте эту форму в левую колонку и установите видимость этой формы только для роли Бухгалтер.
Затем настройте начальную страницу для роли Расчетчик.
По роду деятельности расчетчик в основном пользуется документами и отчетами о начислениях сотрудникам. Расположите список документов о начислениях сотрудникам в правой колонке начальной страницы. А отчет о начислениях сотрудникам расчетчик всегда может открыть из панели команд раздела Главное.
Сначала создайте форму списка документа НачисленияСотрудникам. Затем в редакторе начальной страницы добавьте форму списка в правую колонку и установите видимость этой формы только для роли Расчетчик.
Затем настройте начальную страницу для роли Директор.
Предполагается, что эта роль будет назначена пользователю, осуществляющему руководящие функции. Ему не нужно вводить никаких документов, да у него и нет на это прав. Но ему понадобится регулярно просматривать отчеты о деятельности фирмы, чтобы принимать руководящие решения.
Команды для открытия наиболее важных для директора отчетов будут находиться в панели команд раздела Главное. На его начальной странице расположите один отчет Выручка мастеров. Сначала создайте форму этого отчета, затем в редакторе начальной страницы добавьте эту форму в левую колонку и установите видимость этой формы только для роли Директор.
Для роли Администратор начальная страница останется пока пустой, а позднее вы расположите на ней формы для управления обменом данными.
В результате редактор рабочей области начальной страницы должен принять следующий вид (рис. 24.19).

Рис. 24.19. Редактор начальной страницы {https://ai2b.pro/wp-content/uploads/1/24_19.png}
Если у пользователя на начальной странице видима только какая-то одна форма (например, у директора – отчет Выручка мастеров, у расчетчика – список документов о начислениях сотрудникам), то эти формы в интерфейсе приложения растягиваются на всю ширину начальной страницы, независимо от того, в какой колонке начальной страницы (правой или левой) они изначально находились в 1С:EDT.
Если же для одной роли видимы несколько форм и все они расположены в какой-то одной колонке начальной страницы в 1С:EDT, то в интерфейсе приложения на начальной странице они будут показаны друг под другом.

#### В прикладном решении
Обновите конфигурацию информационной базы, а затем с помощью значка «1С:Предприятие» на рабочем столе запустите проект от имени пользователя, обладающего ролями Бухгалтер и Расчетчик (пользователь Назарова). Нажмите Сформировать в оборотно-сальдовой ведомости.
Вы увидите такую начальную страницу (рис. 24.20).

Рис. 24.20. Начальная страница для пользователя с ролями «Бухгалтер», «Расчетчик» {https://ai2b.pro/wp-content/uploads/1/24_20.png}
Обратите внимание, что на начальной странице находится также список документов о начислениях сотрудникам, так как пользователь Назарова имеет две роли: Бухгалтер и Расчетчик. А также этому пользователю доступны разделы Бухгалтерия, Расчет зарплаты и Предприятие в соответствии с правами, которые вы установили для этих ролей на предыдущем занятии.
А для пользователя Деловой (обладающего ролью Директор) начальная страница будет выглядеть следующим образом (рис. 24.21).

Рис. 24.21. Начальная страница для пользователя с ролью «Директор» {https://ai2b.pro/wp-content/uploads/1/24_21.png}
Причем для директора нужно показывать красивый вариант этого отчета в виде измерительной диаграммы. Поскольку в конфигурации задать стартовый вариант отчета нельзя, нужно зайти в систему от имени пользователя с ролью Директор и выбрать вариант отчета Объем выручки. В дальнейшем этот вариант отчета станет вариантом по умолчанию для данного пользователя.
Для пользователя Гусаков (обладающего ролью Мастер) начальная страница будет выглядеть следующим образом (рис. 24.22).

Рис. 24.22. Начальная страница для пользователя с ролью «Мастер» {https://ai2b.pro/wp-content/uploads/1/24_22.png}
Этому пользователю доступны разделы Учет материалов, Оказание услуг и Предприятие в соответствии с правами, которые вы установили для этой роли на предыдущем занятии.
Если теперь мастер откроет какой-то из документов, то слева от заголовка документа будет доступна кнопка Начальная страница (со значком домика) для перехода на начальную страницу (рис. 24.23).

Рис. 24.23. Возврат на начальную страницу {https://ai2b.pro/wp-content/uploads/1/24_23.png}
Таким образом, вы добились того, что при запуске прикладного решения для каждой роли, например для пользователя с ролью Мастер, на начальной странице сразу открываются формы списков документов, нужные ему для работы. А в панели команд раздела Главное находятся команды для создания этих документов и наиболее важные для мастера отчеты.
Кроме начальной страницы каждый пользователь, безусловно, может пользоваться всей функциональностью других разделов прикладного решения, которая ему доступна в соответствии с его правами.
И, наконец, в процессе работы прикладного решения пользователь может настраивать начальную страницу по своему усмотрению, выполнив команду главного меню Настройки > Настройка начальной страницы.
Но следует иметь в виду, что пользователь может размещать на своей начальной странице только те формы, которые разработчик создал в конфигурации.
Если же какой-то пользователь решит минимизировать командный интерфейс и тем самым расширить рабочее пространство, то он может скрыть все панели прикладного решения, кроме главной панели, по команде главного меню Настройки > Скрыть все панели (рис. 24.24).

Рис. 24.24. Минималистичный командный интерфейс приложения {https://ai2b.pro/wp-content/uploads/1/24_24.png}
В реальной конфигурации, конечно, роли пользователей и наполнение их начальных страниц будут другими. Это зависит от специфики работы предприятия и пожеланий заказчика.
На последних двух занятиях был показан только принцип организации интерфейса прикладного решения по ролям и ограничения доступа к отдельным командам и разделам в целом в зависимости от прав пользователя.

## Занятие 25 (6:10). Обмен данными
Продолжительность
Ориентировочная продолжительность занятия – 6 часов 10 минут.
На этом занятии вы познакомитесь с механизмами обмена данными, которые содержит система «1С:Предприятие», и добавите в вашу конфигурацию возможность обмена данными с удаленными филиалами и отделениями.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Общие сведения об обмене данными
Механизмы обмена данными «1С:Предприятия» позволяют организовывать обмен информацией, хранимой в базе данных, с другими программными системами.
В качестве таких систем могут выступать как другие информационные базы «1С:Предприятия» (имеющие аналогичную или отличающуюся конфигурацию), так и программные системы, не основанные на «1С:Предприятии».
Такая гибкость обмена данными достигается за счет того, что средства обмена данными «1С:Предприятия» могут использоваться в различных комбинациях. Кроме того, формат обмена данными основан на языке XML, являющемся распространенным средством представления данных.
К механизмам обмена данными могут быть отнесены:
планы обмена,
XML-сериализация,
средства чтения и записи документов XML.
В общем случае схема взаимодействия этих трех составляющих может быть представлена следующим образом (рис. 25.1).

Рис. 25.1. Схема взаимодействия механизмов обмена данными {https://ai2b.pro/wp-content/uploads/1/25_01.png}
При помощи планов обмена вы получаете информацию о том, какие элементы данных были изменены и в какой узел обмена их необходимо передать.
Это возможно благодаря тому, что планы обмена содержат механизм регистрации изменений. Информация об измененных данных переносится с помощью сообщений, инфраструктура которых также поддерживается планами обмена.
XML-сериализация позволяет преобразовать объект «1С:Предприятия» в последовательность данных, представленных в формате XML. Кроме этого XML-сериализация выполняет и обратное преобразование – преобразует последовательность данных формата XML в объект «1С:Предприятия», при условии что имеется соответствующий тип «1С:Предприятия».
Запись и чтение документов XML обеспечивают запись/чтение документов формата XML из встроенного языка.
При реализации алгоритма обмена данными перечисленные механизмы могут быть использованы как все вместе, так и в различных комбинациях. В каждом конкретном случае вы можете решать эту задачу самостоятельно.
В примере, приведенном в этой книге, вы будете использовать все эти три механизма. Поэтому, прежде чем перейти непосредственно к написанию кода, познакомьтесь с каждым из них подробнее.
#### Что такое план обмена
Для того чтобы существовала возможность обмена какими-либо данными с кем-либо, необходимо некоторым образом идентифицировать тех, с кем вы будете обмениваться, и для каждого из них описать перечень обмена. Обе эти задачи позволяет решать объект конфигурации План обмена.
Подобно тому как элементами данных справочника являются элементы справочника, элементами данных плана обмена являются узлы плана обмена.
Каждый узел идентифицирует участника обмена по данному плану обмена. Кроме того, в каждом плане обмена всегда существует один предопределенный узел, идентифицирующий данную информационную базу.
В одной конфигурации может существовать несколько планов обмена. Каждый план обмена определяет набор данных, которыми будет производиться обмен в рамках данного плана, и сам механизм этого обмена.
Наличие нескольких планов обмена может потребоваться, если с разными узлами ведется обмен разным составом данных или когда схема организации обмена с одними узлами отличается от схемы организации обмена с другими узлами.
Узнай больше!
О структуре объектов встроенного языка, предназначенных для работы с планом обмена, можно прочитать в разделе «Краткий справочник разработчика. Планы обмена».
В обмене данными могут участвовать:
объекты базы данных: элементы справочников, документы и т. д.;
необъектные данные: наборы записей регистров, последовательностей, константы;
специальный объект встроенного языка – УдалениеОбъекта.
Для упрощения изложения в дальнейшем эти элементы информационных структур будут называться объектами обмена.
Вы можете определить состав каждого плана обмена, указав объекты конфигурации, данные которых должны участвовать в обмене по данному плану.
При описании состава данных плана обмена можно указать для каждого типа объектов признак Авторегистрация. Этот признак определяет, каким образом план обмена будет отслеживать изменения данных.
Возможность отслеживать изменения данных реализована в плане обмена за счет использования механизма регистрации изменений.
Работа этого механизма базируется на том, что каждый из объектов обмена имеет свойство ОбменДанными, с помощью которого можно указать, для каких узлов необходимо производить регистрацию изменений этого объекта. Любые изменения объекта обмена сводятся в конечном итоге к записи или удалению объекта обмена. Механизм регистрации изменений анализирует события записи и удаления объектов обмена и на основании параметров обмена данными, содержащихся в каждом из объектов обмена, формирует записи регистрации изменений. Следует отметить, что свойство ОбменДанными не хранится в базе данных, а используется только во время записи объекта обмена.
Так вот, признак Авторегистрация, устанавливаемый при указании состава данных плана обмена, позволяет указать, что параметры обмена данными будут формироваться каждый раз самим механизмом регистрации изменений на основании информации, содержащейся в плане обмена.
После автоматического заполнения параметров обмена вы также можете внести изменения в сформированные таким образом параметры. Для этого следует использовать обработчики событий объектов, участвующих в обмене: ПередЗаписью и ПередУдалением, в которых можно модифицировать список узлов-получателей (то есть тех узлов, для которых регистрируются изменения).
Кроме того, существует возможность отключить авторегистрацию изменений, и тогда параметры обмена данными нужно будет формировать полностью средствами встроенного языка. Гипотетически это можно делать в любом фрагменте кода, но для того, чтобы конфигурация была легко читаема, рекомендуется использовать все те же обработчики событий ПередЗаписью и ПередУдалением. В этом случае код формирования параметров обмена данными будет сосредоточен в логически понятных точках, а не разбросан по всей конфигурации.
Итак, как вы теперь знаете, при записи и удалении объектов обмена план обмена формирует записи регистрации изменений. Эти записи хранятся в таблицах регистрации изменений, причем для каждого объекта обмена ведется своя таблица.
При изменении объекта обмена в таблице регистрации изменений создается столько записей, сколько узлов-получателей указано в параметрах обмена данными у объекта обмена. Каждая запись при этом будет хранить ссылку на свой узел-получатель. Таблицы регистрации изменений создаются лишь в том случае, если соответствующий объект метаданных указан в хотя бы одном плане обмена.
Кроме ссылки на узел обмена, для которого регистрируются изменения, каждая запись таблицы регистрации изменений хранит также номер сообщения, в котором изменение было передано в первый раз в этот узел. До тех пор, пока сообщение не будет передано в первый раз, это поле хранит Null.
Сообщение с точки зрения плана обмена – это единица обмена информацией. Поэтому одной из важнейших составляющих плана обмена, помимо службы регистрации изменений, является инфраструктура сообщений.
Поскольку сообщения передаются в рамках плана обмена от одного узла к другому, каждое сообщение точно ассоциировано с планом обмена, имеет уникальный номер и одного отправителя и получателя. За нумерацию сообщений отвечает инфраструктура сообщений. Благодаря этому записи регистрации изменений и имеют возможность хранить номера сообщений, в которых эти изменения были переданы первый раз.
Инфраструктура сообщений позволяет также получать подтверждения от узла-получателя о приеме сообщений. Такое подтверждение содержится в каждом сообщении, приходящем от узла-получателя в виде номера последнего принятого сообщения.
Впоследствии, проанализировав номер последнего принятого сообщения и номера сообщений, содержащиеся в записях регистрации изменений, вы можете удалить записи регистрации изменений, прием которых подтвержден получателем.

#### XML-сериализация
Термином XML-сериализация обозначается механизм, позволяющий представить объект «1С:Предприятия» в виде последовательности данных в формате XML. Кроме этого XML-сериализация позволяет выполнить и обратное преобразование – представить последовательность данных формата XML в виде объекта «1С:Предприятия», если существует подходящий тип данных.
Дело в том, что объект обмена, являющийся в системе «1С:Предприятие» единым целым, на самом деле представляет собой совокупность данных различных типов, определенным образом связанных между собой.
Например, элемент справочника кроме кода и наименования может содержать некоторое количество реквизитов различного типа и некоторое количество табличных частей, содержащих, в свою очередь, некоторое количество реквизитов различного типа.
В результате XML-сериализации вся эта совокупность данных представляется в виде последовательности соответствующих данных формата XML.
Вследствие обратного преобразования производится «сборка» объекта – при условии, что существует подходящий тип данных «1С:Предприятия».

#### Запись/чтение документов XML
В отличие от XML-сериализации механизмы записи/чтения документов XML позволяют работать с данными формата XML на базовом уровне, без привязки к объектам «1С:Предприятия».
В частности, они позволяют открывать файлы XML для чтения, читать данные из файлов, создавать новые файлы XML и записывать в них данные.

### Универсальный механизм обмена данными
Итак, ваше ООО «На все руки мастер» открыло свой филиал в городе N и установило в нем такую же конфигурацию для учета работы филиала.
В результате возникла необходимость наладить обмен данными между этими двумя базами таким образом, чтобы каждая из них отражала полную информацию о материалах и услугах, в то время как бухгалтерский учет и расчет зарплаты велись бы в каждой базе отдельно.
Для этого вы создадите план обмена, опишете состав данных, которые будут включены в обмен, и сделаете несколько процедур, позволяющих вам формировать на жестком диске файлы обмена и, соответственно, загружать полученные файлы обмена с жесткого диска.
Для упрощения примера вы не будете программировать какой-либо автоматический обмен файлами между двумя базами и запуск процедуры обмена будете осуществлять вручную.
Прежде чем вы начнете непосредственно программировать алгоритм обмена, следует сказать о некоторых доработках, которые вам придется предварительно внести в вашу базу.
Эти доработки будут связаны с тем, что до сих пор вы работали только в одной базе и использовали уникальность номеров кодов справочников и номеров документов.
Теперь, когда создание новых элементов справочников и новых документов будет происходить в двух базах одновременно и независимо друг от друга, вам снова необходимо обеспечить уникальность номеров кодов элементов справочников и номеров документов – теперь уже «в пространстве» двух баз.
Если вы этого не сделаете, то не исключено, что в каждой из баз будут созданы, например, новые документы с одинаковыми номерами и при обмене данными возникнет конфликт, поскольку система будет пытаться записать в базу документ с номером, который уже используется другим документом.
Для исключения подобных ситуаций в каждой базе к номерам документов и кодам справочников вы будете добавлять уникальный префикс, однозначно идентифицирующий базу данных.
Тогда, даже если номера новых документов в двух базах совпадут, они все равно будут отличаться префиксом и конфликта не возникнет.
Для хранения префикса номеров вы будете использовать объект конфигурации Константа.
#### Константа для обмена данными
Объект конфигурации Константа предназначен для создания в базе данных таблиц, в которых будет храниться информация, не изменяющаяся во времени или изменяющаяся очень редко.
Каждый объект конфигурации Константа описывает таблицу для хранения одного значения.
Теперь пора приступить к созданию константы, в которой вы будете хранить значение префикса номеров.
Добавьте объект конфигурации – константу с именем ПрефиксНумерации.
Установите тип значения константы – Строка с фиксированной длиной 2 символа.

#### Доработка объектов конфигурации, участвующих в обмене
Первое, что вам следует сделать, – внести изменения в модули всех объектов, участвующих в обмене (в вашем случае это будут документы, справочники и планы видов характеристик).
Эти изменения будут заключаться в том, что теперь при формировании номера документа и кода справочника или плана видов характеристик будет использоваться значение константы ПрефиксНумерации для обеспечения уникальности номеров и кодов в каждой из ваших баз.
Функцию формирования префикса номера вы вынесете в общий модуль, поскольку не исключена возможность того, что в будущем алгоритм формирования префикса документов может быть изменен.
Добавьте в конфигурацию общий модуль Обмен. В свойствах этого модуля должны быть установлены флажки Сервер и Вызов сервера.
В модуль поместите следующую функцию (листинг 25.1).
Листинг 25.1. Функция формирования префикса номера
Функция ПолучитьПрефиксНомера() Экспорт
 
Возврат Константы.ПрефиксНумерации.Получить();
 
КонецФункции
Как вы видите, эта функция просто возвращает значение константы ПрефиксНумерации.
Теперь доработайте справочник Клиенты.
Откройте модуль этого объекта и добавьте в него обработчик события ПриУстановкеНовогоКода (листинг 25.2).
Листинг 25.2. Обработчик события «ПриУстановкеНовогоКода»
Процедура ПриУстановкеНовогоКода(СтандартнаяОбработка, Префикс)
 
Префикс = Обмен.ПолучитьПрефиксНомера();
 
КонецПроцедуры
Событие ПриУстановкеНовогоКода возникает в момент, когда выполняется установка нового кода элемента справочника. Обратите внимание: вы пишете этот код не в модуле формы, а в модуле объекта, поскольку это событие возникает не для формы, а для объекта в целом.
Вторым параметром вызова обработчика передается префикс, который будет заполнен в данной процедуре и использован системой для генерации кода.
В обработчике события вы вызываете функцию общего модуля Обмен. Поскольку модуль неглобальный, то вы обращаетесь к ней по имени модуля и имени функции (Обмен.ПолучитьПрефиксНомера). В этой процедуре вы устанавливаете префикс равным значению константы ПрефиксНумерации.
Такие же обработчики нужно будет добавить в модули всех справочников и планов видов характеристик, участвующие в обмене.
В вашем случае это:
Справочники:
Сотрудники,
Склады,
Номенклатура,
ВариантыНоменклатуры,
ДополнительныеСвойстваНоменклатуры.
План видов характеристик: СвойстваНоменклатуры.
После этого у всех этих объектов и у справочника Клиенты нужно увеличить длину кода до 11 символов.
Теперь доработайте документы, участвующие в обмене.
В модуль документа ПриходнаяНакладная добавьте обработчик события ПриУстановкеНовогоНомера (листинг 25.3).
Листинг 25.3. Обработчик события «ПриУстановкеНовогоНомера»
Процедура ПриУстановкеНовогоНомера(СтандартнаяОбработка, Префикс)
 
Префикс = Обмен.ПолучитьПрефиксНомера();
 
КонецПроцедуры
Такие же обработчики нужно будет добавить во все документы, участвующие в обмене.
В вашем случае это еще один документ – ОказаниеУслуги.
После этого для обоих документов нужно увеличить длину номера до 11 символов.
На этом подготовительная работа с существующими объектами конфигурации завершена, и вы можете перейти к созданию процедур обмена данными.

#### Создание плана обмена
Теперь вы займетесь созданием центра любого алгоритма обмена данными, вокруг которого группируются прочие механизмы, – плана обмена.
Добавьте объект конфигурации – план обмена с именем Филиалы. Установите представление объекта – Филиал.
Затем добавьте реквизит плана обмена Главный, имеющий тип Булево (рис. 25.2).

Рис. 25.2. Реквизит плана обмена {https://ai2b.pro/wp-content/uploads/1/25_02.png}
Этот реквизит понадобится вам для того, чтобы разрешать коллизии при обмене данными. Под коллизией понимается ситуация, когда один и тот же объект обмена данными был изменен одновременно в двух узлах.
В этом случае вы будете анализировать значение реквизита Главный и принимать изменения только в том случае, если они сделаны в главном узле. В случае коллизии изменения, произведенные не в главном узле, вы будете отвергать.
Теперь определите состав объектов, участвующих в обмене. Для этого на закладке Состав редактора плана обмена нажмите  над списком объектов. Включите в обмен все объекты, не относящиеся к ведению бухгалтерии и расчету зарплаты (рис. 25.3).

Рис. 25.3. Состав данных обмена {https://ai2b.pro/wp-content/uploads/1/25_03.png}
Обратите внимание, что константа ПрефиксНумерации не участвует в обмене, поскольку ее значение должно быть уникальным для каждой базы, участвующей в обмене.
Теперь создайте для вашего плана обмена основную форму узла.
Затем создайте обработчик события формы ПриСозданииНаСервере.
Этот обработчик понадобится вам для того, чтобы запретить установку реквизита Главный для предопределенного узла, соответствующего данной информационной базе (листинг 25.4).
Листинг 25.4. Обработчик события формы «ПриСозданииНаСервере»
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
 
Если Объект.Ссылка = ПланыОбмена.Филиалы.ЭтотУзел() Тогда
Элементы.Главный.Доступность = Ложь;
 
КонецЕсли;
 
КонецПроцедуры
В этой процедуре вы используете метод менеджера плана обмена ЭтотУзел(), который возвращает ссылку на узел плана обмена, соответствующий данной информационной базе.
Затем создайте основную форму списка плана обмена, чтобы описать в ней некоторые действия по регистрации нового узла обмена.
Суть этих действий будет заключаться в том, что при регистрации нового узла обмена вы должны будете сформировать для него все необходимые записи регистрации изменений для всех объектов конфигурации, входящих в данный план обмена. Это будет своего рода начальная синхронизация узла обмена всеми данными обмена.
Для этого создайте в форме команду ЗарегистрироватьИзменения. Затем создайте обработчик этой команды, выполняющейся на сервере без контекста формы (тип обработчика Создать на клиенте и процедуру на сервере без контекста).
В модуле формы будут созданы шаблоны двух процедур: клиентской процедуры ЗарегистрироватьИзменения() и серверной внеконтекстной процедуры ЗарегистрироватьИзмененияНаСервере(), которая вызывается из клиентской процедуры.
Как вы уже знаете, внеконтекстная процедура выполняется на сервере значительно быстрее за счет того, что на сервер с клиента не передается весь контекст формы.
В процедуру ЗарегистрироватьИзмененияНаСервере() вам нужно передать в качестве параметра ссылку на объект ПланОбмена.Филиалы, используя свойство ТекущаяСтрока для таблицы Список (источником данных этой таблицы является динамический список узлов плана обмена Филиалы).
Поэтому измените текст модуля следующим образом (листинг 25.5).
Листинг 25.5. Текст обработчика команды «ЗарегистрироватьИзменения»
&НаКлиенте
Процедура ЗарегистрироватьИзменения(Команда)
 
ЗарегистрироватьИзмененияНаСервере(Элементы.Список.ТекущаяСтрока);
 
КонецПроцедуры
 
&НаСервереБезКонтекста
Процедура ЗарегистрироватьИзмененияНаСервере(Узел)
 
// Вставить содержимое обработчика.
 
КонецПроцедуры
В процедуру ЗарегистрироватьИзмененияНаСервере()поместите следующий текст (листинг 25.6).
Листинг 25.6. Процедура «ЗарегистрироватьИзмененияНаСервере»
&НаСервереБезКонтекста
Процедура ЗарегистрироватьИзмененияНаСервере(Узел)
 
// Регистрация изменений всех данных для узла.
ПланыОбмена.ЗарегистрироватьИзменения(Узел);
 
КонецПроцедуры
В этой процедуре вы обращаетесь к механизму регистрации изменений, вызывая метод менеджера планов обмена – ЗарегистрироватьИзменения().
В этот метод передается ссылка на текущий узел плана обмена Филиалы.
В результате выполнения этой процедуры в информационной базе будут созданы записи регистрации изменений, предназначенные для пересылки в созданный вами узел, для всех объектов обмена, указанных в данном плане обмена.
Теперь перетащите команду ЗарегистрироватьИзменения в командную панель формы. В результате форма списка примет следующий вид (рис. 25.4).

Рис. 25.4. Форма списка плана обмена {https://ai2b.pro/wp-content/uploads/1/25_04.png}
Заметьте, что при перетаскивании команды в дерево элементов формы имя кнопки может не совпадать с именем команды, с которой она связана. В частности, при перетаскивании команды в командную панель формы к имени команды автоматически добавляется префикс «Форма». Поэтому кнопке присваивается имя ФормаЗарегистрироватьИзменения. Именно по этому имени вы будете обращаться к кнопке из встроенного языка (см. листинг 25.8).
Причем кнопка Зарегистрировать изменения должна быть доступна только в том случае, если текущий узел не является предопределенным для данной информационной базы, иначе регистрация изменений невозможна.
Чтобы обеспечить такое поведение кнопки, создайте в модуле формы списка функцию, выполняющуюся на сервере без контекста и возвращающую истину, если переданный в функцию узел является предопределенным (листинг 25.7).
Листинг 25.7. Функция «ПредопределенныйУзел()»
&НаСервереБезКонтекста
Функция ПредопределенныйУзел(Узел)
 
Возврат Узел = ПланыОбмена.Филиалы.ЭтотУзел();
 
КонецФункции
Затем создайте клиентский (исполняющийся на клиенте) обработчик события ПриАктивизацииСтроки для элемента формы Список и заполните его следующим образом (листинг 25.8).
Листинг 25.8. Обработчик события «ПриАктивизацииСтроки()» элемента формы «Список»
&НаКлиенте
Процедура СписокПриАктивизацииСтроки(Элемент)
 
Если ПредопределенныйУзел(Элемент.ТекущаяСтрока) Тогда
Элементы.ФормаЗарегистрироватьИзменения.Доступность = Ложь;
 
Иначе
Элементы.ФормаЗарегистрироватьИзменения.Доступность = Истина;
 
КонецЕсли;
 
КонецПроцедуры
В этой процедуре доступность кнопки Зарегистрировать изменения определяется в зависимости от значения функции ПредопределенныйУзел(), в которую передается ссылка на текущий узел (Элемент.ТекущаяСтрока).
На этом создание плана обмена завершено, и вы можете перейти непосредственно к созданию процедур обмена данными.

#### Процедуры обмена данными
Для инициализации обмена данными вы будете использовать обработку.
Добавьте объект конфигурации – обработку с именем ОбменДанными.
Затем создайте основную форму обработки и добавьте в нее команду ВыполнитьОбмен.
Создайте обработчик этой команды, выполняющейся на сервере без контекста формы (тип обработчика Создать на клиенте и процедуру на сервере без контекста).
В модуле формы будут созданы шаблоны двух процедур: клиентской процедуры ВыполнитьОбмен() и серверной внеконтекстной процедуры ВыполнитьОбменНаСервере(), которая вызывается из клиентской процедуры.
Процедура ВыполнитьОбмен() автоматически будет заполнена следующим образом (листинг 25.9).
Листинг 25.9. Обработчик команды «ВыполнитьОбмен»
&НаКлиенте
Процедура ВыполнитьОбмен(Команда)
 
ВыполнитьОбменНаСервере();
 
КонецПроцедуры
В процедуру ВыполнитьОбменНаСервере() поместите следующий текст (листинг 25.10).
Листинг 25.10. Создание процедуры «ВыполнитьОбменНаСервере»
&НаСервереБезКонтекста
Процедура ВыполнитьОбменНаСервере() Экспорт
 
ВыборкаУзлов = ПланыОбмена.Филиалы.Выбрать();
 
Пока ВыборкаУзлов.Следующий() Цикл
 
// Произвести обмен данными со всеми узлами, кроме текущего (ЭтотУзел).
Если ВыборкаУзлов.Ссылка <> ПланыОбмена.Филиалы.ЭтотУзел() Тогда
УзелОбъект = ВыборкаУзлов.ПолучитьОбъект();
 
// Получить сообщение.
УзелОбъект.ПрочитатьСообщениеСИзменениями();
 
// Сформировать сообщение.
УзелОбъект.ЗаписатьСообщениеСИзменениями();
 
КонецЕсли;
 
КонецЦикла;
 
КонецПроцедуры
Алгоритм работы этой процедуры заключается в следующем: в цикле вы перебираете узлы, которые содержатся в плане обмена Филиалы, и для всех узлов, кроме себя самого, производите сначала чтение сообщений, поступивших из других узлов обмена (процедуру ПрочитатьСообщенияСИзменениями вы создадите позднее).
Затем вы формируете для них сообщения, предназначенные для передачи и содержащие измененные данные для этого узла (процедура ЗаписатьСообщениеСИзменениями также будет создана вами позднее).
В заключение перетащите команду ВыполнитьОбмен в окно элементов формы. В результате форма обработки будет выглядеть следующим образом (рис. 25.5).

Рис. 25.5. Форма обработки {https://ai2b.pro/wp-content/uploads/1/25_05.png}
#####  Процедура записи данных
Сами процедуры записи и чтения данных обмена вы разместите в модуле плана обмена Филиалы.
Откройте модуль объекта этого плана обмена. Сначала вы создадите процедуру, которая будет использоваться вами при обмене данными, – ЗаписатьСообщениеСИзменениями. Заполнять ее вы будете постепенно.
Сначала вы формируете имя файла, который будет содержать данные для обмена, и сообщаете пользователю о начале и окончании выгрузки данных в узел (листинг 25.11).
Листинг 25.11. Формирование имени файла в процедуре записи данных
Процедура ЗаписатьСообщениеСИзменениями() Экспорт
 
Сообщить("-------- Выгрузка в узел " + Строка(ЭтотОбъект) + " ------------");
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя временного файла.
ИмяФайла = Каталог + "Message" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + "_" + СокрЛП(Ссылка.Код) + ".xml";
Сообщить("-------- Конец выгрузки ------------");
 
КонецПроцедуры
Для упрощения примера вы будете обмениваться сообщениями через каталог временных файлов. Имена сообщений стандартизованы и имеют вид MessageКодУзлаОтправителя_КодУзлаПолучателя.xml.
После этого вы обращаетесь к механизмам записи/чтения XML-документов и создаете новый объект – ЗаписьXML. С помощью него вы открываете новый XML-файл для записи и записываете в него объявление XML. В конце процедуры вы завершаете запись XML и закрываете файл (листинг 25.12).
Листинг 25.12. Создание объекта записи XML в процедуре записи данных
Процедура ЗаписатьСообщениеСИзменениями() Экспорт
 
Сообщить("-------- Выгрузка в узел " + Строка(ЭтотОбъект) + " ------------");
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя временного файла.
ИмяФайла = Каталог + "Message" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + "_" + СокрЛП(Ссылка.Код) + ".xml";
 
// Создать объект записи XML
// *** ЗаписьXML-документов.
ЗаписьXML = Новый ЗаписьXML;
ЗаписьXML.ОткрытьФайл(ИмяФайла);
ЗаписьXML.ЗаписатьОбъявлениеXML();
ЗаписьXML.Закрыть();
 
Сообщить("-------- Конец выгрузки ------------");
 
КонецПроцедуры
Теперь вы обращаетесь к механизмам инфраструктуры сообщений и создаете новый объект ЗаписьСообщенияОбмена, метод которого НачатьЗапись() позволяет, кроме всего прочего, создать очередной номер сообщения и записать заголовок сообщения в XML. В конце процедуры вы опять же заканчиваете запись сообщения (листинг 25.13).
Листинг 25.13. Создание очередного номера сообщения и запись заголовка сообщения в XML
Процедура ЗаписатьСообщениеСИзменениями() Экспорт
 
Сообщить("-------- Выгрузка в узел " + Строка(ЭтотОбъект) + " ------------");
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя временного файла.
ИмяФайла = Каталог + "Message" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + "_" + СокрЛП(Ссылка.Код) + ".xml";
 
// Создать объект записи XML.
// *** ЗаписьXML-документов.
ЗаписьXML = Новый ЗаписьXML;
ЗаписьXML.ОткрытьФайл(ИмяФайла);
ЗаписьXML.ЗаписатьОбъявлениеXML();
 
// *** Инфраструктура сообщений.
ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
ЗаписьСообщения.НачатьЗапись(ЗаписьXML, Ссылка);
Сообщить(" Номер сообщения: " + ЗаписьСообщения.НомерСообщения);
ЗаписьСообщения.ЗакончитьЗапись();
 
ЗаписьXML.Закрыть();
 
Сообщить("-------- Конец выгрузки ------------");
 
КонецПроцедуры
Поскольку вы находитесь в модуле объекта, вы используете стандартный реквизит Ссылка в качестве ссылки на объект План обмена Филиалы.
После этого, чтобы получить данные, которые необходимо сохранить в этом файле, вы обращаетесь к механизму регистрации изменений и получаете выборку из записей регистрации изменений, предназначенных данному узлу. При формировании выборки вы передаете вторым параметром номер сообщения (листинг 25.14).
Листинг 25.14. Получение выборки из записей регистрации изменений, предназначенных данному узлу
Процедура ЗаписатьСообщениеСИзменениями() Экспорт
 
Сообщить("-------- Выгрузка в узел " + Строка(ЭтотОбъект) + " ------------");
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя временного файла.
ИмяФайла = Каталог + "Message" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + "_" + СокрЛП(Ссылка.Код) + ".xml";
 
// Создать объект записи XML
// *** ЗаписьXML-документов.
ЗаписьXML = Новый ЗаписьXML;
ЗаписьXML.ОткрытьФайл(ИмяФайла);
ЗаписьXML.ЗаписатьОбъявлениеXML();
 
// *** Инфраструктура сообщений.
ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
ЗаписьСообщения.НачатьЗапись(ЗаписьXML, Ссылка);
Сообщить(" Номер сообщения: " + ЗаписьСообщения.НомерСообщения);
 
// Получить выборку измененных данных
// *** Механизм регистрации изменений.
ВыборкаИзменений = ПланыОбмена.ВыбратьИзменения(ЗаписьСообщения.Получатель, ЗаписьСообщения.НомерСообщения);
 
ЗаписьСообщения.ЗакончитьЗапись();
 
ЗаписьXML.Закрыть();
 
Сообщить("-------- Конец выгрузки ------------");
 
КонецПроцедуры
Теперь осталось только перебрать выборку записей в цикле и сериализовать их в открытый XML-файл (листинг 25.15).
Листинг 25.15. Перебор выборки записей и сериализация их в открытый XML-файл
Процедура ЗаписатьСообщениеСИзменениями() Экспорт
 
Сообщить("-------- Выгрузка в узел " + Строка(ЭтотОбъект) + " ------------");
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя временного файла.
ИмяФайла = Каталог + "Message" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + "_" + СокрЛП(Ссылка.Код) + ".xml";
 
// Создать объект записи XML
// *** ЗаписьXML-документов.
ЗаписьXML = Новый ЗаписьXML;
ЗаписьXML.ОткрытьФайл(ИмяФайла);
ЗаписьXML.ЗаписатьОбъявлениеXML();
 
// *** Инфраструктура сообщений.
ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
ЗаписьСообщения.НачатьЗапись(ЗаписьXML, Ссылка);
Сообщить(" Номер сообщения: " + ЗаписьСообщения.НомерСообщения);
 
// Получить выборку измененных данных
// *** Механизм регистрации изменений.
ВыборкаИзменений = ПланыОбмена.ВыбратьИзменения(ЗаписьСообщения.Получатель,ЗаписьСообщения.НомерСообщения);
Пока ВыборкаИзменений.Следующий() Цикл
 
// Записать данные в сообщение.
// *** XML-сериализация.
ЗаписатьXML(ЗаписьXML, ВыборкаИзменений.Получить());
 
КонецЦикла;
 
ЗаписьСообщения.ЗакончитьЗапись();
 
ЗаписьXML.Закрыть();
 
Сообщить("-------- Конец выгрузки ------------");
 
КонецПроцедуры
На этом создание процедуры записи данных обмена закончено.

##### Процедура чтения данных
Порядок создания процедуры чтения данных обмена будет таким же, как и ранее: сначала вы формируете имя файла, содержащего данные обмена (листинг 25.16).
Листинг 25.16. Формирование имени файла, содержащего данные обмена
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
КонецЕсли;
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Вы формируете имя файла, которое надеетесь найти в этом каталоге, а затем, создав новый объект Файл с таким именем, проверяете, существует ли он. Если такого файла нет, вы завершаете работу процедуры. Если же такой файл найден, нужно будет удалить его, после того как все данные, содержащиеся в нем, будут обработаны.
Теперь добавьте в процедуру команды чтения найденного файла с данными обмена (листинг 25.17).
Листинг 25.17. Добавление чтения найденного файла с данными обмена
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML 
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Именно в этот момент вы обращаетесь к механизмам записи/чтения документов XML, которые работают с ними на базовом уровне.
Для этого вы создаете новый объект ЧтениеXML, с помощью которого открываете найденный файл для чтения. В случае успеха вы выводите сообщение о начале загрузки данных из файла. В конце процедуры вы также прекращаете чтение XML-данных из файла методом Закрыть().
Полученные таким образом данные должны являться некоторым сообщением обмена данными. Для того чтобы представить их в терминах сообщений, добавьте в процедуру следующий код (листинг 25.18).
Листинг 25.18. Добавление чтения заголовка XML-сообщения
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML  
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Здесь вы обращаетесь к механизмам инфраструктуры сообщений планов обмена и создаете объект ЧтениеСообщенияОбмена. Используя метод этого объекта НачатьЧтение(), вы считываете заголовок XML-сообщения, в котором содержится в том числе информация об отправителе сообщения. После того как все сообщение будет вами обработано, вы заканчиваете чтение.
Теперь, когда вы представили данные обмена в виде сообщения и получили его заголовок, можно произвести одну проверку, перед тем как начать собственно обрабатывать данные (листинг 25.19).
Листинг 25.19. Добавление проверки сообщения
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML  
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Сообщение предназначено не для этого узла.
Если ЧтениеСообщения.Отправитель <> Ссылка Тогда
ВызватьИсключение "Неверный узел";
КонецЕсли;
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Вы проверяете, является ли отправитель сообщения тем узлом, для которого вы в данном вызове этой процедуры производите обмен данными.
Если все в порядке, то, перед тем как начать чтение данных, следует удалить все записи регистрации изменений, которые были сделаны для этого узла и соответствовали номерам сообщений, меньшим или равным указанному в обрабатываемом вами сообщении как номер принятого. Это делается затем, чтобы исключить дублирование данных, которые уже были ранее посланы этому узлу и им обработаны (листинг 25.20).
Листинг 25.20. Удаление записей регистрации изменений для узла-отправителя
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML  
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Сообщение предназначено не для этого узла.
Если ЧтениеСообщения.Отправитель <> Ссылка Тогда
ВызватьИсключение "Неверный узел";
КонецЕсли;
 
// Удалить регистрацию изменений для узла отправителя сообщения.
// *** Служба регистрации изменений.
ПланыОбмена.УдалитьРегистрациюИзменений(ЧтениеСообщения.Отправитель, ЧтениеСообщения.НомерПринятого);
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Обратите внимание, что здесь вы обращаетесь к службе регистрации изменений и используете метод УдалитьРегистрациюИзменений() для выполнения описанных действий.
Теперь, наконец, вы можете приступить к чтению непосредственно самих данных, содержащихся в сообщении (листинг 25.21).
Листинг 25.21. Чтение данных из сообщения
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML  
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Сообщение предназначено не для этого узла.
Если ЧтениеСообщения.Отправитель <> Ссылка Тогда
ВызватьИсключение "Неверный узел";
КонецЕсли;
 
// Удалить регистрацию изменений для узла – отправителя сообщения.
// *** Служба регистрации изменений
ПланыОбмена.УдалитьРегистрациюИзменений(ЧтениеСообщения.Отправитель, ЧтениеСообщения.НомерПринятого);
 
// Читать данные из сообщения *** XML-сериализация.
Пока ВозможностьЧтенияXML(ЧтениеXML) Цикл
 
КонецЦикла;
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Чтение данных выполняется в цикле, причем вы снова обращаетесь к механизмам XML-сериализации, методом глобального контекста ВозможностьЧтенияXML() получаете очередной тип данных XML из объекта ЧтениеXML и определяете, имеется ли соответствующий тип «1С:Предприятия». В случае успеха выполнение цикла продолжается.
И первое, что вам нужно сделать, – представить данные XML в виде некоторого значения, имеющего тип «1С:Предприятия». Для этого вы используете метод глобального контекста ПрочитатьXML() – листинг 25.22.
Листинг 25.22. Представление данных XML в виде значения, имеющего тип
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML  
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Сообщение предназначено не для этого узла.
Если ЧтениеСообщения.Отправитель <> Ссылка Тогда
ВызватьИсключение "Неверный узел";
КонецЕсли;
 
// Удалить регистрацию изменений для узла – отправителя сообщения.
// *** Служба регистрации изменений.
ПланыОбмена.УдалитьРегистрациюИзменений(ЧтениеСообщения.Отправитель, ЧтениеСообщения.НомерПринятого);
 
// Читать данные из сообщения *** XML-сериализация.
Пока ВозможностьЧтенияXML(ЧтениеXML) Цикл
 
// Читать очередное значение.
Данные = ПрочитатьXML(ЧтениеXML);
 
КонецЦикла;
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
В результате выполнения этого метода переменная Данные будет содержать объект «1С:Предприятия», соответствующий данным XML.
Теперь, после того как объект «1С:Предприятия» получен, следует разрешить возможную коллизию (листинг 25.23).
Листинг 25.23. Разрешение возможных коллизий
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Сообщение предназначено не для этого узла.
Если ЧтениеСообщения.Отправитель <> Ссылка Тогда
ВызватьИсключение "Неверный узел";
КонецЕсли;
 
// Удалить регистрацию изменений для узла – отправителя сообщения.
// *** Служба регистрации изменений.
ПланыОбмена.УдалитьРегистрациюИзменений(ЧтениеСообщения.Отправитель, ЧтениеСообщения.НомерПринятого);
 
// Читать данные из сообщения *** XML-сериализация.
Пока ВозможностьЧтенияXML(ЧтениеXML) Цикл
 
// Читать очередное значение.
Данные = ПрочитатьXML(ЧтениеXML);
 
// Не переносить изменение, полученное в главный из неглавного, если есть регистрация изменения.
Если Не ЧтениеСообщения.Отправитель.Главный И ПланыОбмена.ИзменениеЗарегистрировано(ЧтениеСообщения.Отправитель, Данные) Тогда
Сообщить(" – Изменения отклонены");
 
Продолжить;
 
КонецЕсли;
 
КонецЦикла;
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Возможная коллизия разрешается следующим образом: вы проверяете, является ли узел-отправитель главным узлом и есть ли записи об изменении этого объекта для данного узла в вашей базе данных. Если объект изменялся в вашей базе и отправитель не является главным узлом, вы отклоняете запись полученного объекта. Во всех остальных случаях вы принимаете изменения полученного объекта.
Теперь единственное, что вам осталось сделать, – записать полученные данные (листинг 25.24).
Листинг 25.24. Запись полученных данных
Процедура ПрочитатьСообщениеСИзменениями() Экспорт
 
Каталог = КаталогВременныхФайлов();
 
// Сформировать имя файла.
ИмяФайла = Каталог + "Message" + СокрЛП(Ссылка.Код) + "_" + СокрЛП(ПланыОбмена.Филиалы.ЭтотУзел().Код) + ".xml";
 
Файл = Новый Файл(ИмяФайла);
Если Не Файл.Существует() Тогда
Возврат;
 
КонецЕсли;
 
// *** Чтение документов XML  
// Попытаться открыть файл.
ЧтениеXML = Новый ЧтениеXML;
Попытка
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
Исключение
Сообщить("Невозможно открыть файл обмена данными.");
 
Возврат;
 
КонецПопытки;
 
Сообщить("-------- Загрузка из " + Строка(ЭтотОбъект) + " ------------");
Сообщить(" – Считывается файл " + ИмяФайла);
 
// Загрузить из найденного файла
// *** Инфраструктура сообщений.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
 
// Читать заголовок сообщения обмена данными – файла XML.
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Сообщение предназначено не для этого узла.
Если ЧтениеСообщения.Отправитель <> Ссылка Тогда
ВызватьИсключение "Неверный узел";
КонецЕсли;
 
// Удалить регистрацию изменений для узла – отправителя сообщения
// *** Служба регистрации изменений.
ПланыОбмена.УдалитьРегистрациюИзменений(ЧтениеСообщения.Отправитель, ЧтениеСообщения.НомерПринятого);
 
// Читать данные из сообщения *** XML-сериализация.
Пока ВозможностьЧтенияXML(ЧтениеXML) Цикл
 
// Читать очередное значение.
Данные = ПрочитатьXML(ЧтениеXML);
 
// Не переносить изменение, полученное в главный из неглавного, если есть регистрация изменения.
Если Не ЧтениеСообщения.Отправитель.Главный И ПланыОбмена.ИзменениеЗарегистрировано(ЧтениеСообщения.Отправитель, Данные) Тогда
Сообщить(" – Изменения отклонены");
 
Продолжить;
КонецЕсли;
 
// Записать полученные данные.
Данные.ОбменДанными.Отправитель = ЧтениеСообщения.Отправитель;
Данные.ОбменДанными.Загрузка = Истина;
Данные.Записать();
 
КонецЦикла;
 
ЧтениеСообщения.ЗакончитьЧтение();
 
ЧтениеXML.Закрыть();
 
УдалитьФайлы(ИмяФайла);
 
Сообщить("-------- Конец загрузки ------------");
 
КонецПроцедуры
Перед записью полученного объекта вы устанавливаете у него в параметрах обмена данными значение узла отправителя, для того чтобы система при записи этого объекта в вашей базе данных не формировала записи регистрации изменений этого объекта для того узла, от которого вы его только что получили.
Кроме того, в параметрах обмена данными вы устанавливаете свойство Загрузка, информирующее систему о том, что запись объекта будет происходить в режиме обновления данных, полученных в результате обмена. Такое указание позволяет системе упростить процедуру записи объекта, отказавшись от ряда стандартных проверок и исключив изменения связанных данных, которые выполняются при обычной записи.
На этом создание процедуры получения и обработки данных обмена закончено.

#### Проверка работы обмена данными
##### В 1C:EDT
Чтобы иметь возможность редактировать константу ПрефиксНумерации, в ветви Общие > Общие формы панели Навигатор создайте форму констант с именем ОбщиеНастройки (рис. 25.6).

Рис. 25.6. Общая форма констант «ОбщиеНастройки» {https://ai2b.pro/wp-content/uploads/1/25_06.png}
Включите форму в подсистему Предприятие.
Созданные вами ранее план обмена Филиалы и обработку ОбменДанными также включите в подсистему Предприятие.
Затем настройте командный интерфейс подсистемы Предприятие, чтобы доступ к командам открытия плана обмена, обработки, а также формы констант имел только Администратор, и переместите команду Филиалы в самое начало группы Панель навигации.Важное. А также в группе команд Панель действий.Создать включите видимость у команды Филиал: создать только для роли Администратор. Затем установите следующий порядок следования команд в группе Панель действий.Сервис (рис. 25.7):
Общие настройки,
Обмен данными.

Рис. 25.7. Командный интерфейс подсистемы «Предприятие» {https://ai2b.pro/wp-content/uploads/1/25_07.png}
И в заключение создайте на своем компьютере новый каталог, в котором будет размещаться база вашего филиала.
На всякий случай (чтобы убедиться, что конфигурация работоспособна) обновите конфигурацию базы данных.
Затем так же, как вы это делали при создании пользователей прикладного решения, откройте информационную базу в конфигураторе.
Сохраните в созданный каталог вашу конфигурацию, нажав в главном меню Конфигурация > Сохранить конфигурацию в файл… После этого закройте конфигуратор и вернитесь в 1С:EDT.

##### В прикладном решении
Запустите проект в режиме отладки и установите необходимые значения в вашей центральной базе.
Прежде всего задайте значение константы Префикс нумерации – ЦБ. Для этого в разделе Предприятие нажмите Общие настройки в группе Сервис (рис. 25.8).

Рис. 25.8. Значение константы «Префикс нумерации» {https://ai2b.pro/wp-content/uploads/1/25_08.png}
Нажмите Записать и закрыть.
После этого нажмите Филиалы и задайте параметры узла по умолчанию, то есть параметры вашей базы.
В списке узлов обмена уже присутствует одна запись. Откройте и отредактируйте ее.
Код базы будет ЦБ, а наименование – Центральная база.
Не забудьте, что именно код идентифицирует узлы обмена в различных базах, поэтому в базе филиала вы будете создавать узлы с такими же кодами (рис. 25.9).

Рис. 25.9. Создание узла плана обмена {https://ai2b.pro/wp-content/uploads/1/25_09.png}
Нажмите Записать и закрыть.
Затем нажмите Создать над списком филиалов и создайте новый узел, который будет соответствовать базе филиала, присвойте ему код Фил и наименование Филиал (рис. 25.10).

Рис. 25.10. Создание узла плана обмена {https://ai2b.pro/wp-content/uploads/1/25_10.png}
Обратите внимание, что предопределенный узел вашей информационной базы (Центральная база) выделен в списке узлов обмена специальной пиктограммой. Кнопка Зарегистрировать изменения недоступна для этого узла (рис. 25.11).

Рис. 25.11. Список узлов плана обмена {https://ai2b.pro/wp-content/uploads/1/25_11.png}
Выделите в списке новый узел Филиал и нажмите Зарегистрировать изменения.
Теперь вызовите обработку Обмен данными из группы Сервис в разделе Предприятие и нажмите Выполнить обмен.
В окне сообщений появится следующий текст (рис. 25.12).

Рис. 25.12. Обработка «Обмен данными»{https://ai2b.pro/wp-content/uploads/1/25_12.png}
Таким образом, в результате обмена данными центральная база сформировала файл обмена, содержащий изменения всех данных, которыми она обменивается с филиалом.
##### Запуск базы филиала
Настало время перейти к базе филиала.
###### В 1C:EDT
Создайте новую информационную базу (с наименованием, например, База филиала) таким же образом, как вы создавали информационную базу вашего учебного примера в первом занятии этого пособия.
Затем из контекстного меню этой базы снова запустите конфигуратор.

###### В режиме «Конфигуратор»
В главном меню нажмите Конфигурация > Открыть конфигурацию. Вы видите, что список объектов конфигурации пуст.
Теперь загрузите сохраненную ранее конфигурацию из файла (Конфигурация > Загрузить конфигурацию из файла…).
После выбора файла с конфигурацией (*.cf) ответьте утвердительно на вопрос системы об обновлении конфигурации и в окне изменений структуры конфигурации нажмите Принять.
Теперь все объекты конфигурации перенесены из вашей центральной базы. Закройте конфигуратор.

###### В 1C:EDT
После этого импортируйте конфигурацию базы филиала в новый проект так же, как вы это делали в начале разработки вашего учебного примера.
Когда процесс импорта завершится, в панели Навигатор будет открыт еще один проект, содержащий импортированную конфигурацию (рис. 25.13).

Рис. 25.13. Новый проект, содержащий конфигурацию базы филиала {https://ai2b.pro/wp-content/uploads/1/25_13.png}
Теперь в рабочей области у вас находятся два проекта с идентичными конфигурациями: проект База_филиала, содержащий конфигурацию базы филиала, и проект Услуги с конфигурацией центральной базы. Имена ваших проектов, конечно же, могут отличаться от приведенных на рисунке.
При универсальном способе обмена конфигурации узлов обмена могут отличаться, и с этого момента они будут редактироваться и запускаться независимо друг от друга.
При выделении в панели Навигатор одного из проектов (или подчиненных ему объектов) этот проект становится активным – именно содержащуюся в нем конфигурацию вы будете редактировать и запускать на исполнение. Для удобства тот проект, с которым вы не работаете в данный момент, можно свернуть.
В частности, прежде чем выполнять обмен, вам нужно изменить в конфигурации базы филиала одну деталь.
Дело в том, что в обмене данными у вас участвует справочник Склады, содержащий предопределенный элемент с именем Основной.
При создании справочников и других объектов конфигурации, которые могут содержать предопределенные элементы, свойство Обновление предопределенных данных для этих объектов стандартно устанавливается в значение Авто. Это приводит к тому, что при реструктуризации базы данных или при первом обращении к таблице, хранящей данные объекта конфигурации, создаются или обновляются элементы данных, связанные по имени с предопределенными элементами данных в конфигурации.
В вашем случае при открытии списка складов в базе филиала будет автоматически создан элемент справочника Склады, связанный с предопределенным элементом справочника с именем Основной. При этом свойство этого элемента справочника ИмяПредопределенныхДанных будет установлено в значение Основной. Изменить эту связь можно только с помощью встроенного языка.
Но затем при загрузке данных из центральной базы в справочник Склады будет добавлен еще один элемент данных, связанный с предопределенным элементом справочника с именем Основной. В дальнейшем это приведет к ошибке, так как в системе не может быть двух объектов, связанных с одинаковым предопределенным элементом.
Чтобы избежать такой ситуации, выделите в панели Навигатор проект с конфигурацией базы филиала, откройте редактор справочника Склады и в группе свойств Прочее установите свойство Обновление предопределенных данных в значение Не обновлять автоматически (рис. 25.14).

Рис. 25.14. Редактирование свойств справочника «Склады» {https://ai2b.pro/wp-content/uploads/1/25_14.png}

###### В режиме «Конфигуратор»
Опять откройте базу филиала в конфигураторе и создайте одного пользователя – Администратор – с ролью Администратор. Дело в том, что пользователей в каждой информационной базе нужно создавать заново. Закройте конфигуратор.

###### В 1C:EDT
Убедитесь, что в панели Навигатор выделен проект, содержащий конфигурацию базы филиала, и запустите проект в режиме отладки.
Поскольку вы первый раз запускаете этот проект, у него еще нет конфигурации запуска. Поэтому сначала укажите клиентское приложение, которое будет отлаживаться – Тонкий клиент 1С:Предприятия. После этого при первом соединении с базой филиала вам нужно задать параметры соединения с этой информационной базой. Выберите тип доступа – Infobase, в поле Имя пользователя введите Администратор (рис. 25.15).

Рис. 25.15. Запуск базы филиала {https://ai2b.pro/wp-content/uploads/1/25_15.png}

###### В прикладном решении
Первым делом задайте значение константы ПрефиксНумерации – ФЛ (Предприятие – Сервис – Общие настройки) (рис. 25.16).

Рис. 25.16. Редактирование константы {https://ai2b.pro/wp-content/uploads/1/25_16.png}
Затем откройте план обмена Филиалы и опишите предопределенный узел (узел текущей информационной базы). В списке узлов обмена уже присутствует одна запись. Откройте и отредактируйте ее. Задайте код Фил и наименование Филиал (рис. 25.17).

Рис. 25.17. Создание узла плана обмена {https://ai2b.pro/wp-content/uploads/1/25_17.png}
После этого создайте новый узел плана обмена с кодом ЦБ, наименованием Центральная база и признаком Главный (рис. 25.18).

Рис. 25.18. Создание узла плана обмена {https://ai2b.pro/wp-content/uploads/1/25_18.png}
Выделите в списке узлов обмена новый узел Центральная база и нажмите Зарегистрировать изменения.
Теперь для большей наглядности откройте список справочника Клиенты. Сейчас в нем нет ни одного элемента. И в справочнике Склады также нет элементов, так как вы установили свойство справочника Обновление предопределенных данных в значение Не обновлять автоматически.
Запустите обработку Обмен данными и нажмите Выполнить обмен. Справочники (и другие объекты конфигурации, участвующие в обмене данными) будет заполнены элементами, а в окне сообщений появится текст (рис. 25.19).

Рис. 25.19. Обработка «Обмен данными» {https://ai2b.pro/wp-content/uploads/1/25_19.png}
ПРИМЕЧАНИЕ
Чтобы увидеть клиентов, перенесенных из центральной базы, нужно обновить список клиентов (Еще – Обновить – F5).
Теперь проверьте, как будет происходить обмен в другую сторону.
Создайте в справочнике Клиенты нового клиента с произвольным наименованием. Обратите внимание, что нумерация кода нового клиента начинается с единицы и имеет префикс ФЛ.
После этого снова нажмите Выполнить обмен в открытой форме обработки Обмен данными.
Затем запустите проект, содержащий конфигурацию центральной базы, в режиме отладки. Также выполните обмен данными и убедитесь, что клиент, созданный в базе филиала, перенесен в центральную базу.

### Механизм распределенных информационных баз
Механизм распределенных информационных баз является развитием универсального механизма обмена данными.
ВНИМАНИЕ!
Если вы используете учебную версию платформы «1С:Предприятие 8.3», то воспроизвести этот пример не удастся, так как учебная версия не поддерживает работу с распределенными информационными базами.
Распределенная информационная база подразумевает наличие идентичных конфигураций во всех узлах, имеет древовидную структуру и позволяет выполнять обмен как измененными данными, так и изменениями, внесенными в конфигурацию.
Механизм распределенных информационных баз реализуется планами обмена. Для этого объект конфигурации План обмена содержит свойство Распределенная информационная база.
Если это свойство установлено, для данного плана обмена включается механизм распределенных информационных баз и разработчик получает возможность создать распределенную базу исключительно интерактивными средствами, без написания кода.
Такая возможность не исключает программного управления обменом, которое также доступно при работе с распределенными информационными базами.
В ходе создания примера вы реализуете оба варианта организации обмена в распределенных информационных базах.
#### Основные сведения
Как уже говорилось выше, распределенная информационная база должна иметь четко определенную древовидную структуру. Количество уровней в такой структуре не ограничено, главное – между двумя связанными узлами всегда должно быть определено отношение «главный – подчиненный» (рис. 25.20).

Рис. 25.20. Структура распределенной информационной базы {https://ai2b.pro/wp-content/uploads/1/25_20.png}
Таким образом, любой узел этой структуры может иметь произвольное количество подчиненных узлов (в том числе и ни одного). Кроме того, все узлы, кроме одного, должны иметь по одному главному узлу, и один узел не будет иметь главного узла – это корневой узел. Такое жесткое задание структуры узлов необходимо для определения порядка миграции изменений данных и изменений конфигурации.
Конфигурация может быть изменена только в узле, не имеющем главного узла (то есть в корневом). Изменения данных могут выполняться в любом узле.
Изменения конфигурации будут передаваться от главного к подчиненным узлам. Изменения данных могут передаваться между любыми связанными узлами.
Разрешение коллизий также будет производиться исходя из отношения «главный – подчиненный». Если изменения выполнены одновременно и в главном, и в подчиненном узле, при обмене данными будут приняты только изменения главного узла, а изменения подчиненного будут отвергнуты.
Для любого подчиненного узла возможно создание начального образа – информационной базы, созданной на основании конфигурации и данных главного узла в соответствии с правилами, определяемыми планом обмена. Процедура создания начального образа узла может выполняться неоднократно, при этом удаляются все записи изменений в базе главного узла для подчиненного узла. Сразу после создания начальный образ готов к обмену с главным узлом.
Создать подчиненный узел в распределенной информационной базе можно разными способами, но создание начального образа является рекомендуемым.

#### Постановка задачи
В качестве примера для изучения работы механизма распределенных информационных баз вы создадите несколько отделений ООО «На все руки мастер».
В отличие от филиалов, которые расположены в других городах, являются отдельными юридическими лицами и довольно самостоятельны в плане организации учета своей деятельности, отделения вашего предприятия расположены в этом же городе, никакой юридической самостоятельностью не обладают и ведут учет в точности так, как это организовано в главном офисе.
Поэтому все они используют ту же конфигурацию, что и главный офис, причем если главный офис вносит какие-либо изменения в свою конфигурацию, то они должны быть своевременно внесены и в конфигурации отделений.
Для реализации такой схемы работы распределенная информационная база подойдет как нельзя лучше, и сначала вы организуете обмен с отделениями, используя исключительно интерактивные средства.

#### Интерактивный обмен
##### В 1C:EDT
Для построения распределенной информационной базы вам понадобится добавить еще один объект конфигурации – план обмена с именем Отделения и представлением объекта – Отделение.
Будьте внимательны! Перед тем как создавать новый план обмена, не забудьте активизировать в панели Навигатор проект с конфигурацией центральной базы, а проект базы филиала можно свернуть, так как вам он больше не понадобится.
Для этого плана обмена вы должны установить свойство Распределенная ИБ (рис. 25.21).

Рис. 25.21. Установка свойства «Распределенная ИБ» {https://ai2b.pro/wp-content/uploads/1/25_21.png}
В группе свойств Поле ввода установите флажок Быстрый выбор, чтобы иметь возможность выбора узлов плана обмена из выпадающего списка.
Затем определите состав объектов, участвующих в обмене. Включите в обмен все объекты, не относящиеся к ведению бухгалтерии и расчету зарплаты.
В результате состав данных обмена должен выглядеть следующим образом (рис. 25.22).

Рис. 25.22. Состав данных обмена {https://ai2b.pro/wp-content/uploads/1/25_22.png}
Включите план обмена в подсистему Предприятие.
Затем настройте командный интерфейс подсистемы Предприятие. Перенесите команду для открытия плана обмена Отделения в группу Панель навигации.Важное (после команды Филиалы) и установите видимость этой команды только для роли Администратор. А также в группе команд Панель действий.Создать включите видимость у команды Отделение: создать только для роли Администратор.

##### В прикладном решении
Запустите проект, содержащий конфигурацию центральной базы, в режиме отладки.
Нажмите Отделения в разделе Предприятие, откройте план обмена Отделения и задайте параметры центрального узла (предопределенный элемент плана обмена).
В списке узлов обмена уже присутствует одна запись. Это предопределенный узел вашей информационной базы. Откройте и отредактируйте его.
Внесите код ЦБ и наименование Центральная база. После этого создайте новый узел с кодом Отд и наименованием Отделение.
Для созданного вами узла доступны три кнопки в командной панели формы плана обмена: Записать изменения, Прочитать изменения и Создать начальный образ (рис. 25.23).

Рис. 25.23. Команды работы с распределенной информационной базой {https://ai2b.pro/wp-content/uploads/1/25_23.png}
Не откладывая, воспользуйтесь одной из них, чтобы создать начальный образ информационной базы вашего отделения. Для этого вам потребуется сначала создать на диске новый каталог, в котором будет располагаться база отделения.
После этого выделите в списке узлов обмена узел Отделение и нажмите Создать начальный образ. В появившемся окне укажите, что информационная база будет расположена на данном компьютере, и нажмите кнопку Создать начальный образ. На следующем шаге нажмите Сохранить и выберите каталог информационной базы (рис. 25.24).

Рис. 25.24. Создание начального образа информационной базы {https://ai2b.pro/wp-content/uploads/1/25_24.png}
Вы вернетесь в диалог создания начального образа информационной базы. Нажмите Закрыть.
Система создаст в указанном каталоге начальный образ информационной базы вашего отделения.

##### Запуск базы отделения
Теперь перейдите к базе отделения. Здесь нужно иметь в виду следующее.
Особенность обмена данными с подчиненными узлами распределенных информационных баз состоит в том, что конфигурация в этих узлах защищена от изменений и не может изменяться самостоятельно, а может быть получена только от главного узла. Чтобы избежать проблем с блокировкой данных и т. п., работа с информационными базами, являющимися подчиненными узлами, будет вестись в режимах Конфигуратор и 1С:Предприятие, запущенных из операционной системы (из меню Пуск или из стартового окна «1С:Предприятия»).
###### В 1C:EDT
Добавьте в список информационных баз созданную вами базу, расположенную в каталоге, в который вы поместили начальный образ информационной базы вашего отделения.
При тестировании универсального обмена вы также создавали новую информационную базу, но теперь, в отличие от создания базы филиала, вам нужно выбрать другой режим – Добавление существующей информационной базы и затем указать тот каталог информационной базы, куда вы сохранили начальный образ базы отделения.
Запустите конфигуратор для этой базы.

###### В режиме «Конфигуратор»
Добавьте в конфигурацию отделения одного пользователя – Администратор с ролью Администратор (Администрирование – Пользователи – Добавить):
На вкладке Основные задайте имя – Администратор.
На вкладке Прочие выберите роль Администратор.
Нажмите ОК.
Закройте конфигуратор.

###### В режиме «1С:Предприятие»
Запустите базу отделения из операционной системы в режиме 1С:Предприятие и откройте план обмена Отделения (рис. 25.25).

Рис. 25.25. Узлы плана обмена «Отделения» {https://ai2b.pro/wp-content/uploads/1/25_25.png}
Обратите внимание: в базе подчиненного узла сам подчиненный узел (Отделение) является предопределенным узлом плана обмена, а узел центральной базы отмечен желтой пиктограммой, указывающей на то, что он является главным для информационной базы отделения.
Теперь проверьте работу обмена данными.
Откройте список констант и задайте значение константы ПрефиксНумерации – ОТ.
подсказка
Если занятие № 25 Обмен данными выполняется после занятия № 26 Функциональные опции, в панели разделов может быть не видно каких-то разделов, использующихся в данном узле (например, Бухгалтерия). В этом случае откройте форму Общие настройки и проверьте значения функциональных опций, которые отвечают за видимость разделов (например, Бухгалтерский учет). Имейте в виду, что функциональные опции не копируются между узлами, а настраиваются в каждом узле отдельно.
После этого откройте справочник клиентов и добавьте в него нового клиента.
Затем выделите в плане обмена Отделения узел Центральная база (тот узел, в который нужно передать изменения) и нажмите Записать изменения. В появившемся окне нажмите Записать и сохранить в файл, затем нажмите Сохранить и укажите каталог, куда нужно сохранить файл сообщения (рис. 25.26).

Рис. 25.26. Диалог записи сообщения с изменениями {https://ai2b.pro/wp-content/uploads/1/25_26.png}
Вы вернетесь в диалог записи сообщения с изменениями. Нажмите Закрыть. Закройте прикладное решение для базы отделения.
Перейдите в центральную базу. Откройте план обмена Отделения, выделите узел Отделение (тот узел, от которого нужно принять изменения) и нажмите Прочитать изменения. В появившемся окне нажмите Выбрать файл и прочитать изменения и выберите с диска тот файл сообщения, который вы только что записали. Вы вернетесь в диалог чтения сообщения с изменениями. Нажмите Закрыть.
Убедитесь, что новый клиент, созданный в базе отделения, присутствует и в центральной базе. Закройте прикладное решение для центральной базы.

##### Чтение изменений конфигурации из главного узла
Теперь посмотрите, как будут переноситься изменения конфигурации между главным и подчиненным узлами.
В 1С:EDT в конфигурации центральной базы создайте новую константу с именем НоваяКонстанта. А также добавьте новый предопределенный элемент в справочник Склады с именем Офис. Запустите проект в режиме отладки.
Откройте план обмена Отделения и выполните запись изменений для подчиненного узла Отделение.
После этого запустите базу отделения из операционной системы в режиме 1С:Предприятие и выполните чтение изменений от узла Центральная база.
Система выдаст следующее сообщение (рис. 25.27).

Рис. 25.27. Системное сообщение {https://ai2b.pro/wp-content/uploads/1/25_27.png}
Если вы нажмете на ссылку Сформировать отчет об ошибке, а затем на ссылку подробный текст ошибки, то увидите, что из главного узла распределенной информационной базы получены изменения конфигурации и что необходимо выполнить обновление информационной базы.
Для этого вам нужно закрыть прикладное решение и открыть базу отделения режиме Конфигуратор.
Открыв конфигурацию, вы увидите, что в основной конфигурации появилась новая константа НоваяКонстанта, а также новый предопределенный элемент в справочнике Склады с именем Офис (рис. 25.28).

Рис. 25.28. Измененная конфигурация базы отделения {https://ai2b.pro/wp-content/uploads/1/25_28.png}
То есть изменения, внесенные в конфигурацию центральной базы, были перенесены в конфигурацию подчиненного узла. Теперь единственное, что остается сделать, – это выполнить обновление конфигурации базы данных в подчиненном узле. Нажмите F7, чтобы обновить конфигурацию базы данных.
Следует сказать несколько слов о порядке принятия изменений, когда в одном сообщении получены как изменения конфигурации, так и изменения данных.
В этом случае сначала будет изменена основная конфигурация и выдано сообщение о необходимости выполнения обновления конфигурации базы данных.
Но самих данных – например, новой записи в справочнике Склады, связанной с предопределенным элементом Офис, вы пока не увидите.
Что касается предопределенных данных, то здесь не будет такой проблемы с дублированием данных, связанных с одним предопределенным элементом, как при выполнении универсального обмена данными. Дело в том, что автоматическое создание предопределенных данных в дочерних узлах распределенной информационной базы не производится.
Затем следует выполнить повторное получение данных, при котором будут приняты уже изменения данных, содержащиеся в сообщении. Такой порядок принятия изменений не зависит от того, относятся измененные данные к существующим объектам конфигурации или к новым.
В заключение удалите объект НоваяКонстанта из конфигурации центральной базы. Также удалите предопределенный элемент Офис из справочника Склады. Предопределенный элемент надо удалить не только из конфигурации, но и из базы данных (для этого нужно временно дать администратору права на удаление предопределенных элементов справочника).

#### Программный обмен
Все описанные выше действия по обмену данными в распределенной информационной базе можно выполнить программно.
Чтобы реализовать это, вы создадите обработку, которая будет программно выполнять для выбранного узла все те действия, которые были рассмотрены в предыдущем разделе.
##### В 1C:EDT
В конфигурации центральной базы добавьте объект конфигурации – обработку с именем ОбменСОтделениями.
Создайте основную форму обработки. Добавьте в форму реквизит Отделение с типом ПланОбменаСсылка.Отделения и перетащите его в окно элементов формы.
Затем поочередно создайте команды формы: СоздатьНачальныйОбраз, ЗаписатьИзменения и ПрочитатьИзменения. Создайте клиентские обработчики этих команд в модуле формы, затем перейдите на закладку Форма и поочередно перетащите эти команды в окно элементов формы.
В результате форма обработки примет следующий вид (рис. 25.29).

Рис. 25.29. Форма обработки {https://ai2b.pro/wp-content/uploads/1/25_29.png}
В свойствах кнопки СоздатьНачальныйОбраз снимите флажок Доступность.
Таким образом, при открытии обработки кнопка будет недоступной, пока не выбран узел плана обмена в поле Отделение. Эта кнопка также будет недоступной в случае выбора предопределенного узла вашей информационной базы, то есть создание начального образа невозможно, если выбранный узел является предопределенным.
Чтобы обеспечить такое поведение кнопки, создайте в модуле формы обработки функцию, выполняющуюся на сервере и возвращающую значение Истина, если переданный в функцию узел является предопределенным (листинг 25.25).
Листинг 25.25. Функция «ПредопределенныйУзел()»
&НаСервереБезКонтекста
Функция ПредопределенныйУзел(Узел)
 
Возврат Узел = ПланыОбмена.Отделения.ЭтотУзел();
 
КонецФункции
Затем создайте клиентский обработчик события ОбработкаВыбора для элемента формы Отделение и заполните его следующим образом (листинг 25.26).
Листинг 25.26. Процедура «ПолеВводаОтделениеОбработкаВыбора()»
&НаКлиенте
Процедура ОтделениеОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
 
Если ПредопределенныйУзел(ВыбранноеЗначение)Тогда
Элементы.СоздатьНачальныйОбраз.Доступность = Ложь;
 
Иначе
Элементы.СоздатьНачальныйОбраз.Доступность = Истина;
 
КонецЕсли;
 
КонецПроцедуры
В этой процедуре доступность кнопки СоздатьНачальныйОбраз определяется в зависимости от значения функции ПредопределенныйУзел(), в которую передается ссылка на выбранный узел (ВыбранноеЗначение).
Теперь заполните обработчик команды СоздатьНачальныйОбраз следующим образом (листинг 25.27). Обратите внимание на то, что перед ключевым словом Процедура нужно добавить модификатор Асинх:
Листинг 25.27. Обработчик нажатия кнопки «Создать начальный образ»
&НаКлиенте
Асинх Процедура СоздатьНачальныйОбраз(Команда)
 
Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
Диалог.Заголовок = "Укажите каталог информационной базы:";
 
Если Ждать Диалог.ВыбратьАсинх() <> Неопределено Тогда
СоздатьНачальныйОбразНаСервере(Отделение, Диалог.Каталог);
 
Сообщить("Создание начального образа узла завершено.");
 
КонецЕсли;
 
КонецПроцедуры
После этого добавьте в модуль процедуру СоздатьНачальныйОбразНаСервере() (листинг 25.28).
Листинг 25.28. Процедура «СоздатьНачальныйОбразНаСервере»
&НаСервереБезКонтекста
Процедура СоздатьНачальныйОбразНаСервере(Узел, КаталогСоединения)
 
ПланыОбмена.СоздатьНачальныйОбраз(Узел, "File =""" + КаталогСоединения + """");
 
КонецПроцедуры
В начале процедуры СоздатьНачальныйОбраз() вы асинхронно (подробнее об этом рассказывается в разделе «Особенности разработки в режиме без использования модальности») вызываете диалог выбора каталога, в который будет помещен образ информационной базы, и затем вызываете процедуру СоздатьНачальныйОбразНаСервере(), исполняющуюся на сервере без контекста, в которой вызывается метод СоздатьНачальныйОбраз() объекта ПланыОбменаМенеджер.
Именно этот метод и позволяет вам создать образ для подчиненного узла распределенной информационной базы. В первом параметре метода передается ссылка на узел (реквизит формы Отделение), для которого вы хотите создать начальный образ, а во втором – строка соединения, указывающая информационную базу.
Теперь заполните обработчик команды ЗаписатьИзменения.
Текст обработчика будет выглядеть следующим образом (листинг 25.29). Здесь также обратите внимание на то, что перед ключевым словом Процедура нужно добавить модификатор Асинх.
Листинг 25.29. Обработчик нажатия кнопки «Записать изменения»
&НаКлиенте
Асинх Процедура ЗаписатьИзменения(Команда)
 
Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
Диалог.Заголовок = "Укажите файл обмена:";
Если Ждать Диалог.ВыбратьАсинх() <> Неопределено Тогда
ЗаписатьИзмененияНаСервере(Отделение, Диалог.ПолноеИмяФайла);
 
Сообщить("Запись изменений завершена.");
 
КонецЕсли;
 
КонецПроцедуры
После этого добавьте в модуль процедуру ЗаписатьИзмененияНаСервере () (листинг 25. 30).
Листинг 25.30. Процедура «ЗаписатьИзмененияНаСервере»
&НаСервереБезКонтекста
Процедура ЗаписатьИзмененияНаСервере(Узел, ИмяФайла)
 
// Создать и проинициализировать объект ЗаписьXML.
ЗаписьXML = Новый ЗаписьXML;
ЗаписьXML.ОткрытьФайл(ИмяФайла);
 
// Создать объект ЗаписьСообщенияОбмена и начать запись сообщения.
ЗаписьСообщения = ПланыОбмена.СоздатьЗаписьСообщения();
ЗаписьСообщения.НачатьЗапись(ЗаписьXML, Узел);
 
// Записать содержимое тела сообщения обмена данными распределенной ИБ.
ПланыОбмена.ЗаписатьИзменения(ЗаписьСообщения);
 
// Закончить запись сообщения и запись XML.
ЗаписьСообщения.ЗакончитьЗапись();
ЗаписьXML.Закрыть();
 
КонецПроцедуры
В начале процедуры ЗаписатьИзменения() вы асинхронно вызываете диалог ввода имени файла, в который будут записаны изменения, и затем вызываете процедуру ЗаписатьИзмененияНаСервере(), исполняющуюся на сервере без контекста. В первом параметре метода передается ссылка на узел (реквизит формы Отделение), для которого будет производиться запись изменений.
В этой процедуре вы создаете объект ЗаписьXML для работы с этим файлом.
Затем вы создаете объект ЗаписьСообщенияОбмена, с помощью которого будете формировать сообщение обмена. В методе НачатьЗапись(), во втором параметре, вы указываете, для какого узла обмена будет создаваться это сообщение.
После этого вы выполняете метод ЗаписатьИзменения() объекта ПланыОбменаМенеджер, который и записывает изменения, предназначенные для передачи в выбранный узел, в указанное сообщение обмена.
В заключение вы, как обычно, заканчиваете запись сообщения обмена и закрываете файл.
Узнай больше!
Следует отметить, что метод «ЗаписатьИзменения()» позволяет задать максимальное число элементов данных, которые помещаются в сообщение в рамках одной транзакции базы данных. По умолчанию все данные помещаются в сообщение в рамках одной транзакции.
Такой режим является рекомендуемым, так как гарантирует согласованность данных, помещаемых в сообщение.
Но при создании сообщения в многопользовательском режиме могут быть конфликты блокировок между транзакцией, в которой данные помещаются в сообщение, и транзакциями, выполняемыми другими пользователями. Для снижения вероятности возникновения таких конфликтов можно задать значение этого параметра, отличное от значения по умолчанию. Чем меньше значение параметра, тем меньше вероятность конфликта блокировок, но выше вероятность помещения в сообщение несогласованных данных.
Учитывая все вышесказанное, идеальным вариантом является выполнение обмена данными в монопольном режиме. Однако такой вариант не всегда приемлем в силу специфики организации работы конкретных информационных баз.
И последним вы заполните обработчик команды ПрочитатьИзменения.
Текст обработчика будет выглядеть следующим образом (листинг 25.31). Здесь также обратите внимание на то, что перед ключевым словом Процедура нужно добавить модификатор Асинх.
Листинг 25.31. Обработчик нажатия кнопки «Прочитать изменения»
&НаКлиенте
Асинх Процедура ПрочитатьИзменения(Команда)
 
Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
Диалог.Заголовок = "Укажите файл обмена:";
Если Ждать Диалог.ВыбратьАсинх() <> Неопределено Тогда
ПрочитатьИзмененияНаСервере(Диалог.ПолноеИмяФайла);
 
Сообщить("Чтение изменений завершено.");
 
КонецЕсли;
 
КонецПроцедуры
После этого добавьте в модуль процедуру ПрочитатьИзмененияНаСервере () (листинг 25. 32).
Листинг 25.32. Процедура «ПрочитатьИзмененияНаСервере»
&НаСервереБезКонтекста
Процедура ПрочитатьИзмененияНаСервере(ИмяФайла)
 
// Создать и проинициализировать объект ЧтениеXML.
ЧтениеXML = Новый ЧтениеXML;
ЧтениеXML.ОткрытьФайл(ИмяФайла);
 
// Создать объект ЧтениеСообщенияОбмена и начать чтение сообщения.
ЧтениеСообщения = ПланыОбмена.СоздатьЧтениеСообщения();
ЧтениеСообщения.НачатьЧтение(ЧтениеXML);
 
// Прочитать содержимое тела сообщения.
ПланыОбмена.ПрочитатьИзменения(ЧтениеСообщения);
 
// Закончить чтение сообщения и чтение XML.
ЧтениеСообщения.ЗакончитьЧтение();
ЧтениеXML.Закрыть();
 
КонецПроцедуры
В начале процедуры вы снова асинхронно вызываете диалог выбора имени файла, который будет прочитан, и затем вызываете процедуру ПрочитатьИзмененияНаСервере(), исполняющуюся на сервере без контекста.
В этой процедуре вы создаете объект ЧтениеXML для работы с этим файлом. Затем создаете объект ЧтениеСообщенияОбмена для чтения сообщения, содержащегося в указанном файле.
Затем методом ПрочитатьИзменения() объекта ПланыОбменаМенеджер вы читаете полученное сообщение.
В конце процедуры вы завершаете чтение сообщения обмена и закрываете файл.
Теперь настройте интерфейс прикладного решения.
Сначала включите обработку ОбменСОтделениями в подсистему Предприятие.
Затем в редакторе командного интерфейса подсистемы Предприятие разрешите доступ к команде открытия обработки только администратору.
В конце настройте командный интерфейс основного раздела для администратора. Добавьте команды для открытия форм Общие настройки, Обмен данными и Обмен с отделениями в список команд основного раздела и задайте видимость этих форм только для роли Администратор (рис. 25.30).

Рис. 25.30. Настройка командного интерфейса основного раздела для администратора {https://ai2b.pro/wp-content/uploads/1/25_30.png}
Теперь расположите формы списков планов обмена Филиалы и Отделения на начальной странице администратора.
Для этого сначала создайте форму списка плана обмена Отделения. После этого добавьте формы списка планов обмена Филиалы и Отделения в левую часть начальной страницы и задайте видимость этих форм только для роли Администратор (рис. 25.31).

Рис. 25.31. Настройка начальной страницы для администратора {https://ai2b.pro/wp-content/uploads/1/25_31.png}

##### В прикладном решении
Теперь выполните пример программного обмена данными.
подсказка
При выполнении примера обмена данными нужно правильно задавать узел, в который записываются и от которого принимаются изменения. Например, после изменения данных в центральной базе в списке узлов плана обмена нужно выбрать подчиненный узел, которому будут передаваться данные (например, Отделение), и нажать кнопку Записать изменения. А в базе узла, в который будут загружаться данные, в списке узлов плана обмена нужно выбрать узел, из которого данные были выгружены (например, Центральная база), и нажать кнопку Прочитать изменения.
Запустите проект, содержащий конфигурацию центральной базы для пользователя с ролью Администратор. Откроется начальная страница приложения (рис. 25. 32).

Рис. 25.32. Начальная страница «1С:Предприятия» для администратора {https://ai2b.pro/wp-content/uploads/1/25_32.png}
В группе Сервис раздела Главное откройте форму обработки Обмен с отделениями. Выберите в поле Отделение узел обмена Отделение, для которого вы хотите создать начальный образ вашей информационной базы (рис. 25.33).

Рис. 25.33. Пример программного обмена с отделениями {https://ai2b.pro/wp-content/uploads/1/25_33.png}
Затем нажмите Создать начальный образ. Создайте каталог, куда будет выгружен начальный образ информационной базы, и укажите его в диалоге выбора каталога.
Теперь создайте в центральной базе нового сотрудника.
Затем в форме Обмен с отделениями выберите в поле Отделение узел обмена Отделение, в который вы хотите передать изменения. Нажмите Записать изменения и укажите имя файла сообщения с изменениями.

##### Запуск базы отделения
###### В 1C:EDT
Добавьте в список информационных баз созданную вами базу, расположенную в каталоге, в который вы поместили начальный образ информационной базы вашего отделения.
Запустите конфигуратор для этой базы.
###### В режиме «Конфигуратор»
Добавьте в конфигурацию отделения одного пользователя – Администратор с ролью Администратор. Закройте конфигуратор.

###### В режиме «1С:Предприятие»
Запустите базу отделения из операционной системы в режиме 1С:Предприятие. Откройте список констант (Предприятие – Сервис – Общие настройки) и задайте значение константы ПрефиксНумерации – ОД.
Запустите обработку Обмен с отделениями (Главное – Сервис – Обмен с отделениями). В поле Отделение выберите узел обмена Центральная база, от которого вы хотите принять изменения. Нажмите Прочитать изменения и выберите тот файл, в который вы выгрузили изменения из центральной базы.
Убедитесь, что сотрудник центральной базы (с префиксом кода ЦБ) появился в базе отделения.

#### Управление отправкой и приемом данных
Следует лишь сделать несколько заключительных замечаний.
При использовании механизма распределенных информационных баз становятся доступными четыре события объекта встроенного языка ПланОбменаОбъект.<имя>, которые позволяют управлять отправкой и приемом данных на уровне отдельных элементов данных:
ПриОтправкеДанныхГлавному(),
ПриОтправкеДанныхПодчиненному(),
ПриПолученииДанныхОтГлавного(),
ПриПолученииДанныхОтПодчиненного().
Эти события будут вызываться для каждого элемента данных, включаемого в сообщение.
Работу этих событий можно увидеть, добавив в модуль объекта План обмена Отделения следующий текст (листинг 25.33).
Листинг 25.33. Просмотр работы событий объекта «ПланОбменаОбъект»
Процедура ПриОтправкеДанныхГлавному(ЭлементДанных, ОтправкаЭлемента)
 
Сообщить("ПриОтправкеДанныхГлавному " + ЭлементДанных);
 
КонецПроцедуры
 
Процедура ПриОтправкеДанныхПодчиненному(ЭлементДанных, ОтправкаЭлемента)
 
Сообщить("ПриОтправкеДанныхПодчиненному " + ЭлементДанных);
 
КонецПроцедуры
 
Процедура ПриПолученииДанныхОтГлавного(ЭлементДанных, ПолучениеЭлемента, ОтправкаНазад)
 
Сообщить("ПриПолученииДанныхОтГлавного " + ЭлементДанных);
 
КонецПроцедуры
 
Процедура ПриПолученииДанныхОтПодчиненного(ЭлементДанных, ПолучениеЭлемента, ОтправкаНазад)
 
Сообщить("ПриПолученииДанныхОтПодчиненного " + ЭлементДанных);
 
КонецПроцедуры
В первом параметре всех перечисленных событий находится тот элемент данных, для которого вызвано это событие.
Параметр ОтправкаЭлемента позволяет управлять тем, какая информация будет помещена в сообщение. Он может принимать три значения:
Авто – значение по умолчанию. Указывает на то, что элемент данных будет помещен в сообщение;
Удалить – в сообщение будет помещено значение, предназначенное для удаления этого элемента данных;
Игнорировать – в сообщение не будет помещено ничего, связанного с этим элементом данных.
Параметр ПолучениеЭлемента позволяет указать, будет прочитанный элемент данных записан в базу данных или нет. Параметр также может принимать три значения:
Авто – значение по умолчанию. Если элемент данных получен от главного узла, он будет записан всегда. Если элемент данных получен от подчиненного узла, он будет записан, только если не зарегистрированы изменения для этого элемента данных;
Принять – полученный элемент данных будет записан всегда;
Игнорировать – проигнорировать получение элемента данных и ничего не записывать.
Также в событиях получения данных существует третий параметр – ОтправкаНазад, имеющий тип Булево.
Этот параметр позволяет выполнять принудительную регистрацию изменений для полученного элемента данных в базе-получателе.
Такая необходимость может возникнуть, например, когда при приеме данных от узла-отправителя обнаружено, что полученные данные противоречивы (например, в узле-отправителе была допущена ошибка при изменении данных).
Тогда вы можете проигнорировать присланные изменения и, установив флажок ОтправкаНазад, вызвать принудительную регистрацию изменений полученного элемента данных в вашей базе для узла-отправителя.
В результате последующего обмена состояние этого элемента данных в узле-отправителе будет установлено таким же, как и в вашей базе.

#### Изменение структуры узлов
В заключение следует сказать о том, что механизм распределенных информационных баз содержит программное средство реконфигурирования структуры узлов распределенной базы.
Для этого следует использовать метод УстановитьГлавныйУзел() объекта ПланыОбменаМенеджер.
В параметре этого метода передается ссылка на узел плана обмена распределенной информационной базы, который устанавливается главным для текущей базы. Также в этом параметре может быть передано значение Неопределено, и это приведет к тому, что у текущей информационной базы будет отсутствовать главный узел.
Допустим, необходимо переместить один из подчиненных узлов в корень дерева (рис. 25.34).

Рис. 25.34. Реконфигурирование структуры узлов {https://ai2b.pro/wp-content/uploads/1/25_34.png}
Для этого нужно выполнить следующие действия (листинг 25.34).
Листинг 25.34. Перемещение «Узла2» в корень дерева
// В информационной базе Узла2.
ПланыОбменаМенеджер.УстановитьГлавныйУзел(Неопределено);
 
// В информационной базе Узла1.
ПланыОбменаМенеджер.УстановитьГлавныйУзел(Узел2);
При этом будут удалены все записи регистрации изменений конфигурации «Узла1», относящиеся к «Узлу2», так как передача изменений конфигурации будет возможна теперь только от «Узла2» к «Узлу1». Записи регистрации изменения данных удалены не будут, так как передача изменений данных будет по-прежнему возможна между этими узлами.
Таким же образом, используя значение параметра метода Неопределено, вы можете отключать от дерева отдельную информационную базу или целое поддерево (рис. 25.35, листинг 25.35).

Рис. 25.35. Отключение поддерева от распределенной информационной базы {https://ai2b.pro/wp-content/uploads/1/25_35.png}
Листинг 25.35. Перемещение «Узла2» в корень дерева
// В информационной базе Узла1.
ПланыОбменаМенеджер.УстановитьГлавныйУзел(Неопределено);
Кроме того, вы можете создавать распределенную информационную базу из отдельных информационных баз с идентичной конфигурацией (рис. 25.36, листинг 25.36).

Рис. 25.36. Информационная база из отдельных информационных баз с идентичной конфигурацией {https://ai2b.pro/wp-content/uploads/1/25_36.png}
Листинг 25.36. Создание распределенной информационной базы из баз с идентичной конфигурацией
// В информационных базах Узла2, Узла3 и Узла4.
ПланыОбменаМенеджер.УстановитьГлавныйУзел(Узел1);

## Занятие 26 (0:30). Функциональные опции
Продолжительность
Ориентировочная продолжительность занятия – 30 минут.
Вот вы и создали небольшое прикладное решение, которое позволило автоматизировать работу вашей ремонтной фирмы ООО «На все руки мастер». Теперь настало время для одного чудесного превращения.
Дело в том, что ваше прикладное решение настолько понравилось сотрудникам ООО «На все руки мастер», что они рассказали о нем своим соседям – косметическому салону «Королева красоты». Сотрудники салона посмотрели, как работает ваше прикладное решение, и обратились к вам с просьбой автоматизировать и их салон тоже.
Конечно же, вы с радостью согласитесь – по одной простой причине: вы создали универсальную конфигурацию, подходящую для автоматизации практически любой деятельности, связанной с оказанием услуг.
Все, что вам осталось теперь сделать, чтобы ваша конфигурация смогла работать в косметическом салоне, это просто создать новую информационную базу с вашей конфигурацией и заполнить ее новыми данными: сотрудниками, новой номенклатурой и т. п. Все механизмы учета, которые вы создавали, не были привязаны к какой-либо специфике конкретного предприятия, а потому могут с успехом использоваться на любом другом предприятии, имеющем аналогичную область деятельности.
Таким образом, даже если в косметическом салоне пожелают иметь дополнительную функциональность, вам потребуется всего лишь дописать несколько модулей к вашей конфигурации, что гораздо эффективнее, чем создавать заново индивидуальное решение только для данного предприятия.
В то же время в косметическом салоне может не потребоваться какая-то функциональность, которая уже есть в вашей конфигурации.
Что делать? Удалять ненужные объекты конфигурации, программный код?
Это может оказаться очень трудоемкой операцией. В реальных конфигурациях может присутствовать большое количество объектов. Связи между ними могут быть очень сложными.
Поэтому в «1С:Предприятии» существует механизм функциональных опций, который позволяет включать/выключать при внедрении целые блоки функциональности, не изменяя при этом саму конфигурацию.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Опции «Бухгалтерский учет» и «Расчет зарплаты»
Предположим, что косметический салон по каким-то причинам не ведет бухгалтерский учет и расчет заработной платы. Для отключения соответствующей функциональности вы создадите функциональные опции БухгалтерскийУчет и РасчетЗарплаты, установите их для соответствующих объектов конфигурации и отключите их в прикладном решении.
Таким образом, при совершенно одинаковой конфигурации в прикладном решении косметического салона не будет видно никаких действий, связанных с расчетом зарплаты и ведением бухучета, как будто их и нет вовсе.
#### В 1C:EDT
Поскольку значения функциональных опций обязательно должны где-то храниться, создайте сначала константы БухгалтерскийУчет и РасчетЗарплаты с типом Булево, в которых будут храниться значения функциональных опций (рис. 26.1).

Рис. 26.1. Создание константы {https://ai2b.pro/wp-content/uploads/1/26_01.png}
Если значение константы Истина, значит, функциональная опция включена. Если значение Ложь – функциональная опция выключена.
Затем в ветке Общие – Функциональные опции создайте функциональные опции с именами БухгалтерскийУчет и РасчетЗарплаты, указав им в свойстве Хранение соответствующие константы (рис. 26.2).

Рис. 26.2. Создание функциональной опции {https://ai2b.pro/wp-content/uploads/1/26_02.png}
Теперь вам нужно привязать объекты конфигурации к функциональным опциям.
К ведению бухгалтерского учета в вашей конфигурации относятся следующие объекты:
справочник Субконто,
документ ВводНачальныхОстатковНоменклатуры,
отчет ОборотноСальдоваяВедомость,
план видов характеристик ВидыСубконто,
план счетов Основной,
регистр бухгалтерии Управленческий.
На закладке Состав редактора функциональной опции БухгалтерскийУчет отметьте, что эти объекты входят в ее состав (рис. 26.3).

Рис. 26.3. Состав объектов функциональной опции «Бухгалтерский учет» {https://ai2b.pro/wp-content/uploads/1/26_03.png}
К расчету заработной платы в вашей конфигурации относятся следующие объекты:
справочник ВидыГрафиковРаботы,
документ НачисленияСотрудникам,
отчет НачисленияСотрудникам,
отчет Перерасчет,
отчет ДиаграммаНачислений,
план видов расчета ОсновныеНачисления,
регистр сведений ГрафикиРаботы,
регистр расчета Начисления.
Отметьте, что эти объекты входят в состав функциональной опции РасчетЗарплаты.
Теперь, если вы откроете редактор справочника Субконто или любого другого объекта конфигурации, входящего в состав функциональной опции БухгалтерскийУчет, на закладке Функциональные опции, то увидите, что эта опция уже добавлена в список функциональных опций, от которых зависит объект (рис. 26.4).

Рис. 26.4. Значение функциональных опций для объектов бухгалтерского учета {https://ai2b.pro/wp-content/uploads/1/26_04.png}
Таким образом, отображение объектов конфигурации в интерфейсе приложения зависит от того, включена связанная с ними функциональная опция (значение соответствующей константы – Истина) или нет.
У объектов, относящихся к расчету зарплаты, на закладке Функциональные опции вы увидите функциональную опцию РасчетЗарплаты.
Для остальных объектов конфигурации на закладке Функциональные опции ничего не отмечено. Это значит, что данный объект не зависит от значения функциональной опции и отображается всегда.
ПРИМЕЧАНИЕ
Если включить в состав функциональной опции какую-либо подсистему, то вы вообще не увидите соответствующего раздела в «1С:Предприятии», пока данная функциональная опция отключена.
Теперь вам нужно отобразить новые созданные вами константы в форме констант, чтобы затем в пользовательском режиме открывать форму констант и изменять значение функциональных опций.
Эту форму с именем ОбщиеНастройки вы создали на предыдущем занятии, и она уже содержит константу ПрефиксНумерации.
Откройте эту форму (Общие – Общие формы – ОбщиеНастройки) и перетащите константы БухгалтерскийУчет и РасчетЗарплаты из окна реквизитов в окно элементов формы (рис. 26.5).

Рис. 26.5. Редактирование общей формы констант {https://ai2b.pro/wp-content/uploads/1/26_05.png}

#### В прикладном решении
Запустите проект в режиме отладки и проверьте работу функциональных опций. В разделе Главное нажмите Общие настройки в группе команд Сервис.
В открывшейся форме констант вы видите, что обе константы имеют значение Ложь (рис. 26.6).

Рис. 26.6. Форма констант {https://ai2b.pro/wp-content/uploads/1/26_06.png}
Это значит, что соответствующие функциональные опции отключены.
И действительно, в разделах Бухгалтерия и Расчет зарплаты вы не увидите команд для ведения бухучета и расчета заработной платы (рис. 26.7).

Рис. 26.7. Интерфейс раздела «Расчет зарплаты» {https://ai2b.pro/wp-content/uploads/1/26_07.png}
Теперь если через некоторое время руководство косметического салона пожелает вести расчет зарплаты, то администратор включит соответствующую опцию Расчет зарплаты – и все! (рис. 26.8).

Рис. 26.8. Изменение значения функциональной опции для расчета зарплаты {https://ai2b.pro/wp-content/uploads/1/26_08.png}
Нужно только сохранить измененные значения констант и перезапустить «1С:Предприятие», чтобы платформа «отрисовала» новый интерфейс.
В результате раздел Расчет зарплаты будет выглядеть следующим образом (рис. 26.9).

Рис. 26.9. Интерфейс раздела «Расчет зарплаты» {https://ai2b.pro/wp-content/uploads/1/26_09.png}
А если вы включите и вторую функциональную опцию Бухгалтерский учет, то восстановите интерфейс прикладного решения, разработанный вами для фирмы ООО «На все руки мастер».
Вот так быстро и легко происходит настройка прикладного решения под требования заказчика.

### Опция «Учет клиентов»
Нужно отметить, что функциональные опции могут влиять не только на командный интерфейс приложения, но и на внешний вид форм, используемых в прикладном решении. Кроме того, включение/выключение функциональности можно выполнять и без перезапуска клиентского приложения. А если к этому прибавить возможности работы с функциональными опциями во встроенном языке, то становится ясно, что механизм функциональных опций может сделать процесс внедрения и настройки прикладного решения у заказчика простым и понятным даже для неопытного пользователя.
Рассмотрите еще один пример.
«Поименный» учет клиентов при оказании услуг востребован далеко не всегда. Зачастую важен лишь сам факт оказания услуги, при этом «личность» клиента не имеет значения.
Поэтому вам нужно предусмотреть в вашей конфигурации возможность отключить ведение списка клиентов и избавиться от необходимости указывать клиента каждый раз при оказании услуги.
Также вы доработаете существующие функциональные опции, включив в них и подсистемы Бухгалтерия и РасчетЗарплаты, чтобы ваше решение выглядело «законченным». Раз бухгалтерия не нужна, значит, ее нет нигде.

#### В 1C:EDT
Откройте состав функциональной опции БухгалтерскийУчет и добавьте в него подсистему Бухгалтерия.
Аналогичным образом добавьте в состав функциональной опции РасчетЗарплаты подсистему РасчетЗарплаты.
Теперь займитесь созданием новой функциональной опции.
Для хранения этой опции создайте константу с именем УчетКлиентов. Она будет иметь тип Булево.
Создайте функциональную опцию УчетКлиентов и укажите, что ее значение будет храниться в константе УчетКлиентов (рис. 26.10).

Рис. 26.10. Функциональная опция «УчетКлиентов» {https://ai2b.pro/wp-content/uploads/1/26_10.png}
Теперь укажите, какие объекты будут входить в эту функциональную опцию.
Прежде всего – справочник Клиенты. Затем – реквизит Клиент документа ОказаниеУслуги. И в заключение – измерение Клиент регистра накопления Продажи (рис. 26.11).

Рис. 26.11. Состав функциональной опции «УчетКлиентов» {https://ai2b.pro/wp-content/uploads/1/26_11.png}
Теперь доработайте общую форму ОбщиеНастройки, с помощью которой вы устанавливаете значения функциональных опций.
Прежде всего перенесите в состав элементов формы вашу новую константу УчетКлиентов (рис. 26.12).

Рис. 26.12. Форма «ОбщиеНастройки» {https://ai2b.pro/wp-content/uploads/1/26_12.png}
После этого обеспечьте автоматическую перерисовку интерфейса прикладного решения после установки новых значений функциональных опций.
Для этого создайте клиентский обработчик события формы ПослеЗаписи и напишите в нем единственную строку (листинг 26.1).
Листинг 26.1. Обработчик события «ПослеЗаписи» формы
&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
 
ОбновитьИнтерфейс();
 
КонецПроцедуры
ОбновитьИнтерфейс() – это метод глобального контекста, который обновляет командный интерфейс, начальную страницу и открытые формы с учетом текущих значений функциональных опций и их параметров.
Для того чтобы проверка работы функциональных опций стала для вас максимально удобной и легкой, сделайте так, чтобы открытие этой общей формы не блокировало основное окно программы.
Сейчас при открытии формы ОбщиеНастройки в прикладном решении форма, открытая в основном окне программы, блокируется. Так происходит, потому что по умолчанию конструктор формы установил для этой формы свойство РежимОткрытияОкна в значение Блокировать окно владельца.
Поэтому в панели Свойства установите свойство Режим открытия окна для формы в целом в значение Независимый (рис. 26.13).

Рис. 26.13. Свойство «РежимОткрытияОкна» {https://ai2b.pro/wp-content/uploads/1/26_13.png}

#### В прикладном решении
Запустите проект в режиме отладки и вызовите форму Общие настройки. Вы видите, что функциональная опция Учет клиентов отключена (рис. 26.14).

Рис. 26.14. Функциональная опция «УчетКлиентов» отключена {https://ai2b.pro/wp-content/uploads/1/26_14.png}
Проверьте, как это скажется на документе Оказание услуги. Откройте любой документ Оказание услуги, например № 2 (рис. 26.15).

Рис. 26.15. Документ «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/26_15.png}
Вы видите, что в документе нет поля Клиент, а если в панели навигации формы перейти к движениям регистра Продажи, то вы не увидите колонки Клиент. Также в разделе Предприятие нет команды Клиенты.
Теперь вернитесь в форму Общие настройки, установите флажок Учет клиентов и нажмите Записать.
Интерфейс прикладного решения изменится. Для примера откроем снова документ Оказание услуги № 2 (рис. 26.16).

Рис. 26.16. Документ «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/26_16.png}
В документе появилось поле Клиент, в списке движений регистра Продажи появилась колонка Клиент, а в разделе Предприятие – команда Клиенты.
Аналогичным образом вы можете самостоятельно переключить различные функциональные опции и посмотреть, как при этом меняется интерфейс прикладного решения.
В заключение в форме Общие настройки включите все функциональные опции и нажмите Записать (рис. 26.17).

Рис. 26.17. Общие настройки прикладного решения {https://ai2b.pro/wp-content/uploads/1/26_17.png}
Таким образом, вы включили всю функциональность разработанного вами прикладного решения. Заметьте, что интерфейс приложения перерисовался сразу же после записи общих настроек.
На этом вы фактически завершили разработку вашей конфигурации.
Следующие три занятия будут посвящены отдельным приемам разработки, которые часто используются в «1С:Предприятии».
Некоторые примеры вы будете выполнять в нескольких различных вариантах, какой из этих вариантов использовать в имеющейся конфигурации – это уже дело вашего личного вкуса.

## Занятие 27 (2:00). Организация подборов, особенности разработки в режиме без использования модальности и ввод данных на основании
Продолжительность
Ориентировочная продолжительность занятия – 2 часа.
На этом занятии речь пойдет о таких общих приемах разработки, как организация подборов, особенности разработки в режиме без использования модальности и ввод данных на основании.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Организация подборов
Задача организации подбора заключается, как правило, в заполнении табличной части документа информацией, которую выбирает пользователь в списке какого-либо объекта.
Для иллюстрации механизма подбора информации в форме вы будете использовать задачу подбора элементов справочника в табличную часть документа – как наиболее распространенную.
Поскольку механизм подбора реализован на уровне форм, то в других случаях просто будут задействованы иные прикладные объекты. Сама механика подбора не изменится.
Для организации подбора в форму документа следует открыть форму справочника как подчиненную форме документа в целом либо одному из элементов формы. Способ получения формы справочника может быть любым, так же как и сама форма справочника, которая будет использована. Важно лишь то, что эта форма должна быть открыта как подчиненная.
Результат подбора будет доступен в обработчике события ОбработкаВыбора формы документа или элемента формы (в зависимости от того, чему вы подчините форму справочника при открытии).
Событие ОбработкаВыбора в форме документа будет вызвано в двух случаях:
когда в форме справочника будет выполнен интерактивный выбор;
когда в форме справочника будет вызван метод ОповеститьОВыборе().
Различные способы подбора вы рассмотрите на примере подбора элементов справочника Номенклатура в документ ПриходнаяНакладная.
####  Одиночный подбор
При одиночном подборе форма справочника будет закрываться сразу после выбора элемента. Для выбора следующего элемента необходимо будет снова инициировать подбор.
##### В 1C:EDT
Откройте форму документа ПриходнаяНакладная.
Создайте команду формы Подбор и затем создайте клиентский обработчик этой команды.
После этого перетащите команду в окно элементов формы, в командную панель таблицы Материалы (рис. 27.1).

Рис. 27.1. Создание кнопки «Подбор»  {https://ai2b.pro/wp-content/uploads/1/27_01.png}
В модуле формы в обработчик команды Подбор добавьте следующий текст (листинг 27.1).
Листинг 27.1. Обработчик команды «Подбор»
&НаКлиенте
Процедура Подбор(Команда)
 
ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", , Элементы.Материалы);
 
КонецПроцедуры
В этом обработчике вы открываете форму выбора для справочника Номенклатура, указывая, что она подчинена таблице Материалы формы документа ПриходнаяНакладная (Элементы.Материалы).
При выборе из формы выбора справочника выбранное значение будет передано в обработчик события ОбработкаВыбора() таблицы формы Материалы, так как она является владельцем открытой формы выбора.
Поэтому создайте клиентский обработчик события ОбработкаВыбора() для таблицы формы Материалы (листинг 27.2).
Листинг 27.2. Обработчик события «ОбработкаВыбора» таблицы «Материалы»
&НаКлиенте
Процедура МатериалыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
 
Элементы.Материалы.ДобавитьСтроку();
Элементы.Материалы.ТекущиеДанные.Материал = ВыбранноеЗначение;
 
КонецПроцедуры
В этом обработчике вы добавляете новую строку в таблицу Материалы и присваиваете колонке Материал в новой строке выбранное в форме выбора справочника значение. Это значение передается в обработчик события в параметре ВыбранноеЗначение.

##### В прикладном решении
Запустите проект в режиме отладки.
В разделе Учет материалов откройте список приходных накладных и создайте новую приходную накладную.
В командной панели списка материалов нажмите Подбор и двойным щелчком мыши подберите в накладную один материал.

#### Множественный подбор
##### В 1C:EDT
При множественном подборе форма справочника будет открыта до тех пор, пока пользователь не закроет ее интерактивно или не будет вызван метод формы Закрыть().
В форме документа ПриходнаяНакладная, в обработчике команды Подбор замените прежний текст новым (листинг 27.3).
Листинг 27.3. Обработчик команды «Подбор»
&НаКлиенте
Процедура Подбор(Команда)
 
ПараметрыФормы = Новый Структура("ЗакрыватьПриВыборе", Ложь);
ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", ПараметрыФормы, Элементы.Материалы);
 
КонецПроцедуры
При открытии формы вы используете ее параметры.
Параметры формы нужны для того, чтобы открыть форму в некотором нужном вам состоянии. Параметры формы представляют собой структуру. Каждый элемент этой структуры описывает один параметр формы. Ключ элемента – это имя параметра формы.
Такую структуру вы передаете в метод ОткрытьФорму() вторым параметром (переменная ПараметрыФормы).
Предварительно вы эту структуру формируете. В ней у вас всего один элемент с ключом ЗакрыватьПриВыборе.
Таким образом, передавая эту структуру в метод ОткрытьФорму(), вы устанавливаете параметр открываемой формы ЗакрыватьПриВыборе в значение Ложь.
Это значит, что созданная форма выбора после двойного щелчка мыши на номенклатуре закрываться не будет.

##### В прикладном решении
Запустите проект в режиме отладки.
В списке приходных накладных откройте только что созданную приходную накладную.
В командной панели списка материалов нажмите Подбор. Двойным щелчком мыши подберите в накладную один материал, затем другой материал.
Когда все желаемые материалы будут выбраны, закройте окно с формой выбора.

#### Подбор с использованием множественного выбора
##### В 1C:EDT
Еще одним способом организации подбора является возможность выделения в списке сразу нескольких строк.
Режим множественного выделения в списке устанавливается, как правило, во всех формах списков по умолчанию.
Однако возможность выбрать сразу несколько элементов из списка по умолчанию, как правило, отключена.
Поэтому, чтобы в форме списка справочника Номенклатура можно было не только отметить, но и выбрать сразу несколько элементов, вы снова воспользуетесь одним из параметров расширения формы динамического списка – МножественныйВыбор.
В форме документа ПриходнаяНакладная измените текст обработчика команды Подбор следующим образом (листинг 27.4).
Листинг 27.4. Обработчик команды «Подбор»
&НаКлиенте
Процедура Подбор(Команда)
 
ПараметрыФормы = Новый Структура("МножественныйВыбор", Истина);
ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", ПараметрыФормы, Элементы.Материалы);
 
КонецПроцедуры
При множественном выборе форма выбора будет возвращать уже не один элемент, а массив элементов.
Поэтому в обработчик события ОбработкаВыбора() добавьте обход массива переданных элементов (листинг 27.5).
Листинг 27.5. Обработчик события «ОбработкаВыбора» таблицы «Материалы»
&НаКлиенте
Процедура МатериалыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
 
Для Каждого ВыбранныйЭлемент Из ВыбранноеЗначение Цикл
НоваяСтрока = Объект.Материалы.Добавить();
НоваяСтрока.Материал = ВыбранныйЭлемент;
 
КонецЦикла;
 
КонецПроцедуры

##### В прикладном решении
Запустите проект в режиме отладки.
В списке приходных накладных откройте только что созданную приходную накладную.
В командной панели списка материалов нажмите Подбор. Для удобства в открывшейся форме выбора справочника Номенклатура установите режим просмотра в виде списка: Еще – Режим просмотра – Список.
Удерживая клавишу Ctrl, выделите в списке несколько материалов и нажмите Выбрать.
Отмеченные элементы появятся в табличной части документа.

#### Множественный подбор с использованием множественного выбора
##### В 1C:EDT
Последний способ подбора, который вы рассмотрите, будет сочетать в себе оба рассмотренных ранее способа. Вы будете отмечать сразу несколько элементов справочника и подбирать их в документ без закрытия формы выбора. Затем снова отмечать несколько элементов справочника и подбирать их в документ.
Для этого вам будет необходимо при открытии формы выбора установить оба параметра: ЗакрыватьПриВыборе и МножественныйВыбор.
Обработчик команды Подбор будет выглядеть следующим образом (листинг 27.6).
Листинг 27.6. Обработчик команды «Подбор»
&НаКлиенте
Процедура Подбор(Команда)
 
ПараметрыФормы = Новый Структура("ЗакрыватьПриВыборе, МножественныйВыбор", Ложь, Истина);
ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", ПараметрыФормы, Элементы.Материалы);
 
КонецПроцедуры

##### В прикладном решении
Запустите проект в режиме отладки.
В разделе Учет материалов откройте список приходных накладных и создайте новую приходную накладную.
В командной панели списка материалов нажмите Подбор.
Откройте группу Материалы – Прочее, выделите в ней все материалы и нажмите Выбрать.
Затем откройте группу Материалы – Радиодетали, выделите в ней все материалы и нажмите Выбрать.
Закройте окно с формой выбора справочника Номенклатура.

#### Использование метода «ОповеститьОВыборе()»
Метод формы ОповеститьОВыборе() используется в тех случаях, когда алгоритм формирования данных подбора сложен и кроме собственно выбора элемента справочника от пользователя требуется указание некоторой дополнительной информации. В этом случае метод ОповеститьОВыборе() вызывается тогда, когда вся необходимая информация подбора сформирована.
Метод ОповеститьОВыборе() посылает оповещение владельцу формы о выполнении выбора или подбора, передает ему выбранное значение и закрывает форму, если она открыта не в режиме множественного выбора.
Также метод ОповеститьОВыборе() может использоваться в тех случаях, когда требуется передать в форму документа не только выбранный элемент справочника (или массив элементов), но и некоторую произвольную структуру данных.

### Особенности разработки в режиме без использования модальности
На этом же примере с подбором номенклатуры в табличную часть приходной накладной вы познакомитесь с теми особенностями разработки, которые вам нужно знать о режиме работы интерфейса без использования модальных окон.
Этот режим является стандартным для новых, создаваемых с нуля конфигураций и определяется свойством конфигурации РежимИспользованияМодальности.
#### Теория
Прежде чем приступить к практической части, нужно сказать несколько слов о том, почему стандартно используется именно такой режим работы интерфейса.
Исторически сложилось так, что обычные «десктопные» приложения часто используют в своей работе модальные окна. И «1С:Предприятие» не является исключением. Модальные окна очень удобны в тех ситуациях, когда от пользователя требуется ввод информации, без которой невозможно дальнейшее выполнение алгоритма. При этом полностью блокируется весь остальной интерфейс программы, а исполнение программного кода останавливается до тех пор, пока пользователь не закроет модальное окно.
Однако с тех пор, как «1С:Предприятие» перестало быть «обычным десктопным приложением», с появлением веб-клиента и с переходом «1С:Предприятия» на мобильные платформы использование модальных окон стало вызывать много проблем.
Основные неудобства заключались в том, что для нормальной работы веб-клиента на обычных компьютерах требовалась предварительная настройка браузера. А на мобильных устройствах браузеры вообще не поддерживают работу с модальными окнами.
Поэтому в «1С:Предприятии» был стандартно реализован специальный режим работы интерфейса без использования модальных окон. В чем заключается его основная особенность?
В этом режиме работы интерфейса окно, которое раньше было бы модальным, рисуется в пределах родительского окна и точно так же блокирует весь остальной интерфейс. Таким образом обеспечивается «модальность» для пользователя. Он не сможет выполнить никакие другие действия, пока не закроет такое окно.
Однако для разработчика в момент отображения блокирующего окна исполнение программного кода не останавливается. Программный код продолжает выполняться дальше.
Основу описанной выше асинхронной схемы работы составляет объект встроенного языка Обещание, который возвращается асинхронной функцией в качестве результата своей работы. Обещание является оберткой для результата выполнения асинхронной функции (возможно, пока неизвестного).
Асинхронная функция/процедура должна быть описана с помощью модификатора Асинх.
Для того чтобы получить результат работы асинхронной функции, предназначен оператор Ждать, единственным аргументом которого является Обещание. Этот оператор может использоваться только внутри Асинх-процедур/функций.
С логической точки зрения оператор Ждать ожидает завершения асинхронной функции, стоящей за объектом Обещание. Однако это ожидание вовсе не означает блокировку потока выполнения до момента завершения вернувшей Обещание асинхронной функции.
В операторе Ждать выполнение Асинх-процедуры/функции может приостанавливаться и возобновляться. Приостановка означает выход из процедуры/функции с возможностью последующего продолжения с той же точки, где выполнение было приостановлено. Возобновление происходит в том же операторе Ждать, после того как асинхронная функция завершится (выполнит свое обещание).
Суть этих изменений проще всего увидеть на следующем примере. Этот пример немного надуман и вряд ли представляет большую практическую ценность. Но он нужен, чтобы легче понять второй, уже достаточно практический пример.

#### Как задать вопрос пользователю в команде формы
Предположим, прежде чем выполнять подбор номенклатуры в табличную часть приходной накладной, вам нужно задать вопрос пользователю о необходимости подбора.
##### В 1C:EDT
Прежде всего посмотрите, как установлено свойство вашей конфигурации Режим использования модальности (рис. 27.2).

Рис. 27.2. Свойство конфигурации «Режим использования модальности» {https://ai2b.pro/wp-content/uploads/1/27_02.png}
Вы видите, что это свойство стандартно установлено в значение Не использовать. Этот режим является рекомендуемым.
Это значит, что при попытке открытия модального окна в прикладном решении будет получена ошибка.
Поэтому, для того чтобы задать вопрос пользователю в обработчике команды Подбор, вам нужно использовать не модальный метод Вопрос(), а его немодальный аналог ВопросАсинх().
Для разработки конфигураций в режиме отказа от модальности в платформу добавлены методы, аналогичные модальным методам, но в отличие от них не блокирующие программный код. Эти методы уже не используют модальные окна, поэтому могут беспрепятственно использоваться при разработке веб-приложений. Они имеют следующие особенности:
имена этих методов заканчиваются постфиксом Асинх, например: ВопросАсинх() вместо Вопрос(), НайтиФайлыАсинх() вместо НайтиФайлы()и т. п.;
возвращаемые ими значения типа Обещание используются как аргументы оператора Ждать.
В самом простом варианте все сводится к вызову асинхронного метода платформы ВопросАсинх() вместе с оператором Ждать и к написанию самого обработчика команды как асинхронной процедуры (с модификатором Асинх).
Добавьте в модуль формы документа ПриходнаяНакладная следующую процедуру (листинг 27.7).
Листинг 27.7. Обработчик команды «Подбор» с предварительным вопросом пользователю
&НаКлиенте
Асинх Процедура ПодборВопрос(Команда)
 
Результат = Ждать ВопросАсинх("Подобрать номенклатуру в документ?", РежимДиалогаВопрос.ДаНет);
 
Если Результат = КодВозвратаДиалога.Да Тогда
ПараметрыФормы = Новый Структура("МножественныйВыбор", Истина);
ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", ПараметрыФормы, Элементы.Материалы);
 
КонецЕсли; 
 
КонецПроцедуры
Процедура обработчика команды ПодборВопрос() описывается как асинхронная – с модификатором Асинх.
В этой процедуре вызывается асинхронная функция платформы ВопросАсинх(). Так как это асинхронная функция, она возвращает обещание своего результата, которое является аргументом оператора Ждать. Исполнение оператора Ждать приводит к тому, что выполнение процедуры ПодборВопрос() прерывается и управление возвращается платформе.
В результате отображается окно с вопросом пользователю. При этом система не ожидает завершения ответа пользователя, а занимается «своими делами».
После того как пользователь сделает выбор в блокирующем окне, оператор Ждать получает из обещания фактическое возвращаемое значение работы функции, которое содержит результат ответа пользователя.
Это значение сохраняется в переменной Результат. Если ответ положительный (КодВозвратаДиалога.Да), то производится открытие формы выбора номенклатуры для подбора в документ.
Чтобы не путаться, установите новый обработчик для команды Подбор. В свойстве Действие выберите процедуру ПодборВопрос (рис. 27.3).

Рис. 27.3. Установка действия для команды «Подбор» {https://ai2b.pro/wp-content/uploads/1/27_03.png}

##### В прикладном решении
Запустите проект в режиме отладки.
В разделе Учет материалов откройте список приходных накладных и создайте новую приходную накладную. В командной панели списка материалов нажмите Подбор.
Перед выполнением подбора всплывет блокирующее окно с вопросом пользователю о необходимости подбора. Это окно блокирует интерфейс, но не останавливает выполнение прикладного решения. Подбор номенклатуры в документ будет выполнен только в случае положительного ответа пользователя.

#### Как задать вопрос пользователю в обработчике события
Рассмотрите теперь более сложный пример, когда вопрос пользователю требуется задать в обработчике события. Например, перед добавлением номенклатуры в табличную часть приходной накладной нужно спросить, добавлять ли выбранные элементы номенклатуры в документ. Причем подтверждение о добавлении номенклатуры в документ у пользователя нужно спрашивать только один раз.
Конечно, этот пример (как и предыдущий) вряд ли понадобится при разработке реальной конфигурации, но в целом оба примера хорошо демонстрируют общий подход отказа от использования модальных окон, описанный выше в теоретической части этого раздела.
##### В 1C:EDT
Реализуйте вариант одиночного подбора с использованием множественного выбора.
В форме документа ПриходнаяНакладная установите у команды Подбор в качестве обработчика процедуру Подбор.
Измените текст обработчика команды Подбор следующим образом (листинг 27.8).
Листинг 27.8. Обработчик команды «Подбор»
&НаКлиенте
Процедура Подбор(Команда)
 
ПараметрыФормы = Новый Структура("МножественныйВыбор", Истина);
ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", ПараметрыФормы, Элементы.Материалы);
 
КонецПроцедуры
Затем добавьте в обработчик события ОбработкаВыбора() таблицы Материалы открытие блокирующего окна с вопросом пользователю. Обработчик будет выглядеть следующим образом (листинг 27.9).
Листинг 27.9. Обработчик события «ОбработкаВыбора» таблицы «Материалы» с предварительным вопросом пользователю
&НаКлиенте
Асинх Процедура МатериалыОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
 
Если ОтветПередДобавлением <> Истина Тогда
СтандартнаяОбработка = Ложь;
Результат = Ждать ВопросАсинх("Добавить номенклатуру в табличную часть?", РежимДиалогаВопрос.ДаНет);
 
Если Результат = КодВозвратаДиалога.Да Тогда
ОтветПередДобавлением = Истина;
 
Для Каждого ВыбранныйЭлемент Из ВыбранноеЗначение Цикл
НоваяСтрока = Объект.Материалы.Добавить();
НоваяСтрока.Материал = ВыбранныйЭлемент;
 
КонецЦикла;
 
КонецЕсли; 
 
Иначе
Для Каждого ВыбранныйЭлемент Из ВыбранноеЗначение Цикл
НоваяСтрока = Объект.Материалы.Добавить();
НоваяСтрока.Материал = ВыбранныйЭлемент;
 
КонецЦикла;
 
КонецЕсли; 
 
КонецПроцедуры
Процедура МатериалыОбработкаВыбора() описывается как асинхронная – с модификатором Асинх.
Для определения того, был ли получен ответ от пользователя, вы используете переменную ОтветПередДобавлением.
Если нет, то вы отменяете стандартную обработку для события ОбработкаВыбора и показываете блокирующее окно с вопросом пользователю. Если ответ от пользователя уже был получен, то выбранные элементы номенклатуры добавляются в табличную часть без вопросов.
Если значение переменной ОтветПередДобавлением не истинно (номенклатура еще не добавлялась), то окно с вопросом пользователю отображается с помощью асинхронной функции платформы ВопросАсинх() совместно с оператором Ждать. Это приводит к тому, что выполнение процедуры МатериалыОбработкаВыбора() прерывается и управление возвращается платформе. При этом система не ожидает завершения ответа пользователя.
После того как пользователь сделает выбор в блокирующем окне, оператор Ждать получает из обещания результат ответа пользователя.
Это значение сохраняется в переменной Результат. В случае положительного ответа пользователя значение переменной ОтветПередДобавлением становится истинным, и затем выполняется добавление выбранных элементов номенклатуры в табличную часть документа.
Причем если пользователь уже подтвердил, что он хочет добавить номенклатуру в документ, то больше это вопрос не задается, так как значение переменной ОтветПередДобавлением становится истинным.
Остается только объявить эту переменную в самом начале модуля формы (листинг 27.10).
Листинг 27.10. Объявление переменной в модуле формы
&НаКлиенте
Перем ОтветПередДобавлением;

##### В прикладном решении
Запустите проект в режиме отладки.
В разделе Учет материалов откройте список приходных накладных и создайте новую приходную накладную. В командной панели списка материалов нажмите Подбор.
Результат выполнения примера будет таким же, как и в предыдущем случае, за исключением того, что вопрос пользователю будет задан после выбора номенклатуры, а не до этого. А также подтверждение о добавлении номенклатуры в документ требуется только один раз.

### Ввод на основании
Механизм ввода на основании может быть использован для ввода новых объектов различного типа (документы, справочники, планы видов характеристик и т. д.). Вы рассмотрите этот механизм на примере ввода новых документов.
Для каждого объекта конфигурации Документ можно разрешить его ввод на основании других объектов базы данных и возможность являться основанием для других объектов.
Действия по заполнению реквизитов при вводе на основании должны быть описаны в модуле объекта Документ, в обработчике события ОбработкаЗаполнения.
Это можно сделать вручную или с использованием конструктора ввода на основании, который позволяет визуальными средствами конструировать текст обработчика.
Например, документ ОказаниеУслуги будет вводиться на основании элемента справочника Клиенты.
#### Команда ввода на основании
##### В 1C:EDT
У документа ОказаниеУслуги создайте новый реквизит ОбъектОснование с типом СправочникСсылка.Клиенты.
Создание такого реквизита не является обязательной частью механизма ввода на основании и понадобится вам только для того, чтобы впоследствии построить цепочку зависимых документов.
Откройте редактор документа ОказаниеУслуги. На закладке Ввод на основании определите состав объектов, на основании которых может вводиться документ ОказаниеУслуги и основанием для которых он может являться. В списке Вводится на основании выберите справочник Клиенты (рис. 27.4).

Рис. 27.4. Определение состава объектов, на основании которых вводится документ {https://ai2b.pro/wp-content/uploads/1/27_04.png}
Затем в панели Навигатор нажмите Конструкторы – Конструктор ввода на основании… в контекстном меню документа.
Задайте значения реквизитов документа, создаваемого на основании. Для этого мышью перетащите поле справочника Ссылка на строки выражений для полей документа Клиент и ОбъектОснование (рис. 27.5).

Рис. 27.5. Заполнение значений реквизитов документа, создаваемого на основании {https://ai2b.pro/wp-content/uploads/1/27_05.png}
Нажмите OK.
В модуле документа будет сформирован текст обработчика события ОбработкаЗаполнения (листинг 27.11).
Листинг 27.11. Обработчик события «ОбработкаЗаполнения()»
Процедура ОбработкаЗаполнения(ДанныеЗаполнения,СтандартнаяОбработка)
//{{__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
//Данный фрагмент построен конструктором.
//При повторном использовании конструктора, внесенные вручную данные будут утеряны!
 
Если ТипЗнч(ДанныеЗаполнения) = Тип("СправочникСсылка.Клиенты") Тогда
// Заполнение шапки
Клиент = ДанныеЗаполнения.Ссылка;
ОбъектОснование = ДанныеЗаполнения.Ссылка;
 
КонецЕсли;
 
//}}__КОНСТРУКТОР_ВВОД_НА_ОСНОВАНИИ
 
КонецПроцедуры
Как видите, для каждого типа объекта-основания формируется своя ветка условия Если…, в которой происходит заполнение реквизитов нового документа.

##### В прикладном решении
Запустите проект в режиме отладки и проверьте работу ввода на основании.
Откройте список клиентов (Предприятие – Клиенты). Обратите внимание, что в командной панели формы списка справочника Клиенты появилась команда Создать на основании (рис. 27.6).

Рис. 27.6. Создание документа «Оказание услуги» на основании клиента {https://ai2b.pro/wp-content/uploads/1/27_06.png}
Выделив нужного клиента, нажмите Создать на основании – Оказание услуги. В результате будет создан новый документ Оказание услуги, где в качестве клиента будет указан выделенный в списке справочника клиент.
Введите самостоятельно еще несколько документов на основании какого-либо клиента.

#### Объекты, введенные на основании
Хотя платформа содержит механизмы, позволяющие создавать одни объекты на основании других, каких-либо специальных механизмов для анализа цепочек связанных объектов в платформе нет.
Для решения подобной задачи вы можете использовать некоторые рекомендации, которые могут быть положены в основу конкретного решения.
Для построения цепочек связанных объектов можно у каждого объекта, который будет вводиться на основании, создать служебный реквизит для хранения ссылки на объект-основание. Затем можно добавить объект конфигурации КритерийОтбора, который будет использоваться для установки отбора по требуемому значению служебного реквизита.
В дальнейшем для получения всех объектов, введенных на основании, достаточно будет установить нужное значение отбора в критерии отбора.

#### Критерий отбора
Объект конфигурации КритерийОтбора предназначен для задания правил, по которым может выполняться отбор объектов.
Этот объект используется в случае поиска различной информации, когда, например, требуется отобрать все документы, в которых используется (в реквизитах и в табличных частях) определенный контрагент.
При этом можно учитывать также и другие условия отбора информации (например, поиск ведется только среди проведенных документов или в определенном интервале дат).

#### Получение объектов, введенных на основании
Поскольку задача получения всех объектов, введенных на основании какого-либо другого объекта, чаще всего возникает при анализе документов, вы рассмотрите применение описанной выше методики на примере получения списка документов, введенных на основании элемента справочника Клиенты.
##### В 1C:EDT
В ветви Общие – Критерии отбора добавьте объект конфигурации – критерий отбора с именем ОказаниеУслуги типа СправочникСсылка.Клиенты.
В качестве объектов, входящих в состав критерия, выберите реквизит ОбъектОснование документа ОказаниеУслуги (рис. 27.7).

Рис. 27.7. Состав критерия отбора «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/27_07.png}
После этого в панели навигации формы элемента справочника Клиенты в группе Перейти появится команда для открытия критерия отбора.
Создайте эту форму и установите видимость команды КритерийОтбора.ОказаниеУслуги в панели навигации формы документа.

##### В прикладном решении
Запустите проект в режиме отладки и проверьте работу критерия отбора.
В форме списка клиентов выделите клиента, на основании которого вы создавали документы Оказание услуги.
Откройте форму этого клиента. В панели навигации появилась команда Оказание услуги для открытия формы списка созданного вами критерия отбора с установленным отбором по открытому элементу справочника Клиенты.
Выполните эту команду (рис. 27.8).

Рис. 27.8. Открытие списка критерия отбора «ОказаниеУслуги» с отбором по клиенту {https://ai2b.pro/wp-content/uploads/1/27_08.png}
Вы видите в этом списке документ Оказание услуги, созданный на основании клиента Роман. К содержимому документа можно перейти, нажав на него в списке.

## Занятие 28 (2:10). Приемы разработки форм
Продолжительность
Ориентировочная продолжительность занятия – 2 часа 10 минут.
На этом занятии вы рассмотрите несколько типичных приемов работы с формами объектов.
Сначала вы узнаете, каким образом данные отображаются в формах, и о тех типах данных, которые при этом используются.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Данные и элементы формы
Важной особенностью платформы «1С:Предприятие» является механизм представления данных в формах. Ключевым моментом здесь является то, что принадлежность формы к тому или иному объекту конфигурации никоим образом не определяет состав данных, которые форма будет отображать.
Например, можно создать общую форму, которая не будет подчинена ни одному из объектов конфигурации, но которая в зависимости от содержимого будет либо отображать список справочника, либо позволять редактировать документ и т. п. Однако такую форму уже нельзя будет назначить основной для выполнения определенных действий.
Форма сама по себе и ее элементы обособлены от объектов конфигурации. Для того чтобы форма отображала какие-либо данные, необходимо задать связь самой формы и ее элементов с данными. Если связь элементов формы с данными не задана, то элементы вообще не будут отображены в форме (кроме элементов оформления формы).
При использовании конструктора форм 1C:EDT создает такие связи автоматически. Если вы создаете форму вручную, вы можете определить эти связи путем задания свойств формы и ее элементов (рис. 28.1).

Рис. 28.1. Связь элементов формы с данными {https://ai2b.pro/wp-content/uploads/1/28_01.png}
Связь элементов формы с данными, которые они должны отображать, задается в свойстве ПутьКДанным.
Связь формы и ее элементов с данными осуществляется при помощи реквизитов формы. Список существующих реквизитов формы доступен на закладке Реквизиты окна редактора формы.
Среди всех реквизитов формы, как правило, существует один основной реквизит (он выделен жирным шрифтом). Он определяет источник данных для формы в целом. От типа значения основного реквизита формы зависит не только то, какие данные будут отображены в элементах формы, но и поведение самой формы.
Например, если основному реквизиту формы указать тип значения ДокументОбъект.ПриходнаяНакладная, то при закрытии формы программа будет запрашивать подтверждение записи и проведения документа. Если же основному реквизиту формы указать тип значения СправочникОбъект.Клиенты, то подобного подтверждения при закрытии формы возникать не будет.
Похожее влияние источники данных оказывают и на элементы формы.
Например, состав колонок таблицы, источником данных которой является реквизит формы с типом значения ДинамическийСписок, будет различным в зависимости от того, какой объект используется в качестве основной таблицы этого динамического списка (например, РегистрНакопления.ОстаткиНоменклатуры или Справочник.Номенклатура).
То же самое справедливо и для элемента формы Командная панель. При установленном свойстве командной панели Автозаполнение смена источника данных (а точнее говоря, источника действий) будет приводить к изменению состава команд, которые отображает командная панель.
Возможность связать форму и ее элементы с различными данными является причиной того, что у формы и ее элементов существует несколько расширений.
Расширение представляет собой набор дополнительных свойств, методов и событий, появляющихся у формы или у элемента формы. Наличие того или иного расширения определяется либо типом данных, которые отображает форма/элемент, либо расположением элемента формы в других ее элементах.
Чтобы подробнее познакомиться с этим механизмом, создайте основную форму списка справочника Номенклатура. При этом в конструкторе формы не нужно сразу нажимать Готово, как вы делали раньше.
Нажмите Далее > и кроме полей Наименование и Код включите в таблицу Список еще одно поле – ВидНоменклатуры. И затем уже нажмите Готово (рис. 28.2).

Рис. 28.2. Форма списка справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/28_02.png}
Итак, с механизмом расширений вы будете знакомиться на примере поля ВидНоменклатуры, расположенного в таблице Список формы списка справочника Номенклатура.
Сама форма отображает данные объекта ДинамическийСписок (основной реквизит формы Список имеет тип ДинамическийСписок, рис. 28.3).

Рис. 28.3. Основной реквизит формы списка {https://ai2b.pro/wp-content/uploads/1/28_03.png}
Поэтому к свойствам, методам и событиям объекта встроенного языка ФормаКлиентскогоПриложения добавляется Расширение формы клиентского приложения для динамического списка (рис. 28.4).

Рис. 28.4. Контекст формы дополняется контекстом расширения динамического списка {https://ai2b.pro/wp-content/uploads/1/28_04.png}
В результате этого у формы появляются такие параметры, как ТекущаяСтрока, Отбор и т. п.
Теперь посмотрите на таблицу Список.
Поскольку в таблице отображается динамический список, то к свойствам, методам и событиям объекта встроенного языка ТаблицаФормы добавляется Расширение таблицы формы для динамического списка (рис. 28.5).

Рис. 28.5. Контекст таблицы дополняется контекстом расширения динамического списка {https://ai2b.pro/wp-content/uploads/1/28_05.png}
В результате у таблицы Список появляются такие свойства, как АвтоОбновление, ОтображатьКорень и т. д.
И в заключение посмотрите на поле ВидНоменклатуры.
Это поле связано с реквизитом типа ПеречислениеСсылка.ВидыНоменклатуры и является полем ввода.
Поэтому к свойствам, методам и событиям объекта встроенного языка ПолеФормы добавляется Расширение поля формы для поля ввода (рис. 28.6).

Рис. 28.6. Контекст поля формы дополняется контекстом расширения поля ввода {https://ai2b.pro/wp-content/uploads/1/28_06.png}
В результате у поля ВидНоменклатуры появляются такие свойства, как БыстрыйВыбор, ВыделенныйТекст и т. д.

### Типы данных формы
В форме можно выделить следующие категории типов, с которыми она работает:
Типы встроенного языка, предназначенные для использования как в формах, так и вне них. Например: Число, СправочникСсылка.<имя>, ГрафическаяСхема, ТабличныйДокумент и т. д.
Типы встроенного языка, предназначенные исключительно для того, чтобы представить в форме данные прикладных объектов (справочников, документов и т. д.). Это такие типы, как ДанныеФормыСтруктура, ДанныеФормыКоллекция и другие.
Отдельно следует упомянуть тип ДинамическийСписок, который используется в формах для отображения списков прикладных объектов.
Все типы прикладных объектов (такие как СправочникОбъект и т. д.) не существуют на стороне тонкого и веб-клиентов, они существуют только на сервере. Однако данные этих объектов нужно отображать в формах.
Поэтому для представления в форме данных этих прикладных типов введены специальные типы данных:
ДанныеФормыСтруктура – содержит набор свойств произвольного типа. Свойствами могут быть другие структуры, коллекции или структуры с коллекциями. Таким типом в форме представляется, например, СправочникОбъект.
ДанныеФормыКоллекция – это список типизированных значений, похожий на массив. Доступ к элементу коллекции осуществляется по индексу или по идентификатору. Доступ по идентификатору может отсутствовать в некоторых случаях. Это обусловлено типом прикладного объекта, который представлен этой коллекцией. Идентификатором может быть любое целое число. Таким типом в форме представляется, например, табличная часть.
ДанныеФормыСтруктураСКоллекцией – это объект, который представлен в виде структуры и коллекции одновременно. С ним можно обращаться, как с любой из этих сущностей. Таким типом в форме представляется, например, набор записей.
ДанныеФормыДерево – объект предназначен для хранения иерархических данных.
Прикладной объект представлен либо одним, либо несколькими элементами данных формы. В общем виде иерархия и состав данных формы зависят от сложности и взаимосвязи прикладных объектов, отображаемых в форме.
Например, документ, содержащий табличную часть, будет представлен объектом типа ДанныеФормыСтруктура (собственно документ), которому подчинен объект типа ДанныеФормыКоллекция (табличная часть документа).
ВНИМАНИЕ!
Во время разработки конфигурации важно помнить, что прикладные объекты доступны только на сервере, в то время как объектами данных форм можно пользоваться и на сервере, и на клиенте.
Фактически, можно сказать, что данные формы – это унифицированное представление данных различных прикладных объектов, с которыми форма работает единообразно и которые присутствуют и на сервере, и на клиенте.
В редакторе формы (у реквизитов формы) вместо имен этих типов обычно отображаются те прикладные типы, данные которых содержит реквизит.
Например, если реквизит Объект содержит данные элемента справочника Клиенты, то в колонке Тип отображается не настоящий тип этого реквизита формы – ДанныеФормыСтруктура, а тип прикладного объекта, данные которого содержатся в этом реквизите СправочникОбъект.Клиенты. Причем, чтобы было понятно, что это «не настоящий» тип реквизита, тип прикладного объекта показывается в круглых скобках.
Таким образом, форма содержит некоторую «проекцию» данных прикладных объектов в виде своих собственных типов данных и автоматически выполняет преобразование между ними при необходимости.
Однако если разработчик конфигурации реализует свой алгоритм обработки данных, то преобразование данных (из специализированных типов в прикладные и обратно) он должен выполнять самостоятельно.
Для конвертирования прикладных объектов в данные формы и обратно существует набор глобальных методов:
ЗначениеВДанныеФормы() – преобразует объект прикладного типа в данные формы;
ДанныеФормыВЗначение() – преобразует данные формы в объект прикладного типа.
Аналогичные методы, предназначенные для конвертирования значений реквизитов формы в прикладные объекты и обратно, существуют и у самой формы клиентского приложения:
ЗначениеВРеквизитФормы() – преобразует объект прикладного типа в реквизит формы клиентского приложения;
РеквизитФормыВЗначение() – преобразует реквизит формы клиентского приложения в значение прикладного типа.
Методы, работающие с прикладными объектами, доступны только в серверных процедурах формы.
При выполнении стандартных действий формы с основным реквизитом (открытие формы, выполнение стандартной команды Записать и т. д.) преобразование выполняется автоматически.
Ниже приведен пример преобразования данных, которое может потребоваться в собственных алгоритмах.
Например, у вас есть особенная форма, в которой в качестве одного из реквизитов (ТоварДляМодификации) используются данные элемента справочника Товары. При создании формы на сервере вы по некоторому алгоритму определяете, какой именно это товар, и читаете его данные в реквизит формы. При этом используется преобразование данных ЗначениеВДанныеФормы() – листинг 28.1.
Листинг 28.1. Пример преобразования данных прикладных объектов в данные формы
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
 
ОбъектТовар = Справочники.Товары.НайтиПоНаименованию("Кофейник").ПолучитьОбъект();
ЗначениеВДанныеФормы(ОбъектТовар, ТоварДляМодификации);
 
КонецПроцедуры
 
&НаКлиенте
Процедура Записать()
 
ЗаписатьНаСервере();
 
КонецПроцедуры
 
&НаСервере
Процедура ЗаписатьНаСервере()
 
ОбъектТовар = ДанныеФормыВЗначение(ТоварДляМодификации, Тип("СправочникОбъект.Товары"));
ОбъектТовар.Записать();
 
КонецПроцедуры
В некоторый момент работы формы вы решаете, что измененные данные вашего товара необходимо записать в базу данных, и тогда вы выполняете обратное преобразование данных формы в прикладной объект (ДанныеФормыВЗначение()) и записываете его.
Как уже говорилось выше, у формы также есть методы, позволяющие преобразовать прикладные данные в реквизит формы и наоборот.
Использование методов формы обычно удобнее, так как они имеют, например, информацию о типе реквизита формы. Кроме того, метод РеквизитФормыВЗначение() выполняет установку соответствия данных формы и объекта, которая используется при формировании сообщений.
Ниже приведен пример использования этих методов. В серверной процедуре формы вы получаете прикладной объект из реквизита формы и выполняете метод этого прикладного объекта Пересчитать(). Затем данные объекта, измененные в результате пересчета, вы преобразуете обратно в реквизит формы (листинг 28.2).
Листинг 28.2. Пример преобразования данных прикладных объектов в данные формы
&НаСервере
Процедура ПересчитатьНаСервере()
 
// Преобразовать реквизит Объект в прикладной объект.
Документ = РеквизитФормыВЗначение("Объект");
 
// Выполнить пересчет методом, определенным в модуле документа.
Документ.Пересчитать();
 
// Преобразует прикладной объект обратно в реквизит.
ЗначениеВРеквизитФормы(Документ, "Объект");
 
КонецПроцедуры

### Связанные списки
При создании прикладных решений часто возникает необходимость из какой-либо формы прикладного объекта перейти к информации, логически связанной с этим объектом.
Это может быть, например, список подчиненного справочника; регистры, в которых объект производит движения; регистры, где измерение с типом этого объекта указано как ведущее; критерии отбора, в которые входит этот тип; объекты, которые можно ввести на основании этого типа, и т. д.
Одним из распространенных примеров использования связанных списков является необходимость перейти из формы документа к списку движений, которые произвел этот документ в каком-либо регистре.
Все перечисленные ситуации платформа контролирует автоматически. На основании информации, содержащейся в объектах конфигурации, платформа автоматически создает в формах объектов команды для перехода к связанной информации. Некоторые такие команды она сразу же делает видимыми, и они появляются в форме. Некоторые команды она только создает, но по умолчанию не включает их видимость.
Поэтому чаще всего, если в форме вы не видите команды перехода к связанной информации, которая должна быть, просто нужно включить ее видимость в интерфейсе формы.
#### В 1C:EDT
Для примера откройте форму документа ОказаниеУслуги. В левом верхнем окне перейдите на закладку Командный интерфейс.
В разделе Панель навигации в группе Перейти уже находится набор таких команд. Это команды перехода к записям регистров, для которых данный документ является регистратором.
Вы можете установить общую видимость для этих команд, а можете более точно настроить видимость этих команд для каждой отдельной роли, которая есть в вашей конфигурации (рис. 28.7).

Рис. 28.7. Командный интерфейс формы {https://ai2b.pro/wp-content/uploads/1/28_07.png}

#### В прикладном решении
Запустите проект и откройте один из документов Оказание услуги (рис. 28.8).

Рис. 28.8. Документ «Оказание услуги № 3» {https://ai2b.pro/wp-content/uploads/1/28_08.png}
В панели навигации формы вы видите команды перехода к списку записей регистров, связанных с открытым документом.
Например, выполните команду Стоимость материалов и перейдите к движениям, которые произвел в этом регистре ваш документ (рис. 28.9).

Рис. 28.9. Движения документа «Оказание услуги № 3» по регистру «Стоимость материалов» {https://ai2b.pro/wp-content/uploads/1/28_09.png}

### Оформление строк в форме списка
Одним из полезных свойств формы списка является возможность настройки оформления его строк. Для иллюстрации этой возможности вы воспользуетесь формой списка справочника Номенклатура и придадите ей нестандартный вид.
#### В 1C:EDT
Откройте форму списка справочника Номенклатура и создайте обработчик события формы ПриСозданииНаСервере.
Внесите в него следующий текст (листинг 28.3).
Листинг 28.3. Обработчик события формы «ПриСозданииНаСервере»
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
 
СписокСправочника = Элементы.Список;
 
// Задать режим отображения справочника.
СписокСправочника.Отображение = ОтображениеТаблицы.Список;
 
// Скрыть линии сетки.
СписокСправочника.ВертикальныеЛинии = Ложь;
СписокСправочника.ГоризонтальныеЛинии = Ложь;
 
КонецПроцедуры
В этой процедуре, выполняющейся при создании формы на сервере, вы сначала представляете список в виде обычного, а не иерархического списка. Это сделано для большей наглядности, чтобы материалы отображались вперемешку с услугами.
Затем вы скрываете линии, разделяющие колонки и строки таблицы списка.
Теперь настройте условное оформление строк списка. Для этого в панели Свойства основного реквизита формы Список нажмите Открыть в строке Настройка списка (рис. 28.10).

Рис. 28.10. Вызов настройки динамического списка {https://ai2b.pro/wp-content/uploads/1/28_10.png}
Поскольку этот реквизит имеет тип ДинамическийСписок, который построен на основе системы компоновки данных, вы можете задать для него настройки Отбор, Порядок, Группировка и УсловноеОформление аналогично тому, как это делалось в отчетах.
В окне настройки динамического списка перейдите на закладку Настройки – Условное оформление и нажмите Добавить в командной панели окна.
Сначала укажите Оформление для выделения полей.
Нажмите кнопку выбора в поле Оформление и установите сиреневый цвет фона (рис. 28.11).

Рис. 28.11. Настройка условного оформления {https://ai2b.pro/wp-content/uploads/1/28_11.png}
Нажмите ОК. Затем укажите условие, при наступлении которого будет применяться оформление, то есть когда строки списка будут сиреневыми.
Нажмите кнопку выбора в поле Условие и в появившемся окне перетащите поле ВидНоменклатуры из списка доступных полей в список условий отбора.
В графе Вид сравнения выберите значение Равно, а в графе Правое значение выберите Перечисление.ВидыНоменклатуры.Услуга. Для этого нажмите в этом поле сначала кнопку очистки, затем кнопку выбора типа , укажите тип – ПеречислениеСсылка.ВидыНоменклатуры и затем выберите предопределенное значение Услуга (рис. 28.12).

Рис. 28.12. Настройка условного оформления {https://ai2b.pro/wp-content/uploads/1/28_12.png}
Нажмите ОК.
Таким образом, вы установили, что услуги в справочнике Номенклатура будут выделены сиреневым фоном.
Поскольку вы хотите выделить полностью строки, а не отдельные поля списка, то список оформляемых полей можно оставить пустым. Нажмите ОК.

#### В прикладном решении
Запустите проект в режиме отладки и откройте справочник Номенклатура.
Вы видите, что справочник имеет вид обычного неиерархического списка, услуги выделены сиреневым цветом, а также отсутствуют разделительные линии строк и колонок списка (рис. 28.13).

Рис. 28.13. Данные справочника «Номенклатура» с заданным оформлением {https://ai2b.pro/wp-content/uploads/1/28_13.png}


#### В 1C:EDT
Существуют также свойства пользовательских настроек списка, которые аналогичны для всех настроек динамического списка: Отбор, Порядок, Группировка и УсловноеОформление. Настройки динамических списков в платформе очень похожи на настройки отчетов, построенных с помощью системы компоновки данных.
По умолчанию в окне настроек (внизу на каждой из закладок: Отбор, Порядок, Группировка, УсловноеОформление) динамического списка в 1С:EDT установлен флажок Включать в пользовательские настройки, а также свойство Режим редактирования установлено – Обычный (рис. 28.11).
Это значит, что пользователь может изменить заданное оформление списка, выполнив команду Еще – Настроить список… При этом откроется окно настройки динамического списка, аналогичное окну пользовательских настроек отчетов, где он может задать свое условное оформление списка и/или другие настройки (рис. 28.15).
Если настройка требуется пользователю часто, то можно поместить настройку непосредственно в форме списка. Для этого нужно установить в окне настройки списка Режим редактирования в значение Быстрый доступ (рис. 28.14).

Рис. 28.14. Свойства настроек условного оформления {https://ai2b.pro/wp-content/uploads/1/28_14.png}


#### В прикладном решении
При открытии списка в прикладном решении вы увидите следующий результат (рис. 28.15).

Рис. 28.15. Пользовательские настройки списка справочника «Номенклатура» {https://ai2b.pro/wp-content/uploads/1/28_15.png}

Вы видите, что настройка условного оформления доступна пользователю в самой форме списка, сразу над списком справочника. Кроме того, он может вызвать окно пользовательских настроек по команде Еще – Настроить список… и редактировать там условное оформление и другие настройки списка.
А также (как и в отчетах) пользователь может изменить состав настроек (Еще – Изменить состав настроек…) согласно своим предпочтениям. То есть перенести какие-то настройки из списка быстрых настроек в обычные, и наоборот.
В заключение следует заметить, что свойства Включать в пользовательские настройки, Представление и Режим редактирования, устанавливаемые в 1С:EDT (рис. 28.14), могут относиться как в целом к настройкам отбора, порядка, группировки и условного оформления динамического списка, так и к отдельным элементам этих настроек. Например, одна настройка отбора может быть включена в пользовательские настройки, а другая – нет. Свойства отдельных элементов настроек, если они заданы, имеют больший приоритет. Они задаются по команде Свойства элемента пользовательских настроек нажатием соответствующей кнопки над списком настроек.
Аналогичным образом можно настраивать условное оформление и для списков, источником которых является не динамический список, а другие типы данных. Например, условное оформление табличной части документа.
Но выполняется это уже с помощью условного оформления самой формы. То есть в дереве элементов формы нужно выделить корневой элемент и в панели Свойства открыть ссылку УсловноеОформление.
Если требуется выделить по некоторому условию полностью всю строку табличной части, то в список Оформляемые поля нужно добавить саму таблицу формы, содержащую табличную часть (например, Материалы), иначе нужно указать те поля таблицы, которые должны быть оформлены.

### Вычисляемые колонки в списках
Необходимость вывода произвольных данных в колонках списка возникает, когда вместе с элементом списка нужно отобразить некоторую вычисляемую информацию.
Рассмотрите эту ситуацию на примере отображения актуальной цены в списке справочника Номенклатура.
Эти данные вы можете получить из таблицы регистра сведений Цены.СрезПоследних. Следовательно, поле Цена из этой таблицы вам нужно добавить в динамический список Список, который является основным реквизитом формы списка справочника Номенклатура и служит источником данных для таблицы списка.
#### В 1C:EDT
Откройте форму списка справочника Номенклатура и панель Свойства основного реквизита формы Список.
До сих пор в свойствах динамического списка была указана Основная таблица – таблица справочника Номенклатура (рис. 28.10) и список формировался путем запроса к этой таблице.
Теперь вам нужна еще связанная информация из таблицы регистра сведений Цены.СрезПоследних.
Поэтому установите флажок ПроизвольныйЗапрос и в строке Настройка списка нажмите Открыть (рис. 28.16).

Рис. 28.16. Вызов настройки динамического списка {https://ai2b.pro/wp-content/uploads/1/28_16.png}

Откроется окно настройки динамического списка. На закладке Запрос вы видите запрос, в котором выбираются все поля из таблицы Справочник.Номенклатура.
Измените его. Для этого нажмите Конструктор запроса (рис. 28.17).

Рис. 28.17. Создание произвольного запроса для динамического списка {https://ai2b.pro/wp-content/uploads/1/28_17.png}

Сначала, для того чтобы исключить неоднозначность имен в запросе, переименуйте таблицу Номенклатура в спрНоменклатура.
Затем добавьте в список таблиц Цены.СрезПоследних и выберите из нее поле Цена (рис. 28.18).

Рис. 28.18. Добавление второй таблицы {https://ai2b.pro/wp-content/uploads/1/28_18.png}

На закладке Связи отредактируйте связь между таблицами, созданную по умолчанию.
Для этого поменяйте расположение таблиц в соединении так, чтобы первой (левой) таблицей была таблица справочника Номенклатура (рис. 28.19).

Рис. 28.19. Установка связи между таблицами {https://ai2b.pro/wp-content/uploads/1/28_19.png}

Тем самым вы указали, что в списке справочника Номенклатура будут отражены все позиции, даже те, по которым не установлены цены.
Похожие действия вы уже выполняли на занятии № 14 «Отчеты» для отчета «Перечень услуг».
Создание запроса закончено, нажмите ОК.
Теперь колонка Цена, содержащая актуальную цену, будет отображаться в списке справочника, когда вы поместите ее в форму списка.
В окне настройки динамического списка перейдите на закладку Настройки и задайте условное оформление этой колонки так, чтобы низкие цены выделялись цветом.
Для этого перейдите на закладку Условное оформление. Там вы видите созданное вами ранее условное оформление для строк списка. Добавьте еще один элемент условного оформления.
Сначала установите синий цвет текста в поле Оформление.
Затем в поле Условие укажите условие, при наступлении которого будет применяться оформление, то есть когда текст в колонке Цена будет синим.
Перетащите поле Цена из списка доступных полей в список условий отбора. В графе Вид сравнения выберите значение Меньше, а в графе Правое значение выберите 500.
Затем укажите список оформляемых полей. Нажмите кнопку выбора в поле Оформляемые поля, затем нажмите Добавить и выберите поле Цена.
Теперь задайте отдельно свойства для каждого созданного вами элемента настроек условного оформления.
Для этого выделите каждую настройку и нажмите Свойства элемента пользовательских настроек над списком настроек. У обеих настроек установите флажок Включать в пользовательские настройки.
Задайте представление первой настройки как Услуги, второй – Низкая цена, а свойство Режим редактирования оставьте без изменения в значении Быстрый доступ. Аналогичное свойство для настроек условного оформления в целом (внизу окна) верните к значению Обычный (рис. 28.20).

Рис. 28.20. Свойства настроек условного оформления {https://ai2b.pro/wp-content/uploads/1/28_20.png}

Нажмите ОК. Теперь вам осталось только перетащить поле Цена из окна реквизитов в окно элементов формы, в состав элемента Список.

#### В прикладном решении
Запустите проект в режиме отладки и откройте справочник Номенклатура. Вы видите, что вместе с номенклатурой выводится ее актуальная цена, причем цены на номенклатуру меньше 500 выделены синим цветом текста. А также строки номенклатуры, являющейся услугами, выделены сиреневым цветом фона. Обе настройки условного оформления расположены прямо над списком справочника, они имеют понятные названия, их можно включить или выключить (предварительно нужно удалить общую настройку оформления строк списка цветом фона, если она осталась в пользовательских настройках) – рис. 28.21.

Рис. 28.21. Данные справочника «Номенклатура» с заданным оформлением {https://ai2b.pro/wp-content/uploads/1/28_21.png}

В заключение обратите внимание на свойство динамического списка Автоматическое сохранение пользовательских настроек (рис. 28.16). Стандартно оно включено.
Поэтому при закрытии формы все настройки списков автоматически сохраняются в системном хранилище и загружаются при открытии формы этим же пользователем. Кроме того, пользователь может сохранять настройки списков и вручную, задавая им понятные имена (Еще – Сохранить настройки…, Еще – Выбрать настройки…). В результате для одного и того же списка можно хранить несколько вариантов его настройки.
Можно снова вернуться к настройкам списка, заданным разработчиком (открытым по команде Еще – Настроить список…), выполнив команду Еще – Установить стандартные настройки.

### Список выбора для поля ввода
Одним из полезных и удобных механизмов поля ввода является использование списка выбора для этих полей.
Поля ввода, имеющие ссылочный тип (например, Склад, Сотрудник), по умолчанию имеют кнопку выбора. При нажатии этой кнопки открывается форма выбора объекта, на которую ссылается данное поле.
Но для полей других типов тоже бывает нужно выполнять выбор из нескольких предопределенных значений.
Реализуйте совсем простой пример, когда пользователю нужно ввести адреса клиентов, начинающиеся с названия города.
#### В 1C:EDT
Сначала нужно добавить поле Адрес в форму элемента справочника Клиенты.
Для этого справочнику Клиенты добавьте реквизит Адрес с типом Строка, длиной 25. Затем откройте форму элемента справочника и перетащите этот реквизит в окно элементов формы.
Для получившегося поля ввода установите свойство Режим выбора из списка. Затем нажмите кнопку выбора в свойстве Список выбора и, нажимая кнопку Добавить, создайте значения, например: Москва, Санкт-Петербург, Суздаль (рис. 28.22).

Рис. 28.22. Создание списка выбора для поля ввода {https://ai2b.pro/wp-content/uploads/1/28_22.png}


#### В прикладном решении
Запустите проект в режиме отладки и откройте форму редактирования клиента. В поле Адрес наберите «с», и система предложит на выбор два подходящих названия (рис. 28.23).

Рис. 28.23. Выбор из заданного списка значений в поле ввода {https://ai2b.pro/wp-content/uploads/1/28_23.png}

Аналогичные действия, которые вы выполнили в 1C:EDT, можно выполнить и во встроенном языке. То есть в зависимости от некоторого алгоритма можно формировать список выбора для поля ввода динамически.
Более того, вы можете из встроенного языка изменять тот список выбора, который формируется платформой автоматически, например в автогенерируемых формах. Для этого используется обработчик события Обработка получения данных выбора, который располагается в модуле менеджера объекта. Например, это можно сделать в модуле менеджера справочника, когда в поле ввода подбирается один из элементов этого справочника.

### Форма выбора для поля, содержащего ссылочный реквизит
В процессе работы прикладного решения довольно распространенной является ситуация, когда данные вводятся в поля ссылочных реквизитов, то есть реквизитов, ссылающихся на какие-либо объекты конфигурации.
Например, в документе Оказание услуги вы заполняете поле ссылочного типа Мастер (тип СправочникСсылка.Сотрудники).
При нажатии кнопки выбора из списка в этом поле по умолчанию открывается основная форма выбора справочника Сотрудники.
Но иногда бывает нужно, чтобы именно в документе ОказаниеУслуги для выбора открывалась не основная форма выбора, как в других местах, а своя собственная форма, разработанная специально для подбора мастеров в документ ОказаниеУслуги.
Для этого в объекте конфигурации, в документе ОказаниеУслуги, у реквизита Мастер есть свойство ФормаВыбора. В этом свойстве нужно указать эту специальную форму, и тогда она будет открываться для выбора данного реквизита в любой форме, где он находится.
#### В 1C:EDT
Сначала нужно создать форму, предназначенную для выбора мастера в документе ОказаниеУслуги.
В дереве объектов конфигурации в панели Навигатор вы видите, что у справочника Сотрудники вообще еще нет ни одной формы. Это значит, что все формы справочника в прикладном решении, в том числе и форма выбора, генерировались системой автоматически.
Вы создадите обычную форму выбора, просто не будете назначать ее основной, чтобы, как и раньше, для выбора сотрудника в любом поле, имеющем тип ссылки на этот справочник, использовалась бы автогенерируемая форма.
В панели Навигатор нажмите Создать – Форма в контекстном меню справочника Сотрудники.
Выберите тип – Форма выбора справочника.
Снимите флажок Назначить форму основной.
Задайте имя – ФормаВыбораОказаниеУслуги (рис. 28.24).

Рис. 28.24. Создание формы выбора для документа «ОказаниеУслуги» {https://ai2b.pro/wp-content/uploads/1/28_24.png}

Нажмите Далее.
Снимите флажок у реквизита Код и нажмите Готово (рис. 28.25).

Рис. 28.25. Создание основного реквизита формы {https://ai2b.pro/wp-content/uploads/1/28_25.png}

Теперь в учебных целях измените заголовок формы, чтобы отличать ее от автогенерируемой формы выбора.
Задайте заголовок – Форма выбора для документа ОказаниеУслуги.
Снимите флажок Автоматический заголовок (рис. 28.26).

Рис. 28.26. Установка свойств формы {https://ai2b.pro/wp-content/uploads/1/28_26.png}

Теперь в панели Навигатор выделите реквизит Мастер у документа ОказаниеУслуги. В панели Свойства нажмите кнопку выбора в поле Форма выбора.
Откроется список форм выбора, созданных в конфигурации для объекта, на который ссылается данный реквизит. В данном случае для справочника Сотрудники, на который ссылается реквизит Мастер, создана одна форма – ФормаДляВыбора. Выберите ее (рис. 28.27).

Рис. 28.27. Установка формы выбора для ссылочного реквизита {https://ai2b.pro/wp-content/uploads/1/28_27.png}


#### В прикладном решении
Запустите проект в режиме отладки и откройте один из документов Оказание услуги. Нажмите кнопку выбора из списка в поле Мастер и в выпадающем списке, открывшемся под полем ввода, нажмите ссылку Показать все.
Откроется созданная вами форма с заголовком Форма выбора для документа ОказаниеУслуги (рис. 28.28).

Рис. 28.28. Форма выбора сотрудников в документе «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/28_28.png}

Таким образом, поскольку вы задали свойство Форма выбора на уровне реквизита Мастер, а не на уровне отдельной формы, в любой форме, где используется реквизит Мастер документа ОказаниеУслуги, при выборе значения этого реквизита будет открываться ваша специальная форма.
Для проверки откройте список документов Начисление сотрудникам (Расчет зарплаты – Начисления сотрудникам), создайте новый документ, добавьте строку и нажмите Показать все для выбора сотрудника из списка.
Вы увидите, что в данном случае используется автогенерируемая форма выбора, а не та, которую вы создали для документа ОказаниеУслуги (рис. 28.29).

Рис. 28.29. Форма выбора сотрудников в документе «Начисление сотрудникам» {https://ai2b.pro/wp-content/uploads/1/28_29.png}


### Проверка заполнения реквизитов
Для реквизитов объектов конфигурации существует возможность как автоматической, так и программной проверки их заполнения. Причем делается это не на уровне форм, а на уровне свойств реквизитов или в модуле объекта, к которому относится данный реквизит. Таким образом, проверка заполнения реквизита будет производиться во всех формах, где используется этот реквизит.
#### Автоматическая проверка заполнения
##### В 1C:EDT
Для примера возьмите объект конфигурации – документ ОказаниеУслуги. Допустим, вам нужно контролировать заполнение реквизита табличной части. Имя реквизита – НаборСвойств.
Выделите этот реквизит и в панели Свойства установите свойство Проверка заполнения в значение Выдавать ошибку (рис. 28.30).

Рис. 28.30. Свойство «Проверка заполнения» реквизита «НаборСвойств» {https://ai2b.pro/wp-content/uploads/1/28_30.png}

Тем самым при записи документа этот реквизит будет проверяться на заполнение. Если значение реквизита не заполнено, будет выдано сообщение об ошибке и документ не будет сохранен.

##### В прикладном решении
Запустите проект в режиме отладки и откройте документ Оказание услуги № ЦБ000000001. В табличной части этого документа содержится две строки, для которых колонка Набор свойств не заполнена. При проведении этого документа будет выдано сообщение об ошибке, и документ не будет проведен (рис. 28.31).

Рис. 28.31. Сообщение об ошибке {https://ai2b.pro/wp-content/uploads/1/28_31.png}

#### Программная проверка заполнения
##### В 1C:EDT
Иногда бывает нужно самостоятельно производить проверку заполнения реквизита в соответствии с программной логикой. В этом случае, если для реквизита установлено свойство Проверка заполнения в значение Выдавать ошибку, нужно удалить этот реквизит из массива проверяемых реквизитов и выполнить проверку программным путем. Или же, если для реквизита не установлена проверка заполнения, можно программно добавить реквизит в массив проверяемых реквизитов.
Программная проверка заполнения объектов конфигурации выполняется в обработчике ОбработкаПроверкиЗаполнения(), который нужно поместить в модуле объекта. Этот обработчик вызывается автоматически при сохранении любой формы или при проведении документов. Программную проверку объектов интерактивного ввода нужно делать именно в этом обработчике, а не при записи объекта.
Создайте обработчик ОбработкаПроверкиЗаполнения() в модуле документа ОказаниеУслуги и заполните его следующим образом (листинг 28.4).
Листинг 28.4. Обработчик события «ОбработкаПроверкиЗаполнения»
Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
 
Индекс = ПроверяемыеРеквизиты.Найти("ПереченьНоменклатуры.НаборСвойств");
Если Индекс <> Неопределено Тогда
 
ПроверяемыеРеквизиты.Удалить(Индекс);
 
КонецЕсли;
 
Индекс = 0;
Для Каждого ТекСтрокаПереченьНоменклатуры Из ПереченьНоменклатуры Цикл
Если ТекСтрокаПереченьНоменклатуры.Номенклатура.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Материал Тогда
Если Не ЗначениеЗаполнено(ТекСтрокаПереченьНоменклатуры.НаборСвойств) Тогда
Сообщение = Новый СообщениеПользователю();
Сообщение.Текст = "В строке " + Строка(Индекс+1) + " не заполнена колонка Набор свойств";
Сообщение.Поле = "ПереченьНоменклатуры[" + Строка(Индекс) + "].НаборСвойств";
Сообщение.УстановитьДанные(ЭтотОбъект);
Сообщение.Сообщить();
 
Отказ = Истина;
 
КонецЕсли;
 
КонецЕсли;
 
Индекс = Индекс + 1;
 
КонецЦикла;
 
КонецПроцедуры
Сначала вы находите реквизит табличной части НаборСвойств в массиве ПроверяемыеРеквизиты. Этот массив передается в обработчик и содержит массив проверяемых реквизитов, которым вы установили свойство Проверка заполнения в значение Выдавать ошибку во время разработки конфигурации. Если он найден, то удаляете его, так как вы будете выполнять проверку самостоятельно.
Затем вы в цикле обходите строки табличной части документа и формируете сообщения об ошибке только в том случае, если номенклатура в табличной части является материалом и для нее не заполнена колонка НаборСвойств.
Параметр Отказ вы устанавливаете в значение Истина. Это значит, что документ не будет проведен, если найден хоть один незаполненный реквизит НаборСвойств для номенклатуры, являющейся материалом. Если этот параметр закомментировать, сообщения об ошибке будут выдаваться, но документ будет проведен.
Для упрощения примера вы опять здесь используете обращение ПереченьНоменклатуры.Номенклатура.ВидНоменклатуры, хотя более оптимально – использовать запрос. Об этом подробно рассказывалось на занятии № 12 в разделе «Регистрация расхода только той номенклатуры, которая является материалом».

##### В прикладном решении
Запустите проект в режиме отладки и откройте документ Оказание услуги № ЦБ000000001. Нажмите Провести.
Для первой строки табличной части будет выдано сообщение об ошибке (рис. 28.32).

Рис. 28.32. Сообщение об ошибке при записи документа {https://ai2b.pro/wp-content/uploads/1/28_32.png}
Можно также программно добавить реквизит в массив проверяемых реквизитов (листинг 28.5).
Листинг 28.5. Добавление реквизита в массив проверяемых реквизитов
ПроверяемыеРеквизиты.Добавить("ПереченьНоменклатуры.НаборСвойств");

### Использование параметризуемых команд
Использование параметризуемых команд в формах объектов позволяет при выполнении команды передать в обработчик команды какой-либо параметр, например значение ссылочного реквизита. И затем использовать его – например, открыть с этим параметром форму отчета.
Для примера вы создадите команду открытия отчета, показывающего остатки материалов по складу, указанному в документе. Отчет будет вызываться из формы документа ОказаниеУслуги, в него будет передаваться значение реквизита документа Склад, и при открытии отчета в настройки отчета будет добавляться отбор по параметру Склад.
#### В 1C:EDT
Сначала создайте параметризуемую команду объекта конфигурации, отчета Материалы.
В панели Навигатор нажмите Создать – Команда в контекстном меню отчета Материалы. Задайте имя команды – ОстаткиПоСкладу и нажмите Готово.
Задайте свойства команды:
В свойстве Группа выберите Командная панель формы.Важное;
В свойстве Тип параметра команды выберите СправочникСсылка.Склады (рис. 28.33).

Рис. 28.33. Создание параметризуемой команды {https://ai2b.pro/wp-content/uploads/1/28_33.png}
Таким образом, вы создали команду с типом параметра СправочникСсылка.Склады, и теперь во всех формах, имеющих реквизит такого типа, эта команда автоматически будет добавлена в список параметризуемых команд, доступных в форме.
Теперь из контекстного меню откройте модуль команды и заполните ее обработчик следующим образом (листинг 28.6).
Листинг 28.6. Обработчик параметризуемой команды
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
 
ПараметрыФормы = Новый Структура("Отбор, КлючНазначенияИспользования, СформироватьПриОткрытии", Новый Структура("Склад", ПараметрКоманды), "ОстаткиПоСкладу", Истина);
ОткрытьФорму("Отчет.Материалы.Форма", ПараметрыФормы, ПараметрыВыполненияКоманды.Источник, Истина, ПараметрыВыполненияКоманды.Окно);
 
КонецПроцедуры
В обработчик команды передается ПараметрКоманды, содержащий значение типа СправочникСсылка.Склады. Затем создается структура параметров формы (ПараметрыФормы): Отбор, КлючНазначенияИспользования, СформироватьПриОткрытии.
В параметр Отбор добавляется структура, содержащая элемент Склад со значением, содержащимся в параметре команды (ПараметрКоманды), параметр КлючНазначенияИспользования – «ОстаткиПоСкладу» определяет назначение использования формы, а параметру СформироватьПриОткрытии присваивается значение Истина, чтобы отчет формировался сразу после открытия.
Затем структура параметров формы передается в глобальный метод ОткрытьФорму(), и форма, указанная в первом параметре метода, открывается с этими параметрами. Причем, поскольку в четвертом параметре Уникальность этого метода передается Истина, при открытии формы каждый раз будет открываться новая форма отчета и отчет будет заново сформирован с отбором по складу, переданному в параметре команды.
Теперь поместите вашу команду в форму документа.
Как уже говорилось, в формах документов ПриходнаяНакладная и ОказаниеУслуги автоматически будет содержаться команда ОстаткиПоСкладу, так как они имеют реквизит Склад типа СправочникСсылка.Склады.
Откройте форму документа ОказаниеУслуги.
На закладке Команды перейдите в раздел Глобальные команды. Здесь вы видите список глобальных параметризуемых команд, доступных в форме. В группе Параметризуемые раскройте строку Объект и перетащите вашу команду Отчет.Материалы.Команда.ОстаткиПоСкладу(Объект.Склад) в командную панель элементов формы.
В скобках у команды указано значение реквизита Склад – (Объект.Склад), которое будет передаваться в обработчик команды при ее выполнении (рис. 28.34).

Рис. 28.34. Помещение параметризуемой команды в форму {https://ai2b.pro/wp-content/uploads/1/28_34.png}
Заметьте, что вы не создавали форму отчета и не добавляли в настройки отчета отбор по параметру формы Склад. Система сделает это сама при выполнении обработчика команды ОстаткиПоСкладу.

#### В прикладном решении
Запустите проект в режиме отладки и откройте документ Оказание услуги № ЦБ000000001.
Нажмите Остатки по складу. В результате будет вызван отчет Материалы. Форма отчета генерируется системой автоматически. Отчет будет выполнен сразу при открытии формы с отбором по складу Основной, указанному в форме документа (рис. 28.35).

Рис. 28.35. Отчет «Материалы» с отбором по складу, указанному в документе {https://ai2b.pro/wp-content/uploads/1/28_35.png}
Закройте отчет. Если в форме документа изменить склад на Розничный, а затем выполнить отчет, нажав Остатки по складу, то он будет сформирован с отбором по складу Розничный (в данном случае отчет будет пустой, так как у вас нет движений материалов по этому складу).
Таким образом, вы создали для пользователя очень удобную возможность – открывать отчет, показывающий остатки материалов по складу, прямо из формы документа с отбором по указанному в документе складу.

### Открытие формы списка с заданным отбором
В заключение рассмотрите распространенный случай, когда требуется открыть форму списка с некоторым заранее установленным отбором. На этом же примере будет показано различие между фиксированными (программными) пользовательскими настройками и настройками динамического списка, сделанными в 1С:EDT.
Предположим, из списка сотрудников вам нужно открыть список документов об оказании услуг, выполненных сотрудником, который выделен в форме списка.
Похожую задачу вы уже решали с помощью критерия отбора и механизма ввода на основании (см. раздел «Получение объектов, введенных на основании»). Теперь вы реализуете ее с помощью встроенного языка.
#### В 1C:EDT
Итак, вам нужно открыть форму списка документов Оказание услуги с отбором по мастеру, в котором поле Мастер будет равно ссылке на текущего сотрудника в списке сотрудников.
Для этого создайте форму списка справочника Сотрудники, затем создайте в ней команду ОказаниеУслуг и перетащите ее в командную панель формы. Создайте клиентский обработчик этой команды и заполните его следующим образом (листинг 28.7).
Листинг 28.7. Обработчик команды «ОказаниеУслуг»
&НаКлиенте
Процедура ОказаниеУслуг(Команда)
 
ПараметрыФормы = Новый Структура("Отбор", Новый Структура("Мастер", Элементы.Список.ТекущаяСтрока));
ОткрытьФорму("Документ.ОказаниеУслуги.ФормаСписка", ПараметрыФормы, , Истина);
 
КонецПроцедуры
Этот код очень похож на предыдущий (листинг 28.6), в котором открывалась форма отчета с отбором по значению параметризуемой команды. Только здесь в значение отбора для поля Мастер передается ссылка на текущий элемент списка сотрудников, которая содержится в свойстве ТекущаяСтрока таблицы формы Список, отображающей данные динамического списка. Затем этот отбор передается в параметры формы при открытии формы списка документов Оказание услуги.

####  В прикладном решении
Запустите проект в режиме отладки и откройте список сотрудников. В форме списка появилась кнопка Оказание услуг. При ее нажатии открывается список документов об оказании услуг, где мастером является текущий сотрудник (рис. 28.36).

Рис. 28.36. Отбор по мастеру в списке документов «Оказание услуги» {https://ai2b.pro/wp-content/uploads/1/28_36.png}
Однако не все так просто, как может показаться. Здесь есть одна тонкость, которую нужно знать и учитывать при создании настроек (в частности, отборов) динамических списков.
Как уже говорилось, динамический список построен на основе системы компоновки данных. Настройки списка при открытии формы помещаются в свойство динамического списка КомпоновщикНастроек.
Следует различать три вида настроек динамического списка:
Фиксированные настройки, сделанные программным путем, помещаются в свойство динамического списка КомпоновщикНастроек.ФиксированныеНастройки.
Настройки, сделанные в 1С:EDT, помещаются в свойство динамического списка КомпоновщикНастроек.Настройки.
Пользовательские настройки, сделанные в прикладном решении, помещаются в свойство динамического списка КомпоновщикНастроек.ПользовательскиеНастройки.
Пользовательские настройки загружаются из системного хранилища и накладываются на настройки, сделанные в 1С:EDT. В случае пересечения этих настроек пользовательские настройки имеют больший приоритет, то есть «затирают» настройки, сделанные в 1С:EDT.
Затем к полученным настройкам применяются фиксированные настройки. Но в случае пересечения этих настроек будет выдаваться ошибка. Например, при открытии формы списка с отбором (в вашем случае по полю Мастер) этот отбор помещается в фиксированные настройки. Поэтому пользователь уже не сможет установить отбор списка по тому же полю.
Таким образом, если пользователь должен иметь возможность создавать отбор по полю, участвующему в фиксированных настройках списка, нужно удалить отбор из коллекции фиксированных настроек (КомпоновщикНастроек.ФиксированныеНастройки.Отбор) и добавить этот отбор в коллекцию основных настроек списка (КомпоновщикНастроек.Настройки.Отбор).

#### В 1C:EDT
Чтобы решить поставленную задачу, откройте форму списка документа ОказаниеУслуги. Добавьте реквизиты формы ПрограммныйОтбор типа Булево и два реквизита произвольного типа: ПолеОтбора и ЗначениеОтбора. Эти реквизиты будут хранить информацию о программном отборе в форме списка.
Затем создайте обработчик события формы ПриСозданииНаСервере и заполните его следующим образом (листинг 28.8).
Листинг 28.8. Обработчик события формы «ПриСозданииНаСервере»
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
 
Если Параметры.Отбор.Свойство("Мастер") Тогда
ПрограммныйОтбор = Истина;
ПолеОтбора = Новый ПолеКомпоновкиДанных("Мастер");
Параметры.Отбор.Свойство("Мастер", ЗначениеОтбора);
 
КонецЕсли
 
КонецПроцедуры
При создании формы списка с помощью коллекции параметров формы вы проверяете, был ли установлен отбор по полю Мастер. Если такой отбор установлен, то вы устанавливаете признак того, что форма была открыта с программным отбором, реквизит ПолеОтбора устанавливаете как поле компоновки данных с именем Мастер, а в реквизит ЗначениеОтбора помещаете соответствующее значение отбора из коллекции параметров формы.
Далее создайте обработчик события формы ПриОткрытии и заполните его следующим образом (листинг 28.9).
Листинг 28.9. Обработчик события формы «ПриОткрытии»
&НаКлиенте
Процедура ПриОткрытии(Отказ)
 
Если ПрограммныйОтбор = Истина Тогда
ПрограммныеНастройки = Список.КомпоновщикНастроек.ФиксированныеНастройки;
Для Каждого ЭлементНастроек Из ПрограммныеНастройки.Отбор.Элементы Цикл
Если ЭлементНастроек.ЛевоеЗначение = ПолеОтбора Тогда
ПрограммныеНастройки.Отбор.Элементы.Удалить(ЭлементНастроек);
 
КонецЕсли;
 
КонецЦикла;
 
Настройки = Список.КомпоновщикНастроек.Настройки;
 
ЭлементОтбора = Настройки.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
ЭлементОтбора.ЛевоеЗначение  = ПолеОтбора;
ЭлементОтбора.ВидСравнения   = ВидСравненияКомпоновкиДанных.Равно;
ЭлементОтбора.ПравоеЗначение = ЗначениеОтбора;
 
Список.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
 
КонецЕсли;
 
КонецПроцедуры
Код обработчика выполняется в том случае, если форма была открыта с программным отбором.
Сначала обходится коллекция элементов отбора фиксированных настроек компоновщика настроек динамического списка. Если в коллекции присутствует элемент отбора, в котором ЛевоеЗначение равно значению реквизита ПолеОтбора (т. е. установлен программный отбор по полю Мастер), то этот элемент удаляется.
Затем этот же отбор добавляется в коллекцию настроек динамического списка КомпоновщикНастроек.Настройки.Отбор, и измененные настройки загружаются в компоновщик настроек.
Теперь осталось только удалить созданный элемент отбора при закрытии формы списка документа ОказаниеУслуги.
Для этого создайте обработчик события формы ПередЗакрытием и заполните его следующим образом (листинг 28.10).
Листинг 28.10. Обработчик события формы «ПередЗакрытием»
&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
 
Если ПрограммныйОтбор = Истина Тогда
Настройки = Список.КомпоновщикНастроек.Настройки;
Для Каждого ЭлементНастроек Из Настройки.Отбор.Элементы Цикл
Если ЭлементНастроек.ЛевоеЗначение = ПолеОтбора Тогда
Настройки.Отбор.Элементы.Удалить(ЭлементНастроек);
 
КонецЕсли;
 
КонецЦикла;
 
Список.КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
 
КонецЕсли;
 
КонецПроцедуры
Код обработчика выполняется в том случае, если форма была открыта с программным отбором.
Коллекция элементов отбора настроек компоновщика настроек динамического списка КомпоновщикНастроек.Настройки.Отбор обходится в цикле. Если в коллекции присутствует элемент отбора, в котором ЛевоеЗначение равно значению реквизита ПолеОтбора, то этот элемент удаляется. Затем измененные настройки загружаются в компоновщик настроек.

#### В прикладном решении
Запустите проект в режиме отладки, откройте список сотрудников и нажмите Оказание услуг. Откроется список документов об оказании услуг, где мастером является текущий сотрудник.
Вызовите окно настройки списка, нажав Еще – Настроить список… В открывшемся окне вы видите добавленный вами отбор по полю Мастер, который пользователь может изменить или очистить (рис. 28.37).

Рис. 28.37. Окно настройки списка с заданным отбором {https://ai2b.pro/wp-content/uploads/1/28_37.png}
При закрытии формы списка этот отбор удаляется.
Таким образом, вы изучили, как открыть форму списка с заданным отбором и как предоставить пользователю возможность редактировать этот отбор.

## Занятие 29 (2:00). Приемы редактирования форм
Продолжительность
Ориентировочная продолжительность занятия – 2 часа.
До сих пор при разработке своей конфигурации вы в основном пользовались формами, автоматически сконструированными конструктором формы для используемых вами объектов конфигурации или списков этих объектов. Иногда вы добавляли в эти формы кнопки для выполнения нужных вам команд, колонки в табличную часть и т. п.
На этом занятии будут обобщены полученные навыки и показаны примеры разработки формы с нуля с использованием только визуальных средств, а точнее – редактора формы.
ПРИМЕЧАНИЕ
Если вы читаете книгу не с начала и не знаете, как выполнить какое-то действие, загляните в «Список действий», который находится в конце книги.

### Редактор формы
Редактор формы вам уже хорошо знаком по предыдущим занятиям. В нем вы указываете, из каких элементов (полей, кнопок, таблиц и т. п.) будет состоять форма, какие реквизиты (данные), команды и параметры будут использоваться в ней. Затем вы устанавливаете связь между элементами и данными формы, а также задаете желаемые интерфейсные свойства элементов.
Таким образом, вы не «рисуете» форму, а создаете в редакторе ее описание. На основании этого описания платформа сама создаст форму с нужным наполнением и обеспечит либо ее стандартное поведение, либо то поведение, которое вы зададите в модуле формы с помощью встроенного языка.
Окно редактора формы состоит из нескольких взаимосвязанных областей (рис. 29.1).

Рис. 29.1. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_01.png}
В левой верхней части окна на закладке Элементы вы можете редактировать состав и порядок элементов формы, группировать их. Задавая различные интерфейсные свойства этих элементов, вы можете управлять внешним видом формы.
Форма представляет собой иерархическую структуру, в которой все элементы подчинены корневому элементу дерева Форма. Свойства формы в целом, состав ее стандартных команд, набор событий определяются типом основного реквизита, отображаемого в форме. Например, если основным реквизитом является документ, то в панели команд появляется стандартная команда Провести и закрыть, иначе – Записать и закрыть, и т. д.
Свойства вышестоящих элементов дерева формы определяют состав и значение свойств подчиненных элементов. Например, при добавлении кнопки в командную панель свойство Вид этой кнопки автоматически принимает значение Кнопка командной панели.
Влияние одинаковых свойств взаимозависящих элементов дерева друг на друга (например, Ширина) является обоюдным. Таким образом, свойства элементов нижнего уровня могут оказывать влияние на свойства элементов верхнего уровня иерархии, и наоборот.
Что касается расположения элементов в прикладном решении, то чем выше в дереве находится элемент, тем выше и левее он будет располагаться в форме приложения (рис. 29.2).

Рис. 29.2. Закладка «Элементы» редактора формы {https://ai2b.pro/wp-content/uploads/1/29_02.png}
В нижней части окна редактора, в окне предварительного просмотра, вы сразу же в процессе разработки видите, как будет выглядеть форма в интерфейсе приложения. Причем при выделении элемента в дереве элементов он сразу же выделяется в окне предварительного просмотра, и наоборот (рис. 29.1). Вы можете добавлять, удалять, изменять и перетаскивать элементы как в окне элементов, так и в окне предварительного просмотра.
В левой верхней части окна редактора на закладке Командный интерфейс вы можете управлять составом и расположением команд в панели навигации и в командной панели формы. Например, вы можете устанавливать видимость у команд открытия связанных списков, команд ввода на основании и т. п. (рис. 29.3).

Рис. 29.3. Закладка «Командный интерфейс» редактора формы {https://ai2b.pro/wp-content/uploads/1/29_03.png}
В правой верхней части окна редактора на закладке Реквизиты вы можете задавать состав реквизитов и устанавливать их свойства. Основной реквизит (у него установлен признак Основной реквизит) выделен жирным шрифтом и расположен первым в списке реквизитов. Он определяет функциональность формы (рис. 29.4).

Рис. 29.4. Закладка «Реквизиты» редактора формы {https://ai2b.pro/wp-content/uploads/1/29_04.png}
После того как вы связали реквизиты с элементами (в свойстве элементов Путь к данным), данные реквизитов начинают отображаться в форме. Когда вы перетаскиваете реквизит в окно элементов, 1C:EDT автоматически заполняет у элемента путь к данным. При этом она создает элемент того вида, который подходит для отображения данных реквизита. Поэтому вышеописанный способ (путем перетаскивания реквизитов) – самый простой и удобный способ конструирования формы. Вызвав контекстное меню элемента, по команде Перейти вы можете быстро перейти к реквизиту, который связан с этим элементом.
При удалении реквизита 1C:EDT удаляет из списка элементов те элементы, которые связаны с этим реквизитом. Соответствующие элементы сразу же удаляются и из окна предварительного просмотра.
В правой верхней части окна редактора на закладке Команды вы можете задать состав команд, используемых в форме. Это могут быть команды, созданные вами (закладка Команды формы), поставляемые формой и ее расширениями (закладка Стандартные команды), или это могут быть глобальные команды, созданные вами в конфигурации, которые могут отображаться в форме (закладка Глобальные команды), – рис. 29.5.

Рис. 29.5. Закладка «Команды» редактора формы {https://ai2b.pro/wp-content/uploads/1/29_05.png}
Команды, которые вы создаете, в свойстве Действие должны быть связаны с процедурой-обработчиком команды. Процедуру-обработчик команды вы пишете в модуле формы на встроенном языке (рис. 29.6).
Когда вы перетаскиваете команду в окно элементов, 1C:EDT создает в элемент (кнопку или гиперссылку) и связывает его с командой через свойство Команда. При нажатии на этот элемент будет выполняться процедура, указанная как обработчик команды. Из контекстного меню элемента по команде Перейти вы можете быстро перейти к команде формы, связанной с этим элементом.
При удалении команды 1C:EDT удаляет те элементы, которые связаны с этой командой. Соответствующие элементы сразу же удаляются и из окна предварительного просмотра.
В правой верхней части окна редактора на закладке Параметры вы можете задать состав параметров формы. С их помощью вы можете управлять функциональностью формы при ее открытии в прикладном решении.
Внизу окна редактора находится закладка Модуль. При ее нажатии открывается модуль формы, в котором описывается работа формы на встроенном языке. В модуле формы располагаются процедуры-обработчики команд, обработчики событий элементов, а также другие процедуры и функции (рис. 29.6).

Рис. 29.6. Модуль формы {https://ai2b.pro/wp-content/uploads/1/29_06.png}
Из контекстного меню элемента вы можете быстро перейти к процедуре-обработчику команды в модуле формы, связанной с этим элементом. Также с помощью подменю События вы можете быстро создать обработчик или перейти к обработчику события этого элемента.

### Разработка произвольной формы для редактирования документа «Оказание услуги»
#### В 1C:EDT
У вас в конфигурации уже существует основная форма документа ОказаниеУслуги. Эту форму вы создали еще на седьмом занятии в разделе «Форма» с помощью конструктора формы (рис. 29.7).

Рис. 29.7. Форма документа «ОказаниеУслуги» в редакторе формы {https://ai2b.pro/wp-content/uploads/1/29_07.png}
Как вы видите, все реквизиты документа и его табличная часть просто последовательно следуют друг за другом. Конечно, это не мешает пользователю вносить информацию в документ и редактировать ее в этой форме. Однако нельзя сказать, что работать с такой формой очень комфортно.
При взгляде на форму пользователь может потеряться среди обилия полей и колонок, так как информация в форме не структурирована. Кроме того, расположение всех элементов редактирования друг за другом делает форму довольно громоздкой, особенно при наличии большой табличной части.
Для того чтобы улучшить дизайн формы и удобство работы с ней, нужно сконцентрировать внимание пользователя на определенных группах информации, выделить наиболее важные из них, структурировать вводимые данные по смыслу и сделать форму более компактной.
Для решения этих задач вы разработаете форму для редактирования документа ОказаниеУслуги с нуля. Попутно вы освоите (или повторите) основные приемы разработки формы:
как добавить в форму основной реквизит;
как добавить элементы формы, связанные с данным реквизитом;
как объединить элементы формы в группы;
как задать свойства группы и сделать группу свертываемой;
как добавить в форму группу страниц;
как добавить в форму табличную часть и выделить ее строки по условию;
как вывести итог по колонке табличной части.
Итак, сначала создайте произвольную форму (тип формы Произвольная форма) документа ОказаниеУслуги с именем ФормаДляРедактирования (рис. 29.8).

Рис. 29.8. Создание произвольной формы документа {https://ai2b.pro/wp-content/uploads/1/29_08.png}
Нажмите Готово.
В открывшемся редакторе формы вы видите, что кроме командной панели со стандартным подменю Еще в форме больше ничего нет. Так и должно быть. Ведь форма – произвольная, и сейчас вы начнете наполнять ее данными и элементами по своему усмотрению.
На закладке Реквизиты добавьте реквизит формы с именем ДокументОбъект и типом ДокументОбъект.ОказаниеУслуги. И обязательно укажите, что реквизит будет основным, установив флажок Основной реквизит (рис. 29.9).

Рис. 29.9. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_09.png}
Сразу после установки основного реквизита формы в окне предварительного просмотра в командной панели формы появляются кнопки для выполнения стандартных действий с документами (Провести и закрыть, Записать, Провести и т. п.).
После установки основного реквизита формы вам становятся доступны для редактирования в форме данные объекта Документ ОказаниеУслуги. Нужно только связать эти данные с элементами формы, в которых они будут отображаться. Проще всего это сделать путем перетаскивания реквизитов в окно элементов формы. При этом связь элементов с отображаемыми данными будет установлена автоматически в свойстве элементов формы Путь к данным.
В окне реквизитов раскройте основной реквизит ДокументОбъект и последовательно перетащите в окно элементов формы реквизиты документа Номер, Дата, Склад, Клиент, Мастер. В форме будут созданы соответствующие поля ввода для отображения этих данных. Однако стандартно они размещаются друг под другом, как и в форме, созданной конструктором (рис. 29.10).

Рис. 29.10. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_10.png}
В соответствии с вашим планом по переделке стандартной формы разбейте информацию на смысловые группы.
Первым делом вам нужно, чтобы стандартные реквизиты документа Дата и Номер были объединены в отдельную группу, выделялись бы цветом фона и располагались бы не друг под другом, а горизонтально.
Для этого в окне элементов формы выделите поле Номер (над которым вы хотите расположить группу), нажмите Добавить и выберите группу типа Обычная группа без отображения. Вам нужно выбрать этот тип группы, а не Обычная группа, так как вам не нужно особым образом выделять группу (она будет выделена цветом фона) и давать ей заголовок (рис. 29.11).

Рис. 29.11. Добавление новой группы в форму {https://ai2b.pro/wp-content/uploads/1/29_11.png}
Оставьте без изменений стандартно установленное свойство группы Группировка в значение Горизонтальная если возможно, снимите флажок Разрешить изменение состава и задайте свойство Цвет фона (рис. 29.12).

Рис. 29.12. Свойства группы {https://ai2b.pro/wp-content/uploads/1/29_12.png}
Перетащите в эту группу поля Номер и Дата. В окне предварительного просмотра в нижней части редактора формы вы сразу же увидите результат сделанных изменений (рис. 29.13).

Рис. 29.13. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_13.png}
Таким образом, взгляд пользователя сразу будет падать на выделенную цветом группу, в которой горизонтально расположены номер и дата документа. А также вы запретили пользователю менять состав элементов этой группы в прикладном решении, сняв флажок Разрешить изменение состава. Кроме того, форма стала более компактной по высоте за счет расположения двух полей ввода на одной строке.
Теперь вам нужно добавить в форму более детальную информацию о клиенте, которому оказывались услуги. Например, это может быть адрес клиента, телефон, e-mail и т. п. Причем требуется сделать просмотр этих данных опциональным, чтобы блок с информацией можно было свернуть или развернуть по желанию пользователя. Опять же из соображений компактности нужно, чтобы группа с дополнительной информацией изначально была свернута.
Добавить в форму реквизиты ссылочного реквизита очень просто. Реквизит документа Клиент имеет тип ссылки на справочник Клиенты. Поэтому в окне редактора формы документа вы можете раскрыть реквизит Клиент и перетащить в форму необходимые вам реквизиты справочника Клиенты. Перетащите в окно элементов формы реквизит справочника Адрес. Путь к данным этого «реквизита реквизита» будет указан через точку – ДокументОбъект.Клиент.Адрес. Кроме того, поместите поле Склад последним в списке полей (рис. 29.14).

Рис. 29.14. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_14.png}
Затем добавьте над полем КлиентАдрес еще одну группу, свертываемую, для просмотра адреса (и другой дополнительной информации) клиента.
На этот раз выберите тип группы – Обычная группа.
Установите свойства группы:
Заголовок – Скрыть информацию о клиенте;
Поведение – Свертываемая;
Свернутый заголовок – Показать информацию о клиенте;
установите флажок Свернута;
Отображение – Нет (рис. 29.15).

Рис. 29.15. Свойства группы {https://ai2b.pro/wp-content/uploads/1/29_15.png}
Перетащите в эту группу поле КлиентАдрес. В окне предварительного просмотра формы вы видите результат сделанных изменений. Правда, здесь группа развернута и имеет заголовок «Скрыть информацию о клиенте», а при открытии формы в прикладном решении группа с дополнительной информацией будет свернута под заголовком «Показать информацию о клиенте», так как вы установили в свойствах группы флажок Свернута (рис. 29.16).

Рис. 29.16. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_16.png}
Таким образом, чтобы группа была свертываемой, нужно установить свойство Поведение этой группы в значение Свертываемая и, кроме того, указать либо заголовок (и/или заголовок в свернутом виде), либо картинку, в зависимости от значения свойства Отображение управления. Это свойство стандартно установлено в значение Гиперссылка заголовка.
В результате в прикладном решении пользователь по своему желанию может отобразить или скрыть дополнительную информацию о клиенте, нажимая на заголовок группы.
Теперь объедините в одну группу поле Склад и команду для открытия отчета Материалы с отбором по складу, указанному в данном поле. Эту команду вы создали на предыдущем занятии в разделе «Использование параметризуемых команд». Кажется, что это будет вполне логичным и удобным.
Для этого над полем Склад добавьте еще одну группу типа Обычная группа без отображения. Затем перетащите в эту группу поле Склад и глобальную параметризуемую команду ОстаткиПоСкладу. Посмотрите на результат сделанных изменений в окне предварительного просмотра формы (рис. 29.17).

Рис. 29.17. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_17.png}
На этом этапе проверьте результат работы в прикладном решении. Сначала установите вашу произвольную форму в качестве основной формы документа ОказаниеУслуги. Для этого в свойстве документа Основная форма объекта выберите созданную вами форму с именем ФормаДляРедактирования (рис. 29.18).

Рис. 29.18. Установка основной формы документа {https://ai2b.pro/wp-content/uploads/1/29_18.png}

#### В прикладном решении
Запустите проект в режиме отладки и откройте любой из документов Оказание услуги. Внешний вид формы документа в точности соответствует тому, что вы хотели (рис. 29.19).

Рис. 29.19. Форма документа в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_19.png}
Однако вы видите не всю информацию: здесь не отображена табличная часть документа. Поэтому вам нужно доработать форму документа – поместить в нее табличную часть, а также немного усовершенствовать ее внешний вид.

#### В 1C:EDT
Прежде чем добавить в форму табличную часть, с помощью группы страниц разделите форму на две большие части. Добавьте в форму группу с двумя страницами, на одной из которых будут располагаться основные реквизиты документа (Номер, Дата, Клиент и т. п.), а на другой – таблица со списком оказанных услуг.
Для этого в окне элементов формы добавьте группу типа Страницы (рис. 29.20).

Рис. 29.20. Добавление в форму группы страниц {https://ai2b.pro/wp-content/uploads/1/29_20.png}
Задайте имя этой группы – Панель. Затем добавьте в эту группу (причем группа Панель должна быть выделена в дереве элементов формы) еще одну группу типа Страница (рис. 29.21).

Рис. 29.21. Добавление страницы в группу страниц {https://ai2b.pro/wp-content/uploads/1/29_21.png}
Дайте ей имя ОсновнаяИнформация и заголовок Основная информация.
Затем снова выделите группу Панель и аналогичным образом добавьте в группу страниц еще одну страницу с именем СписокУслуг и заголовком Список услуг.
Теперь мышью перетащите в группу ОсновнаяИнформация все ранее созданные вами элементы формы (Группа1, Клиент, Группа2, Мастер, Группа3). Окно редактора формы примет следующий вид (рис. 29.22).

Рис. 29.22. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_22.png}
Однако в окне предварительного просмотра формы в панели страниц вы не видите пока страницы Список услуг. Так происходит потому, что вы еще не добавили в эту группу ни одного элемента.
В окне реквизитов формы раскройте реквизит ДокументОбъект и перетащите табличную часть ПереченьНоменклатуры в окно элементов формы, в группу СписокУслуг. Подтвердите, что вы хотите добавить в форму все колонки табличной части. В панели страниц сразу же появится страница Список услуг, содержащая таблицу с данными табличной части (рис. 29.23).

Рис. 29.23. Окно редактора формы {https://ai2b.pro/wp-content/uploads/1/29_23.png}
Немного усовершенствуйте внешний вид таблицы. Прежде всего, удалите несущественную для вас колонку НаборСвойств.
Теперь задайте условное оформление строк таблицы. Например, вы хотите выделить строки таблицы, в которых сумма услуг превышает 300 руб.
Для этого воспользуйтесь свойством Условное оформление формы. Выделите корень дерева элементов формы Форма и в панели Свойства нажмите гиперссылку Открыть в строке Условное оформление (рис. 29.24).

Рис. 29.24. Палитра свойств формы {https://ai2b.pro/wp-content/uploads/1/29_24.png}
Добавьте новый элемент условного оформления.
Сначала в поле Оформление установите голубой цвет текста.
Затем в поле Условие укажите условие, при наступлении которого будет применяться оформление, то есть когда строки в таблице будут выделены голубым фоном.
Перетащите поле Сумма табличной части документа из списка доступных полей в список условий отбора. В графе Вид сравнения выберите значение Больше, а в графе Правое значение выберите 300.
Затем укажите список оформляемых полей. Нажмите кнопку выбора в поле Оформляемые поля, затем нажмите Добавить и, так как вы хотите выделить сразу всю строку таблицы, выберите из списка элементов формы таблицу ПереченьНоменклатуры целиком (рис. 29.25).

Рис. 29.25. Окно настройки условного оформления формы {https://ai2b.pro/wp-content/uploads/1/29_25.png}
Нажмите ОК.
Подобным образом можно оформить по условию любой другой элемент формы – поле, группу и т. п.
Проверьте результат работы в прикладном решении.

#### В прикладном решении
Запустите проект в режиме отладки и откройте любой из документов Оказание услуги. Все выглядит так, как вы и хотели.
На первой странице, на закладке Основная информация, вы видите основную информацию документа, в которой вы можете открыть дополнительную информацию о клиенте или сформировать отчет об остатках материалов на складе, указанном в документе. Номер и дата документа объединены в горизонтальную группу, выделенную цветом (рис. 29.26).

Рис. 29.26. Форма документа в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_26.png}
Переключившись в панели закладок на страницу Оказание услуг, вы видите табличную часть документа, в которой строки с суммой выше 300 выделены голубым цветом (рис. 29.27).

Рис. 29.27. Форма документа в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_27.png}
Пожалуй, не хватает только итоговой строки в таблице с общей суммой услуг. И хотелось бы также видеть эту сумму на странице с основной информацией документа. Выполните эту доработку в 1С:EDT.

#### В 1C:EDT
В свойствах таблицы формы ПереченьНоменклатуры установите флажок Подвал (рис. 29.28).

Рис. 29.28. Свойства таблицы формы {https://ai2b.pro/wp-content/uploads/1/29_28.png}
Затем для поля таблицы ПереченьНоменклатурыСумма в свойстве Путь к данным подвала выберите из списка реквизитов ДокументОбъект.ПереченьНоменклатуры.ИтогСумма (рис. 29.29).

Рис. 29.29. Свойства поля таблицы {https://ai2b.pro/wp-content/uploads/1/29_29.png}
Таким образом, итог по колонке Сумма будет отражаться в подвале таблицы.
Теперь отобразите эту итоговую сумму на странице с основной информацией документа. Для этого перетащите реквизит табличной части ИтогСумма в группу ОсновнаяИнформация (рис. 29.30).

Рис. 29.30. Редактор формы документа {https://ai2b.pro/wp-content/uploads/1/29_30.png}
А также установите в свойствах этого поля формы свойства Шрифт и ШрифтЗаголовка в значение Крупный шрифт текста (рис. 29.31).

Рис. 29.31. Свойства поля формы {https://ai2b.pro/wp-content/uploads/1/29_31.png}

#### В прикладном решении
Запустите проект в режиме отладки и откройте любой из документов Оказание услуги. Теперь на странице с основной информацией вы видите общую сумму документа, выделенную крупным шрифтом (рис. 29.32).

Рис. 29.32. Форма документа в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_32.png}
А в табличной части присутствует итоговая строка с общей суммой услуг (рис. 29.33).

Рис. 29.33. Форма документа в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_33.png}
Вроде бы это все, что вы хотели доработать в форме документа. Теперь она выглядит более компактной, законченной, более эстетичной. Скорее всего, работать с такой формой пользователю будет удобнее и комфортнее.
Конечно, в этом вопросе прежде всего нужно руководствоваться пожеланиями заказчика, мнением пользователей, а затем уже своим личным вкусом.
В любом случае, на данном примере было показано только несколько распространенных приемов, которые помогут улучшить дизайн и удобство работы с формой.
Ниже будут продемонстрированы еще несколько небольших примеров редактирования форм.

### Как добавить в форму переключатель – тумблер
В форме редактирования элемента номенклатуры, сгенерированной автоматически, вы заполняете поле ВидНоменклатуры. Значениями этого поля являются элементы перечисления ВидыНоменклатуры – Материал или Услуга. Стандартно это поле отображается в виде обычного поля ввода, выбор значений которого осуществляется в выпадающем списке.
Когда элементов перечисления немного (2–3 значения), можно представить это поле в виде переключателя. Переключатель может иметь вид или обычного переключателя, или тумблера. Второй вариант кажется более современным и стильным.
#### В 1C:EDT
Чтобы выполнить это изменение, сначала создайте форму элемента для справочника Номенклатура.
Затем для поля ВидНоменклатуры установите свойство Вид в значение Поле переключателя, Вид переключателя в значение Тумблер, а для свойства Список выбора задайте список значений, состоящий из элементов перечисления ВидыНоменклатуры (рис. 29.34).

Рис. 29.34. Свойства поля переключателя {https://ai2b.pro/wp-content/uploads/1/29_34.png}
Попутно сделайте еще одно небольшое изменение. В элементе формы Родитель в прикладном решении можно изменить группу номенклатуры, к которой принадлежит конкретный элемент справочника. Например, при переносе элемента номенклатуры в корень справочника это поле требуется очистить.
Однако кнопка очистки  стандартно не отображается у поля ввода. Очистить поле можно и без этой кнопки (мышью, клавишей Delete), но некоторые пользователи чувствуют себя без нее как без рук. Чтобы принудительно отобразить кнопку очистки у поля Родитель, установите свойство Кнопка очистки в значение Да (рис. 29.35).

Рис. 29.35. Свойства поля ввода «Родитель» {https://ai2b.pro/wp-content/uploads/1/29_35.png}
Заметьте, что у полей ввода есть еще ряд кнопок (кнопка открытия, кнопка создания и т. п.), необходимость отображения которых автоматически определяется платформой. Видимость этих кнопок также можно задать явно.
Результат ваших изменений в окне редактора формы будет выглядеть следующим образом (рис. 29.36).

Рис. 29.36. Вид формы в редакторе формы элемента справочника {https://ai2b.pro/wp-content/uploads/1/29_36.png}

#### В прикладном решении
Запустите проект в режиме отладки и откройте любой из элементов справочника Номенклатура. Теперь для выбора вида номенклатуры достаточно щелкнуть переключателем в виде тумблера. При этом выбранное значение выделено зеленым цветом. А также у поля Группа материалов/услуг присутствует кнопка очистки (рис. 29.37).

Рис. 29.37. Форма элемента справочника «Номенклатура» в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_37.png}

### Как сгруппировать данные в списке
Часто для большей наглядности и структурированности требуется сгруппировать информацию в списках по значению одного или нескольких полей. Например, список документов Оказание услуги нужно сгруппировать по клиентам, которым оказывались услуги. Сделать это можно и в 1С:EDT, и в прикладном решении (Еще – Настроить список…).
Здесь, так же как и для отчетов, действует следующий принцип: если настройка списка необходима всем пользователям, то выполнять ее нужно в 1С:EDT; настройка списка, выполненная в прикладном решении, принадлежит только тому пользователю, который эту настройку произвел.
#### В 1C:EDT
Выполните настройку группировки списка документов ОказаниеУслуги для всех пользователей.
Откройте форму списка этого объекта конфигурации и вызовите настройку списка основного реквизита формы Список.
В окне настройки динамического списка на закладке Группировка перенесите из списка доступных полей в список полей группировки поле Клиент (рис. 29.38).

Рис. 29.38. Настройка группировки динамического списка {https://ai2b.pro/wp-content/uploads/1/29_38.png}
Стандартно эта настройка будет добавлена в список обычных пользовательских настроек в прикладном решении, то есть будет доступна по команде Еще – Настроить список…

#### В прикладном решении
Запустите проект в режиме отладки и откройте список документов Оказание услуги. Список документов сгруппирован по клиентам, которым оказывались услуги (рис. 29.39). Эту настройку можно изменить, сохранить или удалить из подменю Еще.

Рис. 29.39. Список документов «Оказание услуги» в прикладном решении {https://ai2b.pro/wp-content/uploads/1/29_39.png}
ПРИМЕЧАНИЕ
Вы можете сравнить свое прикладное решение с эталонным приложением Занятие 29. Как это сделать, описано в разделе «Эталонные проекты».
## Эталонные проекты
Эталонные проекты и информационные базы можно скачать по адресу https://its.1c.ru/bmk/dg8edt.
Вы можете загрузить в 1C:EDT только эталонный проект, чтобы сравнить его со своим проектом. Или же вы можете подключить к эталонному проекту его информационную базу, чтобы полностью сравнить работу эталонного приложения с тем приложением, которое разработали вы.
### Как подключить эталонный проект
Допустим, вы хотите подключить эталонный проект после выполнения 6-го занятия. Для этого вам понадобится файл Проект-занятие-06.zip из каталога Проекты и базы. Извлеките этот файл из архива.
Эталонный проект вы поместите в ту же рабочую область, в которой разрабатываете собственный проект.
Сначала создайте новый проект. Для этого в панели Навигатор нажмите Новый > Проект … > Общие > Проект в контекстном меню панели (рис. 32.1).

Рис. 32.1. Новый проект {https://ai2b.pro/wp-content/uploads/1/32_001.png}
Задайте имя проекта, например Проверка06, и нажмите Готово (рис. 32.2).

Рис. 32.2. Имя нового проекта {https://ai2b.pro/wp-content/uploads/1/32_002.png}
Новый проект появится в панели Навигатор (рис. 32.3). Если он не появился, нажмите F5, чтобы обновить содержимое панели.

Рис. 32.3. Новый проект в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/32_0013.png}
Теперь в этот проект нужно импортировать содержимое эталонного проекта. Для этого нажмите Импорт … > Общие > Файл архива в контекстном меню нового проекта (рис. 32.4).

Рис. 32.4. Импорт из файла архива {https://ai2b.pro/wp-content/uploads/1/32_004.png}
Задайте параметры импорта:
В поле Исходный архив выберите файл эталонного проекта Проект-занятие-06.zip.
Снимите флажок с корня иерархии архива и установите флажки у всех вложенных папок архива и у файла .project, который находится в корне архива.
В поле В папку выберите каталог нового проекта.
Установите флажок Заменять существующие ресурсы без предупреждения.
Нажмите Готово (рис. 32.5).

Рис. 32.5. Параметры импорта {https://ai2b.pro/wp-content/uploads/1/32_005.png}
Через некоторое время эталонный проект появится в панели Навигатор (рис. 32.6).

Рис. 32.6. Эталонный проект в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/32_006.png}

### Как сравнить два проекта
Чтобы сравнить два проекта, выделите эталонный проект, а затем, удерживая клавишу Ctrl, выделите собственный проект. После этого нажмите Сравнить/Объединить в контекстном меню проекта (рис. 32.7).

Рис. 32.7. Выбор проектов для сравнения {https://ai2b.pro/wp-content/uploads/1/32_007.png}
В диалоге настройки сравнения/объединения ничего не меняйте и нажмите Сравнить (рис. 32.8).

Рис. 32.8. Параметры сравнения {https://ai2b.pro/wp-content/uploads/1/32_008.png}
1C:EDT откроет редактор сравнения/объединения конфигураций, в котором вы увидите различия двух проектов. Например, что в вашем проекте допущена опечатка в имени реквизита табличной части документа ОказаниеУслуги (рис. 32.9).

Рис. 32.9. Редактор сравнения/объединения {https://ai2b.pro/wp-content/uploads/1/32_009.png}
После того как вы нашли ошибку, редактор можно закрыть, нажав на крестик во вкладке.

### Подключение эталонной информационной базы
Если вы хотите сравнить не только содержимое проекта, разрабатываемого в 1C:EDT, но и работу приложения в режиме «1С:Предприятие», то вам понадобятся эталонные данные, которые находятся в базе, соответствующей эталонному проекту.
Например, если вы подключили проект Проект-занятие-06.zip, то для него понадобится файл База-занятие-06.dt. Извлеките этот файл из архива.
Сначала вы добавите новую информационную базу, загрузите в нее эти данные. А затем создадите конфигурацию запуска, в которой подключите эту базу к эталонному проекту.
Чтобы добавить новую информационную базу, откройте панель Информационные базы (стандартно она свернута на правой стороне экрана) и нажмите Добавить… в контекстном меню (рис. 32.10).

Рис. 32.10. Добавить новую информационную базу {https://ai2b.pro/wp-content/uploads/1/32_010.png}
Создайте новую информационную базу так, как вы создавали ее в начале книги (см. рис. 1.25). Чтобы не запутаться, назовите ее Проверка06.
1C:EDT создаст базу и откроет панель Приложения. Не нажимайте ссылку в этой панели.
Вернитесь обратно в панель Информационные базы и нажмите Загрузить информационную базу… в контекстном меню добавленной новой базы (рис. 32.11).

Рис. 32.11. Загрузить информационную базу {https://ai2b.pro/wp-content/uploads/1/32_011.png}
Выберите файл База-занятие-06.dt и нажмите Готово (рис. 32.12). Информационная база будет загружена.

Рис. 32.12. Загрузка информационной базы {https://ai2b.pro/wp-content/uploads/1/32_012.png}
Теперь осталось создать конфигурацию запуска. В панели Навигатор выделите проект Проверка06 и нажмите F11.
1C:EDT спросит вас о том, какое клиентское приложение вы хотите запускать. Выберите Тонкий клиент и нажмите ОК (рис. 32.13).

Рис. 32.13. Выбор клиентского приложения {https://ai2b.pro/wp-content/uploads/1/32_013.png}
Затем 1C:EDT попросит вас выбрать информационную базу. Выберите базу Проверка06 (рис. 32.14)

Рис. 32.14. Выбор информационной базы {https://ai2b.pro/wp-content/uploads/1/32_014.png}
После этого вы можете нажать Готово – и приложение будет запущено.
Это справедливо для всех эталонных информационных баз, кроме базы База-занятие-29.dt. В этой информационной базе, в отличие от остальных, существуют пользователи. Поэтому, прежде чем нажимать Готово, задайте параметры доступа к этой базе.
Для этого нажмите на «шестеренку» (см. рис. 32.14). 1C:EDT откроет диалог доступа к базе (рис. 32.15).

Рис. 32.15. Доступ к информационной базе {https://ai2b.pro/wp-content/uploads/1/32_015.png}
В поле Тип доступа выберите Infobase. В поле Имя пользователя введите Администратор и нажмите ОК.
После этого можете нажать Готово в предыдущем диалоге (см. рис. 32.14).

## Краткий справочник разработчика

### Прикладные типы
Для обеспечения доступа к данным, хранящимся в базе данных, встроенный язык содержит набор прикладных типов. Их можно разделить на несколько групп в зависимости от их назначения.
Менеджеры класса объектов конфигурации. Это такие типы, как:
СправочникиМенеджер,
ДокументыМенеджер,
ОтчетыМенеджер,
ПланыСчетовМенеджер и т. д.
Каждый из них содержит менеджеры всех объектов конфигурации этого класса.
Например, менеджер справочников – СправочникиМенеджер – это коллекция значений, содержащая объекты СправочникМенеджер.<имя>.
Каждый из менеджеров класса предназначен для доступа к отдельным менеджерам объектов конфигурации данного класса. Подробнее об этом рассказывается в разделе «Менеджеры объектов конфигурации».
Менеджеры объектов конфигурации. Это такие типы, как:
СправочникМенеджер.Клиенты,
СправочникМенеджер.Номенклатура,
ДокументМенеджер.ПриходнаяНакладная,
ДокументМенеджер.ОказаниеУслуги и т. д.
Каждый из этих типов предоставляет средства для работы с данными конкретного объекта конфигурации. Например, менеджер документа ПриходнаяНакладная – ДокументМенеджер.ПриходнаяНакладная – позволяет находить конкретные документы Приходная накладная, создавать объекты этих документов и т. д. Подробнее об этом рассказывается в разделе «Менеджеры объектов конфигурации».
Объекты – это такие типы, как:
СправочникОбъект.Клиенты,
СправочникОбъект.Номенклатура,
ДокументОбъект.ПриходнаяНакладная,
ДокументОбъект.ОказаниеУслуги и т. д.
С помощью этих типов вы можете читать, изменять, записывать и удалять данные в базе данных. Они предоставляют вам доступ к объекту базы данных. Эти типы существуют для тех объектов конфигурации, которые описывают объектные данные (справочники – СправочникОбъект.<имя>, документы – ДокументОбъект.<имя> и т. д.). Подробнее об этом рассказывается в разделе «Объектные данные».
Наборы записей – это такие типы, как:
РегистрСведенийНаборЗаписей.Цены,
РегистрНакопленияНаборЗаписей.ОстаткиМатериалов,
РегистрБухгалтерииНаборЗаписей.Управленческий и т. д.
С помощью этих типов вы также можете читать, изменять, записывать и удалять данные в базе. Эти типы существуют для тех объектов конфигурации, которые описывают необъектные данные (регистры – РегистрНакопленияНаборЗаписей.<имя>, перерасчеты – ПерерасчетНаборЗаписей.<имя> и т. д.). Подробнее об этом рассказывается в разделе «Объектные данные».
Ссылки – это такие типы, как:
СправочникСсылка.Клиенты,
СправочникСсылка.Номенклатура,
ДокументСсылка.ПриходнаяНакладная,
ДокументСсылка.ОказаниеУслуги и т. д.
Эти типы служат для указания на объект базы данных и кроме этого предоставляют некоторую информацию об этом объекте (например, документ – ДокументСсылка.<имя>).
Выборки – это такие типы, как:
СправочникВыборка.Клиенты,
ДокументВыборка.ПриходнаяНакладная,
РегистрСведенийВыборка.Цены,
РегистрНакопленияВыборка.ОстаткиМатериалов и т. д.
Каждый из этих типов описывает набор данных некоторого объекта конфигурации, отобранных по определенному критерию. Для обхода выборки используйте метод Следующий(). Считывание данных из базы происходит динамически, по мере продвижения по выборке. От выборки вы можете получить ссылку на объект базы данных с помощью свойства Ссылка. Также от выборки можно получить объект методом ПолучитьОбъект().

### Изменение данных
Несмотря на большое разнообразие типов встроенного языка, предназначенных для работы с данными, хранящимися в базе, лишь некоторые из них позволяют вам изменять эти данные. Такие типы будем называть манипулирующими типами.
Каждый такой тип имеет в конфигурации соответствующий модуль. Он называется либо модулем объекта, либо модулем набора записей, в зависимости от принадлежности к тому или иному объекту конфигурации. Для констант этот модуль называется модулем менеджера значений.
Так вот, каждый такой модуль будет выполняться, когда вы создаете объект соответствующего манипулирующего типа. Кроме того, он будет всегда выполняться и при интерактивном обращении пользователя к самой структуре данных, поскольку при таком обращении платформа «1С:Предприятие» будет сама создавать объект манипулирующего типа. Например, при открытии формы элемента справочника платформа будет создавать объект СправочникОбъект.<имя>.
В перечисленных модулях кроме всего прочего вы можете написать процедуры с ключевым словом Экспорт, что подразумевает вызов этих процедур как методов соответствующего объекта манипулирующего типа.
Например, если для справочника Клиенты вы напишете в модуле объекта процедуру (листинг 30.1), то в дальнейшем сможете вызывать ее как метод объекта СправочникОбъект.Клиенты (листинг 30.2).
Листинг 30.1. Процедура «Проверка()» в модуле справочника
Процедура Проверка() Экспорт
…
КонецПроцедуры;
Листинг 30.2. Вызов процедуры как метода объекта «Справочник»
Клиент = Справочники.Клиенты.НайтиПоКоду(1).ПолучитьОбъект();
Клиент.Проверка();
Однако следующий код будет приводить к ошибке, так как объект СправочникСсылка.Клиенты не имеет метода Проверка (листинг 30.3).
Листинг 30.3. Вызов процедуры «Проверка» приведет к ошибке
Клиент = Справочники.Клиенты.НайтиПоКоду(1);
Клиент.Проверка();
В следующей таблице представлен перечень манипулирующих типов. Как всегда, не бывает правил без исключений, и существуют два таких исключения.
Таблица 30.1. Работа с данными объектов
Во-первых, для констант указаны три манипулирующих типа: КонстантаМенеджерЗначения.<имя>, КонстантаМенеджер.<имя> и КонстантыНабор. На самом деле манипулирование данными константы осуществляется при помощи типа КонстантаМенеджерЗначения.<имя>.
Два других типа – КонстантаМенеджер.<имя> и КонстантыНабор – также позволяют изменять значения констант, хранящиеся в базе данных, однако при выполнении своих методов Установить() и Записать() они вызывают создание объекта КонстантаМенеджерЗначения.<имя>, который и выполняет непосредственное изменение данных.
При выполнении метода Установить() объекта КонстантаМенеджер.<имя> будут вызваны модуль менеджера значения и обработчики событий ПриЗаписи() и ПередЗаписью() для изменяемой константы. При выполнении метода Записать() объекта КонстантыНабор модуль менеджера значения и соответствующие обработчики будут вызваны для каждой константы, входящей в набор.
Во-вторых, для регистра сведений указаны два манипулирующих типа. В чистом виде манипулирование данными регистра сведений осуществляется при помощи типа РегистрСведенийНаборЗаписей.<имя>.
Однако существует возможность манипулирования записями регистра сведений и при помощи типа РегистрСведенийМенеджерЗаписи.<имя>. Но тип РегистрСведенийМенеджерЗаписи.<имя> работает с данными регистра не напрямую, а через объект РегистрСведенийНаборЗаписей.<имя>. Таким образом, модуль набора записей, а также обработчики событий ПередЗаписью() и ПриЗаписи() набора записей будут отрабатывать и при использовании объекта РегистрСведенийМенеджерЗаписи.<имя>. Однако процедуры и функции, описанные в модуле набора записей с ключевым словом Экспорт, не будут доступны как методы объекта РегистрСведенийМенеджерЗаписи.<имя>.

### Константы
#### Типы для работы с константами
На следующей схеме изображено взаимодействие типов для работы с константами (рис. 30.1).

Рис. 30.1. Типы встроенного языка для работы с константами {https://ai2b.pro/wp-content/uploads/1/30_01.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
КонстантыНабор – позволяет читать и записывать сразу группу констант, в частном случае – все константы. Также используется в форме констант для хранения, записи и считывания констант.
КонстантаМенеджерЗначения.<имя> – используется для доступа к константе. Любая запись константы (интерактивно в форме, объекты КонстантыНабор и КонстантаМенеджер.<имя>) создает объект этого типа и производит запись с его помощью, что обеспечивает вызов модуля и обработчиков событий этого объекта.

#### Последовательность событий при записи констант из формы констант (записать и закрыть)

Рис. 30.2. Последовательность событий при записи констант из формы констант {https://ai2b.pro/wp-content/uploads/1/30_02.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.
Работа с формой констант осуществляется при помощи типа КонстантыНабор, который, в свою очередь, использует тип КонстантаМенеджерЗначения.<имя>.
Особенности внутренней реализации типа КонстантыНабор таковы, что при записи набора констант обработчики события ОбработкаПроверкиЗаполнения(), ПередЗаписью() и ПриЗаписи() модуля менеджера значения константы будут вызваны для каждой константы, входящей в записываемый набор.

### Справочники
#### Типы для работы со справочниками
На следующей схеме изображено взаимодействие типов для работы со справочниками (рис. 30.3).

Рис. 30.3. Типы для работы со справочниками {https://ai2b.pro/wp-content/uploads/1/30_03.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».

#### Последовательность событий при записи элемента справочника из формы элемента (записать и закрыть)

Рис. 30.4. Последовательность событий при записи элемента справочника из формы элемента {https://ai2b.pro/wp-content/uploads/1/30_04.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Документы
#### Типы для работы с документами
На следующей схеме изображено взаимодействие типов для работы с документами (рис. 30.5).

Рис. 30.5. Типы для работы с документами {https://ai2b.pro/wp-content/uploads/1/30_05.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».

#### Последовательность событий при записи документа из формы документа

Рис. 30.6. Последовательность событий при записи нового документа из формы документа {https://ai2b.pro/wp-content/uploads/1/30_06.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

#### Последовательность событий при проведении документа из формы документа (провести и закрыть)

Рис. 30.7. Последовательность событий при проведении документа из формы документа {https://ai2b.pro/wp-content/uploads/1/30_07.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

#### Последовательность событий при отмене проведения документа из формы документа

Рис. 30.8. Последовательность событий при отмене проведения документа из формы документа {https://ai2b.pro/wp-content/uploads/1/30_08.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Перечисления
#### Типы для работы с перечислениями
На следующей схеме изображено взаимодействие типов для работы с перечислениями (рис. 30.9).

Рис. 30.9. Типы для работы с перечислениями {https://ai2b.pro/wp-content/uploads/1/30_09.png}
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».

### Планы видов характеристик
#### Типы для работы с планами видов характеристик
На следующей схеме изображено взаимодействие типов для работы с планами видов характеристик (рис. 30.10).

Рис. 30.10. Типы для работы с планами видов характеристик {https://ai2b.pro/wp-content/uploads/1/30_10.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные виды объектов встроенного языка можно прочитать в главе «Объекты встроенного языка для работы с прикладными данными».
Свойства и методы взаимодействия перечисленных типов в большинстве своем аналогичны свойствам и методам типов, предназначенных для работы со справочниками.
#### Последовательность событий при записи вида характеристики из формы элемента (записать и закрыть)

Рис. 30.11. Последовательность событий при записи вида характеристики из формы элемента {https://ai2b.pro/wp-content/uploads/1/30_11.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Планы счетов
#### Типы для работы с планами счетов
На следующей схеме изображено взаимодействие типов для работы с планами счетов (рис. 30.12).

Рис. 30.12. Типы для работы с планами счетов {https://ai2b.pro/wp-content/uploads/1/30_12.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
ПланСчетовВидыСубконто.<имя>. Используется для доступа к методам специальной табличной части счета ВидыСубконто в целом.
ПланСчетовВидыСубконтоСтрока.<имя>. Строка специальной табличной части счета ВидыСубконто.
Свойства и методы взаимодействия перечисленных типов в большинстве своем аналогичны свойствам и методам типов, предназначенных для работы со справочниками.
#### Последовательность событий при записи счета из формы счета (записать и закрыть)

Рис. 30.13. Последовательность событий при записи счета из формы счета {https://ai2b.pro/wp-content/uploads/1/30_13.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.


### Планы видов расчета
#### Типы для работы с планами видов расчета
На следующей схеме изображено взаимодействие типов для работы с планами видов расчета (рис. 30.14).

Рис. 30.14. Типы для работы с планами видов расчета {https://ai2b.pro/wp-content/uploads/1/30_14.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
ВытесняющиеВидыРасчета.<имя>. Предопределенная табличная часть вида расчета – список вытесняющих видов расчета. Такая табличная часть определена только для планов видов расчета с признаком ИспользуетПериодДействия. Имеет единственную колонку – ВидРасчета типа ПланВидовРасчетаСсылка.<имя>.
ВытесняющиеВидыРасчетаСтрока.<имя>. Строка предопределенной таблицы вытесняющих видов расчета.
ВедущиеВидыРасчета.<имя>. Предопределенная табличная часть вида расчета – список ведущих видов расчета. Имеет единственную колонку – ВидРасчета типа ПланВидовРасчетаСсылка.<имя>.
ВедущиеВидыРасчетаСтрока.<имя>. Строка предопределенной таблицы ведущих видов расчета.
БазовыеВидыРасчета.<имя>. Предопределенная табличная часть вида расчета – список ведущих видов расчета. Такая табличная часть (свойство БазовыеВидыРасчета) определена только для планов видов расчета со свойством ЗависимостьОтБазы, не равным значению Не зависит. Имеет единственную колонку – Вид Расчета типа ПланВидовРасчетаСсылка.<имя>.
БазовыеВидыРасчетаСтрока.<имя>. Строка предопределенной таблицы базовых видов расчета.
Свойства и методы взаимодействия перечисленных типов в большинстве своем аналогичны свойствам и методам типов, предназначенным для работы со справочниками.
#### Последовательность событий при записи вида расчета из формы вида расчета (записать и закрыть)

Рис. 30.15. Последовательность событий при записи вида расчета из формы вида расчета {https://ai2b.pro/wp-content/uploads/1/30_15.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Регистры сведений
#### Типы для работы с регистрами сведений
На следующей схеме изображено взаимодействие типов для работы с регистрами сведений (рис. 30.16).

Рис. 30.16. Типы для работы с регистрами сведений {https://ai2b.pro/wp-content/uploads/1/30_16.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
РегистрСведенийМенеджерЗаписи.<имя>. Позволяет читать, записывать и удалять отдельную запись регистра сведений. Используется только для регистров сведений, не изменяемых регистраторами, т. е. для которых в 1C:EDT установлен режим записи Независимый.
РегистрСведенийЗапись.<имя>. Предоставляет доступ к записи регистра сведений. Объект этого типа не создается непосредственно, а предоставляется другими объектами, связанными с регистром сведений. Например, данный объект представляет записи регистра в наборе записей.
РегистрСведенийКлючЗаписи.<имя>. Представляет собой набор значений, однозначно идентифицирующих запись регистра. Тип используется в тех случаях, когда необходимо сослаться на определенную запись. Например, объект этого типа выступает в качестве значения свойства ТекущаяСтрока табличного поля, отображающего список записей регистра.
#### Последовательность событий при сохранении данных из формы записи регистра сведений (записать и закрыть)

Рис. 30.17. Последовательность событий при сохранении данных из формы записи регистра сведений {https://ai2b.pro/wp-content/uploads/1/30_17.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.
Работа с формой записи регистра сведений осуществляется при помощи типа РегистрСведенийМенеджерЗаписи.<имя>, который, в свою очередь, использует тип РегистрСведенийНаборЗаписей.<имя>.
Особенности внутренней реализации типа РегистрСведенийМенеджерЗаписи.<имя> таковы, что в случае сохранения существующей записи регистра сведений обработчики события Перед Записью() и ПриЗаписи() модуля набора записей будут вызваны дважды: сначала для старого набора записей (с количеством записей 0) и затем для нового (с количеством записей 1).

#### Последовательность событий при сохранении данных из формы набора записей регистра сведений (записать и закрыть)

Рис. 30.18. Последовательность событий при сохранении данных из формы набора записей регистра сведений {https://ai2b.pro/wp-content/uploads/1/30_18.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Регистры накопления
#### Типы для работы с регистрами накопления
На следующей схеме изображено взаимодействие типов для работы с регистрами накопления (рис. 30.19).

Рис. 30.19. Типы для работы с регистрами накопления {https://ai2b.pro/wp-content/uploads/1/30_19.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
РегистрНакопленияЗапись.<имя>. Используется для доступа к записи регистра накопления. Объект этого типа не создается непосредственно, а предоставляется другими объектами, отвечающими за регистр накопления. Например, данный объект представляет записи регистра в наборе записей.
РегистрНакопленияКлючЗаписи.<имя>. Представляет собой набор значений, однозначно идентифицирующих запись регистра. Тип используется в тех случаях, когда необходимо сослаться на определенную запись. Например, объект этого типа выступает в качестве значения свойства ТекущаяСтрока табличного поля, отображающего список записей регистра.
#### Последовательность событий при сохранении набора записей регистра накопления из формы набора записей

Рис. 30.20. Последовательность событий при сохранении набора записей регистра накопления из формы набора записей {https://ai2b.pro/wp-content/uploads/1/30_20.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Регистры бухгалтерии
#### Типы для работы с регистрами бухгалтерии
На следующей схеме изображено взаимодействие типов для работы с регистрами бухгалтерии (рис. 30.21).

Рис. 30.21. Типы для работы с регистрами бухгалтерии {https://ai2b.pro/wp-content/uploads/1/30_21.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
РегистрБухгалтерииЗапись.<имя>. Используется для доступа к записи регистра бухгалтерии. Объект этого типа не создается непосредственно, а предоставляется другими объектами, отвечающими за регистр бухгалтерии. Например, данный объект представляет записи регистра в наборе записей.
РегистрБухгалтерииСубконто.<имя>. Коллекция значений субконто записи регистра бухгалтерии. Установка и получение значения конкретного субконто осуществляются через оператор [], в качестве параметра которому передается вид субконто, или через имя предопределенного субконто.
РегистрБухгалтерииКлючЗаписи.<имя>. Набор значений, однозначно идентифицирующий запись регистра. Тип используется в тех случаях, когда необходимо сослаться на определенную запись. Например, объект этого типа выступает в качестве значения свойства ТекущаяСтрока табличного поля, отображающего список записей регистра.
Свойства и методы взаимодействия перечисленных типов в большинстве своем аналогичны свойствам и методам типов, предназначенным для работы с регистрами накопления.
#### Последовательность событий при сохранении набора записей регистра бухгалтерии из формы

Рис. 30.22. Последовательность событий при сохранении набора записей регистра бухгалтерии из формы {https://ai2b.pro/wp-content/uploads/1/30_22.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Регистры расчета
#### Типы для работы с регистрами расчета
На следующей схеме изображено взаимодействие типов для работы с регистрами расчета (рис. 30.23).

Рис. 30.23. Типы для работы с регистрами расчета {https://ai2b.pro/wp-content/uploads/1/30_23.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
РегистрРасчетаЗапись.<имя>. Используется для доступа к записи регистра расчета. Объект этого типа не создается непосредственно, а предоставляется другими объектами, отвечающими за регистр расчета. Например, данный объект представляет записи регистра в наборе записей.
РегистрРасчетаКлючЗаписи.<имя>. Представляет собой набор значений, однозначно идентифицирующих запись регистра. Тип используется в тех случаях, когда необходимо сослаться на определенную запись. Например, объект этого типа выступает в качестве значения свойства ТекущаяСтрока табличного поля, отображающего список записей регистра.
ПерерасчетыМенеджер.<имя регистра расчета>. Менеджер всех менеджеров перерасчетов регистра расчетов.
ПерерасчетМенеджер.<имя перерасчета>. Менеджер перерасчета служит для получения набора записей перерасчета.
ПерерасчетНаборЗаписей.<имя перерасчета>. Набор записей перерасчета.
ПерерасчетЗапись.<имя перерасчета>. Тип используется для доступа к записи перерасчета.
ФактическийПериодДействия. Массив значений типа ЭлементФактическогоПериодаДействия.
ЭлементФактическогоПериодаДействия. Элемент фактического периода действия.
Свойства и методы взаимодействия перечисленных типов в большинстве своем аналогичны свойствам и методам типов, предназначенных для работы с регистрами накопления.
#### Последовательность событий при сохранении набора записей регистра расчета из формы

Рис. 30.24. Последовательность событий при сохранении набора записей регистра расчета из формы {https://ai2b.pro/wp-content/uploads/1/30_24.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

### Планы обмена
#### Типы для работы с планами обмена
На следующей схеме изображено взаимодействие типов для работы с планами обмена (рис. 30.25).

Рис. 30.25. Типы для работы с планами обмена {https://ai2b.pro/wp-content/uploads/1/30_25.png}
ПРИМЕЧАНИЕ
Заливкой выделен манипулирующий тип.
Узнай больше!
Про основные типы встроенного языка вы можете прочитать в разделе «Прикладные типы».
ЗаписьСообщенияОбмена – тип предназначен для организации записи сообщения обмена данными.
ЧтениеСообщенияОбмена – тип предназначен для приема сообщений обмена данными. При начале чтения он осуществляет проверку правильности задания заголовка сообщения и отвергает неправильные сообщения. При завершении чтения данный объект модифицирует значение реквизита НомерПринятого соответствующего узла плана обмена в соответствии с номером принятого сообщения.
Свойства и методы взаимодействия перечисленных типов в большинстве своем аналогичны свойствам и методам типов, предназначенных для работы со справочниками.
#### Последовательность событий при записи узла плана обмена из формы узла (записать и закрыть)

Рис. 30.26. Последовательность событий при записи узла плана обмена из формы узла {https://ai2b.pro/wp-content/uploads/1/30_26.png}
ПРИМЕЧАНИЕ
Заливкой выделены события, выполняющиеся в транзакции записи.

## Глоссарий
Базовый вид расчета – вид расчета, результат которого будет использован при перерасчете данного вида расчета. Например, вид расчета Оклад является базовым для вида расчета Премия.
Базовый период расчета – период, в котором анализируются результаты других расчетов, влияющих на данный вид расчета по базовому периоду.
Блокирующее окно – блокирует весь интерфейс приложения или его часть, но при этом исполнение кода не останавливается.
Быстрая пользовательская настройка – настройка, расположенная в форме отчета, которая требуется пользователю постоянно.
Ведущий вид расчета – вид расчета, изменение результатов которого приводит к необходимости перерасчета данного вида расчета. Например, виды расчета Невыход и Оклад являются ведущими для вида расчета Премия.
Вид расчета – алгоритм, по которому рассчитывается некоторая часть заработной платы, например: Оклад, Премия и т. п.
Виды субконто – разрезы для ведения аналитического учета на счетах бухгалтерского учета.
Виртуальные таблицы – таблицы, формируемые платформой с помощью запросов из данных реальных таблиц базы данных.
Владелец – объект конфигурации, которому подчинен другой объект конфигурации. Например, справочник Товары является владельцем справочника Единицы измерения.
Временные таблицы – программные объекты, которые разработчик может создать и заполнить данными, а запросы могут использовать данные временных таблиц для своих нужд.
Встроенный язык является важной частью технологической платформы «1С:Предприятие 8», поскольку позволяет разработчику описывать собственные алгоритмы функционирования прикладного решения.
Вытеснение по периоду действия – влияние, которое оказывают вытесняющие виды расчета на период действия данного вида расчета.
Вытесняющий вид расчета – вид расчета, который вытесняет данный вид расчета по периоду действия. Например, вид расчета Невыход является вытесняющим для вида расчета Оклад.
Вычисляемые поля представляют собой дополнительные поля схемы компоновки данных, значения которых будут вычисляться по некоторой формуле.
Главное меню – один из элементов командного интерфейса приложения. Содержит набор команд, относящихся к прикладному решению в целом и не зависящих от прикладной специфики конфигурации. Главное меню расположено в главной панели основного окна программы.
Главная панель – предназначена для быстрого доступа к основным функциям прикладного решения: меню функций, глобальному поиску, центру оповещений, избранному, истории, к текущему пользователю и главному меню.
Группировка – элемент структуры отчета, служащий для вывода информации в виде обычного линейного отчета.
Движения документа – записи в регистрах, которые создаются в процессе проведения документа и отражают изменения, производимые этим документом.
Движения регистра – набор записей, отражающий изменение состояния регистра. В каждой записи содержатся значения измерений, значения приращений ресурсов и т. п.
Дерево объектов конфигурации – иерархическая структура всех объектов конфигурации.
Детальные записи отчета – записи, получаемые в результате выполнения запроса без итогов.
Диаграмма – элемент структуры отчета, служащий для вывода информации в виде диаграммы.
Диаграмма Ганта представляет собой диаграмму интервалов на шкале времени и отражает использование объектами (точками) ресурсов (серий).
Документ – объект конфигурации, предназначенный для описания информации о совершенных хозяйственных операциях или о событиях, произошедших в жизни организации вообще.
Дополнение периода макета компоновки данных позволяет указывать для группировок дополнение периодов с заданной периодичностью в указанном интервале, которое служит для детализации данных в отчете.
Зависимость по базовому периоду – зависимость, которую оказывают базовые виды расчета на базовый период действия данного вида расчета.
Запись XML – объект встроенного языка, обеспечивающий запись документов формата XML из встроенного языка.
Иерархия групп и элементов – вид подчинения в иерархическом справочнике, когда элемент или группа элементов справочника подчинены другой группе элементов этого справочника.
Измерения регистра – объекты конфигурации, в разрезе которых накапливается информация в регистре. Например: Материал, Склад и т. п.
Иерархия элементов – вид подчинения в иерархическом справочнике, когда один элемент подчинен другому.
Имя объекта конфигурации – уникальное наименование объекта, которое служит для обращения к свойствам и методам объекта на встроенном языке.
Информационная панель – панель в нижней части окна приложения, которая отображает показатели производительности системы, то есть информацию о вызовах сервера, объеме данных, передаваемых между клиентом и сервером, и т. п.
Клиент-серверная архитектура разделяет всю работающую систему на три различные части, определенным образом взаимодействующие между собой: клиент, сервер «1С:Предприятия» и сервер баз данных.
Клиент – пользовательская часть приложения, которую видит и с которой работает пользователь.
Ключ записи регистра сведений – совокупность значений измерений регистра и периода (в случае если регистр сведений периодический). Регистр сведений не может содержать несколько записей с одинаковыми ключами.
Конструктор запроса – инструмент, созданный для помощи разработчику, позволяющий визуально конструировать запрос.
Конструктор формы – инструмент разработчика, построенный по принципу мастеров, для создания форм объектов конфигурации.
Конструктор печати – инструмент разработчика, построенный по принципу мастеров, для создания макетов печатных форм объектов конфигурации.
Конструктор движений позволяет создать процедуру на встроенном языке, которая будет выполняться при проведении документа и вносить изменения в состояние регистров, регистратором которых является документ.
Конструктор ввода на основании позволяет создать процедуру на встроенном языке, которая будет выполняться при создании объекта и заполнять реквизиты объекта, вводящиеся на основании.
Контекст модуля определяет набор доступных во время выполнения модуля объектов, переменных, процедур и функций.
Конфигурация – совокупность созданных разработчиком объектов, их свойств, методов и алгоритмов поведения, отражающих хозяйственную деятельность предприятия. Конфигурация разрабатывается в режиме 1С:EDT.
Конфигурация базы данных – конфигурация, с которой работают пользователи.
Конфигурируемость системы «1С:Предприятие» – возможность настройки системы в соответствии с особенностями конкретного предприятия и классом решаемых задач.
Макет – объект конфигурации, предназначенный для хранения различных форм представления данных или вспомогательных данных, которые использует некоторый объект конфигурации или вся конфигурация в целом.
Меню функций предоставляет удобный доступ ко всем командам прикладного решения. Перемещаясь по разделам, пользователь может настроить состав и порядок команд раздела в прикладном решении, пометить команды как избранные и т. п.
Модальное окно блокирует исполнение логики приложения, позволяя выполнять ее участки последовательно, друг за другом, в зависимости от результата, полученного от пользователя.
Модальный метод – метод встроенного языка, выполняющий открытие модального окна. Например: Вопрос(), Предупреждение() и др.
Модуль – «хранилище» для текста программы на встроенном языке.
Момент времени представляет собой совокупность даты, времени и ссылки на объект базы данных. Он позволяет однозначно идентифицировать любой объект ссылочного типа базы данных на оси событий, но имеет смысл в основном только для документов.
Настройки схемы компоновки данных определяют иерархическую структуру отчета (группировка, таблица, диаграмма) и его внешний вид (список полей отчета, сортировка, отбор, условное оформление записей отчета и т. п.).
Независимый регистр сведений – регистр сведений, не использующий подчинение регистратору.
Неоперативное проведение документов подразумевает отражение в базе данных фактов, которые свершились в прошлом или которые точно будут совершены в будущем. Задача неоперативного проведения документов – просто отразить в информационной базе данные о совершенных операциях.
Обработчики событий – процедуры на встроенном языке, выполняющиеся в момент наступления событий объектов конфигурации.
Объекты обмена – объекты конфигурации, данные которых должны участвовать в обмене конкретного плана обмена.
Объектный способ доступа к данным реализован посредством использования объектов встроенного языка. Например, объект ДокументОбъект.ОказаниеУслуги будет содержать значения всех реквизитов документа Оказание услуги и всех его табличных частей.
Объекты конфигурации – логические единицы, «блоки», из которых состоит конфигурация.
Оперативная отметка времени создается системой каждый раз при оперативном проведении документа. Ее значение формируется исходя из текущей даты сеанса и последней созданной оперативной отметки.
Оперативное проведение документов пользователями выполняется в режиме реального времени, то есть отображает изменения, факты, совершающиеся в настоящее время.
Основная конфигурация (или просто конфигурация) – конфигурация, предназначенная для разработчика. Она редактируется в 1C:EDT.
Основной раздел (Главное) – раздел приложения, предназначенный для размещения форм и команд для работы с наиболее часто используемыми пользователем документами, отчетами, справочниками и т. п.
Отладчик – вспомогательный инструмент, облегчающий разработку и отладку программных модулей системы «1С:Предприятие».
Панель «Свойства» позволяет редактировать все свойства объекта конфигурации и другую связанную с ним информацию. Эта панель показывает свойства элемента, выделенного в другой панели или в другом редакторе.
Панель избранного содержит наиболее важные и часто используемые пользователем списки, отчеты, объекты базы данных и команды и т. п.
Панель истории содержит историю последних действий пользователя, сгруппированную по датам.
Панель функций текущего раздела содержит команды, соответствующие выделенному разделу. В начале панели расположены команды, позволяющие открыть какие-либо списки, а затем – команды, позволяющие создать новые элементы данных, сформировать какой-нибудь отчет или выполнить обработку.
Панель навигации формы содержит команды для перехода к спискам, отражающим информацию, которая связана с объектом базы данных, содержащимся в форме. Например, это команды перехода к движениям конкретного документа.
Панель разделов – панель в верхней части окна приложения, которая отражает функциональную структуру приложения и позволяет быстро переключаться между его частями.
Перерасчет – подчиненный регистру расчета объект конфигурации для регистрации фактов появления в регистре записей, влияющих на результат расчета уже существующих записей регистра.
Перечисление – объект конфигурации, предназначенный для описания структуры хранения постоянных наборов значений, не изменяемых в процессе работы конфигурации.
Период действия расчета – период, задаваемый пользователем, в котором действует результат расчета.
Периодический регистр сведений – регистр сведений, использующий привязку ко времени.
План видов характеристик – объект конфигурации, предназначенный для описания структуры хранения информации о характеристиках, создаваемых пользователем.
План счетов – объект конфигурации, предназначенный для описания структуры хранения информации о совокупности синтетических счетов предприятия, которые созданы для группировки данных о его хозяйственной деятельности.
План обмена – объект конфигурации, предназначенный для описания участников обмена (узлов обмена) и объектов конфигурации, данные которых участвуют в обмене (объектов обмена).
Платформа – базисная часть системы «1С:Предприятие», которая обеспечивает работу конфигурации и позволяет вносить в нее изменения или создавать собственную конфигурацию.
Подсистемы – объекты конфигурации, позволяющие выделить в конфигурации функциональные части, на которые логически разбивается создаваемое прикладное решение.
Подчиненные объекты конфигурации – объекты конфигурации, которые логически связаны и подчинены другому объекту конфигурации. Например: Реквизиты, Формы и т. п.
Пользовательские настройки динамического списка или отчета – настройки, заданные в прикладном решении. Они автоматически сохраняются для данного пользователя.
Предопределенные элементы – элементы объекта конфигурации, созданные разработчиком, которые можно использовать при разработке алгоритмов прикладного решения из встроенного языка.
Признак учета – подчиненный плану счетов объект конфигурации для хранения вида учета (например, количественный и валютный) на конкретном счете.
Признак учета субконто – подчиненный плану счетов объект конфигурации для хранения вида учета субконто (например, суммовой, количественный или валютный) на конкретном счете.
Прикладное решение содержит всю функциональность, необходимую для работы предприятия. Это часть системы, видимая для конечного пользователя.
Примитивные типы данных – это Число, Строка, Дата и Булево. Примитивные типы данных изначально определены в системе, и их набор ограничен.
Проведение документа означает, что событие, которое он отражает, повлияло на состояние учета.
Рабочая область приложения – рабочее окно приложения, в котором отражаются формы списков, отчетов, документов и др.
Регистр бухгалтерии – объект конфигурации, предназначенный для описания структуры накопления бухгалтерских данных, учет которых ведется исходя из некоторого плана счетов.
Регистр накопления – объект конфигурации, предназначенный для описания структуры накопления данных.
Регистр оборотов – регистр накопления, накапливающий обороты.
Регистр остатков – регистр накопления, накапливающий остатки.
Регистр расчета – объект конфигурации, предназначенный для описания структуры накопления данных, являющихся результатами сложных периодических расчетов.
Регистр сведений – объект конфигурации, предназначенный для описания структуры хранения данных в разрезе нескольких измерений.
Регистратор регистра – объект конфигурации, который может производить движения в регистре.
Редактор форм объединяет несколько взаимосвязанных между собой окон для редактирования данных и элементов формы, команд формы, модуля формы и т. д.
Редактор объекта конфигурации предназначен для редактирования свойств сложных объектов конфигурации. Все свойства объекта сгруппированы на отдельных закладках, перемещаясь между которыми, можно быстро просмотреть или изменить свойства объекта.
Режим «1С:Предприятие» служит для работы пользователей системы. В этом режиме пользователи вносят данные, обрабатывают их и получают выходные результаты.
Режим «Конфигуратор» используется разработчиками для модификации существующей или создания новой конфигурации.
Реквизиты объекта конфигурации – свойства, характеризующие объект конфигурации, созданные разработчиком. Например: Артикул, Производитель и т. п.
Реквизиты регистра – набор свойств регистра для хранения дополнительной информации.
Ресурсы регистра – виды информации, накапливаемой регистром. Например: Количество, Сумма и т. п.
Ресурсы схемы компоновки данных – поля, значения которых рассчитываются на основании детальных записей, входящих в группировку. По сути ресурсы являются групповыми или общими итогами отчета.
Родитель – элемент или группа элементов справочника (в зависимости от вида иерархии), которому подчинены другие элементы этого справочника.
Роль – объект конфигурации, предназначенный для описания прав пользователей на выполнение различных действий с той или иной информацией, хранящейся в информационной базе.
Сервер «1С:Предприятия» – часть системы «1С:Предприятие», передающая запросы от клиентского приложения к серверу баз данных и возвращающая обратно клиенту результаты этих запросов. На сервере выполняются большинство алгоритмов на встроенном языке, подготовка данных для отображения форм, отчетов и т. д.
Сервер баз данных – программа, поставляемая сторонними производителями. Ее основное назначение – это организация и ведение баз данных.
Синоним объекта конфигурации предназначен для хранения «альтернативного» наименования объекта конфигурации, которое будет использовано в элементах интерфейса программы.
Синтакс-помощник – инструмент, созданный для помощи разработчику, который содержит описание всех программных объектов, используемых системой, их методов, свойств, событий и пр.
Система компоновки данных – мощный и гибкий механизм для построения отчетов, позволяющий выполнить все необходимые действия – от получения данных из различных источников до представления этих данных в виде, удобном для пользователя.
События – различные ситуации, которые возникают в процессе работы прикладного решения. События связаны с конкретными объектами конфигурации. Например, событие ПриОткрытии объекта конфигурации Форма возникает при открытии формы.
Справочник – объект конфигурации, предназначенный для работы со списками данных.
Стандартные реквизиты – свойства объекта конфигурации, автоматически созданные платформой. Например: Код, Наименование и т. п.
Субконто – конкретные объекты для ведения аналитического учета на счетах бухгалтерского учета.
Схема компоновки данных – основа для построения отчета, содержащая исходные данные для компоновки отчета.
Таблица – элемент структуры отчета, служащий для вывода информации в виде таблицы.
Табличная часть – набор информации, которая одинакова по своей структуре, но различна по количеству и предназначена для разных элементов объекта конфигурации. Например, список мест работы в справочнике Сотрудники.
Табличный доступ к данным реализован посредством использования запросов к базе данных. В этой технике разработчик получает возможность оперировать отдельными полями таблиц базы данных, в которых хранятся те или иные данные.
Типообразующие объекты – объекты конфигурации, которые могут образовывать новые типы данных.
Точки останова позволяют прерывать выполнение программы во время отладки в тех местах, где они установлены.
Транзакция – неделимая последовательность манипулирования данными, переводящая базу данных из одного целостного состояния в другое. Если по каким-то причинам одно из действий транзакции невыполнимо, база данных возвращается в то состояние, которое было до начала транзакции.
Фактический период расчета – период, получившийся из периода действия вида расчета после анализа всех периодов действия расчетов, вытесняющих данный вид расчета по периоду действия.
Фиксированные настройки динамического списка или отчета – настройки, сделанные программным путем, например при открытии формы списка с заданным отбором.
Функциональные опции позволяют разработчику выделить некоторую часть функциональности прикладного решения, которую можно оперативно включать или выключать на этапе внедрения и/или в процессе работы системы.
Чтение XML – объект встроенного языка, обеспечивающий чтение документов формата XML из встроенного языка.
Язык запросов – специальный язык. На нем описывается алгоритм, по которому данные будут выбраны из таблиц запроса базы данных. Этот алгоритм помещается в текст запроса.
XML-сериализация преобразует объект «1С:Предприятия» в последовательность данных, представленных в формате XML, и выполняет обратное преобразование – преобразует последовательность данных формата XML в объект «1С:Предприятия» (при условии, что имеется соответствующий тип «1С:Предприятия»).


## Список действий
### Включить объект в подсистему
Чтобы включить объект конфигурации в подсистему, выполните следующие действия:
Откройте редактор объекта конфигурации.
Перейдите на вкладку Подсистемы.
Нажмите Редактировать значение списка в командной панели.
Выберите подсистемы, в которые нужно включить объект.
Нажмите ОК (рис. 31.1) .

Рис. 31.1. Включить объект конфигурации в подсистему {https://ai2b.pro/wp-content/uploads/1/31_001.png}

### Включить объекты в план обмена
Чтобы включить объекты конфигурации в план обмена, выполните следующие действия:
Откройте редактор плана обмена.
Перейдите на вкладку Состав.
Нажмите Редактировать значение списка в командной панели.
Выберите объекты, которые нужно включить в план обмена.
Нажмите ОК (рис. 31.2) .

Рис. 31.2. Включить объекты в план обмена {https://ai2b.pro/wp-content/uploads/1/31_002.png}

### Включить параметры в быстрые пользовательские настройки
Чтобы включить параметры схемы компоновки в быстрые пользовательские настройки, выполните следующие действия:
В редакторе схемы компоновки данных перейдите в окно Настройки.
Перейдите на вкладку Параметры.
По очереди выделите каждый из параметров и нажмите Свойства элемента пользовательских настроек.
Установите флажок Включать в пользовательские настройки.
Установите Режим редактирования в значение Быстрый доступ.
Нажмите ОК (рис. 31.3)

Рис. 31.3. Пользовательские настройки элемента {https://ai2b.pro/wp-content/uploads/1/31_003.png}

### Добавить в форму команду и связанную с ней кнопку
Чтобы добавить в форму команду и связанную с ней кнопку, выполните следующие действия:
В редакторе формы на закладке Команды – Команды формы нажмите Добавить и добавьте команду.
В панели Свойства нажмите значок лупы в поле Действие, чтобы добавить обработчик этой команды (рис. 31.4).

Рис. 31.4. Добавить команду формы {https://ai2b.pro/wp-content/uploads/1/31_004.png}
Выберите вид процедуры (на клиенте, на клиенте и на сервере).
Нажмите ОК (рис. 31.5).

Рис. 31.5. Выбрать вид процедуры {https://ai2b.pro/wp-content/uploads/1/31_005.png}
В модуле формы будет создан шаблон клиентской процедуры Перерассчитать().
Перетащите мышью команду Перерассчитать в группу элементов формы ОсновнаяКоманднаяПанель. При этом в форме появится кнопка Перерассчитать, а связь кнопки с командой будет установлена автоматически (рис. 31.6).

Рис. 31.6. Добавление кнопки в форму {https://ai2b.pro/wp-content/uploads/1/31_006.png}

### Добавить в форму новый элемент, связанный с реквизитом объекта
Чтобы добавить в форму новый элемент, связанный с реквизитом объекта, выполните следующие действия:
В редакторе формы на закладке Реквизиты раскройте реквизит формы Объект или Список.
Найдите нужный реквизит и перетащите его в окно элементов формы, расположенное слева в верхней части редактора формы (рис. 31.7).

Рис. 31.7. Добавить в форму новый элемент, связанный с реквизитом объекта {https://ai2b.pro/wp-content/uploads/1/31_007.png}
Новый элемент будет автоматически связан с реквизитом и сразу же отобразится в окне просмотра формы документа, расположенном в нижнем окне редактора формы.

### Добавить группировку «Детальные записи» в структуру отчета
Чтобы добавить группировку Детальные записи в структуру отчета, выполните следующие действия:
Перейдите на вкладку Настройки.
Нажмите Новая группировка в контекстном меню корневого элемента Отчет (рис. 31.8).
Не указывая поле группировки, сразу нажмите OK.

Рис. 31.8. Добавить группировку «Детальные записи» {https://ai2b.pro/wp-content/uploads/1/31_008.png}

### Добавить набор данных – запрос в схему компоновки данных
Чтобы добавить набор данных – запрос в схему компоновки данных, выполните следующие действия:
Раскройте список выбора на вкладке Наборы данных.
Нажмите Добавить набор данных – запрос (рис. 31.9).

Рис. 31.9. Добавить набор данных – запрос в схему компоновки данных {https://ai2b.pro/wp-content/uploads/1/31_009.png}

### Добавить объект конфигурации
Чтобы добавить объект конфигурации, выполните следующие действия:
В панели Навигатор выделите ту ветку, в которую вы хотите добавить объект. Например, Справочники или Общие – Планы обмена.
Нажмите Создать – <Класс объекта конфигурации> в контекстном меню (рис. 31.10).

Рис. 31.10. Добавить объект конфигурации {https://ai2b.pro/wp-content/uploads/1/31_010.png}
Чтобы добавить реквизит, табличную часть, реквизит табличной части, измерение, ресурс и т. д., выполните следующие действия:
В панели Навигатор выделите тот объект, которому вы хотите его добавить. Например, справочник ВариантыНоменклатуры;
Нажмите Создать – <Вид подчиненного объекта> в контекстном меню (рис. 31.11).

Рис. 31.11. Добавить реквизит {https://ai2b.pro/wp-content/uploads/1/31_011.png}
Чтобы добавить реквизит табличной части, выполните следующие действия:
В панели Навигатор выделите ту табличную часть, которой вы хотите его добавить.
Нажмите Создать – Реквизит табличной части в контекстном меню (рис. 31.12).

Рис. 31.12. Добавить реквизит табличной части {https://ai2b.pro/wp-content/uploads/1/31_012.png}

### Добавить регистр в движения документа
Чтобы добавить регистр в движения документа, выполните следующие действия:
Откройте редактор документа.
Перейдите на вкладку Движения.
Нажмите Редактировать значение списка в командной панели.
Выберите регистры, которые нужно добавить.
Нажмите ОК (рис. 31.13).

Рис. 31.13. Добавить регистр в движения документа {https://ai2b.pro/wp-content/uploads/1/31_013.png}

### Закомментировать строки программы
Чтобы закомментировать сразу несколько строк, выделите их и нажмите Источник – Переключить комментарий в их контекстном меню (рис. 31.14).

Рис. 31.14. Добавить комментарий {https://ai2b.pro/wp-content/uploads/1/31_014.png}
Этой же командой можно снять комментарии.

### Запустить проект в режиме отладки
Чтобы запустить проект в режиме отладки, выполните следующие действия:
В панели Навигатор выделите проект.
Нажмите F11.
Другой способ – в главном меню нажать Запуск – Отладка.

### Импортировать конфигурацию из информационной базы в новый проект
Чтобы импортировать конфигурацию из информационной базы в новый проект, выполните следующие действия:
Откройте панель Информационные базы.
Перетащите нужную базу в панель Навигатор.
Нажмите Импорт (рис. 31.15).

Рис. 31.15. Импортировать конфигурацию из информационной базы в новый проект {https://ai2b.pro/wp-content/uploads/1/31_015.png}

### Редактировать командный интерфейс разделов
Чтобы отредактировать командный интерфейс какого-либо раздела (в том числе основного раздела – Главное), в панели Навигатор нажмите Открыть командный интерфейс в контекстном меню конфигурации (рис. 31.16).

Рис. 31.16. Открыть командный интерфейс {https://ai2b.pro/wp-content/uploads/1/31_016.png}
В редакторе, в списке слева, вы увидите список созданных вами подсистем (разделов приложения). С помощью кнопок Вверх, Вниз или просто потянув мышью можно изменить порядок расположения разделов в этом списке (рис. 31.17).

Рис. 31.17. Редактор командного интерфейса {https://ai2b.pro/wp-content/uploads/1/31_017.png}
Чтобы изменить состав команд конкретной подсистемы (включая раздел Главное), выделите ее в списке разделов слева. Справа вы увидите все команды этой подсистемы и сможете включить/отключить их видимость.

### Редактировать командный интерфейс формы
Чтобы отредактировать командный интерфейс формы, в редакторе формы перейдите на вкладку Командный интерфейс (рис. 31.18).

Рис. 31.18. Командный интерфейс формы {https://ai2b.pro/wp-content/uploads/1/31_018.png}

### Обновить конфигурацию базы данных
Чтобы обновить конфигурацию базы данных, выполните следующие действия:
В панели Навигатор нажмите Обновить конфигурацию… в контекстном меню проекта.
Установите флажок Загрузить конфигурацию полностью…
Нажмите Готово (рис. 31.19).

Рис. 31.19. Обновить конфигурацию базы данных {https://ai2b.pro/wp-content/uploads/1/31_019.png}

### Открыть информационную базу в конфигураторе
Чтобы открыть информационную базу в конфигураторе, выполните следующие действия:
Откройте панель «Информационные базы».
Нажмите Запустить Конфигуратор в контекстном меню нужной базы (рис. 31.20).

Рис. 31.20. Открыть информационную базу в конфигураторе {https://ai2b.pro/wp-content/uploads/1/31_020.png}

### Открыть конструктор запроса
Чтобы открыть конструктор запроса в модуле, нажмите Конструктор запроса… в контекстном меню. Конструктор запроса создаст только текст запроса. Инструкции, необходимые для его выполнения, нужно будет написать самостоятельно (рис. 31.21).

Рис. 31.21. Открыть конструктор запроса в модуле {https://ai2b.pro/wp-content/uploads/1/31_021.png}
Чтобы добавить в модуль готовый фрагмент кода, включающий создание запроса, его выполнение и обход результата, нажмите Конструктор запроса с обработкой результата… в контекстном меню.
Чтобы отредактировать существующий в модуле запрос с помощью конструктора, установите курсор внутрь текста запроса и нажмите Конструктор запроса… в контекстном меню.
Чтобы открыть конструктор запроса для редактирования запроса в конструкторе схемы компоновки данных, нажмите Конструктор запроса… (рис. 31.22).

Рис. 31.22. Открыть конструктор запроса в конструкторе схемы компоновки данных {https://ai2b.pro/wp-content/uploads/1/31_022.png}

### Открыть модуль приложения, модуль объекта, модуль менеджера, модуль формы и другие
Чтобы открыть модуль приложения или модуль сеанса, в панели Навигатор нажмите Открыть модуль приложения или Открыть модуль сеанса в контекстном меню вашей конфигурации (рис. 31.23).

Рис. 31.23. Открыть модуль приложения или модуль сеанса {https://ai2b.pro/wp-content/uploads/1/31_023.png}
Чтобы открыть модуль объекта или модуль менеджера объекта, в панели Навигатор нажмите Открыть модуль объекта или Открыть модуль менеджера в контекстном меню нужного объекта конфигурации (рис. 31.24).

Рис. 31.24. Открыть модуль объекта или модуль менеджера {https://ai2b.pro/wp-content/uploads/1/31_024.png}
Для открытия модуля формы в панели Навигатор нажмите Открыть модуль формы в контекстном меню нужной формы (рис. 31.25).

Рис. 31.25. Открыть модуль формы {https://ai2b.pro/wp-content/uploads/1/31_025.png}
Чтобы открыть общий модуль или модуль команды, достаточно дважды щелкнуть на модуле или на команде в панели Навигатор.

### Открыть панель «Информационные базы»
Обычно панель Информационные базы находится в свернутом состоянии у правой стороны основного окна 1C:EDT.
Чтобы открыть панель Информационные базы, щелкните мышью на ее значке (рис. 31.26).

Рис. 31.26. Открыть панель «Информационные базы» {https://ai2b.pro/wp-content/uploads/1/31_026.png}
Если вы не видите на экране значок панели Информационные базы, можно открыть эту панель через главное меню: Окно – Показать панель – Другое – 1С:Предприятие – Информационные базы.

### Открыть редактор рабочей области начальной страницы
Чтобы открыть редактор рабочей области начальной страницы, в панели Навигатор нажмите Открыть рабочую область начальной страницы в контекстном меню конфигурации (рис. 31.27).

Рис. 31.27. Открыть редактор объекта конфигурации {https://ai2b.pro/wp-content/uploads/1/31_027.png}

### Открыть редактор объекта конфигурации или формы
Чтобы открыть редактор объекта конфигурации (формы), дважды щелкните мышью на нужном объекте в панели Навигатор (рис. 31.28).

Рис. 31.28. Открыть редактор объекта конфигурации {https://ai2b.pro/wp-content/uploads/1/31_028.png}

### Открыть синтакс-помощник
Чтобы открыть синтакс-помощник, нажмите Shift + F1, а затем в появившемся окне справки нажмите кнопку Показать в оглавлении (рис. 32.29).

Рис. 31.29. Показать в оглавлении {https://ai2b.pro/wp-content/uploads/1/31_029.png}
Другой способ – в главном меню нажать Справка – Оглавление справки - 1С:Предприятие (синтакс-помощник) – 1С:Предприятие – Версия 8.3.21 – Синтакс помощник.

### Открыть список констант
Чтобы открыть список констант, нажмите Предприятие – Сервис – Общие настройки (рис. 31.30).

Рис. 31.30. Список констант {https://ai2b.pro/wp-content/uploads/1/31_030.png}

### Переименовать таблицу в конструкторе запроса
Чтобы переименовать таблицу – источник данных в конструкторе запроса, в списке Таблицы нажмите Переименовать таблицу в контекстном меню нужной таблицы (рис. 31.31).

Рис. 31.31. Переименовать таблицу в конструкторе запроса {https://ai2b.pro/wp-content/uploads/1/31_031.png}

### Перепровести документы
Перепроведение – это повторное проведение документа, который уже находится в состоянии Проведен.
Если вы находитесь в форме документа, то для того, чтобы перепровести его, нажмите Провести (рис. 31.32).

Рис. 31.32. Перепроведение документа в форме {https://ai2b.pro/wp-content/uploads/1/31_032.png}
Если вы находитесь в списке документов, то для того, чтобы перепровести один или несколько документов, выполните следующие действия:
Выделите те документы, которые нужно перепровести (удерживая клавишу Ctrl).
В контекстном меню нажмите Провести (рис. 31.33).

Рис. 31.33. Перепроведение документов в списке {https://ai2b.pro/wp-content/uploads/1/31_033.png}

### Поменять местами связанные таблицы запроса
Если в запросе участвуют несколько таблиц, в конструкторе запроса становится доступной закладка Связи, на которой задаются тип связи и условие связи между таблицами. В тех случаях, когда это возможно, платформа сама устанавливает связь между источниками запроса по ссылочным полям (рис. 31.34).

Рис. 31.34. Связи таблиц {https://ai2b.pro/wp-content/uploads/1/31_034.png}
Бывает так, что платформа связывает таблицы не в той последовательности, которая вам нужна. Например, таблица регистра – слева, а таблица справочника – справа.
Чтобы поменять таблицы местами, выделите таблицу регистра и нажмите Переместить в контекстном меню (рис. 31.35).

Рис. 31.35. Перемещение таблицы {https://ai2b.pro/wp-content/uploads/1/31_035.png}
После этого выберите таблицу спрНоменклатура. Таблицы поменяются местами.

### Создать информационную базу
Чтобы создать информационную базу, выполните следующие действия.
Откройте панель Информационные базы. Нажмите Добавить в командной панели (рис. 31.36).

Рис. 31.36. Добавить информационную базу {https://ai2b.pro/wp-content/uploads/1/31_036.png}
1С:EDT запустит мастер добавления информационной базы. На первом шаге ничего не меняйте (вам действительно надо создать новую информационную базу) и нажмите Далее (рис. 31.37).

Рис. 31.37. Добавление информационной базы {https://ai2b.pro/wp-content/uploads/1/31_037.png}
На следующем шаге выберите пункт Создание информационной базы без конфигурации… и нажмите Далее (рис. 31.38).

Рис. 31.38. Начальное содержание информационной базы {https://ai2b.pro/wp-content/uploads/1/31_038.png}
На следующем шаге задайте имя информационной базы, например Услуги (рис. 31.39).

Рис. 31.39. Настройка размещения информационной базы {https://ai2b.pro/wp-content/uploads/1/31_039.png}
Остальные параметры менять не нужно, они вас устраивают: для создания базы 1C:EDT выберет самую старшую версию платформы «1С:Предприятие 8.3», которая есть на вашем компьютере, а располагаться эта база будет тоже на вашем компьютере. Нажмите Далее.
На следующем шаге ничего не меняйте и нажмите Далее (рис. 31.40).

Рис. 31.40. Настройки локального размещения информационной базы {https://ai2b.pro/wp-content/uploads/1/31_040.png}
На следующем шаге тоже ничего не меняйте и нажмите Готово (рис. 31.41).

Рис. 31.41. Установка параметров запуска для информационной базы {https://ai2b.pro/wp-content/uploads/1/31_041.png}

### Создать обработчик события в модуле объекта, в модуле менеджера или обработчик события формы
Чтобы создать обработчик события в модуле объекта, в модуле менеджера или обработчик события формы, выполните следующие действия:
Откройте нужный модуль.
Нажмите Добавить обработчик события в контекстном меню.
Выберите нужное событие.
Выберите вид процедуры (на клиенте, на клиенте и на сервере).
Нажмите ОК (рис. 31.42).

Рис. 31.42. Создать обработчик события {https://ai2b.pro/wp-content/uploads/1/31_042.png}

### Создать обработчик события элемента формы
Чтобы создать обработчик события элемента формы, выполните следующие действия:
Откройте редактор формы.
На вкладке Элементы выделите нужный элемент формы.
Нажмите События – <Имя события> в контекстном меню.
Выберите вид процедуры (на клиенте, на клиенте и на сервере).
Нажмите ОК (рис. 31.43).

Рис. 31.43. Создание обработчика события «ПриИзменении» поля табличной части «Количество» {https://ai2b.pro/wp-content/uploads/1/31_043.png}

### Создать основную схему компоновки данных отчета
Чтобы создать основную схему компоновки данных отчета, выполните следующие действия:
Откройте редактор отчета.
На вкладке Основные нажмите на значок лупы в поле Основная схема компоновки данных.
Нажмите Готово (рис. 31.44).

Рис. 31.44. Создать основную схему компоновки данных отчета {https://ai2b.pro/wp-content/uploads/1/31_044.png}

### Создать предопределенные элементы
Чтобы создать предопределенные элементы справочника или плана видов характеристик, выполните следующие действия:
Откройте редактор объекта конфигурации.
Перейдите на вкладку ПредопределенныеДанные.
Нажмите Добавить в командной панели (рис. 31.45).

Рис. 31.45. Создать предопределенные элементы {https://ai2b.pro/wp-content/uploads/1/31_045.png}

### Создать форму объекта конфигурации
Чтобы создать форму объекта конфигурации, выполните следующие действия:
В панели Навигатор нажмите Создать – Форма в контекстном меню нужного объекта.
Выберите нужный тип формы.
Установите флажок Назначить форму основной, если нужно создать основную форму.
Нажмите Готово (рис. 31.46).

Рис. 31.46. Создать форму объекта конфигурации {https://ai2b.pro/wp-content/uploads/1/31_046.png}

### Установить свойство объекта конфигурации
Установить свойство объекта конфигурации можно несколькими способами.
Если это новый объект, то у вас открыт его редактор. Свойства объекта находятся на вкладке Основные и на других вкладках (рис. 31.47).

Рис. 31.47. Основные свойства документа {https://ai2b.pro/wp-content/uploads/1/31_047.png}
Если редактор объекта закрыт, тогда выделите объект в панели Навигатор и найдите нужное свойство в панели Свойства. В этой панели есть строка поиска, в которую можно ввести часть имени свойства, чтобы найти его быстрее (рис. 31.48).

Рис. 31.48. Свойства документа в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/31_048.png}

### Установить свойство реквизита
Установить свойство реквизита объекта конфигурации можно несколькими способами.
С помощью редактора объекта конфигурации:
Откройте редактор объекта конфигурации.
Перейдите на вкладку Данные.
Выделите нужный реквизит.
В панели Свойства найдите нужное свойство. Можно использовать строку поиска (рис. 31.49).

Рис. 31.49. Свойства реквизита в редакторе {https://ai2b.pro/wp-content/uploads/1/31_049.png}
Этот способ удобен тем, что он позволяет установить свойства стандартных реквизитов, которые по умолчанию не отображаются в панели Навигатор.
Если же вам нужно изменить свойства «обычного» реквизита, то есть более быстрый способ:
В панели Навигатор выделите нужный реквизит.
В панели Свойства найдите нужное свойство (рис. 31.50).

Рис. 31.50. Свойства реквизита в панели «Навигатор» {https://ai2b.pro/wp-content/uploads/1/31_050.png}

### Установить свойство формы или элемента формы
Чтобы установить свойство формы или ее элемента, выполните следующие действия:
Откройте редактор формы.
В окне элементов формы выделите форму (корень) или нужный элемент.
В панели Свойства найдите нужное свойство. Можно использовать строку поиска (рис. 31.51).

Рис. 31.51. Свойства элемента формы {https://ai2b.pro/wp-content/uploads/1/31_051.png}







